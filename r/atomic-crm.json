{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "atomic-crm",
  "title": "Atomic CRM",
  "description": "A fully fledged CRM application built with Shadcn Admin Kit",
  "dependencies": [
    "@hello-pangea/dnd@^18.0.1",
    "@nivo/bar@^0.99.0",
    "faker@^5.5.3",
    "jsonexport@^3.2.0",
    "papaparse@^5.5.3",
    "ra-supabase-core@^3.5.1",
    "ra-supabase-language-english@^3.5.0",
    "zod@^4.0.5"
  ],
  "registryDependencies": [
    "progress",
    "tabs",
    "https://marmelab.com/shadcn-admin-kit/r/admin.json"
  ],
  "files": [
    {
      "path": "src/components/atomic-crm/types.ts",
      "content": "import type { Identifier, RaRecord } from \"ra-core\";\nimport type { ComponentType } from \"react\";\n\nimport type {\n  COMPANY_CREATED,\n  CONTACT_CREATED,\n  CONTACT_NOTE_CREATED,\n  DEAL_CREATED,\n  DEAL_NOTE_CREATED,\n  QUOTE_CREATED,\n  QUOTE_UPDATED,\n  TASK_CREATED,\n  TASK_COMPLETED,\n  DEAL_STATUS_CHANGED,\n  DEAL_ARCHIVED,\n  DEAL_UNARCHIVED,\n  NOTE_DELETED,\n  QUOTE_DELETED,\n  TASK_DELETED,\n  APPOINTMENT_CREATED,\n  APPOINTMENT_DELETED,\n} from \"./consts\";\n\nexport type SignUpData = {\n  email: string;\n  password: string;\n  first_name: string;\n  last_name: string;\n};\n\nexport type SalesFormData = {\n  avatar: string;\n  email: string;\n  password?: string;\n  first_name: string;\n  last_name: string;\n  administrator: boolean;\n  disabled: boolean;\n};\n\nexport type Sale = {\n  first_name: string;\n  last_name: string;\n  administrator: boolean;\n  avatar?: RAFile;\n  disabled?: boolean;\n  user_id: string;\n\n  /**\n   * This is a copy of the user's email, to make it easier to handle by react admin\n   * DO NOT UPDATE this field directly, it should be updated by the backend\n   */\n  email: string;\n\n  /**\n   * This is used by the fake rest provider to store the password\n   * DO NOT USE this field in your code besides the fake rest provider\n   * @deprecated\n   */\n  password?: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type Service = {\n  name: string;\n  color?: string | null;\n  created_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type Company = {\n  name: string;\n  logo: RAFile;\n  sector: string;\n  size: 1 | 10 | 50 | 250 | 500;\n  linkedin_url: string;\n  website: string;\n  phone_number: string;\n  address: string;\n  zipcode: string;\n  city: string;\n  stateAbbr: string;\n  sales_id: Identifier;\n  created_at: string;\n  description: string;\n  revenue: string;\n  tax_identifier: string;\n  country: string;\n  context_links?: string[];\n  nb_contacts?: number;\n  nb_deals?: number;\n  // B2C fields for clients\n  services?: Identifier[];\n  nb_tasks?: number;\n} & Pick<RaRecord, \"id\">;\n\nexport type EmailAndType = {\n  email: string;\n  type: \"Work\" | \"Home\" | \"Other\";\n};\n\nexport type PhoneNumberAndType = {\n  number: string;\n  type: \"Work\" | \"Home\" | \"Other\";\n};\n\nexport type Contact = {\n  first_name: string;\n  last_name: string;\n  title: string;\n  company_id: Identifier;\n  email_jsonb: EmailAndType[];\n  avatar?: Partial<RAFile>;\n  linkedin_url?: string | null;\n  first_seen: string;\n  last_seen: string;\n  has_newsletter: boolean;\n  tags: Identifier[];\n  gender: string;\n  sales_id: Identifier;\n  status: string;\n  background: string;\n  phone_jsonb: PhoneNumberAndType[];\n  nb_tasks?: number;\n  company_name?: string;\n  archived_at?: string;\n  // B2C fields for leads\n  flat_villa_number?: string;\n  building_street?: string;\n  area?: string;\n  city?: string;\n  google_maps_link?: string;\n  latitude?: number | null;\n  longitude?: number | null;\n  phone_has_whatsapp?: boolean;\n  services_interested?: Identifier[];\n  description?: string;\n} & Pick<RaRecord, \"id\">;\n\n// Type alias for clarity - Lead is a Contact in B2C context\nexport type Lead = Contact;\n\n// Type alias for clarity - Client is a Company in B2C context\nexport type Client = Company;\n\nexport type ContactNote = {\n  contact_id: Identifier;\n  text: string;\n  date: string;\n  sales_id: Identifier;\n  status: string;\n  attachments?: AttachmentNote[];\n  tagged_user_ids?: Identifier[];\n} & Pick<RaRecord, \"id\">;\n\nexport type Deal = {\n  name?: string; // Deprecated: use first_name and last_name instead\n  first_name?: string;\n  last_name?: string;\n  company_id: Identifier;\n  contact_ids: Identifier[];\n  category: string;\n  stage: string;\n  description: string;\n  amount: number;\n  created_at: string;\n  updated_at: string;\n  archived_at?: string;\n  expected_closing_date: string;\n  sales_id: Identifier;\n  index: number;\n  // B2C field for lead status\n  lead_id?: Identifier;\n} & Pick<RaRecord, \"id\">;\n\n// Type alias for clarity - LeadStatus is a Deal in B2C context\nexport type LeadStatus = Deal;\n\nexport type DealNote = {\n  deal_id: Identifier;\n  text: string;\n  date: string;\n  sales_id: Identifier;\n  attachments?: AttachmentNote[];\n  tagged_user_ids?: Identifier[];\n\n  // This is defined for compatibility with `ContactNote`\n  status?: undefined;\n} & Pick<RaRecord, \"id\">;\n\nexport type Tag = {\n  name: string;\n  color: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type Task = {\n  contact_id: Identifier;\n  type: string;\n  text: string;\n  due_date: string;\n  done_date?: string | null;\n  sales_id?: Identifier;\n  created_at?: string;\n  tagged_user_ids?: Identifier[];\n} & Pick<RaRecord, \"id\">;\n\nexport type Quote = {\n  contact_id: Identifier;\n  service_id?: Identifier;\n  description?: string;\n  amount: number;\n  status: \"Draft\" | \"Sent\" | \"Accepted\" | \"Rejected\";\n  created_at: string;\n  updated_at: string;\n  sales_id?: Identifier;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityCompanyCreated = {\n  type: typeof COMPANY_CREATED;\n  company_id: Identifier;\n  company: Company;\n  sales_id: Identifier;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityContactCreated = {\n  type: typeof CONTACT_CREATED;\n  company_id: Identifier;\n  sales_id?: Identifier;\n  contact: Contact;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityContactNoteCreated = {\n  type: typeof CONTACT_NOTE_CREATED;\n  sales_id?: Identifier;\n  contactNote: ContactNote;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityDealCreated = {\n  type: typeof DEAL_CREATED;\n  company_id: Identifier;\n  sales_id?: Identifier;\n  deal: Deal;\n  date: string;\n};\n\nexport type ActivityDealNoteCreated = {\n  type: typeof DEAL_NOTE_CREATED;\n  sales_id?: Identifier;\n  dealNote: DealNote;\n  date: string;\n};\n\nexport type ActivityQuoteCreated = {\n  type: typeof QUOTE_CREATED;\n  sales_id?: Identifier;\n  quote: Quote;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityQuoteUpdated = {\n  type: typeof QUOTE_UPDATED;\n  sales_id?: Identifier;\n  quote: Quote;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityTaskCreated = {\n  type: typeof TASK_CREATED;\n  sales_id?: Identifier;\n  task: Task;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityTaskCompleted = {\n  type: typeof TASK_COMPLETED;\n  sales_id?: Identifier;\n  task: Task;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityDealStatusChanged = {\n  type: typeof DEAL_STATUS_CHANGED;\n  company_id?: Identifier;\n  sales_id?: Identifier;\n  deal: Deal;\n  date: string;\n  old_stage?: string | null;\n  new_stage?: string | null;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityDealArchived = {\n  type: typeof DEAL_ARCHIVED;\n  company_id?: Identifier;\n  sales_id?: Identifier;\n  deal: Deal;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityDealUnarchived = {\n  type: typeof DEAL_UNARCHIVED;\n  company_id?: Identifier;\n  sales_id?: Identifier;\n  deal: Deal;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityNoteDeleted = {\n  type: typeof NOTE_DELETED;\n  sales_id?: Identifier;\n  contact_id?: Identifier;\n  deal_id?: Identifier;\n  note_text?: string;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityQuoteDeleted = {\n  type: typeof QUOTE_DELETED;\n  sales_id?: Identifier;\n  contact_id?: Identifier;\n  quote_amount?: number;\n  quote_description?: string;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityTaskDeleted = {\n  type: typeof TASK_DELETED;\n  sales_id?: Identifier;\n  contact_id?: Identifier;\n  task_text?: string;\n  task_type?: string;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityAppointmentCreated = {\n  type: typeof APPOINTMENT_CREATED;\n  sales_id?: Identifier;\n  contact_id?: Identifier;\n  appointment_id?: Identifier;\n  appointment?: Appointment;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityAppointmentDeleted = {\n  type: typeof APPOINTMENT_DELETED;\n  sales_id?: Identifier;\n  contact_id?: Identifier;\n  appointment_id?: Identifier;\n  appointment_date?: string;\n  appointment_type?: string;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type Activity = RaRecord &\n  (\n    | ActivityCompanyCreated\n    | ActivityContactCreated\n    | ActivityContactNoteCreated\n    | ActivityDealCreated\n    | ActivityDealNoteCreated\n    | ActivityQuoteCreated\n    | ActivityQuoteUpdated\n    | ActivityTaskCreated\n    | ActivityTaskCompleted\n    | ActivityDealStatusChanged\n    | ActivityDealArchived\n    | ActivityDealUnarchived\n    | ActivityNoteDeleted\n    | ActivityQuoteDeleted\n    | ActivityTaskDeleted\n    | ActivityAppointmentCreated\n    | ActivityAppointmentDeleted\n  );\n\nexport interface RAFile {\n  src: string;\n  title: string;\n  path?: string;\n  rawFile: File;\n  type?: string;\n}\n\nexport type AttachmentNote = RAFile;\nexport interface DealStage {\n  value: string;\n  label: string;\n}\n\nexport interface NoteStatus {\n  value: string;\n  label: string;\n  color: string;\n}\n\nexport interface ContactGender {\n  value: string;\n  label: string;\n  icon: ComponentType<{ className?: string }>;\n}\n\nexport type Staff = {\n  first_name: string;\n  last_name: string;\n  staff_type: string;\n  phone: string;\n  email?: string;\n  created_at: string;\n  updated_at: string;\n  // Optional fields (kept for backward compatibility with existing data)\n  specialization?: string;\n  status?: \"active\" | \"inactive\";\n} & Pick<RaRecord, \"id\">;\n\nexport type RecurrenceConfig = {\n  pattern: \"daily\" | \"weekly\" | \"monthly\" | \"yearly\" | \"custom\";\n  interval: number; // e.g., 2 for \"every 2 weeks\"\n  end_type: \"date\" | \"occurrences\";\n  end_date?: string | null; // YYYY-MM-DD\n  occurrences?: number | null;\n  days_of_week?: number[] | null; // For weekly: 0=Sunday, 6=Saturday\n  day_of_month?: number | null; // For monthly: 1-31\n  week_of_month?: number | null; // For monthly: 1-5 (first Monday, etc.)\n  month?: number | null; // For yearly: 1-12\n  custom_unit?: \"days\" | \"weeks\" | \"months\" | null; // For custom pattern\n};\n\nexport type Appointment = {\n  patient_id: Identifier;\n  appointment_date: string;\n  start_time: string;\n  end_time: string;\n  duration_minutes: number;\n  appointment_type: \"doctor_on_call\" | \"lab_test\" | \"teleconsultation\" | \"physiotherapy\" | \"caregiver\" | \"iv_therapy\";\n  status: \"scheduled\" | \"confirmed\" | \"completed\" | \"cancelled\";\n  notes?: string;\n  mini_notes?: string;\n  full_notes?: string;\n  pickup_instructions?: string;\n  custom_fields?: Record<string, any>;\n  primary_staff_id?: Identifier;\n  driver_id?: Identifier;\n  staff_ids?: Identifier[];\n  payment_package_id?: Identifier | null;\n  created_at: string;\n  updated_at: string;\n  // Recurrence fields\n  recurrence_id?: string;\n  recurrence_config?: RecurrenceConfig;\n  is_recurring?: boolean;\n  recurrence_sequence?: number;\n} & Pick<RaRecord, \"id\">;\n\nexport type AppointmentStaffAssignment = {\n  appointment_id: Identifier;\n  staff_id: Identifier;\n  role: \"primary\" | \"driver\" | \"other\";\n  created_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type BugReport = {\n  reported_by: Identifier;\n  title: string;\n  description: string;\n  steps_to_reproduce?: string | null;\n  screenshot_urls?: string[];\n  status: \"open\" | \"in_progress\" | \"resolved\" | \"closed\";\n  priority: \"low\" | \"medium\" | \"high\" | \"critical\";\n  browser_info?: string | null;\n  device_info?: string | null;\n  url?: string | null;\n  created_at: string;\n  updated_at: string;\n} & Pick<RaRecord, \"id\">;\n\n// Payment tracking types\nexport type PaymentPackage = {\n  patient_id: Identifier;\n  service_id?: Identifier;\n  package_type: \"session-based\" | \"time-based\" | \"post-payment\";\n  total_amount: number;\n  price_per_hour?: number | null;\n  total_sessions?: number | null;\n  total_hours?: number | null;\n  duration_days?: number | null;\n  hours_per_day?: number | null;\n  start_date: string; // YYYY-MM-DD\n  end_date?: string | null; // YYYY-MM-DD\n  renewal_date?: string | null; // YYYY-MM-DD\n  status: \"active\" | \"completed\" | \"expired\";\n  renewed_from_package_id?: Identifier | null;\n  name?: string | null; // Human-readable package name\n  created_at: string;\n  updated_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type PaymentTransaction = {\n  payment_package_id?: Identifier | null; // Optional for standalone payments (one-off services)\n  appointment_id?: Identifier | null; // Optional, used to link standalone payments to appointments\n  amount_received: number;\n  bank_charge: number;\n  net_amount: number;\n  payment_method: \"POS\" | \"Tabby\" | \"Payment Link\" | \"Ziina\" | \"Cash\";\n  date_paid: string; // YYYY-MM-DD\n  date_received: string; // YYYY-MM-DD\n  invoice_number?: string | null;\n  installment_number?: number | null;\n  created_at: string;\n  updated_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type PackageUsage = {\n  payment_package_id: Identifier;\n  appointment_id?: Identifier | null;\n  usage_type: \"session\" | \"hours\";\n  quantity_used: number;\n  usage_date: string; // YYYY-MM-DD\n  is_manual_adjustment: boolean;\n  notes?: string | null;\n  created_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type InstallmentSchedule = {\n  payment_package_id: Identifier;\n  installment_number: number;\n  due_date: string; // YYYY-MM-DD\n  amount_due: number;\n  is_paid: boolean;\n  paid_date?: string | null; // YYYY-MM-DD\n  reminder_sent: boolean;\n  created_at: string;\n  updated_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type PaymentSettings = {\n  payment_method: \"POS\" | \"Tabby\" | \"Payment Link\" | \"Ziina\" | \"Cash\";\n  fee_percentage?: number | null;\n  fixed_fee_amount?: number | null;\n  vat_percentage: number;\n  is_active: boolean;\n  created_at: string;\n  updated_at: string;\n} & Pick<RaRecord, \"id\">;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/consts.ts",
      "content": "export const COMPANY_CREATED = \"company.created\" as const;\nexport const CONTACT_CREATED = \"contact.created\" as const;\nexport const CONTACT_NOTE_CREATED = \"contactNote.created\" as const;\nexport const DEAL_CREATED = \"deal.created\" as const;\nexport const DEAL_NOTE_CREATED = \"dealNote.created\" as const;\nexport const QUOTE_CREATED = \"quote.created\" as const;\nexport const QUOTE_UPDATED = \"quote.updated\" as const;\nexport const TASK_CREATED = \"task.created\" as const;\nexport const TASK_COMPLETED = \"task.completed\" as const;\nexport const DEAL_STATUS_CHANGED = \"deal.statusChanged\" as const;\nexport const DEAL_ARCHIVED = \"deal.archived\" as const;\nexport const DEAL_UNARCHIVED = \"deal.unarchived\" as const;\nexport const NOTE_DELETED = \"note.deleted\" as const;\nexport const QUOTE_DELETED = \"quote.deleted\" as const;\nexport const TASK_DELETED = \"task.deleted\" as const;\nexport const APPOINTMENT_CREATED = \"appointment.created\" as const;\nexport const APPOINTMENT_DELETED = \"appointment.deleted\" as const;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/UnplannedJobsQueue.tsx",
      "content": "/**\n * UnplannedJobsQueue Component\n * \n * Left panel showing unplanned appointments (appointments without assigned trips).\n * Displays draggable cards that can be dragged to driver timeline lanes.\n */\n\nimport React, { useMemo } from \"react\";\nimport { Draggable, Droppable } from \"@hello-pangea/dnd\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Clock, MapPin, User, FileText } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Appointment, Contact, Staff } from \"../types\";\nimport type { Identifier } from \"ra-core\";\nimport { useGetList } from \"ra-core\";\n\ntype UnplannedJobsQueueProps = {\n  appointments: Appointment[];\n  loading: boolean;\n  selectedDate: Date;\n  onAppointmentClick: (appointmentId: Identifier) => void;\n  onAppointmentHover: (appointmentId: Identifier | null) => void;\n};\n\nexport const UnplannedJobsQueue: React.FC<UnplannedJobsQueueProps> = ({\n  appointments,\n  loading,\n  selectedDate,\n  onAppointmentClick,\n  onAppointmentHover,\n}) => {\n  // Fetch patients for appointments\n  const patientIds = useMemo(() => {\n    return appointments.map((a) => a.patient_id).filter(Boolean);\n  }, [appointments]);\n\n  const { data: patients } = useGetList<Contact>(\n    \"clients\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      filter: {\n        \"id@in\": patientIds.length > 0 ? `(${patientIds.join(\",\")})` : \"(-1)\",\n      },\n    },\n    {\n      enabled: patientIds.length > 0,\n      retry: false,\n    }\n  );\n\n  // Fetch staff for appointments\n  const staffIds = useMemo(() => {\n    const ids = new Set<Identifier>();\n    appointments.forEach((a) => {\n      if (a.primary_staff_id) ids.add(a.primary_staff_id);\n      if (a.driver_id) ids.add(a.driver_id);\n    });\n    return Array.from(ids);\n  }, [appointments]);\n\n  const { data: staff } = useGetList<Staff>(\n    \"staff\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      filter: {\n        \"id@in\": staffIds.length > 0 ? `(${staffIds.join(\",\")})` : \"(-1)\",\n      },\n    },\n    {\n      enabled: staffIds.length > 0,\n      retry: false,\n    }\n  );\n\n  // Create maps for quick lookup\n  const patientsMap = useMemo(() => {\n    if (!patients) return new Map<Identifier, Contact>();\n    return new Map(patients.map((p) => [p.id, p]));\n  }, [patients]);\n\n  const staffMap = useMemo(() => {\n    if (!staff) return new Map<Identifier, Staff>();\n    return new Map(staff.map((s) => [s.id, s]));\n  }, [staff]);\n\n  // Sort appointments by time\n  const sortedAppointments = useMemo(() => {\n    return [...appointments].sort((a, b) => {\n      const timeA = a.start_time ? new Date(a.start_time).getTime() : 0;\n      const timeB = b.start_time ? new Date(b.start_time).getTime() : 0;\n      return timeA - timeB;\n    });\n  }, [appointments]);\n\n  if (loading) {\n    return (\n      <div className=\"h-full flex items-center justify-center\">\n        <div className=\"text-slate-500 dark:text-slate-400\">Loading...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      {/* Header */}\n      <div className=\"flex-shrink-0 px-4 py-3 border-b border-slate-200 dark:border-slate-700\">\n        <h2 className=\"text-sm font-semibold text-slate-900 dark:text-slate-100\">\n          Unplanned Jobs\n        </h2>\n        <p className=\"text-xs text-slate-500 dark:text-slate-400 mt-1\">\n          {sortedAppointments.length} appointment{sortedAppointments.length !== 1 ? \"s\" : \"\"}\n        </p>\n      </div>\n\n      {/* Scrollable List */}\n      <Droppable droppableId=\"unplanned-queue\" isDropDisabled={true}>\n        {(provided, snapshot) => (\n          <div\n            ref={provided.innerRef}\n            {...provided.droppableProps}\n            className=\"flex-1 overflow-y-auto p-4 space-y-2\"\n          >\n            {sortedAppointments.length === 0 ? (\n              <div className=\"text-center text-slate-500 dark:text-slate-400 py-8 text-sm\">\n                No unplanned appointments\n              </div>\n            ) : (\n              sortedAppointments.map((appointment, index) => {\n                const patient = patientsMap.get(appointment.patient_id);\n                const primaryStaff = appointment.primary_staff_id\n                  ? staffMap.get(appointment.primary_staff_id)\n                  : null;\n\n                return (\n                  <Draggable\n                    key={appointment.id}\n                    draggableId={`appointment-${appointment.id}`}\n                    index={index}\n                  >\n                    {(provided, snapshot) => (\n                      <Card\n                        ref={provided.innerRef}\n                        {...provided.draggableProps}\n                        {...provided.dragHandleProps}\n                        className={`cursor-grab active:cursor-grabbing ${\n                          snapshot.isDragging\n                            ? \"shadow-lg ring-2 ring-blue-500\"\n                            : \"hover:shadow-md\"\n                        } transition-shadow`}\n                        onMouseEnter={() => onAppointmentHover(appointment.id)}\n                        onMouseLeave={() => onAppointmentHover(null)}\n                        onClick={() => onAppointmentClick(appointment.id)}\n                      >\n                        <CardContent className=\"p-3\">\n                          {/* Time */}\n                          <div className=\"flex items-center gap-2 mb-2\">\n                            <Clock className=\"w-4 h-4 text-slate-500 dark:text-slate-400\" />\n                            <span className=\"text-sm font-medium text-slate-900 dark:text-slate-100\">\n                              {appointment.start_time\n                                ? format(new Date(appointment.start_time), \"h:mm a\")\n                                : \"No time\"}\n                            </span>\n                          </div>\n\n                          {/* Patient */}\n                          {patient && (\n                            <div className=\"flex items-center gap-2 mb-2\">\n                              <User className=\"w-4 h-4 text-slate-500 dark:text-slate-400\" />\n                              <span className=\"text-sm text-slate-700 dark:text-slate-300\">\n                                {patient.first_name} {patient.last_name}\n                              </span>\n                            </div>\n                          )}\n\n                          {/* Area */}\n                          {patient?.area && (\n                            <div className=\"flex items-center gap-2 mb-2\">\n                              <MapPin className=\"w-4 h-4 text-slate-500 dark:text-slate-400\" />\n                              <span className=\"text-xs text-slate-600 dark:text-slate-400\">\n                                {patient.area}\n                              </span>\n                            </div>\n                          )}\n\n                          {/* Staff */}\n                          {primaryStaff && (\n                            <div className=\"text-xs text-slate-600 dark:text-slate-400 mb-2\">\n                              Staff: {primaryStaff.first_name} {primaryStaff.last_name}\n                            </div>\n                          )}\n\n                          {/* Pickup/Drop Required */}\n                          <div className=\"text-xs text-slate-500 dark:text-slate-400 mb-2\">\n                            {appointment.pickup_instructions || appointment.primary_staff_id || (appointment.staff_ids && appointment.staff_ids.length > 0)\n                              ? \"Pickup/Drop required\"\n                              : \"No transport needed\"}\n                          </div>\n\n                          {/* Notes */}\n                          {appointment.notes && (\n                            <div className=\"flex items-start gap-2 mt-2 pt-2 border-t border-slate-200 dark:border-slate-700\">\n                              <FileText className=\"w-3 h-3 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0\" />\n                              <span className=\"text-xs text-slate-600 dark:text-slate-400 line-clamp-2\">\n                                {appointment.notes}\n                              </span>\n                            </div>\n                          )}\n                        </CardContent>\n                      </Card>\n                    )}\n                  </Draggable>\n                );\n              })\n            )}\n            {provided.placeholder}\n          </div>\n        )}\n      </Droppable>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/TransportPage.tsx",
      "content": "import { DispatcherBoard } from \"./DispatcherBoard\";\n\nexport const TransportPage = () => {\n  return (\n    <div className=\"h-full w-full\">\n      <DispatcherBoard />\n    </div>\n  );\n};\n\nTransportPage.path = \"/transport\";\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/StopsList.tsx",
      "content": "/**\n * StopsList Component\n * \n * Ordered list of stops below the map, synchronized with selected driver's route.\n * Clickable to highlight on map.\n */\n\nimport React, { useMemo } from \"react\";\nimport { Clock, MapPin, User } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Identifier } from \"ra-core\";\nimport { useGetList } from \"ra-core\";\nimport type { DriverTrip, TripLeg, Contact, Staff } from \"../types\";\n\ntype StopsListProps = {\n  selectedDriverId: Identifier | null;\n  selectedDate: Date;\n  onLegClick: (legId: Identifier | null) => void;\n  hoveredLegId: Identifier | null;\n};\n\nexport const StopsList: React.FC<StopsListProps> = ({\n  selectedDriverId,\n  selectedDate,\n  onLegClick,\n  hoveredLegId,\n}) => {\n  const selectedDateStr = format(selectedDate, \"yyyy-MM-dd\");\n\n  // Fetch driver trip\n  const { data: driverTrips } = useGetList<DriverTrip>(\n    \"driver_trips\",\n    {\n      pagination: { page: 1, perPage: 100 },\n      filter: {\n        \"trip_date@eq\": selectedDateStr,\n        ...(selectedDriverId ? { \"driver_id@eq\": selectedDriverId } : {}),\n      },\n    },\n    {\n      enabled: !!selectedDriverId,\n      retry: false,\n    }\n  );\n\n  // Fetch trip legs\n  const tripIds = useMemo(() => {\n    return driverTrips?.map((trip) => trip.id) || [];\n  }, [driverTrips]);\n\n  const { data: tripLegs } = useGetList<TripLeg>(\n    \"trip_legs\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      filter: {\n        \"trip_id@in\": tripIds.length > 0 ? `(${tripIds.join(\",\")})` : \"(-1)\",\n      },\n      sort: { field: \"leg_order\", order: \"ASC\" },\n    },\n    {\n      enabled: tripIds.length > 0,\n      retry: false,\n    }\n  );\n\n  // Fetch contacts and staff\n  const patientIds = useMemo(() => {\n    if (!tripLegs) return [];\n    return tripLegs\n      .filter((leg) => leg.location_type === \"patient\" && leg.location_id)\n      .map((leg) => leg.location_id)\n      .filter(Boolean);\n  }, [tripLegs]);\n\n  const staffIds = useMemo(() => {\n    if (!tripLegs) return [];\n    const ids = new Set<Identifier>();\n    tripLegs.forEach((leg) => {\n      if (leg.staff_id) ids.add(leg.staff_id);\n    });\n    return Array.from(ids);\n  }, [tripLegs]);\n\n  const { data: patients } = useGetList<Contact>(\n    \"clients\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      filter: {\n        \"id@in\": patientIds.length > 0 ? `(${patientIds.join(\",\")})` : \"(-1)\",\n      },\n    },\n    {\n      enabled: patientIds.length > 0,\n      retry: false,\n    }\n  );\n\n  const { data: staff } = useGetList<Staff>(\n    \"staff\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      filter: {\n        \"id@in\": staffIds.length > 0 ? `(${staffIds.join(\",\")})` : \"(-1)\",\n      },\n    },\n    {\n      enabled: staffIds.length > 0,\n      retry: false,\n    }\n  );\n\n  const patientsMap = useMemo(() => {\n    if (!patients) return new Map<Identifier, Contact>();\n    return new Map(patients.map((p) => [p.id, p]));\n  }, [patients]);\n\n  const staffMap = useMemo(() => {\n    if (!staff) return new Map<Identifier, Staff>();\n    return new Map(staff.map((s) => [s.id, s]));\n  }, [staff]);\n\n  const getLegLabel = (leg: TripLeg): string => {\n    switch (leg.leg_type) {\n      case \"pickup_staff\":\n        const pickupStaff = leg.staff_id ? staffMap.get(leg.staff_id) : null;\n        return `Pickup ${pickupStaff ? `${pickupStaff.first_name} ${pickupStaff.last_name}` : \"Staff\"}`;\n      case \"drop_staff\":\n        const dropStaff = leg.staff_id ? staffMap.get(leg.staff_id) : null;\n        return `Drop ${dropStaff ? `${dropStaff.first_name} ${dropStaff.last_name}` : \"Staff\"}`;\n      case \"appointment\":\n        const patient = leg.location_id ? patientsMap.get(leg.location_id) : null;\n        return patient ? `${patient.first_name} ${patient.last_name}` : \"Appointment\";\n      case \"wait\":\n        return `Wait ${leg.wait_duration_minutes || 0} min`;\n      case \"return\":\n        return \"Return to Office\";\n      default:\n        return leg.leg_type;\n    }\n  };\n\n  const getLocationLabel = (leg: TripLeg): string => {\n    if (leg.location_type === \"patient\" && leg.location_id) {\n      const patient = patientsMap.get(leg.location_id);\n      if (patient?.area) return patient.area;\n      if (patient?.city) return patient.city;\n    }\n    return leg.location_type.charAt(0).toUpperCase() + leg.location_type.slice(1);\n  };\n\n  if (!selectedDriverId) {\n    return (\n      <div className=\"h-full flex items-center justify-center bg-slate-50 dark:bg-slate-900\">\n        <div className=\"text-slate-500 dark:text-slate-400 text-sm\">\n          Select a driver to view stops\n        </div>\n      </div>\n    );\n  }\n\n  if (!tripLegs || tripLegs.length === 0) {\n    return (\n      <div className=\"h-full flex items-center justify-center bg-slate-50 dark:bg-slate-900\">\n        <div className=\"text-slate-500 dark:text-slate-400 text-sm\">\n          No stops scheduled\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full overflow-y-auto bg-slate-50 dark:bg-slate-900\">\n      <div className=\"p-2 space-y-1\">\n        {tripLegs.map((leg, index) => {\n          const isHovered = hoveredLegId === leg.id;\n          const startTime = new Date(leg.planned_arrival_time);\n\n          return (\n            <div\n              key={leg.id}\n              className={`p-2 rounded-md cursor-pointer transition-colors ${\n                isHovered\n                  ? \"bg-blue-100 dark:bg-blue-900/30 border border-blue-300 dark:border-blue-700\"\n                  : \"bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700\"\n              }`}\n              onClick={() => onLegClick(leg.id)}\n              onMouseEnter={() => onLegClick(leg.id)}\n              onMouseLeave={() => onLegClick(null)}\n            >\n              <div className=\"flex items-center gap-2\">\n                <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-blue-500 text-white text-xs flex items-center justify-center font-medium\">\n                  {index + 1}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2\">\n                    <Clock className=\"w-3 h-3 text-slate-500 dark:text-slate-400 flex-shrink-0\" />\n                    <span className=\"text-xs font-medium text-slate-900 dark:text-slate-100\">\n                      {format(startTime, \"h:mm a\")}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center gap-2 mt-1\">\n                    <User className=\"w-3 h-3 text-slate-500 dark:text-slate-400 flex-shrink-0\" />\n                    <span className=\"text-xs text-slate-700 dark:text-slate-300 truncate\">\n                      {getLegLabel(leg)}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center gap-2 mt-1\">\n                    <MapPin className=\"w-3 h-3 text-slate-500 dark:text-slate-400 flex-shrink-0\" />\n                    <span className=\"text-xs text-slate-600 dark:text-slate-400 truncate\">\n                      {getLocationLabel(leg)}\n                    </span>\n                  </div>\n                </div>\n              </div>\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/PlaybackMapView.tsx",
      "content": "/**\n * PlaybackMapView Component\n * \n * Map view showing driver positions at specific time points with animated movement along routes.\n * Displays route polylines, driver markers, stop markers, and highlights active stops.\n */\n\nimport React, { useEffect, useRef, useState, useMemo } from \"react\";\nimport type { Identifier } from \"ra-core\";\nimport type { DriverTrip, TripLeg, Staff, Contact } from \"../types\";\nimport type { PlaybackState, RouteConflict } from \"./types\";\nimport { useGetList } from \"ra-core\";\nimport { format } from \"date-fns\";\nimport {\n  extractContactCoordinates,\n  getOfficeLocation,\n  getMetroLocation,\n  getStaffHomeLocation,\n} from \"./utils/coordinateExtractor\";\nimport type { Location } from \"./types\";\nimport { useOfficeLocation } from \"@/hooks/useOfficeLocation\";\n\ntype PlaybackMapViewProps = {\n  playbackState: PlaybackState;\n  driverTrips: DriverTrip[];\n  tripLegs: TripLeg[];\n  activeStops: TripLeg[];\n  activeConflicts: RouteConflict[];\n};\n\nexport const PlaybackMapView: React.FC<PlaybackMapViewProps> = ({\n  playbackState,\n  driverTrips,\n  tripLegs,\n  activeStops,\n  activeConflicts,\n}) => {\n  const mapContainerRef = useRef<HTMLDivElement>(null);\n  const mapRef = useRef<google.maps.Map | null>(null);\n  const [mapLoaded, setMapLoaded] = useState(false);\n  const markersRef = useRef<google.maps.Marker[]>([]);\n  const polylinesRef = useRef<google.maps.Polyline[]>([]);\n  const driverMarkersRef = useRef<Map<Identifier, google.maps.Marker>>(new Map());\n  const [driverPositions, setDriverPositions] = useState<\n    Map<Identifier, { lat: number; lng: number; legId?: Identifier }>\n  >(new Map());\n\n  // Get office location from settings\n  const { officeLocation } = useOfficeLocation();\n\n  // Fetch staff for drivers\n  const driverIds = useMemo(() => {\n    return driverTrips.map((trip) => trip.driver_id);\n  }, [driverTrips]);\n\n  const { data: staff } = useGetList<Staff>(\n    \"staff\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      filter: {\n        \"id@in\": driverIds.length > 0 ? `(${driverIds.join(\",\")})` : \"(-1)\",\n      },\n    },\n    {\n      enabled: driverIds.length > 0,\n      retry: false,\n    }\n  );\n\n  // Fetch contacts for patient locations\n  const patientIds = useMemo(() => {\n    return tripLegs\n      .filter((leg) => leg.location_type === \"patient\" && leg.location_id)\n      .map((leg) => leg.location_id)\n      .filter(Boolean);\n  }, [tripLegs]);\n\n  const { data: patients } = useGetList<Contact>(\n    \"clients\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      filter: {\n        \"id@in\": patientIds.length > 0 ? `(${patientIds.join(\",\")})` : \"(-1)\",\n      },\n    },\n    {\n      enabled: patientIds.length > 0,\n      retry: false,\n    }\n  );\n\n  // Initialize Google Maps\n  useEffect(() => {\n    const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;\n    if (!apiKey) {\n      console.error(\"Google Maps API key not found\");\n      return;\n    }\n\n    const isApiReady = () => {\n      return (\n        window.google &&\n        window.google.maps &&\n        window.google.maps.Map\n      );\n    };\n\n    if (isApiReady()) {\n      initializeMap();\n      return;\n    }\n\n    const existingScript = document.querySelector(\n      `script[src*=\"maps.googleapis.com/maps/api/js\"]`\n    );\n    if (existingScript) {\n      const checkReady = setInterval(() => {\n        if (isApiReady()) {\n          clearInterval(checkReady);\n          initializeMap();\n        }\n      }, 100);\n      setTimeout(() => clearInterval(checkReady), 10000);\n      return;\n    }\n\n    const script = document.createElement(\"script\");\n    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&loading=async`;\n    script.async = true;\n    script.defer = true;\n    script.onload = () => {\n      const checkReady = setInterval(() => {\n        if (isApiReady()) {\n          clearInterval(checkReady);\n          initializeMap();\n        }\n      }, 100);\n      setTimeout(() => clearInterval(checkReady), 10000);\n    };\n    document.head.appendChild(script);\n  }, []);\n\n  const initializeMap = () => {\n    if (!mapContainerRef.current || !window.google || !window.google.maps || mapRef.current) {\n      return;\n    }\n\n    // Use office location from settings, fallback to Dubai\n    const centerLat = officeLocation?.latitude ?? 25.2048;\n    const centerLng = officeLocation?.longitude ?? 55.2708;\n\n    const map = new window.google.maps.Map(mapContainerRef.current, {\n      center: { lat: centerLat, lng: centerLng },\n      zoom: 12,\n      mapTypeId: window.google.maps.MapTypeId.ROADMAP,\n    });\n\n    mapRef.current = map;\n    setMapLoaded(true);\n  };\n\n  // Get location for a trip leg\n  const getLocationForLeg = async (leg: TripLeg): Promise<Location | null> => {\n    switch (leg.location_type) {\n      case \"office\":\n        return getOfficeLocation(officeLocation);\n      case \"metro\":\n        return getMetroLocation();\n      case \"home\":\n        if (leg.staff_id && staff) {\n          const staffMember = staff.find((s) => s.id === leg.staff_id);\n          return getStaffHomeLocation(staffMember || undefined);\n        }\n        return null;\n      case \"patient\":\n        if (leg.location_id && patients) {\n          const patient = patients.find((p) => p.id === leg.location_id);\n          return extractContactCoordinates(patient || undefined);\n        }\n        return null;\n      default:\n        return null;\n    }\n  };\n\n  // Calculate driver positions at current playback time\n  useEffect(() => {\n    if (!tripLegs || tripLegs.length === 0 || !staff || !patients) {\n      setDriverPositions(new Map());\n      return;\n    }\n\n    const calculatePositions = async () => {\n      const currentTime = new Date(playbackState.current_time);\n      const positions = new Map<Identifier, { lat: number; lng: number; legId?: Identifier }>();\n\n      // Group legs by trip\n      const legsByTrip = new Map<Identifier, TripLeg[]>();\n      tripLegs.forEach((leg) => {\n        if (!legsByTrip.has(leg.trip_id)) {\n          legsByTrip.set(leg.trip_id, []);\n        }\n        legsByTrip.get(leg.trip_id)!.push(leg);\n      });\n\n      // For each trip, find where the driver should be\n      for (const trip of driverTrips) {\n        const legs = legsByTrip.get(trip.id) || [];\n        const sortedLegs = [...legs].sort((a, b) => a.leg_order - b.leg_order);\n\n        // Find the leg the driver is currently on\n        for (let i = 0; i < sortedLegs.length; i++) {\n          const leg = sortedLegs[i];\n          const arrivalTime = new Date(leg.planned_arrival_time);\n          const departureTime = leg.planned_departure_time\n            ? new Date(leg.planned_departure_time)\n            : new Date(arrivalTime.getTime() + 30 * 60 * 1000);\n\n          if (currentTime >= arrivalTime && currentTime <= departureTime) {\n            // Driver is at this stop\n            const location = await getLocationForLeg(leg);\n            if (location?.coordinates) {\n              positions.set(trip.driver_id, {\n                lat: location.coordinates.latitude,\n                lng: location.coordinates.longitude,\n                legId: leg.id,\n              });\n            }\n            break;\n          } else if (currentTime < arrivalTime && i > 0) {\n            // Driver is traveling between previous stop and current stop\n            const prevLeg = sortedLegs[i - 1];\n            const prevLocation = await getLocationForLeg(prevLeg);\n            const currLocation = await getLocationForLeg(leg);\n\n            if (prevLocation?.coordinates && currLocation?.coordinates) {\n              // Interpolate position (simplified - assumes linear movement)\n              const prevTime = prevLeg.planned_departure_time\n                ? new Date(prevLeg.planned_departure_time)\n                : new Date(prevLeg.planned_arrival_time);\n              const travelDuration = arrivalTime.getTime() - prevTime.getTime();\n              const elapsed = currentTime.getTime() - prevTime.getTime();\n              const progress = Math.max(0, Math.min(1, elapsed / travelDuration));\n\n              const lat =\n                prevLocation.coordinates.latitude +\n                (currLocation.coordinates.latitude - prevLocation.coordinates.latitude) * progress;\n              const lng =\n                prevLocation.coordinates.longitude +\n                (currLocation.coordinates.longitude - prevLocation.coordinates.longitude) * progress;\n\n              positions.set(trip.driver_id, {\n                lat,\n                lng,\n                legId: leg.id,\n              });\n            }\n            break;\n          }\n        }\n      }\n\n      setDriverPositions(positions);\n    };\n\n    calculatePositions();\n  }, [playbackState.current_time, driverTrips, tripLegs, staff, patients]);\n\n  // Update map with routes and driver positions\n  useEffect(() => {\n    if (!mapRef.current || !mapLoaded || !tripLegs || !staff || !patients) return;\n\n    // Clear existing markers and polylines\n    markersRef.current.forEach((marker) => marker.setMap(null));\n    markersRef.current = [];\n    polylinesRef.current.forEach((polyline) => polyline.setMap(null));\n    polylinesRef.current = [];\n    driverMarkersRef.current.forEach((marker) => marker.setMap(null));\n    driverMarkersRef.current.clear();\n\n    if (driverTrips.length === 0) {\n      return;\n    }\n\n    // Group legs by trip\n    const legsByTrip = new Map<Identifier, TripLeg[]>();\n    tripLegs.forEach((leg) => {\n      if (!legsByTrip.has(leg.trip_id)) {\n        legsByTrip.set(leg.trip_id, []);\n      }\n      legsByTrip.get(leg.trip_id)!.push(leg);\n    });\n\n    const staffMap = new Map(staff.map((s) => [s.id, s]));\n    const patientsMap = new Map(patients.map((p) => [p.id, p]));\n    const bounds = new window.google.maps.LatLngBounds();\n\n    // Draw routes and stops for each trip - use async/await properly\n    (async () => {\n      const allRouteCoordinates: google.maps.LatLng[] = [];\n      \n      for (const trip of driverTrips) {\n        const legs = legsByTrip.get(trip.id) || [];\n        const sortedLegs = [...legs].sort((a, b) => a.leg_order - b.leg_order);\n        const routeCoordinates: google.maps.LatLng[] = [];\n\n        // Draw route polyline\n        for (const leg of sortedLegs) {\n          const location = await getLocationForLeg(leg);\n          if (location?.coordinates) {\n            const position = new window.google.maps.LatLng(\n              location.coordinates.latitude,\n              location.coordinates.longitude\n            );\n            routeCoordinates.push(position);\n            allRouteCoordinates.push(position);\n            bounds.extend(position);\n\n            // Check if this stop is active\n            const isActive = activeStops.some((s) => s.id === leg.id);\n            \n            // Check if there's a conflict at this stop\n            const hasConflict = activeConflicts.some(\n              (conflict) => conflict.leg_id === leg.id || conflict.appointment_id === leg.appointment_id\n            );\n\n            // Determine marker color based on state\n            let markerColor = \"#3b82f6\"; // Default blue\n            let markerScale = 10;\n            \n            if (hasConflict) {\n              markerColor = \"#ef4444\"; // Red for conflict\n              markerScale = 14;\n            } else if (isActive) {\n              markerColor = \"#10b981\"; // Green for active\n              markerScale = 12;\n            }\n\n            // Create stop marker with animation for active stops\n            const marker = new window.google.maps.Marker({\n              position,\n              map: mapRef.current,\n              label: {\n                text: String(leg.leg_order),\n                color: \"white\",\n              },\n              icon: {\n                path: window.google.maps.SymbolPath.CIRCLE,\n                scale: markerScale,\n                fillColor: markerColor,\n                fillOpacity: hasConflict ? 0.9 : 1,\n                strokeColor: \"#ffffff\",\n                strokeWeight: hasConflict ? 3 : 2,\n              },\n              title: `Stop ${leg.leg_order}: ${location.name || location.address}${hasConflict ? \" (CONFLICT)\" : \"\"}`,\n              zIndex: hasConflict ? 100 : undefined, // Conflicts on top\n              animation: isActive ? window.google.maps.Animation.BOUNCE : undefined, // Bounce animation for active stops\n            });\n\n            markersRef.current.push(marker);\n            \n            // Add conflict indicator (red circle overlay) for conflicts with pulse animation\n            if (hasConflict) {\n              const conflictMarker = new window.google.maps.Marker({\n                position,\n                map: mapRef.current,\n                icon: {\n                  path: window.google.maps.SymbolPath.CIRCLE,\n                  scale: 18,\n                  fillColor: \"#ef4444\",\n                  fillOpacity: 0.3,\n                  strokeColor: \"#ef4444\",\n                  strokeWeight: 2,\n                },\n                zIndex: 99,\n                animation: window.google.maps.Animation.BOUNCE, // Pulse animation for conflicts\n              });\n              markersRef.current.push(conflictMarker);\n            }\n          }\n        }\n\n        // Draw polyline for route\n        if (routeCoordinates.length > 1) {\n          const polyline = new window.google.maps.Polyline({\n            path: routeCoordinates,\n            geodesic: true,\n            strokeColor: \"#3b82f6\",\n            strokeOpacity: 0.6,\n            strokeWeight: 3,\n          });\n          polyline.setMap(mapRef.current);\n          polylinesRef.current.push(polyline);\n        }\n\n        // Draw driver position marker with smooth animation\n        const driverPosition = driverPositions.get(trip.driver_id);\n        if (driverPosition) {\n          const driver = staffMap.get(trip.driver_id);\n          const driverName = driver\n            ? `${driver.first_name} ${driver.last_name}`.trim()\n            : \"Driver\";\n\n          // Check if marker already exists for smooth animation\n          const existingMarker = driverMarkersRef.current.get(trip.driver_id);\n          const newPosition = new window.google.maps.LatLng(driverPosition.lat, driverPosition.lng);\n\n          if (existingMarker) {\n            // Animate marker movement smoothly\n            const startPosition = existingMarker.getPosition();\n            if (startPosition) {\n              const startLat = startPosition.lat();\n              const startLng = startPosition.lng();\n              const endLat = driverPosition.lat;\n              const endLng = driverPosition.lng;\n\n              // Use Google Maps animation for smooth movement\n              // Calculate steps for animation (10 steps over 200ms)\n              const steps = 10;\n              const duration = 200; // milliseconds\n              let currentStep = 0;\n\n              const animate = () => {\n                if (currentStep >= steps) {\n                  existingMarker.setPosition(newPosition);\n                  return;\n                }\n\n                const progress = currentStep / steps;\n                const lat = startLat + (endLat - startLat) * progress;\n                const lng = startLng + (endLng - startLng) * progress;\n\n                existingMarker.setPosition(new window.google.maps.LatLng(lat, lng));\n                currentStep++;\n\n                if (currentStep < steps) {\n                  setTimeout(animate, duration / steps);\n                }\n              };\n\n              animate();\n            } else {\n              existingMarker.setPosition(newPosition);\n            }\n          } else {\n            // Create new marker\n            const driverMarker = new window.google.maps.Marker({\n              position: newPosition,\n              map: mapRef.current,\n              icon: {\n                path: window.google.maps.SymbolPath.CIRCLE,\n                scale: 10,\n                fillColor: \"#ef4444\", // Red for driver\n                fillOpacity: 1,\n                strokeColor: \"#ffffff\",\n                strokeWeight: 3,\n              },\n              title: driverName,\n              zIndex: 1000, // Above other markers\n              animation: window.google.maps.Animation.DROP, // Drop animation on first appearance\n            });\n\n            driverMarkersRef.current.set(trip.driver_id, driverMarker);\n          }\n\n          bounds.extend(newPosition);\n        }\n      }\n\n      // Fit bounds to show all routes - only if we have valid bounds\n      if (bounds.getNorthEast().lat() !== bounds.getSouthWest().lat() && \n          bounds.getNorthEast().lng() !== bounds.getSouthWest().lng()) {\n        mapRef.current.fitBounds(bounds, { padding: 50 });\n      } else if (allRouteCoordinates.length > 0 || driverPositions.size > 0) {\n        // Fallback: if bounds are invalid but we have coordinates, use them\n        const fallbackBounds = new window.google.maps.LatLngBounds();\n        allRouteCoordinates.forEach(pos => fallbackBounds.extend(pos));\n        driverPositions.forEach(pos => {\n          fallbackBounds.extend(new window.google.maps.LatLng(pos.lat, pos.lng));\n        });\n        \n        if (allRouteCoordinates.length > 0 || driverPositions.size > 0) {\n          mapRef.current.fitBounds(fallbackBounds, { padding: 50 });\n        }\n      } else {\n        // Default to office location if no valid coordinates\n        const fallbackLat = officeLocation?.latitude ?? 25.2048;\n        const fallbackLng = officeLocation?.longitude ?? 55.2708;\n        mapRef.current.setCenter({ lat: fallbackLat, lng: fallbackLng });\n        mapRef.current.setZoom(12);\n      }\n    })();\n  }, [\n    mapLoaded,\n    tripLegs,\n    driverTrips,\n    staff,\n    patients,\n    activeStops,\n    driverPositions,\n    officeLocation,\n  ]);\n\n  return (\n    <div className=\"h-full w-full relative\">\n      <div ref={mapContainerRef} className=\"h-full w-full\" />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/DriverTimelineLanes.tsx",
      "content": "/**\n * DriverTimelineLanes Component\n * \n * Center panel displaying horizontal timeline lanes for each driver.\n * Shows time-based blocks (Pickup, Drop, Appointment, Wait) with color coding.\n * Supports drag-and-drop from unplanned queue.\n */\n\nimport React, { useMemo, useCallback, useRef, useEffect, useState } from \"react\";\nimport { Droppable } from \"@hello-pangea/dnd\";\nimport { format, startOfDay, addHours, setHours } from \"date-fns\";\nimport { X } from \"lucide-react\";\nimport type { Staff, DriverTrip, TripLeg } from \"../types\";\nimport type { Identifier } from \"ra-core\";\nimport { useGetList } from \"ra-core\";\nimport {\n  ContextMenu,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuTrigger,\n} from \"@/components/ui/context-menu\";\n\ntype DriverTimelineLanesProps = {\n  drivers: Staff[];\n  selectedDate: Date;\n  selectedDriverId: Identifier | null;\n  onDriverSelect: (driverId: Identifier | null) => void;\n  onAppointmentHover: (appointmentId: Identifier | null) => void;\n  onUnassignAppointment?: (legId: Identifier, tripId: Identifier) => void;\n  loading: boolean;\n};\n\ntype TimelineBlock = {\n  id: string;\n  type: \"pickup_staff\" | \"drop_staff\" | \"appointment\" | \"wait\" | \"return\";\n  startTime: Date;\n  endTime: Date;\n  label: string;\n  status: \"safe\" | \"tight\" | \"conflict\";\n  appointmentId?: Identifier;\n  legId?: Identifier;\n  tripId?: Identifier;\n};\n\nexport const DriverTimelineLanes: React.FC<DriverTimelineLanesProps> = ({\n  drivers,\n  selectedDate,\n  selectedDriverId,\n  onDriverSelect,\n  onAppointmentHover,\n  onUnassignAppointment,\n  loading,\n}) => {\n  const timelineRef = useRef<HTMLDivElement>(null);\n  const [timelineWidth, setTimelineWidth] = useState(0);\n\n  // Measure timeline width for responsive calculation\n  useEffect(() => {\n    const updateWidth = () => {\n      if (timelineRef.current) {\n        setTimelineWidth(timelineRef.current.offsetWidth);\n      }\n    };\n\n    updateWidth();\n    window.addEventListener(\"resize\", updateWidth);\n    return () => window.removeEventListener(\"resize\", updateWidth);\n  }, []);\n\n  // Fetch driver trips for selected date\n  const selectedDateStr = format(selectedDate, \"yyyy-MM-dd\");\n  const { data: driverTrips } = useGetList<DriverTrip>(\n    \"driver_trips\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      filter: {\n        \"trip_date@eq\": selectedDateStr,\n      },\n    },\n    {\n      retry: false,\n    }\n  );\n\n  // Fetch trip legs for all trips\n  const tripIds = useMemo(() => {\n    return driverTrips?.map((trip) => trip.id) || [];\n  }, [driverTrips]);\n\n  const { data: tripLegs } = useGetList<TripLeg>(\n    \"trip_legs\",\n    {\n      pagination: { page: 1, perPage: 10000 },\n      filter: {\n        \"trip_id@in\": tripIds.length > 0 ? `(${tripIds.join(\",\")})` : \"(-1)\",\n      },\n      sort: { field: \"leg_order\", order: \"ASC\" },\n    },\n    {\n      enabled: tripIds.length > 0,\n      retry: false,\n    }\n  );\n\n  // Group trips by driver\n  const tripsByDriver = useMemo(() => {\n    if (!driverTrips) return new Map<Identifier, DriverTrip[]>();\n    const map = new Map<Identifier, DriverTrip[]>();\n    driverTrips.forEach((trip) => {\n      const driverId = trip.driver_id;\n      if (!map.has(driverId)) {\n        map.set(driverId, []);\n      }\n      map.get(driverId)!.push(trip);\n    });\n    return map;\n  }, [driverTrips]);\n\n  // Group legs by trip\n  const legsByTrip = useMemo(() => {\n    if (!tripLegs) return new Map<Identifier, TripLeg[]>();\n    const map = new Map<Identifier, TripLeg[]>();\n    tripLegs.forEach((leg) => {\n      const tripId = leg.trip_id;\n      if (!map.has(tripId)) {\n        map.set(tripId, []);\n      }\n      map.get(tripId)!.push(leg);\n    });\n    return map;\n  }, [tripLegs]);\n\n  // Calculate timeline blocks for a driver\n  const getDriverBlocks = useCallback(\n    (driverId: Identifier): TimelineBlock[] => {\n      const trips = tripsByDriver.get(driverId) || [];\n      const blocks: TimelineBlock[] = [];\n\n      trips.forEach((trip) => {\n        const legs = legsByTrip.get(trip.id) || [];\n        legs.forEach((leg) => {\n          const startTime = new Date(leg.planned_arrival_time);\n          const endTime = leg.planned_departure_time\n            ? new Date(leg.planned_departure_time)\n            : addHours(startTime, 1);\n\n          let status: \"safe\" | \"tight\" | \"conflict\" = \"safe\";\n\n          blocks.push({\n            id: `leg-${leg.id}`,\n            type: leg.leg_type,\n            startTime,\n            endTime,\n            label: getLegLabel(leg),\n            status,\n            appointmentId: leg.appointment_id,\n            legId: leg.id,\n            tripId: leg.trip_id,\n          });\n        });\n      });\n\n      return blocks.sort((a, b) => a.startTime.getTime() - b.startTime.getTime());\n    },\n    [tripsByDriver, legsByTrip]\n  );\n\n  // Get label for a leg\n  const getLegLabel = (leg: TripLeg): string => {\n    switch (leg.leg_type) {\n      case \"pickup_staff\":\n        return \"Pickup Staff\";\n      case \"drop_staff\":\n        return \"Drop Staff\";\n      case \"appointment\":\n        return \"Appointment\";\n      case \"wait\":\n        return `Wait ${leg.wait_duration_minutes || 0} min`;\n      case \"return\":\n        return \"Return\";\n      default:\n        return leg.leg_type;\n    }\n  };\n\n  // Timeline configuration - 24 hours (midnight to midnight)\n  const dayStart = useMemo(() => startOfDay(selectedDate), [selectedDate]);\n  const dayEnd = useMemo(() => {\n    const nextDay = new Date(selectedDate);\n    nextDay.setDate(nextDay.getDate() + 1);\n    return startOfDay(nextDay);\n  }, [selectedDate]);\n  \n  const totalMinutes = useMemo(() => {\n    return (dayEnd.getTime() - dayStart.getTime()) / (1000 * 60);\n  }, [dayStart, dayEnd]);\n\n  // Get color for block status\n  const getBlockColor = (status: TimelineBlock[\"status\"], type: TimelineBlock[\"type\"]): string => {\n    if (status === \"conflict\") return \"bg-red-500\";\n    if (status === \"tight\") return \"bg-yellow-500\";\n    \n    switch (type) {\n      case \"pickup_staff\":\n      case \"drop_staff\":\n        return \"bg-blue-500\";\n      case \"appointment\":\n        return \"bg-green-500\";\n      case \"wait\":\n        return \"bg-gray-400\";\n      case \"return\":\n        return \"bg-purple-500\";\n      default:\n        return \"bg-slate-500\";\n    }\n  };\n\n  // Calculate position for a block using percentages (responsive)\n  const getBlockPosition = useCallback((block: TimelineBlock) => {\n    const startMinutes = (block.startTime.getTime() - dayStart.getTime()) / (1000 * 60);\n    const durationMinutes = (block.endTime.getTime() - block.startTime.getTime()) / (1000 * 60);\n    \n    const leftPercent = (startMinutes / totalMinutes) * 100;\n    const widthPercent = (durationMinutes / totalMinutes) * 100;\n    \n    return {\n      left: `${leftPercent}%`,\n      width: `${Math.max(widthPercent, 0.5)}%`, // Minimum 0.5% width\n    };\n  }, [dayStart, totalMinutes]);\n\n  if (loading) {\n    return (\n      <div className=\"h-full flex items-center justify-center\">\n        <div className=\"text-slate-500 dark:text-slate-400\">Loading...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      {/* Header */}\n      <div className=\"flex-shrink-0 px-4 py-3 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-sm font-semibold text-slate-900 dark:text-slate-100\">\n            Driver Timelines - 24 Hours\n          </h2>\n          {/* Time scale header - responsive, no scrolling */}\n          <div className=\"flex-1 ml-4\" ref={timelineRef}>\n            <div className=\"flex h-full\">\n              {Array.from({ length: 24 }, (_, i) => i).map((hour) => (\n                <div\n                  key={hour}\n                  className=\"flex-1 text-center border-r border-slate-300 dark:border-slate-600 last:border-r-0\"\n                >\n                  <div className=\"text-xs text-slate-600 dark:text-slate-400 font-medium\">\n                    {format(setHours(dayStart, hour), hour % 3 === 0 ? \"h a\" : \"h\")}\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Timeline Lanes */}\n      <div className=\"flex-1 overflow-y-auto overflow-x-hidden\">\n        {drivers.length === 0 ? (\n          <div className=\"text-center text-slate-500 dark:text-slate-400 py-8 text-sm\">\n            No drivers available\n          </div>\n        ) : (\n          drivers.map((driver) => {\n            const blocks = getDriverBlocks(driver.id);\n            const driverName = `${driver.first_name} ${driver.last_name}`.trim();\n            const isSelected = selectedDriverId === driver.id;\n\n            return (\n              <Droppable\n                key={driver.id}\n                droppableId={`driver-${driver.id}`}\n                direction=\"horizontal\"\n              >\n                {(provided, snapshot) => (\n                  <div\n                    ref={provided.innerRef}\n                    {...provided.droppableProps}\n                    className={`border-b border-slate-200 dark:border-slate-700 ${\n                      snapshot.isDraggingOver ? \"bg-blue-50 dark:bg-blue-900/20\" : \"\"\n                    } ${isSelected ? \"bg-blue-50 dark:bg-blue-900/10\" : \"\"}`}\n                    onClick={() => onDriverSelect(driver.id)}\n                  >\n                    {/* Driver Lane */}\n                    <div className=\"flex items-stretch min-h-[90px]\">\n                      {/* Driver Name */}\n                      <div className=\"w-40 flex-shrink-0 px-4 py-3 bg-slate-100 dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex items-center\">\n                        <div className=\"text-sm font-medium text-slate-900 dark:text-slate-100\">\n                          {driverName}\n                        </div>\n                      </div>\n                      \n                      {/* Timeline Area - Responsive, no scrolling */}\n                      <div className=\"flex-1 relative bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-900/50 dark:to-slate-800/50\">\n                        {/* Hour markers grid - responsive */}\n                        <div className=\"absolute inset-0 flex\">\n                          {Array.from({ length: 24 }, (_, i) => i).map((hour) => (\n                            <div\n                              key={hour}\n                              className=\"flex-1 border-r border-slate-200 dark:border-slate-700 last:border-r-0 relative\"\n                            >\n                              {/* Major hour marker (every 3 hours) */}\n                              {hour % 3 === 0 && (\n                                <div className=\"absolute top-0 left-0 right-0 h-full border-l-2 border-slate-300 dark:border-slate-600\" />\n                              )}\n                              {/* Hour label (every 6 hours) */}\n                              {hour % 6 === 0 && (\n                                <div className=\"absolute top-1 left-1 text-[10px] text-slate-400 dark:text-slate-500 font-medium\">\n                                  {format(setHours(dayStart, hour), \"h a\")}\n                                </div>\n                              )}\n                            </div>\n                          ))}\n                        </div>\n                        \n                        {/* Timeline blocks - responsive positioning */}\n                        <div className=\"absolute inset-0\">\n                          {blocks.map((block) => {\n                            const position = getBlockPosition(block);\n                            \n                            // Can unassign if this is part of an appointment sequence (has tripId and legId)\n                            const canUnassign = (block.type === \"appointment\" || block.type === \"pickup_staff\" || block.type === \"drop_staff\" || block.type === \"return\") && block.legId && block.tripId && onUnassignAppointment;\n                            \n                            const blockElement = (\n                              <div\n                                key={block.id}\n                                className={`absolute top-2 bottom-2 ${getBlockColor(block.status, block.type)} rounded-md text-white text-xs px-2 py-1.5 flex items-center justify-center cursor-pointer hover:opacity-90 hover:shadow-lg hover:scale-105 transition-all z-10 font-medium`}\n                                style={position}\n                                onMouseEnter={() => {\n                                  if (block.appointmentId) {\n                                    onAppointmentHover(block.appointmentId);\n                                  }\n                                }}\n                                onMouseLeave={() => onAppointmentHover(null)}\n                                title={`${block.label} - ${format(block.startTime, \"h:mm a\")} to ${format(block.endTime, \"h:mm a\")}${canUnassign ? \" (Right-click to unassign)\" : \"\"}`}\n                              >\n                                <span className=\"truncate\">{block.label}</span>\n                              </div>\n                            );\n\n                            if (canUnassign) {\n                              return (\n                                <ContextMenu key={block.id}>\n                                  <ContextMenuTrigger asChild>\n                                    {blockElement}\n                                  </ContextMenuTrigger>\n                                  <ContextMenuContent>\n                                    <ContextMenuItem\n                                      variant=\"destructive\"\n                                      onClick={(e) => {\n                                        e.stopPropagation();\n                                        if (block.legId && block.tripId && onUnassignAppointment) {\n                                          onUnassignAppointment(block.legId, block.tripId);\n                                        }\n                                      }}\n                                    >\n                                      <X className=\"w-4 h-4 mr-2\" />\n                                      Unassign Appointment\n                                    </ContextMenuItem>\n                                  </ContextMenuContent>\n                                </ContextMenu>\n                              );\n                            }\n\n                            return blockElement;\n                          })}\n                        </div>\n                      </div>\n                    </div>\n                    {provided.placeholder}\n                  </div>\n                )}\n              </Droppable>\n            );\n          })\n        )}\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/utils/travelTimeCalculator.ts",
      "content": "/**\n * Travel Time Calculator\n * \n * This module provides utilities for calculating travel times between locations\n * with traffic awareness using the Google Maps Distance Matrix API.\n */\n\nimport { getDistanceMatrixWithRateLimit, type DistanceMatrixRequest } from \"./googleMapsApi\";\nimport { calculateHaversineDistance } from \"./distanceCalculator\";\nimport type { Location } from \"../types\";\n\nexport type TravelTimeResult = {\n  duration_seconds: number;\n  duration_minutes: number;\n  duration_in_traffic_seconds?: number;\n  duration_in_traffic_minutes?: number;\n  status: \"OK\" | \"NOT_FOUND\" | \"ZERO_RESULTS\" | \"MAX_ROUTE_LENGTH_EXCEEDED\";\n  origin_address?: string;\n  destination_address?: string;\n  has_traffic_data: boolean;\n};\n\n/**\n * Calculate travel time between two locations with traffic awareness\n * \n * @param origin - Origin location (coordinates or address string)\n * @param destination - Destination location (coordinates or address string)\n * @param options - Optional parameters including departure time and traffic model\n * @returns Travel time result with base duration and traffic-aware duration\n */\n// Track if Google Maps API is available (set to false on first failure)\nlet googleMapsApiAvailable: boolean | null = null;\n\nexport async function calculateTravelTime(\n  origin: { lat: number; lng: number } | string,\n  destination: { lat: number; lng: number } | string,\n  options?: {\n    mode?: \"driving\" | \"walking\" | \"bicycling\" | \"transit\";\n    departure_time?: Date | \"now\";\n    traffic_model?: \"best_guess\" | \"pessimistic\" | \"optimistic\";\n    avoid?: \"tolls\" | \"highways\" | \"ferries\" | \"indoor\";\n  }\n): Promise<TravelTimeResult> {\n  // If API is known to be unavailable, skip directly to fallback\n  if (googleMapsApiAvailable === false) {\n    return calculateTravelTimeFallback(origin, destination);\n  }\n\n  const request: DistanceMatrixRequest = {\n    origins: [origin],\n    destinations: [destination],\n    mode: options?.mode || \"driving\",\n    departure_time: options?.departure_time || \"now\",\n    traffic_model: options?.traffic_model || \"best_guess\",\n    avoid: options?.avoid,\n  };\n  \n  try {\n    const response = await getDistanceMatrixWithRateLimit(request);\n    \n    if (response.status !== \"OK\") {\n      return {\n        duration_seconds: 0,\n        duration_minutes: 0,\n        status: response.status as TravelTimeResult[\"status\"],\n        has_traffic_data: false,\n      };\n    }\n    \n    const element = response.rows[0]?.elements[0];\n    \n    if (!element || element.status !== \"OK\") {\n      return {\n        duration_seconds: 0,\n        duration_minutes: 0,\n        status: (element?.status || \"NOT_FOUND\") as TravelTimeResult[\"status\"],\n        has_traffic_data: false,\n      };\n    }\n    \n    const duration_seconds = element.duration?.value || 0;\n    const duration_minutes = duration_seconds / 60;\n    \n    const duration_in_traffic_seconds = element.duration_in_traffic?.value;\n    const duration_in_traffic_minutes = duration_in_traffic_seconds\n      ? duration_in_traffic_seconds / 60\n      : undefined;\n    \n    return {\n      duration_seconds,\n      duration_minutes,\n      duration_in_traffic_seconds,\n      duration_in_traffic_minutes,\n      status: \"OK\",\n      origin_address: response.origin_addresses[0],\n      destination_address: response.destination_addresses[0],\n      has_traffic_data: !!duration_in_traffic_seconds,\n    };\n  } catch (error) {\n    // Mark API as unavailable on first failure\n    if (googleMapsApiAvailable === null) {\n      console.warn(\"Google Maps API unavailable, using fallback for all calculations\");\n      googleMapsApiAvailable = false;\n    }\n    \n    // Use fallback immediately\n    return calculateTravelTimeFallback(origin, destination);\n  }\n}\n\n/**\n * Fallback travel time calculation using haversine distance\n */\nfunction calculateTravelTimeFallback(\n  origin: { lat: number; lng: number } | string,\n  destination: { lat: number; lng: number } | string\n): TravelTimeResult {\n  try {\n    const originCoords = typeof origin === \"string\" ? null : origin;\n    const destCoords = typeof destination === \"string\" ? null : destination;\n    \n    if (originCoords && destCoords) {\n      // Calculate distance using haversine formula\n      const distanceKm = calculateHaversineDistance(originCoords, destCoords);\n      \n      // Estimate travel time: ~2 minutes per km for city driving (average speed ~30 km/h)\n      // Add 10 minutes base time for city traffic, stops, etc.\n      const estimatedMinutes = Math.max(5, Math.round(distanceKm * 2 + 10));\n      const estimatedSeconds = estimatedMinutes * 60;\n      \n      return {\n        duration_seconds: estimatedSeconds,\n        duration_minutes: estimatedMinutes,\n        duration_in_traffic_seconds: estimatedSeconds,\n        duration_in_traffic_minutes: estimatedMinutes,\n        status: \"OK\",\n        has_traffic_data: false,\n      };\n    }\n  } catch (fallbackError) {\n    console.warn(\"Fallback calculation failed:\", fallbackError);\n  }\n  \n  // Default estimate if calculation fails\n  return {\n    duration_seconds: 30 * 60,\n    duration_minutes: 30,\n    status: \"OK\",\n    has_traffic_data: false,\n  };\n}\n\n/**\n * Calculate travel times between multiple origins and destinations\n * \n * @param origins - Array of origin locations\n * @param destinations - Array of destination locations\n * @param options - Optional parameters\n * @returns Matrix of travel time results (origins x destinations)\n */\nexport async function calculateTravelTimeMatrix(\n  origins: Array<{ lat: number; lng: number } | string>,\n  destinations: Array<{ lat: number; lng: number } | string>,\n  options?: {\n    mode?: \"driving\" | \"walking\" | \"bicycling\" | \"transit\";\n    departure_time?: Date | \"now\";\n    traffic_model?: \"best_guess\" | \"pessimistic\" | \"optimistic\";\n    avoid?: \"tolls\" | \"highways\" | \"ferries\" | \"indoor\";\n  }\n): Promise<TravelTimeResult[][]> {\n  const request: DistanceMatrixRequest = {\n    origins,\n    destinations,\n    mode: options?.mode || \"driving\",\n    departure_time: options?.departure_time || \"now\",\n    traffic_model: options?.traffic_model || \"best_guess\",\n    avoid: options?.avoid,\n  };\n  \n  try {\n    const response = await getDistanceMatrixWithRateLimit(request);\n    \n    if (response.status !== \"OK\") {\n      // Return empty matrix on error\n      return origins.map(() =>\n        destinations.map(() => ({\n          duration_seconds: 0,\n          duration_minutes: 0,\n          status: response.status as TravelTimeResult[\"status\"],\n          has_traffic_data: false,\n        }))\n      );\n    }\n    \n    return response.rows.map((row, originIndex) =>\n      row.elements.map((element, destIndex) => {\n        if (element.status !== \"OK\") {\n          return {\n            duration_seconds: 0,\n            duration_minutes: 0,\n            status: element.status as TravelTimeResult[\"status\"],\n            origin_address: response.origin_addresses[originIndex],\n            destination_address: response.destination_addresses[destIndex],\n            has_traffic_data: false,\n          };\n        }\n        \n        const duration_seconds = element.duration?.value || 0;\n        const duration_minutes = duration_seconds / 60;\n        \n        const duration_in_traffic_seconds = element.duration_in_traffic?.value;\n        const duration_in_traffic_minutes = duration_in_traffic_seconds\n          ? duration_in_traffic_seconds / 60\n          : undefined;\n        \n        return {\n          duration_seconds,\n          duration_minutes,\n          duration_in_traffic_seconds,\n          duration_in_traffic_minutes,\n          status: \"OK\" as const,\n          origin_address: response.origin_addresses[originIndex],\n          destination_address: response.destination_addresses[destIndex],\n          has_traffic_data: !!duration_in_traffic_seconds,\n        };\n      })\n    );\n  } catch (error) {\n    // Mark API as unavailable on first failure\n    if (googleMapsApiAvailable === null) {\n      console.warn(\"Google Maps API unavailable, using fallback for all calculations\");\n      googleMapsApiAvailable = false;\n    }\n    \n    // Fallback: Use haversine distance for each origin-destination pair\n    return origins.map((origin) =>\n      destinations.map((destination) => {\n        const result = calculateTravelTimeFallback(origin, destination);\n        return {\n          ...result,\n          status: \"OK\" as const,\n        };\n      })\n    );\n  }\n}\n\n/**\n * Calculate travel time between two Location objects\n * \n * @param origin - Origin location\n * @param destination - Destination location\n * @param options - Optional parameters\n * @returns Travel time result\n */\nexport async function calculateTravelTimeBetweenLocations(\n  origin: Location,\n  destination: Location,\n  options?: {\n    mode?: \"driving\" | \"walking\" | \"bicycling\" | \"transit\";\n    departure_time?: Date | \"now\";\n    traffic_model?: \"best_guess\" | \"pessimistic\" | \"optimistic\";\n    avoid?: \"tolls\" | \"highways\" | \"ferries\" | \"indoor\";\n  }\n): Promise<TravelTimeResult> {\n  // Extract coordinates from Location objects\n  const originCoords = origin.coordinates\n    ? { lat: origin.coordinates.latitude, lng: origin.coordinates.longitude }\n    : origin.address || \"\";\n  \n  const destCoords = destination.coordinates\n    ? { lat: destination.coordinates.latitude, lng: destination.coordinates.longitude }\n    : destination.address || \"\";\n  \n  if (!originCoords || !destCoords) {\n    // If no coordinates, use fallback estimate\n    console.warn(\"No coordinates available, using default travel time estimate\");\n    return {\n      duration_seconds: 30 * 60,\n      duration_minutes: 30,\n      status: \"OK\",\n      has_traffic_data: false,\n    };\n  }\n  \n  return calculateTravelTime(originCoords, destCoords, options);\n}\n\n/**\n * Get the effective travel time (uses traffic data if available, otherwise base duration)\n * \n * @param result - Travel time result\n * @returns Effective travel time in minutes\n */\nexport function getEffectiveTravelTime(result: TravelTimeResult): number {\n  return result.duration_in_traffic_minutes ?? result.duration_minutes;\n}\n\n/**\n * Check if travel time result indicates a feasible route\n * \n * @param result - Travel time result\n * @returns True if route is feasible\n */\nexport function isRouteFeasible(result: TravelTimeResult): boolean {\n  return result.status === \"OK\" && result.duration_minutes > 0;\n}\n\n/**\n * Calculate ETA (Estimated Time of Arrival) based on current time and travel time\n * \n * @param departureTime - When the trip starts (Date object or \"now\")\n * @param travelTimeMinutes - Travel time in minutes (from calculateTravelTime)\n * @returns ETA as Date object\n */\nexport function calculateETA(\n  departureTime: Date | \"now\",\n  travelTimeMinutes: number\n): Date {\n  const now = new Date();\n  const departure = departureTime === \"now\" ? now : departureTime;\n  const eta = new Date(departure.getTime() + travelTimeMinutes * 60 * 1000);\n  return eta;\n}\n\n/**\n * Calculate ETA with traffic awareness\n * Uses traffic data if available, otherwise falls back to base duration\n * \n * @param departureTime - When the trip starts\n * @param travelTimeResult - Travel time result from calculateTravelTime\n * @returns ETA as Date object\n */\nexport function calculateETAWithTraffic(\n  departureTime: Date | \"now\",\n  travelTimeResult: TravelTimeResult\n): Date {\n  const effectiveTravelTime = getEffectiveTravelTime(travelTimeResult);\n  return calculateETA(departureTime, effectiveTravelTime);\n}\n\n/**\n * Recalculate ETA dynamically based on current time and updated travel time\n * Useful for real-time updates when driver status changes\n * \n * @param originalDepartureTime - Original planned departure time\n * @param currentTime - Current time (defaults to now)\n * @param updatedTravelTimeMinutes - Updated travel time in minutes\n * @returns Updated ETA as Date object\n */\nexport function recalculateETA(\n  originalDepartureTime: Date,\n  updatedTravelTimeMinutes: number,\n  currentTime: Date = new Date()\n): Date {\n  // If we're past the original departure time, calculate from now\n  const effectiveDepartureTime = currentTime > originalDepartureTime \n    ? currentTime \n    : originalDepartureTime;\n  \n  return calculateETA(effectiveDepartureTime, updatedTravelTimeMinutes);\n}\n\n/**\n * Get time remaining until ETA\n * \n * @param eta - Estimated time of arrival\n * @param currentTime - Current time (defaults to now)\n * @returns Time remaining in minutes (negative if ETA has passed)\n */\nexport function getTimeRemainingUntilETA(\n  eta: Date,\n  currentTime: Date = new Date()\n): number {\n  const diffMs = eta.getTime() - currentTime.getTime();\n  return diffMs / (60 * 1000); // Convert to minutes\n}\n\n/**\n * Check if ETA is still valid (not too far in the past)\n * \n * @param eta - Estimated time of arrival\n * @param currentTime - Current time (defaults to now)\n * @param maxAgeMinutes - Maximum age in minutes before ETA is considered stale (default: 30)\n * @returns True if ETA is still valid\n */\nexport function isETAValid(\n  eta: Date,\n  currentTime: Date = new Date(),\n  maxAgeMinutes: number = 30\n): boolean {\n  const timeRemaining = getTimeRemainingUntilETA(eta, currentTime);\n  // ETA is valid if it's in the future or within maxAgeMinutes in the past\n  return timeRemaining >= -maxAgeMinutes;\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/utils/pickupDropSuggester.ts",
      "content": "/**\n * Pickup/Drop Suggester\n * \n * Logic to suggest Office/Home/Metro for staff pickup/drop\n * based on proximity and 2-hour wait rule.\n */\n\nimport type { Identifier } from \"ra-core\";\nimport type { Appointment, Staff, Contact } from \"../../types\";\nimport type { PickupDropSuggestion, LocationType, Location } from \"../types\";\nimport { calculateHaversineDistance } from \"./distanceCalculator\";\nimport {\n  extractContactCoordinates,\n  getOfficeLocation,\n  getMetroLocation,\n  getStaffHomeLocation,\n} from \"./coordinateExtractor\";\nimport type { OfficeLocation } from \"@/hooks/useOfficeLocation\";\n\n/**\n * Suggest pickup and drop locations for staff\n * \n * @param appointment - Appointment requiring staff pickup/drop\n * @param staff - Staff member to pick up/drop\n * @param patient - Patient/contact for the appointment\n * @param previousAppointmentEndTime - End time of previous appointment (if any)\n * @param nextAppointmentStartTime - Start time of next appointment (if any)\n * @param officeLocationOverride - Optional office location from settings (for accurate distance calculations)\n * @returns Pickup and drop location suggestions\n */\nexport async function suggestPickupDrop(\n  appointment: Appointment,\n  staff: Staff | null,\n  patient: Contact | null,\n  previousAppointmentEndTime?: Date | null,\n  nextAppointmentStartTime?: Date | null,\n  officeLocationOverride?: OfficeLocation | null\n): Promise<PickupDropSuggestion | null> {\n  if (!staff || !patient) return null;\n\n  const appointmentStartTime = new Date(appointment.start_time);\n  const appointmentEndTime = new Date(appointment.end_time);\n  const patientLocation = extractContactCoordinates(patient);\n\n  if (!patientLocation?.coordinates) {\n    return null;\n  }\n\n  // Get available locations - use office location from settings if provided\n  const officeLocation = getOfficeLocation(officeLocationOverride);\n  const metroLocation = getMetroLocation();\n  const homeLocation = getStaffHomeLocation(staff);\n\n  // Suggest pickup location (before appointment)\n  const pickupLocation = await suggestPickupLocation(\n    officeLocation,\n    homeLocation,\n    metroLocation,\n    patientLocation,\n    appointmentStartTime,\n    previousAppointmentEndTime\n  );\n\n  // Suggest drop location (after appointment)\n  const dropLocation = await suggestDropLocation(\n    officeLocation,\n    homeLocation,\n    metroLocation,\n    patientLocation,\n    appointmentEndTime,\n    nextAppointmentStartTime\n  );\n\n  // Calculate time/distance savings\n  const savings = await calculateSavings(\n    pickupLocation,\n    dropLocation,\n    patientLocation,\n    officeLocation\n  );\n\n  const reasoning = buildReasoning(\n    pickupLocation,\n    dropLocation,\n    appointmentStartTime,\n    appointmentEndTime,\n    previousAppointmentEndTime,\n    nextAppointmentStartTime\n  );\n\n  return {\n    appointment_id: appointment.id,\n    staff_id: staff.id,\n    pickup_location: pickupLocation,\n    drop_location: dropLocation,\n    reasoning,\n    time_saved_minutes: savings.timeSaved,\n    distance_saved_km: savings.distanceSaved,\n  };\n}\n\n/**\n * Suggest pickup location based on proximity and time\n */\nasync function suggestPickupLocation(\n  office: Location,\n  home: Location | null,\n  metro: Location,\n  patient: Location,\n  appointmentTime: Date,\n  previousAppointmentEndTime?: Date | null\n): Promise<LocationType> {\n  // If morning appointment (before 12 PM), prefer office\n  const hour = appointmentTime.getHours();\n  if (hour < 12) {\n    return \"office\";\n  }\n\n  // If there's a previous appointment, check proximity\n  if (previousAppointmentEndTime) {\n    // If previous appointment ended recently, prefer staying near patient area\n    const timeSincePrevious = (appointmentTime.getTime() - previousAppointmentEndTime.getTime()) / (60 * 1000);\n    if (timeSincePrevious < 60) {\n      // Recent appointment - prefer metro or home if closer\n      if (home?.coordinates) {\n        const homeDistance = calculateHaversineDistance(\n          home.coordinates,\n          patient.coordinates\n        );\n        const officeDistance = calculateHaversineDistance(\n          office.coordinates,\n          patient.coordinates\n        );\n\n        if (homeDistance < officeDistance) {\n          return \"home\";\n        }\n      }\n    }\n  }\n\n  // Default to office for pickup\n  return \"office\";\n}\n\n/**\n * Suggest drop location based on proximity and wait time\n */\nasync function suggestDropLocation(\n  office: Location,\n  home: Location | null,\n  metro: Location,\n  patient: Location,\n  appointmentEndTime: Date,\n  nextAppointmentStartTime?: Date | null\n): Promise<LocationType> {\n  // If no next appointment, return to office\n  if (!nextAppointmentStartTime) {\n    return \"office\";\n  }\n\n  // Calculate wait time until next appointment\n  const waitMinutes = (nextAppointmentStartTime.getTime() - appointmentEndTime.getTime()) / (60 * 1000);\n\n  // If wait  2 hours AND no other jobs  suggest WAIT (return to office)\n  // Otherwise  suggest LEAVE (metro or home if closer)\n  if (waitMinutes <= 120) {\n    // Short wait - return to office\n    return \"office\";\n  }\n\n  // Long wait - suggest metro or home if closer to next appointment\n  // For now, default to metro (could be enhanced to check next appointment location)\n  if (home?.coordinates) {\n    const homeDistance = calculateHaversineDistance(\n      home.coordinates,\n      patient.coordinates\n    );\n    const metroDistance = calculateHaversineDistance(\n      metro.coordinates,\n      patient.coordinates\n    );\n\n    if (homeDistance < metroDistance && homeDistance < 10) {\n      // Home is closer and reasonable distance\n      return \"home\";\n    }\n  }\n\n  return \"metro\";\n}\n\n/**\n * Calculate time and distance savings\n */\nasync function calculateSavings(\n  pickupLocation: LocationType,\n  dropLocation: LocationType,\n  patientLocation: Location,\n  officeLocation: Location\n): Promise<{ timeSaved: number; distanceSaved: number }> {\n  // Simplified calculation - would use Google Maps in production\n  let timeSaved = 0;\n  let distanceSaved = 0;\n\n  // If not using office for both, calculate savings\n  if (pickupLocation !== \"office\" || dropLocation !== \"office\") {\n    // Estimate savings (simplified)\n    if (pickupLocation !== \"office\") {\n      timeSaved += 5; // Estimate 5 minutes saved\n      distanceSaved += 2; // Estimate 2km saved\n    }\n    if (dropLocation !== \"office\") {\n      timeSaved += 5;\n      distanceSaved += 2;\n    }\n  }\n\n  return { timeSaved, distanceSaved };\n}\n\n/**\n * Build reasoning text for suggestion\n */\nfunction buildReasoning(\n  pickupLocation: LocationType,\n  dropLocation: LocationType,\n  appointmentStartTime: Date,\n  appointmentEndTime: Date,\n  previousAppointmentEndTime?: Date | null,\n  nextAppointmentStartTime?: Date | null\n): string {\n  const reasons: string[] = [];\n\n  if (pickupLocation === \"office\") {\n    reasons.push(\"Pickup from office (standard)\");\n  } else if (pickupLocation === \"home\") {\n    reasons.push(\"Pickup from home (closer to patient)\");\n  } else {\n    reasons.push(\"Pickup from metro (convenient)\");\n  }\n\n  if (dropLocation === \"office\") {\n    if (nextAppointmentStartTime) {\n      const waitMinutes = (nextAppointmentStartTime.getTime() - appointmentEndTime.getTime()) / (60 * 1000);\n      if (waitMinutes <= 120) {\n        reasons.push(\"Return to office (short wait 2 hours)\");\n      } else {\n        reasons.push(\"Return to office\");\n      }\n    } else {\n      reasons.push(\"Return to office (end of day)\");\n    }\n  } else if (dropLocation === \"home\") {\n    reasons.push(\"Drop at home (long wait, closer to next appointment)\");\n  } else {\n    reasons.push(\"Drop at metro (long wait, convenient)\");\n  }\n\n  return reasons.join(\". \");\n}\n\n/**\n * Determine if driver should WAIT or LEAVE after appointment\n * Rule: If wait  2 hours AND no other jobs  WAIT, otherwise  LEAVE\n */\nexport function suggestWaitVsLeave(\n  appointmentEndTime: Date,\n  nextAppointmentStartTime: Date | null,\n  hasOtherJobs: boolean\n): \"wait\" | \"leave\" {\n  if (!nextAppointmentStartTime) {\n    return \"leave\"; // No next appointment\n  }\n\n  const waitMinutes = (nextAppointmentStartTime.getTime() - appointmentEndTime.getTime()) / (60 * 1000);\n\n  if (waitMinutes <= 120 && !hasOtherJobs) {\n    return \"wait\";\n  }\n\n  return \"leave\";\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/utils/googleMapsApi.ts",
      "content": "/**\n * Google Maps API Wrapper\n * \n * This module provides utilities for interacting with Google Maps APIs:\n * - Distance Matrix API: Calculate distances and travel times between multiple origins and destinations\n * - Directions API: Get detailed route information with turn-by-turn directions\n * \n * Both APIs are REST-based and require an API key.\n */\n\nexport type DistanceMatrixRequest = {\n  origins: Array<{ lat: number; lng: number } | string>;\n  destinations: Array<{ lat: number; lng: number } | string>;\n  mode?: \"driving\" | \"walking\" | \"bicycling\" | \"transit\";\n  departure_time?: Date | \"now\";\n  traffic_model?: \"best_guess\" | \"pessimistic\" | \"optimistic\";\n  avoid?: \"tolls\" | \"highways\" | \"ferries\" | \"indoor\";\n  units?: \"metric\" | \"imperial\";\n  region?: string;\n};\n\nexport type DistanceMatrixResponse = {\n  status: string;\n  origin_addresses: string[];\n  destination_addresses: string[];\n  rows: Array<{\n    elements: Array<{\n      status: string;\n      distance?: {\n        value: number; // in meters\n        text: string;\n      };\n      duration?: {\n        value: number; // in seconds\n        text: string;\n      };\n      duration_in_traffic?: {\n        value: number; // in seconds\n        text: string;\n      };\n    }>;\n  }>;\n};\n\nexport type DirectionsRequest = {\n  origin: { lat: number; lng: number } | string;\n  destination: { lat: number; lng: number } | string;\n  waypoints?: Array<{ lat: number; lng: number } | string>;\n  mode?: \"driving\" | \"walking\" | \"bicycling\" | \"transit\";\n  departure_time?: Date | \"now\";\n  traffic_model?: \"best_guess\" | \"pessimistic\" | \"optimistic\";\n  avoid?: \"tolls\" | \"highways\" | \"ferries\" | \"indoor\";\n  optimize_waypoints?: boolean;\n  alternatives?: boolean;\n};\n\nexport type DirectionsResponse = {\n  status: string;\n  routes: Array<{\n    bounds: {\n      northeast: { lat: number; lng: number };\n      southwest: { lat: number; lng: number };\n    };\n    legs: Array<{\n      distance: { value: number; text: string };\n      duration: { value: number; text: string };\n      duration_in_traffic?: { value: number; text: string };\n      start_address: string;\n      end_address: string;\n      start_location: { lat: number; lng: number };\n      end_location: { lat: number; lng: number };\n      steps: Array<{\n        distance: { value: number; text: string };\n        duration: { value: number; text: string };\n        start_location: { lat: number; lng: number };\n        end_location: { lat: number; lng: number };\n        html_instructions: string;\n        travel_mode: string;\n      }>;\n    }>;\n    overview_polyline: {\n      points: string; // Encoded polyline\n    };\n    summary: string;\n    warnings: string[];\n    waypoint_order?: number[];\n  }>;\n  geocoded_waypoints?: Array<{\n    geocoder_status: string;\n    place_id: string;\n    types: string[];\n  }>;\n};\n\nexport type ApiError = {\n  status: string;\n  error_message?: string;\n  code?: number;\n};\n\n// Track if API is known to be unavailable (to skip future calls)\nlet apiUnavailable = false;\n\n/**\n * Get Google Maps API key from environment variables\n */\nfunction getApiKey(): string | null {\n  const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;\n  \n  // Debug: Check if env var is accessible\n  if (import.meta.env.DEV) {\n    console.debug(\"Checking Google Maps API key...\");\n    console.debug(\"VITE_GOOGLE_MAPS_API_KEY exists:\", !!apiKey);\n    console.debug(\"VITE_GOOGLE_MAPS_API_KEY length:\", apiKey?.length || 0);\n    // Log all VITE_ prefixed env vars to help debug\n    const viteEnvVars = Object.keys(import.meta.env).filter(key => key.startsWith('VITE_'));\n    console.debug(\"Available VITE_ env vars:\", viteEnvVars);\n  }\n  \n  if (!apiKey || apiKey.trim() === \"\") {\n    return null; // Return null instead of throwing\n  }\n  \n  // Basic validation - Google API keys are typically long alphanumeric strings\n  if (apiKey.length < 20) {\n    console.warn(\"Google Maps API key appears to be invalid (too short). Please verify your API key.\");\n  }\n  \n  return apiKey;\n}\n\n/**\n * Check if API should be used (not marked as unavailable)\n */\nexport function isGoogleMapsApiAvailable(): boolean {\n  return !apiUnavailable && getApiKey() !== null;\n}\n\n/**\n * Mark API as unavailable (called when API fails)\n */\nexport function markGoogleMapsApiUnavailable(): void {\n  apiUnavailable = true;\n}\n\n/**\n * Format coordinates for API request\n */\nfunction formatCoordinates(coords: { lat: number; lng: number } | string): string {\n  if (typeof coords === \"string\") {\n    return coords;\n  }\n  return `${coords.lat},${coords.lng}`;\n}\n\n/**\n * Format departure time for API request\n */\nfunction formatDepartureTime(departureTime?: Date | \"now\"): string | undefined {\n  if (!departureTime) return undefined;\n  if (departureTime === \"now\") return \"now\";\n  return Math.floor(departureTime.getTime() / 1000).toString();\n}\n\n/**\n * Retry configuration\n */\nconst RETRY_CONFIG = {\n  maxRetries: 3,\n  retryDelay: 1000, // 1 second\n  retryableStatuses: [\"OVER_QUERY_LIMIT\", \"REQUEST_DENIED\", \"UNKNOWN_ERROR\"],\n};\n\n/**\n * Sleep utility for retry delays\n */\nfunction sleep(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\n/**\n * Check if error is retryable\n */\nfunction isRetryableError(status: string): boolean {\n  return RETRY_CONFIG.retryableStatuses.includes(status);\n}\n\n/**\n * Call Google Maps Distance Matrix API\n * \n * @param request - Distance Matrix API request parameters\n * @param retryCount - Current retry attempt (internal use)\n * @returns Promise with Distance Matrix API response\n */\nexport async function getDistanceMatrix(\n  request: DistanceMatrixRequest,\n  retryCount = 0\n): Promise<DistanceMatrixResponse> {\n  // Skip API call if marked as unavailable\n  if (apiUnavailable) {\n    throw new Error(\"Google Maps API is unavailable - using fallback\");\n  }\n\n  const apiKey = getApiKey();\n  if (!apiKey) {\n    apiUnavailable = true;\n    throw new Error(\"Google Maps API key not found - using fallback\");\n  }\n  \n  // Build query parameters\n  const params = new URLSearchParams();\n  \n  // Format origins\n  const origins = request.origins.map(formatCoordinates);\n  params.append(\"origins\", origins.join(\"|\"));\n  \n  // Format destinations\n  const destinations = request.destinations.map(formatCoordinates);\n  params.append(\"destinations\", destinations.join(\"|\"));\n  \n  // Add optional parameters\n  if (request.mode) {\n    params.append(\"mode\", request.mode);\n  }\n  \n  if (request.departure_time) {\n    const departureTime = formatDepartureTime(request.departure_time);\n    if (departureTime) {\n      params.append(\"departure_time\", departureTime);\n    }\n  }\n  \n  if (request.traffic_model) {\n    params.append(\"traffic_model\", request.traffic_model);\n  }\n  \n  if (request.avoid) {\n    params.append(\"avoid\", request.avoid);\n  }\n  \n  if (request.units) {\n    params.append(\"units\", request.units);\n  }\n  \n  if (request.region) {\n    params.append(\"region\", request.region);\n  }\n  \n  params.append(\"key\", apiKey);\n  \n  const url = `https://maps.googleapis.com/maps/api/distancematrix/json?${params.toString()}`;\n  \n  // Log request details in development\n  if (import.meta.env.DEV) {\n    const urlForLogging = url.replace(/key=[^&]+/, 'key=***');\n    console.debug(\"Google Maps Distance Matrix API request:\", urlForLogging);\n  }\n  \n  // Check if API is marked as unavailable - skip immediately\n  if (apiUnavailable) {\n    throw new Error(\"Google Maps API is unavailable - using fallback\");\n  }\n\n  try {\n    // Use simple fetch without custom headers to avoid CORS preflight issues\n    // Google Maps APIs support CORS, but we want to keep the request simple\n    const response = await fetch(url, { \n      signal: AbortSignal.timeout(5000) // 5 second timeout\n    });\n    \n    if (!response.ok) {\n      // Try to get error details from response\n      let errorMessage = `HTTP error! status: ${response.status}`;\n      let errorDetails: any = null;\n      try {\n        errorDetails = await response.json();\n        if (errorDetails.error_message) {\n          errorMessage = `Google Maps API error: ${errorDetails.error_message}`;\n        } else if (errorDetails.status) {\n          errorMessage = `Google Maps API error: ${errorDetails.status}`;\n        }\n        console.error(\"Google Maps API error response:\", errorDetails);\n      } catch (e) {\n        // If we can't parse the error, try to get text\n        try {\n          const errorText = await response.text();\n          console.error(\"Google Maps API error (text):\", errorText);\n        } catch {\n          // If we can't parse the error, use the status\n        }\n      }\n      throw new Error(errorMessage);\n    }\n    \n    const data: DistanceMatrixResponse | ApiError = await response.json();\n    \n    // Check for API errors\n    if (\"status\" in data && data.status !== \"OK\") {\n      // Handle retryable errors\n      if (isRetryableError(data.status) && retryCount < RETRY_CONFIG.maxRetries) {\n        const delay = RETRY_CONFIG.retryDelay * Math.pow(2, retryCount); // Exponential backoff\n        await sleep(delay);\n        return getDistanceMatrix(request, retryCount + 1);\n      }\n      \n      const errorMessage = `Distance Matrix API error: ${data.status}${\"error_message\" in data ? ` - ${data.error_message}` : \"\"}`;\n      throw new Error(errorMessage);\n    }\n    \n    return data as DistanceMatrixResponse;\n  } catch (error) {\n    // Log detailed error information\n    console.error(\"Google Maps API fetch error:\", error);\n    console.error(\"Error type:\", error instanceof Error ? error.constructor.name : typeof error);\n    console.error(\"Error message:\", error instanceof Error ? error.message : String(error));\n    console.error(\"Error stack:\", error instanceof Error ? error.stack : \"No stack trace\");\n    \n    if (error instanceof TypeError && error.message === \"Failed to fetch\") {\n      // Mark API as unavailable on first network failure\n      if (retryCount === 0) {\n        apiUnavailable = true;\n        console.warn(\"Google Maps API unavailable (network/CORS error). Using fallback calculations for all requests.\");\n      }\n      \n      // Don't retry - fail fast and use fallback\n      throw new Error(\"Google Maps API unavailable - using fallback\");\n    }\n    \n    // For other errors, don't retry either - fail fast\n    throw error;\n  }\n}\n\n/**\n * Call Google Maps Directions API\n * \n * @param request - Directions API request parameters\n * @param retryCount - Current retry attempt (internal use)\n * @returns Promise with Directions API response\n */\nexport async function getDirections(\n  request: DirectionsRequest,\n  retryCount = 0\n): Promise<DirectionsResponse> {\n  const apiKey = getApiKey();\n  \n  // Build query parameters\n  const params = new URLSearchParams();\n  \n  // Format origin\n  params.append(\"origin\", formatCoordinates(request.origin));\n  \n  // Format destination\n  params.append(\"destination\", formatCoordinates(request.destination));\n  \n  // Format waypoints if provided\n  if (request.waypoints && request.waypoints.length > 0) {\n    const waypoints = request.waypoints.map(formatCoordinates);\n    params.append(\"waypoints\", waypoints.join(\"|\"));\n  }\n  \n  // Add optional parameters\n  if (request.mode) {\n    params.append(\"mode\", request.mode);\n  }\n  \n  if (request.departure_time) {\n    const departureTime = formatDepartureTime(request.departure_time);\n    if (departureTime) {\n      params.append(\"departure_time\", departureTime);\n    }\n  }\n  \n  if (request.traffic_model) {\n    params.append(\"traffic_model\", request.traffic_model);\n  }\n  \n  if (request.avoid) {\n    params.append(\"avoid\", request.avoid);\n  }\n  \n  if (request.optimize_waypoints) {\n    params.append(\"optimize\", \"true\");\n  }\n  \n  if (request.alternatives) {\n    params.append(\"alternatives\", \"true\");\n  }\n  \n  params.append(\"key\", apiKey);\n  \n  const url = `https://maps.googleapis.com/maps/api/directions/json?${params.toString()}`;\n  \n  try {\n    const response = await fetch(url);\n    \n    if (!response.ok) {\n      // Try to get error details from response\n      let errorMessage = `HTTP error! status: ${response.status}`;\n      try {\n        const errorData = await response.json();\n        if (errorData.error_message) {\n          errorMessage = `Google Maps API error: ${errorData.error_message}`;\n        }\n      } catch {\n        // If we can't parse the error, use the status\n      }\n      throw new Error(errorMessage);\n    }\n    \n    const data: DirectionsResponse | ApiError = await response.json();\n    \n    // Check for API errors\n    if (\"status\" in data && data.status !== \"OK\") {\n      // Handle retryable errors\n      if (isRetryableError(data.status) && retryCount < RETRY_CONFIG.maxRetries) {\n        const delay = RETRY_CONFIG.retryDelay * Math.pow(2, retryCount); // Exponential backoff\n        await sleep(delay);\n        return getDirections(request, retryCount + 1);\n      }\n      \n      const errorMessage = `Directions API error: ${data.status}${\"error_message\" in data ? ` - ${data.error_message}` : \"\"}`;\n      throw new Error(errorMessage);\n    }\n    \n    return data as DirectionsResponse;\n  } catch (error) {\n    // Improve error messages for common issues\n    if (error instanceof TypeError && error.message === \"Failed to fetch\") {\n      // This usually means CORS, network issue, or API key problem\n      const enhancedError = new Error(\n        `Failed to connect to Google Maps API. This could be due to:\n1. Missing or invalid API key (check VITE_GOOGLE_MAPS_API_KEY)\n2. API key restrictions blocking this domain\n3. Network connectivity issues\n4. CORS configuration issues\n\nPlease verify your Google Maps API key is set correctly and has the Directions API enabled.`\n      );\n      enhancedError.name = error.name;\n      error = enhancedError;\n    }\n    \n    // Retry on network errors (but not on API errors)\n    if (retryCount < RETRY_CONFIG.maxRetries && error instanceof Error) {\n      // Only retry if it's a network error, not an API error\n      if (error.message.includes(\"Failed to connect\") || error.message.includes(\"Failed to fetch\")) {\n        const delay = RETRY_CONFIG.retryDelay * Math.pow(2, retryCount);\n        await sleep(delay);\n        return getDirections(request, retryCount + 1);\n      }\n    }\n    \n    throw error;\n  }\n}\n\n/**\n * Rate limiting helper\n * Tracks API calls to prevent exceeding quotas\n */\nclass RateLimiter {\n  private calls: number[] = [];\n  private readonly maxCallsPerSecond: number;\n  private readonly maxCallsPerDay: number;\n  \n  constructor(maxCallsPerSecond = 10, maxCallsPerDay = 25000) {\n    this.maxCallsPerSecond = maxCallsPerSecond;\n    this.maxCallsPerDay = maxCallsPerDay;\n  }\n  \n  /**\n   * Check if we can make an API call\n   */\n  canMakeCall(): boolean {\n    const now = Date.now();\n    const oneSecondAgo = now - 1000;\n    const oneDayAgo = now - 24 * 60 * 60 * 1000;\n    \n    // Remove old calls\n    this.calls = this.calls.filter((timestamp) => timestamp > oneDayAgo);\n    \n    // Check per-second limit\n    const recentCalls = this.calls.filter((timestamp) => timestamp > oneSecondAgo);\n    if (recentCalls.length >= this.maxCallsPerSecond) {\n      return false;\n    }\n    \n    // Check per-day limit\n    if (this.calls.length >= this.maxCallsPerDay) {\n      return false;\n    }\n    \n    return true;\n  }\n  \n  /**\n   * Record an API call\n   */\n  recordCall(): void {\n    this.calls.push(Date.now());\n  }\n  \n  /**\n   * Wait until we can make an API call\n   */\n  async waitIfNeeded(): Promise<void> {\n    while (!this.canMakeCall()) {\n      const now = Date.now();\n      const oneSecondAgo = now - 1000;\n      const recentCalls = this.calls.filter((timestamp) => timestamp > oneSecondAgo);\n      \n      if (recentCalls.length > 0) {\n        const oldestRecentCall = Math.min(...recentCalls);\n        const waitTime = 1000 - (now - oldestRecentCall);\n        if (waitTime > 0) {\n          await sleep(waitTime);\n        }\n      } else {\n        await sleep(100);\n      }\n    }\n  }\n}\n\n// Global rate limiter instance\nconst rateLimiter = new RateLimiter();\n\n/**\n * Get rate limiter instance (for testing or custom configuration)\n */\nexport function getRateLimiter(): RateLimiter {\n  return rateLimiter;\n}\n\n/**\n * Wrapper for getDistanceMatrix with rate limiting\n */\nexport async function getDistanceMatrixWithRateLimit(\n  request: DistanceMatrixRequest\n): Promise<DistanceMatrixResponse> {\n  await rateLimiter.waitIfNeeded();\n  rateLimiter.recordCall();\n  return getDistanceMatrix(request);\n}\n\n/**\n * Wrapper for getDirections with rate limiting\n */\nexport async function getDirectionsWithRateLimit(\n  request: DirectionsRequest\n): Promise<DirectionsResponse> {\n  await rateLimiter.waitIfNeeded();\n  rateLimiter.recordCall();\n  return getDirections(request);\n}\n\n/**\n * Test if the Google Maps API key is valid and has Distance Matrix API enabled\n * This makes a simple test request to verify the API key works\n */\nexport async function testApiKey(): Promise<{ valid: boolean; error?: string }> {\n  try {\n    const apiKey = getApiKey();\n    \n    // Make a simple test request with two nearby locations\n    const testRequest: DistanceMatrixRequest = {\n      origins: [{ lat: 25.2048, lng: 55.2708 }], // Dubai coordinates\n      destinations: [{ lat: 25.2049, lng: 55.2709 }], // Very close location\n      mode: \"driving\",\n    };\n    \n    const result = await getDistanceMatrix(testRequest);\n    \n    if (result.status === \"OK\") {\n      return { valid: true };\n    } else {\n      return { \n        valid: false, \n        error: `API returned status: ${result.status}` \n      };\n    }\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : String(error);\n    return { \n      valid: false, \n      error: errorMessage \n    };\n  }\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/utils/draftRouteGenerator.ts",
      "content": "/**\n * Draft Route Generator\n * \n * Main algorithm to generate draft routes for all unplanned appointments.\n * Analyzes appointments, driver availability, locations, and travel times\n * to suggest optimal assignments. All suggestions require manager approval.\n */\n\nimport { addMinutes, format, startOfDay } from \"date-fns\";\nimport type { Identifier } from \"ra-core\";\nimport type { Appointment, Staff, Contact, DriverTrip, TripLeg } from \"../../types\";\nimport type { DraftRoute, Location, LocationType } from \"../types\";\nimport { suggestDriverAssignment, calculateDriverAvailabilities } from \"./driverAssignmentSuggester\";\nimport { suggestPickupDrop, suggestWaitVsLeave } from \"./pickupDropSuggester\";\nimport { detectSplitDriverNeeded } from \"./splitDriverLogic\";\nimport { detectConflicts, type ConflictDetectionContext } from \"./conflictDetector\";\nimport { optimizeRoute } from \"./routeOptimizer\";\nimport {\n  extractContactCoordinates,\n  getLocationByType,\n  getOfficeLocation,\n} from \"./coordinateExtractor\";\nimport { calculateTravelTime, getEffectiveTravelTime } from \"./travelTimeCalculator\";\nimport type { OfficeLocation } from \"@/hooks/useOfficeLocation\";\n\nexport type DraftRouteGenerationOptions = {\n  selectedDate: string; // YYYY-MM-DD\n  unplannedAppointments: Appointment[];\n  drivers: Staff[];\n  existingTrips: DriverTrip[];\n  existingLegs: TripLeg[];\n  patients: Map<Identifier, Contact>;\n  staff: Map<Identifier, Staff>;\n  officeLocation?: OfficeLocation | null; // Optional office location from settings for accurate distance calculations\n};\n\nexport type DraftRouteGenerationResult = {\n  draftRoutes: DraftRoute[];\n  unassignedAppointments: Appointment[];\n  suggestions: {\n    total_appointments: number;\n    assigned_appointments: number;\n    unassigned_appointments: number;\n    split_driver_suggestions: number;\n  };\n};\n\n/**\n * Generate draft routes for all unplanned appointments\n * \n * @param options - Generation options including appointments, drivers, and existing routes\n * @returns Draft routes with suggestions and unassigned appointments\n */\nexport async function generateDraftRoutes(\n  options: DraftRouteGenerationOptions\n): Promise<DraftRouteGenerationResult> {\n  const {\n    selectedDate,\n    unplannedAppointments,\n    drivers,\n    existingTrips,\n    existingLegs,\n    patients,\n    staff,\n    officeLocation,\n  } = options;\n\n  const draftRoutes: DraftRoute[] = [];\n  const unassignedAppointments: Appointment[] = [];\n\n  // Calculate driver availabilities\n  const driverAvailabilities = calculateDriverAvailabilities(\n    drivers,\n    existingTrips,\n    existingLegs,\n    selectedDate\n  );\n\n  // Sort appointments by start time\n  const sortedAppointments = [...unplannedAppointments].sort((a, b) => {\n    const timeA = a.start_time ? new Date(a.start_time).getTime() : 0;\n    const timeB = b.start_time ? new Date(b.start_time).getTime() : 0;\n    return timeA - timeB;\n  });\n\n  // Track assigned appointments to avoid double assignment\n  const assignedAppointmentIds = new Set<Identifier>();\n\n  // Group appointments by suggested driver\n  const appointmentsByDriver = new Map<Identifier, Appointment[]>();\n\n  // Step 1: Suggest driver assignments for each appointment\n  for (const appointment of sortedAppointments) {\n    if (assignedAppointmentIds.has(appointment.id)) continue;\n\n    const patient = patients.get(appointment.patient_id);\n    const primaryStaff = appointment.primary_staff_id\n      ? staff.get(appointment.primary_staff_id)\n      : null;\n\n    // Get driver suggestions\n    const driverSuggestions = await suggestDriverAssignment(\n      appointment,\n      drivers,\n      driverAvailabilities,\n      patient || null,\n      existingTrips,\n      existingLegs\n    );\n\n    if (driverSuggestions.length === 0) {\n      // No suitable driver found\n      unassignedAppointments.push(appointment);\n      continue;\n    }\n\n    // Use top suggestion\n    const topSuggestion = driverSuggestions[0];\n    const driverId = topSuggestion.driver_id;\n\n    // Add to driver's appointment list\n    if (!appointmentsByDriver.has(driverId)) {\n      appointmentsByDriver.set(driverId, []);\n    }\n    appointmentsByDriver.get(driverId)!.push(appointment);\n    assignedAppointmentIds.add(appointment.id);\n  }\n\n  // Step 2: Generate draft routes for each driver\n  for (const [driverId, driverAppointments] of appointmentsByDriver) {\n    const driver = drivers.find((d) => d.id === driverId);\n    if (!driver) continue;\n\n    // Sort appointments by time\n    const sortedDriverAppointments = [...driverAppointments].sort((a, b) => {\n      const timeA = a.start_time ? new Date(a.start_time).getTime() : 0;\n      const timeB = b.start_time ? new Date(b.start_time).getTime() : 0;\n      return timeA - timeB;\n    });\n\n    // Generate trip legs for this driver\n    const legs: TripLeg[] = [];\n    let tripStartTime: Date | null = null;\n    let tripEndTime: Date | null = null;\n\n    for (let i = 0; i < sortedDriverAppointments.length; i++) {\n      const appointment = sortedDriverAppointments[i];\n      const patient = patients.get(appointment.patient_id);\n      const primaryStaff = appointment.primary_staff_id\n        ? staff.get(appointment.primary_staff_id)\n        : null;\n\n      const appointmentStart = new Date(appointment.start_time);\n      const appointmentEnd = new Date(appointment.end_time);\n\n      // Update trip time range\n      if (!tripStartTime || appointmentStart < tripStartTime) {\n        tripStartTime = appointmentStart;\n      }\n      if (!tripEndTime || appointmentEnd > tripEndTime) {\n        tripEndTime = appointmentEnd;\n      }\n\n      // Get previous and next appointments for wait/leave logic\n      const previousAppointment =\n        i > 0 ? sortedDriverAppointments[i - 1] : null;\n      const nextAppointment =\n        i < sortedDriverAppointments.length - 1\n          ? sortedDriverAppointments[i + 1]\n          : null;\n\n      const previousEndTime = previousAppointment\n        ? new Date(previousAppointment.end_time)\n        : null;\n      const nextStartTime = nextAppointment\n        ? new Date(nextAppointment.start_time)\n        : null;\n\n      // Suggest pickup/drop locations - pass office location from settings for accurate distance calculations\n      const pickupDropSuggestion = await suggestPickupDrop(\n        appointment,\n        primaryStaff || null,\n        patient || null,\n        previousEndTime || undefined,\n        nextStartTime || undefined,\n        officeLocation || undefined\n      );\n\n      const pickupLocation: LocationType =\n        pickupDropSuggestion?.pickup_location || \"office\";\n      const dropLocation: LocationType =\n        pickupDropSuggestion?.drop_location || \"office\";\n\n      // Determine wait vs leave\n      const waitVsLeave = suggestWaitVsLeave(\n        appointmentEnd,\n        nextStartTime,\n        nextAppointment !== null\n      );\n\n      // Create legs for this appointment\n      // 1. Pickup staff\n      const pickupArrivalTime = calculatePickupArrivalTime(\n        appointmentStart,\n        pickupLocation,\n        patient || null\n      );\n\n      legs.push({\n        id: `draft-pickup-${appointment.id}` as Identifier,\n        trip_id: `draft-trip-${driverId}` as Identifier,\n        leg_type: \"pickup_staff\",\n        leg_order: legs.length + 1,\n        staff_id: primaryStaff?.id,\n        location_type: pickupLocation,\n        location_id: getLocationIdForType(pickupLocation, primaryStaff?.id),\n        planned_arrival_time: pickupArrivalTime.toISOString(),\n        planned_departure_time: appointmentStart.toISOString(),\n        is_locked: false,\n        created_at: new Date().toISOString(),\n        updated_at: new Date().toISOString(),\n      });\n\n      // 2. Drop staff at patient\n      legs.push({\n        id: `draft-drop-${appointment.id}` as Identifier,\n        trip_id: `draft-trip-${driverId}` as Identifier,\n        leg_type: \"drop_staff\",\n        leg_order: legs.length + 1,\n        staff_id: primaryStaff?.id,\n        appointment_id: appointment.id,\n        location_type: \"patient\",\n        location_id: appointment.patient_id,\n        planned_arrival_time: appointmentStart.toISOString(),\n        planned_departure_time: null, // Will be set after appointment\n        is_locked: false,\n        created_at: new Date().toISOString(),\n        updated_at: new Date().toISOString(),\n      });\n\n      // 3. Appointment (wait)\n      if (waitVsLeave === \"wait\") {\n        const waitDuration = nextStartTime\n          ? (nextStartTime.getTime() - appointmentEnd.getTime()) / (60 * 1000)\n          : 0;\n\n        legs.push({\n          id: `draft-wait-${appointment.id}` as Identifier,\n          trip_id: `draft-trip-${driverId}` as Identifier,\n          leg_type: \"wait\",\n          leg_order: legs.length + 1,\n          appointment_id: appointment.id,\n          location_type: \"patient\",\n          location_id: appointment.patient_id,\n          planned_arrival_time: appointmentEnd.toISOString(),\n          planned_departure_time: nextStartTime?.toISOString() || null,\n          wait_duration_minutes: waitDuration,\n          is_locked: false,\n          created_at: new Date().toISOString(),\n          updated_at: new Date().toISOString(),\n        });\n      }\n\n      // 4. Pickup staff from patient (if wait) or return (if leave)\n      if (waitVsLeave === \"wait\" && nextStartTime) {\n        // Pickup for next appointment\n        // (Will be handled in next iteration)\n      } else {\n        // Return to drop location\n        const returnArrivalTime = calculateReturnArrivalTime(\n          appointmentEnd,\n          dropLocation,\n          patient || null\n        );\n\n        legs.push({\n          id: `draft-return-${appointment.id}` as Identifier,\n          trip_id: `draft-trip-${driverId}` as Identifier,\n          leg_type: \"return\",\n          leg_order: legs.length + 1,\n          location_type: dropLocation,\n          location_id: getLocationIdForType(dropLocation, primaryStaff?.id),\n          planned_arrival_time: returnArrivalTime.toISOString(),\n          return_location_type: dropLocation,\n          is_locked: false,\n          created_at: new Date().toISOString(),\n          updated_at: new Date().toISOString(),\n        });\n      }\n    }\n\n    // Create draft trip\n    if (tripStartTime && tripEndTime) {\n      const draftTrip: DriverTrip = {\n        id: `draft-trip-${driverId}` as Identifier,\n        driver_id: driverId,\n        trip_date: selectedDate,\n        start_time: format(tripStartTime, \"HH:mm:ss\"),\n        end_time: format(tripEndTime, \"HH:mm:ss\"),\n        status: \"draft\",\n        created_at: new Date().toISOString(),\n        updated_at: new Date().toISOString(),\n      };\n\n      // Detect conflicts\n      const conflictContext: ConflictDetectionContext = {\n        trip: draftTrip,\n        legs,\n        appointments: new Map(\n          sortedDriverAppointments.map((a) => [a.id, a])\n        ),\n        contacts: patients,\n        staff,\n      };\n\n      const conflicts = await detectConflicts(conflictContext);\n\n      // Build locations map for optimization\n      const locationsMap = new Map<Identifier, Location>();\n      for (const leg of legs) {\n        const location = await getLocationForLeg(leg, patients, staff);\n        if (location) {\n          locationsMap.set(leg.id, location);\n        }\n      }\n\n      // Optimize route order\n      const optimized = await optimizeRoute(legs, locationsMap, {\n        appointment_times_must_not_change: true,\n      });\n\n      draftRoutes.push({\n        trip: draftTrip,\n        legs: optimized.legs,\n        conflicts,\n        suggested_driver_name: `${driver.first_name} ${driver.last_name}`.trim(),\n        confidence_score: 0.8, // Would be calculated based on suggestions\n      });\n    }\n  }\n\n  // Count split driver suggestions\n  let splitDriverCount = 0;\n  for (const appointment of sortedAppointments) {\n    const splitSuggestion = detectSplitDriverNeeded(\n      appointment,\n      appointment.primary_staff_id ? staff.get(appointment.primary_staff_id) || null : null,\n      sortedAppointments,\n      drivers\n    );\n    if (splitSuggestion) {\n      splitDriverCount++;\n    }\n  }\n\n  return {\n    draftRoutes,\n    unassignedAppointments,\n    suggestions: {\n      total_appointments: unplannedAppointments.length,\n      assigned_appointments: assignedAppointmentIds.size,\n      unassigned_appointments: unassignedAppointments.length,\n      split_driver_suggestions: splitDriverCount,\n    },\n  };\n}\n\n/**\n * Calculate pickup arrival time\n */\nfunction calculatePickupArrivalTime(\n  appointmentStart: Date,\n  pickupLocation: LocationType,\n  patient: Contact | null\n): Date {\n  // Estimate travel time from pickup location to patient\n  // Simplified: assume 15 minutes travel time\n  const travelTimeMinutes = 15;\n  return addMinutes(appointmentStart, -travelTimeMinutes);\n}\n\n/**\n * Calculate return arrival time\n */\nfunction calculateReturnArrivalTime(\n  appointmentEnd: Date,\n  returnLocation: LocationType,\n  patient: Contact | null\n): Date {\n  // Estimate travel time from patient to return location\n  // Simplified: assume 15 minutes travel time\n  const travelTimeMinutes = 15;\n  return addMinutes(appointmentEnd, travelTimeMinutes);\n}\n\n/**\n * Get location ID for location type\n */\nfunction getLocationIdForType(\n  locationType: LocationType,\n  staffId?: Identifier\n): Identifier {\n  if (locationType === \"patient\") {\n    return \"\" as Identifier; // Will be set from appointment\n  }\n  // For office/metro/home, use a constant ID or staff ID\n  return (staffId || \"default\") as Identifier;\n}\n\n/**\n * Get location for a leg\n */\nasync function getLocationForLeg(\n  leg: TripLeg,\n  patients: Map<Identifier, Contact>,\n  staff: Map<Identifier, Staff>\n): Promise<Location | null> {\n  return getLocationByType(\n    leg.location_type,\n    leg.location_type === \"patient\" && leg.location_id\n      ? patients.get(leg.location_id) || undefined\n      : undefined,\n    leg.staff_id ? staff.get(leg.staff_id) || undefined : undefined\n  );\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/transport/hooks/useDraftRouteGeneration.ts",
      "content": "/**\n * useDraftRouteGeneration Hook\n * \n * Handles draft route generation workflow:\n * - Generate draft routes for unplanned appointments\n * - Preview draft routes before applying\n * - Apply draft routes (create driver_trips and trip_legs)\n */\n\nimport { useState, useCallback } from \"react\";\nimport { useCreate, useNotify, useDataProvider } from \"ra-core\";\nimport { format } from \"date-fns\";\nimport type { Identifier } from \"ra-core\";\nimport type { Appointment, Staff, Contact, DriverTrip, TripLeg } from \"../../types\";\nimport type { DraftRoute, DraftRouteGenerationResult } from \"../types\";\nimport { generateDraftRoutes, type DraftRouteGenerationOptions } from \"../utils/draftRouteGenerator\";\nimport { useOfficeLocation } from \"@/hooks/useOfficeLocation\";\n\ntype UseDraftRouteGenerationOptions = {\n  selectedDate: Date;\n  onRoutesGenerated?: (result: DraftRouteGenerationResult) => void;\n  onError?: (error: Error) => void;\n};\n\nexport function useDraftRouteGeneration({\n  selectedDate,\n  onRoutesGenerated,\n  onError,\n}: UseDraftRouteGenerationOptions) {\n  const [create] = useCreate();\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const { officeLocation } = useOfficeLocation(); // Get office location from settings\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [draftRoutes, setDraftRoutes] = useState<DraftRoute[]>([]);\n  const [isPreviewMode, setIsPreviewMode] = useState(false);\n\n  /**\n   * Generate draft routes for unplanned appointments\n   */\n  const generateDrafts = useCallback(\n    async (\n      unplannedAppointments: Appointment[],\n      drivers: Staff[],\n      existingTrips: DriverTrip[],\n      existingLegs: TripLeg[],\n      patients: Map<Identifier, Contact>,\n      staff: Map<Identifier, Staff>\n    ) => {\n      setIsGenerating(true);\n      try {\n        const selectedDateStr = format(selectedDate, \"yyyy-MM-dd\");\n\n        const options: DraftRouteGenerationOptions = {\n          selectedDate: selectedDateStr,\n          unplannedAppointments,\n          drivers,\n          existingTrips,\n          existingLegs,\n          patients,\n          staff,\n          officeLocation, // Pass office location from settings for accurate distance calculations\n        };\n\n        const result = await generateDraftRoutes(options);\n\n        setDraftRoutes(result.draftRoutes);\n        setIsPreviewMode(true);\n\n        notify(\n          `Generated ${result.draftRoutes.length} draft route(s) for ${result.suggestions.assigned_appointments} appointment(s)`,\n          { type: \"success\" }\n        );\n\n        onRoutesGenerated?.(result);\n        return result;\n      } catch (error) {\n        const err = error instanceof Error ? error : new Error(\"Failed to generate draft routes\");\n        console.error(\"Error generating draft routes:\", err);\n        \n        // Provide more specific error messages\n        let errorMessage = \"Failed to generate draft routes\";\n        if (err.message.includes(\"API key\")) {\n          errorMessage = \"Google Maps API key is missing or invalid. Please check your environment configuration.\";\n        } else if (err.message.includes(\"Failed to connect\") || err.message.includes(\"Unable to connect\")) {\n          errorMessage = \"Unable to connect to Google Maps API. Please check your internet connection and API key configuration.\";\n        } else if (err.message.includes(\"Distance Matrix API\")) {\n          errorMessage = \"Google Maps Distance Matrix API error. Please verify your API key has the Distance Matrix API enabled.\";\n        } else {\n          errorMessage = err.message || errorMessage;\n        }\n        \n        notify(errorMessage, { type: \"error\" });\n        onError?.(err);\n        throw err;\n      } finally {\n        setIsGenerating(false);\n      }\n    },\n    [selectedDate, notify, onRoutesGenerated, onError]\n  );\n\n  /**\n   * Apply draft routes (create driver_trips and trip_legs in database)\n   */\n  const applyDraftRoutes = useCallback(\n    async (routesToApply: DraftRoute[] = draftRoutes) => {\n      if (routesToApply.length === 0) {\n        notify(\"No draft routes to apply\", { type: \"warning\" });\n        return;\n      }\n\n      setIsGenerating(true);\n      try {\n        // Create driver trips\n        const trips: DriverTrip[] = [];\n        for (const draftRoute of routesToApply) {\n          const trip = await create(\n            \"driver_trips\",\n            {\n              data: {\n                driver_id: draftRoute.trip.driver_id,\n                trip_date: draftRoute.trip.trip_date,\n                start_time: draftRoute.trip.start_time,\n                end_time: draftRoute.trip.end_time,\n                status: \"draft\",\n              },\n            }\n          );\n          trips.push(trip);\n        }\n\n        // Create trip legs for all trips\n        const allLegs: TripLeg[] = [];\n        for (let i = 0; i < routesToApply.length; i++) {\n          const draftRoute = routesToApply[i];\n          const trip = trips[i];\n\n          for (const leg of draftRoute.legs) {\n            allLegs.push({\n              ...leg,\n              trip_id: trip.id,\n            });\n          }\n        }\n\n        // Batch create legs\n        if (allLegs.length > 0) {\n          await Promise.all(\n            allLegs.map((leg) =>\n              dataProvider.create(\"trip_legs\", {\n                data: {\n                  trip_id: leg.trip_id,\n                  leg_type: leg.leg_type,\n                  leg_order: leg.leg_order,\n                  staff_id: leg.staff_id,\n                  appointment_id: leg.appointment_id,\n                  location_type: leg.location_type,\n                  location_id: leg.location_id,\n                  planned_arrival_time: leg.planned_arrival_time,\n                  planned_departure_time: leg.planned_departure_time,\n                  is_locked: leg.is_locked,\n                  wait_duration_minutes: leg.wait_duration_minutes,\n                  return_location_type: leg.return_location_type,\n                },\n              })\n            )\n          );\n        }\n\n        notify(`Applied ${routesToApply.length} draft route(s)`, { type: \"success\" });\n        setDraftRoutes([]);\n        setIsPreviewMode(false);\n      } catch (error) {\n        const err = error instanceof Error ? error : new Error(\"Failed to apply draft routes\");\n        console.error(\"Error applying draft routes:\", err);\n        notify(\"Failed to apply draft routes\", { type: \"error\" });\n        onError?.(err);\n        throw err;\n      } finally {\n        setIsGenerating(false);\n      }\n    },\n    [draftRoutes, create, dataProvider, notify, onError]\n  );\n\n  /**\n   * Discard draft routes\n   */\n  const discardDraftRoutes = useCallback(() => {\n    setDraftRoutes([]);\n    setIsPreviewMode(false);\n    notify(\"Draft routes discarded\", { type: \"info\" });\n  }, [notify]);\n\n  return {\n    generateDrafts,\n    applyDraftRoutes,\n    discardDraftRoutes,\n    draftRoutes,\n    isGenerating,\n    isPreviewMode,\n  };\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TasksPage.tsx",
      "content": "import { CheckSquare, CheckCircle2, Search } from \"lucide-react\";\nimport {\n  ListContextProvider,\n  ResourceContextProvider,\n  useGetIdentity,\n  useGetList,\n  useList,\n} from \"ra-core\";\nimport { useState, useMemo, useEffect } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\nimport { AddTask } from \"./AddTask\";\nimport { TasksIterator } from \"./TasksIterator\";\nimport {\n  crmAddDays,\n  crmEndOfDay,\n  crmEndOfWeek,\n  crmStartOfDay,\n} from \"../misc/timezone\";\nimport type { Task } from \"../types\";\n\nconst startOfTodayDate = crmStartOfDay();\nconst endOfTodayDate = crmEndOfDay();\nconst endOfTomorrowDate = crmEndOfDay(crmAddDays(new Date(), 1));\nconst endOfWeekDate = crmEndOfWeek();\n\nconst startOfTodayDateISO = (startOfTodayDate ?? new Date()).toISOString();\nconst endOfTodayDateISO = (endOfTodayDate ?? new Date()).toISOString();\nconst endOfTomorrowDateISO = (endOfTomorrowDate ?? new Date()).toISOString();\nconst endOfWeekDateISO = (endOfWeekDate ?? new Date()).toISOString();\n\nconst taskFilters = {\n  overdue: {\n    \"due_date@lt\": startOfTodayDateISO,\n    \"done_date@is\": null,\n  },\n  today: {\n    \"due_date@gte\": startOfTodayDateISO,\n    \"due_date@lte\": endOfTodayDateISO,\n    \"done_date@is\": null,\n  },\n  tomorrow: {\n    \"due_date@gt\": endOfTodayDateISO,\n    \"due_date@lte\": endOfTomorrowDateISO,\n    \"done_date@is\": null,\n  },\n  thisWeek: {\n    \"due_date@gt\": endOfTomorrowDateISO,\n    \"due_date@lte\": endOfWeekDateISO,\n    \"done_date@is\": null,\n  },\n  later: {\n    \"due_date@gt\": endOfWeekDateISO,\n    \"done_date@is\": null,\n  },\n  completed: {\n    \"done_date@not.is\": null,\n  },\n};\n\ntype TaskColumnProps = {\n  title: string;\n  filter: any;\n  showMyTasksOnly: boolean;\n  currentUserId?: number;\n  sortBy?: \"due_date\" | \"done_date\";\n  sortOrder?: \"ASC\" | \"DESC\";\n  searchQuery?: string;\n};\n\nconst TaskColumn = ({\n  title,\n  filter,\n  showMyTasksOnly,\n  currentUserId,\n  sortBy = \"due_date\",\n  sortOrder = \"ASC\",\n  searchQuery,\n}: TaskColumnProps) => {\n  const baseFilter = useMemo(() => {\n    let finalFilter = { ...filter };\n    \n    if (showMyTasksOnly && currentUserId) {\n      // Filter by tagged_user_ids using @cs (contains) operator\n      finalFilter[\"tagged_user_ids@cs\"] = `{${currentUserId}}`;\n    }\n    \n    // Add search filter if provided\n    if (searchQuery && searchQuery.trim()) {\n      finalFilter[\"text@ilike\"] = `%${searchQuery.trim()}%`;\n    }\n    \n    return finalFilter;\n  }, [filter, showMyTasksOnly, currentUserId, searchQuery]);\n\n  const {\n    data: tasks,\n    total,\n    isPending,\n  } = useGetList<Task>(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: sortBy, order: sortOrder },\n      filter: baseFilter,\n    },\n    { enabled: !showMyTasksOnly || !!currentUserId },\n  );\n\n  // Sort tasks based on column type\n  const sortedTasks = useMemo(() => {\n    if (!tasks) return [];\n    \n    // For completed column, sort by done_date descending (most recent first)\n    if (sortBy === \"done_date\") {\n      return tasks.sort((a, b) => {\n        const dateA = new Date(a.done_date || 0).getTime();\n        const dateB = new Date(b.done_date || 0).getTime();\n        return dateB - dateA; // Descending order\n      });\n    }\n    \n    // For other columns: only show incomplete tasks, sorted by due_date\n    return tasks\n      .filter(task => !task.done_date)\n      .sort((a, b) => {\n        const dateA = new Date(a.due_date || 0).getTime();\n        const dateB = new Date(b.due_date || 0).getTime();\n        return dateA - dateB;\n      });\n  }, [tasks, sortBy]);\n\n  const listContext = useList({\n    data: sortedTasks,\n    isPending,\n    resource: \"tasks\",\n    perPage: 1000,\n  });\n\n  return (\n    <div className=\"flex flex-col h-full\">\n      <Card className=\"flex flex-col h-full border-border/50 shadow-sm\">\n        <CardHeader className=\"pb-2.5 px-4 pt-3 border-b border-border/50\">\n          <CardTitle className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n            <span>{title}</span>\n            {total !== undefined && total > 0 && (\n              <span className=\"text-xs font-medium text-foreground bg-muted px-1.5 py-0.5 rounded\">\n                {total}\n              </span>\n            )}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex-1 overflow-y-auto min-h-0 p-2 space-y-2\">\n          <ResourceContextProvider value=\"tasks\">\n            <ListContextProvider value={listContext}>\n              {isPending ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <p className=\"text-sm text-muted-foreground\">Loading...</p>\n                </div>\n              ) : (\n                <TasksIterator showContact showAll showTimestamp={false} />\n              )}\n            </ListContextProvider>\n          </ResourceContextProvider>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nconst CompletedTasksDialog = ({\n  open,\n  onClose,\n  showMyTasksOnly,\n  currentUserId,\n  searchQuery: initialSearchQuery,\n}: {\n  open: boolean;\n  onClose: () => void;\n  showMyTasksOnly: boolean;\n  currentUserId?: number;\n  searchQuery?: string;\n}) => {\n  const [searchQuery, setSearchQuery] = useState(initialSearchQuery || \"\");\n\n  // Sync search query when dialog opens or parent search changes\n  useEffect(() => {\n    if (open && initialSearchQuery !== undefined) {\n      setSearchQuery(initialSearchQuery);\n    }\n  }, [open, initialSearchQuery]);\n\n  const baseFilter = useMemo(() => {\n    let finalFilter = { ...taskFilters.completed };\n    \n    if (showMyTasksOnly && currentUserId) {\n      finalFilter[\"tagged_user_ids@cs\"] = `{${currentUserId}}`;\n    }\n    \n    if (searchQuery && searchQuery.trim()) {\n      finalFilter[\"text@ilike\"] = `%${searchQuery.trim()}%`;\n    }\n    \n    return finalFilter;\n  }, [showMyTasksOnly, currentUserId, searchQuery]);\n\n  const {\n    data: tasks,\n    total,\n    isPending,\n  } = useGetList<Task>(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"done_date\", order: \"DESC\" },\n      filter: baseFilter,\n    },\n    { enabled: open },\n  );\n\n  const sortedTasks = useMemo(() => {\n    if (!tasks) return [];\n    return tasks.sort((a, b) => {\n      const dateA = new Date(a.done_date || 0).getTime();\n      const dateB = new Date(b.done_date || 0).getTime();\n      return dateB - dateA;\n    });\n  }, [tasks]);\n\n  const listContext = useList({\n    data: sortedTasks,\n    isPending,\n    resource: \"tasks\",\n    perPage: 1000,\n  });\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"lg:max-w-4xl max-h-[90vh] overflow-hidden flex flex-col\">\n        <DialogHeader>\n          <DialogTitle>Completed Tasks</DialogTitle>\n          <DialogDescription className=\"sr-only\">\n            View all completed tasks\n          </DialogDescription>\n        </DialogHeader>\n        {/* Search Bar */}\n        <div className=\"flex-shrink-0 pb-4\">\n          <div className=\"flex flex-grow relative\">\n            <input\n              type=\"text\"\n              placeholder=\"Search completed tasks...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8\"\n            />\n            <Search className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none\" />\n          </div>\n        </div>\n        <div className=\"flex-1 overflow-y-auto min-h-0\">\n          <ResourceContextProvider value=\"tasks\">\n            <ListContextProvider value={listContext}>\n              {isPending ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <p className=\"text-sm text-muted-foreground\">Loading...</p>\n                </div>\n              ) : sortedTasks && sortedTasks.length > 0 ? (\n                <TasksIterator showContact showAll showTimestamp={true} />\n              ) : (\n                <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n                  <CheckCircle2 className=\"w-12 h-12 text-muted-foreground mb-4 opacity-50\" />\n                  <p className=\"text-sm text-muted-foreground\">No completed tasks</p>\n                </div>\n              )}\n            </ListContextProvider>\n          </ResourceContextProvider>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport const TasksPage = () => {\n  const { identity } = useGetIdentity();\n  const [showMyTasksOnly, setShowMyTasksOnly] = useState(false);\n  const [completedDialogOpen, setCompletedDialogOpen] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  return (\n    <div className=\"flex flex-col w-full lg:h-[calc(100vh-8rem)] h-auto -mx-4 -mt-4 p-6 gap-4 bg-background\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-shrink-0 pb-2\">\n        {/* Search Bar (moved into header) */}\n        <div className=\"flex-shrink-0 w-full max-w-md\">\n          <div className=\"flex flex-grow relative\">\n            <input\n              type=\"text\"\n              placeholder=\"Search tasks...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8\"\n            />\n            <Search className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none\" />\n          </div>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <div className=\"flex items-center gap-2\">\n            <Switch\n              id=\"my-tasks-only\"\n              checked={showMyTasksOnly}\n              onCheckedChange={setShowMyTasksOnly}\n            />\n            <Label\n              htmlFor=\"my-tasks-only\"\n              className=\"text-sm font-medium cursor-pointer text-muted-foreground\"\n            >\n              My Tasks Only\n            </Label>\n          </div>\n          <Button\n            variant=\"outline\"\n            onClick={() => setCompletedDialogOpen(true)}\n            className=\"flex items-center gap-2\"\n            size=\"sm\"\n          >\n            <CheckCircle2 className=\"h-4 w-4\" />\n            Completed Tasks\n          </Button>\n          <AddTask display=\"icon\" selectContact />\n        </div>\n      </div>\n\n      {/* Task Columns */}\n      <div className=\"flex-1 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 min-h-0 overflow-hidden max-md:overflow-y-auto max-md:h-auto\">\n        <TaskColumn\n          title=\"Overdue\"\n          filter={taskFilters.overdue}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n        <TaskColumn\n          title=\"Today\"\n          filter={taskFilters.today}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n        <TaskColumn\n          title=\"Tomorrow\"\n          filter={taskFilters.tomorrow}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n        <TaskColumn\n          title=\"This Week\"\n          filter={taskFilters.thisWeek}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n        <TaskColumn\n          title=\"Later\"\n          filter={taskFilters.later}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n      </div>\n\n      <CompletedTasksDialog\n        open={completedDialogOpen}\n        onClose={() => setCompletedDialogOpen(false)}\n        showMyTasksOnly={showMyTasksOnly}\n        currentUserId={identity?.id}\n        searchQuery={searchQuery}\n      />\n    </div>\n  );\n};\n\nTasksPage.path = \"/tasks\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TasksIterator.tsx",
      "content": "import { useListContext } from \"ra-core\";\nimport { CheckSquare } from \"lucide-react\";\n\nimport { Task } from \"./Task\";\n\nexport const TasksIterator = ({\n  showContact,\n  className,\n  showAll,\n  showTimestamp = true,\n}: {\n  showContact?: boolean;\n  className?: string;\n  showAll?: boolean;\n  showTimestamp?: boolean;\n}) => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error) return null;\n\n  // If showAll is true, show all tasks (including completed ones)\n  // Otherwise, filter out completed tasks completely\n  const tasks = showAll \n    ? data\n    : data.filter((task) => !task.done_date);\n\n  if (!tasks || tasks.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n        <CheckSquare className=\"w-12 h-12 text-muted-foreground mb-4 opacity-50\" />\n        <p className=\"text-sm text-muted-foreground\">No tasks yet</p>\n        <p className=\"text-xs text-muted-foreground mt-1\">Create your first task to get started</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className={`space-y-2 ${className || \"\"}`}>\n      {tasks.map((task) => (\n        <Task task={task} showContact={showContact} showTimestamp={showTimestamp} key={task.id} />\n      ))}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskEdit.tsx",
      "content": "import { EditBase, Form, required, useNotify, type Identifier } from \"ra-core\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { ReferenceArrayInput } from \"@/components/admin/reference-array-input\";\nimport { AutocompleteArrayInput } from \"@/components/admin/autocomplete-array-input\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Sale } from \"../types\";\n\nexport const TaskEdit = ({\n  open,\n  close,\n  taskId,\n}: {\n  taskId: Identifier;\n  open: boolean;\n  close: () => void;\n}) => {\n  const { taskTypes } = useConfigurationContext();\n  const notify = useNotify();\n  return (\n    <Dialog open={open} onOpenChange={close}>\n      {taskId && (\n        <EditBase\n          id={taskId}\n          resource=\"tasks\"\n          className=\"mt-0\"\n          mutationOptions={{\n            onSuccess: () => {\n              close();\n              notify(\"Task updated\", {\n                type: \"info\",\n                undoable: true,\n              });\n            },\n          }}\n          redirect={false}\n        >\n          <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n            <Form className=\"flex flex-col gap-4\">\n              <DialogHeader>\n                <DialogTitle>Edit task</DialogTitle>\n                <DialogDescription className=\"sr-only\">\n                  Edit task details including description, due date, type, and tagged users.\n                </DialogDescription>\n              </DialogHeader>\n              <TextInput\n                autoFocus\n                source=\"text\"\n                label=\"Description\"\n                validate={required()}\n                multiline\n                helperText={false}\n              />\n              <div className=\"grid grid-cols-2 gap-4\">\n                <DateInput\n                  source=\"due_date\"\n                  helperText={false}\n                  validate={required()}\n                />\n                <SelectInput\n                  source=\"type\"\n                  choices={taskTypes.map((type) => ({\n                    id: type,\n                    name: type,\n                  }))}\n                  helperText={false}\n                  validate={required()}\n                />\n              </div>\n              <ReferenceArrayInput\n                source=\"tagged_user_ids\"\n                reference=\"sales\"\n                filter={{ \"disabled@neq\": true }}\n                sort={{ field: \"last_name\", order: \"ASC\" }}\n              >\n                <AutocompleteArrayInput\n                  label=\"Tag users\"\n                  helperText={false}\n                  optionText={(choice: Sale) => `${choice.first_name} ${choice.last_name}`}\n                  placeholder=\"Search users to tag...\"\n                />\n              </ReferenceArrayInput>\n              <DialogFooter className=\"w-full sm:justify-between gap-4\">\n                <DeleteButton\n                  mutationOptions={{\n                    onSuccess: () => {\n                      close();\n                      notify(\"Task deleted\", {\n                        type: \"info\",\n                        undoable: true,\n                      });\n                    },\n                  }}\n                  redirect={false}\n                />\n                <SaveButton label=\"Save\" />\n              </DialogFooter>\n            </Form>\n          </DialogContent>\n        </EditBase>\n      )}\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/Task.tsx",
      "content": "import { useQueryClient } from \"@tanstack/react-query\";\nimport { MoreVertical } from \"lucide-react\";\nimport {\n  RecordContextProvider,\n  useDeleteWithUndoController,\n  useNotify,\n  useRecordContext,\n  useUpdate,\n} from \"ra-core\";\nimport { useEffect, useState } from \"react\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ReferenceArrayField } from \"@/components/admin/reference-array-field\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { cn } from \"@/lib/utils\";\n\nimport type { Contact, Sale, Task as TData } from \"../types\";\nimport { crmAddDays } from \"../misc/timezone\";\nimport { TaskEdit } from \"./TaskEdit\";\n\n// Component to display user initials\nconst UserInitials = () => {\n  const record = useRecordContext<Sale>();\n  if (!record) return null;\n  const initials = `${record.first_name?.charAt(0) || \"\"}${record.last_name?.charAt(0) || \"\"}`.toUpperCase();\n  return (\n    <div\n      className=\"w-6 h-6 rounded-full bg-muted flex items-center justify-center text-[10px] font-medium text-muted-foreground border border-border\"\n      title={`${record.first_name} ${record.last_name}`}\n    >\n      {initials}\n    </div>\n  );\n};\n\nexport const Task = ({\n  task,\n  showContact,\n  showTimestamp = true,\n}: {\n  task: TData;\n  showContact?: boolean;\n  showTimestamp?: boolean;\n}) => {\n  // showTimestamp is kept for compatibility with callers; timestamp is currently not displayed.\n  void showTimestamp;\n\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n\n  const [openEdit, setOpenEdit] = useState(false);\n\n  const handleCloseEdit = () => {\n    setOpenEdit(false);\n  };\n\n  const [update, { isPending: isUpdatePending, isSuccess, variables }] = useUpdate();\n\n  const { handleDelete } = useDeleteWithUndoController({\n    resource: \"tasks\",\n    record: task,\n    redirect: false,\n    mutationOptions: {\n      onSuccess() {\n        notify(\"Task deleted successfully\", { undoable: true });\n      },\n    },\n  });\n\n  const handleEdit = () => {\n    setOpenEdit(true);\n  };\n\n  const handleCheck = () => () => {\n    update(\"tasks\", {\n      id: task.id,\n      data: {\n        done_date: task.done_date ? null : new Date().toISOString(),\n      },\n      previousData: task,\n    });\n  };\n\n  useEffect(() => {\n    // Invalidate queries when task completion status changes\n    if (isSuccess && variables?.data?.done_date !== undefined) {\n      queryClient.invalidateQueries({ queryKey: [\"tasks\", \"getList\"] });\n    }\n  }, [queryClient, isSuccess, variables]);\n\n  const labelId = `checkbox-list-label-${task.id}`;\n  const isCompleted = !!task.done_date;\n  const dueDate = task.due_date ? new Date(task.due_date) : null;\n  const isOverdue = dueDate && !isCompleted && dueDate < new Date();\n\n  return (\n    <>\n      <Card\n        id={`task-${task.id}`}\n        className={cn(\n          \"group border border-border/50 bg-card hover:border-border hover:shadow-sm transition-all duration-200\",\n          isCompleted && \"opacity-60\",\n        )}\n      >\n        <CardContent className=\"p-2 flex items-start gap-2\">\n          <Checkbox\n            id={labelId}\n            checked={isCompleted}\n            onCheckedChange={handleCheck()}\n            disabled={isUpdatePending}\n            className=\"mt-1 h-4 w-4 border-2 flex-shrink-0\"\n          />\n\n          <div className=\"flex flex-col flex-1 min-w-0 gap-1\">\n            <div className=\"flex items-start justify-between gap-2\">\n              {/* Description */}\n              <p\n                className={cn(\n                  \"text-sm font-medium leading-snug break-words min-w-0\",\n                  isCompleted\n                    ? \"line-through text-muted-foreground\"\n                    : \"text-foreground\",\n                )}\n              >\n                {task.text || \"No description\"}\n              </p>\n\n              {/* Right Side: Initials + Actions */}\n              <div className=\"flex items-start gap-1 flex-shrink-0\">\n                {task.tagged_user_ids && task.tagged_user_ids.length > 0 && (\n                  <RecordContextProvider value={task}>\n                    <ReferenceArrayField\n                      source=\"tagged_user_ids\"\n                      reference=\"sales\"\n                    >\n                      <SingleFieldList className=\"flex items-center gap-1\">\n                        <UserInitials />\n                      </SingleFieldList>\n                    </ReferenceArrayField>\n                  </RecordContextProvider>\n                )}\n\n                <div className=\"opacity-0 group-hover:opacity-100 transition-opacity\">\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"h-6 w-6 p-0 cursor-pointer hover:bg-muted\"\n                        aria-label=\"task actions\"\n                      >\n                        <MoreVertical className=\"h-3.5 w-3.5\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      {isCompleted ? (\n                        <DropdownMenuItem\n                          className=\"cursor-pointer\"\n                          onClick={() => {\n                            update(\"tasks\", {\n                              id: task.id,\n                              data: { done_date: null },\n                              previousData: task,\n                            });\n                            notify(\"Task added back to tasks board\", {\n                              type: \"success\",\n                            });\n                          }}\n                        >\n                          Add back to tasks\n                        </DropdownMenuItem>\n                      ) : (\n                        <>\n                          <DropdownMenuItem\n                            className=\"cursor-pointer\"\n                            onClick={() => {\n                              const tomorrow = crmAddDays(new Date(), 1)?.toISOString();\n                              update(\"tasks\", {\n                                id: task.id,\n                                data: { due_date: tomorrow || new Date().toISOString() },\n                                previousData: task,\n                              });\n                            }}\n                          >\n                            Postpone to tomorrow\n                          </DropdownMenuItem>\n                          <DropdownMenuItem\n                            className=\"cursor-pointer\"\n                            onClick={() => {\n                              const nextWeek = crmAddDays(new Date(), 7)?.toISOString();\n                              update(\"tasks\", {\n                                id: task.id,\n                                data: { due_date: nextWeek || new Date().toISOString() },\n                                previousData: task,\n                              });\n                            }}\n                          >\n                            Postpone to next week\n                          </DropdownMenuItem>\n                        </>\n                      )}\n                      <DropdownMenuItem className=\"cursor-pointer\" onClick={handleEdit}>\n                        Edit\n                      </DropdownMenuItem>\n                      <DropdownMenuItem\n                        className=\"cursor-pointer text-destructive\"\n                        onClick={handleDelete}\n                      >\n                        Delete\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n              </div>\n            </div>\n\n            {/* Footer Metadata */}\n            <div className=\"flex items-center gap-2 text-xs min-w-0\">\n              {dueDate && (\n                <div\n                  className={cn(\n                    \"flex items-center gap-1.5 whitespace-nowrap flex-shrink-0\",\n                    isOverdue && !isCompleted\n                      ? \"text-destructive font-medium\"\n                      : \"text-muted-foreground\",\n                  )}\n                >\n                  {isOverdue && !isCompleted && (\n                    <span className=\"w-1.5 h-1.5 rounded-full bg-destructive flex-shrink-0\" />\n                  )}\n                  <DateField source=\"due_date\" record={task} />\n                </div>\n              )}\n\n              {dueDate && showContact && (\n                <span className=\"text-muted-foreground/30 flex-shrink-0\"></span>\n              )}\n\n              {showContact && (\n                <div className=\"min-w-0 truncate\">\n                  <ReferenceField<TData, Contact>\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={task}\n                    link=\"show\"\n                    className=\"text-muted-foreground hover:underline truncate block\"\n                    render={({ referenceRecord }) => {\n                      if (!referenceRecord) return null;\n                      const fullName =\n                        `${referenceRecord?.first_name ?? \"\"} ${referenceRecord?.last_name ?? \"\"}`.trim() ||\n                        \"New Lead\";\n                      return (\n                        <span className=\"truncate block\" title={fullName}>\n                          {fullName}\n                        </span>\n                      );\n                    }}\n                  />\n                </div>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* This part is for editing the Task directly via a Dialog */}\n      {openEdit && (\n        <TaskEdit taskId={task.id} open={openEdit} close={handleCloseEdit} />\n      )}\n    </>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/AddTask.tsx",
      "content": "import { Plus } from \"lucide-react\";\nimport {\n  CreateBase,\n  Form,\n  RecordRepresentation,\n  required,\n  useDataProvider,\n  useGetIdentity,\n  useNotify,\n  useRecordContext,\n  useUpdate,\n} from \"ra-core\";\nimport { useState } from \"react\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { useFormContext } from \"react-hook-form\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { ReferenceArrayInput } from \"@/components/admin/reference-array-input\";\nimport { AutocompleteArrayInput } from \"@/components/admin/autocomplete-array-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport {\n  FormControl,\n  FormError,\n  FormField,\n  FormLabel,\n} from \"@/components/admin/form\";\nimport { FieldTitle, useInput, useResourceContext } from \"ra-core\";\nimport { InputHelperText } from \"@/components/admin/input-helper-text\";\n\nimport { contactOptionText } from \"../misc/ContactOption\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport {\n  crmDateInputString,\n  crmDateYmdInputString,\n  crmDateStringToISO,\n  crmStartOfDay,\n} from \"../misc/timezone\";\nimport { SmartTextInput } from \"../misc/SmartTextInput\";\nimport type { Sale } from \"../types\";\n\nexport const AddTask = ({\n  selectContact,\n  display = \"chip\",\n}: {\n  selectContact?: boolean;\n  display?: \"chip\" | \"icon\";\n}) => {\n  const { identity } = useGetIdentity();\n  const dataProvider = useDataProvider();\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const { taskTypes } = useConfigurationContext();\n  const contact = useRecordContext();\n  const [open, setOpen] = useState(false);\n  const queryClient = useQueryClient();\n  const handleOpen = () => {\n    setOpen(true);\n  };\n\n  const handleSuccess = async (data: any) => {\n    setOpen(false);\n    const contact = await dataProvider.getOne(\"contacts\", {\n      id: data.contact_id,\n    });\n    if (!contact.data) return;\n\n    await update(\"contacts\", {\n      id: contact.data.id,\n      data: { last_seen: new Date().toISOString() },\n      previousData: contact.data,\n    });\n\n    // Refresh activity log so the new task shows immediately (any scope)\n    queryClient.invalidateQueries({\n      predicate: ({ queryKey }) =>\n        Array.isArray(queryKey) && queryKey[0] === \"activityLog\",\n    });\n    notify(\"Task added\");\n  };\n\n  if (!identity) return null;\n\n  return (\n    <>\n      {display === \"icon\" ? (\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                size=\"sm\"\n                variant=\"ghost\"\n                className=\"p-2 cursor-pointer\"\n                onClick={handleOpen}\n              >\n                <Plus className=\"w-4 h-4\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>Create task</TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      ) : (\n        <div className=\"my-2\">\n          <Button\n            variant=\"outline\"\n            className=\"h-6 cursor-pointer\"\n            onClick={handleOpen}\n            size=\"sm\"\n          >\n            <Plus className=\"w-4 h-4\" />\n            Add task\n          </Button>\n        </div>\n      )}\n\n      <CreateBase\n        resource=\"tasks\"\n        record={{\n          type: \"None\",\n          contact_id: contact?.id,\n          // Keep due_date in form state as YYYY-MM-DD (matches <input type=\"date\">)\n          due_date: crmDateYmdInputString() || new Date().toISOString().slice(0, 10),\n          sales_id: identity.id,\n          // Explicitly omit tagged_user_ids from initial record to avoid schema cache issues\n        }}\n        transform={(data) => {\n          const rawText = String(data.text ?? \"\").trim();\n          const textWithoutDateHints = rawText\n            // relative phrases\n            .replace(/\\b(day\\s+after\\s+tomorrow|day\\s+after\\s+tmrw)\\b/gi, \"\")\n            .replace(/\\b(next\\s+week|next\\s+month)\\b/gi, \"\")\n            .replace(/\\b(in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)\\b/gi, \"\")\n            .replace(/\\b(today|tomorrow)\\b/gi, \"\")\n            // date literals\n            .replace(/\\b\\d{4}-\\d{2}-\\d{2}\\b/g, \"\")\n            .replace(/\\b\\d{1,2}\\/\\d{1,2}(?:\\/\\d{2,4})?\\b/g, \"\")\n            // cleanup whitespace/punctuation\n            .replace(/\\s{2,}/g, \" \")\n            .replace(/^[\\s,.;:-]+|[\\s,.;:-]+$/g, \"\")\n            .trim();\n          const cleanedText =\n            textWithoutDateHints.length > 0 ? textWithoutDateHints : rawText;\n\n          const dueDateIso =\n            crmDateStringToISO(data.due_date) ||\n            crmStartOfDay()?.toISOString() ||\n            data.due_date;\n          \n          // Build result object excluding problematic fields\n          const result: any = {\n            type: data.type,\n            contact_id: data.contact_id,\n            text: cleanedText,\n            due_date: dueDateIso,\n            sales_id: data.sales_id,\n          };\n          \n          // Only include tagged_user_ids if it's a valid non-empty array\n          // This avoids schema cache issues if the column doesn't exist in Supabase's cache yet\n          if (Array.isArray(data.tagged_user_ids) && data.tagged_user_ids.length > 0) {\n            result.tagged_user_ids = data.tagged_user_ids;\n          }\n          \n          // Explicitly do NOT include created_at or any other fields that might cause issues\n          return result;\n        }}\n        mutationOptions={{ onSuccess: handleSuccess }}\n      >\n        <Dialog open={open} onOpenChange={() => setOpen(false)}>\n          <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n            <Form className=\"flex flex-col gap-4\">\n              <DialogHeader>\n                <DialogTitle>\n                  {!selectContact\n                    ? \"Create a new task for \"\n                    : \"Create a new task\"}\n                  {!selectContact && contact && \n                   (() => {\n                     const firstName = contact.first_name?.trim();\n                     const lastName = contact.last_name?.trim();\n                     const validFirstName = firstName && firstName !== \"null\" && firstName !== \"\";\n                     const validLastName = lastName && lastName !== \"null\" && lastName !== \"\";\n                     \n                     if (validFirstName || validLastName) {\n                       const nameParts = [validFirstName ? firstName : null, validLastName ? lastName : null]\n                         .filter(Boolean)\n                         .join(\" \");\n                       return nameParts || \"this contact\";\n                     }\n                     return \"this contact\";\n                   })()}\n                </DialogTitle>\n                <DialogDescription>\n                  Add a new task with a description, due date, type, and optionally tag users.\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"flex flex-col gap-4\">\n                <TaskDescriptionInput />\n                {selectContact && (\n                  <ReferenceInput\n                    source=\"contact_id\"\n                    reference=\"contacts_summary\"\n                  >\n                    <AutocompleteInput\n                      label=\"Contact\"\n                      optionText={contactOptionText}\n                      helperText={false}\n                      validate={required()}\n                    />\n                  </ReferenceInput>\n                )}\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <DateInput\n                    source=\"due_date\"\n                    helperText={false}\n                    validate={required()}\n                  />\n                  <SelectInput\n                    source=\"type\"\n                    validate={required()}\n                    choices={taskTypes.map((type) => ({\n                      id: type,\n                      name: type,\n                    }))}\n                    helperText={false}\n                  />\n                </div>\n                <ReferenceArrayInput\n                  source=\"tagged_user_ids\"\n                  reference=\"sales\"\n                  filter={{ \"disabled@neq\": true }}\n                  sort={{ field: \"last_name\", order: \"ASC\" }}\n                >\n                  <AutocompleteArrayInput\n                    label=\"Tag users\"\n                    helperText={false}\n                    optionText={(choice: Sale) => `${choice.first_name} ${choice.last_name}`}\n                    placeholder=\"Search users to tag...\"\n                  />\n                </ReferenceArrayInput>\n              </div>\n              <DialogFooter className=\"w-full justify-end\">\n                <SaveButton />\n              </DialogFooter>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </CreateBase>\n    </>\n  );\n};\n\n// Component that wraps SmartTextInput with form integration\nconst TaskDescriptionInput = () => {\n  const resource = useResourceContext();\n  const { id, field, isRequired } = useInput({\n    source: \"text\",\n    validate: required(),\n  });\n  const { setValue } = useFormContext();\n\n  const handleDateDetected = (date: string) => {\n    // Update the due_date field when a date is detected\n    try {\n      const dateObj = new Date(date);\n      if (!isNaN(dateObj.getTime())) {\n        const dateStr = crmDateYmdInputString(dateObj);\n        if (dateStr) {\n          setValue(\"due_date\", dateStr, { shouldDirty: true, shouldValidate: false });\n        }\n      }\n    } catch (error) {\n      console.error(\"Error parsing date:\", error);\n    }\n  };\n\n  const handleUsersTagged = (userIds: number[]) => {\n    // Update the tagged_user_ids field when users are tagged\n    setValue(\"tagged_user_ids\", userIds.length > 0 ? userIds : undefined, { shouldDirty: true });\n  };\n\n  return (\n    <FormField id={id} className=\"m-0\" name={field.name}>\n      <FormLabel>\n        <FieldTitle\n          label=\"Description\"\n          source=\"text\"\n          resource={resource}\n          isRequired={isRequired}\n        />\n      </FormLabel>\n      <FormControl>\n        <SmartTextInput\n          value={field.value || \"\"}\n          onChange={field.onChange}\n          onBlur={field.onBlur}\n          multiline\n          placeholder=\"Type a task description. Try typing a date like 'tomorrow' or tag someone with @\"\n          className=\"m-0\"\n          onDateDetected={handleDateDetected}\n          onUsersTagged={handleUsersTagged}\n          autoFocus\n        />\n      </FormControl>\n      <InputHelperText helperText={false} />\n      <FormError />\n    </FormField>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/colors.ts",
      "content": "export const colors = [\n  \"#eddcd2\",\n  \"#fff1e6\",\n  \"#fde2e4\",\n  \"#fad2e1\",\n  \"#c5dedd\",\n  \"#dbe7e4\",\n  \"#f0efeb\",\n  \"#d6e2e9\",\n  \"#bcd4e6\",\n  \"#99c1de\",\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagEditModal.tsx",
      "content": "import { useUpdate } from \"ra-core\";\n\nimport type { Tag } from \"../types\";\nimport { TagDialog } from \"./TagDialog\";\n\ntype TagEditModalProps = {\n  tag: Tag;\n  open: boolean;\n  onClose(): void;\n  onSuccess?(tag: Tag): Promise<void>;\n};\n\nexport function TagEditModal({\n  tag,\n  open,\n  onClose,\n  onSuccess,\n}: TagEditModalProps) {\n  const [update] = useUpdate<Tag>();\n\n  const handleEditTag = async (data: Pick<Tag, \"name\" | \"color\">) => {\n    await update(\n      \"tags\",\n      { id: tag.id, data, previousData: tag },\n      {\n        onSuccess: async (tag) => {\n          await onSuccess?.(tag);\n        },\n      },\n    );\n  };\n\n  return (\n    <TagDialog\n      open={open}\n      title=\"Edit tag\"\n      onClose={onClose}\n      onSubmit={handleEditTag}\n      tag={tag}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagDialog.tsx",
      "content": "import { SaveIcon } from \"lucide-react\";\nimport { useEffect, useState, type ChangeEvent, type FormEvent } from \"react\";\nimport { Button, buttonVariants } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { cn } from \"@/lib/utils\";\n\nimport type { Tag } from \"../types\";\nimport { colors } from \"./colors\";\nimport { RoundButton } from \"./RoundButton\";\n\ntype TagDialogProps = {\n  open: boolean;\n  tag?: Pick<Tag, \"name\" | \"color\">;\n  title: string;\n  onSubmit(tag: Pick<Tag, \"name\" | \"color\">): Promise<void>;\n  onClose(): void;\n};\n\nexport function TagDialog({\n  open,\n  tag,\n  title,\n  onClose,\n  onSubmit,\n}: TagDialogProps) {\n  const [newTagName, setNewTagName] = useState(\"\");\n  const [newTagColor, setNewTagColor] = useState(colors[0]);\n  const [disabled, setDisabled] = useState(false);\n\n  const handleNewTagNameChange = (event: ChangeEvent<HTMLInputElement>) => {\n    setNewTagName(event.target.value);\n  };\n\n  const handleClose = () => {\n    setDisabled(false);\n    onClose();\n  };\n\n  const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n\n    await onSubmit({ name: newTagName, color: newTagColor });\n\n    setDisabled(true);\n    setNewTagName(\"\");\n    setNewTagColor(colors[0]);\n\n    handleClose();\n  };\n\n  useEffect(() => {\n    setNewTagName(tag?.name ?? \"\");\n    setNewTagColor(tag?.color ?? colors[0]);\n  }, [tag]);\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"sm:max-w-lg\">\n        <form onSubmit={handleSubmit}>\n          <DialogHeader>\n            <DialogTitle>{title}</DialogTitle>\n            <DialogDescription className=\"sr-only\">\n              {tag ? \"Edit tag name and color\" : \"Create a new tag with name and color\"}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"tag-name\">Tag name</Label>\n              <Input\n                id=\"tag-name\"\n                autoFocus\n                value={newTagName}\n                onChange={handleNewTagNameChange}\n                placeholder=\"Enter tag name\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Color</Label>\n              <div className=\"flex flex-wrap\">\n                {colors.map((color) => (\n                  <RoundButton\n                    key={color}\n                    color={color}\n                    selected={color === newTagColor}\n                    handleClick={() => {\n                      setNewTagColor(color);\n                    }}\n                  />\n                ))}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"flex justify-end pt-4\">\n            <Button\n              variant=\"outline\"\n              disabled={disabled}\n              className={cn(\n                buttonVariants({ variant: \"outline\" }),\n                \"text-primary\",\n                disabled ? \"opacity-50 cursor-not-allowed\" : \"cursor-pointer\",\n              )}\n            >\n              <SaveIcon />\n              Save\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagCreateModal.tsx",
      "content": "import { useCreate } from \"ra-core\";\n\nimport type { Tag } from \"../types\";\nimport { TagDialog } from \"./TagDialog\";\n\ntype TagCreateModalProps = {\n  open: boolean;\n  onClose(): void;\n  onSuccess?(tag: Tag): Promise<void>;\n};\n\nexport function TagCreateModal({\n  open,\n  onClose,\n  onSuccess,\n}: TagCreateModalProps) {\n  const [create] = useCreate<Tag>();\n\n  const handleCreateTag = async (data: Pick<Tag, \"name\" | \"color\">) => {\n    await create(\n      \"tags\",\n      { data },\n      {\n        onSuccess: async (tag) => {\n          await onSuccess?.(tag);\n        },\n      },\n    );\n  };\n\n  return (\n    <TagDialog\n      open={open}\n      title=\"Create a new tag\"\n      onClose={onClose}\n      onSubmit={handleCreateTag}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagChip.tsx",
      "content": "import { X } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport type { Tag } from \"../types\";\nimport { TagEditModal } from \"./TagEditModal\";\n\ntype TagChipProps = {\n  tag: Tag;\n\n  onUnlink: () => Promise<void>;\n};\n\nexport function TagChip({ tag, onUnlink }: TagChipProps) {\n  const [open, setOpen] = useState(false);\n\n  const handleClose = () => {\n    setOpen(false);\n  };\n\n  const handleClick = () => {\n    setOpen(true);\n  };\n\n  return (\n    <>\n      <div\n        className=\"text-black inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md cursor-pointer hover:opacity-80 transition-opacity\"\n        style={{ backgroundColor: tag.color }}\n        onClick={handleClick}\n      >\n        {tag.name}\n        <button\n          onClick={(e) => {\n            e.stopPropagation();\n            onUnlink();\n          }}\n          className=\"transition-colors p-0 ml-1 cursor-pointer\"\n        >\n          <X className=\"w-3 h-3\" />\n        </button>\n      </div>\n      <TagEditModal tag={tag} open={open} onClose={handleClose} />\n    </>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/RoundButton.tsx",
      "content": "export const RoundButton = ({ color, handleClick, selected }: any) => (\n  <button\n    type=\"button\"\n    className={`w-8 h-8 rounded-full inline-block m-1 transition-all ${\n      selected ? \"ring-2 ring-gray-500 ring-offset-1\" : \"\"\n    }`}\n    style={{ backgroundColor: color }}\n    onClick={handleClick}\n  />\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/staff/index.tsx",
      "content": "import type { Staff } from \"../types\";\nimport { StaffCreate } from \"./StaffCreate\";\nimport { StaffEdit } from \"./StaffEdit\";\nimport { StaffList } from \"./StaffList\";\nimport { StaffShow } from \"./StaffShow\";\n\nexport default {\n  list: StaffList,\n  show: StaffShow,\n  edit: StaffEdit,\n  create: StaffCreate,\n  recordRepresentation: (record: Staff) =>\n    `${record?.first_name} ${record?.last_name}`.trim(),\n};\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/staff/StaffShow.tsx",
      "content": "import { ShowBase, useShowContext } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Edit, Phone, Mail } from \"lucide-react\";\nimport { Link } from \"react-router\";\nimport type { Staff } from \"../types\";\n\nconst staffTypeColors: Record<string, string> = {\n  Doctor: \"bg-blue-500 hover:bg-blue-600\",\n  Nurse: \"bg-green-500 hover:bg-green-600\",\n  Physiotherapist: \"bg-purple-500 hover:bg-purple-600\",\n  Caregiver: \"bg-orange-500 hover:bg-orange-600\",\n  Management: \"bg-indigo-500 hover:bg-indigo-600\",\n  Driver: \"bg-gray-500 hover:bg-gray-600\",\n};\n\nexport const StaffShow = () => {\n  return (\n    <ShowBase>\n      <StaffShowContent />\n    </ShowBase>\n  );\n};\n\nconst StaffShowContent = () => {\n  const { record, isPending } = useShowContext<Staff>();\n\n  if (isPending || !record) {\n    return (\n      <div className=\"mt-2 flex justify-center\">\n        <div className=\"w-[90%] max-w-2xl\">\n          <Card>\n            <CardContent className=\"p-6\">\n              <div className=\"space-y-4\">\n                <div className=\"h-8 bg-muted animate-pulse rounded w-1/3\" />\n                <div className=\"h-4 bg-muted animate-pulse rounded w-1/2\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  const fullName = `${record.first_name} ${record.last_name}`.trim();\n\n  return (\n    <div className=\"mt-2 flex justify-center\">\n      <div className=\"w-[90%] max-w-2xl\">\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <CardTitle className=\"text-2xl\">{fullName}</CardTitle>\n                <div className=\"flex items-center gap-2 mt-2\">\n                  <Badge\n                    className={staffTypeColors[record.staff_type] || \"bg-gray-500\"}\n                  >\n                    {record.staff_type || \"Unknown\"}\n                  </Badge>\n                </div>\n              </div>\n              <Button asChild>\n                <Link to={`/staff/${record.id}/edit`} className=\"flex items-center gap-2\">\n                  <Edit className=\"h-4 w-4\" />\n                  Edit\n                </Link>\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <div>\n                <h3 className=\"text-sm font-medium text-muted-foreground mb-2\">First Name</h3>\n                <p className=\"text-base\">{record.first_name}</p>\n              </div>\n              <div>\n                <h3 className=\"text-sm font-medium text-muted-foreground mb-2\">Last Name</h3>\n                <p className=\"text-base\">{record.last_name}</p>\n              </div>\n              <div>\n                <h3 className=\"text-sm font-medium text-muted-foreground mb-2\">Staff Type</h3>\n                <Badge\n                  className={staffTypeColors[record.staff_type] || \"bg-gray-500\"}\n                >\n                  {record.staff_type || \"Unknown\"}\n                </Badge>\n              </div>\n              <div>\n                <h3 className=\"text-sm font-medium text-muted-foreground mb-2\">Phone</h3>\n                <div className=\"flex items-center gap-2\">\n                  <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                  <p className=\"text-base\">{record.phone}</p>\n                </div>\n              </div>\n              {record.email && (\n                <div>\n                  <h3 className=\"text-sm font-medium text-muted-foreground mb-2\">Email</h3>\n                  <div className=\"flex items-center gap-2\">\n                    <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                    <p className=\"text-base\">{record.email}</p>\n                  </div>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/staff/StaffListFilter.tsx",
      "content": "import { useListContext } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport type { Staff } from \"../types\";\n\nexport const StaffListFilter = () => {\n  const { filterValues = {}, setFilters } = useListContext<Staff>();\n\n  const handleStaffTypeChange = (value: string) => {\n    if (value === \"all\") {\n      const newFilters = { ...filterValues };\n      delete newFilters.staff_type;\n      setFilters(newFilters);\n    } else {\n      setFilters({ ...filterValues, staff_type: value });\n    }\n  };\n\n  const clearFilters = () => {\n    setFilters({});\n  };\n\n  const hasFilters = Object.keys(filterValues).length > 0;\n\n  return (\n    <div className=\"flex items-center gap-2\">\n      <Select\n        value={(filterValues.staff_type as string) || \"all\"}\n        onValueChange={handleStaffTypeChange}\n      >\n        <SelectTrigger className=\"w-[180px]\">\n          <SelectValue placeholder=\"All Roles\" />\n        </SelectTrigger>\n        <SelectContent>\n          <SelectItem value=\"all\">All Roles</SelectItem>\n          <SelectItem value=\"Doctor\">Doctor</SelectItem>\n          <SelectItem value=\"Nurse\">Nurse</SelectItem>\n          <SelectItem value=\"Physiotherapist\">Physiotherapist</SelectItem>\n          <SelectItem value=\"Caregiver\">Caregiver</SelectItem>\n          <SelectItem value=\"Management\">Management</SelectItem>\n          <SelectItem value=\"Driver\">Driver</SelectItem>\n        </SelectContent>\n      </Select>\n\n      {hasFilters && (\n        <Button variant=\"outline\" onClick={clearFilters}>\n          Clear Filters\n        </Button>\n      )}\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/staff/StaffListContent.tsx",
      "content": "import { RecordContextProvider, useListContext } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Phone, Mail } from \"lucide-react\";\nimport type { Staff } from \"../types\";\n\nconst staffTypeColors: Record<string, string> = {\n  Doctor: \"bg-blue-500 hover:bg-blue-600\",\n  Nurse: \"bg-green-500 hover:bg-green-600\",\n  Physiotherapist: \"bg-purple-500 hover:bg-purple-600\",\n  Caregiver: \"bg-orange-500 hover:bg-orange-600\",\n  Management: \"bg-indigo-500 hover:bg-indigo-600\",\n  Driver: \"bg-gray-500 hover:bg-gray-600\",\n};\n\nexport const StaffListContent = () => {\n  const {\n    data: staff,\n    isPending,\n    onSelect,\n    onToggleItem,\n    selectedIds,\n  } = useListContext<Staff>();\n\n  if (isPending) {\n    return (\n      <div className=\"p-4\">\n        <div className=\"space-y-4\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"h-16 bg-muted animate-pulse rounded\" />\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  if (!staff || staff.length === 0) {\n    return (\n      <div className=\"p-8 text-center text-muted-foreground\">\n        <p>No staff members found. Click \"+ Add Staff\" to create your first staff member.</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"w-full\">\n        <thead>\n          <tr className=\"border-b\">\n            <th className=\"p-4 text-left w-12\">\n              <Checkbox\n                checked={selectedIds?.length === staff.length && staff.length > 0}\n                onCheckedChange={(checked) => {\n                  if (checked) {\n                    staff.forEach((s) => onSelect(s.id));\n                  } else {\n                    staff.forEach((s) => onToggleItem(s.id));\n                  }\n                }}\n              />\n            </th>\n            <th className=\"p-4 text-left font-medium\">Staff Member</th>\n            <th className=\"p-4 text-left font-medium\">Role</th>\n            <th className=\"p-4 text-left font-medium\">Contact</th>\n            <th className=\"p-4 text-left font-medium\">Actions</th>\n          </tr>\n        </thead>\n        <tbody>\n          {staff.map((member) => (\n            <RecordContextProvider key={member.id} value={member}>\n              <StaffRow member={member} selectedIds={selectedIds} onToggleItem={onToggleItem} />\n            </RecordContextProvider>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n};\n\nconst StaffRow = ({\n  member,\n  selectedIds,\n  onToggleItem,\n}: {\n  member: Staff;\n  selectedIds?: (string | number)[];\n  onToggleItem: (id: string | number) => void;\n}) => {\n  const isSelected = selectedIds?.includes(member.id);\n  const fullName = `${member.first_name} ${member.last_name}`.trim();\n\n  return (\n    <tr className=\"border-b hover:bg-muted/50 transition-colors\">\n      <td className=\"p-4\">\n        <Checkbox\n          checked={isSelected}\n          onCheckedChange={() => onToggleItem(member.id)}\n          onClick={(e) => e.stopPropagation()}\n        />\n      </td>\n      <td className=\"p-4\">\n        <Link\n          to={`/staff/${member.id}/show`}\n          className=\"hover:underline font-medium\"\n        >\n          {fullName}\n        </Link>\n        {member.email && (\n          <div className=\"flex items-center gap-1 text-sm text-muted-foreground mt-1\">\n            <Mail className=\"h-3 w-3\" />\n            <span>{member.email}</span>\n          </div>\n        )}\n      </td>\n      <td className=\"p-4\">\n        <Badge\n          className={staffTypeColors[member.staff_type] || \"bg-gray-500\"}\n        >\n          {member.staff_type || \"Unknown\"}\n        </Badge>\n      </td>\n      <td className=\"p-4\">\n        <div className=\"flex items-center gap-1 text-sm\">\n          <Phone className=\"h-3 w-3 text-muted-foreground\" />\n          <span>{member.phone}</span>\n        </div>\n      </td>\n      <td className=\"p-4\">\n        <Link\n          to={`/staff/${member.id}/edit`}\n          className=\"text-sm text-primary hover:underline\"\n        >\n          Edit\n        </Link>\n      </td>\n    </tr>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/staff/StaffList.tsx",
      "content": "import { FilterLiveForm, useListContext } from \"ra-core\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SortButton } from \"@/components/admin/sort-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Card } from \"@/components/ui/card\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { StaffListContent } from \"./StaffListContent\";\nimport { StaffListFilter } from \"./StaffListFilter\";\nimport type { Staff } from \"../types\";\n\nexport const StaffList = () => {\n  return (\n    <List\n      title={false}\n      actions={<StaffListActions />}\n      perPage={25}\n      sort={{ field: \"created_at\", order: \"DESC\" }}\n    >\n      <StaffListLayout />\n    </List>\n  );\n};\n\nconst StaffListLayout = () => {\n  const { data, isPending } = useListContext<Staff>();\n\n  if (isPending) return null;\n\n  return (\n    <div className=\"flex flex-col gap-6\">\n      <div className=\"flex flex-col gap-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold\">Staff</h1>\n            <p className=\"text-muted-foreground\">Manage healthcare staff and schedules</p>\n          </div>\n        </div>\n        \n        {/* Summary Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Total Staff</p>\n                <p className=\"text-2xl font-bold\">{data?.length || 0}</p>\n              </div>\n            </div>\n          </Card>\n          <Card className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Doctors</p>\n                <p className=\"text-2xl font-bold\">\n                  {data?.filter((s) => s.staff_type === \"Doctor\").length || 0}\n                </p>\n              </div>\n            </div>\n          </Card>\n          <Card className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Nurses</p>\n                <p className=\"text-2xl font-bold\">\n                  {data?.filter((s) => s.staff_type === \"Nurse\").length || 0}\n                </p>\n              </div>\n            </div>\n          </Card>\n          <Card className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Management</p>\n                <p className=\"text-2xl font-bold\">\n                  {data?.filter((s) => s.staff_type === \"Management\").length || 0}\n                </p>\n              </div>\n            </div>\n          </Card>\n        </div>\n\n        {/* Search and Filters */}\n        <Card className=\"p-4\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"flex-1 max-w-md\">\n              <FilterLiveForm>\n                <SearchInput source=\"q\" placeholder=\"Search staff...\" />\n              </FilterLiveForm>\n            </div>\n            <StaffListFilter />\n          </div>\n        </Card>\n      </div>\n\n      {/* Staff Table */}\n      <Card className=\"py-0\">\n        <StaffListContent />\n      </Card>\n    </div>\n  );\n};\n\nconst StaffListActions = () => {\n  return (\n    <TopToolbar>\n      <SortButton fields={[\"first_name\", \"last_name\", \"created_at\", \"staff_type\"]} />\n      <CreateButton label=\"+ Add Staff\" />\n    </TopToolbar>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/staff/StaffInputs.tsx",
      "content": "import { TextInput } from \"@/components/admin/text-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\n\nconst staffTypeOptions = [\n  { id: \"Doctor\", name: \"Doctor\" },\n  { id: \"Nurse\", name: \"Nurse\" },\n  { id: \"Physiotherapist\", name: \"Physiotherapist\" },\n  { id: \"Caregiver\", name: \"Caregiver\" },\n  { id: \"Management\", name: \"Management\" },\n  { id: \"Driver\", name: \"Driver\" },\n];\n\nexport const StaffInputs = () => {\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <TextInput\n          source=\"first_name\"\n          label=\"First Name\"\n          required\n          fullWidth\n        />\n        <TextInput\n          source=\"last_name\"\n          label=\"Last Name\"\n          required\n          fullWidth\n        />\n      </div>\n\n      <SelectInput\n        source=\"staff_type\"\n        label=\"Staff Type\"\n        choices={staffTypeOptions}\n        optionText=\"name\"\n        optionValue=\"id\"\n        required\n        fullWidth\n      />\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <TextInput\n          source=\"phone\"\n          label=\"Phone\"\n          required\n          fullWidth\n          helperText=\"Include country code (e.g., +971501234567)\"\n        />\n        <TextInput\n          source=\"email\"\n          label=\"Email\"\n          fullWidth\n          type=\"email\"\n        />\n      </div>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/staff/StaffEdit.tsx",
      "content": "import { EditBase, Form, useEditContext } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useDataProvider, useNotify, useRedirect } from \"ra-core\";\nimport { Trash2 } from \"lucide-react\";\nimport type { Staff } from \"../types\";\nimport { StaffInputs } from \"./StaffInputs\";\n\nexport const StaffEdit = () => {\n  return (\n    <EditBase redirect=\"show\">\n      <StaffEditContent />\n    </EditBase>\n  );\n};\n\nconst StaffEditContent = () => {\n  const { record } = useEditContext<Staff>();\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const redirect = useRedirect();\n\n  const handleDelete = async () => {\n    if (!record?.id || !confirm(\"Are you sure you want to delete this staff member?\")) {\n      return;\n    }\n\n    try {\n      await dataProvider.delete(\"staff\", { id: record.id });\n      notify(\"Staff member deleted successfully\", { type: \"success\" });\n      redirect(\"list\", \"staff\");\n    } catch (error) {\n      notify(\"Failed to delete staff member\", { type: \"error\" });\n      console.error(error);\n    }\n  };\n\n  if (!record) return null;\n\n  return (\n    <div className=\"mt-2 flex justify-center\">\n      <div className=\"w-[90%] max-w-2xl\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Edit Staff Member</CardTitle>\n            <p className=\"text-sm text-muted-foreground\">Update staff member information</p>\n          </CardHeader>\n          <CardContent>\n            <Form defaultValues={record}>\n              <StaffInputs />\n              <div className=\"flex items-center justify-between mt-6 pt-6 border-t\">\n                <Button\n                  type=\"button\"\n                  variant=\"destructive\"\n                  onClick={handleDelete}\n                  className=\"flex items-center gap-2\"\n                >\n                  <Trash2 className=\"h-4 w-4\" />\n                  Delete Staff\n                </Button>\n                <FormToolbar />\n              </div>\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/staff/StaffCreate.tsx",
      "content": "import { CreateBase, Form } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport type { Staff } from \"../types\";\nimport { StaffInputs } from \"./StaffInputs\";\n\nexport const StaffCreate = () => {\n  return (\n    <CreateBase redirect=\"show\">\n      <div className=\"mt-2 flex justify-center\">\n        <div className=\"w-[90%] max-w-2xl\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Add Staff Member</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <Form>\n                <StaffInputs />\n                <FormToolbar />\n              </Form>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </CreateBase>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/SimpleListLoading.tsx",
      "content": "import { useTimeout } from \"ra-core\";\nimport type { ReactNode } from \"react\";\n\nimport { ListPlaceholder } from \"./ListPlaceholder.tsx\";\n\nexport const SimpleListLoading = (props: SimpleListLoadingProps) => {\n  const {\n    className,\n    hasLeftAvatarOrIcon,\n    hasRightAvatarOrIcon,\n    hasSecondaryText,\n    hasTertiaryText,\n    nbFakeLines = 5,\n    ...rest\n  } = props;\n\n  const oneSecondHasPassed = useTimeout(1000);\n\n  return oneSecondHasPassed ? (\n    <ul className={className} {...rest}>\n      {times(nbFakeLines, (key) => (\n        <li key={key} className=\"flex items-center space-x-3 p-3\">\n          {hasLeftAvatarOrIcon && (\n            <div className=\"w-10 h-10 bg-gray-300 rounded-full flex-shrink-0\">\n              &nbsp;\n            </div>\n          )}\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"mb-1\">\n              <ListPlaceholder className=\"w-1/3 inline-block mb-1\" />\n              {hasTertiaryText && (\n                <span className=\"float-right opacity-55 min-w-[10vw]\">\n                  <ListPlaceholder />\n                </span>\n              )}\n            </div>\n            {hasSecondaryText && <ListPlaceholder className=\"w-1/4\" />}\n          </div>\n          {hasRightAvatarOrIcon && (\n            <div className=\"w-10 h-10 bg-gray-300 rounded-full flex-shrink-0\">\n              &nbsp;\n            </div>\n          )}\n        </li>\n      ))}\n    </ul>\n  ) : null;\n};\n\nconst times = (nbChildren: number, fn: (key: number) => ReactNode) =>\n  Array.from({ length: nbChildren }, (_, key) => fn(key));\n\nexport interface SimpleListLoadingProps {\n  className?: string;\n  hasLeftAvatarOrIcon?: boolean;\n  hasRightAvatarOrIcon?: boolean;\n  hasSecondaryText?: boolean;\n  hasTertiaryText?: boolean;\n  nbFakeLines?: number;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/SimpleListItem.tsx",
      "content": "import {\n  useEvent,\n  useGetPathForRecord,\n  useGetPathForRecordCallback,\n  useRecordContext,\n  useResourceContext,\n  type Identifier,\n  type LinkToType,\n  type RaRecord,\n} from \"ra-core\";\nimport type { CSSProperties, ReactElement, ReactNode } from \"react\";\nimport { Link, useNavigate } from \"react-router\";\n\nexport const SimpleListItem = <RecordType extends RaRecord = any>(\n  props: SimpleListItemProps<RecordType>,\n) => {\n  const { children, linkType, rowClick, style } = props;\n  const resource = useResourceContext(props);\n  const record = useRecordContext<RecordType>(props);\n  const navigate = useNavigate();\n  // If we don't have a function to get the path, we can compute the path immediately and set the href\n  // on the Link correctly without onClick (better for accessibility)\n  const isFunctionLink =\n    typeof linkType === \"function\" || typeof rowClick === \"function\";\n  const pathForRecord = useGetPathForRecord({\n    link: isFunctionLink ? false : (linkType ?? rowClick),\n    resource,\n  });\n  const getPathForRecord = useGetPathForRecordCallback();\n  const handleClick = useEvent(async () => {\n    // No need to handle non function linkType or rowClick\n    if (!isFunctionLink) return;\n    if (!record) return;\n\n    const link: LinkToType =\n      typeof linkType === \"function\"\n        ? linkType(record, record.id)\n        : typeof rowClick === \"function\"\n          ? (record, resource) => rowClick(record.id, resource, record)\n          : false;\n\n    const path = await getPathForRecord({\n      record,\n      resource,\n      link,\n    });\n    if (path === false || path == null) {\n      return;\n    }\n    navigate(path);\n  });\n\n  if (!record) return null;\n\n  if (isFunctionLink) {\n    return (\n      <li className=\"w-full\">\n        <button\n          onClick={handleClick}\n          style={style}\n          className=\"w-full text-left hover:bg-muted focus: bg-muted focus:outline-none\"\n        >\n          {children}\n        </button>\n      </li>\n    );\n  }\n\n  if (pathForRecord) {\n    return (\n      <li className=\"w-full\">\n        <Link\n          to={pathForRecord}\n          style={style}\n          className=\"block w-full hover:bg-muted focus:bg-muted focus:outline-none\"\n        >\n          {children}\n        </Link>\n      </li>\n    );\n  }\n\n  return <li className=\"w-full\">{children}</li>;\n};\n\nexport type FunctionToElement<RecordType extends RaRecord = any> = (\n  record: RecordType,\n  id: Identifier,\n) => ReactNode;\n\nexport type FunctionLinkType = (record: RaRecord, id: Identifier) => string;\n\nexport interface SimpleListBaseProps<RecordType extends RaRecord = any> {\n  leftAvatar?: FunctionToElement<RecordType>;\n  leftIcon?: FunctionToElement<RecordType>;\n  primaryText?: FunctionToElement<RecordType> | ReactElement | string;\n  /**\n   * @deprecated use rowClick instead\n   */\n  linkType?: string | FunctionLinkType | false;\n\n  /**\n   * The action to trigger when the user clicks on a row.\n   *\n   * @see https://marmelab.com/shadcn-admin-kit/docs/datatable/\n   * @example\n   * import { List, DataTable } from 'shadcn-admin-kit';\n   *\n   * export const PostList = () => (\n   *     <List>\n   *         <DataTable rowClick=\"edit\">\n   *             ...\n   *         </DataTable>                    </ListItem>\n\n   *     </List>\n   * );\n   */\n  rowClick?: string | RowClickFunction | false;\n  rightAvatar?: FunctionToElement<RecordType>;\n  rightIcon?: FunctionToElement<RecordType>;\n  secondaryText?: FunctionToElement<RecordType> | ReactElement | string;\n  tertiaryText?: FunctionToElement<RecordType> | ReactElement | string;\n}\n\nexport interface SimpleListItemProps<RecordType extends RaRecord = any>\n  extends SimpleListBaseProps<RecordType> {\n  rowIndex: number;\n  className?: string;\n  style?: CSSProperties;\n  children?: ReactNode;\n  resource?: string;\n}\n\nexport type RowClickFunction<RecordType extends RaRecord = RaRecord> = (\n  id: Identifier,\n  resource: string,\n  record: RecordType,\n) => string | false | Promise<string | false>;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/SimpleList.tsx",
      "content": "import {\n  ListIterator,\n  type RaRecord,\n  sanitizeListRestProps,\n  useGetRecordRepresentation,\n  useListContextWithProps,\n  useRecordContext,\n  useResourceContext,\n  useTranslate,\n} from \"ra-core\";\nimport { isValidElement, type ReactElement } from \"react\";\n\nimport { ListNoResults } from \"./ListNoResults.tsx\";\nimport type { FunctionToElement } from \"./SimpleListItem.tsx\";\nimport {\n  type SimpleListBaseProps,\n  SimpleListItem,\n  type SimpleListItemProps,\n} from \"./SimpleListItem.tsx\";\nimport { SimpleListLoading } from \"./SimpleListLoading.tsx\";\n\n/**\n * The <SimpleList> component renders a list of records\n * It is usually used as a child of shadcn-admin-kit's <List> and <ReferenceManyField> components.\n *\n * Also widely used on Mobile.\n *\n * Props:\n * - primaryText: function returning a React element (or some text) based on the record\n * - secondaryText: same\n * - tertiaryText: same\n * - leftAvatar: function returning a React element based on the record\n * - leftIcon: same\n * - rightAvatar: same\n * - rightIcon: same\n * - linkType: deprecated - 'edit' or 'show', or a function returning 'edit' or 'show' based on the record\n * - rowClick: The action to trigger when the user clicks on a row.\n * - rowStyle: function returning a style object based on (record, index)\n * - rowSx: function returning a sx object based on (record, index)\n *\n * @example // Display all posts as a List\n * const postRowSx = (record, index) => ({\n *     backgroundColor: record.views >= 500 ? '#efe' : 'white',\n * });\n * export const PostList = () => (\n *     <List>\n *         <SimpleList\n *             primaryText={record => record.title}\n *             secondaryText={record => `${record.views} views`}\n *             tertiaryText={record =>\n *                 new Date(record.published_at).toLocaleDateString()\n *             }\n *             rowSx={postRowSx}\n *          />\n *     </List>\n * );\n */\nexport const SimpleList = <RecordType extends RaRecord = any>(\n  props: SimpleListProps<RecordType>,\n) => {\n  const {\n    className,\n    empty = DefaultEmpty,\n    leftAvatar,\n    leftIcon,\n    linkType,\n    rowClick,\n    primaryText,\n    rightAvatar,\n    rightIcon,\n    secondaryText,\n    tertiaryText,\n    resource,\n    ...rest\n  } = props;\n  const { data, isPending, total } = useListContextWithProps<RecordType>(props);\n\n  if (isPending === true) {\n    return (\n      <SimpleListLoading\n        className={className}\n        hasLeftAvatarOrIcon={!!leftIcon || !!leftAvatar}\n        hasRightAvatarOrIcon={!!rightIcon || !!rightAvatar}\n        hasSecondaryText={!!secondaryText}\n        hasTertiaryText={!!tertiaryText}\n      />\n    );\n  }\n\n  if (data == null || data.length === 0 || total === 0) {\n    if (empty) {\n      return empty;\n    }\n\n    return null;\n  }\n\n  return (\n    <ul className={className} {...sanitizeListRestProps(rest)}>\n      <ListIterator<RecordType>\n        data={data}\n        total={total}\n        render={(record, rowIndex) => (\n          <SimpleListItem\n            key={record.id}\n            rowIndex={rowIndex}\n            linkType={linkType}\n            rowClick={rowClick}\n            resource={resource}\n          >\n            <SimpleListItemContent\n              leftAvatar={leftAvatar}\n              leftIcon={leftIcon}\n              primaryText={primaryText}\n              rightAvatar={rightAvatar}\n              rightIcon={rightIcon}\n              secondaryText={secondaryText}\n              tertiaryText={tertiaryText}\n              rowIndex={rowIndex}\n            />\n          </SimpleListItem>\n        )}\n      />\n    </ul>\n  );\n};\n\nexport interface SimpleListProps<RecordType extends RaRecord = any>\n  extends SimpleListBaseProps<RecordType> {\n  className?: string;\n  empty?: ReactElement;\n  // can be injected when using the component without context\n  resource?: string;\n  data?: RecordType[];\n  isLoading?: boolean;\n  isPending?: boolean;\n  isLoaded?: boolean;\n  total?: number;\n}\n\nconst SimpleListItemContent = <RecordType extends RaRecord = any>(\n  props: SimpleListItemProps<RecordType>,\n) => {\n  const {\n    leftAvatar,\n    leftIcon,\n    primaryText,\n    rightAvatar,\n    rightIcon,\n    secondaryText,\n    tertiaryText,\n  } = props;\n  const resource = useResourceContext(props);\n  const record = useRecordContext<RecordType>(props);\n  const getRecordRepresentation = useGetRecordRepresentation(resource);\n  const translate = useTranslate();\n\n  const renderAvatar = (\n    record: RecordType,\n    avatarCallback: FunctionToElement<RecordType>,\n  ) => {\n    const avatarValue = avatarCallback(record, record.id);\n    if (\n      typeof avatarValue === \"string\" &&\n      (avatarValue.startsWith(\"http\") || avatarValue.startsWith(\"data:\"))\n    ) {\n      return (\n        <img\n          src={avatarValue}\n          alt=\"\"\n          className=\"w-10 h-10 rounded-full object-cover\"\n        />\n      );\n    } else {\n      return (\n        <div className=\"w-10 h-10 rounded-full flex items-center justify-center text-sm\">\n          {avatarValue}\n        </div>\n      );\n    }\n  };\n\n  if (!record) return null;\n\n  return (\n    <div className=\"flex items-center space-x-3 p-3\">\n      {leftIcon && (\n        <div className=\"flex-shrink-0\">{leftIcon(record, record.id)}</div>\n      )}\n      {leftAvatar && (\n        <div className=\"flex-shrink-0\">{renderAvatar(record, leftAvatar)}</div>\n      )}\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"text-sm font-medium truncate\">\n            {primaryText\n              ? typeof primaryText === \"string\"\n                ? translate(primaryText, {\n                    ...record,\n                    _: primaryText,\n                  })\n                : isValidElement(primaryText)\n                  ? primaryText\n                  : primaryText(record, record.id)\n              : getRecordRepresentation(record)}\n          </div>\n\n          {!!tertiaryText && (\n            <div className=\"text-xs text-muted-foreground ml-2\">\n              {typeof tertiaryText === \"string\"\n                ? translate(tertiaryText, {\n                    ...record,\n                    _: tertiaryText,\n                  })\n                : isValidElement(tertiaryText)\n                  ? tertiaryText\n                  : tertiaryText(record, record.id)}\n            </div>\n          )}\n        </div>\n\n        {!!secondaryText && (\n          <div className=\"text-sm text-muted-foreground truncate\">\n            {typeof secondaryText === \"string\"\n              ? translate(secondaryText, {\n                  ...record,\n                  _: secondaryText,\n                })\n              : isValidElement(secondaryText)\n                ? secondaryText\n                : secondaryText(record, record.id)}\n          </div>\n        )}\n      </div>\n      {(rightAvatar || rightIcon) && (\n        <div className=\"flex-shrink-0 flex items-center space-x-2\">\n          {rightAvatar && renderAvatar(record, rightAvatar)}\n          {rightIcon && rightIcon(record, record.id)}\n        </div>\n      )}\n    </div>\n  );\n};\n\nconst DefaultEmpty = <ListNoResults />;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/ListPlaceholder.tsx",
      "content": "import { cn } from \"@/lib/utils\";\n\ninterface ListPlaceholderProps {\n  className?: string;\n}\n\nexport const ListPlaceholder = ({ className }: ListPlaceholderProps) => {\n  return <span className={cn(\"bg-gray-300 flex\", className)}>&nbsp;</span>;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/ListNoResults.tsx",
      "content": "import {\n  useGetResourceLabel,\n  useListContextWithProps,\n  useResourceContext,\n  useTranslate,\n} from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\n\nexport const ListNoResults = (props: ListNoResultsProps) => {\n  const translate = useTranslate();\n  const resource = useResourceContext(props);\n  const { filterValues, setFilters } = useListContextWithProps(props);\n  const getResourceLabel = useGetResourceLabel();\n  if (!resource) {\n    throw new Error(\"<ListNoResults> must be used inside a <List> component\");\n  }\n  return (\n    <div className=\"p-6\">\n      <p className=\"text-sm text-muted-foreground\">\n        {filterValues && setFilters && Object.keys(filterValues).length > 0 ? (\n          <>\n            {translate(\"ra.navigation.no_filtered_results\", {\n              resource,\n              name: getResourceLabel(resource, 0),\n              _: \"No results found with the current filters.\",\n            })}{\" \"}\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setFilters({}, [])}\n            >\n              {translate(\"ra.navigation.clear_filters\", {\n                _: \"Clear filters\",\n              })}\n            </Button>\n          </>\n        ) : (\n          translate(\"ra.navigation.no_results\", {\n            resource,\n            name: getResourceLabel(resource, 0),\n            _: \"No results found.\",\n          })\n        )}\n      </p>\n    </div>\n  );\n};\n\nexport interface ListNoResultsProps {\n  resource?: string;\n  filterValues?: any;\n  setFilters?: (filters: any, filterTypes?: string[]) => void;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/settings/SettingsPage.tsx",
      "content": "import { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { CircleX, Copy, Pencil, Save, Plus, Trash2, Edit } from \"lucide-react\";\nimport {\n  Form,\n  useDataProvider,\n  useGetIdentity,\n  useGetOne,\n  useNotify,\n  useRecordContext,\n  useGetList,\n  useCreate,\n  useUpdate,\n  useDelete,\n  type Identifier,\n} from \"ra-core\";\nimport { useState } from \"react\";\nimport * as React from \"react\";\nimport { useFormState } from \"react-hook-form\";\nimport { useNavigate } from \"react-router\";\nimport { RecordField } from \"@/components/admin/record-field\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Confirm } from \"@/components/admin/confirm\";\n\nimport ImageEditorField from \"../misc/ImageEditorField\";\nimport type { CrmDataProvider } from \"../providers/types\";\nimport type { Sale, SalesFormData, Tag, Service } from \"../types\";\nimport { TagCreateModal } from \"../tags/TagCreateModal\";\nimport { TagEditModal } from \"../tags/TagEditModal\";\nimport { TagChip } from \"../tags/TagChip\";\nimport { colors } from \"../tags/colors\";\nimport { RoundButton } from \"../tags/RoundButton\";\nimport { useTimezone } from \"@/hooks/useTimezone\";\nimport { useOfficeLocation } from \"@/hooks/useOfficeLocation\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { formatCrmDateTime } from \"../misc/timezone\";\nimport { PaymentSettingsSection } from \"./PaymentSettingsSection\";\n\nexport const SettingsPage = () => {\n  const [isEditMode, setEditMode] = useState(false);\n  const { identity, refetch: refetchIdentity } = useGetIdentity();\n  const { data, refetch: refetchUser } = useGetOne(\"sales\", {\n    id: identity?.id,\n  });\n  const notify = useNotify();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n\n  const { mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      if (!identity) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.salesUpdate(identity.id, data);\n    },\n    onSuccess: () => {\n      refetchIdentity();\n      refetchUser();\n      setEditMode(false);\n      notify(\"Your profile has been updated\");\n    },\n    onError: (_) => {\n      notify(\"An error occurred. Please try again\", {\n        type: \"error\",\n      });\n    },\n  });\n\n  if (!identity) return null;\n\n  const handleOnSubmit = async (values: any) => {\n    mutate(values);\n  };\n\n  const isAdministrator = data?.administrator === true;\n\n  return (\n    <div className=\"max-w-6xl mx-auto mt-8 px-4\">\n      <Tabs defaultValue=\"profile\" className=\"w-full\">\n        <TabsList className={isAdministrator ? \"grid w-full grid-cols-6\" : \"grid w-full grid-cols-5\"}>\n          <TabsTrigger value=\"profile\">My Info</TabsTrigger>\n          <TabsTrigger value=\"general\">General</TabsTrigger>\n          <TabsTrigger value=\"tags\">Tags</TabsTrigger>\n          <TabsTrigger value=\"services\">Services</TabsTrigger>\n          <TabsTrigger value=\"payments\">Payment Settings</TabsTrigger>\n          {isAdministrator && (\n            <TabsTrigger value=\"users\">Users</TabsTrigger>\n          )}\n        </TabsList>\n\n        <TabsContent value=\"profile\" className=\"mt-6\">\n          <Form onSubmit={handleOnSubmit} record={data}>\n            <SettingsForm isEditMode={isEditMode} setEditMode={setEditMode} />\n          </Form>\n        </TabsContent>\n\n        <TabsContent value=\"general\" className=\"mt-6\">\n          <GeneralSettingsSection />\n        </TabsContent>\n\n        <TabsContent value=\"tags\" className=\"mt-6\">\n          <TagsManagementSection />\n        </TabsContent>\n\n        <TabsContent value=\"services\" className=\"mt-6\">\n          <ServicesManagementSection />\n        </TabsContent>\n\n        <TabsContent value=\"payments\" className=\"mt-6\">\n          <PaymentSettingsSection />\n        </TabsContent>\n\n        {isAdministrator && (\n          <TabsContent value=\"users\" className=\"mt-6\">\n            <UsersManagementSection />\n          </TabsContent>\n        )}\n      </Tabs>\n    </div>\n  );\n};\n\nconst SettingsForm = ({\n  isEditMode,\n  setEditMode,\n}: {\n  isEditMode: boolean;\n  setEditMode: (value: boolean) => void;\n}) => {\n  const notify = useNotify();\n  const record = useRecordContext<Sale>();\n  const { identity, refetch } = useGetIdentity();\n  const { isDirty } = useFormState();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n\n  const { mutate: updatePassword } = useMutation({\n    mutationKey: [\"updatePassword\"],\n    mutationFn: async () => {\n      if (!identity) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.updatePassword(identity.id);\n    },\n    onSuccess: () => {\n      notify(\"A reset password email has been sent to your email address\");\n    },\n    onError: (e) => {\n      notify(`${e}`, {\n        type: \"error\",\n      });\n    },\n  });\n\n  const { mutate: mutateSale } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      if (!record) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.salesUpdate(record.id, data);\n    },\n    onSuccess: () => {\n      refetch();\n      notify(\"Your profile has been updated\");\n    },\n    onError: () => {\n      notify(\"An error occurred. Please try again.\");\n    },\n  });\n  if (!identity) return null;\n\n  const handleClickOpenPasswordChange = () => {\n    updatePassword();\n  };\n\n  const handleAvatarUpdate = async (values: any) => {\n    mutateSale(values);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardContent>\n          <div className=\"mb-4 flex flex-row justify-between\">\n            <h2 className=\"text-xl font-semibold text-muted-foreground\">\n              My info\n            </h2>\n          </div>\n\n          <div className=\"space-y-4 mb-4\">\n            <ImageEditorField\n              source=\"avatar\"\n              type=\"avatar\"\n              onSave={handleAvatarUpdate}\n              linkPosition=\"right\"\n            />\n            <TextRender source=\"first_name\" isEditMode={isEditMode} />\n            <TextRender source=\"last_name\" isEditMode={isEditMode} />\n            <TextRender source=\"email\" isEditMode={isEditMode} />\n          </div>\n\n          <div className=\"flex flex-row justify-end gap-2\">\n            {!isEditMode && (\n              <>\n                <Button\n                  variant=\"outline\"\n                  type=\"button\"\n                  onClick={handleClickOpenPasswordChange}\n                >\n                  Change password\n                </Button>\n              </>\n            )}\n\n            <Button\n              type=\"button\"\n              variant={isEditMode ? \"ghost\" : \"outline\"}\n              onClick={() => setEditMode(!isEditMode)}\n              className=\"flex items-center\"\n            >\n              {isEditMode ? <CircleX /> : <Pencil />}\n              {isEditMode ? \"Cancel\" : \"Edit\"}\n            </Button>\n\n            {isEditMode && (\n              <Button type=\"submit\" disabled={!isDirty} variant=\"outline\">\n                <Save />\n                Save\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n      {import.meta.env.VITE_INBOUND_EMAIL && (\n        <Card>\n          <CardContent>\n            <div className=\"space-y-4 justify-between\">\n              <h2 className=\"text-xl font-semibold text-muted-foreground\">\n                Inbound email\n              </h2>\n              <p className=\"text-sm text-muted-foreground\">\n                You can start sending emails to your server's inbound email\n                address, e.g. by adding it to the\n                <b> Cc: </b> field. BestDOC CRM will process the emails and add\n                notes to the corresponding contacts.\n              </p>\n              <CopyPaste />\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n};\n\nconst TextRender = ({\n  source,\n  isEditMode,\n}: {\n  source: string;\n  isEditMode: boolean;\n}) => {\n  if (isEditMode) {\n    return <TextInput source={source} helperText={false} />;\n  }\n  return (\n    <div className=\"m-2\">\n      <RecordField source={source} />\n    </div>\n  );\n};\n\nconst CopyPaste = () => {\n  const [copied, setCopied] = useState(false);\n  const handleCopy = () => {\n    setCopied(true);\n    navigator.clipboard.writeText(import.meta.env.VITE_INBOUND_EMAIL);\n    setTimeout(() => {\n      setCopied(false);\n    }, 1500);\n  };\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Button\n            type=\"button\"\n            onClick={handleCopy}\n            variant=\"ghost\"\n            className=\"normal-case justify-between w-full\"\n          >\n            <span className=\"overflow-hidden text-ellipsis\">\n              {import.meta.env.VITE_INBOUND_EMAIL}\n            </span>\n            <Copy className=\"h-4 w-4 ml-2\" />\n          </Button>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p>{copied ? \"Copied!\" : \"Copy\"}</p>\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  );\n};\n\n// Tags Management Section\nconst TagsManagementSection = () => {\n  const notify = useNotify();\n  const { data: tags, isLoading, refetch } = useGetList<Tag>(\"tags\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const [create] = useCreate<Tag>();\n  const [update] = useUpdate<Tag>();\n  const [deleteTag] = useDelete();\n  const [createModalOpen, setCreateModalOpen] = useState(false);\n  const [editModalOpen, setEditModalOpen] = useState(false);\n  const [selectedTag, setSelectedTag] = useState<Tag | null>(null);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [tagToDelete, setTagToDelete] = useState<Tag | null>(null);\n\n  const handleCreateSuccess = async () => {\n    setCreateModalOpen(false);\n    refetch();\n    notify(\"Tag created successfully\");\n  };\n\n  const handleEditClick = (tag: Tag) => {\n    setSelectedTag(tag);\n    setEditModalOpen(true);\n  };\n\n  const handleEditSuccess = async () => {\n    setEditModalOpen(false);\n    setSelectedTag(null);\n    refetch();\n    notify(\"Tag updated successfully\");\n  };\n\n  const handleDeleteClick = (tag: Tag) => {\n    setTagToDelete(tag);\n    setDeleteDialogOpen(true);\n  };\n\n  const handleDeleteConfirm = async (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (tagToDelete) {\n      await deleteTag(\"tags\", { id: tagToDelete.id });\n      setDeleteDialogOpen(false);\n      setTagToDelete(null);\n      refetch();\n      notify(\"Tag deleted successfully\");\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex justify-between items-center\">\n          <CardTitle>Tags Management</CardTitle>\n          <Button onClick={() => setCreateModalOpen(true)}>\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add Tag\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n        ) : tags && tags.length > 0 ? (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Name</TableHead>\n                <TableHead>Color</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {tags.map((tag) => (\n                <TableRow key={tag.id}>\n                  <TableCell>{tag.name}</TableCell>\n                  <TableCell>\n                    <TagChip tag={tag} />\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleEditClick(tag)}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleDeleteClick(tag)}\n                      >\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            No tags found. Create your first tag!\n          </div>\n        )}\n\n        <TagCreateModal\n          open={createModalOpen}\n          onClose={() => setCreateModalOpen(false)}\n          onSuccess={handleCreateSuccess}\n        />\n\n        {selectedTag && (\n          <TagEditModal\n            tag={selectedTag}\n            open={editModalOpen}\n            onClose={() => {\n              setEditModalOpen(false);\n              setSelectedTag(null);\n            }}\n            onSuccess={handleEditSuccess}\n          />\n        )}\n\n        <Confirm\n          isOpen={deleteDialogOpen}\n          loading={false}\n          title=\"Delete Tag\"\n          content={`Are you sure you want to delete the tag \"${tagToDelete?.name}\"? This action cannot be undone.`}\n          confirm=\"Delete\"\n          cancel=\"Cancel\"\n          confirmColor=\"warning\"\n          onClose={() => setDeleteDialogOpen(false)}\n          onConfirm={handleDeleteConfirm}\n        />\n      </CardContent>\n    </Card>\n  );\n};\n\n// Services Management Section\nconst ServicesManagementSection = () => {\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n  const { data: services, isLoading, refetch } = useGetList<Service>(\"services\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const [create] = useCreate<Service>();\n  const [update] = useUpdate<Service>();\n  const [deleteService] = useDelete();\n  const [createDialogOpen, setCreateDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedService, setSelectedService] = useState<Service | null>(null);\n  const [serviceToDelete, setServiceToDelete] = useState<Service | null>(null);\n  const [serviceName, setServiceName] = useState(\"\");\n  const [serviceColor, setServiceColor] = useState(\"#3b82f6\");\n  \n  // Color palette for services (expanded with unique colors, excluding blue/green/red used for status)\n  // Status colors to avoid: #3b82f6 (blue), #10b981 (green), #ef4444 (red)\n  const serviceColors = [\n    // Purples and Violets\n    \"#a855f7\", // purple\n    \"#8b5cf6\", // violet\n    \"#c084fc\", // purple-300\n    \"#9333ea\", // purple-600\n    \"#7c3aed\", // violet-600\n    \"#6d28d9\", // purple-700\n    \"#a78bfa\", // violet-400\n    \"#8338ec\", // electric purple\n    \"#9370db\", // medium purple\n    \"#8a2be2\", // blue violet\n    \"#ba55d3\", // medium orchid\n    \"#da70d6\", // orchid\n    \n    // Oranges and Corals\n    \"#f97316\", // orange\n    \"#fb923c\", // orange-400\n    \"#f59e0b\", // amber\n    \"#fbbf24\", // amber-400\n    \"#fb7185\", // rose-400\n    \"#f87171\", // red-400 (lighter, distinct from status red)\n    \"#fa8b5c\", // coral\n    \"#ff6b35\", // vibrant coral\n    \"#fb5607\", // bright orange\n    \"#c2410c\", // orange-700 (brownish)\n    \"#ff6347\", // tomato\n    \"#ff4500\", // orange red\n    \"#ff8c00\", // dark orange\n    \"#ffa500\", // orange\n    \n    // Pinks and Magentas\n    \"#ec4899\", // pink\n    \"#f43f5e\", // rose\n    \"#f472b6\", // pink-400\n    \"#e879f9\", // fuchsia-400\n    \"#d946ef\", // fuchsia-600\n    \"#c026d3\", // fuchsia-700\n    \"#db2777\", // pink-600\n    \"#ff006e\", // hot pink/magenta\n    \"#ff1493\", // deep pink\n    \"#ff69b4\", // hot pink\n    \n    // Cyans and Teals\n    \"#06b6d4\", // cyan\n    \"#14b8a6\", // teal\n    \"#22d3ee\", // sky\n    \"#2dd4bf\", // teal-400\n    \"#0891b2\", // cyan-600\n    \"#0d9488\", // teal-600\n    \"#5eead4\", // teal-300\n    \"#67e8f9\", // cyan-300\n    \"#00ced1\", // dark turquoise\n    \"#48d1cc\", // medium turquoise\n    \"#40e0d0\", // turquoise\n    \n    // Yellows and Golds\n    \"#eab308\", // yellow\n    \"#facc15\", // yellow-400\n    \"#fde047\", // yellow-300\n    \"#ca8a04\", // yellow-600\n    \"#ffbe0b\", // golden yellow\n    \"#ffd700\", // gold\n    \n    // Limes and Light Greens (distinct from status green #10b981)\n    \"#84cc16\", // lime\n    \"#a3e635\", // lime-400\n    \"#65a30d\", // lime-600\n    \"#bef264\", // lime-300\n    \"#4ade80\", // green-300 (lighter than status green)\n    \"#22c55e\", // green-500 (different shade)\n    \"#06ffa5\", // mint green\n    \"#adff2f\", // green yellow\n    \"#7fff00\", // chartreuse\n    \"#00fa9a\", // medium spring green\n    \n    // Indigos\n    \"#6366f1\", // indigo-500\n    \"#818cf8\", // indigo-400\n    \"#4f46e5\", // indigo-600\n    \"#4338ca\", // indigo-700\n    \n    // Slates and Grays\n    \"#64748b\", // slate-500\n    \"#475569\", // slate-600\n    \"#94a3b8\", // slate-400\n    \"#334155\", // slate-700\n    \"#1e293b\", // slate-800\n    \n    // Browns and Coppers\n    \"#a16207\", // amber-700 (brownish)\n    \"#92400e\", // amber-800\n    \"#78350f\", // amber-900\n    \"#b45309\", // amber-600\n    \n    // Unique Vibrant Colors (different from status colors)\n    \"#3a86ff\", // bright blue (different from status blue #3b82f6)\n  ];\n\n  const handleCreate = async () => {\n    if (!serviceName.trim()) {\n      notify(\"Service name is required\", { type: \"error\" });\n      return;\n    }\n    await create(\"services\", { data: { name: serviceName.trim(), color: serviceColor } });\n    setServiceName(\"\");\n    setServiceColor(\"#3b82f6\");\n    setCreateDialogOpen(false);\n    // Invalidate all services queries to refresh appointment types and other components\n    queryClient.invalidateQueries({\n      predicate: ({ queryKey }) =>\n        Array.isArray(queryKey) && queryKey[0] === \"services\",\n    });\n    refetch();\n    notify(\"Service created successfully\");\n  };\n\n  const handleEditClick = (service: Service) => {\n    setSelectedService(service);\n    setServiceName(service.name);\n    setServiceColor(service.color || \"#3b82f6\");\n    setEditDialogOpen(true);\n  };\n\n  const handleUpdate = async () => {\n    if (!serviceName.trim() || !selectedService) {\n      notify(\"Service name is required\", { type: \"error\" });\n      return;\n    }\n    await update(\"services\", {\n      id: selectedService.id,\n      data: { name: serviceName.trim(), color: serviceColor },\n      previousData: selectedService,\n    });\n    setServiceName(\"\");\n    setServiceColor(\"#3b82f6\");\n    setSelectedService(null);\n    setEditDialogOpen(false);\n    // Invalidate all services queries to refresh appointment types and other components\n    queryClient.invalidateQueries({\n      predicate: ({ queryKey }) =>\n        Array.isArray(queryKey) && queryKey[0] === \"services\",\n    });\n    refetch();\n    notify(\"Service updated successfully\");\n  };\n\n  const handleDeleteClick = (service: Service) => {\n    setServiceToDelete(service);\n    setDeleteDialogOpen(true);\n  };\n\n  const handleDeleteConfirm = async (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (serviceToDelete) {\n      await deleteService(\"services\", { id: serviceToDelete.id });\n      setDeleteDialogOpen(false);\n      setServiceToDelete(null);\n      // Invalidate all services queries to refresh appointment types and other components\n      queryClient.invalidateQueries({\n        predicate: ({ queryKey }) =>\n          Array.isArray(queryKey) && queryKey[0] === \"services\",\n      });\n      refetch();\n      notify(\"Service deleted successfully\");\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex justify-between items-center\">\n          <CardTitle>Services Management</CardTitle>\n          <Button onClick={() => {\n            setServiceName(\"\");\n            setServiceColor(\"#3b82f6\");\n            setCreateDialogOpen(true);\n          }}>\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add Service\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n        ) : services && services.length > 0 ? (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Name</TableHead>\n                <TableHead>Color</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {services.map((service) => (\n                <TableRow key={service.id}>\n                  <TableCell>{service.name}</TableCell>\n                  <TableCell>\n                    <div className=\"flex items-center gap-2\">\n                      <div\n                        className=\"w-6 h-6 rounded-full border-2 border-border\"\n                        style={{ backgroundColor: service.color || \"#3b82f6\" }}\n                      />\n                      <span className=\"text-sm text-muted-foreground\">\n                        {service.color || \"#3b82f6\"}\n                      </span>\n                    </div>\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleEditClick(service)}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleDeleteClick(service)}\n                      >\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            No services found. Create your first service!\n          </div>\n        )}\n\n        {/* Create Service Dialog */}\n        <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Create Service</DialogTitle>\n              <DialogDescription>\n                Add a new service to the system.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"service-name\">Service Name</Label>\n                <Input\n                  id=\"service-name\"\n                  value={serviceName}\n                  onChange={(e) => setServiceName(e.target.value)}\n                  placeholder=\"Enter service name\"\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\") {\n                      e.preventDefault();\n                      handleCreate();\n                    }\n                  }}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Color</Label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {serviceColors.map((color) => (\n                    <button\n                      key={color}\n                      type=\"button\"\n                      onClick={() => setServiceColor(color)}\n                      className={`w-10 h-10 rounded-full border-2 transition-all ${\n                        serviceColor === color\n                          ? \"border-foreground scale-110 ring-2 ring-offset-2 ring-primary\"\n                          : \"border-border hover:scale-105\"\n                      }`}\n                      style={{ backgroundColor: color }}\n                      aria-label={`Select color ${color}`}\n                    />\n                  ))}\n                </div>\n                <div className=\"flex items-center gap-2 mt-2\">\n                  <div\n                    className=\"w-6 h-6 rounded-full border border-border\"\n                    style={{ backgroundColor: serviceColor }}\n                  />\n                  <span className=\"text-sm text-muted-foreground\">{serviceColor}</span>\n                </div>\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button variant=\"outline\" onClick={() => setCreateDialogOpen(false)}>\n                Cancel\n              </Button>\n              <Button onClick={handleCreate}>\n                <Save className=\"h-4 w-4 mr-2\" />\n                Create\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Edit Service Dialog */}\n        <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Edit Service</DialogTitle>\n              <DialogDescription>\n                Update the service name.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-service-name\">Service Name</Label>\n                <Input\n                  id=\"edit-service-name\"\n                  value={serviceName}\n                  onChange={(e) => setServiceName(e.target.value)}\n                  placeholder=\"Enter service name\"\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\") {\n                      e.preventDefault();\n                      handleUpdate();\n                    }\n                  }}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Color</Label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {serviceColors.map((color) => (\n                    <button\n                      key={color}\n                      type=\"button\"\n                      onClick={() => setServiceColor(color)}\n                      className={`w-10 h-10 rounded-full border-2 transition-all ${\n                        serviceColor === color\n                          ? \"border-foreground scale-110 ring-2 ring-offset-2 ring-primary\"\n                          : \"border-border hover:scale-105\"\n                      }`}\n                      style={{ backgroundColor: color }}\n                      aria-label={`Select color ${color}`}\n                    />\n                  ))}\n                </div>\n                <div className=\"flex items-center gap-2 mt-2\">\n                  <div\n                    className=\"w-6 h-6 rounded-full border border-border\"\n                    style={{ backgroundColor: serviceColor }}\n                  />\n                  <span className=\"text-sm text-muted-foreground\">{serviceColor}</span>\n                </div>\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setEditDialogOpen(false);\n                  setSelectedService(null);\n                  setServiceName(\"\");\n                  setServiceColor(\"#3b82f6\");\n                }}\n              >\n                Cancel\n              </Button>\n              <Button onClick={handleUpdate}>\n                <Save className=\"h-4 w-4 mr-2\" />\n                Update\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Delete Service Dialog */}\n        <Confirm\n          isOpen={deleteDialogOpen}\n          loading={false}\n          title=\"Delete Service\"\n          content={`Are you sure you want to delete the service \"${serviceToDelete?.name}\"? This action cannot be undone.`}\n          confirm=\"Delete\"\n          cancel=\"Cancel\"\n          confirmColor=\"warning\"\n          onClose={() => setDeleteDialogOpen(false)}\n          onConfirm={handleDeleteConfirm}\n        />\n      </CardContent>\n    </Card>\n  );\n};\n\n// Users Management Section\nconst UsersManagementSection = () => {\n  const notify = useNotify();\n  const navigate = useNavigate();\n  const { identity } = useGetIdentity();\n  const { data: users, isLoading, refetch } = useGetList<Sale>(\"sales\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"first_name\", order: \"ASC\" },\n  });\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [userToDelete, setUserToDelete] = useState<Sale | null>(null);\n  const [deleteUser] = useDelete();\n\n  const handleDeleteClick = (user: Sale) => {\n    setUserToDelete(user);\n    setDeleteDialogOpen(true);\n  };\n\n  const handleDeleteConfirm = async (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (userToDelete) {\n      await deleteUser(\"sales\", { id: userToDelete.id });\n      setDeleteDialogOpen(false);\n      setUserToDelete(null);\n      refetch();\n      notify(\"User deleted successfully\");\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex justify-between items-center\">\n          <CardTitle>Users Management</CardTitle>\n          <Button onClick={() => navigate(\"/sales/create\")}>\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add User\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n        ) : users && users.length > 0 ? (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Name</TableHead>\n                <TableHead>Email</TableHead>\n                <TableHead>Role</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {users.map((user) => (\n                <TableRow key={user.id}>\n                  <TableCell>\n                    {user.first_name} {user.last_name}\n                  </TableCell>\n                  <TableCell>{user.email}</TableCell>\n                  <TableCell>\n                    {user.administrator ? (\n                      <Badge variant=\"secondary\">Administrator</Badge>\n                    ) : (\n                      <Badge variant=\"outline\">User</Badge>\n                    )}\n                  </TableCell>\n                  <TableCell>\n                    {user.disabled ? (\n                      <Badge variant=\"destructive\">Disabled</Badge>\n                    ) : (\n                      <Badge variant=\"default\">Active</Badge>\n                    )}\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => navigate(`/sales/${user.id}`)}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                      {user.id !== identity?.id && (\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => handleDeleteClick(user)}\n                        >\n                          <Trash2 className=\"h-4 w-4 text-destructive\" />\n                        </Button>\n                      )}\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            No users found. Create your first user!\n          </div>\n        )}\n\n        <Confirm\n          isOpen={deleteDialogOpen}\n          loading={false}\n          title=\"Delete User\"\n          content={`Are you sure you want to delete the user \"${userToDelete?.first_name} ${userToDelete?.last_name}\"? This action cannot be undone.`}\n          confirm=\"Delete\"\n          cancel=\"Cancel\"\n          confirmColor=\"warning\"\n          onClose={() => setDeleteDialogOpen(false)}\n          onConfirm={handleDeleteConfirm}\n        />\n      </CardContent>\n    </Card>\n  );\n};\n\n// General Settings Section\nconst GeneralSettingsSection = () => {\n  const { timezone, setTimezone, offsetLabel, displayName } = useTimezone();\n  const { officeLocation, isLoading: officeLocationLoading, updateOfficeLocation } = useOfficeLocation();\n  const notify = useNotify();\n  const [currentTime, setCurrentTime] = React.useState(new Date());\n  const [isEditingOffice, setIsEditingOffice] = React.useState(false);\n  const [officeFormData, setOfficeFormData] = React.useState({\n    latitude: \"\",\n    longitude: \"\",\n    address: \"\",\n  });\n\n  // Update current time display every second\n  React.useEffect(() => {\n    const interval = setInterval(() => {\n      setCurrentTime(new Date());\n    }, 1000);\n    return () => clearInterval(interval);\n  }, []);\n\n  // Update time display when timezone changes\n  React.useEffect(() => {\n    setCurrentTime(new Date());\n  }, [timezone]);\n\n  const handleTimezoneChange = (newTimezone: string) => {\n    setTimezone(newTimezone);\n    // Show notification briefly before reload\n    notify(\"Timezone updated successfully. Page will refresh...\", { type: \"success\" });\n    // Force a page refresh to update all date/time displays\n    setTimeout(() => {\n      window.location.reload();\n    }, 500);\n  };\n\n  // Initialize office form data when editing\n  React.useEffect(() => {\n    if (isEditingOffice && officeLocation) {\n      setOfficeFormData({\n        latitude: officeLocation.latitude.toString(),\n        longitude: officeLocation.longitude.toString(),\n        address: officeLocation.address,\n      });\n    }\n  }, [isEditingOffice, officeLocation]);\n\n  const handleOfficeLocationSave = async () => {\n    try {\n      const lat = parseFloat(officeFormData.latitude);\n      const lng = parseFloat(officeFormData.longitude);\n\n      if (isNaN(lat) || isNaN(lng)) {\n        notify(\"Please enter valid numeric coordinates\", { type: \"error\" });\n        return;\n      }\n\n      if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {\n        notify(\"Invalid coordinates. Latitude must be -90 to 90, longitude -180 to 180\", { type: \"error\" });\n        return;\n      }\n\n      await updateOfficeLocation({\n        latitude: lat,\n        longitude: lng,\n        address: officeFormData.address || \"Office\",\n      });\n\n      setIsEditingOffice(false);\n    } catch (error) {\n      console.error(\"Error updating office location:\", error);\n    }\n  };\n\n  const handleOfficeLocationCancel = () => {\n    setIsEditingOffice(false);\n    if (officeLocation) {\n      setOfficeFormData({\n        latitude: officeLocation.latitude.toString(),\n        longitude: officeLocation.longitude.toString(),\n        address: officeLocation.address,\n      });\n    }\n  };\n\n  // Common timezones with their display names\n  const timezones = [\n    { value: \"Asia/Dubai\", label: \"Dubai (UTC+4)\", offset: \"UTC+4\" },\n    { value: \"Asia/Kolkata\", label: \"Mumbai/Kolkata (UTC+5:30)\", offset: \"UTC+5:30\" },\n    { value: \"Asia/Singapore\", label: \"Singapore (UTC+8)\", offset: \"UTC+8\" },\n    { value: \"Asia/Tokyo\", label: \"Tokyo (UTC+9)\", offset: \"UTC+9\" },\n    { value: \"Europe/London\", label: \"London (UTC+0/+1)\", offset: \"UTC+0/+1\" },\n    { value: \"Europe/Paris\", label: \"Paris (UTC+1/+2)\", offset: \"UTC+1/+2\" },\n    { value: \"America/New_York\", label: \"New York (UTC-5/-4)\", offset: \"UTC-5/-4\" },\n    { value: \"America/Los_Angeles\", label: \"Los Angeles (UTC-8/-7)\", offset: \"UTC-8/-7\" },\n    { value: \"Australia/Sydney\", label: \"Sydney (UTC+10/+11)\", offset: \"UTC+10/+11\" },\n  ];\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>General Settings</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-6\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"timezone-select\">Application Timezone</Label>\n            <p className=\"text-sm text-muted-foreground\">\n              All dates and times in the application will be displayed in this timezone.\n            </p>\n            <Select value={timezone} onValueChange={handleTimezoneChange}>\n              <SelectTrigger id=\"timezone-select\" className=\"w-full max-w-md\">\n                <SelectValue placeholder=\"Select timezone\" />\n              </SelectTrigger>\n              <SelectContent>\n                {timezones.map((tz) => (\n                  <SelectItem key={tz.value} value={tz.value}>\n                    {tz.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <div className=\"mt-2 text-sm text-muted-foreground\">\n              <p>Current timezone: <strong>{displayName}</strong> ({offsetLabel})</p>\n              <p className=\"mt-1\">Current time: <strong>{formatCrmDateTime(currentTime)}</strong></p>\n            </div>\n          </div>\n\n          {/* Office Location Settings */}\n          <div className=\"space-y-2 border-t pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label htmlFor=\"office-location\">Office Location</Label>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Set your office coordinates for transport routing and map displays.\n                </p>\n              </div>\n              {!isEditingOffice && (\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setIsEditingOffice(true)}\n                  disabled={officeLocationLoading}\n                >\n                  <Pencil className=\"w-4 h-4 mr-2\" />\n                  Edit\n                </Button>\n              )}\n            </div>\n\n            {isEditingOffice ? (\n              <div className=\"space-y-4 mt-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"office-latitude\">Latitude</Label>\n                    <Input\n                      id=\"office-latitude\"\n                      type=\"number\"\n                      step=\"any\"\n                      value={officeFormData.latitude}\n                      onChange={(e) =>\n                        setOfficeFormData({ ...officeFormData, latitude: e.target.value })\n                      }\n                      placeholder=\"25.2048\"\n                    />\n                    <p className=\"text-xs text-muted-foreground\">Range: -90 to 90</p>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"office-longitude\">Longitude</Label>\n                    <Input\n                      id=\"office-longitude\"\n                      type=\"number\"\n                      step=\"any\"\n                      value={officeFormData.longitude}\n                      onChange={(e) =>\n                        setOfficeFormData({ ...officeFormData, longitude: e.target.value })\n                      }\n                      placeholder=\"55.2708\"\n                    />\n                    <p className=\"text-xs text-muted-foreground\">Range: -180 to 180</p>\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"office-address\">Address</Label>\n                  <Input\n                    id=\"office-address\"\n                    type=\"text\"\n                    value={officeFormData.address}\n                    onChange={(e) =>\n                      setOfficeFormData({ ...officeFormData, address: e.target.value })\n                    }\n                    placeholder=\"Office, Dubai, UAE\"\n                  />\n                </div>\n                <div className=\"flex gap-2\">\n                  <Button\n                    type=\"button\"\n                    onClick={handleOfficeLocationSave}\n                    size=\"sm\"\n                  >\n                    <Save className=\"w-4 h-4 mr-2\" />\n                    Save\n                  </Button>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={handleOfficeLocationCancel}\n                    size=\"sm\"\n                  >\n                    <CircleX className=\"w-4 h-4 mr-2\" />\n                    Cancel\n                  </Button>\n                </div>\n              </div>\n            ) : (\n              <div className=\"mt-4 p-4 bg-slate-50 dark:bg-slate-900 rounded-md\">\n                <div className=\"grid grid-cols-3 gap-4 text-sm\">\n                  <div>\n                    <p className=\"text-muted-foreground\">Latitude</p>\n                    <p className=\"font-medium\">{officeLocation?.latitude.toFixed(6)}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-muted-foreground\">Longitude</p>\n                    <p className=\"font-medium\">{officeLocation?.longitude.toFixed(6)}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-muted-foreground\">Address</p>\n                    <p className=\"font-medium\">{officeLocation?.address || \"Not set\"}</p>\n                  </div>\n                </div>\n                {officeLocation && (\n                  <div className=\"mt-3\">\n                    <a\n                      href={`https://www.google.com/maps?q=${officeLocation.latitude},${officeLocation.longitude}`}\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                      className=\"text-sm text-blue-600 dark:text-blue-400 hover:underline\"\n                    >\n                      View on Google Maps \n                    </a>\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nSettingsPage.path = \"/settings\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/settings/PaymentSettingsSection.tsx",
      "content": "import { useState, useEffect } from \"react\";\nimport { useNotify } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Save, Info } from \"lucide-react\";\nimport { usePaymentSettings, type PaymentSetting } from \"@/hooks/usePaymentSettings\";\n\ninterface PaymentSettingFormData {\n  fee_percentage: string;\n  fixed_fee_amount: string;\n  vat_percentage: string;\n}\n\nconst PAYMENT_METHODS: PaymentSetting[\"payment_method\"][] = [\n  \"POS\",\n  \"Payment Link\",\n  \"Ziina\",\n  \"Tabby\",\n  \"Cash\",\n];\n\nexport const PaymentSettingsSection = () => {\n  const notify = useNotify();\n  const { data: settings, isLoading, updateAllSettings } = usePaymentSettings();\n  const [formData, setFormData] = useState<\n    Record<string, PaymentSettingFormData>\n  >({});\n  const [errors, setErrors] = useState<\n    Record<string, Partial<PaymentSettingFormData>>\n  >({});\n  const [isSaving, setIsSaving] = useState(false);\n\n  // Initialize form data when settings are loaded\n  useEffect(() => {\n    if (settings && settings.length > 0) {\n      const initialData: Record<string, PaymentSettingFormData> = {};\n      settings.forEach((setting) => {\n        initialData[setting.payment_method] = {\n          fee_percentage: setting.fee_percentage?.toString() ?? \"\",\n          fixed_fee_amount: setting.fixed_fee_amount?.toString() ?? \"\",\n          vat_percentage: setting.vat_percentage?.toString() ?? \"5\",\n        };\n      });\n      setFormData(initialData);\n    }\n  }, [settings]);\n\n  const validateField = (\n    method: string,\n    field: keyof PaymentSettingFormData,\n    value: string\n  ): string | undefined => {\n    const numValue = parseFloat(value);\n    const isEmpty = value.trim() === \"\";\n\n    if (field === \"fee_percentage\") {\n      if (!isEmpty && (isNaN(numValue) || numValue < 0 || numValue > 100)) {\n        return \"Fee percentage must be between 0 and 100\";\n      }\n    } else if (field === \"fixed_fee_amount\") {\n      if (!isEmpty && (isNaN(numValue) || numValue < 0)) {\n        return \"Fixed fee amount must be 0 or greater\";\n      }\n    } else if (field === \"vat_percentage\") {\n      if (isEmpty || isNaN(numValue) || numValue < 0 || numValue > 100) {\n        return \"VAT percentage must be between 0 and 100\";\n      }\n    }\n\n    return undefined;\n  };\n\n  const handleFieldChange = (\n    method: string,\n    field: keyof PaymentSettingFormData,\n    value: string\n  ) => {\n    // Update form data\n    setFormData((prev) => ({\n      ...prev,\n      [method]: {\n        ...prev[method],\n        [field]: value,\n      },\n    }));\n\n    // Validate and update errors\n    const error = validateField(method, field, value);\n    setErrors((prev) => ({\n      ...prev,\n      [method]: {\n        ...prev[method],\n        [field]: error,\n      },\n    }));\n  };\n\n  const validateAllFields = (): boolean => {\n    const newErrors: Record<string, Partial<PaymentSettingFormData>> = {};\n    let isValid = true;\n\n    PAYMENT_METHODS.forEach((method) => {\n      const data = formData[method];\n      if (!data) return;\n\n      const methodErrors: Partial<PaymentSettingFormData> = {};\n\n      const feeError = validateField(method, \"fee_percentage\", data.fee_percentage);\n      if (feeError) {\n        methodErrors.fee_percentage = feeError;\n        isValid = false;\n      }\n\n      const fixedError = validateField(\n        method,\n        \"fixed_fee_amount\",\n        data.fixed_fee_amount\n      );\n      if (fixedError) {\n        methodErrors.fixed_fee_amount = fixedError;\n        isValid = false;\n      }\n\n      const vatError = validateField(method, \"vat_percentage\", data.vat_percentage);\n      if (vatError) {\n        methodErrors.vat_percentage = vatError;\n        isValid = false;\n      }\n\n      if (Object.keys(methodErrors).length > 0) {\n        newErrors[method] = methodErrors;\n      }\n    });\n\n    setErrors(newErrors);\n    return isValid;\n  };\n\n  const handleSave = async () => {\n    if (!validateAllFields()) {\n      notify(\"Please fix validation errors before saving\", { type: \"error\" });\n      return;\n    }\n\n    setIsSaving(true);\n\n    try {\n      // Prepare updates for all payment methods\n      const updates: Record<PaymentSetting[\"payment_method\"], {\n        fee_percentage: number | null;\n        fixed_fee_amount: number | null;\n        vat_percentage: number;\n      }> = {} as any;\n\n      PAYMENT_METHODS.forEach((method) => {\n        const data = formData[method];\n        if (!data) return;\n\n        updates[method] = {\n          fee_percentage:\n            data.fee_percentage.trim() === \"\"\n              ? null\n              : parseFloat(data.fee_percentage),\n          fixed_fee_amount:\n            data.fixed_fee_amount.trim() === \"\"\n              ? null\n              : parseFloat(data.fixed_fee_amount),\n          vat_percentage: parseFloat(data.vat_percentage),\n        };\n      });\n\n      await updateAllSettings(updates);\n    } catch (error) {\n      console.error(\"Error updating payment settings:\", error);\n      // Error notification is handled by the hook\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardContent className=\"py-8\">\n          <div className=\"text-center text-muted-foreground\">Loading...</div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex justify-between items-center\">\n          <CardTitle>Payment Settings</CardTitle>\n          <Button onClick={handleSave} disabled={isSaving}>\n            <Save className=\"h-4 w-4 mr-2\" />\n            {isSaving ? \"Saving...\" : \"Save Changes\"}\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-6\">\n          <div className=\"bg-muted/50 p-4 rounded-lg\">\n            <div className=\"flex items-start gap-2\">\n              <Info className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\n              <div className=\"text-sm text-muted-foreground\">\n                <p className=\"font-medium mb-1\">Bank Charge Calculation:</p>\n                <p>\n                  Bank charge = (Amount  Fee %) + Fixed Fee, then add VAT on\n                  the total fee.\n                </p>\n                <p className=\"mt-1 text-xs\">\n                  Example: For AED 1,000 with POS (1.9% + 5% VAT): Base fee =\n                  AED 19.00, VAT = AED 0.95, Total = AED 19.95\n                </p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-6\">\n            {PAYMENT_METHODS.map((method) => {\n              const setting = settings?.find((s) => s.payment_method === method);\n              const data = formData[method];\n              const methodErrors = errors[method] || {};\n\n              if (!setting || !data) return null;\n\n              return (\n                <div\n                  key={method}\n                  className=\"border rounded-lg p-4 space-y-4\"\n                >\n                  <div className=\"flex items-center justify-between\">\n                    <h3 className=\"text-lg font-semibold\">{method}</h3>\n                    {method === \"Tabby\" && (\n                      <span className=\"text-xs text-muted-foreground italic\">\n                        Fee structure to be configured once details are provided\n                      </span>\n                    )}\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor={`${method}-fee-percentage`}>\n                        Fee Percentage (%)\n                      </Label>\n                      <Input\n                        id={`${method}-fee-percentage`}\n                        type=\"number\"\n                        step=\"0.01\"\n                        min=\"0\"\n                        max=\"100\"\n                        value={data.fee_percentage}\n                        onChange={(e) =>\n                          handleFieldChange(method, \"fee_percentage\", e.target.value)\n                        }\n                        placeholder=\"0.00\"\n                        className={\n                          methodErrors.fee_percentage ? \"border-destructive\" : \"\"\n                        }\n                      />\n                      {methodErrors.fee_percentage && (\n                        <p className=\"text-sm text-destructive\">\n                          {methodErrors.fee_percentage}\n                        </p>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor={`${method}-fixed-fee`}>\n                        Fixed Fee Amount (AED)\n                      </Label>\n                      <Input\n                        id={`${method}-fixed-fee`}\n                        type=\"number\"\n                        step=\"0.01\"\n                        min=\"0\"\n                        value={data.fixed_fee_amount}\n                        onChange={(e) =>\n                          handleFieldChange(method, \"fixed_fee_amount\", e.target.value)\n                        }\n                        placeholder=\"0.00\"\n                        className={\n                          methodErrors.fixed_fee_amount ? \"border-destructive\" : \"\"\n                        }\n                      />\n                      {methodErrors.fixed_fee_amount && (\n                        <p className=\"text-sm text-destructive\">\n                          {methodErrors.fixed_fee_amount}\n                        </p>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor={`${method}-vat-percentage`}>\n                        VAT Percentage (%)\n                      </Label>\n                      <Input\n                        id={`${method}-vat-percentage`}\n                        type=\"number\"\n                        step=\"0.01\"\n                        min=\"0\"\n                        max=\"100\"\n                        value={data.vat_percentage}\n                        onChange={(e) =>\n                          handleFieldChange(method, \"vat_percentage\", e.target.value)\n                        }\n                        className={\n                          methodErrors.vat_percentage ? \"border-destructive\" : \"\"\n                        }\n                      />\n                      {methodErrors.vat_percentage && (\n                        <p className=\"text-sm text-destructive\">\n                          {methodErrors.vat_percentage}\n                        </p>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/index.ts",
      "content": "import type { Service } from \"../types\";\nimport { ServiceCreate } from \"./ServiceCreate\";\nimport { ServiceEdit } from \"./ServiceEdit\";\nimport { ServiceList } from \"./ServiceList\";\n\nexport default {\n  list: ServiceList,\n  create: ServiceCreate,\n  edit: ServiceEdit,\n  recordRepresentation: (record: Service) => record.name,\n};\n\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/ServiceList.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\nimport { DataTable } from \"@/components/admin/data-table\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\n\nconst filters = [<SearchInput key=\"service-search\" source=\"q\" alwaysOn />];\n\nconst ServiceListActions = () => (\n  <TopToolbar>\n    <ExportButton />\n    <CreateButton label=\"New service\" />\n  </TopToolbar>\n);\n\nexport const ServiceList = () => {\n  return (\n    <List filters={filters} actions={<ServiceListActions />}>\n      <DataTable>\n        <DataTable.Col source=\"name\" label=\"Service\" />\n        <DataTable.Col\n          source=\"created_at\"\n          label=\"Created\"\n          field={DateField}\n          headerClassName=\"text-right\"\n          cellClassName=\"text-right\"\n        />\n      </DataTable>\n    </List>\n  );\n};\n\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/ServiceInputs.tsx",
      "content": "import { required } from \"ra-core\";\nimport { TextInput } from \"@/components/admin/text-input\";\n\nexport const ServiceInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <TextInput\n        source=\"name\"\n        label=\"Service name\"\n        validate={required()}\n        helperText={false}\n      />\n    </div>\n  );\n};\n\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/ServiceEdit.tsx",
      "content": "import { EditBase, Form } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport { ServiceInputs } from \"./ServiceInputs\";\n\nexport const ServiceEdit = () => {\n  return (\n    <EditBase redirect=\"list\">\n      <div className=\"max-w-lg w-full mx-auto mt-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Edit service</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Form className=\"flex flex-col gap-4\">\n              <ServiceInputs />\n              <FormToolbar>\n                <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n                  <DeleteButton redirect=\"list\" />\n                  <div className=\"flex flex-row gap-2 justify-end\">\n                    <CancelButton />\n                    <SaveButton />\n                  </div>\n                </div>\n              </FormToolbar>\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </EditBase>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/ServiceCreate.tsx",
      "content": "import { CreateBase, Form } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport { ServiceInputs } from \"./ServiceInputs\";\n\nexport const ServiceCreate = () => {\n  return (\n    <CreateBase redirect=\"list\">\n      <div className=\"max-w-lg w-full mx-auto mt-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Create service</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Form className=\"flex flex-col gap-4\">\n              <ServiceInputs />\n              <FormToolbar />\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </CreateBase>\n  );\n};\n\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/index.ts",
      "content": "import type { Sale } from \"../types\";\nimport { SalesCreate } from \"./SalesCreate\";\nimport { SalesEdit } from \"./SalesEdit\";\nimport { SalesList } from \"./SalesList\";\n\nexport default {\n  list: SalesList,\n  create: SalesCreate,\n  edit: SalesEdit,\n  recordRepresentation: (record: Sale) =>\n    `${record.first_name} ${record.last_name}`,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesList.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { DataTable } from \"@/components/admin/data-table\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\n\nimport { TopToolbar } from \"../layout/TopToolbar\";\n\nconst SalesListActions = () => (\n  <TopToolbar>\n    <ExportButton />\n    <CreateButton label=\"New user\" />\n  </TopToolbar>\n);\n\nconst filters = [<SearchInput source=\"q\" alwaysOn />];\n\nconst OptionsField = (_props: { label?: string | boolean }) => {\n  const record = useRecordContext();\n  if (!record) return null;\n  return (\n    <div className=\"flex flex-row gap-1\">\n      {record.administrator && (\n        <Badge\n          variant=\"outline\"\n          className=\"border-blue-300 dark:border-blue-700\"\n        >\n          Admin\n        </Badge>\n      )}\n      {record.disabled && (\n        <Badge\n          variant=\"outline\"\n          className=\"border-orange-300 dark:border-orange-700\"\n        >\n          Disabled\n        </Badge>\n      )}\n    </div>\n  );\n};\n\nexport function SalesList() {\n  return (\n    <List\n      filters={filters}\n      actions={<SalesListActions />}\n      sort={{ field: \"first_name\", order: \"ASC\" }}\n    >\n      <DataTable>\n        <DataTable.Col source=\"first_name\" />\n        <DataTable.Col source=\"last_name\" />\n        <DataTable.Col source=\"email\" />\n        <DataTable.Col label={false}>\n          <OptionsField />\n        </DataTable.Col>\n      </DataTable>\n    </List>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesInputs.tsx",
      "content": "import { email, required, useGetIdentity, useRecordContext } from \"ra-core\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\n\nimport type { Sale } from \"../types\";\n\nexport function SalesInputs({ showPassword = false }: { showPassword?: boolean }) {\n  const { identity } = useGetIdentity();\n  const record = useRecordContext<Sale>();\n  return (\n    <div className=\"space-y-4 w-full\">\n      <TextInput source=\"first_name\" validate={required()} helperText={false} />\n      <TextInput source=\"last_name\" validate={required()} helperText={false} />\n      <TextInput\n        source=\"email\"\n        validate={[required(), email()]}\n        helperText={false}\n      />\n      {showPassword && (\n        <TextInput\n          source=\"password\"\n          type=\"password\"\n          helperText=\"Optional. If blank, the user will receive an email to set their password.\"\n        />\n      )}\n      <BooleanInput\n        source=\"administrator\"\n        readOnly={record?.id === identity?.id}\n        helperText={false}\n      />\n      <BooleanInput\n        source=\"disabled\"\n        readOnly={record?.id === identity?.id}\n        helperText={false}\n      />\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesEdit.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport {\n  useDataProvider,\n  useEditController,\n  useNotify,\n  useRecordContext,\n  useRedirect,\n} from \"ra-core\";\nimport type { SubmitHandler } from \"react-hook-form\";\nimport { SimpleForm } from \"@/components/admin/simple-form\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport type { Sale, SalesFormData } from \"../types\";\nimport { SalesInputs } from \"./SalesInputs\";\n\nfunction EditToolbar() {\n  return (\n    <div className=\"flex justify-end gap-4\">\n      <CancelButton />\n      <SaveButton />\n    </div>\n  );\n}\n\nexport function SalesEdit() {\n  const { record } = useEditController();\n\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n\n  const { mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      if (!record) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.salesUpdate(record.id, data);\n    },\n    onSuccess: () => {\n      redirect(\"/sales\");\n      notify(\"User updated successfully\");\n    },\n    onError: () => {\n      notify(\"An error occurred. Please try again.\");\n    },\n  });\n\n  const onSubmit: SubmitHandler<SalesFormData> = async (data) => {\n    mutate(data);\n  };\n\n  return (\n    <div className=\"max-w-lg w-full mx-auto mt-8\">\n      <Card>\n        <CardContent>\n          <SimpleForm\n            toolbar={<EditToolbar />}\n            onSubmit={onSubmit as SubmitHandler<any>}\n            record={record}\n          >\n            <SaleEditTitle />\n            <SalesInputs />\n          </SimpleForm>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nconst SaleEditTitle = () => {\n  const record = useRecordContext<Sale>();\n  if (!record) return null;\n  return (\n    <h2 className=\"text-lg font-semibold mb-4\">\n      Edit {record?.first_name} {record?.last_name}\n    </h2>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesCreate.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport { useDataProvider, useNotify, useRedirect } from \"ra-core\";\nimport type { SubmitHandler } from \"react-hook-form\";\nimport { SimpleForm } from \"@/components/admin/simple-form\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport type { SalesFormData } from \"../types\";\nimport { SalesInputs } from \"./SalesInputs\";\n\nexport function SalesCreate() {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n\n  const { mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      return dataProvider.salesCreate(data);\n    },\n    onSuccess: (_data, variables) => {\n      const passwordProvided =\n        typeof variables?.password === \"string\" &&\n        variables.password.trim().length > 0;\n      notify(\n        passwordProvided\n          ? \"User created. Password was set.\"\n          : \"User created. They will soon receive an email to set their password.\",\n      );\n      redirect(\"/sales\");\n    },\n    onError: () => {\n      notify(\"An error occurred while creating the user.\", {\n        type: \"error\",\n      });\n    },\n  });\n  const onSubmit: SubmitHandler<SalesFormData> = async (data) => {\n    mutate(data);\n  };\n\n  return (\n    <div className=\"max-w-lg w-full mx-auto mt-8\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Create a new user</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <SimpleForm onSubmit={onSubmit as SubmitHandler<any>}>\n            <SalesInputs showPassword />\n          </SimpleForm>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SaleName.tsx",
      "content": "import { useGetIdentity, useRecordContext } from \"ra-core\";\n\nimport type { Sale } from \"../types\";\n\nexport const SaleName = ({ sale }: { sale?: Sale }) => {\n  const { identity, isPending } = useGetIdentity();\n  const saleFromContext = useRecordContext<Sale>();\n  const finalSale = sale || saleFromContext;\n  if (isPending || !finalSale) return null;\n  return finalSale.id === identity?.id\n    ? \"You\"\n    : `${finalSale.first_name} ${finalSale.last_name}`;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/i18nProvider.tsx",
      "content": "import { mergeTranslations } from \"ra-core\";\nimport polyglotI18nProvider from \"ra-i18n-polyglot\";\nimport englishMessages from \"ra-language-english\";\nimport { raSupabaseEnglishMessages } from \"ra-supabase-language-english\";\n\nconst raSupabaseEnglishMessagesOverride = {\n  \"ra-supabase\": {\n    auth: {\n      password_reset: \"Check your emails for a Reset Password message.\",\n    },\n  },\n};\n\nexport const i18nProvider = polyglotI18nProvider(\n  () => {\n    return mergeTranslations(\n      englishMessages,\n      raSupabaseEnglishMessages,\n      raSupabaseEnglishMessagesOverride,\n    );\n  },\n  \"en\",\n  [{ locale: \"en\", name: \"English\" }],\n  { allowMissing: true },\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/defaultConfiguration.ts",
      "content": "import { Mars, NonBinary, Venus } from \"lucide-react\";\n\nexport const defaultDarkModeLogo = \"./logos/logo_bestdoc_crm_dark.svg\";\nexport const defaultLightModeLogo = \"./logos/logo_bestdoc_crm_light.svg\";\n\nexport const defaultTitle = \"BestDOC Tasks\";\n\nexport const defaultCompanySectors = [\n  \"Communication Services\",\n  \"Consumer Discretionary\",\n  \"Consumer Staples\",\n  \"Energy\",\n  \"Financials\",\n  \"Health Care\",\n  \"Industrials\",\n  \"Information Technology\",\n  \"Materials\",\n  \"Real Estate\",\n  \"Utilities\",\n];\n\nexport const defaultDealStages = [\n  { value: \"opportunity\", label: \"Opportunity\" },\n  { value: \"proposal-sent\", label: \"Proposal Sent\" },\n  { value: \"in-negociation\", label: \"In Negotiation\" },\n  { value: \"won\", label: \"Won\" },\n  { value: \"lost\", label: \"Lost\" },\n  { value: \"delayed\", label: \"Delayed\" },\n];\n\nexport const defaultDealPipelineStatuses = [\"won\"];\n\nexport const defaultDealCategories = [\n  \"Other\",\n  \"Copywriting\",\n  \"Print project\",\n  \"UI Design\",\n  \"Website design\",\n];\n\nexport const defaultNoteStatuses = [\n  { value: \"cold\", label: \"Cold\", color: \"#7dbde8\" },\n  { value: \"warm\", label: \"Warm\", color: \"#e8cb7d\" },\n  { value: \"hot\", label: \"Hot\", color: \"#e88b7d\" },\n  { value: \"in-contract\", label: \"In Contract\", color: \"#a4e87d\" },\n];\n\nexport const defaultTaskTypes = [\n  \"None\",\n  \"Email\",\n  \"Demo\",\n  \"Lunch\",\n  \"Meeting\",\n  \"Follow-up\",\n  \"Thank you\",\n  \"Ship\",\n  \"Call\",\n];\n\nexport const defaultContactGender = [\n  { value: \"male\", label: \"Male\", icon: Mars },\n  { value: \"female\", label: \"Female\", icon: Venus },\n  { value: \"nonbinary\", label: \"Non-binary\", icon: NonBinary },\n];\n\nexport const defaultServices = [\n  \"Doctor on Call\",\n  \"Teleconsultation\",\n  \"Physiotherapy\",\n  \"Nurse on Call\",\n  \"Blood Test\",\n  \"IV Therapy\",\n  \"Nanny\",\n  \"Elderly Care\",\n];\n\nexport const defaultLeadStages = [\n  { value: \"new\", label: \"New\" },\n  { value: \"contacted\", label: \"Contacted\" },\n  { value: \"quoted\", label: \"Quoted\" },\n  { value: \"qualified\", label: \"Qualified\" },\n  { value: \"not-qualified\", label: \"Not Qualified\" },\n  { value: \"converted\", label: \"Converted\" },\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/ConfigurationContext.tsx",
      "content": "import { createContext, useContext, type ReactNode } from \"react\";\n\nimport type { ContactGender, DealStage, NoteStatus } from \"../types\";\nimport {\n  defaultCompanySectors,\n  defaultContactGender,\n  defaultDarkModeLogo,\n  defaultDealCategories,\n  defaultDealPipelineStatuses,\n  defaultDealStages,\n  defaultLightModeLogo,\n  defaultNoteStatuses,\n  defaultTaskTypes,\n  defaultTitle,\n  defaultServices,\n  defaultLeadStages,\n} from \"./defaultConfiguration\";\n\n// Define types for the context value\nexport interface ConfigurationContextValue {\n  companySectors: string[];\n  dealCategories: string[];\n  dealPipelineStatuses: string[];\n  dealStages: DealStage[];\n  leadStages: DealStage[];\n  noteStatuses: NoteStatus[];\n  taskTypes: string[];\n  title: string;\n  darkModeLogo: string;\n  lightModeLogo: string;\n  contactGender: ContactGender[];\n  services: string[];\n}\n\nexport interface ConfigurationProviderProps extends ConfigurationContextValue {\n  children: ReactNode;\n}\n\n// Create context with default value\nexport const ConfigurationContext = createContext<ConfigurationContextValue>({\n  companySectors: defaultCompanySectors,\n  dealCategories: defaultDealCategories,\n  dealPipelineStatuses: defaultDealPipelineStatuses,\n  dealStages: defaultDealStages,\n  leadStages: defaultLeadStages,\n  noteStatuses: defaultNoteStatuses,\n  taskTypes: defaultTaskTypes,\n  title: defaultTitle,\n  darkModeLogo: defaultDarkModeLogo,\n  lightModeLogo: defaultLightModeLogo,\n  contactGender: defaultContactGender,\n  services: defaultServices,\n});\n\nexport const ConfigurationProvider = ({\n  children,\n  companySectors,\n  dealCategories,\n  dealPipelineStatuses,\n  dealStages,\n  leadStages,\n  darkModeLogo,\n  lightModeLogo,\n  noteStatuses,\n  taskTypes,\n  title,\n  contactGender,\n  services,\n}: ConfigurationProviderProps) => (\n  <ConfigurationContext.Provider\n    value={{\n      companySectors,\n      dealCategories,\n      dealPipelineStatuses,\n      dealStages,\n      leadStages,\n      darkModeLogo,\n      lightModeLogo,\n      noteStatuses,\n      title,\n      taskTypes,\n      contactGender,\n      services,\n    }}\n  >\n    {children}\n  </ConfigurationContext.Provider>\n);\n\nexport const useConfigurationContext = () => useContext(ConfigurationContext);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/CRM.tsx",
      "content": "import {\n  CustomRoutes,\n  localStorageStore,\n  Resource,\n  type AuthProvider,\n  type DataProvider,\n} from \"ra-core\";\nimport { useEffect } from \"react\";\nimport { Route } from \"react-router\";\nimport { Admin } from \"@/components/admin/admin\";\nimport { ForgotPasswordPage } from \"@/components/supabase/forgot-password-page\";\nimport { SetPasswordPage } from \"@/components/supabase/set-password-page\";\n\nimport contacts from \"../contacts\";\nimport clients from \"../clients\";\nimport { Dashboard } from \"../dashboard/Dashboard\";\nimport deals from \"../deals\";\nimport { Layout } from \"../layout/Layout\";\nimport { SignupPage } from \"../login/SignupPage\";\nimport {\n  authProvider as defaultAuthProvider,\n  dataProvider as defaultDataProvider,\n} from \"../providers/supabase\";\nimport sales from \"../sales\";\nimport servicesResource from \"../services\";\nimport staff from \"../staff\";\nimport { NotesPage } from \"../notes/NotesPage\";\nimport { SettingsPage } from \"../settings/SettingsPage\";\nimport { TasksPage } from \"../tasks/TasksPage\";\nimport { AppointmentsPage } from \"../appointments/AppointmentsPage\";\nimport { BugReportPage } from \"../bug-reports/BugReportPage\";\nimport bugReports from \"../bug-reports\";\nimport paymentPackages, { paymentTransactions } from \"../payments\";\nimport type { ConfigurationContextValue } from \"./ConfigurationContext\";\nimport { ConfigurationProvider } from \"./ConfigurationContext\";\nimport {\n  defaultCompanySectors,\n  defaultContactGender,\n  defaultDarkModeLogo,\n  defaultDealCategories,\n  defaultDealPipelineStatuses,\n  defaultDealStages,\n  defaultLightModeLogo,\n  defaultNoteStatuses,\n  defaultTaskTypes,\n  defaultTitle,\n  defaultServices,\n  defaultLeadStages,\n} from \"./defaultConfiguration\";\nimport { i18nProvider } from \"./i18nProvider\";\nimport { StartPage } from \"../login/StartPage.tsx\";\n\nexport type CRMProps = {\n  dataProvider?: DataProvider;\n  authProvider?: AuthProvider;\n  disableTelemetry?: boolean;\n} & Partial<ConfigurationContextValue>;\n\n/**\n * CRM Component\n *\n * This component sets up and renders the main CRM application using `ra-core`. It provides\n * default configurations and themes but allows for customization through props. The component\n * wraps the application with a `ConfigurationProvider` to provide configuration values via context.\n *\n * @param {Array<ContactGender>} contactGender - The gender options for contacts used in the application.\n * @param {string[]} companySectors - The list of company sectors used in the application.\n * @param {RaThemeOptions} darkTheme - The theme to use when the application is in dark mode.\n * @param {string[]} dealCategories - The categories of deals used in the application.\n * @param {string[]} dealPipelineStatuses - The statuses of deals in the pipeline used in the application.\n * @param {DealStage[]} dealStages - The stages of deals used in the application.\n * @param {RaThemeOptions} lightTheme - The theme to use when the application is in light mode.\n * @param {string} logo - The logo used in the CRM application.\n * @param {NoteStatus[]} noteStatuses - The statuses of notes used in the application.\n * @param {string[]} taskTypes - The types of tasks used in the application.\n * @param {string} title - The title of the CRM application.\n *\n * @returns {JSX.Element} The rendered CRM application.\n *\n * @example\n * // Basic usage of the CRM component\n * import { CRM } from '@/components/atomic-crm/dashboard/CRM';\n *\n * const App = () => (\n *     <CRM\n *         logo=\"/path/to/logo.png\"\n *         title=\"My Custom CRM\"\n *         lightTheme={{\n *             ...defaultTheme,\n *             palette: {\n *                 primary: { main: '#0000ff' },\n *             },\n *         }}\n *     />\n * );\n *\n * export default App;\n */\nexport const CRM = ({\n  contactGender = defaultContactGender,\n  companySectors = defaultCompanySectors,\n  dealCategories = defaultDealCategories,\n  dealPipelineStatuses = defaultDealPipelineStatuses,\n  dealStages = defaultDealStages,\n  leadStages = defaultLeadStages,\n  darkModeLogo = defaultDarkModeLogo,\n  lightModeLogo = defaultLightModeLogo,\n  noteStatuses = defaultNoteStatuses,\n  taskTypes = defaultTaskTypes,\n  title = defaultTitle,\n  services = defaultServices,\n  dataProvider = defaultDataProvider,\n  authProvider = defaultAuthProvider,\n  disableTelemetry,\n  ...rest\n}: CRMProps) => {\n  useEffect(() => {\n    if (\n      disableTelemetry ||\n      process.env.NODE_ENV !== \"production\" ||\n      typeof window === \"undefined\" ||\n      typeof window.location === \"undefined\" ||\n      typeof Image === \"undefined\"\n    ) {\n      return;\n    }\n    const img = new Image();\n    img.src = `https://atomic-crm-telemetry.marmelab.com/atomic-crm-telemetry?domain=${window.location.hostname}`;\n  }, [disableTelemetry]);\n\n  return (\n    <ConfigurationProvider\n      contactGender={contactGender}\n      companySectors={companySectors}\n      dealCategories={dealCategories}\n      dealPipelineStatuses={dealPipelineStatuses}\n      dealStages={dealStages}\n      leadStages={leadStages}\n      darkModeLogo={darkModeLogo}\n      lightModeLogo={lightModeLogo}\n      noteStatuses={noteStatuses}\n      taskTypes={taskTypes}\n      title={title}\n      services={services}\n    >\n      <Admin\n        dataProvider={dataProvider}\n        authProvider={authProvider}\n        store={localStorageStore(undefined, \"CRM\")}\n        layout={Layout}\n        loginPage={StartPage}\n        i18nProvider={i18nProvider}\n        dashboard={Dashboard}\n        requireAuth\n        disableTelemetry\n        {...rest}\n      >\n        <CustomRoutes noLayout>\n          <Route path={SignupPage.path} element={<SignupPage />} />\n          <Route path={SetPasswordPage.path} element={<SetPasswordPage />} />\n          <Route\n            path={ForgotPasswordPage.path}\n            element={<ForgotPasswordPage />}\n          />\n        </CustomRoutes>\n\n        <CustomRoutes>\n          <Route path={SettingsPage.path} element={<SettingsPage />} />\n          <Route path={TasksPage.path} element={<TasksPage />} />\n          <Route path={NotesPage.path} element={<NotesPage />} />\n          <Route path={AppointmentsPage.path} element={<AppointmentsPage />} />\n          <Route path={BugReportPage.path} element={<BugReportPage />} />\n        </CustomRoutes>\n        <Resource name=\"lead-journey\" options={{ label: \"Lead Journey\" }} {...deals} />\n        <Resource name=\"contacts\" options={{ label: \"Leads\" }} {...contacts} />\n        <Resource name=\"clients\" options={{ label: \"Clients\" }} {...clients} />\n        <Resource name=\"contactNotes\" />\n        <Resource name=\"dealNotes\" />\n        <Resource name=\"tasks\" />\n        <Resource name=\"quotes\" />\n        <Resource name=\"sales\" {...sales} />\n        <Resource name=\"services\" {...servicesResource} />\n        <Resource name=\"staff\" options={{ label: \"Staff\" }} {...staff} />\n        <Resource name=\"tags\" />\n        <Resource name=\"payment_packages\" options={{ label: \"Payment Packages\" }} {...paymentPackages} />\n        <Resource name=\"payment_transactions\" options={{ label: \"Payment Transactions\" }} {...paymentTransactions} />\n        <Resource name=\"bug_reports\" options={{ label: \"Bug Reports\" }} {...bugReports} />\n      </Admin>\n    </ConfigurationProvider>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/index.ts",
      "content": "export { AddQuote } from \"./AddQuote\";\nexport { QuoteItem } from \"./QuoteItem\";\nexport { QuotesIterator } from \"./QuotesIterator\";\nexport { QuoteEdit } from \"./QuoteEdit\";\n\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/QuotesIterator.tsx",
      "content": "import { useListContext } from \"ra-core\";\nimport { FileText } from \"lucide-react\";\n\nimport { QuoteItem } from \"./QuoteItem\";\n\nexport const QuotesIterator = () => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error) return null;\n\n  if (!data || data.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n        <FileText className=\"w-12 h-12 text-muted-foreground mb-4 opacity-50\" />\n        <p className=\"text-sm text-muted-foreground\">No quotes yet</p>\n        <p className=\"text-xs text-muted-foreground mt-1\">Create your first quote to get started</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-2\">\n      {data.map((quote) => (\n        <QuoteItem quote={quote} key={quote.id} />\n      ))}\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/QuoteItem.tsx",
      "content": "import { MoreVertical, Edit, Trash2, FileText } from \"lucide-react\";\nimport { useDeleteWithUndoController, useNotify } from \"ra-core\";\nimport { useState } from \"react\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { NumberField } from \"@/components/admin/number-field\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardHeader } from \"@/components/ui/card\";\n\nimport type { Quote } from \"../types\";\nimport { QuoteEdit } from \"./QuoteEdit\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\n\nconst statusColors = {\n  Draft: \"secondary\",\n  Sent: \"default\",\n  Accepted: \"default\",\n  Rejected: \"destructive\",\n} as const;\n\nexport const QuoteItem = ({ quote }: { quote: Quote }) => {\n  const notify = useNotify();\n  const [openEdit, setOpenEdit] = useState(false);\n\n  const { handleDelete } = useDeleteWithUndoController({\n    resource: \"quotes\",\n    record: quote,\n    redirect: false,\n    mutationOptions: {\n      onSuccess() {\n        notify(\"Quote deleted successfully\", { undoable: true });\n      },\n    },\n  });\n\n  const handleEdit = () => {\n    setOpenEdit(true);\n  };\n\n  const handleCloseEdit = () => {\n    setOpenEdit(false);\n  };\n\n  return (\n    <>\n      <Card className=\"hover:shadow-md transition-shadow py-3\">\n        <CardHeader className=\"pb-2 px-4 pt-0\">\n          <div className=\"flex items-start justify-between gap-3\">\n            <div className=\"flex items-start gap-2.5 flex-1 min-w-0\">\n              <div className=\"flex items-center justify-center w-8 h-8 rounded-md bg-primary/10 text-primary flex-shrink-0\">\n                <FileText className=\"w-4 h-4\" />\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-2 flex-wrap mb-1\">\n                  <ReferenceField\n                    source=\"service_id\"\n                    reference=\"services\"\n                    record={quote}\n                    link={false}\n                  >\n                    <TextField source=\"name\" className=\"font-semibold text-sm\" />\n                  </ReferenceField>\n                  <Badge variant={statusColors[quote.status] as any} className=\"text-xs\">\n                    {quote.status}\n                  </Badge>\n                </div>\n                {quote.description && (\n                  <div className=\"text-xs text-muted-foreground line-clamp-2 mb-1.5\">\n                    {quote.description}\n                  </div>\n                )}\n                <div className=\"text-base font-semibold text-primary\">\n                  <NumberField\n                    source=\"amount\"\n                    record={quote}\n                    options={{\n                      style: \"currency\",\n                      currency: \"AED\",\n                      minimumFractionDigits: 2,\n                    }}\n                  />\n                </div>\n              </div>\n            </div>\n            <span className=\"text-xs text-muted-foreground whitespace-nowrap mt-1\">\n              <RelativeDate\n                date={\n                  (quote as any).created_at ??\n                  quote.updated_at ??\n                  quote.date ??\n                  quote.sent_at ??\n                  quote.updated_at\n                }\n                mode=\"local\"\n              />\n            </span>\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-7 w-7 p-0 cursor-pointer\"\n                >\n                  <MoreVertical className=\"h-3.5 w-3.5\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem onClick={handleEdit} className=\"cursor-pointer\">\n                  <Edit className=\"mr-2 h-4 w-4\" />\n                  Edit\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={handleDelete}\n                  className=\"cursor-pointer text-destructive\"\n                >\n                  <Trash2 className=\"mr-2 h-4 w-4\" />\n                  Delete\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </CardHeader>\n      </Card>\n      {openEdit && (\n        <QuoteEdit quote={quote} open={openEdit} onClose={handleCloseEdit} />\n      )}\n    </>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/QuoteEdit.tsx",
      "content": "import {\n  EditBase,\n  Form,\n  useNotify,\n  useUpdate,\n} from \"ra-core\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { NumberInput } from \"@/components/admin/number-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { required } from \"ra-core\";\n\nimport type { Quote } from \"../types\";\n\nconst quoteStatuses = [\n  { id: \"Draft\", name: \"Draft\" },\n  { id: \"Sent\", name: \"Sent\" },\n  { id: \"Accepted\", name: \"Accepted\" },\n  { id: \"Rejected\", name: \"Rejected\" },\n];\n\nexport const QuoteEdit = ({\n  quote,\n  open,\n  onClose,\n}: {\n  quote: Quote;\n  open: boolean;\n  onClose: () => void;\n}) => {\n  const notify = useNotify();\n\n  const handleSuccess = () => {\n    notify(\"Quote updated\");\n    onClose();\n  };\n\n  return (\n    <EditBase\n      resource=\"quotes\"\n      id={quote.id}\n      mutationOptions={{ onSuccess: handleSuccess }}\n    >\n      <Dialog open={open} onOpenChange={(open) => !open && onClose()}>\n        <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n          <Form className=\"flex flex-col gap-4\">\n            <DialogHeader>\n              <DialogTitle>Edit Quote</DialogTitle>\n              <DialogDescription className=\"sr-only\">\n                Edit quote details including service type, status, description, and amount.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"flex flex-col gap-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <ReferenceInput\n                  source=\"service_id\"\n                  reference=\"services\"\n                >\n                  <AutocompleteInput\n                    label=\"Service Type\"\n                    optionText=\"name\"\n                    helperText={false}\n                    validate={required()}\n                  />\n                </ReferenceInput>\n                <SelectInput\n                  source=\"status\"\n                  choices={quoteStatuses}\n                  helperText={false}\n                />\n              </div>\n              <TextInput\n                source=\"description\"\n                label=\"Description\"\n                multiline\n                rows={4}\n                helperText={false}\n                placeholder=\"Describe the service details...\"\n              />\n              <NumberInput\n                source=\"amount\"\n                label=\"Amount\"\n                helperText={false}\n                validate={required()}\n              />\n            </div>\n            <DialogFooter className=\"w-full justify-end\">\n              <Button variant=\"outline\" onClick={onClose} type=\"button\">\n                Cancel\n              </Button>\n              <SaveButton label=\"Update Quote\" />\n            </DialogFooter>\n          </Form>\n        </DialogContent>\n      </Dialog>\n    </EditBase>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/AddQuote.tsx",
      "content": "import { Plus } from \"lucide-react\";\nimport {\n  CreateBase,\n  Form,\n  useGetIdentity,\n  useNotify,\n  useRecordContext,\n  useUpdate,\n  useRefresh,\n} from \"ra-core\";\nimport { useState } from \"react\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { NumberInput } from \"@/components/admin/number-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { required } from \"ra-core\";\n\nimport type { Quote } from \"../types\";\n\nconst quoteStatuses = [\n  { id: \"Draft\", name: \"Draft\" },\n  { id: \"Sent\", name: \"Sent\" },\n  { id: \"Accepted\", name: \"Accepted\" },\n  { id: \"Rejected\", name: \"Rejected\" },\n];\n\nexport const AddQuote = () => {\n  const { identity } = useGetIdentity();\n  const contact = useRecordContext();\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n  const [open, setOpen] = useState(false);\n\n  const handleOpen = () => {\n    setOpen(true);\n  };\n\n  const handleSuccess = async (data: Quote) => {\n    setOpen(false);\n    if (contact?.id) {\n      await update(\"contacts\", {\n        id: contact.id,\n        data: { last_seen: new Date().toISOString() },\n        previousData: contact,\n      });\n    }\n    notify(\"Quote added\");\n    refresh();\n  };\n\n  if (!identity || !contact) return null;\n\n  return (\n    <>\n      <div className=\"my-2\">\n        <Button\n          variant=\"outline\"\n          className=\"h-6 cursor-pointer\"\n          onClick={handleOpen}\n          size=\"sm\"\n        >\n          <Plus className=\"w-4 h-4\" />\n          Add quote\n        </Button>\n      </div>\n\n      <CreateBase\n        resource=\"quotes\"\n        record={{\n          contact_id: contact.id,\n          amount: 0,\n          status: \"Draft\",\n          sales_id: identity.id,\n        }}\n        mutationOptions={{ onSuccess: handleSuccess }}\n      >\n        <Dialog open={open} onOpenChange={(open) => !open && setOpen(false)}>\n          <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n            <Form className=\"flex flex-col gap-4\">\n              <DialogHeader>\n                <DialogTitle>Create New Quote</DialogTitle>\n                <DialogDescription className=\"sr-only\">\n                  Create a new quote with service type, status, description, and amount.\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"flex flex-col gap-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <ReferenceInput\n                    source=\"service_id\"\n                    reference=\"services\"\n                  >\n                    <AutocompleteInput\n                      label=\"Service Type\"\n                      optionText=\"name\"\n                      helperText={false}\n                      validate={required()}\n                    />\n                  </ReferenceInput>\n                  <SelectInput\n                    source=\"status\"\n                    choices={quoteStatuses}\n                    helperText={false}\n                    defaultValue=\"Draft\"\n                  />\n                </div>\n                <TextInput\n                  source=\"description\"\n                  label=\"Description\"\n                  multiline\n                  rows={4}\n                  helperText={false}\n                  placeholder=\"Describe the service details...\"\n                />\n                <NumberInput\n                  source=\"amount\"\n                  label=\"Amount\"\n                  helperText={false}\n                  defaultValue={0}\n                  validate={required()}\n                />\n              </div>\n              <DialogFooter className=\"w-full justify-end\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setOpen(false)}\n                  type=\"button\"\n                >\n                  Cancel\n                </Button>\n                <SaveButton label=\"Create Quote\" />\n              </DialogFooter>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </CreateBase>\n    </>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/types.ts",
      "content": "export type { CrmDataProvider } from \"./supabase/dataProvider\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/supabase.ts",
      "content": "import { createClient } from \"@supabase/supabase-js\";\n\nexport const supabase = createClient(\n  import.meta.env.VITE_SUPABASE_URL,\n  import.meta.env.VITE_SUPABASE_ANON_KEY,\n  {\n    auth: {\n      persistSession: true,\n      autoRefreshToken: true,\n      detectSessionInUrl: true,\n      storage: typeof window !== \"undefined\" ? window.localStorage : undefined,\n    },\n  },\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/index.ts",
      "content": "export { authProvider } from \"./authProvider\";\nexport { dataProvider } from \"./dataProvider\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/dataProvider.ts",
      "content": "import { supabaseDataProvider } from \"ra-supabase-core\";\nimport {\n  withLifecycleCallbacks,\n  type CreateParams,\n  type DataProvider,\n  type GetListParams,\n  type Identifier,\n  type UpdateParams,\n} from \"ra-core\";\n\nimport type {\n  Contact,\n  ContactNote,\n  Deal,\n  DealNote,\n  RAFile,\n  Sale,\n  SalesFormData,\n  SignUpData,\n} from \"../../types\";\nimport { getActivityLog } from \"../commons/activity\";\nimport { getCompanyAvatar } from \"../commons/getCompanyAvatar\";\nimport { getContactAvatar } from \"../commons/getContactAvatar\";\nimport { mergeContacts } from \"../commons/mergeContacts\";\nimport { getIsInitialized } from \"./authProvider\";\nimport { supabase } from \"./supabase\";\nimport { logger } from \"@/lib/logger\";\n\nif (import.meta.env.VITE_SUPABASE_URL === undefined) {\n  throw new Error(\"Please set the VITE_SUPABASE_URL environment variable\");\n}\nif (import.meta.env.VITE_SUPABASE_ANON_KEY === undefined) {\n  throw new Error(\"Please set the VITE_SUPABASE_ANON_KEY environment variable\");\n}\n\nconst baseDataProvider = supabaseDataProvider({\n  instanceUrl: import.meta.env.VITE_SUPABASE_URL,\n  apiKey: import.meta.env.VITE_SUPABASE_ANON_KEY,\n  supabaseClient: supabase,\n  sortOrder: \"asc,desc.nullslast\" as any,\n});\n\nconst processCompanyLogo = async (params: CreateParams<Company> | UpdateParams<Company>): Promise<CreateParams<Company> | UpdateParams<Company>> => {\n  let logo = params.data.logo;\n\n  if (typeof logo !== \"object\" || logo === null || !logo.src) {\n    logo = await getCompanyAvatar(params.data);\n  } else if (logo.rawFile instanceof File) {\n    await uploadToBucket(logo);\n  }\n\n  return {\n    ...params,\n    data: {\n      ...params.data,\n      logo,\n    },\n  };\n};\n\nasync function processContactAvatar(\n  params: UpdateParams<Contact>,\n): Promise<UpdateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact>,\n): Promise<CreateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact> | UpdateParams<Contact>,\n): Promise<CreateParams<Contact> | UpdateParams<Contact>> {\n  const { data } = params;\n  if (data.avatar?.src || !data.email_jsonb || !data.email_jsonb.length) {\n    return params;\n  }\n  const avatarUrl = await getContactAvatar(data);\n\n  // Clone the data and modify the clone\n  const newData = { ...data, avatar: { src: avatarUrl || undefined } };\n\n  return { ...params, data: newData };\n}\n\n// Helper function to map resource names for data provider\nconst mapResourceName = (resource: string): string => {\n  if (resource === \"lead-journey\") {\n    return \"deals\";\n  }\n  if (resource === \"contactNotes\" || resource === \"contact_notes\") {\n    return \"contactNotes\";\n  }\n  if (resource === \"dealNotes\" || resource === \"deal_notes\") {\n    return \"dealNotes\";\n  }\n  if (resource === \"companies\") {\n    return \"companies_summary\";\n  }\n  if (resource === \"contacts\" || resource === \"clients\") {\n    return \"contacts_summary\";\n  }\n  return resource;\n};\n\ntype RangeFilter = {\n  field: string;\n  gte?: string;\n  lte?: string;\n};\n\nfunction parseInList(value?: string): string[] {\n  if (!value) return [];\n  return value\n    .replace(/[()]/g, \"\")\n    .split(\",\")\n    .map((item) => item.trim())\n    .filter(Boolean);\n}\n\nfunction mergeIdInFilters(\n  existing: string | Identifier[] | undefined,\n  ids: Iterable<Identifier>,\n): string {\n  const existingIds: Identifier[] = Array.isArray(existing)\n    ? existing\n    : typeof existing === \"string\"\n      ? (parseInList(existing)\n          .map((item) => Number(item))\n          .filter((id) => !Number.isNaN(id)) as Identifier[])\n      : [];\n  const combined = new Set<Identifier>(existingIds);\n  for (const id of ids) {\n    combined.add(id);\n  }\n  if (combined.size === 0) return \"(-1)\";\n  return `(${Array.from(combined).join(\",\")})`;\n}\n\nasync function collectIdsForRanges(\n  resource: string,\n  ranges: RangeFilter[],\n  baseFilter: Record<string, unknown>,\n): Promise<Set<Identifier>> {\n  const ids = new Set<Identifier>();\n  for (const range of ranges) {\n    const filterForRange: Record<string, unknown> = { ...baseFilter };\n    if (range.gte) {\n      filterForRange[`${range.field}@gte`] = range.gte;\n    }\n    if (range.lte) {\n      filterForRange[`${range.field}@lte`] = range.lte;\n    }\n\n    const { data } = await baseDataProvider.getList(resource, {\n      pagination: { page: 1, perPage: 10000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: filterForRange,\n    });\n\n    data?.forEach((record: any) => {\n      if (record?.id !== undefined && record?.id !== null) {\n        ids.add(record.id as Identifier);\n      }\n    });\n  }\n  return ids;\n}\n\nconst dataProviderWithCustomMethods = {\n  ...baseDataProvider,\n  async getList(resource: string, params: GetListParams) {\n    const mappedResource = mapResourceName(resource);\n    \n    // Debug: log payment_packages queries\n    if (mappedResource === \"payment_packages\") {\n      console.log(\"PaymentPackages getList - params:\", JSON.stringify(params, null, 2));\n    }\n    \n    // Debug: log payment_transactions queries\n    if (mappedResource === \"payment_transactions\") {\n      console.log(\"PaymentTransactions getList - resource:\", resource, \"mappedResource:\", mappedResource);\n      console.log(\"PaymentTransactions getList - params:\", JSON.stringify(params, null, 2));\n    }\n    \n    // Handle overdue installments filter for payment_packages\n    if (mappedResource === \"payment_packages\" && params.filter && (params.filter as any).overdue_installments === true) {\n      try {\n        const today = new Date().toISOString().split(\"T\")[0];\n        // Get package IDs that have overdue installments\n        const { data: overdueInstallments, error } = await supabase\n          .from(\"installment_schedules\")\n          .select(\"payment_package_id\")\n          .eq(\"is_paid\", false)\n          .lt(\"due_date\", today);\n\n        if (error) throw error;\n\n        const packageIds = overdueInstallments\n          ? [...new Set(overdueInstallments.map((i) => i.payment_package_id))]\n          : [];\n\n        // Remove the custom filter and add id filter\n        const { overdue_installments, ...restFilter } = params.filter as any;\n        if (packageIds.length > 0) {\n          params.filter = {\n            ...restFilter,\n            id: packageIds,\n          };\n        } else {\n          // No overdue installments, return empty result\n          params.filter = {\n            ...restFilter,\n            id: [], // Empty array will return no results\n          };\n        }\n      } catch (error) {\n        logger.error(\"Error filtering overdue installments\", { error });\n        // Fall through to normal filtering\n      }\n    }\n    \n    const lastSeenRanges =\n      params.filter && Array.isArray((params.filter as any).last_seen_ranges)\n        ? ((params.filter as any).last_seen_ranges as RangeFilter[])\n        : [];\n    if (params.filter && \"last_seen_ranges\" in params.filter) {\n      delete (params.filter as any).last_seen_ranges;\n    }\n    \n    // Clean up invalid @or filters that might cause parsing errors\n    if (params.filter && params.filter[\"@or\"] && typeof params.filter[\"@or\"] === \"object\") {\n      const orFilter = params.filter[\"@or\"];\n      // Check if @or has invalid keys (like services_interested.cs_5.{5} or malformed syntax)\n      const hasInvalidKeys = Object.keys(orFilter).some(key => \n        key.includes(\".\") && (key.includes(\"cs_\") || key.match(/\\.\\d+\\./) || key.includes(\"services_interested.cs\"))\n      );\n      \n      if (hasInvalidKeys) {\n        // Remove invalid @or filter entirely\n        delete params.filter[\"@or\"];\n        // If @or was the only filter, ensure we don't have an empty filter object causing issues\n        if (Object.keys(params.filter).length === 0) {\n          params.filter = undefined;\n        }\n      }\n    }\n    \n    // Handle lead_stage filter for contacts resource - filter contacts by their deal stage (single or multi)\n    if (\n      (resource === \"contacts\" || resource === \"clients\") &&\n      params.filter &&\n      (\"lead_stage\" in params.filter || \"lead_stage@in\" in params.filter)\n    ) {\n      const stageValues: string[] = [];\n      if (\"lead_stage\" in params.filter) {\n        stageValues.push(params.filter.lead_stage as string);\n        delete params.filter.lead_stage;\n      }\n      if (\"lead_stage@in\" in params.filter) {\n        stageValues.push(\n          ...parseInList(params.filter[\"lead_stage@in\"] as string),\n        );\n        delete params.filter[\"lead_stage@in\"];\n      }\n\n      if (stageValues.length > 0) {\n        const dealsFilter =\n          stageValues.length === 1\n            ? { stage: stageValues[0] }\n            : { \"stage@in\": `(${stageValues.join(\",\")})` };\n\n        const { data: dealsWithStage } = await baseDataProvider.getList(\n          \"deals\",\n          {\n            pagination: { page: 1, perPage: 10000 },\n            sort: { field: \"id\", order: \"ASC\" },\n            filter: dealsFilter,\n          },\n        );\n\n        const contactIds = Array.from(\n          new Set(\n            dealsWithStage\n              ?.flatMap((deal: Deal) => {\n                if (deal.lead_id != null) return [deal.lead_id];\n                if (Array.isArray((deal as any).contact_ids)) {\n                  return (deal as any).contact_ids.filter(\n                    (id: Identifier | undefined) =>\n                      id !== undefined && id !== null,\n                  );\n                }\n                return [];\n              })\n              .filter(\n                (id: Identifier | undefined): id is Identifier =>\n                  id !== undefined && id !== null,\n              ),\n          ),\n        );\n\n        if (contactIds.length > 0) {\n          params.filter[\"id@in\"] = mergeIdInFilters(\n            params.filter[\"id@in\"],\n            contactIds,\n          );\n        } else {\n          params.filter[\"id@in\"] = \"(-1)\";\n        }\n      }\n    }\n    \n    // Handle client filters (active/archived) based on converted deals\n    if (resource === \"clients\" && params.filter) {\n      const hasArchivedDeals =\n        \"hasArchivedDeals\" in params.filter\n          ? params.filter.hasArchivedDeals\n          : undefined;\n      const hasIsClient = \"isClient\" in params.filter;\n\n      // Clean up handled filters\n      if (hasIsClient) {\n        delete params.filter.isClient;\n      }\n      if (\"hasArchivedDeals\" in params.filter) {\n        delete params.filter.hasArchivedDeals;\n      }\n\n      // Only run when explicitly filtering clients or archive state\n      if (hasIsClient || typeof hasArchivedDeals === \"boolean\") {\n        const dealFilter: any = { stage: \"converted\" };\n\n        // Default client view and explicit \"unarchived\" both limit to active deals\n        if (hasArchivedDeals === true) {\n          dealFilter[\"archived_at@not.is\"] = null;\n        } else {\n          dealFilter[\"archived_at@is\"] = null;\n        }\n\n        const { data: convertedDeals } = await baseDataProvider.getList(\"deals\", {\n          pagination: { page: 1, perPage: 10000 },\n          sort: { field: \"id\", order: \"ASC\" },\n          filter: dealFilter,\n        });\n\n        if (!convertedDeals || convertedDeals.length === 0) {\n          params.filter[\"id@in\"] = \"(-1)\";\n        } else {\n          // Extract unique lead_ids (contact IDs) from converted deals, falling back to legacy contact_ids array\n          const clientContactIds = Array.from(\n            new Set(\n              convertedDeals\n                .flatMap((deal: Deal) => {\n                  if (deal.lead_id != null) return [deal.lead_id];\n                  if (Array.isArray((deal as any).contact_ids)) {\n                    return (deal as any).contact_ids.filter(\n                      (id: Identifier | undefined) =>\n                        id !== undefined && id !== null,\n                    );\n                  }\n                  return [];\n                })\n                .filter((id: Identifier | undefined): id is Identifier => id !== undefined && id !== null),\n            ),\n          );\n\n          if (clientContactIds.length > 0) {\n            params.filter[\"id@in\"] = `(${clientContactIds.join(\",\")})`;\n          } else {\n            params.filter[\"id@in\"] = \"(-1)\";\n          }\n        }\n      }\n    }\n    \n    // Handle services_interested filters for contacts - only when a services filter is explicitly selected by the user\n    // CRITICAL: By default, show ALL leads (with and without services_interested)\n    if ((resource === \"contacts\" || resource === \"contacts_summary\") && params.filter) {\n      const isEmptySetString = (val: unknown) =>\n        typeof val !== \"string\" ||\n        val.trim() === \"\" ||\n        val.replace(/[{}\\s,]/g, \"\") === \"\";\n\n      // Remove null/undefined/empty-string filters to avoid accidental filtering\n      Object.entries(params.filter).forEach(([key, value]) => {\n        if (value === null || value === undefined || (typeof value === \"string\" && value.trim() === \"\")) {\n          delete params.filter![key];\n        }\n      });\n      if (params.filter[\"@or\"] && typeof params.filter[\"@or\"] === \"object\") {\n        const cleanedOr = Object.fromEntries(\n          Object.entries(params.filter[\"@or\"]).filter(([, value]) => {\n            if (value === null || value === undefined) return false;\n            if (typeof value === \"string\" && value.trim() === \"\") return false;\n            return true;\n          }),\n        );\n        if (Object.keys(cleanedOr).length === 0) {\n          delete params.filter[\"@or\"];\n        } else {\n          params.filter[\"@or\"] = cleanedOr;\n        }\n      }\n\n      // Clean up empty/invalid services filters (both @cs and @ov) so they don't accidentally filter out leads\n      const serviceKeys = [\"services_interested@cs\", \"services_interested@ov\"];\n      serviceKeys.forEach((key) => {\n        if (key in params.filter && isEmptySetString(params.filter[key])) {\n          delete params.filter[key];\n        }\n      });\n\n      if (params.filter[\"@or\"] && typeof params.filter[\"@or\"] === \"object\") {\n        const cleanedOr = Object.fromEntries(\n          Object.entries(params.filter[\"@or\"]).filter(([key, value]) => {\n            if (\n              !key.startsWith(\"services_interested@cs\") &&\n              !key.startsWith(\"services_interested@ov\")\n            )\n              return true;\n            return !isEmptySetString(value);\n          }),\n        );\n        if (Object.keys(cleanedOr).length === 0) {\n          delete params.filter[\"@or\"];\n        } else {\n          params.filter[\"@or\"] = cleanedOr;\n        }\n      }\n\n      // Check if there's actually a services_interested filter\n      const hasServicesFilter = !!(\n        (params.filter[\"services_interested@cs\"] &&\n          !isEmptySetString(params.filter[\"services_interested@cs\"])) ||\n        (params.filter[\"services_interested@ov\"] &&\n          !isEmptySetString(params.filter[\"services_interested@ov\"])) ||\n        (params.filter[\"@or\"] &&\n          typeof params.filter[\"@or\"] === \"object\" &&\n          Object.keys(params.filter[\"@or\"]).some(\n            (key) =>\n              (key.startsWith(\"services_interested@cs\") ||\n                key.startsWith(\"services_interested@ov\")) &&\n              !isEmptySetString((params.filter as any)[\"@or\"][key]),\n          ))\n      );\n      \n      // Only process services filter logic if there's actually a services filter\n      // If no services filter is present, skip this entire block - this ensures ALL contacts are shown\n      // including those without any services_interested (NULL or empty array)\n      if (hasServicesFilter) {\n        // Check if there are multiple services_interested@cs filters in @or\n        if (params.filter[\"@or\"] && typeof params.filter[\"@or\"] === \"object\") {\n          const orFilter = params.filter[\"@or\"];\n          const serviceFilters: string[] = [];\n          \n          // Extract all services_interested@cs filters from @or\n          Object.entries(orFilter).forEach(([key, value]) => {\n            if (key === \"services_interested@cs\" || key.startsWith(\"services_interested@cs\")) {\n              if (typeof value === \"string\") {\n                serviceFilters.push(value);\n              }\n            }\n          });\n          \n          // If we found multiple service filters, handle them\n          if (serviceFilters.length > 0) {\n            // Remove the @or filter temporarily\n            const cleanedOr = Object.fromEntries(\n              Object.entries(orFilter).filter(\n                ([key]) => !key.startsWith(\"services_interested@cs\")\n              )\n            );\n            \n            if (Object.keys(cleanedOr).length === 0) {\n              delete params.filter[\"@or\"];\n            } else {\n              params.filter[\"@or\"] = cleanedOr;\n            }\n            \n            // Fetch contacts for each service and combine results\n            const allContactIds = new Set<Identifier>();\n            \n            for (const serviceFilter of serviceFilters) {\n              const serviceIdMatch = serviceFilter?.match(/\\{(\\d+)\\}/);\n              if (serviceIdMatch) {\n                const { data: contacts } = await baseDataProvider.getList(\"contacts_summary\", {\n                  pagination: { page: 1, perPage: 1000 },\n                  sort: { field: \"id\", order: \"ASC\" },\n                  filter: { \"services_interested@cs\": serviceFilter },\n                });\n                \n                contacts?.forEach((c: any) => allContactIds.add(c.id));\n              }\n            }\n            \n            // Apply id@in filter with all matching contact IDs\n            if (allContactIds.size > 0) {\n              const contactIdsArray = Array.from(allContactIds);\n              // If there's already an id@in filter, intersect them\n              if (params.filter[\"id@in\"]) {\n                const existingIds = params.filter[\"id@in\"]\n                  .replace(/[()]/g, \"\")\n                  .split(\",\")\n                  .map((id: string) => parseInt(id.trim()))\n                  .filter((id: number) => !isNaN(id));\n                \n                const intersection = existingIds.filter((id: number) => contactIdsArray.includes(id));\n                \n                if (intersection.length > 0) {\n                  params.filter[\"id@in\"] = `(${intersection.join(\",\")})`;\n                } else {\n                  params.filter[\"id@in\"] = \"(-1)\";\n                }\n              } else {\n                params.filter[\"id@in\"] = `(${contactIdsArray.join(\",\")})`;\n              }\n            } else {\n              // No contacts match, return empty result\n              params.filter[\"id@in\"] = \"(-1)\";\n            }\n          }\n        }\n        \n        // Also handle single services_interested@cs filter (not in @or)\n        if (params.filter[\"services_interested@cs\"] && !params.filter[\"@or\"]) {\n          const servicesFilter = params.filter[\"services_interested@cs\"];\n          delete params.filter[\"services_interested@cs\"];\n          \n          const serviceIdMatch = servicesFilter?.match(/\\{(\\d+)\\}/);\n          if (serviceIdMatch) {\n            // Fetch contacts that have this service\n            const { data: contacts } = await baseDataProvider.getList(\"contacts_summary\", {\n              pagination: { page: 1, perPage: 1000 },\n              sort: { field: \"id\", order: \"ASC\" },\n              filter: { \"services_interested@cs\": servicesFilter },\n            });\n            \n            const contactIds = contacts?.map((c: any) => c.id) || [];\n            \n            if (contactIds.length > 0) {\n              // If there's already an id@in filter, intersect them\n              if (params.filter[\"id@in\"]) {\n                const existingIds = params.filter[\"id@in\"]\n                  .replace(/[()]/g, \"\")\n                  .split(\",\")\n                  .map((id: string) => parseInt(id.trim()))\n                  .filter((id: number) => !isNaN(id));\n                \n                const intersection = existingIds.filter((id: number) => contactIds.includes(id));\n                \n                if (intersection.length > 0) {\n                  params.filter[\"id@in\"] = `(${intersection.join(\",\")})`;\n                } else {\n                  params.filter[\"id@in\"] = \"(-1)\";\n                }\n              } else {\n                params.filter[\"id@in\"] = `(${contactIds.join(\",\")})`;\n              }\n            } else {\n              params.filter[\"id@in\"] = \"(-1)\";\n            }\n          }\n        }\n      }\n    }\n    \n    // Handle services_interested filter for lead-journey (deals) - filter through lead_id relationship\n    if (resource === \"lead-journey\" && params.filter && \"services_interested@cs\" in params.filter) {\n      const servicesFilter = params.filter[\"services_interested@cs\"];\n      delete params.filter[\"services_interested@cs\"];\n      \n      // Extract service ID from filter (format: {serviceId})\n      const serviceIdMatch = servicesFilter?.match(/\\{(\\d+)\\}/);\n      if (serviceIdMatch) {\n        // First, fetch contacts that have this service\n        const { data: contacts } = await baseDataProvider.getList(\"contacts_summary\", {\n          pagination: { page: 1, perPage: 1000 },\n          sort: { field: \"id\", order: \"ASC\" },\n          filter: { \"services_interested@cs\": servicesFilter },\n        });\n        \n        // Extract contact IDs and format as string for @in filter: \"(1,2,3)\"\n        const contactIds = contacts?.map((c: any) => c.id) || [];\n        \n        // Filter deals by lead_id in those contact IDs, and fallback to legacy contact_ids array\n        if (contactIds.length > 0) {\n          // Primary filter using lead_id\n          params.filter[\"lead_id@in\"] = `(${contactIds.join(\",\")})`;\n          // Legacy fallback: ensure we also match deals where the contact is stored in contact_ids\n          params.filter[\"@or\"] = {\n            \"lead_id@in\": params.filter[\"lead_id@in\"],\n            \"contact_ids@cs\": `{${contactIds.join(\",\")}}`,\n          };\n        } else {\n          // No contacts match, return empty result by using a non-existent ID\n          params.filter[\"lead_id@in\"] = \"(-1)\";\n        }\n      }\n    }\n    \n    // Ensure params.filter is always an object (not undefined) for the base provider\n    // Empty filter objects are fine - they won't filter anything\n    if (!params.filter) {\n      params.filter = {};\n    }\n\n    // Apply multi-range last_seen filters (union of matching IDs) after all other filters are in place\n    if (\n      lastSeenRanges.length > 0 &&\n      (mappedResource === \"contacts_summary\" ||\n        resource === \"contacts\" ||\n        resource === \"clients\")\n    ) {\n      const ids = await collectIdsForRanges(\n        mappedResource,\n        lastSeenRanges,\n        params.filter,\n      );\n      params.filter[\"id@in\"] =\n        ids.size > 0\n          ? mergeIdInFilters(params.filter[\"id@in\"], ids)\n          : \"(-1)\";\n    }\n    \n    return baseDataProvider.getList(mappedResource, params);\n  },\n  async getOne(resource: string, params: any) {\n    const mappedResource = mapResourceName(resource);\n    return baseDataProvider.getOne(mappedResource, params);\n  },\n  async create(resource: string, params: any) {\n    // For creates, use the base table instead of the view\n    let mappedResource = mapResourceName(resource);\n    if (mappedResource === \"contacts_summary\") {\n      mappedResource = \"contacts\";\n    }\n    if (mappedResource === \"companies_summary\") {\n      mappedResource = \"companies\";\n    }\n    \n    // Clean up tagged_user_ids for tasks to avoid schema cache issues\n    if (mappedResource === \"tasks\" && params.data) {\n      const cleanedData = { ...params.data };\n      // Only include tagged_user_ids if it's a valid non-empty array\n      // Otherwise, completely remove it to avoid Supabase schema cache errors\n      if (!Array.isArray(cleanedData.tagged_user_ids) || cleanedData.tagged_user_ids.length === 0) {\n        delete cleanedData.tagged_user_ids;\n      }\n      return baseDataProvider.create(mappedResource, { ...params, data: cleanedData });\n    }\n    \n    // Handle recurring appointments\n    if (mappedResource === \"appointments\" && params.data) {\n      const appointmentData = { ...params.data };\n      const staffIds = appointmentData.staff_ids || [];\n      delete appointmentData.staff_ids; // Remove staff_ids as it's not a column\n      \n      // Check if this is a recurring appointment\n      if (appointmentData.is_recurring && appointmentData.recurrence_config) {\n        // Import recurrence utilities dynamically to avoid circular dependencies\n        const { generateRecurringAppointments } = await import(\"../../appointments/recurrenceUtils\");\n        \n        // Generate UUID for recurrence_id\n        const recurrenceId = crypto.randomUUID();\n        \n        // Prepare base appointment data for generation\n        // Include payment_package_id so it propagates to all recurring instances\n        const baseAppointment = {\n          patient_id: appointmentData.patient_id,\n          appointment_date: appointmentData.appointment_date,\n          start_time: appointmentData.start_time,\n          end_time: appointmentData.end_time,\n          duration_minutes: appointmentData.duration_minutes,\n          appointment_type: appointmentData.appointment_type,\n          status: appointmentData.status || \"scheduled\",\n          notes: appointmentData.notes || null,\n          mini_notes: appointmentData.mini_notes || null,\n          full_notes: appointmentData.full_notes || null,\n          pickup_instructions: appointmentData.pickup_instructions || null,\n          primary_staff_id: appointmentData.primary_staff_id || null,\n          driver_id: appointmentData.driver_id || null,\n          payment_package_id: appointmentData.payment_package_id || null,\n        };\n        \n        // Generate all appointment instances\n        const generatedAppointments = generateRecurringAppointments(\n          baseAppointment,\n          appointmentData.recurrence_config\n        );\n        logger.debug(`Generated ${generatedAppointments.length} recurring appointments`, {\n          config: appointmentData.recurrence_config,\n          count: generatedAppointments.length,\n        });\n        \n        // Create parent appointment (sequence 0) with recurrence_config\n        const parentData = {\n          ...baseAppointment,\n          ...generatedAppointments[0],\n          recurrence_id: recurrenceId,\n          recurrence_config: appointmentData.recurrence_config,\n          is_recurring: true,\n          recurrence_sequence: 0,\n        };\n        \n        const parentResult = await baseDataProvider.create(mappedResource, {\n          ...params,\n          data: parentData,\n        });\n        \n        const parentId = parentResult.id;\n        \n        // Create staff assignments for parent\n        if (staffIds.length > 0) {\n          for (const staffId of staffIds) {\n            try {\n              await baseDataProvider.create(\"appointment_staff_assignments\", {\n                data: {\n                  appointment_id: parentId,\n                  staff_id: staffId,\n                  role: \"other\",\n                },\n              });\n            } catch (staffError) {\n              logger.warn(\"Error creating staff assignment for parent\", { error: staffError });\n            }\n          }\n        }\n        \n        // Log activity for parent appointment\n        try {\n          const { data: contact } = await supabase\n            .from(\"contacts\")\n            .select(\"sales_id\")\n            .eq(\"id\", appointmentData.patient_id)\n            .maybeSingle();\n          \n          await supabase.from(\"activity_log\").insert({\n            type: \"appointment.created\",\n            appointment_id: parentId,\n            contact_id: appointmentData.patient_id,\n            sales_id: contact?.sales_id || null,\n            date: new Date().toISOString(),\n          });\n        } catch (activityError) {\n          logger.warn(\"Error logging parent appointment activity\", { error: activityError });\n        }\n        \n        // Create child appointments (sequence 1+)\n        const childResults = [];\n        for (let i = 1; i < generatedAppointments.length; i++) {\n          const childData = {\n            ...generatedAppointments[i],\n            recurrence_id: recurrenceId,\n            is_recurring: true,\n            recurrence_sequence: i,\n            // Don't include recurrence_config on children\n          };\n          \n          try {\n            const childResult = await baseDataProvider.create(mappedResource, {\n              ...params,\n              data: childData,\n            });\n            \n            const childId = childResult.id;\n            childResults.push(childResult);\n            \n            // Create staff assignments for child\n            if (staffIds.length > 0) {\n              for (const staffId of staffIds) {\n                try {\n                  await baseDataProvider.create(\"appointment_staff_assignments\", {\n                    data: {\n                      appointment_id: childId,\n                      staff_id: staffId,\n                      role: \"other\",\n                    },\n                  });\n                } catch (staffError) {\n                  logger.warn(\"Error creating staff assignment for child\", { error: staffError });\n                }\n              }\n            }\n            \n            // Log activity for child appointment\n            try {\n              const { data: contact } = await supabase\n                .from(\"contacts\")\n                .select(\"sales_id\")\n                .eq(\"id\", appointmentData.patient_id)\n                .maybeSingle();\n              \n              await supabase.from(\"activity_log\").insert({\n                type: \"appointment.created\",\n                appointment_id: childId,\n                contact_id: appointmentData.patient_id,\n                sales_id: contact?.sales_id || null,\n                date: new Date().toISOString(),\n              });\n            } catch (activityError) {\n              logger.warn(\"Error logging child appointment activity\", { error: activityError });\n            }\n          } catch (childError) {\n            logger.error(`Error creating child appointment ${i}`, childError, { context: \"dataProvider\" });\n            // Continue creating other children even if one fails\n          }\n        }\n        \n        // Return parent result with metadata about children\n        return {\n          ...parentResult,\n          meta: {\n            ...parentResult.meta,\n            childrenCreated: childResults.length,\n            totalCreated: childResults.length + 1,\n          },\n        };\n      } else {\n        // Non-recurring appointment - create as normal but log activity\n        const result = await baseDataProvider.create(mappedResource, {\n          ...params,\n          data: appointmentData,\n        });\n        \n        // Create staff assignments\n        if (staffIds.length > 0) {\n          for (const staffId of staffIds) {\n            try {\n              await baseDataProvider.create(\"appointment_staff_assignments\", {\n                data: {\n                  appointment_id: result.id,\n                  staff_id: staffId,\n                  role: \"other\",\n                },\n              });\n            } catch (staffError) {\n              logger.warn(\"Error creating staff assignment\", { error: staffError });\n            }\n          }\n        }\n        \n        // Log activity for appointment creation\n        try {\n          const { data: contact } = await supabase\n            .from(\"contacts\")\n            .select(\"sales_id\")\n            .eq(\"id\", appointmentData.patient_id)\n            .maybeSingle();\n          \n          await supabase.from(\"activity_log\").insert({\n            type: \"appointment.created\",\n            appointment_id: result.id,\n            contact_id: appointmentData.patient_id,\n            sales_id: contact?.sales_id || null,\n            date: new Date().toISOString(),\n          });\n        } catch (activityError) {\n          logger.warn(\"Error logging appointment activity\", { error: activityError });\n        }\n        \n        return result;\n      }\n    }\n    \n    return baseDataProvider.create(mappedResource, params);\n  },\n  async update(resource: string, params: UpdateParams<RaRecord>) {\n    // For updates, use the base table instead of the view\n    // Views cannot be updated, so we need to update the actual table\n    let mappedResource = mapResourceName(resource);\n    if (mappedResource === \"contacts_summary\") {\n      mappedResource = \"contacts\";\n    }\n    if (mappedResource === \"companies_summary\") {\n      mappedResource = \"companies\";\n    }\n    \n    // Check if this is a deal/lead-journey update\n    if ((mappedResource === \"deals\" || resource === \"lead-journey\") && params.data) {\n      // Fetch the previous data to compare changes\n      const { data: previousDeal } = await supabase\n        .from(\"deals\")\n        .select(\"stage, sales_id, company_id, lead_id, contact_ids, archived_at\")\n        .eq(\"id\", params.id)\n        .maybeSingle();\n      \n      if (previousDeal) {\n        // Check if stage is changing\n        if (\"stage\" in params.data && previousDeal.stage !== params.data.stage) {\n          try {\n            const activityData: Record<string, unknown> = {\n              type: \"deal.statusChanged\",\n              deal_id: params.id,\n              sales_id: previousDeal.sales_id || params.data.sales_id || null,\n              date: new Date().toISOString(),\n            };\n            \n            // Try to include new columns (will fail gracefully if migration hasn't run)\n            const activityDataWithNewColumns = {\n              ...activityData,\n              company_id: previousDeal.company_id || params.data.company_id || null,\n              old_stage: previousDeal.stage || null,\n              new_stage: params.data.stage || null,\n            };\n            \n            const { error: insertError } = await supabase\n              .from(\"activity_log\")\n              .insert(activityDataWithNewColumns);\n            \n            // If insert failed (likely because columns don't exist), try without new columns\n            if (insertError) {\n              const { error: fallbackError } = await supabase\n                .from(\"activity_log\")\n                .insert(activityData);\n              \n              if (fallbackError) {\n                logger.warn(\"Failed to log status change to activity_log. Please run migration 20250208000000_add_status_change_tracking.sql\", { error: fallbackError });\n              }\n            }\n          } catch (error) {\n            logger.warn(\"Error logging status change\", { error });\n          }\n        }\n        \n        // Check if archived_at is changing (archive/unarchive)\n        if (\"archived_at\" in params.data) {\n          const wasArchived = previousDeal.archived_at != null;\n          const willBeArchived = params.data.archived_at != null;\n          \n          // Only log if the archive status is actually changing\n          if (wasArchived !== willBeArchived) {\n            try {\n              const activityData: Record<string, unknown> = {\n                type: willBeArchived ? \"deal.archived\" : \"deal.unarchived\",\n                deal_id: params.id,\n                sales_id: previousDeal.sales_id || params.data.sales_id || null,\n                date: new Date().toISOString(),\n              };\n              \n              // Try to include company_id if migration has been run\n              const activityDataWithCompany = {\n                ...activityData,\n                company_id: previousDeal.company_id || params.data.company_id || null,\n              };\n              \n              const { error: insertError } = await supabase\n                .from(\"activity_log\")\n                .insert(activityDataWithCompany);\n              \n              if (insertError) {\n                // Try without company_id if it fails\n                const { error: fallbackError } = await supabase\n                  .from(\"activity_log\")\n                  .insert(activityData);\n                \n                if (fallbackError) {\n                  logger.warn(\"Failed to log archive/unarchive to activity_log\", { error: fallbackError });\n                }\n              }\n            } catch (error) {\n              logger.warn(\"Error logging archive/unarchive\", { error });\n            }\n          }\n        }\n      }\n    }\n    \n    // Handle recurring appointment updates\n    if (mappedResource === \"appointments\" && params.data && params.id) {\n      const updateFutureOnly = (params.meta as any)?.updateFutureOnly || false;\n      \n      // Fetch the current appointment to check if it's recurring\n      const { data: currentAppointment } = await supabase\n        .from(\"appointments\")\n        .select(\"*\")\n        .eq(\"id\", params.id)\n        .maybeSingle();\n      \n      if (currentAppointment) {\n        const isRecurring = currentAppointment.is_recurring || currentAppointment.recurrence_id;\n        \n        if (isRecurring && updateFutureOnly) {\n          // Update this appointment and all future appointments in the series\n          const recurrenceId = currentAppointment.recurrence_id;\n          const appointmentStartTime = currentAppointment.start_time;\n          \n          // Find all appointments with same recurrence_id and start_time >= this appointment's start_time\n          const { data: futureAppointments } = await supabase\n            .from(\"appointments\")\n            .select(\"id, patient_id, start_time, appointment_type\")\n            .eq(\"recurrence_id\", recurrenceId)\n            .gte(\"start_time\", appointmentStartTime);\n          \n          const appointmentsToUpdate = futureAppointments || [];\n          \n          // Prepare update data - preserve dates, only update other fields\n          const updateData: Record<string, any> = { ...params.data };\n          \n          // For each future appointment, preserve its original date but update other fields\n          for (const futureAppt of appointmentsToUpdate) {\n            // Get the original date/time for this appointment\n            const originalStartTime = futureAppt.start_time;\n            const originalEndTime = futureAppt.end_time;\n            const originalDate = originalStartTime ? originalStartTime.split(\"T\")[0] : null;\n            \n            // Extract time from the update data (if provided)\n            let newStartTime = updateData.start_time;\n            let newEndTime = updateData.end_time;\n            \n            if (newStartTime && originalDate) {\n              // Preserve the original date, but use the new time\n              const timePart = newStartTime.includes(\"T\") ? newStartTime.split(\"T\")[1] : newStartTime;\n              newStartTime = `${originalDate}T${timePart}`;\n            } else if (originalStartTime) {\n              // Keep original time if no new time provided\n              newStartTime = originalStartTime;\n            }\n            \n            if (newEndTime && originalDate) {\n              // Preserve the original date, but use the new time\n              const timePart = newEndTime.includes(\"T\") ? newEndTime.split(\"T\")[1] : newEndTime;\n              newEndTime = `${originalDate}T${timePart}`;\n            } else if (originalEndTime) {\n              // Keep original time if no new time provided\n              newEndTime = originalEndTime;\n            }\n            \n            // Create update data with preserved date\n            const futureUpdateData: Record<string, any> = {\n              ...updateData,\n              appointment_date: originalDate || updateData.appointment_date,\n              start_time: newStartTime || updateData.start_time,\n              end_time: newEndTime || updateData.end_time,\n            };\n            \n            // Remove staff_ids from update data - it's handled separately\n            delete futureUpdateData.staff_ids;\n            \n            // Update this future appointment\n            try {\n              await baseDataProvider.update(mappedResource, {\n                id: futureAppt.id,\n                data: futureUpdateData,\n                previousData: futureAppt as any,\n              });\n            } catch (updateError) {\n              logger.error(`Error updating future appointment ${futureAppt.id}`, updateError, { context: \"dataProvider\" });\n              // Continue updating other appointments even if one fails\n            }\n          }\n          \n          // Store future appointment IDs for staff assignment handling\n          const futureAppointmentIds = appointmentsToUpdate.map(apt => apt.id);\n          \n          // Update the current appointment and return result with future appointment IDs\n          const result = await baseDataProvider.update(mappedResource, params);\n          \n          // Add future appointment IDs to the result\n          return {\n            ...result,\n            meta: {\n              ...result.meta,\n              futureAppointmentIds,\n            },\n          };\n        }\n      }\n    }\n    \n    return baseDataProvider.update(mappedResource, params);\n  },\n  async delete(resource: string, params: { id: Identifier; meta?: { deleteFutureOnly?: boolean } }) {\n    // Handle sales deletion through Edge Function to delete auth user\n    if (resource === \"sales\") {\n      return this.salesDelete(params.id);\n    }\n    \n    // For deletes, use the base table instead of the view\n    let mappedResource = mapResourceName(resource);\n    if (mappedResource === \"contacts_summary\") {\n      mappedResource = \"contacts\";\n    }\n    if (mappedResource === \"companies_summary\") {\n      mappedResource = \"companies\";\n    }\n    \n    // Try to fetch the record first (using maybeSingle to avoid 406 if not found)\n    // If fetch fails, we'll still try to delete\n    let record: Record<string, unknown> | null = null;\n    const { data: fetchedRecord } = await supabase\n      .from(mappedResource)\n      .select(\"*\")\n      .eq(\"id\", params.id)\n      .maybeSingle();\n    \n    record = fetchedRecord;\n\n    // Handle recurring appointment deletion\n    if (mappedResource === \"appointments\" && record) {\n      const deleteFutureOnly = params.meta?.deleteFutureOnly || false;\n      const isRecurring = record.is_recurring || record.recurrence_id;\n      \n      if (isRecurring && deleteFutureOnly) {\n        // Delete this appointment and all future appointments in the series\n        const recurrenceId = record.recurrence_id;\n        const appointmentStartTime = record.start_time;\n        \n        // Find all appointments with same recurrence_id and start_time >= this appointment's start_time\n        const { data: futureAppointments } = await supabase\n          .from(\"appointments\")\n          .select(\"id, patient_id, start_time, appointment_type\")\n          .eq(\"recurrence_id\", recurrenceId)\n          .gte(\"start_time\", appointmentStartTime);\n        \n        const appointmentsToDelete = futureAppointments || [];\n        \n        // Delete staff assignments and log activities for each appointment\n        for (const apt of appointmentsToDelete) {\n          try {\n            // Delete staff assignments\n            const { data: assignments } = await supabase\n              .from(\"appointment_staff_assignments\")\n              .select(\"id\")\n              .eq(\"appointment_id\", apt.id);\n            \n            for (const assignment of assignments || []) {\n              await supabase\n                .from(\"appointment_staff_assignments\")\n                .delete()\n                .eq(\"id\", assignment.id);\n            }\n            \n            // Log deletion activity\n            try {\n              const { data: contact } = await supabase\n                .from(\"contacts\")\n                .select(\"sales_id\")\n                .eq(\"id\", apt.patient_id)\n                .maybeSingle();\n              \n              await supabase.from(\"activity_log\").insert({\n                type: \"appointment.deleted\",\n                appointment_id: apt.id,\n                contact_id: apt.patient_id,\n                sales_id: contact?.sales_id || null,\n                appointment_date: apt.start_time ? apt.start_time.split(\"T\")[0] : null,\n                appointment_type: apt.appointment_type || null,\n                date: new Date().toISOString(),\n              });\n            } catch (activityError) {\n              logger.warn(\"Error logging appointment deletion activity\", { error: activityError });\n            }\n            \n            // Delete the appointment\n            await supabase\n              .from(\"appointments\")\n              .delete()\n              .eq(\"id\", apt.id);\n          } catch (error) {\n            logger.error(`Error deleting appointment ${apt.id}`, error, { context: \"dataProvider\" });\n            // Continue deleting other appointments even if one fails\n          }\n        }\n        \n        // Return the deleted record\n        return { data: record };\n      }\n      // For single appointment deletion, continue to normal deletion flow below\n      // (activity logging will happen in the general deletion section)\n    }\n\n    // If a contact is deleted, also archive any related Lead Journey items (deals)\n    // so they stop showing as cards after the FK sets lead_id to NULL.\n    if (mappedResource === \"contacts\" && params?.id != null) {\n      const contactId = params.id;\n      const now = new Date().toISOString();\n      try {\n        // Primary relation (new schema): deals.lead_id\n        await supabase\n          .from(\"deals\")\n          .update({ archived_at: now, updated_at: now })\n          .eq(\"lead_id\", contactId);\n\n        // Legacy relation (older schema): deals.contact_ids array\n        // Best-effort: if column doesn't exist or update is blocked, we ignore.\n        await supabase\n          .from(\"deals\")\n          .update({ archived_at: now, updated_at: now })\n          // PostgREST array contains operator\n          .contains(\"contact_ids\", [contactId] as any);\n      } catch {\n        // Best effort only; deletion should still proceed.\n      }\n    }\n    \n    // For contacts, archive instead of deleting\n    if (mappedResource === \"contacts\" && record) {\n      const now = new Date().toISOString();\n      const { error: archiveError } = await supabase\n        .from(\"contacts\")\n        .update({ archived_at: now })\n        .eq(\"id\", params.id);\n      \n      if (archiveError) {\n        throw archiveError;\n      }\n      \n      // Return the archived record\n      return { data: { ...record, archived_at: now } };\n    }\n    \n    // Create deletion activity before deleting\n    if (record) {\n      const activityData: Record<string, unknown> = {\n        date: new Date().toISOString(),\n        sales_id: record.sales_id || null,\n      };\n\n      if (mappedResource === \"contactNotes\" || mappedResource === \"dealNotes\") {\n        // Note deletion\n        activityData.type = \"note.deleted\";\n        activityData.note_text = record.text || null;\n        if (mappedResource === \"contactNotes\") {\n          activityData.contact_id = record.contact_id || null;\n        } else if (mappedResource === \"dealNotes\") {\n          activityData.deal_id = record.deal_id || null;\n          // For deal notes, try to get contact_id from the deal if possible\n          // This is a best-effort approach - if deal is already deleted, contact_id won't be available\n          if (record.deal_id) {\n            const { data: deal } = await supabase\n              .from(\"deals\")\n              .select(\"lead_id, contact_ids\")\n              .eq(\"id\", record.deal_id)\n              .maybeSingle();\n            if (deal) {\n              activityData.contact_id = deal.lead_id || (Array.isArray(deal.contact_ids) ? deal.contact_ids[0] : null);\n            }\n          }\n        }\n      } else if (mappedResource === \"quotes\") {\n        // Quote deletion\n        activityData.type = \"quote.deleted\";\n        activityData.contact_id = record.contact_id || null;\n        activityData.quote_amount = record.amount || null;\n        activityData.quote_description = record.description || null;\n      } else if (mappedResource === \"tasks\") {\n        // Task deletion\n        activityData.type = \"task.deleted\";\n        activityData.contact_id = record.contact_id || null;\n        activityData.task_text = record.text || null;\n        activityData.task_type = record.type || null;\n      } else if (mappedResource === \"appointments\") {\n        // Appointment deletion (single appointment, not handled above)\n        // Skip if we already handled it in the recurring appointment section\n        if (!record.is_recurring || !params.meta?.deleteFutureOnly) {\n          activityData.type = \"appointment.deleted\";\n          activityData.appointment_id = record.id;\n          activityData.contact_id = record.patient_id || null;\n          activityData.appointment_date = record.appointment_date || null;\n          activityData.appointment_type = record.appointment_type || null;\n        }\n      }\n\n      // Only create activity log entry if it's a note, quote, task, or appointment\n      if (activityData.type) {\n        await supabase.from(\"activity_log\").insert(activityData);\n      }\n    }\n    \n    // Use Supabase client directly to perform the delete\n    // This avoids the 406 error from the REST API\n    const { error: deleteError } = await supabase\n      .from(mappedResource)\n      .delete()\n      .eq(\"id\", params.id);\n    \n    if (deleteError) {\n      throw deleteError;\n    }\n    \n    // Return the deleted record in the format expected by react-admin\n    // If we couldn't fetch it, return at least the ID\n    return { data: record || { id: params.id } };\n  },\n  async getMany(resource: string, params: any) {\n    const mappedResource = mapResourceName(resource);\n    return baseDataProvider.getMany(mappedResource, params);\n  },\n  async getManyReference(resource: string, params: any) {\n    const mappedResource = mapResourceName(resource);\n    return baseDataProvider.getManyReference(mappedResource, params);\n  },\n\n  async signUp({ email, password, first_name, last_name }: SignUpData) {\n    const response = await supabase.auth.signUp({\n      email,\n      password,\n      options: {\n        data: {\n          first_name,\n          last_name,\n        },\n      },\n    });\n\n    if (!response.data?.user || response.error) {\n      logger.error(\"signUp.error\", response.error, { context: \"dataProvider\" });\n      throw new Error(\"Failed to create account\");\n    }\n\n    // Update the is initialized cache\n    getIsInitialized._is_initialized_cache = true;\n\n    return {\n      id: response.data.user.id,\n      email,\n      password,\n    };\n  },\n  async salesCreate(body: SalesFormData) {\n    // Use direct fetch to get better error details\n    try {\n      const session = await supabase.auth.getSession();\n      const authToken = session.data.session?.access_token;\n      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\n      const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;\n      \n      console.log(\"salesCreate - Making request to:\", `${supabaseUrl}/functions/v1/users`);\n      console.log(\"salesCreate - Request body:\", body);\n      \n      const response = await fetch(`${supabaseUrl}/functions/v1/users`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Authorization\": `Bearer ${authToken}`,\n          \"apikey\": supabaseKey,\n        },\n        body: JSON.stringify(body),\n      });\n      \n      const responseText = await response.text();\n      console.log(\"salesCreate - Response status:\", response.status);\n      console.log(\"salesCreate - Response text:\", responseText);\n      \n      if (!response.ok) {\n        let errorData: { status?: number; message?: string } = {};\n        try {\n          errorData = JSON.parse(responseText);\n        } catch {\n          errorData = { message: responseText || `HTTP ${response.status}: ${response.statusText}` };\n        }\n        \n        console.error(\"salesCreate - Error response:\", {\n          status: response.status,\n          statusText: response.statusText,\n          responseText,\n          errorData,\n        });\n        \n        throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);\n      }\n      \n      const result = JSON.parse(responseText);\n      return result.data || result;\n    } catch (fetchError: any) {\n      // If it's already our Error with message, re-throw it\n      if (fetchError instanceof Error && fetchError.message && !fetchError.message.includes(\"fetch\")) {\n        throw fetchError;\n      }\n      \n      // Otherwise, fall back to supabase client for compatibility\n      console.warn(\"Direct fetch failed, trying supabase client:\", fetchError);\n      const { data, error } = await supabase.functions.invoke<{ data: Sale }>(\"users\", {\n        method: \"POST\",\n        body,\n      });\n      \n      if (error) {\n        throw error;\n      }\n      \n      return data;\n    }\n  },\n  async salesUpdate(\n    id: Identifier,\n    data: Partial<Omit<SalesFormData, \"password\">>,\n  ) {\n    const { email, first_name, last_name, administrator, avatar, disabled } =\n      data;\n\n    const { data: sale, error } = await supabase.functions.invoke<Sale>(\n      \"users\",\n      {\n        method: \"PATCH\",\n        body: {\n          sales_id: id,\n          email,\n          first_name,\n          last_name,\n          administrator,\n          disabled,\n          avatar,\n        },\n      },\n    );\n\n    if (!sale || error) {\n      logger.error(\"salesUpdate.error\", error, { context: \"dataProvider\" });\n      throw new Error(\"Failed to update account manager\");\n    }\n\n    return data;\n  },\n  async salesDelete(id: Identifier) {\n    const { error } = await supabase.functions.invoke<{ message: string }>(\n      \"users\",\n      {\n        method: \"DELETE\",\n        body: {\n          sales_id: id,\n        },\n      },\n    );\n\n    if (error) {\n      logger.error(\"salesDelete.error\", error, { context: \"dataProvider\", id });\n      \n      // Try to extract error message from the error response\n      let errorMessage = \"Failed to delete user\";\n      const errorAny = error as any;\n      \n      // Log the full error structure for debugging\n      if (process.env.NODE_ENV === \"development\") {\n        console.error(\"Full error object:\", JSON.stringify(errorAny, null, 2));\n      }\n      \n      // Try to extract from error context\n      if (errorAny?.context) {\n        const context = errorAny.context;\n        if (context?.message) {\n          errorMessage = context.message;\n        } else if (context?.status === 401) {\n          errorMessage = \"You do not have permission to delete users. Administrator access required.\";\n        } else if (context?.status === 400) {\n          errorMessage = \"Cannot delete your own account\";\n        } else if (context?.status === 404) {\n          errorMessage = \"User not found\";\n        } else if (context?.status === 500) {\n          errorMessage = \"Server error occurred while deleting user. Please check the Edge Function logs.\";\n        }\n      }\n      \n      // Try to extract from error message if it contains JSON\n      if (error instanceof Error && error.message) {\n        try {\n          const match = error.message.match(/\\{.*\\}/);\n          if (match) {\n            const parsed = JSON.parse(match[0]);\n            if (parsed.message) {\n              errorMessage = parsed.message;\n            } else if (parsed.status === 401) {\n              errorMessage = \"You do not have permission to delete users. Administrator access required.\";\n            } else if (parsed.status === 500) {\n              errorMessage = parsed.message || \"Server error occurred while deleting user. Please check the Edge Function logs.\";\n            }\n          }\n        } catch {\n          // Ignore parsing errors\n        }\n      }\n      \n      throw new Error(errorMessage);\n    }\n\n    return { data: { id } };\n  },\n  async updatePassword(id: Identifier) {\n    const { data: passwordUpdated, error } =\n      await supabase.functions.invoke<boolean>(\"updatePassword\", {\n        method: \"PATCH\",\n        body: {\n          sales_id: id,\n        },\n      });\n\n    if (!passwordUpdated || error) {\n      logger.error(\"passwordUpdate.error\", error, { context: \"dataProvider\" });\n      throw new Error(\"Failed to update password\");\n    }\n\n    return passwordUpdated;\n  },\n  async unarchiveDeal(deal: Deal) {\n    // Log unarchive action before processing\n    try {\n      const activityData: Record<string, unknown> = {\n        type: \"deal.unarchived\",\n        deal_id: deal.id,\n        sales_id: deal.sales_id || null,\n        date: new Date().toISOString(),\n      };\n      \n      // Try to include company_id if migration has been run\n      const activityDataWithCompany = {\n        ...activityData,\n        company_id: deal.company_id || null,\n      };\n      \n      const { error: insertError } = await supabase\n        .from(\"activity_log\")\n        .insert(activityDataWithCompany);\n      \n      if (insertError) {\n        // Try without company_id if it fails\n        const { error: fallbackError } = await supabase\n          .from(\"activity_log\")\n          .insert(activityData);\n        \n        if (fallbackError) {\n          logger.warn(\"Failed to log unarchive to activity_log\", { error: fallbackError });\n        }\n      }\n    } catch (error) {\n      logger.warn(\"Error logging unarchive\", { error });\n    }\n    \n    // get all deals where stage is the same as the deal to unarchive\n    const { data: deals } = await baseDataProvider.getList<Deal>(\"deals\", {\n      filter: { stage: deal.stage },\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"index\", order: \"ASC\" },\n    });\n\n    // set index for each deal starting from 1, if the deal to unarchive is found, set its index to the last one\n    const updatedDeals = deals.map((d, index) => ({\n      ...d,\n      index: d.id === deal.id ? 0 : index + 1,\n      archived_at: d.id === deal.id ? null : d.archived_at,\n    }));\n\n    return await Promise.all(\n      updatedDeals.map((updatedDeal) =>\n        baseDataProvider.update(\"deals\", {\n          id: updatedDeal.id,\n          data: updatedDeal,\n          previousData: deals.find((d) => d.id === updatedDeal.id),\n        }),\n      ),\n    );\n  },\n  async getActivityLog(companyId?: Identifier, contactId?: Identifier) {\n    return getActivityLog(baseDataProvider, companyId, undefined, contactId);\n  },\n  async isInitialized() {\n    return getIsInitialized();\n  },\n  async mergeContacts(sourceId: Identifier, targetId: Identifier) {\n    // FIXME this should be done in a lambda function using a transaction instead\n    return mergeContacts(sourceId, targetId, baseDataProvider);\n  },\n  async getOverdueInstallments() {\n    try {\n      const today = new Date().toISOString().split(\"T\")[0];\n      const { data, error } = await supabase\n        .from(\"installment_schedules\")\n        .select(`\n          *,\n          payment_packages!inner(*)\n        `)\n        .eq(\"is_paid\", false)\n        .lt(\"due_date\", today)\n        .order(\"due_date\", { ascending: true });\n\n      if (error) throw error;\n\n      return {\n        data: data || [],\n        total: data?.length || 0,\n      };\n    } catch (error) {\n      logger.error(\"getOverdueInstallments.error\", error, { context: \"dataProvider\" });\n      throw error;\n    }\n  },\n  async linkAppointmentToPackage(appointmentId: Identifier, packageId: Identifier) {\n    try {\n      const { data, error } = await supabase\n        .from(\"appointments\")\n        .update({ payment_package_id: packageId })\n        .eq(\"id\", appointmentId)\n        .select()\n        .single();\n\n      if (error) throw error;\n      return { data };\n    } catch (error) {\n      logger.error(\"linkAppointmentToPackage.error\", error, { context: \"dataProvider\", appointmentId, packageId });\n      throw error;\n    }\n  },\n  async getPackageUsage(packageId: Identifier) {\n    // Alias for calculatePackageUsage for consistency\n    return this.calculatePackageUsage(packageId);\n  },\n  async renewPackage(packageId: Identifier, newParams: any) {\n    try {\n      // Get the old package\n      const { data: oldPackage, error: getError } = await supabase\n        .from(\"payment_packages\")\n        .select(\"*\")\n        .eq(\"id\", packageId)\n        .single();\n\n      if (getError || !oldPackage) throw getError || new Error(\"Package not found\");\n\n      // Create new package with new parameters\n      const { data: newPackage, error: createError } = await supabase\n        .from(\"payment_packages\")\n        .insert({\n          ...oldPackage,\n          ...newParams,\n          id: undefined, // Let database generate new ID\n          renewed_from_package_id: packageId,\n          status: \"active\",\n          created_at: undefined,\n          updated_at: undefined,\n        })\n        .select()\n        .single();\n\n      if (createError) throw createError;\n\n      // Mark old package as completed\n      const { error: updateError } = await supabase\n        .from(\"payment_packages\")\n        .update({ status: \"completed\" })\n        .eq(\"id\", packageId);\n\n      if (updateError) throw updateError;\n\n      return { data: newPackage };\n    } catch (error) {\n      logger.error(\"renewPackage.error\", error, { context: \"dataProvider\", packageId, newParams });\n      throw error;\n    }\n  },\n  async calculatePackageUsage(packageId: Identifier) {\n    // Call the database function to calculate package usage\n    const { data, error } = await supabase.rpc('calculate_package_usage', {\n      package_id: packageId,\n    });\n\n    if (error) {\n      logger.error(\"calculatePackageUsage.error\", error, { context: \"dataProvider\", packageId });\n      throw new Error(`Failed to calculate package usage: ${error.message}`);\n    }\n\n    // The function returns JSONB with sessions_used and hours_used\n    return {\n      sessionsUsed: Number(data?.sessions_used || 0),\n      hoursUsed: Number(data?.hours_used || 0),\n    };\n  },\n} satisfies DataProvider;\n\nexport type CrmDataProvider = typeof dataProviderWithCustomMethods;\n\nexport const dataProvider = withLifecycleCallbacks(\n  dataProviderWithCustomMethods,\n  [\n    {\n      resource: \"contactNotes\",\n      beforeSave: async (data: ContactNote, _, __) => {\n        return data;\n      },\n    },\n    {\n      resource: \"dealNotes\",\n      beforeSave: async (data: DealNote, _, __) => {\n        return data;\n      },\n    },\n    {\n      resource: \"sales\",\n      beforeSave: async (data: Sale, _, __) => {\n        if (data.avatar) {\n          await uploadToBucket(data.avatar);\n        }\n        return data;\n      },\n    },\n    {\n      resource: \"contacts\",\n      beforeCreate: async (params) => {\n        return processContactAvatar(params);\n      },\n      beforeUpdate: async (params) => {\n        return processContactAvatar(params);\n      },\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"first_name\",\n          \"last_name\",\n          \"company_name\",\n          \"title\",\n          \"email\",\n          \"phone\",\n          \"background\",\n        ])(params);\n      },\n    },\n    {\n      resource: \"staff\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"first_name\",\n          \"last_name\",\n          \"email\",\n          \"phone\",\n          \"staff_type\",\n        ])(params);\n      },\n    },\n    {\n      resource: \"companies\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"name\",\n          \"phone_number\",\n          \"website\",\n          \"zipcode\",\n          \"city\",\n          \"stateAbbr\",\n        ])(params);\n      },\n      beforeCreate: async (params) => {\n        const createParams = await processCompanyLogo(params);\n\n        return {\n          ...createParams,\n          data: {\n            ...createParams.data,\n            created_at: new Date().toISOString(),\n          },\n        };\n      },\n      beforeUpdate: async (params) => {\n        return await processCompanyLogo(params);\n      },\n    },\n    {\n      resource: \"contacts_summary\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"first_name\",\n          \"last_name\",\n          \"email\",\n          \"phone\",\n          \"background\",\n          \"area\",\n          \"city\",\n          \"flat_villa_number\",\n          \"building_street\",\n        ])(params);\n      },\n    },\n    {\n      resource: \"lead-journey\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\"name\", \"type\", \"description\"])(params);\n      },\n    },\n    {\n      resource: \"sales\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"first_name\",\n          \"last_name\",\n          \"email\",\n        ], { useFtsSuffix: false })(params);\n      },\n    },\n    {\n      resource: \"payment_transactions\",\n      afterCreate: async (result, dataProvider) => {\n        const transaction = result.data;\n        \n        // If payment has installment_number, mark the corresponding installment as paid\n        if (transaction.installment_number && transaction.payment_package_id) {\n          try {\n            // Find the installment schedule record\n            const { data: installments } = await supabase\n              .from(\"installment_schedules\")\n              .select(\"*\")\n              .eq(\"payment_package_id\", transaction.payment_package_id)\n              .eq(\"installment_number\", transaction.installment_number)\n              .eq(\"is_paid\", false)\n              .maybeSingle();\n\n            if (installments) {\n              // Check if amount matches (with some tolerance for rounding)\n              const amountDifference = Math.abs(installments.amount_due - transaction.amount_received);\n              const tolerance = 0.01; // Allow 1 cent difference for rounding\n\n              if (amountDifference <= tolerance) {\n                // Mark installment as paid\n                await supabase\n                  .from(\"installment_schedules\")\n                  .update({\n                    is_paid: true,\n                    paid_date: transaction.date_paid || transaction.date_received || new Date().toISOString().split(\"T\")[0],\n                  })\n                  .eq(\"id\", installments.id);\n\n                logger.info(`Marked installment ${transaction.installment_number} as paid for package ${transaction.payment_package_id}`);\n              } else {\n                logger.warn(\n                  `Payment amount (${transaction.amount_received}) doesn't match installment amount (${installments.amount_due}) for package ${transaction.payment_package_id}, installment ${transaction.installment_number}`\n                );\n              }\n            }\n          } catch (error) {\n            logger.error(`Failed to mark installment as paid for transaction ${transaction.id}`, { error });\n            // Don't throw - transaction is already created\n          }\n        }\n\n        return result;\n      },\n    },\n    {\n      resource: \"payment_packages\",\n      beforeGetList: async (params) => {\n        // Remove empty search query - payment_packages doesn't have text search columns\n        if (params.filter && \"q\" in params.filter) {\n          const filter = params.filter as any;\n          const q = filter.q;\n          // Remove empty or whitespace-only search queries\n          if (q === undefined || q === null || q === \"\" || (typeof q === \"string\" && q.trim() === \"\")) {\n            const { q: _, ...restFilter } = filter;\n            params.filter = restFilter;\n          }\n          // Note: We don't apply full-text search here because payment_packages\n          // doesn't have searchable text columns. Users can filter by patient, service, status, etc.\n        }\n        // Debug: log the filter to see what's being sent\n        console.log(\"PaymentPackages beforeGetList - filter:\", params.filter);\n        return params;\n      },\n      afterCreate: async (result, dataProvider) => {\n        // No automatic installment creation - payments are flexible\n        return result;\n      },\n    },\n  ],\n);\n\nconst applyFullTextSearch = (\n  columns: string[],\n  options: { useFtsSuffix?: boolean } = { useFtsSuffix: true }\n) => (params: GetListParams) => {\n  if (!params.filter?.q) {\n    return params;\n  }\n  const { q, ...filter } = params.filter;\n  const { useFtsSuffix = true } = options;\n  return {\n    ...params,\n    filter: {\n      ...filter,\n      \"@or\": columns.reduce((acc, column) => {\n        if (column === \"email\") {\n          const emailColumn = useFtsSuffix ? \"email_fts\" : \"email\";\n          return {\n            ...acc,\n            [`${emailColumn}@ilike`]: q,\n          };\n        }\n        if (column === \"phone\") {\n          const phoneColumn = useFtsSuffix ? \"phone_fts\" : \"phone\";\n          return {\n            ...acc,\n            [`${phoneColumn}@ilike`]: q,\n          };\n        }\n        return {\n          ...acc,\n          [`${column}@ilike`]: q,\n        };\n      }, {}),\n    },\n  };\n};\n\nconst uploadToBucket = async (fi: RAFile) => {\n  if (!fi.src.startsWith(\"blob:\") && !fi.src.startsWith(\"data:\")) {\n    // Sign URL check if path exists in the bucket\n    if (fi.path) {\n      const { error } = await supabase.storage\n        .from(\"attachments\")\n        .createSignedUrl(fi.path, 60);\n\n      if (!error) {\n        return;\n      }\n    }\n  }\n\n  const dataContent = fi.src\n    ? await fetch(fi.src).then((res) => res.blob())\n    : fi.rawFile;\n\n  const file = fi.rawFile;\n  const fileExt = file.name.split(\".\").pop();\n  const fileName = `${Math.random()}.${fileExt}`;\n  const filePath = `${fileName}`;\n  const { error: uploadError } = await supabase.storage\n    .from(\"attachments\")\n    .upload(filePath, dataContent);\n\n  if (uploadError) {\n    logger.error(\"uploadError\", uploadError, { context: \"dataProvider\" });\n    throw new Error(\"Failed to upload attachment\");\n  }\n\n  const { data } = supabase.storage.from(\"attachments\").getPublicUrl(filePath);\n\n  fi.path = filePath;\n  fi.src = data.publicUrl;\n\n  // save MIME type\n  const mimeType = file.type;\n  fi.type = mimeType;\n\n  return fi;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/authProvider.ts",
      "content": "/* eslint-disable no-var */\n/* eslint-disable @typescript-eslint/no-namespace */\nimport type { AuthProvider } from \"ra-core\";\nimport { supabaseAuthProvider } from \"ra-supabase-core\";\n\nimport { canAccess } from \"../commons/canAccess\";\nimport { supabase } from \"./supabase\";\n\nconst baseAuthProvider = supabaseAuthProvider(supabase, {\n  getIdentity: async () => {\n    const sale = await getSaleFromCache();\n\n    if (sale == null) {\n      throw new Error();\n    }\n\n    return {\n      id: sale.id,\n      fullName: `${sale.first_name} ${sale.last_name}`,\n      avatar: sale.avatar?.src,\n    };\n  },\n});\n\nexport async function getIsInitialized() {\n  if (getIsInitialized._is_initialized_cache == null) {\n    const { data } = await supabase.from(\"init_state\").select(\"is_initialized\");\n\n    getIsInitialized._is_initialized_cache = data?.at(0)?.is_initialized > 0;\n  }\n\n  return getIsInitialized._is_initialized_cache;\n}\n\nexport namespace getIsInitialized {\n  export var _is_initialized_cache: boolean | null = null;\n}\n\nexport const authProvider: AuthProvider = {\n  ...baseAuthProvider,\n  login: async (params) => {\n    const result = await baseAuthProvider.login(params);\n    // clear cached sale\n    cachedSale = undefined;\n    return result;\n  },\n  checkAuth: async (params) => {\n    // Users are on the set-password page, nothing to do\n    if (\n      window.location.pathname === \"/set-password\" ||\n      window.location.hash.includes(\"#/set-password\")\n    ) {\n      return;\n    }\n    // Users are on the forgot-password page, nothing to do\n    if (\n      window.location.pathname === \"/forgot-password\" ||\n      window.location.hash.includes(\"#/forgot-password\")\n    ) {\n      return;\n    }\n    // Users are on the sign-up page, nothing to do\n    if (\n      window.location.pathname === \"/sign-up\" ||\n      window.location.hash.includes(\"#/sign-up\")\n    ) {\n      return;\n    }\n\n    const isInitialized = await getIsInitialized();\n\n    if (!isInitialized) {\n      await supabase.auth.signOut();\n      throw {\n        redirectTo: \"/sign-up\",\n        message: false,\n      };\n    }\n\n    // Check if we have a valid session\n    const { data: sessionData } = await supabase.auth.getSession();\n\n    if (!sessionData?.session) {\n      // No session found, let baseAuthProvider handle the redirect\n      // It will throw an error that redirects to login\n    }\n\n    return baseAuthProvider.checkAuth(params);\n  },\n  canAccess: async (params) => {\n    const isInitialized = await getIsInitialized();\n    if (!isInitialized) return false;\n\n    // Get the current user\n    const sale = await getSaleFromCache();\n    if (sale == null) return false;\n\n    // Compute access rights from the sale role\n    const role = sale.administrator ? \"admin\" : \"user\";\n    return canAccess(role, params);\n  },\n};\n\nlet cachedSale: any;\nconst getSaleFromCache = async () => {\n  if (cachedSale != null) return cachedSale;\n\n  const { data: dataSession, error: errorSession } =\n    await supabase.auth.getSession();\n\n  // Shouldn't happen after login but just in case\n  if (dataSession?.session?.user == null || errorSession) {\n    return undefined;\n  }\n\n  const { data: dataSale, error: errorSale } = await supabase\n    .from(\"sales\")\n    .select(\"id, first_name, last_name, avatar, administrator\")\n    .match({ user_id: dataSession?.session?.user.id })\n    .single();\n\n  // Shouldn't happen either as all users are sales but just in case\n  if (dataSale == null || errorSale) {\n    return undefined;\n  }\n\n  cachedSale = dataSale;\n  return dataSale;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/index.ts",
      "content": "export { authProvider } from \"./authProvider\";\nexport { dataProvider } from \"./dataProvider\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataProvider.ts",
      "content": "import {\n  withLifecycleCallbacks,\n  type CreateParams,\n  type DataProvider,\n  type Identifier,\n  type ResourceCallbacks,\n  type UpdateParams,\n} from \"ra-core\";\nimport fakeRestDataProvider from \"ra-data-fakerest\";\n\nimport type {\n  Company,\n  Contact,\n  Deal,\n  Sale,\n  SalesFormData,\n  SignUpData,\n  Task,\n} from \"../../types\";\nimport { getActivityLog } from \"../commons/activity\";\nimport { getCompanyAvatar } from \"../commons/getCompanyAvatar\";\nimport { getContactAvatar } from \"../commons/getContactAvatar\";\nimport { mergeContacts } from \"../commons/mergeContacts\";\nimport type { CrmDataProvider } from \"../types\";\nimport { authProvider, USER_STORAGE_KEY } from \"./authProvider\";\nimport generateData from \"./dataGenerator\";\nimport { withSupabaseFilterAdapter } from \"./internal/supabaseAdapter\";\n\nconst baseDataProvider = fakeRestDataProvider(generateData(), true, 300);\n\nconst TASK_MARKED_AS_DONE = \"TASK_MARKED_AS_DONE\";\nconst TASK_MARKED_AS_UNDONE = \"TASK_MARKED_AS_UNDONE\";\nconst TASK_DONE_NOT_CHANGED = \"TASK_DONE_NOT_CHANGED\";\nlet taskUpdateType = TASK_DONE_NOT_CHANGED;\n\nconst processCompanyLogo = async (params: any) => {\n  let logo = params.data.logo;\n\n  if (typeof logo !== \"object\" || logo === null || !logo.src) {\n    logo = await getCompanyAvatar(params.data);\n  } else if (logo.rawFile instanceof File) {\n    const base64Logo = await convertFileToBase64(logo);\n    logo = { src: base64Logo, title: logo.title };\n  }\n\n  return {\n    ...params,\n    data: {\n      ...params.data,\n      logo,\n    },\n  };\n};\n\nasync function processContactAvatar(\n  params: UpdateParams<Contact>,\n): Promise<UpdateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact>,\n): Promise<CreateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact> | UpdateParams<Contact>,\n): Promise<CreateParams<Contact> | UpdateParams<Contact>> {\n  const { data } = params;\n  if (data.avatar?.src || !data.email_jsonb || !data.email_jsonb.length) {\n    return params;\n  }\n  const avatarUrl = await getContactAvatar(data);\n\n  // Clone the data and modify the clone\n  const newData = { ...data, avatar: { src: avatarUrl || undefined } };\n\n  return { ...params, data: newData };\n}\n\nasync function fetchAndUpdateCompanyData(\n  params: UpdateParams<Contact>,\n  dataProvider: DataProvider,\n): Promise<UpdateParams<Contact>>;\n\nasync function fetchAndUpdateCompanyData(\n  params: CreateParams<Contact>,\n  dataProvider: DataProvider,\n): Promise<CreateParams<Contact>>;\n\nasync function fetchAndUpdateCompanyData(\n  params: CreateParams<Contact> | UpdateParams<Contact>,\n  dataProvider: DataProvider,\n): Promise<CreateParams<Contact> | UpdateParams<Contact>> {\n  const { data } = params;\n  const newData = { ...data };\n\n  if (!newData.company_id) {\n    return params;\n  }\n\n  const { data: company } = await dataProvider.getOne(\"companies\", {\n    id: newData.company_id,\n  });\n\n  if (!company) {\n    return params;\n  }\n\n  newData.company_name = company.name;\n  return { ...params, data: newData };\n}\n\nconst dataProviderWithCustomMethod: CrmDataProvider = {\n  ...baseDataProvider,\n  unarchiveDeal: async (deal: Deal) => {\n    // get all deals where stage is the same as the deal to unarchive\n    const { data: deals } = await baseDataProvider.getList<Deal>(\"deals\", {\n      filter: { stage: deal.stage },\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"index\", order: \"ASC\" },\n    });\n\n    // set index for each deal starting from 1, if the deal to unarchive is found, set its index to the last one\n    const updatedDeals = deals.map((d, index) => ({\n      ...d,\n      index: d.id === deal.id ? 0 : index + 1,\n      archived_at: d.id === deal.id ? null : d.archived_at,\n    }));\n\n    return await Promise.all(\n      updatedDeals.map((updatedDeal) =>\n        dataProvider.update(\"deals\", {\n          id: updatedDeal.id,\n          data: updatedDeal,\n          previousData: deals.find((d) => d.id === updatedDeal.id),\n        }),\n      ),\n    );\n  },\n  // We simulate a remote endpoint that is in charge of returning activity log\n  getActivityLog: async (companyId?: Identifier, contactId?: Identifier) => {\n    return getActivityLog(dataProvider, companyId, undefined, contactId);\n  },\n  signUp: async ({\n    email,\n    password,\n    first_name,\n    last_name,\n  }: SignUpData): Promise<{ id: string; email: string; password: string }> => {\n    const user = await baseDataProvider.create(\"sales\", {\n      data: {\n        email,\n        first_name,\n        last_name,\n      },\n    });\n\n    return {\n      ...user.data,\n      password,\n    };\n  },\n  salesCreate: async ({ ...data }: SalesFormData): Promise<Sale> => {\n    const user = await dataProvider.create(\"sales\", {\n      data: {\n        ...data,\n        password: \"new_password\",\n      },\n    });\n\n    return {\n      ...user.data,\n    };\n  },\n  salesUpdate: async (\n    id: Identifier,\n    data: Partial<Omit<SalesFormData, \"password\">>,\n  ): Promise<Partial<Omit<SalesFormData, \"password\">>> => {\n    const { data: previousData } = await dataProvider.getOne<Sale>(\"sales\", {\n      id,\n    });\n\n    if (!previousData) {\n      throw new Error(\"User not found\");\n    }\n\n    const { data: sale } = await dataProvider.update(\"sales\", {\n      id,\n      data,\n      previousData,\n    });\n    return sale;\n  },\n  isInitialized: async (): Promise<boolean> => {\n    const sales = await dataProvider.getList<Sale>(\"sales\", {\n      filter: {},\n      pagination: { page: 1, perPage: 1 },\n      sort: { field: \"id\", order: \"ASC\" },\n    });\n    if (sales.data.length === 0) {\n      return false;\n    }\n    return true;\n  },\n  updatePassword: async (id: Identifier): Promise<true> => {\n    const currentUser = await authProvider.getIdentity?.();\n    if (!currentUser) {\n      throw new Error(\"User not found\");\n    }\n    const { data: previousData } = await dataProvider.getOne<Sale>(\"sales\", {\n      id: currentUser.id,\n    });\n\n    if (!previousData) {\n      throw new Error(\"User not found\");\n    }\n\n    await dataProvider.update(\"sales\", {\n      id,\n      data: {\n        password: \"demo_newPassword\",\n      },\n      previousData,\n    });\n\n    return true;\n  },\n  mergeContacts: async (sourceId: Identifier, targetId: Identifier) => {\n    return mergeContacts(sourceId, targetId, baseDataProvider);\n  },\n};\n\nasync function updateCompany(\n  companyId: Identifier,\n  updateFn: (company: Company) => Partial<Company>,\n) {\n  const { data: company } = await dataProvider.getOne<Company>(\"companies\", {\n    id: companyId,\n  });\n\n  return await dataProvider.update(\"companies\", {\n    id: companyId,\n    data: {\n      ...updateFn(company),\n    },\n    previousData: company,\n  });\n}\n\nexport const dataProvider = withLifecycleCallbacks(\n  withSupabaseFilterAdapter(dataProviderWithCustomMethod),\n  [\n    {\n      resource: \"sales\",\n      beforeCreate: async (params) => {\n        const { data } = params;\n        // If administrator role is not set, we simply set it to false\n        if (data.administrator == null) {\n          data.administrator = false;\n        }\n        return params;\n      },\n      afterSave: async (data) => {\n        // Since the current user is stored in localStorage in fakerest authProvider\n        // we need to update it to keep information up to date in the UI\n        const currentUser = await authProvider.getIdentity?.();\n        if (currentUser?.id === data.id) {\n          localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(data));\n        }\n        return data;\n      },\n      beforeDelete: async (params) => {\n        if (params.meta?.identity?.id == null) {\n          throw new Error(\"Identity MUST be set in meta\");\n        }\n\n        const newSaleId = params.meta.identity.id as Identifier;\n\n        const [companies, contacts, contactNotes, deals] = await Promise.all([\n          dataProvider.getList(\"companies\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n          dataProvider.getList(\"contacts\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n          dataProvider.getList(\"contactNotes\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n          dataProvider.getList(\"deals\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n        ]);\n\n        await Promise.all([\n          dataProvider.updateMany(\"companies\", {\n            ids: companies.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n          dataProvider.updateMany(\"contacts\", {\n            ids: contacts.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n          dataProvider.updateMany(\"contactNotes\", {\n            ids: contactNotes.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n          dataProvider.updateMany(\"deals\", {\n            ids: deals.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n        ]);\n\n        return params;\n      },\n    } satisfies ResourceCallbacks<Sale>,\n    {\n      resource: \"contacts\",\n      beforeCreate: async (params, dataProvider) => {\n        const newParams = await processContactAvatar(params);\n        return fetchAndUpdateCompanyData(newParams, dataProvider);\n      },\n      afterCreate: async (result) => {\n        if (result.data.company_id != null) {\n          await updateCompany(result.data.company_id, (company) => ({\n            nb_contacts: (company.nb_contacts ?? 0) + 1,\n          }));\n        }\n\n        return result;\n      },\n      beforeUpdate: async (params) => {\n        const newParams = await processContactAvatar(params);\n        return fetchAndUpdateCompanyData(newParams, dataProvider);\n      },\n      afterDelete: async (result) => {\n        if (result.data.company_id != null) {\n          await updateCompany(result.data.company_id, (company) => ({\n            nb_contacts: (company.nb_contacts ?? 1) - 1,\n          }));\n        }\n\n        return result;\n      },\n    } satisfies ResourceCallbacks<Contact>,\n    {\n      resource: \"tasks\",\n      afterCreate: async (result, dataProvider) => {\n        // update the task count in the related contact\n        const { contact_id } = result.data;\n        const { data: contact } = await dataProvider.getOne(\"contacts\", {\n          id: contact_id,\n        });\n        await dataProvider.update(\"contacts\", {\n          id: contact_id,\n          data: {\n            nb_tasks: (contact.nb_tasks ?? 0) + 1,\n          },\n          previousData: contact,\n        });\n        return result;\n      },\n      beforeUpdate: async (params) => {\n        const { data, previousData } = params;\n        if (previousData.done_date !== data.done_date) {\n          taskUpdateType = data.done_date\n            ? TASK_MARKED_AS_DONE\n            : TASK_MARKED_AS_UNDONE;\n        } else {\n          taskUpdateType = TASK_DONE_NOT_CHANGED;\n        }\n        return params;\n      },\n      afterUpdate: async (result, dataProvider) => {\n        // update the contact: if the task is done, decrement the nb tasks, otherwise increment it\n        const { contact_id } = result.data;\n        const { data: contact } = await dataProvider.getOne(\"contacts\", {\n          id: contact_id,\n        });\n        if (taskUpdateType !== TASK_DONE_NOT_CHANGED) {\n          await dataProvider.update(\"contacts\", {\n            id: contact_id,\n            data: {\n              nb_tasks:\n                taskUpdateType === TASK_MARKED_AS_DONE\n                  ? (contact.nb_tasks ?? 0) - 1\n                  : (contact.nb_tasks ?? 0) + 1,\n            },\n            previousData: contact,\n          });\n        }\n        return result;\n      },\n      afterDelete: async (result, dataProvider) => {\n        // update the task count in the related contact\n        const { contact_id } = result.data;\n        const { data: contact } = await dataProvider.getOne(\"contacts\", {\n          id: contact_id,\n        });\n        await dataProvider.update(\"contacts\", {\n          id: contact_id,\n          data: {\n            nb_tasks: (contact.nb_tasks ?? 0) - 1,\n          },\n          previousData: contact,\n        });\n        return result;\n      },\n    } satisfies ResourceCallbacks<Task>,\n    {\n      resource: \"companies\",\n      beforeCreate: async (params) => {\n        const createParams = await processCompanyLogo(params);\n\n        return {\n          ...createParams,\n          data: {\n            ...createParams.data,\n            created_at: new Date().toISOString(),\n          },\n        };\n      },\n      beforeUpdate: async (params) => {\n        return await processCompanyLogo(params);\n      },\n      afterUpdate: async (result, dataProvider) => {\n        // get all contacts of the company and for each contact, update the company_name\n        const { id, name } = result.data;\n        const { data: contacts } = await dataProvider.getList(\"contacts\", {\n          filter: { company_id: id },\n          pagination: { page: 1, perPage: 1000 },\n          sort: { field: \"id\", order: \"ASC\" },\n        });\n\n        const contactIds = contacts.map((contact) => contact.id);\n        await dataProvider.updateMany(\"contacts\", {\n          ids: contactIds,\n          data: { company_name: name },\n        });\n        return result;\n      },\n    } satisfies ResourceCallbacks<Company>,\n    {\n      resource: \"deals\",\n      beforeCreate: async (params) => {\n        return {\n          ...params,\n          data: {\n            ...params.data,\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString(),\n          },\n        };\n      },\n      afterCreate: async (result) => {\n        await updateCompany(result.data.company_id, (company) => ({\n          nb_deals: (company.nb_deals ?? 0) + 1,\n        }));\n\n        return result;\n      },\n      beforeUpdate: async (params) => {\n        return {\n          ...params,\n          data: {\n            ...params.data,\n            updated_at: new Date().toISOString(),\n          },\n        };\n      },\n      afterDelete: async (result) => {\n        await updateCompany(result.data.company_id, (company) => ({\n          nb_deals: (company.nb_deals ?? 1) - 1,\n        }));\n\n        return result;\n      },\n    } satisfies ResourceCallbacks<Deal>,\n  ],\n);\n\n/**\n * Convert a `File` object returned by the upload input into a base 64 string.\n * That's not the most optimized way to store images in production, but it's\n * enough to illustrate the idea of dataprovider decoration.\n */\nconst convertFileToBase64 = (file: { rawFile: Blob }) =>\n  new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(reader.result);\n    reader.onerror = reject;\n    reader.readAsDataURL(file.rawFile);\n  });\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/authProvider.ts",
      "content": "import type { AuthProvider } from \"ra-core\";\n\nimport type { Sale } from \"../../types\";\nimport { canAccess } from \"../commons/canAccess\";\nimport { dataProvider } from \"./dataProvider\";\n\nexport const DEFAULT_USER = {\n  id: 0,\n  first_name: \"Jane\",\n  last_name: \"Doe\",\n  email: \"janedoe@atomic.dev\",\n  password: \"demo\",\n  administrator: true,\n  avatar: {\n    src: \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4gKgSUNDX1BST0ZJTEUAAQEAAAKQbGNtcwQwAABtbnRyUkdCIFhZWiAH3wAIABMAEgAWADFhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtkZXNjAAABCAAAADhjcHJ0AAABQAAAAE53dHB0AAABkAAAABRjaGFkAAABpAAAACxyWFlaAAAB0AAAABRiWFlaAAAB5AAAABRnWFlaAAAB+AAAABRyVFJDAAACDAAAACBnVFJDAAACLAAAACBiVFJDAAACTAAAACBjaHJtAAACbAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAABwAAAAcAHMAUgBHAEIAIABiAHUAaQBsAHQALQBpAG4AAG1sdWMAAAAAAAAAAQAAAAxlblVTAAAAMgAAABwATgBvACAAYwBvAHAAeQByAGkAZwBoAHQALAAgAHUAcwBlACAAZgByAGUAZQBsAHkAAAAAWFlaIAAAAAAAAPbWAAEAAAAA0y1zZjMyAAAAAAABDEoAAAXj///zKgAAB5sAAP2H///7ov///aMAAAPYAADAlFhZWiAAAAAAAABvlAAAOO4AAAOQWFlaIAAAAAAAACSdAAAPgwAAtr5YWVogAAAAAAAAYqUAALeQAAAY3nBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltwYXJhAAAAAAADAAAAAmZmAADypwAADVkAABPQAAAKW2Nocm0AAAAAAAMAAAAAo9cAAFR7AABMzQAAmZoAACZmAAAPXP/bAEMACAYGBwYFCAcHBwkJCAoMFA0MCwsMGRITDxQdGh8eHRocHCAkLicgIiwjHBwoNyksMDE0NDQfJzk9ODI8LjM0Mv/bAEMBCQkJDAsMGA0NGDIhHCEyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMv/AABEIAIAAgAMBIgACEQEDEQH/xAAcAAABBAMBAAAAAAAAAAAAAAABAAUGBwIDBAj/xAA2EAABAwMBBgMHAwQDAQAAAAABAAIDBAUREgYTITFBUSJxgRQyYZGxwdEHQqEkUmLhFRYjkv/EABoBAAIDAQEAAAAAAAAAAAAAAAIDAAEEBQb/xAAkEQACAgIDAAEEAwAAAAAAAAAAAQIRAyEEEjETBSJRcTJBYf/aAAwDAQACEQMRAD8AuIIoIogAooIqygorB72xsc97g1rRkk9FFrlfnVD3Rwu0Qj5uQyko+hRi5eEjlr6aEkOlBI6N4rSbpCG6j4R0zzPoFEIpZpn+Ahv+TuJ9E9Qtipodc0haD15ud5BI+Vsb8aXoq/a6GgJ1UsrgBknTj6rgp/1JtEkgjnbNTk9Xxkt/+m5Cbrvbam9sc2XeU9G0jTFry6Q9M/hddk/T6kpId7UwNmqJCOBOGxjoD3KLvIroiX0VxprhCJaeVr2njlpyutR+k2dlttQZ4KwMZpwIGjwD5lbI785leaSppZWHmJG+JpHfKYppgOLQ9pIAhwBHIpIwBJFJBQhgiEAiFRYQkgmzaCuNDaZHsOJHeBvmVG6VkSt0Me0l93spoqY5Y0+N3Qn8JgjdrcA3xOPU9f8AS485Jy4c8ucep/CzirNBIh4D9zz1WGU7dmyMElRIIXspeBw+fGeJ4N8/wtsEstTUtHFzz1Pb7BNVHvJQA0EAnOo83fH/AGpBR7qniw14yfekz9+qFMNxHiljYwjhqc3kTxPxwnaIZA+6ZoJWDGhjnZ68gnaEvewftHw4BOixTVGc2GsOdI4c3KFXmSuq75Rw0kQ3EWZKieQaQG8g0D4n7KauaGgiNu8eeJJPBN89JLUN8btWg5HDAL++OwUZSMbTWxV9vZNFqxyIcMEELuTdTBtNUbiP3A0D5BOC0QdozzVMWUksoIwTBFBIKEMlFdtJSIKaMHHEuKlKg+3Ly6rgizhugl3wHVLyv7WMxK5Ih8k2+IAJEecNGeLvj5LvoossDsZHl9E2x6ZZNTvDGPp2WFde45P6WlqI4tPAZIGT6rAb0vwSiOox4RgA+84nn6ruiuAhLdA1n+5x5Kt6SsrYagtqqkyuJ8Jxj+FLpIql9qM0b9GW8Ceioaoa2TigrXStDsMb8SOKeYtUgGpxLe5+wVQ2eouftIabs52T7ugHPqrOtNNX7gb+r3zSPE1zNJPljknQaehGSFDo6piax5Em7iZ78h+gXJV1OId7lzIgzIYOePyue4QvxGGs8OsAN6D/ACPfH1QinirgZmODoi4Mb5BFYlqjfSsc58kjxgkN4dua61wWWqFbb2VGCDM4uAPMN6LsJ4p+LwRlM8pZWGUU0UBFYhFUWFV/t0S67xR8muhGT8MqwFDNvKJz4IqxgyWjQ49uyXl3EbidSKxrp31VWaKnJaxoySO6aX7INZG9swlcHuD3OyMkjlxKdLWA2uqJH/3NH8KRVNWz2XJ7LCm1tHSUIyWyL0NvdC6CnBeQHjRqOSB2VwVdnd/1YwRt/wDQx8Pkq4sX9XdoXubpZrGCeo7q7i3eW0OjbqLW8B3RRjdkm+tJHn6usdbV1JY6rnpmBww5jT4QPLn6q09jLdcKBsRgv0lZSFgaaaoYXBuBza4kuB7g5HwCa6y50tRWvi3ZjeHYc1wwQVMdm42NaC3lhXBu6JkikuzHS4QuNuqCPf3biPPCqj9OdonubHa6txLyXkPJ65JH1x6K27tKYrXVPAyRE/A7nBVE7OUEtJtDSs0k6JwHO8zghMemZ6bjZcdqjZT0jo2DAY4tC68rVBHuosY4klx81sWnGqiYcjuRkllAIhGCBFBFUWFc9dSR11FLTyDLXtI8l0BJUXZRt4tNRZ7hPFI3Trw5p6HHBcEk0jgwO93l6q3tsrJ/y1oL4WZqYTqZ8R1H0VRVEDKqikgkaQRkdiCsOWHWR0+Pk7RFRzVNHXQmNwc1pHAHBVq2m+19QIzTgMhaMFsjclx+ap2wW6gn3dNXvqIpA7G+DstcB9CrVtVqsVDa4Zpa2eUmPIDS4knIzgD4FUou9Dvtqpe/oZ9qrfUR1Elw3ZDy7UeGAVKtibgKi3skzwPDj0KiV7ornc6xk8EtdTW+QhraSZ+S49SW8cAeamWzlsFupBG39ztXkotSKl/CmO21N3pbLs7U3GtL/Z4tOsMGScuAwB6qK7JUrbs1t6ex+5kOuESBoceJ4uDeGfJP+1NpO0NLSWyRgNE6cS1Rzza3iGjzOPknKCnipadkEEbY4o2hrWtGAAFojj7O2YJ5eq6oyKCywlhaTIBEJJKEMQigEVRYUViioQJAIIPVVrtzYW0FY2507cQVLtMoH7X9/X6hWVlcl0pKWvtlRTVuPZ3sOs5xpxx1A9COaDJDtGhuKbhKyjW2uT2newSuZq544g+in2ytGYpGzTPMj28WgNAwofRV0cFU6F7w5oOGudw1DoVPbRdKCBrdU0eojg1pyT6BYbr+zsd5dKRIvZN6/ey4yPhyXRTx+PDeXfssaZz6wBzssj6N6nzTiyJrAABgI1vaMrdaZp06SQTniktkvv5WtbIO4o5+RVJgwkikjAAkigVCGsJZWuSaOGMySvaxg5uccAJiqtqqeNxbSxOmP9x8I/KCU4x9DjCUvESIJuvG0Fp2fp2zXWvhpWPzo3h4uxzwBxKi1XtTcJGnS5sDe7Bx+ZVD7WX+p2gvs1TNM+VkZ3cOp2fCD9+amOayPReTG4LZaF2/XVjKmRlotTZIG5DZal5Bce+kch5lcLNqL5erSJrhXPd7SNRiYA2No6AAKocHGOqs21NJs1K3HERgfwg5T6xSQzixTk2zAtEziCn6wwbmoa4DHHoE1tgO9BA9FJLfTua0ODeK5sjpw0WFaagua0Ek+akAcC3KiNnbI0AkKTsfiLJTsb0IyrZue3U3yULuW39stV+fbKlkmmMAPmZ4sPPTCeNoL9HZbPUVbiCWN8I7novPE9TLVVktTM4ukkLnuJ6kldPg4fkk2/DncyfSKr09C2zaizXZzI6SvidM/lE7wv8AkU7rznsdUvG1Nvbk5FWz6r0O2XuPkj5EYYpJJ+isPfIm6NqCQcDySSk0/A2mvStrpepLtWu0kimYcRt+5+K1sZlqa6LmMp13ga1cuUnJ2zrQioqkM21VULfs7VzA4foLWeZ4fdUnjAHmrI/Uiv8A6OmpQffeXkfAD8lVyBlkY75K6XDhWO/yc7ly++vwGMZljGM5I+qvWlpab2eMNiDQGjgAqNb4J2EftwR6cV6Et0Daihp5WjwyRtcPUIebGkhnCabZjTWykmOHsHDkU7U9BHF7ucLXFTljuSc4W8srnUb26OmmeI2Dgt7qzIw44C1BgwmLaq7w2a0S1Dj4sYYM8S7oEyKb0hcmvWRD9S9pI6qaCz0rsiM7ydw79B6c/kq/Mni7cM/RYmd9XUyVEpJe4l7s9StD3nWT105+y9NxsXw4lE8/nyfLkch32Lk07X21zjw3+r5L0HHUa25yvPWxzc7YW9nYk/wVdrKgsAHRcn6lKpx/R0+BG4N/6P8AFL4hxTg2IvZkc1HqSoy8EqUUUgfGFjxt3o0ZUq2f/9k=\",\n  },\n} as const;\n\nexport const USER_STORAGE_KEY = \"user\";\n\nlocalStorage.setItem(USER_STORAGE_KEY, JSON.stringify({ ...DEFAULT_USER }));\n\nasync function getUser(email: string) {\n  const sales = await dataProvider.getList(\"sales\", {\n    pagination: { page: 1, perPage: 200 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  if (!sales.data.length) {\n    return { ...DEFAULT_USER };\n  }\n\n  const user = sales.data.find((sale) => sale.email === email);\n  if (!user || user.disabled) {\n    return { ...DEFAULT_USER };\n  }\n  return user;\n}\n\nexport const authProvider: AuthProvider = {\n  login: async ({ email }) => {\n    const user = await getUser(email);\n    localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(user));\n    return Promise.resolve();\n  },\n  logout: () => {\n    localStorage.removeItem(USER_STORAGE_KEY);\n    return Promise.resolve();\n  },\n  checkError: () => Promise.resolve(),\n  checkAuth: () =>\n    localStorage.getItem(USER_STORAGE_KEY)\n      ? Promise.resolve()\n      : Promise.reject(),\n  canAccess: async ({ signal: _signal, ...params }) => {\n    // Get the current user\n    const userItem = localStorage.getItem(USER_STORAGE_KEY);\n    const localUser = userItem ? (JSON.parse(userItem) as Sale) : null;\n    if (!localUser) return false;\n\n    // Compute access rights from the sale role\n    const role = localUser.administrator ? \"admin\" : \"user\";\n    return canAccess(role, params);\n  },\n  getIdentity: () => {\n    const userItem = localStorage.getItem(USER_STORAGE_KEY);\n    const user = userItem ? (JSON.parse(userItem) as Sale) : null;\n    return Promise.resolve({\n      id: user?.id ?? 0,\n      fullName: user ? `${user.first_name} ${user.last_name}` : \"Jane Doe\",\n      avatar: user?.avatar?.src,\n    });\n  },\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformOrFilter.ts",
      "content": "import isObject from \"lodash/isObject\";\n\n// @or filter is an equivaluent of fakerest `q=`\nexport function transformOrFilter(values: any) {\n  if (!isObject(values) || Array.isArray(values)) {\n    throw new Error(\n      \"Invalid '@or' filter, expected an object as first element\",\n    );\n  }\n\n  const queries = Object.values(values);\n  if (queries.length === 0) {\n    throw new Error(\"Invalid '@or' filter, object is empty\");\n  }\n\n  return queries[0];\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformOrFilter.spec.ts",
      "content": "import { transformOrFilter } from \"./transformOrFilter\";\n\nit(\"should throw an error if the value is not an object\", () => {\n  expect(() => transformOrFilter([])).toThrow(\n    \"Invalid '@or' filter, expected an object\",\n  );\n});\n\nit(\"should throw an error if the object is empty\", () => {\n  expect(() => transformOrFilter({})).toThrow(\n    \"Invalid '@or' filter, object is empty\",\n  );\n});\n\nit(\"should return the query value\", () => {\n  expect(transformOrFilter({ \"last_name@ilike\": \"one\" })).toEqual(\"one\");\n  expect(\n    transformOrFilter({\n      \"last_name@ilike\": \"one\",\n      \"first_name@ilike\": \"one\",\n    }),\n  ).toEqual(\"one\");\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformInFilter.ts",
      "content": "import { LIST_REGEX_BASE, parseList } from \"./listParser\";\n\nexport const IN_FILTER_REGEX = new RegExp(`^\\\\(${LIST_REGEX_BASE}\\\\)$`);\n\nexport function transformInFilter(value: any) {\n  if (value === \"()\") {\n    return [];\n  }\n\n  if (typeof value !== \"string\" || !value.match(IN_FILTER_REGEX)) {\n    throw new Error(\n      `Invalid '@in' filter value, expected a string matching '${IN_FILTER_REGEX.source}', got: ${value}`,\n    );\n  }\n\n  return parseList(value.slice(1, -1));\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformInFilter.spec.ts",
      "content": "import { IN_FILTER_REGEX, transformInFilter } from \"./transformInFilter\";\n\nit(\"should throw an error if the filter is not a string\", () => {\n  expect(() => transformInFilter(1)).toThrow(\n    `Invalid '@in' filter value, expected a string matching '${IN_FILTER_REGEX.source}', got: 1`,\n  );\n});\n\nit(\"should throw an error if the filter does not match pattern\", () => {\n  expect(() => transformInFilter(\"1,2\")).toThrow(\n    `Invalid '@in' filter value, expected a string matching '${IN_FILTER_REGEX.source}', got: 1,2`,\n  );\n});\n\nit(\"should support empty arrays\", () => {\n  expect(transformInFilter(\"()\")).toEqual([]);\n});\n\nit(\"should return an array of numbers\", () => {\n  expect(transformInFilter(\"(1)\")).toEqual([1]);\n  expect(transformInFilter(\"(1,2,3)\")).toEqual([1, 2, 3]);\n});\n\nit(\"should return an array of strings\", () => {\n  expect(transformInFilter(\"(a)\")).toEqual([\"a\"]);\n  expect(transformInFilter(\"(a,B,c-d)\")).toEqual([\"a\", \"B\", \"c-d\"]);\n});\n\nit(\"should return an array of quoted strings\", () => {\n  expect(transformInFilter('(\"a\")')).toEqual([\"a\"]);\n  expect(transformInFilter('(\"a\",\"B, c\")')).toEqual([\"a\", \"B, c\"]);\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformFilter.ts",
      "content": "import { transformContainsFilter } from \"./transformContainsFilter\";\nimport { transformInFilter } from \"./transformInFilter\";\nimport { transformOrFilter } from \"./transformOrFilter\";\n\nexport function transformFilter(filter: Record<string, any>) {\n  if (!filter) {\n    return undefined;\n  }\n  const transformedFilters: Record<string, any> = {};\n  for (const [key, value] of Object.entries(filter)) {\n    if (\n      key.endsWith(\"@eq\") ||\n      key.endsWith(\"@neq\") ||\n      key.endsWith(\"@lt\") ||\n      key.endsWith(\"@lte\") ||\n      key.endsWith(\"@gt\") ||\n      key.endsWith(\"@gte\")\n    ) {\n      const lastIndexOfAt = key.lastIndexOf(\"@\");\n      transformedFilters[\n        `${key.substring(0, lastIndexOfAt)}_${key.substring(lastIndexOfAt + 1)}`\n      ] = value;\n      continue;\n    }\n\n    if (key.endsWith(\"@is\")) {\n      transformedFilters[`${key.slice(0, -3)}_eq`] = value;\n      continue;\n    }\n\n    if (key.endsWith(\"@not.is\")) {\n      transformedFilters[`${key.slice(0, -7)}_neq`] = value;\n      continue;\n    }\n\n    if (key.endsWith(\"@in\")) {\n      transformedFilters[`${key.slice(0, -3)}_eq_any`] =\n        transformInFilter(value);\n      continue;\n    }\n\n    if (key.endsWith(\"@cs\")) {\n      transformedFilters[`${key.slice(0, -3)}`] =\n        transformContainsFilter(value);\n      continue;\n    }\n\n    // Search query\n    if (key.endsWith(\"@or\")) {\n      transformedFilters[\"q\"] = transformOrFilter(value);\n      continue;\n    }\n\n    transformedFilters[key] = value;\n  }\n  return transformedFilters;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformContainsFilter.ts",
      "content": "import { LIST_REGEX_BASE, parseList } from \"./listParser\";\n\nexport const CONTAINS_FILTER_REGEX = new RegExp(`^\\\\{${LIST_REGEX_BASE}\\\\}$`);\n\nexport function transformContainsFilter(value: any) {\n  if (value === \"{}\") {\n    return [];\n  }\n\n  if (typeof value !== \"string\" || !value.match(CONTAINS_FILTER_REGEX)) {\n    throw new Error(\n      `Invalid '@cs' filter value, expected a string matching '${CONTAINS_FILTER_REGEX.source}', got: ${value}`,\n    );\n  }\n\n  return parseList(value.slice(1, -1));\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformContainsFilter.spec.ts",
      "content": "import {\n  CONTAINS_FILTER_REGEX,\n  transformContainsFilter,\n} from \"./transformContainsFilter\";\n\nit(\"should throw an error if the filter is not a string\", () => {\n  expect(() => transformContainsFilter(1)).toThrow(\n    `Invalid '@cs' filter value, expected a string matching '${CONTAINS_FILTER_REGEX.source}', got: 1`,\n  );\n});\n\nit(\"should throw an error if the filter does not match pattern\", () => {\n  expect(() => transformContainsFilter(\"1,2\")).toThrow(\n    `Invalid '@cs' filter value, expected a string matching '${CONTAINS_FILTER_REGEX.source}', got: 1,2`,\n  );\n});\n\nit(\"should support empty arrays\", () => {\n  expect(transformContainsFilter(\"{}\")).toEqual([]);\n});\n\nit(\"should return an array of numbers\", () => {\n  expect(transformContainsFilter(\"{1}\")).toEqual([1]);\n  expect(transformContainsFilter(\"{1,2,3}\")).toEqual([1, 2, 3]);\n});\n\nit(\"should return an array of strings\", () => {\n  expect(transformContainsFilter(\"{a}\")).toEqual([\"a\"]);\n  expect(transformContainsFilter(\"{a,B,c-d}\")).toEqual([\"a\", \"B\", \"c-d\"]);\n});\n\nit(\"should return an array of quoted strings\", () => {\n  expect(transformContainsFilter('{\"a\"}')).toEqual([\"a\"]);\n  expect(transformContainsFilter('{\"a\",\"B, c\"}')).toEqual([\"a\", \"B, c\"]);\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/supabaseAdapter.ts",
      "content": "import type { DataProvider } from \"ra-core\";\nimport { transformFilter } from \"./transformFilter\";\n\nfunction removeSummarySuffix(resource: string) {\n  return resource.endsWith(\"_summary\")\n    ? resource.replace(\"_summary\", \"\")\n    : resource;\n}\n\nexport function withSupabaseFilterAdapter<T extends DataProvider>(\n  dataProvider: T,\n): T {\n  return {\n    ...dataProvider,\n    getOne(resource, params) {\n      return dataProvider.getOne(removeSummarySuffix(resource), params);\n    },\n    getList(resource, params) {\n      return dataProvider.getList(removeSummarySuffix(resource), {\n        ...params,\n        filter: transformFilter(params.filter),\n      });\n    },\n    getMany(resource, params) {\n      return dataProvider.getMany(removeSummarySuffix(resource), params);\n    },\n    getManyReference(resource, params) {\n      return dataProvider.getManyReference(removeSummarySuffix(resource), {\n        ...params,\n        filter: transformFilter(params.filter),\n      });\n    },\n    create(resource, params) {\n      return dataProvider.create(removeSummarySuffix(resource), params);\n    },\n    delete(resource, params) {\n      return dataProvider.delete(removeSummarySuffix(resource), params);\n    },\n    deleteMany(resource, params) {\n      return dataProvider.deleteMany(removeSummarySuffix(resource), params);\n    },\n    update(resource, params) {\n      return dataProvider.update(removeSummarySuffix(resource), params);\n    },\n    updateMany(resource, params) {\n      return dataProvider.updateMany(removeSummarySuffix(resource), params);\n    },\n  };\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/supabaseAdapter.spec.ts",
      "content": "import type { DataProvider } from \"ra-core\";\nimport { withSupabaseFilterAdapter } from \"./supabaseAdapter\";\n\ndescribe(\"getList\", () => {\n  it(\"should transform '@eq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@eq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_eq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@neq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@neq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_neq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@eq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@eq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_eq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@neq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@neq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_neq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@is'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"id@is\": null } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id_eq: null },\n    });\n  });\n\n  it(\"should transform '@not.is'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"id@not.is\": null } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id_neq: null },\n    });\n  });\n\n  it(\"should transform '@lt'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@lt\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_lt\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@lte'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@lte\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_lte\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@gt'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@gt\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_gt\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@gte'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@gte\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_gte\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@in'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"id@in\": \"(1,2,a)\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id_eq_any: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@cs'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"tags@cs\": \"{1,2,a}\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { tags: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@or'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", {\n        filter: { \"@or\": { last_name: \"one\" } },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { q: \"one\" },\n    });\n  });\n\n  it(\"should not transform a filter without operator\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(getListAdapter(\"resource\", { filter: { id: 1 } })).resolves.toEqual([\n      { id: 1 },\n    ]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id: 1 },\n    });\n  });\n});\n\ndescribe(\"getManyReference\", () => {\n  it(\"should transform @eq\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@eq\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_eq\": \"2\" },\n    });\n  });\n\n  it(\"should transform @neq\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@neq\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_neq\": \"2\" },\n    });\n  });\n\n  it(\"should transform @is\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"id@is\": null },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id_eq: null },\n    });\n  });\n\n  it(\"should transform @not.is\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"id@not.is\": null },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id_neq: null },\n    });\n  });\n\n  it(\"should transform @lt\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@lt\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_lt\": \"2\" },\n    });\n  });\n\n  it(\"should transform @lte\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@lte\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_lte\": \"2\" },\n    });\n  });\n\n  it(\"should transform @gt\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@gt\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_gt\": \"2\" },\n    });\n  });\n\n  it(\"should transform @gte\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@gte\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_gte\": \"2\" },\n    });\n  });\n\n  it(\"should transform '@in'\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"id@in\": \"(1,2,a)\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id_eq_any: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@cs'\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"tags@cs\": \"{1,2,a}\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { tags: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@or'\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"@or\": { last_name: \"one\" } },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { q: \"one\" },\n    });\n  });\n\n  it(\"should not transform a filter without operator\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { id: 2 },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id: 2 },\n    });\n  });\n});\n\nit(\"should remove summary suffix\", () => {\n  const getOne = vi.fn();\n  const getList = vi.fn();\n  const getMany = vi.fn();\n  const getManyReference = vi.fn();\n  const create = vi.fn();\n  const del = vi.fn();\n  const deleteMany = vi.fn();\n  const update = vi.fn();\n  const updateMany = vi.fn();\n\n  const dataProvider: DataProvider = withSupabaseFilterAdapter({\n    getOne,\n    getList,\n    getMany,\n    getManyReference,\n    create,\n    delete: del,\n    deleteMany,\n    update,\n    updateMany,\n  });\n\n  expect(\n    Promise.all([\n      dataProvider.getOne(\"resource_summary\", { id: 1 }),\n      dataProvider.getList(\"resource_summary\", {\n        pagination: { page: 1, perPage: 10 },\n      }),\n      dataProvider.getMany(\"resource_summary\", { ids: [1] }),\n      dataProvider.getManyReference(\"resource_summary\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: {},\n      }),\n      dataProvider.create(\"resource_summary\", { data: {} }),\n      dataProvider.delete(\"resource_summary\", { id: 1 }),\n      dataProvider.deleteMany(\"resource_summary\", { ids: [1] }),\n      dataProvider.update(\"resource_summary\", {\n        id: 1,\n        data: {},\n        previousData: {},\n      }),\n      dataProvider.updateMany(\"resource_summary\", { ids: [1], data: {} }),\n    ]),\n  ).resolves.toHaveLength(9);\n\n  expect(getOne).toHaveBeenCalledWith(\"resource\", { id: 1 });\n  expect(getList).toHaveBeenCalledWith(\"resource\", {\n    pagination: { page: 1, perPage: 10 },\n    filter: undefined,\n  });\n  expect(getMany).toHaveBeenCalledWith(\"resource\", { ids: [1] });\n  expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n    id: 1,\n    target: \"target\",\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"id\", order: \"ASC\" },\n    filter: {},\n  });\n  expect(create).toHaveBeenCalledWith(\"resource\", { data: {} });\n  expect(del).toHaveBeenCalledWith(\"resource\", { id: 1 });\n  expect(deleteMany).toHaveBeenCalledWith(\"resource\", { ids: [1] });\n  expect(update).toHaveBeenCalledWith(\"resource\", {\n    id: 1,\n    data: {},\n    previousData: {},\n  });\n  expect(updateMany).toHaveBeenCalledWith(\"resource\", { ids: [1], data: {} });\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/listParser.ts",
      "content": "export const UNQUOTED_ALLOWED_CHARS = \"[A-Za-z---0-9-]+\";\nexport const QUOTED_ALLOWED_CHARS = \"[A-Za-z---0-9, -]+\";\nexport const LIST_REGEX_BASE = `(${UNQUOTED_ALLOWED_CHARS}|\"${QUOTED_ALLOWED_CHARS}\")(,(${UNQUOTED_ALLOWED_CHARS}|\"${QUOTED_ALLOWED_CHARS}\"))*`;\n\n/**\n * List represents a list of values, quoted or not.\n *\n * e.g. 1\n * e.g 1,2\n * e.g \"a\",\"b\"\n * e.g \"a\",b\n */\nexport function parseList(list: string) {\n  const parsedItems = [];\n\n  let currentItem = \"\";\n  let currentQuoted = false;\n  for (const char of list) {\n    if (char === \",\") {\n      if (currentQuoted) {\n        currentItem += char;\n        continue;\n      }\n\n      parsedItems.push(currentItem);\n      currentItem = \"\";\n      continue;\n    }\n\n    if (char === '\"') {\n      currentQuoted = !currentQuoted;\n      continue;\n    }\n\n    currentItem += char;\n  }\n  if (currentItem) {\n    parsedItems.push(currentItem);\n  }\n\n  return parsedItems.map((v: string) => {\n    const parsedFloat = Number.parseFloat(v);\n    if (!Number.isNaN(parsedFloat)) {\n      return parsedFloat;\n    }\n    return v;\n  });\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/utils.ts",
      "content": "import faker from \"faker/locale/en\";\n\nexport const weightedArrayElement = (values: any[], weights: any) =>\n  faker.random.arrayElement(\n    values.reduce(\n      (acc, value, index) => acc.concat(new Array(weights[index]).fill(value)),\n      [],\n    ),\n  );\n\nexport const weightedBoolean = (likelyhood: number) =>\n  faker.datatype.number(99) < likelyhood;\n\nexport const randomDate = (minDate?: Date, maxDate?: Date) => {\n  const minTs =\n    minDate instanceof Date\n      ? minDate.getTime()\n      : Date.now() - 5 * 365 * 24 * 60 * 60 * 1000; // 5 years\n  const maxTs = maxDate instanceof Date ? maxDate.getTime() : Date.now();\n  const range = maxTs - minTs;\n  const randomRange = faker.datatype.number({ max: range });\n  // move it more towards today to account for traffic increase\n  const ts = Math.sqrt(randomRange / range) * range;\n  return new Date(minTs + ts);\n};\n\nexport const randomFloat = (min: number, max: number) =>\n  parseFloat(faker.datatype.number({ min, max, precision: 0.01 }).toFixed(2));\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/types.ts",
      "content": "import type {\n  Company,\n  Contact,\n  ContactNote,\n  Deal,\n  DealNote,\n  Sale,\n  Tag,\n  Task,\n} from \"../../../types\";\n\nexport interface Db {\n  companies: Required<Company>[];\n  contacts: Required<Contact>[];\n  contactNotes: ContactNote[];\n  deals: Deal[];\n  dealNotes: DealNote[];\n  sales: Sale[];\n  tags: Tag[];\n  tasks: Task[];\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/tasks.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport { defaultTaskTypes } from \"../../../root/defaultConfiguration\";\nimport type { Task } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\ntype TaskType = (typeof defaultTaskTypes)[number];\n\nexport const type: TaskType[] = [\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Demo\",\n  \"Lunch\",\n  \"Meeting\",\n  \"Follow-up\",\n  \"Follow-up\",\n  \"Thank you\",\n  \"Ship\",\n  \"None\",\n];\n\nexport const generateTasks = (db: Db) => {\n  return Array.from(Array(400).keys()).map<Task>((id) => {\n    const contact = random.arrayElement(db.contacts);\n    contact.nb_tasks++;\n    return {\n      id,\n      contact_id: contact.id,\n      type: random.arrayElement(defaultTaskTypes),\n      text: lorem.sentence(),\n      due_date: randomDate(\n        datatype.boolean() ? new Date() : new Date(contact.first_seen),\n        new Date(Date.now() + 100 * 24 * 60 * 60 * 1000),\n      ).toISOString(),\n      done_date: undefined,\n      sales_id: 0,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/tags.ts",
      "content": "import type { Db } from \"./types\";\n\nconst tags = [\n  { id: 0, name: \"football-fan\", color: \"#eddcd2\" },\n  { id: 1, name: \"holiday-card\", color: \"#fff1e6\" },\n  { id: 2, name: \"influencer\", color: \"#fde2e4\" },\n  { id: 3, name: \"manager\", color: \"#fad2e1\" },\n  { id: 4, name: \"musician\", color: \"#c5dedd\" },\n  { id: 5, name: \"vip\", color: \"#dbe7e4\" },\n];\n\nexport const generateTags = (_: Db) => {\n  return [...tags];\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/sales.ts",
      "content": "import { internet, name } from \"faker/locale/en_US\";\n\nimport type { RAFile, Sale } from \"../../../types\";\nimport type { Db } from \"./types\";\n\nexport const generateSales = (_: Db): Sale[] => {\n  const randomSales = Array.from(Array(5).keys()).map((id) => {\n    const first_name = name.firstName();\n    const last_name = name.lastName();\n    const email = internet.email(first_name, last_name);\n\n    return {\n      id: id + 1,\n      user_id: `${id + 1}`,\n      first_name,\n      last_name,\n      email,\n      password: \"demo\",\n      administrator: false,\n    };\n  });\n  return [\n    {\n      id: 0,\n      user_id: \"0\",\n      first_name: \"Jane\",\n      last_name: \"Doe\",\n      email: \"janedoe@atomic.dev\",\n      password: \"demo\",\n      administrator: true,\n      avatar: {\n        src: \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4gKgSUNDX1BST0ZJTEUAAQEAAAKQbGNtcwQwAABtbnRyUkdCIFhZWiAH3wAIABMAEgAWADFhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtkZXNjAAABCAAAADhjcHJ0AAABQAAAAE53dHB0AAABkAAAABRjaGFkAAABpAAAACxyWFlaAAAB0AAAABRiWFlaAAAB5AAAABRnWFlaAAAB+AAAABRyVFJDAAACDAAAACBnVFJDAAACLAAAACBiVFJDAAACTAAAACBjaHJtAAACbAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAABwAAAAcAHMAUgBHAEIAIABiAHUAaQBsAHQALQBpAG4AAG1sdWMAAAAAAAAAAQAAAAxlblVTAAAAMgAAABwATgBvACAAYwBvAHAAeQByAGkAZwBoAHQALAAgAHUAcwBlACAAZgByAGUAZQBsAHkAAAAAWFlaIAAAAAAAAPbWAAEAAAAA0y1zZjMyAAAAAAABDEoAAAXj///zKgAAB5sAAP2H///7ov///aMAAAPYAADAlFhZWiAAAAAAAABvlAAAOO4AAAOQWFlaIAAAAAAAACSdAAAPgwAAtr5YWVogAAAAAAAAYqUAALeQAAAY3nBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltwYXJhAAAAAAADAAAAAmZmAADypwAADVkAABPQAAAKW2Nocm0AAAAAAAMAAAAAo9cAAFR7AABMzQAAmZoAACZmAAAPXP/bAEMACAYGBwYFCAcHBwkJCAoMFA0MCwsMGRITDxQdGh8eHRocHCAkLicgIiwjHBwoNyksMDE0NDQfJzk9ODI8LjM0Mv/bAEMBCQkJDAsMGA0NGDIhHCEyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMv/AABEIAIAAgAMBIgACEQEDEQH/xAAcAAABBAMBAAAAAAAAAAAAAAABAAUGBwIDBAj/xAA2EAABAwMBBgMHAwQDAQAAAAABAAIDBAUREgYTITFBUSJxgRQyYZGxwdEHQqEkUmLhFRYjkv/EABoBAAIDAQEAAAAAAAAAAAAAAAIDAAEEBQb/xAAkEQACAgIDAAEEAwAAAAAAAAAAAQIRAyEEEjETBSJRcTJBYf/aAAwDAQACEQMRAD8AuIIoIogAooIqygorB72xsc97g1rRkk9FFrlfnVD3Rwu0Qj5uQyko+hRi5eEjlr6aEkOlBI6N4rSbpCG6j4R0zzPoFEIpZpn+Ahv+TuJ9E9Qtipodc0haD15ud5BI+Vsb8aXoq/a6GgJ1UsrgBknTj6rgp/1JtEkgjnbNTk9Xxkt/+m5Cbrvbam9sc2XeU9G0jTFry6Q9M/hddk/T6kpId7UwNmqJCOBOGxjoD3KLvIroiX0VxprhCJaeVr2njlpyutR+k2dlttQZ4KwMZpwIGjwD5lbI785leaSppZWHmJG+JpHfKYppgOLQ9pIAhwBHIpIwBJFJBQhgiEAiFRYQkgmzaCuNDaZHsOJHeBvmVG6VkSt0Me0l93spoqY5Y0+N3Qn8JgjdrcA3xOPU9f8AS485Jy4c8ucep/CzirNBIh4D9zz1WGU7dmyMElRIIXspeBw+fGeJ4N8/wtsEstTUtHFzz1Pb7BNVHvJQA0EAnOo83fH/AGpBR7qniw14yfekz9+qFMNxHiljYwjhqc3kTxPxwnaIZA+6ZoJWDGhjnZ68gnaEvewftHw4BOixTVGc2GsOdI4c3KFXmSuq75Rw0kQ3EWZKieQaQG8g0D4n7KauaGgiNu8eeJJPBN89JLUN8btWg5HDAL++OwUZSMbTWxV9vZNFqxyIcMEELuTdTBtNUbiP3A0D5BOC0QdozzVMWUksoIwTBFBIKEMlFdtJSIKaMHHEuKlKg+3Ly6rgizhugl3wHVLyv7WMxK5Ih8k2+IAJEecNGeLvj5LvoossDsZHl9E2x6ZZNTvDGPp2WFde45P6WlqI4tPAZIGT6rAb0vwSiOox4RgA+84nn6ruiuAhLdA1n+5x5Kt6SsrYagtqqkyuJ8Jxj+FLpIql9qM0b9GW8Ceioaoa2TigrXStDsMb8SOKeYtUgGpxLe5+wVQ2eouftIabs52T7ugHPqrOtNNX7gb+r3zSPE1zNJPljknQaehGSFDo6piax5Em7iZ78h+gXJV1OId7lzIgzIYOePyue4QvxGGs8OsAN6D/ACPfH1QinirgZmODoi4Mb5BFYlqjfSsc58kjxgkN4dua61wWWqFbb2VGCDM4uAPMN6LsJ4p+LwRlM8pZWGUU0UBFYhFUWFV/t0S67xR8muhGT8MqwFDNvKJz4IqxgyWjQ49uyXl3EbidSKxrp31VWaKnJaxoySO6aX7INZG9swlcHuD3OyMkjlxKdLWA2uqJH/3NH8KRVNWz2XJ7LCm1tHSUIyWyL0NvdC6CnBeQHjRqOSB2VwVdnd/1YwRt/wDQx8Pkq4sX9XdoXubpZrGCeo7q7i3eW0OjbqLW8B3RRjdkm+tJHn6usdbV1JY6rnpmBww5jT4QPLn6q09jLdcKBsRgv0lZSFgaaaoYXBuBza4kuB7g5HwCa6y50tRWvi3ZjeHYc1wwQVMdm42NaC3lhXBu6JkikuzHS4QuNuqCPf3biPPCqj9OdonubHa6txLyXkPJ65JH1x6K27tKYrXVPAyRE/A7nBVE7OUEtJtDSs0k6JwHO8zghMemZ6bjZcdqjZT0jo2DAY4tC68rVBHuosY4klx81sWnGqiYcjuRkllAIhGCBFBFUWFc9dSR11FLTyDLXtI8l0BJUXZRt4tNRZ7hPFI3Trw5p6HHBcEk0jgwO93l6q3tsrJ/y1oL4WZqYTqZ8R1H0VRVEDKqikgkaQRkdiCsOWHWR0+Pk7RFRzVNHXQmNwc1pHAHBVq2m+19QIzTgMhaMFsjclx+ap2wW6gn3dNXvqIpA7G+DstcB9CrVtVqsVDa4Zpa2eUmPIDS4knIzgD4FUou9Dvtqpe/oZ9qrfUR1Elw3ZDy7UeGAVKtibgKi3skzwPDj0KiV7ornc6xk8EtdTW+QhraSZ+S49SW8cAeamWzlsFupBG39ztXkotSKl/CmO21N3pbLs7U3GtL/Z4tOsMGScuAwB6qK7JUrbs1t6ex+5kOuESBoceJ4uDeGfJP+1NpO0NLSWyRgNE6cS1Rzza3iGjzOPknKCnipadkEEbY4o2hrWtGAAFojj7O2YJ5eq6oyKCywlhaTIBEJJKEMQigEVRYUViioQJAIIPVVrtzYW0FY2507cQVLtMoH7X9/X6hWVlcl0pKWvtlRTVuPZ3sOs5xpxx1A9COaDJDtGhuKbhKyjW2uT2newSuZq544g+in2ytGYpGzTPMj28WgNAwofRV0cFU6F7w5oOGudw1DoVPbRdKCBrdU0eojg1pyT6BYbr+zsd5dKRIvZN6/ey4yPhyXRTx+PDeXfssaZz6wBzssj6N6nzTiyJrAABgI1vaMrdaZp06SQTniktkvv5WtbIO4o5+RVJgwkikjAAkigVCGsJZWuSaOGMySvaxg5uccAJiqtqqeNxbSxOmP9x8I/KCU4x9DjCUvESIJuvG0Fp2fp2zXWvhpWPzo3h4uxzwBxKi1XtTcJGnS5sDe7Bx+ZVD7WX+p2gvs1TNM+VkZ3cOp2fCD9+amOayPReTG4LZaF2/XVjKmRlotTZIG5DZal5Bce+kch5lcLNqL5erSJrhXPd7SNRiYA2No6AAKocHGOqs21NJs1K3HERgfwg5T6xSQzixTk2zAtEziCn6wwbmoa4DHHoE1tgO9BA9FJLfTua0ODeK5sjpw0WFaagua0Ek+akAcC3KiNnbI0AkKTsfiLJTsb0IyrZue3U3yULuW39stV+fbKlkmmMAPmZ4sPPTCeNoL9HZbPUVbiCWN8I7novPE9TLVVktTM4ukkLnuJ6kldPg4fkk2/DncyfSKr09C2zaizXZzI6SvidM/lE7wv8AkU7rznsdUvG1Nvbk5FWz6r0O2XuPkj5EYYpJJ+isPfIm6NqCQcDySSk0/A2mvStrpepLtWu0kimYcRt+5+K1sZlqa6LmMp13ga1cuUnJ2zrQioqkM21VULfs7VzA4foLWeZ4fdUnjAHmrI/Uiv8A6OmpQffeXkfAD8lVyBlkY75K6XDhWO/yc7ly++vwGMZljGM5I+qvWlpab2eMNiDQGjgAqNb4J2EftwR6cV6Et0Daihp5WjwyRtcPUIebGkhnCabZjTWykmOHsHDkU7U9BHF7ucLXFTljuSc4W8srnUb26OmmeI2Dgt7qzIw44C1BgwmLaq7w2a0S1Dj4sYYM8S7oEyKb0hcmvWRD9S9pI6qaCz0rsiM7ydw79B6c/kq/Mni7cM/RYmd9XUyVEpJe4l7s9StD3nWT105+y9NxsXw4lE8/nyfLkch32Lk07X21zjw3+r5L0HHUa25yvPWxzc7YW9nYk/wVdrKgsAHRcn6lKpx/R0+BG4N/6P8AFL4hxTg2IvZkc1HqSoy8EqUUUgfGFjxt3o0ZUq2f/9k=\",\n      } as RAFile,\n    },\n    ...randomSales,\n  ];\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/index.ts",
      "content": "import { generateCompanies } from \"./companies\";\nimport { generateContactNotes } from \"./contactNotes\";\nimport { generateContacts } from \"./contacts\";\nimport { generateDealNotes } from \"./dealNotes\";\nimport { generateDeals } from \"./deals\";\nimport { finalize } from \"./finalize\";\nimport { generateSales } from \"./sales\";\nimport { generateTags } from \"./tags\";\nimport { generateTasks } from \"./tasks\";\nimport type { Db } from \"./types\";\n\nexport default (): Db => {\n  const db = {} as Db;\n  db.sales = generateSales(db);\n  db.tags = generateTags(db);\n  db.companies = generateCompanies(db);\n  db.contacts = generateContacts(db);\n  db.contactNotes = generateContactNotes(db);\n  db.deals = generateDeals(db);\n  db.dealNotes = generateDealNotes(db);\n  db.tasks = generateTasks(db);\n  finalize(db);\n\n  return db;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/finalize.ts",
      "content": "import type { Db } from \"./types\";\n\nexport const finalize = (db: Db) => {\n  // set contact status according to the latest note\n  db.contactNotes\n    .sort((a, b) => new Date(a.date).valueOf() - new Date(b.date).valueOf())\n    .forEach((note) => {\n      db.contacts[note.contact_id as number].status = note.status;\n    });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/deals.ts",
      "content": "import { add } from \"date-fns\";\nimport { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport {\n  defaultDealCategories,\n  defaultDealStages,\n} from \"../../../root/defaultConfiguration\";\nimport type { Deal } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateDeals = (db: Db): Deal[] => {\n  const deals = Array.from(Array(50).keys()).map((id) => {\n    const company = random.arrayElement(db.companies);\n    company.nb_deals++;\n    const contacts = random.arrayElements(\n      db.contacts.filter((contact) => contact.company_id === company.id),\n      datatype.number({ min: 1, max: 3 }),\n    );\n    const lowercaseName = lorem.words();\n    const created_at = randomDate(new Date(company.created_at)).toISOString();\n\n    const expected_closing_date = randomDate(\n      new Date(created_at),\n      add(new Date(created_at), { months: 6 }),\n    ).toISOString();\n\n    return {\n      id,\n      name: lowercaseName[0].toUpperCase() + lowercaseName.slice(1),\n      company_id: company.id,\n      contact_ids: contacts.map((contact) => contact.id),\n      category: random.arrayElement(defaultDealCategories),\n      stage: random.arrayElement(defaultDealStages).value,\n      description: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      amount: datatype.number(1000) * 100,\n      created_at,\n      updated_at: randomDate(new Date(created_at)).toISOString(),\n      expected_closing_date,\n      sales_id: company.sales_id,\n      index: 0,\n    };\n  });\n  // compute index based on stage\n  defaultDealStages.forEach((stage) => {\n    deals\n      .filter((deal) => deal.stage === stage.value)\n      .forEach((deal, index) => {\n        deals[deal.id].index = index;\n      });\n  });\n  return deals;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/dealNotes.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateDealNotes = (db: Db) => {\n  return Array.from(Array(300).keys()).map((id) => {\n    const deal = random.arrayElement(db.deals);\n    return {\n      id,\n      deal_id: deal.id,\n      text: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      date: randomDate(\n        new Date(db.deals[deal.id as number].created_at),\n      ).toISOString(),\n      sales_id: deal.sales_id,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/contacts.ts",
      "content": "import {\n  company as fakerCompany,\n  internet,\n  lorem,\n  name,\n  phone,\n  random,\n} from \"faker/locale/en_US\";\n\nimport {\n  defaultContactGender,\n  defaultNoteStatuses,\n} from \"../../../root/defaultConfiguration\";\nimport type { Company, Contact } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate, weightedBoolean } from \"./utils\";\n\nconst maxContacts = {\n  1: 1,\n  10: 4,\n  50: 12,\n  250: 25,\n  500: 50,\n};\n\nconst getRandomContactDetailsType = () =>\n  random.arrayElement([\"Work\", \"Home\", \"Other\"]) as \"Work\" | \"Home\" | \"Other\";\n\nexport const generateContacts = (db: Db, size = 500): Required<Contact>[] => {\n  const nbAvailblePictures = 223;\n  let numberOfContacts = 0;\n\n  return Array.from(Array(size).keys()).map((id) => {\n    const has_avatar =\n      weightedBoolean(25) && numberOfContacts < nbAvailblePictures;\n    const gender = random.arrayElement(defaultContactGender).value;\n    const first_name = name.firstName(gender as any);\n    const last_name = name.lastName();\n    const email_jsonb = [\n      {\n        email: internet.email(first_name, last_name),\n        type: getRandomContactDetailsType(),\n      },\n    ];\n    const phone_jsonb = [\n      {\n        number: phone.phoneNumber(),\n        type: getRandomContactDetailsType(),\n      },\n      {\n        number: phone.phoneNumber(),\n        type: getRandomContactDetailsType(),\n      },\n    ];\n    const avatar = {\n      src: has_avatar\n        ? \"https://marmelab.com/posters/avatar-\" +\n          (223 - numberOfContacts) +\n          \".jpeg\"\n        : undefined,\n    };\n    const title = fakerCompany.bsAdjective();\n\n    if (has_avatar) {\n      numberOfContacts++;\n    }\n\n    // choose company with people left to know\n    let company: Required<Company>;\n    do {\n      company = random.arrayElement(db.companies);\n    } while (company.nb_contacts >= maxContacts[company.size]);\n    company.nb_contacts++;\n\n    const first_seen = randomDate(new Date(company.created_at)).toISOString();\n    const last_seen = first_seen;\n\n    return {\n      id,\n      first_name,\n      last_name,\n      gender,\n      title: title.charAt(0).toUpperCase() + title.substr(1),\n      company_id: company.id,\n      company_name: company.name,\n      email_jsonb,\n      phone_jsonb,\n      background: lorem.sentence(),\n      acquisition: random.arrayElement([\"inbound\", \"outbound\"]),\n      avatar,\n      first_seen: first_seen,\n      last_seen: last_seen,\n      has_newsletter: weightedBoolean(30),\n      status: random.arrayElement(defaultNoteStatuses).value,\n      tags: random\n        .arrayElements(db.tags, random.arrayElement([0, 0, 0, 1, 1, 2]))\n        .map((tag) => tag.id), // finalize\n      sales_id: company.sales_id,\n      nb_tasks: 0,\n      linkedin_url: null,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/contactNotes.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport { defaultNoteStatuses } from \"../../../root/defaultConfiguration\";\nimport type { ContactNote } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateContactNotes = (db: Db): ContactNote[] => {\n  return Array.from(Array(1200).keys()).map((id) => {\n    const contact = random.arrayElement(db.contacts);\n    const date = randomDate(new Date(contact.first_seen));\n    contact.last_seen =\n      date > new Date(contact.last_seen)\n        ? date.toISOString()\n        : contact.last_seen;\n    return {\n      id,\n      contact_id: contact.id,\n      text: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      date: date.toISOString(),\n      sales_id: contact.sales_id,\n      status: random.arrayElement(defaultNoteStatuses).value,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/companies.ts",
      "content": "import {\n  address,\n  company,\n  datatype,\n  internet,\n  lorem,\n  phone,\n  random,\n} from \"faker/locale/en_US\";\n\nimport { randomDate } from \"./utils\";\nimport { defaultCompanySectors } from \"../../../root/defaultConfiguration\";\nimport type { Company, RAFile } from \"../../../types\";\nimport type { Db } from \"./types\";\n\nconst sizes = [1, 10, 50, 250, 500];\n\nconst regex = /\\W+/;\n\nexport const generateCompanies = (db: Db, size = 55): Required<Company>[] => {\n  return Array.from(Array(size).keys()).map((id) => {\n    const name = company.companyName();\n    return {\n      id,\n      name: name,\n      logo: {\n        title: lorem.text(1),\n        src: `./logos/${id}.png`,\n      } as RAFile,\n      sector: random.arrayElement(defaultCompanySectors),\n      size: random.arrayElement(sizes) as 1 | 10 | 50 | 250 | 500,\n      linkedin_url: `https://www.linkedin.com/company/${name\n        .toLowerCase()\n        .replace(regex, \"_\")}`,\n      website: internet.url(),\n      phone_number: phone.phoneNumber(),\n      address: address.streetAddress(),\n      zipcode: address.zipCode(),\n      city: address.city(),\n      stateAbbr: address.stateAbbr(),\n      nb_contacts: 0,\n      nb_deals: 0,\n      // at least 1/3rd of companies for Jane Doe\n      sales_id: datatype.number(2) === 0 ? 0 : random.arrayElement(db.sales).id,\n      created_at: randomDate().toISOString(),\n      description: lorem.paragraph(),\n      revenue: random.arrayElement([\".1M\", \".10M\", \".100M\", \".1B\"]),\n      tax_identifier: random.alphaNumeric(10),\n      country: random.arrayElement([\"USA\", \"France\", \"UK\"]),\n      context_links: [],\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/mergeContacts.ts",
      "content": "import type { Identifier, DataProvider } from \"ra-core\";\n\nimport type { Contact, Task, Deal, ContactNote } from \"../../types\";\n\n/**\n * Merge one contact (loser) into another contact (winner).\n *\n * This function copies properties from the loser to the winner contact,\n * transfers all associated data (tasks, notes, deals) from the loser to the winner,\n * and deletes the loser contact.\n */\nexport const mergeContacts = async (\n  loserId: Identifier,\n  winnerId: Identifier,\n  dataProvider: DataProvider,\n) => {\n  // Fetch both contacts using dataProvider to get fresh data\n  const { data: winnerContact } = await dataProvider.getOne<Contact>(\n    \"contacts\",\n    { id: winnerId },\n  );\n  const { data: loserContact } = await dataProvider.getOne<Contact>(\n    \"contacts\",\n    { id: loserId },\n  );\n\n  if (!winnerContact || !loserContact) {\n    throw new Error(\"Could not fetch contacts\");\n  }\n\n  // 1. Reassign all tasks from loser to winner\n  const { data: loserTasks } = await dataProvider.getManyReference<Task>(\n    \"tasks\",\n    {\n      target: \"contact_id\",\n      id: loserId,\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: {},\n    },\n  );\n\n  const taskUpdates =\n    loserTasks?.map((task) =>\n      dataProvider.update(\"tasks\", {\n        id: task.id,\n        data: { contact_id: winnerId },\n        previousData: task,\n      }),\n    ) || [];\n\n  // 2. Reassign all notes from loser to winner\n  const { data: loserNotes } = await dataProvider.getManyReference<ContactNote>(\n    \"contactNotes\",\n    {\n      target: \"contact_id\",\n      id: loserId,\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: {},\n    },\n  );\n\n  const noteUpdates =\n    loserNotes?.map((note) =>\n      dataProvider.update<ContactNote>(\"contactNotes\", {\n        id: note.id,\n        data: { contact_id: winnerId },\n        previousData: note,\n      }),\n    ) || [];\n\n  // 3. Change contact in deals - replace loser ID with winner ID in contact_ids array\n  const { data: loserDeals } = await dataProvider.getList<Deal>(\"deals\", {\n    filter: { \"contact_ids@cs\": `{${loserId}}` },\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"id\", order: \"ASC\" },\n  });\n\n  const dealUpdates =\n    loserDeals?.map((deal) => {\n      const newContactIds = deal.contact_ids\n        .filter((id) => id !== loserId)\n        .concat(winnerId)\n        .filter(\n          (id: Identifier, index: number, self: Identifier[]) =>\n            self.indexOf(id) === index,\n        ); // Remove duplicates\n\n      return dataProvider.update<Deal>(\"deals\", {\n        id: deal.id,\n        data: { contact_ids: newContactIds },\n        previousData: deal,\n      });\n    }) || [];\n\n  // 4. Update winner contact with loser data\n  const mergedEmails = mergeObjectArraysUnique(\n    winnerContact.email_jsonb || [],\n    loserContact.email_jsonb || [],\n    (email) => email.email,\n  );\n\n  const mergedPhones = mergeObjectArraysUnique(\n    winnerContact.phone_jsonb || [],\n    loserContact.phone_jsonb || [],\n    (phone) => phone.number,\n  );\n\n  const winnerUpdate = dataProvider.update<Contact>(\"contacts\", {\n    id: winnerId,\n    data: {\n      avatar:\n        winnerContact.avatar && winnerContact.avatar.src\n          ? winnerContact.avatar\n          : loserContact.avatar,\n      gender: winnerContact.gender ?? loserContact.gender,\n      first_name: winnerContact.first_name ?? loserContact.first_name,\n      last_name: winnerContact.last_name ?? loserContact.last_name,\n      title: winnerContact.title ?? loserContact.title,\n      company_id: winnerContact.company_id ?? loserContact.company_id,\n      email_jsonb: mergedEmails,\n      phone_jsonb: mergedPhones,\n      linkedin_url: winnerContact.linkedin_url || loserContact.linkedin_url,\n      background: winnerContact.background ?? loserContact.background,\n      has_newsletter:\n        winnerContact.has_newsletter ?? loserContact.has_newsletter,\n      first_seen: winnerContact.first_seen ?? loserContact.first_seen,\n      last_seen:\n        winnerContact.last_seen > loserContact.last_seen\n          ? winnerContact.last_seen\n          : loserContact.last_seen,\n      sales_id: winnerContact.sales_id ?? loserContact.sales_id,\n      tags: mergeArraysUnique(\n        winnerContact.tags || [],\n        loserContact.tags || [],\n      ),\n    },\n    previousData: winnerContact,\n  });\n\n  // Execute all updates\n  await Promise.all([\n    ...taskUpdates,\n    ...noteUpdates,\n    ...dealUpdates,\n    winnerUpdate,\n  ]);\n\n  // 5. Delete the loser contact\n  await dataProvider.delete<Contact>(\"contacts\", {\n    id: loserId,\n    previousData: loserContact,\n  });\n};\n\n// Helper functions to merge arrays and remove duplicates\n\n// For primitive arrays like tags\nconst mergeArraysUnique = <T>(arr1: T[], arr2: T[]): T[] => [\n  ...new Set([...arr1, ...arr2]),\n];\n\n// For object arrays like emails and phones\nfunction mergeObjectArraysUnique<T>(\n  arr1: T[],\n  arr2: T[],\n  getKey: (item: T) => string,\n): T[] {\n  const map = new Map<string, T>();\n\n  arr1.forEach((item) => {\n    const key = getKey(item);\n    if (key) map.set(key, item);\n  });\n\n  arr2.forEach((item) => {\n    const key = getKey(item);\n    if (key && !map.has(key)) {\n      map.set(key, item);\n    }\n  });\n\n  return Array.from(map.values());\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getContactAvatar.ts",
      "content": "import { fetchWithTimeout } from \"../../misc/fetchWithTimeout\";\nimport { DOMAINS_NOT_SUPPORTING_FAVICON } from \"../../misc/unsupportedDomains.const\";\nimport type { Contact } from \"../../types\";\n\nexport async function hash(string: string) {\n  const utf8 = new TextEncoder().encode(string);\n  const hashBuffer = await crypto.subtle.digest(\"SHA-256\", utf8);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  const hashHex = hashArray\n    .map((bytes) => bytes.toString(16).padStart(2, \"0\"))\n    .join(\"\");\n  return hashHex;\n}\n\n// Helper function to get the Gravatar URL\nasync function getGravatarUrl(email: string): Promise<string> {\n  const hashEmail = await hash(email);\n  return `https://www.gravatar.com/avatar/${hashEmail}?d=404`;\n}\n\n// Helper function to get the favicon URL\nasync function getFaviconUrl(domain: string): Promise<string | null> {\n  if (DOMAINS_NOT_SUPPORTING_FAVICON.includes(domain)) {\n    return null;\n  }\n\n  try {\n    const faviconUrl = `https://${domain}/favicon.ico`;\n    const response = await fetchWithTimeout(faviconUrl);\n    if (response.ok) {\n      return faviconUrl;\n    }\n  } catch {\n    return null;\n  }\n  return null;\n}\n\n// Main function to get the avatar URL\nexport async function getContactAvatar(\n  record: Partial<Contact>,\n): Promise<string | null> {\n  if (!record.email_jsonb || !record.email_jsonb.length) {\n    return null;\n  }\n\n  for (const { email } of record.email_jsonb) {\n    // Step 1: Try to get Gravatar image\n    const gravatarUrl = await getGravatarUrl(email);\n    try {\n      const gravatarResponse = await fetch(gravatarUrl);\n      if (gravatarResponse.ok) {\n        return gravatarUrl;\n      }\n    } catch {\n      // Gravatar not found\n    }\n\n    // Step 2: Try to get favicon from email domain\n    const domain = email.split(\"@\")[1];\n    const faviconUrl = await getFaviconUrl(domain);\n    if (faviconUrl) {\n      return faviconUrl;\n    }\n\n    // TODO: Step 3: Try to get image from LinkedIn.\n  }\n\n  return null;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getContactAvatar.spec.ts",
      "content": "import { webcrypto } from \"node:crypto\";\n\nimport type { Contact, EmailAndType } from \"../../types\";\nimport { getContactAvatar, hash } from \"./getContactAvatar\";\n\nObject.defineProperty(globalThis, \"crypto\", {\n  value: webcrypto,\n});\n\nit(\"should return gravatar URL for anthony@marmelab.com\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"anthony@marmelab.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  const hashedEmail = await hash(email[0].email);\n  expect(avatarUrl).toBe(\n    `https://www.gravatar.com/avatar/${hashedEmail}?d=404`,\n  );\n});\n\nit(\"should return favicon URL if gravatar does not exist\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"no-gravatar@gravatar.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBe(\"https://gravatar.com/favicon.ico\");\n});\n\nit(\"should not return favicon URL if not domain not allowed\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"no-gravatar@gmail.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return null if no email is provided\", async () => {\n  const record: Partial<Contact> = {};\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return null if an empty array is provided\", async () => {\n  const email: EmailAndType[] = [];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return null if email has no gravatar or validate domain\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"anthony@fake-domain-marmelab.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return gravatar URL for 2nd email if 1st email has no gravatar nor valid domain\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"anthony@fake-domain-marmelab.com\", type: \"Work\" },\n    { email: \"anthony@marmelab.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  const hashedEmail = await hash(email[1].email);\n  expect(avatarUrl).toBe(\n    `https://www.gravatar.com/avatar/${hashedEmail}?d=404`,\n  );\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getCompanyAvatar.ts",
      "content": "import type { Company } from \"../../types\";\n\n// Main function to get the avatar URL\nexport async function getCompanyAvatar(record: Partial<Company>): Promise<{\n  src: string;\n  title: string;\n} | null> {\n  // TODO: Step 1: Try to get image from LinkedIn.\n\n  // Step 2: Fallback to the favicon from website domain\n  if (!record.website) {\n    return null;\n  }\n  const websiteUrlWithoutScheme = record.website\n    .replace(/^https?:\\/\\//, \"\")\n    .replace(/\\/$/, \"\");\n  return {\n    src: `https://favicon.show/${websiteUrlWithoutScheme}`,\n    title: \"Company favicon\",\n  };\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getCompanyAvatar.spec.ts",
      "content": "import type { Company } from \"../../types\";\nimport { getCompanyAvatar } from \"./getCompanyAvatar\";\n\nit(\"should return favicon URL if website url exist\", async () => {\n  const website = \"https://example.com\";\n  const record: Partial<Company> = { website };\n\n  const avatarUrl = await getCompanyAvatar(record);\n  expect(avatarUrl).toStrictEqual({\n    src: \"https://favicon.show/example.com\",\n    title: \"Company favicon\",\n  });\n});\n\nit(\"should return null if no website is provided\", async () => {\n  const record: Partial<Company> = {};\n\n  const avatarUrl = await getCompanyAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/canAccess.ts",
      "content": "// FIXME: This should be exported from the ra-core package\ntype CanAccessParams<\n  RecordType extends Record<string, any> = Record<string, any>,\n> = {\n  action: string;\n  resource: string;\n  record?: RecordType;\n};\n\nexport const canAccess = <\n  RecordType extends Record<string, any> = Record<string, any>,\n>(\n  role: string,\n  params: CanAccessParams<RecordType>,\n) => {\n  if (role === \"admin\") {\n    return true;\n  }\n\n  // Non admins can't access the sales resource\n  if (params.resource === \"sales\") {\n    return false;\n  }\n\n  return true;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/activity.ts",
      "content": "import type { DataProvider, Identifier } from \"ra-core\";\n\nimport {\n  COMPANY_CREATED,\n  CONTACT_CREATED,\n  CONTACT_NOTE_CREATED,\n  DEAL_CREATED,\n  DEAL_NOTE_CREATED,\n  QUOTE_CREATED,\n  QUOTE_UPDATED,\n  TASK_CREATED,\n  TASK_COMPLETED,\n  DEAL_STATUS_CHANGED,\n  DEAL_ARCHIVED,\n  DEAL_UNARCHIVED,\n  NOTE_DELETED,\n  QUOTE_DELETED,\n  TASK_DELETED,\n  APPOINTMENT_CREATED,\n  APPOINTMENT_DELETED,\n} from \"../../consts\";\nimport type {\n  Activity,\n  Company,\n  Contact,\n  ContactNote,\n  Deal,\n  DealNote,\n  Quote,\n  Task,\n  Appointment,\n} from \"../../types\";\n\n// FIXME: Requires 5 large queries to get the latest activities.\n// Replace with a server-side view or a custom API endpoint.\nexport async function getActivityLog(\n  dataProvider: DataProvider,\n  companyId?: Identifier,\n  salesId?: Identifier,\n  contactId?: Identifier,\n) {\n  const companyFilter = {} as any;\n  if (companyId) {\n    companyFilter.id = companyId;\n  } else if (salesId) {\n    companyFilter[\"sales_id@in\"] = `(${salesId})`;\n  }\n\n  const filter = {} as any;\n  if (companyId) {\n    filter.company_id = companyId;\n  } else if (salesId) {\n    filter[\"sales_id@in\"] = `(${salesId})`;\n  } else if (contactId) {\n    filter.id = contactId;\n  }\n\n  const [newCompanies, newContactsAndNotes, newDealsAndNotes, newQuotes, newTasks, statusChanges, archiveChanges, deletions, appointments] =\n    await Promise.all([\n      getNewCompanies(dataProvider, companyFilter),\n      getNewContactsAndNotes(dataProvider, filter),\n      getNewDealsAndNotes(dataProvider, filter),\n      getQuotes(dataProvider, filter),\n      getTasks(dataProvider, filter),\n      getStatusChanges(dataProvider, filter),\n      getArchiveChanges(dataProvider, filter),\n      getDeletions(dataProvider, filter),\n      getAppointments(dataProvider, filter),\n    ]);\n  return (\n    [...newCompanies, ...newContactsAndNotes, ...newDealsAndNotes, ...newQuotes, ...newTasks, ...statusChanges, ...archiveChanges, ...deletions, ...appointments]\n      // sort by date desc\n      .sort((a, b) => {\n        const tsA = a.date ? new Date(a.date).getTime() : 0;\n        const tsB = b.date ? new Date(b.date).getTime() : 0;\n        return tsB - tsA;\n      })\n      // limit to 250 activities\n      .slice(0, 250)\n  );\n}\n\nconst getNewCompanies = async (\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> => {\n  const { data: companies } = await dataProvider.getList<Company>(\"companies\", {\n    filter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n  });\n  return companies.map((company) => ({\n    id: `company.${company.id}.created`,\n    type: COMPANY_CREATED,\n    company_id: company.id,\n    company,\n    sales_id: company.sales_id,\n    date: company.created_at,\n  }));\n};\n\nasync function getNewContactsAndNotes(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n    filter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"first_seen\", order: \"DESC\" },\n  });\n\n  const recentContactNotesFilter = {} as any;\n  if (filter.sales_id) {\n    recentContactNotesFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // No company_id field in contactNote, filtering by related contacts instead.\n    // This filter is only valid if a company has less than 250 contact.\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    recentContactNotesFilter[\"contact_id@in\"] = `(${contactIds})`;\n  }\n  if (filter.id) {\n    // Filter by specific contact ID\n    recentContactNotesFilter.contact_id = filter.id;\n  }\n\n  const { data: contactNotes } = await dataProvider.getList<ContactNote>(\n    \"contactNotes\",\n    {\n      filter: recentContactNotesFilter,\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    },\n  );\n\n  const newContacts = contacts.map((contact) => ({\n    id: `contact.${contact.id}.created`,\n    type: CONTACT_CREATED,\n    company_id: contact.company_id,\n    sales_id: contact.sales_id,\n    contact,\n    date: contact.first_seen,\n  }));\n\n  const newContactNotes = contactNotes.map((contactNote) => ({\n    id: `contactNote.${contactNote.id}.created`,\n    type: CONTACT_NOTE_CREATED,\n    sales_id: contactNote.sales_id,\n    contactNote,\n    date: contactNote.date,\n  }));\n\n  return [...newContacts, ...newContactNotes];\n}\n\nasync function getNewDealsAndNotes(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  // For contact filtering, we need to filter deals by lead_id\n  const dealsFilter = {} as any;\n  if (filter.id) {\n    // Filter deals by lead_id (contact_id) when filtering by contact\n    dealsFilter[\"@or\"] = {\n      lead_id: filter.id,\n      \"contact_ids@cs\": `{${filter.id}}`,\n    };\n  } else {\n    Object.assign(dealsFilter, filter);\n  }\n\n  // Use \"deals\" table directly (lead-journey is just a UI-facing resource name)\n  const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n    filter: dealsFilter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n  });\n\n  const recentDealNotesFilter = {} as any;\n  if (filter.sales_id) {\n    recentDealNotesFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // No company_id field in dealNote, filtering by related deals instead.\n    // This filter is only valid if a deal has less than 250 notes.\n    const dealIds = deals.map((deal) => deal.id).join(\",\");\n    recentDealNotesFilter[\"deal_id@in\"] = `(${dealIds})`;\n  }\n  if (filter.id) {\n    // Filter deal notes by deals associated with this contact\n    const dealIds = deals.map((deal) => deal.id).join(\",\");\n    if (dealIds) {\n      recentDealNotesFilter[\"deal_id@in\"] = `(${dealIds})`;\n    } else {\n      // No deals for this contact, so no deal notes\n      // Don't return DEAL_CREATED activities - they're duplicates of CONTACT_CREATED\n      return [];\n    }\n  }\n\n  const { data: dealNotes } = await dataProvider.getList<DealNote>(\n    \"dealNotes\",\n    {\n      filter: recentDealNotesFilter,\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    },\n  );\n\n  // Filter out DEAL_CREATED activities - they're duplicates of CONTACT_CREATED\n  // Only return deal notes, not deal creation activities\n  const newDealNotes = dealNotes.map((dealNote) => ({\n    id: `dealNote.${dealNote.id}.created`,\n    type: DEAL_NOTE_CREATED,\n    sales_id: dealNote.sales_id,\n    dealNote,\n    date: dealNote.date,\n  }));\n\n  return [...newDealNotes];\n}\n\nasync function getQuotes(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const quotesFilter = {} as any;\n  if (filter.sales_id) {\n    quotesFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // Filter by contacts in the company\n    const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n      filter: { company_id: filter.company_id },\n      pagination: { page: 1, perPage: 250 },\n    });\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    if (contactIds) {\n      quotesFilter[\"contact_id@in\"] = `(${contactIds})`;\n    } else {\n      return [];\n    }\n  }\n  if (filter.id) {\n    // Filter by specific contact ID\n    quotesFilter.contact_id = filter.id;\n  }\n\n  const { data: quotes } = await dataProvider.getList<Quote>(\"quotes\", {\n    filter: quotesFilter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"updated_at\", order: \"DESC\" },\n  });\n\n  return quotes.map((quote) => {\n    // Use updated_at if it's different from created_at (quote was updated)\n    const isUpdated = quote.updated_at && quote.updated_at !== quote.created_at;\n    return {\n      id: isUpdated\n        ? `quote.${quote.id}.updated`\n        : `quote.${quote.id}.created`,\n      type: isUpdated ? QUOTE_UPDATED : QUOTE_CREATED,\n      sales_id: quote.sales_id,\n      quote,\n      date: isUpdated ? quote.updated_at : quote.created_at,\n    };\n  });\n}\n\nasync function getTasks(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const tasksFilter = {} as any;\n  if (filter.sales_id) {\n    tasksFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // Filter by contacts in the company\n    const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n      filter: { company_id: filter.company_id },\n      pagination: { page: 1, perPage: 250 },\n    });\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    if (contactIds) {\n      tasksFilter[\"contact_id@in\"] = `(${contactIds})`;\n    } else {\n      return [];\n    }\n  }\n  if (filter.id) {\n    // Filter by specific contact ID\n    tasksFilter.contact_id = filter.id;\n  }\n\n  const { data: tasks } = await dataProvider.getList<Task>(\"tasks\", {\n    filter: tasksFilter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"due_date\", order: \"DESC\" },\n  });\n\n  const activities: Activity[] = [];\n\n  tasks.forEach((task) => {\n    // Task completed activity\n    if (task.done_date) {\n      const completionDate = task.done_date || task.due_date || task.created_at;\n      if (completionDate) {\n        activities.push({\n          id: `task.${task.id}.completed`,\n          type: TASK_COMPLETED,\n          sales_id: task.sales_id,\n          task,\n          date: completionDate,\n        });\n      }\n    }\n    // Task created activity - always include; prefer created_at then due_date (never use current time)\n    const creationDate = task.created_at || task.due_date;\n    if (creationDate) {\n      activities.push({\n        id: `task.${task.id}.created`,\n        type: TASK_CREATED,\n        sales_id: task.sales_id,\n        task,\n        date: creationDate,\n      });\n    }\n  });\n\n  return activities;\n}\n\nasync function getStatusChanges(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const statusChangeFilter = {} as any;\n  \n  if (filter.sales_id) {\n    statusChangeFilter.sales_id = filter.sales_id;\n  }\n  \n  // Build deal filter to find relevant deals\n  const dealsFilter: any = {};\n  if (filter.company_id) {\n    dealsFilter.company_id = filter.company_id;\n  }\n  if (filter.id) {\n    // When filtering by contact, we need to find deals associated with that contact\n    dealsFilter[\"@or\"] = {\n      lead_id: filter.id,\n      \"contact_ids@cs\": `{${filter.id}}`,\n    };\n  }\n  \n  // If we have deal filters, fetch deals first to get deal IDs\n  let dealIds: Identifier[] = [];\n  if (Object.keys(dealsFilter).length > 0) {\n    const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n      filter: dealsFilter,\n      pagination: { page: 1, perPage: 250 },\n    });\n    \n    dealIds = deals.map((deal) => deal.id);\n    if (dealIds.length > 0) {\n      statusChangeFilter[\"deal_id@in\"] = `(${dealIds.join(\",\")})`;\n    } else {\n      // No deals found, return empty array\n      return [];\n    }\n  }\n  \n  // Also filter by company_id if provided (for activity_log entries that have it)\n  if (filter.company_id) {\n    statusChangeFilter.company_id = filter.company_id;\n  }\n\n  // Read status changes from activity_log table\n  let statusChanges: any[] = [];\n  try {\n    const result = await dataProvider.getList<any>(\"activity_log\", {\n      filter: {\n        ...statusChangeFilter,\n        type: \"deal.statusChanged\",\n      },\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    });\n    statusChanges = result?.data || [];\n  } catch (error) {\n    // If activity_log table doesn't exist or query fails, return empty array\n    // This can happen if the migration hasn't been run yet\n    console.warn(\"Failed to fetch status changes from activity_log:\", error);\n    return [];\n  }\n\n  // If no status changes found, return empty array\n  // Note: This is expected if no status changes have been logged yet\n  if (!statusChanges || statusChanges.length === 0) {\n    return [];\n  }\n\n  // Fetch the current deal data for each status change\n  const uniqueDealIds = [...new Set(statusChanges.map((sc: any) => sc.deal_id).filter(Boolean))];\n  \n  let dealsMap = new Map<Identifier, Deal>();\n  if (uniqueDealIds.length > 0) {\n    const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n      filter: {\n        \"id@in\": `(${uniqueDealIds.join(\",\")})`,\n      },\n      pagination: { page: 1, perPage: 250 },\n    });\n    deals?.forEach((deal) => {\n      dealsMap.set(deal.id, deal);\n    });\n  }\n\n  return statusChanges.map((statusChange: any) => {\n    const deal = dealsMap.get(statusChange.deal_id);\n    if (!deal) {\n      // Deal might have been deleted, skip this status change\n      return null;\n    }\n    \n    return {\n      id: `deal.${statusChange.deal_id}.statusChanged.${statusChange.id}`,\n      type: DEAL_STATUS_CHANGED,\n      company_id: statusChange.company_id || deal.company_id,\n      sales_id: statusChange.sales_id || deal.sales_id,\n      deal: {\n        ...deal,\n        // Use the new_stage from the activity log, or fall back to current deal stage\n        stage: statusChange.new_stage || deal.stage,\n      },\n      old_stage: statusChange.old_stage,\n      new_stage: statusChange.new_stage,\n      date: statusChange.date || new Date().toISOString(),\n    };\n  }).filter((activity): activity is Activity => activity !== null);\n}\n\nasync function getArchiveChanges(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const archiveFilter = {} as any;\n  \n  if (filter.sales_id) {\n    archiveFilter.sales_id = filter.sales_id;\n  }\n  \n  // Build deal filter to find relevant deals\n  const dealsFilter: any = {};\n  if (filter.company_id) {\n    dealsFilter.company_id = filter.company_id;\n  }\n  if (filter.id) {\n    // When filtering by contact, we need to find deals associated with that contact\n    dealsFilter[\"@or\"] = {\n      lead_id: filter.id,\n      \"contact_ids@cs\": `{${filter.id}}`,\n    };\n  }\n  \n  // If we have deal filters, fetch deals first to get deal IDs\n  let dealIds: Identifier[] = [];\n  if (Object.keys(dealsFilter).length > 0) {\n    const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n      filter: dealsFilter,\n      pagination: { page: 1, perPage: 250 },\n    });\n    \n    dealIds = deals.map((deal) => deal.id);\n    if (dealIds.length > 0) {\n      archiveFilter[\"deal_id@in\"] = `(${dealIds.join(\",\")})`;\n    } else {\n      // No deals found, return empty array\n      return [];\n    }\n  }\n  \n  // Also filter by company_id if provided\n  if (filter.company_id) {\n    archiveFilter.company_id = filter.company_id;\n  }\n\n  // Read archive changes from activity_log table\n  let archiveChanges: any[] = [];\n  try {\n    const result = await dataProvider.getList<any>(\"activity_log\", {\n      filter: {\n        ...archiveFilter,\n        \"type@in\": \"(deal.archived,deal.unarchived)\",\n      },\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    });\n    archiveChanges = result?.data || [];\n  } catch (error) {\n    console.warn(\"Failed to fetch archive changes from activity_log:\", error);\n    return [];\n  }\n\n  // If no archive changes found, return empty array\n  if (!archiveChanges || archiveChanges.length === 0) {\n    return [];\n  }\n\n  // Fetch the current deal data for each archive change\n  const uniqueDealIds = [...new Set(archiveChanges.map((ac: any) => ac.deal_id).filter(Boolean))];\n  \n  let dealsMap = new Map<Identifier, Deal>();\n  if (uniqueDealIds.length > 0) {\n    const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n      filter: {\n        \"id@in\": `(${uniqueDealIds.join(\",\")})`,\n      },\n      pagination: { page: 1, perPage: 250 },\n    });\n    deals?.forEach((deal) => {\n      dealsMap.set(deal.id, deal);\n    });\n  }\n\n  return archiveChanges.map((archiveChange: any) => {\n    const deal = dealsMap.get(archiveChange.deal_id);\n    if (!deal) {\n      // Deal might have been deleted, skip this archive change\n      return null;\n    }\n    \n    const activityType = archiveChange.type === \"deal.archived\" ? DEAL_ARCHIVED : DEAL_UNARCHIVED;\n    \n    return {\n      id: `deal.${archiveChange.deal_id}.${archiveChange.type}.${archiveChange.id}`,\n      type: activityType,\n      company_id: archiveChange.company_id || deal.company_id,\n      sales_id: archiveChange.sales_id || deal.sales_id,\n      deal,\n      date: archiveChange.date || new Date().toISOString(),\n    };\n  }).filter((activity): activity is Activity => activity !== null);\n}\n\nasync function getDeletions(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const deletionFilter = {} as any;\n  if (filter.sales_id) {\n    deletionFilter.sales_id = filter.sales_id;\n  }\n  if (filter.id) {\n    // Filter by specific contact ID\n    deletionFilter.contact_id = filter.id;\n  }\n  if (filter.company_id) {\n    // For company filter, we need to get contact IDs first\n    const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n      filter: { company_id: filter.company_id },\n      pagination: { page: 1, perPage: 250 },\n    });\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    if (contactIds) {\n      deletionFilter[\"contact_id@in\"] = `(${contactIds})`;\n    } else {\n      return [];\n    }\n  }\n\n  const { data: deletions } = await dataProvider.getList<any>(\"activity_log\", {\n    filter: {\n      ...deletionFilter,\n      \"type@in\": \"(note.deleted,quote.deleted,task.deleted)\",\n    },\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"date\", order: \"DESC\" },\n  });\n\n  return deletions.map((deletion) => {\n    const baseActivity = {\n      id: `deletion.${deletion.id}`,\n      sales_id: deletion.sales_id,\n      date: deletion.date,\n    };\n\n    if (deletion.type === \"note.deleted\") {\n      return {\n        ...baseActivity,\n        type: NOTE_DELETED,\n        contact_id: deletion.contact_id,\n        deal_id: deletion.deal_id,\n        note_text: deletion.note_text,\n      };\n    } else if (deletion.type === \"quote.deleted\") {\n      return {\n        ...baseActivity,\n        type: QUOTE_DELETED,\n        contact_id: deletion.contact_id,\n        quote_amount: deletion.quote_amount,\n        quote_description: deletion.quote_description,\n      };\n    } else if (deletion.type === \"task.deleted\") {\n      return {\n        ...baseActivity,\n        type: TASK_DELETED,\n        contact_id: deletion.contact_id,\n        task_text: deletion.task_text,\n        task_type: deletion.task_type,\n      };\n    }\n    return null;\n  }).filter((activity): activity is Activity => activity !== null);\n}\n\nasync function getAppointments(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const appointmentFilter = {} as any;\n  \n  if (filter.sales_id) {\n    appointmentFilter.sales_id = filter.sales_id;\n  }\n  if (filter.id) {\n    // Filter by specific contact ID\n    appointmentFilter.contact_id = filter.id;\n  }\n  if (filter.company_id) {\n    // For company filter, we need to get contact IDs first\n    const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n      filter: { company_id: filter.company_id },\n      pagination: { page: 1, perPage: 250 },\n    });\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    if (contactIds) {\n      appointmentFilter[\"contact_id@in\"] = `(${contactIds})`;\n    } else {\n      return [];\n    }\n  }\n\n  // Fetch appointment activities from activity_log\n  let appointmentActivities: any[] = [];\n  try {\n    const result = await dataProvider.getList<any>(\"activity_log\", {\n      filter: {\n        ...appointmentFilter,\n        \"type@in\": \"(appointment.created,appointment.deleted)\",\n      },\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    });\n    appointmentActivities = result?.data || [];\n  } catch (error) {\n    console.warn(\"Failed to fetch appointment activities from activity_log:\", error);\n    return [];\n  }\n\n  if (!appointmentActivities || appointmentActivities.length === 0) {\n    return [];\n  }\n\n  // Fetch appointment details for created appointments\n  const appointmentIds = appointmentActivities\n    .filter((a) => a.type === \"appointment.created\" && a.appointment_id)\n    .map((a) => a.appointment_id);\n  \n  let appointmentsMap = new Map<Identifier, Appointment>();\n  if (appointmentIds.length > 0) {\n    try {\n      const { data: appointments } = await dataProvider.getList<Appointment>(\"appointments\", {\n        filter: {\n          \"id@in\": `(${appointmentIds.join(\",\")})`,\n        },\n        pagination: { page: 1, perPage: 250 },\n      });\n      appointments?.forEach((apt) => {\n        appointmentsMap.set(apt.id, apt);\n      });\n    } catch (error) {\n      console.warn(\"Failed to fetch appointment details:\", error);\n    }\n  }\n\n  return appointmentActivities.map((activityLog: any) => {\n    const baseActivity = {\n      id: `appointment.${activityLog.appointment_id || activityLog.id}.${activityLog.type}`,\n      sales_id: activityLog.sales_id,\n      contact_id: activityLog.contact_id,\n      date: activityLog.date || new Date().toISOString(),\n    };\n\n    if (activityLog.type === \"appointment.created\") {\n      const appointment = appointmentsMap.get(activityLog.appointment_id);\n      return {\n        ...baseActivity,\n        type: APPOINTMENT_CREATED,\n        appointment_id: activityLog.appointment_id,\n        appointment,\n      };\n    } else if (activityLog.type === \"appointment.deleted\") {\n      return {\n        ...baseActivity,\n        type: APPOINTMENT_DELETED,\n        appointment_id: activityLog.appointment_id,\n        appointment_date: activityLog.appointment_date,\n        appointment_type: activityLog.appointment_type,\n      };\n    }\n    return null;\n  }).filter((activity): activity is Activity => activity !== null);\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/types.ts",
      "content": "import type { Identifier, RaRecord } from \"ra-core\";\n\nexport type PaymentPackage = {\n  patient_id: Identifier;\n  service_id?: Identifier;\n  package_type: \"session-based\" | \"time-based\" | \"post-payment\";\n  total_amount: number;\n  price_per_hour?: number | null;\n  total_sessions?: number | null;\n  total_hours?: number | null;\n  duration_days?: number | null;\n  hours_per_day?: number | null;\n  start_date: string; // YYYY-MM-DD\n  end_date?: string | null; // YYYY-MM-DD\n  renewal_date?: string | null; // YYYY-MM-DD\n  next_payment_date?: string | null; // YYYY-MM-DD\n  status: \"active\" | \"completed\" | \"expired\";\n  renewed_from_package_id?: Identifier | null;\n  name?: string | null; // Human-readable package name\n  created_at: string;\n  updated_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type PaymentTransaction = {\n  payment_package_id?: Identifier | null; // Optional for standalone payments (one-off services)\n  appointment_id?: Identifier | null; // Optional, used to link standalone payments to appointments\n  amount_received: number;\n  bank_charge: number;\n  net_amount: number;\n  payment_method: \"POS\" | \"Tabby\" | \"Payment Link\" | \"Ziina\" | \"Cash\";\n  date_paid: string; // YYYY-MM-DD\n  date_received: string; // YYYY-MM-DD\n  invoice_number?: string | null;\n  installment_number?: number | null;\n  created_at: string;\n  updated_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type PackageUsage = {\n  payment_package_id: Identifier;\n  appointment_id?: Identifier | null;\n  usage_type: \"session\" | \"hours\";\n  quantity_used: number;\n  usage_date: string; // YYYY-MM-DD\n  is_manual_adjustment: boolean;\n  notes?: string | null;\n  created_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type InstallmentSchedule = {\n  payment_package_id: Identifier;\n  installment_number: number;\n  due_date: string; // YYYY-MM-DD\n  amount_due: number;\n  is_paid: boolean;\n  paid_date?: string | null; // YYYY-MM-DD\n  reminder_sent: boolean;\n  created_at: string;\n  updated_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type PaymentSettings = {\n  payment_method: \"POS\" | \"Tabby\" | \"Payment Link\" | \"Ziina\" | \"Cash\";\n  fee_percentage?: number | null;\n  fixed_fee_amount?: number | null;\n  vat_percentage: number;\n  is_active: boolean;\n  created_at: string;\n  updated_at: string;\n} & Pick<RaRecord, \"id\">;\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/paymentTransactions.ts",
      "content": "import type { PaymentTransaction } from \"./types\";\nimport { PaymentTransactionList } from \"./PaymentTransactionList\";\nimport { PaymentTransactionCreate } from \"./PaymentTransactionCreate\";\nimport { PaymentTransactionEdit } from \"./PaymentTransactionEdit\";\nimport { CreditCard } from \"lucide-react\";\n\nexport default {\n  list: PaymentTransactionList,\n  create: PaymentTransactionCreate,\n  edit: PaymentTransactionEdit,\n  icon: CreditCard,\n  recordRepresentation: (record: PaymentTransaction) => {\n    return `Transaction #${record.id} - AED ${record.amount_received.toLocaleString()}`;\n  },\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/index.ts",
      "content": "export { PaymentPackagesPage } from \"./PaymentPackagesPage\";\nexport { PaymentPackageList, PaymentPackageListActions, filters } from \"./PaymentPackageList\";\nexport { PaymentPackageForm } from \"./PaymentPackageForm\";\nexport { PaymentPackageShow } from \"./PaymentPackageShow\";\nexport { PaymentPackageCreate } from \"./PaymentPackageCreate\";\nexport { PaymentPackageEdit } from \"./PaymentPackageEdit\";\nexport { PackageDetailsView } from \"./PackageDetailsView\";\nexport { UsageTracker } from \"./UsageTracker\";\nexport { UsageAdjustmentForm } from \"./UsageAdjustmentForm\";\nexport { RenewalForm } from \"./RenewalForm\";\nexport { InstallmentSchedule } from \"./InstallmentSchedule\";\nexport { PaymentTransactionForm } from \"./PaymentTransactionForm\";\nexport { PaymentTransactionCreate } from \"./PaymentTransactionCreate\";\nexport { PaymentTransactionEdit } from \"./PaymentTransactionEdit\";\nexport { PaymentTransactionList } from \"./PaymentTransactionList\";\nexport { calculateBankCharge, useBankChargeCalculation } from \"./BankChargeCalculator\";\nexport type { BankChargeCalculation } from \"./BankChargeCalculator\";\nexport type {\n  PaymentPackage,\n  PaymentTransaction,\n  PackageUsage,\n  InstallmentSchedule,\n  PaymentSettings,\n} from \"./types\";\n\nimport type { PaymentPackage } from \"./types\";\nimport { PaymentPackagesPage } from \"./PaymentPackagesPage\";\nimport { PaymentPackageCreate } from \"./PaymentPackageCreate\";\nimport { PaymentPackageEdit } from \"./PaymentPackageEdit\";\nimport { PaymentPackageShow } from \"./PaymentPackageShow\";\nimport { Package } from \"lucide-react\";\n\nexport default {\n  list: PaymentPackagesPage,\n  create: PaymentPackageCreate,\n  edit: PaymentPackageEdit,\n  show: PaymentPackageShow,\n  icon: Package,\n  recordRepresentation: (record: PaymentPackage) => {\n    return `Package #${record.id}`;\n  },\n};\n\nexport { default as paymentTransactions } from \"./paymentTransactions\";\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/UsageTracker.tsx",
      "content": "import { Progress } from \"@/components/ui/progress\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport type { PaymentPackage } from \"./types\";\n\ntype UsageTrackerProps = {\n  package: PaymentPackage;\n  sessionsUsed?: number;\n  hoursUsed?: number;\n};\n\nexport const UsageTracker = ({ package: pkg, sessionsUsed = 0, hoursUsed = 0 }: UsageTrackerProps) => {\n  let used: number;\n  let total: number;\n  let label: string;\n  let unit: string;\n\n  if (pkg.package_type === \"session-based\" && pkg.total_sessions) {\n    used = sessionsUsed;\n    total = pkg.total_sessions;\n    label = \"Sessions\";\n    unit = \"sessions\";\n  } else if (pkg.package_type === \"time-based\" && pkg.total_hours) {\n    used = hoursUsed;\n    total = pkg.total_hours;\n    label = \"Hours\";\n    unit = \"hours\";\n  } else {\n    // Post-payment or no usage tracking\n    return null;\n  }\n\n  const percentage = total > 0 ? Math.min((used / total) * 100, 100) : 0;\n  const remaining = Math.max(total - used, 0);\n\n  // Color based on usage percentage\n  let progressColor = \"bg-green-500\";\n  if (percentage >= 100) {\n    progressColor = \"bg-red-500\";\n  } else if (percentage >= 80) {\n    progressColor = \"bg-yellow-500\";\n  } else if (percentage >= 50) {\n    progressColor = \"bg-blue-500\";\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-lg\">Usage Tracking</CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <div className=\"flex justify-between text-sm\">\n            <span className=\"text-muted-foreground\">{label} Used</span>\n            <span className=\"font-medium\">\n              {used.toFixed(pkg.package_type === \"time-based\" ? 1 : 0)} / {total.toFixed(pkg.package_type === \"time-based\" ? 1 : 0)} {unit}\n            </span>\n          </div>\n          <Progress value={percentage} className=\"h-3\" />\n          <div className=\"flex justify-between text-xs text-muted-foreground\">\n            <span>{percentage.toFixed(1)}% used</span>\n            <span>{remaining.toFixed(pkg.package_type === \"time-based\" ? 1 : 0)} {unit} remaining</span>\n          </div>\n        </div>\n        {percentage >= 100 && (\n          <div className=\"p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md\">\n            <p className=\"text-sm text-red-800 dark:text-red-300 font-medium\">\n              Package Exhausted - All {unit} have been used\n            </p>\n          </div>\n        )}\n        {percentage >= 80 && percentage < 100 && (\n          <div className=\"p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md\">\n            <p className=\"text-sm text-yellow-800 dark:text-yellow-300 font-medium\">\n              Low Usage Warning - Less than {remaining.toFixed(pkg.package_type === \"time-based\" ? 1 : 0)} {unit} remaining\n            </p>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/UsageAdjustmentForm.tsx",
      "content": "import { useState, useEffect } from \"react\";\nimport { useFormContext, useWatch } from \"react-hook-form\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { NumberInput } from \"@/components/admin/number-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { required } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport type { PaymentPackage } from \"./types\";\n\ntype UsageAdjustmentFormProps = {\n  package: PaymentPackage;\n};\n\nconst validatePositive = (value: any) => {\n  if (value == null || value === \"\") return undefined;\n  const num = typeof value === \"number\" ? value : parseFloat(value);\n  if (isNaN(num) || num <= 0) {\n    return \"Must be greater than 0\";\n  }\n  return undefined;\n};\n\nconst usageTypeChoices = [\n  { id: \"session\", name: \"Sessions\" },\n  { id: \"hours\", name: \"Hours\" },\n];\n\nexport const UsageAdjustmentForm = ({ package: pkg }: UsageAdjustmentFormProps) => {\n  const { setValue } = useFormContext();\n  const usageType = useWatch({ name: \"usage_type\" });\n  const usageDate = useWatch({ name: \"usage_date\" });\n\n  // Set default values\n  useEffect(() => {\n    const defaultUsageType = pkg.package_type === \"session-based\" ? \"session\" : \"hours\";\n    if (!usageType) {\n      setValue(\"usage_type\", defaultUsageType);\n    }\n    if (!usageDate) {\n      setValue(\"usage_date\", new Date().toISOString().split(\"T\")[0]);\n    }\n  }, [pkg.package_type, setValue, usageType, usageDate]);\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Manual Usage Adjustment</CardTitle>\n          <CardDescription>\n            Add or adjust usage for this package. This will create a manual adjustment record.\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n          <SelectInput\n            source=\"usage_type\"\n            label=\"Usage Type\"\n            choices={usageTypeChoices}\n            validate={required()}\n            helperText={\n              pkg.package_type === \"session-based\"\n                ? \"This package tracks sessions\"\n                : \"This package tracks hours\"\n            }\n          />\n\n          <NumberInput\n            source=\"quantity_used\"\n            label={(usageType || (pkg.package_type === \"session-based\" ? \"session\" : \"hours\")) === \"session\" ? \"Number of Sessions\" : \"Number of Hours\"}\n            validate={[required(), validatePositive]}\n            min={0}\n            step={(usageType || (pkg.package_type === \"session-based\" ? \"session\" : \"hours\")) === \"session\" ? 1 : 0.1}\n            helperText={\n              (usageType || (pkg.package_type === \"session-based\" ? \"session\" : \"hours\")) === \"session\"\n                ? \"Enter the number of sessions to add\"\n                : \"Enter the number of hours to add\"\n            }\n          />\n\n          <DateInput\n            source=\"usage_date\"\n            label=\"Usage Date\"\n            validate={required()}\n            helperText=\"Date when this usage occurred\"\n          />\n\n          <TextInput\n            source=\"notes\"\n            label=\"Notes (Optional)\"\n            helperText=\"Explain why this adjustment is needed (e.g., 'Appointment was completed but not tracked automatically')\"\n            multiline\n            rows={3}\n          />\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/RenewalForm.tsx",
      "content": "import { useState, useEffect } from \"react\";\nimport { required } from \"ra-core\";\nimport { useFormContext, useWatch } from \"react-hook-form\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { RadioButtonGroupInput } from \"@/components/admin/radio-button-group-input\";\nimport { NumberInput } from \"@/components/admin/number-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport type { PaymentPackage } from \"./types\";\n\n// Validation functions\nconst validatePositive = (value: any) => {\n  if (value == null || value === \"\") return undefined;\n  const num = typeof value === \"number\" ? value : parseFloat(value);\n  if (isNaN(num) || num <= 0) {\n    return \"Must be greater than 0\";\n  }\n  return undefined;\n};\n\nconst validatePositiveInteger = (value: any) => {\n  if (value == null || value === \"\") return undefined;\n  const num = typeof value === \"number\" ? value : parseInt(value, 10);\n  if (isNaN(num) || num <= 0 || !Number.isInteger(num)) {\n    return \"Must be a positive whole number\";\n  }\n  return undefined;\n};\n\ntype RenewalFormProps = {\n  currentPackage: PaymentPackage;\n};\n\nconst packageTypeChoices = [\n  { id: \"session-based\", name: \"Session-based\" },\n  { id: \"time-based\", name: \"Time-based\" },\n  { id: \"post-payment\", name: \"Post-payment\" },\n];\n\nexport const RenewalForm = ({ currentPackage }: RenewalFormProps) => {\n  const packageType = useWatch({ name: \"package_type\" }) || currentPackage.package_type || \"session-based\";\n  const [priceMode, setPriceMode] = useState<\"total\" | \"perHour\">(\n    currentPackage.price_per_hour ? \"perHour\" : \"total\"\n  );\n  const { setValue, reset } = useFormContext();\n  const startDate = useWatch({ name: \"start_date\" });\n\n  // Watch for changes in time-based fields to calculate price\n  const totalAmount = useWatch({ name: \"total_amount\" });\n  const pricePerHour = useWatch({ name: \"price_per_hour\" });\n  const durationDays = useWatch({ name: \"duration_days\" });\n  const hoursPerDay = useWatch({ name: \"hours_per_day\" });\n\n  // Initialize form with current package values\n  useEffect(() => {\n    const defaultValues = {\n      patient_id: currentPackage.patient_id,\n      service_id: currentPackage.service_id,\n      package_type: currentPackage.package_type,\n      total_amount: currentPackage.total_amount,\n      price_per_hour: currentPackage.price_per_hour,\n      total_sessions: currentPackage.total_sessions,\n      total_hours: currentPackage.total_hours,\n      duration_days: currentPackage.duration_days,\n      hours_per_day: currentPackage.hours_per_day,\n      start_date: new Date().toISOString().split(\"T\")[0], // Default to today for renewal\n    };\n    reset(defaultValues);\n  }, [currentPackage, reset]);\n\n  // Auto-calculate price_per_hour when total_amount, duration_days, or hours_per_day changes\n  useEffect(() => {\n    if (packageType === \"time-based\" && priceMode === \"total\") {\n      if (totalAmount && durationDays && hoursPerDay && hoursPerDay > 0) {\n        const totalHours = durationDays * hoursPerDay;\n        if (totalHours > 0) {\n          const calculatedPricePerHour = totalAmount / totalHours;\n          setValue(\"price_per_hour\", calculatedPricePerHour, { shouldDirty: false, shouldValidate: false });\n          setValue(\"total_hours\", totalHours, { shouldDirty: false, shouldValidate: false });\n        }\n      }\n    }\n  }, [packageType, priceMode, totalAmount, durationDays, hoursPerDay, setValue]);\n\n  // Auto-calculate total_amount when price_per_hour, duration_days, or hours_per_day changes\n  useEffect(() => {\n    if (packageType === \"time-based\" && priceMode === \"perHour\") {\n      if (pricePerHour && durationDays && hoursPerDay && hoursPerDay > 0) {\n        const totalHours = durationDays * hoursPerDay;\n        if (totalHours > 0) {\n          const calculatedTotalAmount = pricePerHour * totalHours;\n          setValue(\"total_amount\", calculatedTotalAmount, { shouldDirty: false, shouldValidate: false });\n          setValue(\"total_hours\", totalHours, { shouldDirty: false, shouldValidate: false });\n        }\n      }\n    }\n  }, [packageType, priceMode, pricePerHour, durationDays, hoursPerDay, setValue]);\n\n  // Auto-calculate end_date and renewal_date when start_date or duration_days changes\n  useEffect(() => {\n    if (packageType === \"time-based\" && startDate && durationDays) {\n      const start = new Date(startDate);\n      const end = new Date(start);\n      end.setDate(end.getDate() + durationDays);\n      const endDateStr = end.toISOString().split(\"T\")[0];\n      setValue(\"end_date\", endDateStr, { shouldDirty: false, shouldValidate: false });\n      setValue(\"renewal_date\", endDateStr, { shouldDirty: false, shouldValidate: false });\n    }\n  }, [packageType, startDate, durationDays, setValue]);\n\n  return (\n    <div className=\"flex flex-col gap-6\">\n      {/* Basic Information */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Basic Information</CardTitle>\n          <CardDescription>Review and update patient, service, and package type</CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n            <ReferenceInput\n              source=\"patient_id\"\n              reference=\"clients\"\n              filter={{ isClient: true, \"archived_at@is\": null }}\n            >\n            <AutocompleteInput\n              label=\"Patient\"\n              optionText={(contact: any) => `${contact.first_name} ${contact.last_name}`}\n              helperText={false}\n              validate={required()}\n            />\n          </ReferenceInput>\n\n          <ReferenceInput\n            source=\"service_id\"\n            reference=\"services\"\n          >\n            <AutocompleteInput\n              label=\"Service\"\n              optionText=\"name\"\n              helperText={false}\n            />\n          </ReferenceInput>\n\n          <RadioButtonGroupInput\n            source=\"package_type\"\n            label=\"Package Type\"\n            choices={packageTypeChoices}\n            validate={required()}\n            row\n            helperText={false}\n          />\n        </CardContent>\n      </Card>\n\n      {/* Session-based Package Fields */}\n      {packageType === \"session-based\" && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Session-based Package Details</CardTitle>\n            <CardDescription>Enter total amount and number of sessions</CardDescription>\n          </CardHeader>\n          <CardContent className=\"flex flex-col gap-4\">\n            <NumberInput\n              source=\"total_amount\"\n              label=\"Total Amount (AED)\"\n              validate={[required(), validatePositive]}\n              helperText={false}\n              min={0}\n              step={0.01}\n            />\n            <NumberInput\n              source=\"total_sessions\"\n              label=\"Total Sessions\"\n              validate={[required(), validatePositiveInteger]}\n              helperText={false}\n              min={1}\n            />\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Time-based Package Fields */}\n      {packageType === \"time-based\" && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Time-based Package Details</CardTitle>\n            <CardDescription>Configure duration and pricing</CardDescription>\n          </CardHeader>\n          <CardContent className=\"flex flex-col gap-4\">\n            {/* Price Mode Toggle */}\n            <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n              <div className=\"flex flex-col\">\n                <Label className=\"text-sm font-medium\">Price Entry Mode</Label>\n                <span className=\"text-xs text-muted-foreground\">\n                  Choose how to enter the package price\n                </span>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <span className={`text-sm ${priceMode === \"total\" ? \"font-medium\" : \"text-muted-foreground\"}`}>\n                  Total Price\n                </span>\n                <Switch\n                  checked={priceMode === \"perHour\"}\n                  onCheckedChange={(checked) => setPriceMode(checked ? \"perHour\" : \"total\")}\n                />\n                <span className={`text-sm ${priceMode === \"perHour\" ? \"font-medium\" : \"text-muted-foreground\"}`}>\n                  Price Per Hour\n                </span>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Conditional Price Fields */}\n            {priceMode === \"total\" ? (\n              <NumberInput\n                source=\"total_amount\"\n                label=\"Total Amount (AED)\"\n                validate={[required(), validatePositive]}\n                helperText={false}\n                min={0}\n                step={0.01}\n              />\n            ) : (\n              <NumberInput\n                source=\"price_per_hour\"\n                label=\"Price Per Hour (AED)\"\n                validate={[required(), validatePositive]}\n                helperText={false}\n                min={0}\n                step={0.01}\n              />\n            )}\n\n            {/* Duration Fields */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <NumberInput\n                source=\"duration_days\"\n                label=\"Duration (Days)\"\n                validate={[required(), validatePositiveInteger]}\n                helperText={false}\n                min={1}\n              />\n              <NumberInput\n                source=\"hours_per_day\"\n                label=\"Hours Per Day\"\n                validate={[required(), validatePositive]}\n                helperText={false}\n                min={0.1}\n                max={24}\n                step={0.1}\n              />\n            </div>\n\n            {/* Calculated Display */}\n            <PriceCalculationDisplay\n              priceMode={priceMode}\n              totalAmount={totalAmount}\n              pricePerHour={pricePerHour}\n              durationDays={durationDays}\n              hoursPerDay={hoursPerDay}\n            />\n            \n            {/* Hidden field to store total_hours */}\n            <input type=\"hidden\" name=\"total_hours\" />\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Post-payment Package Fields */}\n      {packageType === \"post-payment\" && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Post-payment Package Details</CardTitle>\n            <CardDescription>Enter amount and optionally link to appointment</CardDescription>\n          </CardHeader>\n          <CardContent className=\"flex flex-col gap-4\">\n            <NumberInput\n              source=\"total_amount\"\n              label=\"Total Amount (AED)\"\n              validate={[required(), validatePositive]}\n              helperText={false}\n              min={0}\n              step={0.01}\n            />\n            <ReferenceInput\n              source=\"appointment_id\"\n              reference=\"appointments\"\n              filter={{ status: \"completed\" }}\n            >\n              <AutocompleteInput\n                label=\"Link to Appointment (Optional)\"\n                optionText={(appointment: any) => \n                  `${appointment.appointment_type} - ${new Date(appointment.appointment_date).toLocaleDateString()}`\n                }\n                helperText={false}\n              />\n            </ReferenceInput>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Common Fields */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Package Schedule</CardTitle>\n          <CardDescription>Set start date and optional end/renewal dates</CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n          <DateInput\n            source=\"start_date\"\n            label=\"Start Date\"\n            validate={required()}\n            helperText={false}\n          />\n          <DateInput\n            source=\"end_date\"\n            label=\"End Date (Auto-calculated for time-based)\"\n            helperText={false}\n          />\n          <DateInput\n            source=\"renewal_date\"\n            label=\"Renewal Date (Auto-calculated for time-based)\"\n            helperText={false}\n          />\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\n// Helper component to display calculated values\nconst PriceCalculationDisplay = ({\n  priceMode,\n  totalAmount,\n  pricePerHour,\n  durationDays,\n  hoursPerDay,\n}: {\n  priceMode: \"total\" | \"perHour\";\n  totalAmount?: number;\n  pricePerHour?: number;\n  durationDays?: number;\n  hoursPerDay?: number;\n}) => {\n  const [calculatedTotal, setCalculatedTotal] = useState<number | null>(null);\n  const [calculatedPricePerHour, setCalculatedPricePerHour] = useState<number | null>(null);\n  const [totalHours, setTotalHours] = useState<number | null>(null);\n\n  useEffect(() => {\n    if (durationDays && hoursPerDay) {\n      const hours = durationDays * hoursPerDay;\n      setTotalHours(hours);\n\n      if (priceMode === \"total\" && totalAmount && hours > 0) {\n        // Calculate price per hour from total\n        setCalculatedPricePerHour(totalAmount / hours);\n        setCalculatedTotal(null);\n      } else if (priceMode === \"perHour\" && pricePerHour && hours > 0) {\n        // Calculate total from price per hour\n        setCalculatedTotal(pricePerHour * hours);\n        setCalculatedPricePerHour(null);\n      } else {\n        setCalculatedTotal(null);\n        setCalculatedPricePerHour(null);\n      }\n    } else {\n      setCalculatedTotal(null);\n      setCalculatedPricePerHour(null);\n      setTotalHours(null);\n    }\n  }, [priceMode, totalAmount, pricePerHour, durationDays, hoursPerDay]);\n\n  if (!calculatedTotal && !calculatedPricePerHour && !totalHours) {\n    return null;\n  }\n\n  return (\n    <div className=\"p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border\">\n      <div className=\"text-sm font-medium mb-2\">Calculated Values</div>\n      <div className=\"space-y-1 text-sm\">\n        {totalHours !== null && (\n          <div>Total Hours: <span className=\"font-medium\">{totalHours.toFixed(1)}</span></div>\n        )}\n        {calculatedPricePerHour !== null && (\n          <div>Price Per Hour: <span className=\"font-medium\">AED {calculatedPricePerHour.toFixed(2)}</span></div>\n        )}\n        {calculatedTotal !== null && (\n          <div>Total Amount: <span className=\"font-medium\">AED {calculatedTotal.toFixed(2)}</span></div>\n        )}\n      </div>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentTransactionList.tsx",
      "content": "import { List } from \"@/components/admin/list\";\nimport { DataTable } from \"@/components/admin/data-table\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Badge } from \"@/components/ui/badge\";\nimport type { PaymentTransaction } from \"./types\";\n\nconst PaymentTransactionListContent = () => {\n  return (\n    <DataTable rowClick=\"show\">\n      <DataTable.Col\n        source=\"id\"\n        label=\"ID\"\n        headerClassName=\"text-left\"\n        cellClassName=\"text-left\"\n        render={(record: PaymentTransaction) => `#${record.id}`}\n      />\n      <DataTable.Col\n        source=\"payment_package_id\"\n        label=\"Package\"\n        headerClassName=\"text-left\"\n        cellClassName=\"text-left\"\n      >\n        <ReferenceField source=\"payment_package_id\" reference=\"payment_packages\" link=\"show\" />\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"amount_received\"\n        label=\"Amount Received\"\n        headerClassName=\"text-right\"\n        cellClassName=\"text-right\"\n        render={(record: PaymentTransaction) => (\n          <span className=\"font-semibold\">\n            AED {record.amount_received.toLocaleString()}\n          </span>\n        )}\n      />\n      <DataTable.Col\n        source=\"payment_method\"\n        label=\"Method\"\n        headerClassName=\"text-center\"\n        cellClassName=\"text-center\"\n        render={(record: PaymentTransaction) => (\n          <Badge variant=\"outline\">{record.payment_method}</Badge>\n        )}\n      />\n      <DataTable.Col\n        source=\"bank_charge\"\n        label=\"Bank Charge\"\n        headerClassName=\"text-right\"\n        cellClassName=\"text-right\"\n        render={(record: PaymentTransaction) => (\n          <span className=\"text-muted-foreground\">\n            AED {record.bank_charge.toLocaleString()}\n          </span>\n        )}\n      />\n      <DataTable.Col\n        source=\"net_amount\"\n        label=\"Net Amount\"\n        headerClassName=\"text-right\"\n        cellClassName=\"text-right\"\n        render={(record: PaymentTransaction) => (\n          <span className=\"font-medium text-green-600 dark:text-green-400\">\n            AED {record.net_amount.toLocaleString()}\n          </span>\n        )}\n      />\n      <DataTable.Col\n        source=\"date_paid\"\n        label=\"Date Paid\"\n        field={DateField}\n        headerClassName=\"text-right\"\n        cellClassName=\"text-right\"\n      />\n      <DataTable.Col\n        source=\"invoice_number\"\n        label=\"Invoice\"\n        headerClassName=\"text-right\"\n        cellClassName=\"text-right\"\n        render={(record: PaymentTransaction) => (\n          record.invoice_number ? (\n            <span className=\"text-sm\">{record.invoice_number}</span>\n          ) : (\n            <span className=\"text-muted-foreground text-sm\"></span>\n          )\n        )}\n      />\n    </DataTable>\n  );\n};\n\nexport const PaymentTransactionList = () => {\n  return (\n    <List title=\"Payment Transactions\">\n      <PaymentTransactionListContent />\n    </List>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentTransactionForm.tsx",
      "content": "import { useState, useEffect, useMemo } from \"react\";\nimport { required } from \"ra-core\";\nimport { useFormContext, useWatch } from \"react-hook-form\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { NumberInput } from \"@/components/admin/number-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ChevronDown } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useGetList } from \"ra-core\";\nimport type { PaymentTransaction, PaymentPackage } from \"./types\";\nimport type { Contact } from \"../types\";\nimport { useBankChargeCalculation } from \"./BankChargeCalculator\";\nimport { usePaymentSettings } from \"@/hooks/usePaymentSettings\";\n\n// Validation functions\nconst validatePositive = (value: any) => {\n  if (value == null || value === \"\") return undefined;\n  const num = typeof value === \"number\" ? value : parseFloat(value);\n  if (isNaN(num) || num <= 0) {\n    return \"Must be greater than 0\";\n  }\n  return undefined;\n};\n\nconst validateNonNegative = (value: any) => {\n  if (value == null || value === \"\") return undefined;\n  const num = typeof value === \"number\" ? value : parseFloat(value);\n  if (isNaN(num) || num < 0) {\n    return \"Must be 0 or greater\";\n  }\n  return undefined;\n};\n\ntype PaymentTransactionFormProps = {\n  record?: PaymentTransaction | null;\n  defaultPackageId?: string | number;\n  defaultAppointmentId?: string | number;\n};\n\nconst paymentMethodChoices = [\n  { id: \"POS\", name: \"POS\" },\n  { id: \"Tabby\", name: \"Tabby\" },\n  { id: \"Payment Link\", name: \"Payment Link\" },\n  { id: \"Ziina\", name: \"Ziina\" },\n  { id: \"Cash\", name: \"Cash\" },\n];\n\nexport const PaymentTransactionForm = ({ record, defaultPackageId, defaultAppointmentId }: PaymentTransactionFormProps) => {\n  const { setValue, getValues } = useFormContext();\n  \n  // Custom validation: require at least one of package_id or appointment_id\n  const validatePackageOrAppointment = (value: any) => {\n    const formValues = getValues();\n    const packageId = value || formValues?.payment_package_id;\n    const appointmentId = formValues?.appointment_id || defaultAppointmentId;\n    \n    if (!packageId && !appointmentId) {\n      return \"Either a payment package or appointment must be selected\";\n    }\n    return undefined;\n  };\n  const [useDefaultBankCharge, setUseDefaultBankCharge] = useState(true);\n  const [showCalculationBreakdown, setShowCalculationBreakdown] = useState(false);\n\n  // Watch form values\n  const paymentPackageId = useWatch({ name: \"payment_package_id\" }) || defaultPackageId;\n  const appointmentId = useWatch({ name: \"appointment_id\" });\n  const amountReceived = useWatch({ name: \"amount_received\" });\n  const paymentMethod = useWatch({ name: \"payment_method\" });\n  const bankCharge = useWatch({ name: \"bank_charge\" });\n  const datePaid = useWatch({ name: \"date_paid\" });\n  const dateReceived = useWatch({ name: \"date_received\" });\n\n  // Fetch payment package to get installment info\n  const { data: packageData } = useGetList<PaymentPackage>(\n    \"payment_packages\",\n    {\n      pagination: { page: 1, perPage: 1 },\n      filter: paymentPackageId ? { id: paymentPackageId } : {},\n    },\n    { enabled: !!paymentPackageId }\n  );\n\n  const selectedPackage = packageData?.[0];\n\n  // Fetch patients for name lookup\n  const { data: patients } = useGetList<Contact>(\"clients\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n\n  // Create patients map for quick lookup\n  const patientsMap = useMemo(() => {\n    if (!patients) return new Map<number, Contact>();\n    return new Map(patients.map((p) => [Number(p.id), p]));\n  }, [patients]);\n\n  // Calculate bank charge using hook\n  const { calculation: bankChargeCalculation, isLoading: calculatingCharge } = useBankChargeCalculation(\n    amountReceived,\n    paymentMethod as any\n  );\n\n  // Auto-calculate bank charge when amount or payment method changes (if using default)\n  useEffect(() => {\n    if (useDefaultBankCharge && bankChargeCalculation && amountReceived && paymentMethod) {\n      setValue(\"bank_charge\", bankChargeCalculation.totalCharge, { shouldDirty: false, shouldValidate: false });\n    }\n  }, [useDefaultBankCharge, bankChargeCalculation, amountReceived, paymentMethod, setValue]);\n\n  // Auto-calculate net amount\n  useEffect(() => {\n    if (amountReceived != null && bankCharge != null) {\n      const netAmount = amountReceived - bankCharge;\n      setValue(\"net_amount\", netAmount, { shouldDirty: false, shouldValidate: false });\n    }\n  }, [amountReceived, bankCharge, setValue]);\n\n  // Set default dates to today\n  useEffect(() => {\n    if (!record) {\n      const today = new Date().toISOString().split(\"T\")[0];\n      if (!datePaid) {\n        setValue(\"date_paid\", today);\n      }\n      if (!dateReceived) {\n        setValue(\"date_received\", today);\n      }\n    }\n  }, [record, datePaid, dateReceived, setValue]);\n\n\n  // Set default package if provided\n  useEffect(() => {\n    if (defaultPackageId && !paymentPackageId) {\n      setValue(\"payment_package_id\", defaultPackageId);\n    }\n  }, [defaultPackageId, paymentPackageId, setValue]);\n\n  // Set default appointment if provided\n  useEffect(() => {\n    if (defaultAppointmentId && !appointmentId) {\n      setValue(\"appointment_id\", defaultAppointmentId);\n    }\n  }, [defaultAppointmentId, appointmentId, setValue]);\n\n  const netAmount = amountReceived && bankCharge ? amountReceived - bankCharge : 0;\n\n  return (\n    <div className=\"flex flex-col gap-6\">\n      {/* Payment Package Selection (Optional) */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Payment Package (Optional)</CardTitle>\n          <CardDescription>\n            Select a payment package, or leave empty for a standalone payment\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n          <ReferenceInput\n            source=\"payment_package_id\"\n            reference=\"payment_packages\"\n          >\n            <AutocompleteInput\n              label=\"Payment Package\"\n              optionText={(pkg: PaymentPackage) => {\n                // Get patient name from map\n                const patient = patientsMap.get(Number(pkg.patient_id));\n                const patientName = patient \n                  ? `${patient.first_name} ${patient.last_name}`.trim()\n                  : `Patient #${pkg.patient_id}`;\n                \n                // Use package name if available, otherwise use ID\n                const packageName = (pkg as any).name || `Package #${pkg.id}`;\n                \n                // Return: \"Package Name - Patient Name - AED Amount\"\n                return `${packageName} - ${patientName} - AED ${pkg.total_amount.toLocaleString()}`;\n              }}\n              helperText=\"Leave empty to create a standalone payment\"\n              validate={validatePackageOrAppointment}\n            />\n          </ReferenceInput>\n\n          {selectedPackage && (\n            <div className=\"p-3 bg-slate-50 dark:bg-slate-800 rounded-lg text-sm\">\n              <p className=\"font-medium\">Package Details:</p>\n              <p className=\"text-muted-foreground\">\n                Type: {selectedPackage.package_type} | Total: AED {selectedPackage.total_amount.toLocaleString()}\n              </p>\n              {selectedPackage.next_payment_date && (\n                <p className=\"text-muted-foreground mt-1\">\n                  Next payment scheduled: {new Date(selectedPackage.next_payment_date).toLocaleDateString()}\n                </p>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Payment Details */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Payment Details</CardTitle>\n          <CardDescription>Enter payment amount and method</CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n          <NumberInput\n            source=\"amount_received\"\n            label=\"Amount Received (AED)\"\n            validate={[required(), validatePositive]}\n            helperText=\"Gross amount before bank charges\"\n            min={0}\n            step={0.01}\n          />\n\n          <SelectInput\n            source=\"payment_method\"\n            label=\"Payment Method\"\n            choices={paymentMethodChoices}\n            validate={required()}\n            helperText={false}\n          />\n\n          {/* Bank Charge Section */}\n          <div className=\"p-4 border rounded-lg space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex flex-col\">\n                <Label className=\"text-sm font-medium\">Bank Charge Calculation</Label>\n                <span className=\"text-xs text-muted-foreground\">\n                  Use default calculation or enter manually\n                </span>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <span className={`text-sm ${useDefaultBankCharge ? \"font-medium\" : \"text-muted-foreground\"}`}>\n                  Use Default\n                </span>\n                <Switch\n                  checked={useDefaultBankCharge}\n                  onCheckedChange={setUseDefaultBankCharge}\n                />\n                <span className={`text-sm ${!useDefaultBankCharge ? \"font-medium\" : \"text-muted-foreground\"}`}>\n                  Manual Entry\n                </span>\n              </div>\n            </div>\n\n            <NumberInput\n              source=\"bank_charge\"\n              label=\"Bank Charge (AED)\"\n              validate={[required(), validateNonNegative]}\n              helperText={useDefaultBankCharge ? \"Auto-calculated based on payment method\" : \"Enter bank charge manually\"}\n              min={0}\n              step={0.01}\n              disabled={useDefaultBankCharge && calculatingCharge}\n            />\n\n            {/* Calculation Breakdown */}\n            {bankChargeCalculation && useDefaultBankCharge && (\n              <div className=\"space-y-2\">\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"w-full justify-between\"\n                  onClick={() => setShowCalculationBreakdown(!showCalculationBreakdown)}\n                >\n                  <span className=\"text-sm\">Show Calculation Breakdown</span>\n                  <ChevronDown className={`h-4 w-4 transition-transform ${showCalculationBreakdown ? \"rotate-180\" : \"\"}`} />\n                </Button>\n                {showCalculationBreakdown && (\n                  <div className=\"p-3 bg-slate-50 dark:bg-slate-800 rounded-lg space-y-1 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span>Base Fee:</span>\n                      <span className=\"font-medium\">AED {bankChargeCalculation.baseFee.toFixed(2)}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>VAT ({paymentMethod === \"POS\" ? \"5%\" : paymentMethod === \"Payment Link\" ? \"5%\" : \"5%\"}):</span>\n                      <span className=\"font-medium\">AED {bankChargeCalculation.vatAmount.toFixed(2)}</span>\n                    </div>\n                    <Separator />\n                    <div className=\"flex justify-between font-semibold\">\n                      <span>Total Charge:</span>\n                      <span>AED {bankChargeCalculation.totalCharge.toFixed(2)}</span>\n                    </div>\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n\n          {/* Net Amount Display - value is set via useEffect setValue */}\n          <div className=\"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800\">\n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-sm font-medium\">Net Amount (After Charges):</span>\n              <span className=\"text-lg font-semibold text-green-700 dark:text-green-400\">\n                AED {netAmount.toFixed(2)}\n              </span>\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Amount received minus bank charges (auto-calculated)\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Payment Dates and Invoice */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Payment Information</CardTitle>\n          <CardDescription>Record payment dates and invoice details</CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <DateInput\n              source=\"date_paid\"\n              label=\"Date Paid\"\n              validate={required()}\n              helperText={false}\n            />\n            <DateInput\n              source=\"date_received\"\n              label=\"Date Received\"\n              validate={required()}\n              helperText={false}\n            />\n          </div>\n\n          <TextInput\n            source=\"invoice_number\"\n            label=\"Invoice Number\"\n            helperText=\"Optional invoice number from accounting system\"\n          />\n        </CardContent>\n      </Card>\n\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentTransactionEdit.tsx",
      "content": "import { EditBase, Form } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { PaymentTransactionForm } from \"./PaymentTransactionForm\";\n\nexport const PaymentTransactionEdit = () => {\n  return (\n    <EditBase redirect=\"list\">\n      <div className=\"max-w-4xl w-full mx-auto mt-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Edit Payment Transaction</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Form className=\"flex flex-col gap-4\">\n              <PaymentTransactionForm />\n              <FormToolbar>\n                <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n                  <DeleteButton redirect=\"list\" />\n                  <div className=\"flex flex-row gap-2 justify-end\">\n                    <CancelButton />\n                    <SaveButton />\n                  </div>\n                </div>\n              </FormToolbar>\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </EditBase>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentTransactionCreate.tsx",
      "content": "import { CreateBase, Form } from \"ra-core\";\nimport { useSearchParams } from \"react-router\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { PaymentTransactionForm } from \"./PaymentTransactionForm\";\n\nexport const PaymentTransactionCreate = () => {\n  // Get package ID from query parameters (e.g., /payment_transactions/create?package_id=123)\n  const [searchParams] = useSearchParams();\n  const packageId = searchParams.get(\"package_id\");\n\n  return (\n    <CreateBase redirect=\"list\">\n      <div className=\"max-w-4xl w-full mx-auto mt-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Record Payment</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Form className=\"flex flex-col gap-4\">\n              <PaymentTransactionForm defaultPackageId={packageId} />\n              <FormToolbar />\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </CreateBase>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentPackagesPage.tsx",
      "content": "import { List } from \"@/components/admin/list\";\nimport { PaymentPackageList, PaymentPackageListActions, filters } from \"./PaymentPackageList\";\n\nexport const PaymentPackagesPage = () => {\n  return (\n    <List filters={filters} actions={<PaymentPackageListActions />}>\n      <PaymentPackageList />\n    </List>\n  );\n};\n\nPaymentPackagesPage.path = \"/payment-packages\";\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentPackageShow.tsx",
      "content": "import { useState } from \"react\";\nimport { ShowBase, useShowContext, useGetList, useCreatePath, useCreate, useUpdate, useDelete, useNotify, Form, useRedirect, useRefresh } from \"ra-core\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { Show } from \"@/components/admin/show\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { PaymentPackageDeleteButton } from \"./PaymentPackageDeleteButton\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Plus, RefreshCw, Edit, ExternalLink, ArrowLeft, Trash2 } from \"lucide-react\";\nimport { Link } from \"react-router\";\nimport type { PaymentPackage, PaymentTransaction, PackageUsage } from \"../types\";\nimport { PackageDetailsView } from \"./PackageDetailsView\";\nimport { UsageTracker } from \"./UsageTracker\";\nimport { UsageAdjustmentForm } from \"./UsageAdjustmentForm\";\nimport { RenewalForm } from \"./RenewalForm\";\nimport { InstallmentSchedule as InstallmentScheduleComponent } from \"./InstallmentSchedule\";\nimport { usePackageUsage } from \"@/hooks/usePackageUsage\";\n\nexport const PaymentPackageShow = () => (\n  <ShowBase>\n    <PaymentPackageShowContent />\n  </ShowBase>\n);\n\nconst PaymentPackageShowContent = () => {\n  const { record, isPending } = useShowContext<PaymentPackage>();\n  const createPath = useCreatePath();\n  const createPaymentPath = createPath({ resource: \"payment_transactions\", type: \"create\" });\n  const [isAdjustmentDialogOpen, setIsAdjustmentDialogOpen] = useState(false);\n  const [isRenewalDialogOpen, setIsRenewalDialogOpen] = useState(false);\n  const [isRenewalConfirmOpen, setIsRenewalConfirmOpen] = useState(false);\n  const [renewalData, setRenewalData] = useState<any>(null);\n  const [isRenewalSubmitting, setIsRenewalSubmitting] = useState(false);\n  const [newPackageId, setNewPackageId] = useState<number | null>(null);\n  const [usageToDelete, setUsageToDelete] = useState<PackageUsage | null>(null);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [create] = useCreate();\n  const [update] = useUpdate();\n  const [deleteOne] = useDelete();\n  const notify = useNotify();\n  const redirect = useRedirect();\n  const refresh = useRefresh();\n  const queryClient = useQueryClient();\n\n  // Use the usePackageUsage hook to get usage data\n  const { sessionsUsed, hoursUsed, refetch: refetchUsage } = usePackageUsage(record?.id);\n\n  // Fetch payment transactions\n  const { data: transactions, isLoading: transactionsLoading } = useGetList<PaymentTransaction>(\n    \"payment_transactions\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date_paid\", order: \"DESC\" },\n      filter: record?.id ? { payment_package_id: record.id } : {},\n    },\n    { enabled: !!record?.id }\n  );\n\n  // Fetch package usage records\n  const { data: usageRecords, isLoading: usageLoading, refetch: refetchUsageRecords } = useGetList<PackageUsage>(\n    \"package_usage\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"usage_date\", order: \"DESC\" },\n      filter: record?.id ? { payment_package_id: record.id } : {},\n    },\n    { enabled: !!record?.id }\n  );\n\n\n  const handleAdjustUsage = async (data: {\n    usage_type: \"session\" | \"hours\";\n    quantity_used: number;\n    usage_date: string;\n    notes?: string;\n  }) => {\n    if (!record?.id) {\n      notify(\"Package not found\", { type: \"error\" });\n      return;\n    }\n    try {\n      await create(\"package_usage\", {\n        data: {\n          payment_package_id: record.id,\n          usage_type: data.usage_type,\n          quantity_used: data.quantity_used,\n          usage_date: data.usage_date,\n          notes: data.notes || null,\n          is_manual_adjustment: true,\n        },\n      });\n      notify(\"Usage adjustment recorded successfully\", { type: \"success\" });\n      setIsAdjustmentDialogOpen(false);\n      // Invalidate and refetch usage data\n      queryClient.invalidateQueries({ queryKey: [\"packageUsage\", record.id] });\n      await refetchUsage();\n      await refetchUsageRecords();\n    } catch (error: any) {\n      notify(`Failed to record usage adjustment: ${error.message}`, { type: \"error\" });\n    }\n  };\n\n  const handleDeleteUsage = async () => {\n    if (!usageToDelete?.id) {\n      return;\n    }\n    try {\n      await deleteOne(\"package_usage\", { id: usageToDelete.id });\n      notify(\"Usage record deleted successfully\", { type: \"success\" });\n      setIsDeleteDialogOpen(false);\n      setUsageToDelete(null);\n      // Invalidate and refetch usage data\n      queryClient.invalidateQueries({ queryKey: [\"packageUsage\", record?.id] });\n      await refetchUsage();\n      await refetchUsageRecords();\n    } catch (error: any) {\n      notify(`Failed to delete usage record: ${error.message}`, { type: \"error\" });\n    }\n  };\n\n  // Fetch renewed from package (parent package)\n  const { data: renewedFromPackage } = useGetList<PaymentPackage>(\n    \"payment_packages\",\n    {\n      pagination: { page: 1, perPage: 1 },\n      filter: record?.renewed_from_package_id ? { id: record.renewed_from_package_id } : {},\n    },\n    { enabled: !!record?.renewed_from_package_id }\n  );\n\n  // Fetch renewed to package (child package)\n  const { data: renewedToPackages } = useGetList<PaymentPackage>(\n    \"payment_packages\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      filter: record?.id ? { renewed_from_package_id: record.id } : {},\n    },\n    { enabled: !!record?.id }\n  );\n\n  const handleRenewalSubmit = async (data: any) => {\n    setRenewalData(data);\n    setIsRenewalConfirmOpen(true);\n  };\n\n  const handleRenewalConfirm = async () => {\n    if (!renewalData || !record) return;\n\n    setIsRenewalSubmitting(true);\n    try {\n      // Calculate end_date and renewal_date for time-based packages\n      let endDate = renewalData.end_date;\n      let renewalDate = renewalData.renewal_date;\n\n      if (renewalData.package_type === \"time-based\" && renewalData.start_date && renewalData.duration_days) {\n        const start = new Date(renewalData.start_date);\n        const end = new Date(start);\n        end.setDate(end.getDate() + renewalData.duration_days);\n        endDate = end.toISOString().split(\"T\")[0];\n        renewalDate = endDate;\n      }\n\n      // Create new package with renewal data\n      const newPackageData = {\n        ...renewalData,\n        end_date: endDate || null,\n        renewal_date: renewalDate || null,\n        renewed_from_package_id: record.id,\n        status: \"active\" as const,\n      };\n\n      const { data: newPackage } = await create(\"payment_packages\", {\n        data: newPackageData,\n      });\n\n      // Mark old package as completed\n      await update(\"payment_packages\", {\n        id: record.id,\n        data: { status: \"completed\" },\n        previousData: record,\n      });\n\n      setNewPackageId(newPackage.id);\n      setIsRenewalConfirmOpen(false);\n      setIsRenewalDialogOpen(false);\n      setIsRenewalSubmitting(false);\n      refresh();\n      notify(\"Package renewed successfully\", { type: \"success\" });\n    } catch (error: any) {\n      notify(`Failed to renew package: ${error.message}`, { type: \"error\" });\n      setIsRenewalSubmitting(false);\n    }\n  };\n\n  const handleRecordPaymentAfterRenewal = () => {\n    if (newPackageId) {\n      redirect(\"create\", \"payment_transactions\", undefined, { package_id: newPackageId });\n      setNewPackageId(null);\n    }\n  };\n\n  if (isPending || !record) return null;\n\n  const totalPaid = transactions?.reduce((sum, t) => sum + t.amount_received, 0) || 0;\n  const totalNetAmount = transactions?.reduce((sum, t) => sum + t.net_amount, 0) || 0;\n\n  return (\n    <Show\n      title={`Payment Package #${record.id}`}\n      actions={\n        <TopToolbar>\n          <EditButton />\n          <Button variant=\"outline\" size=\"sm\" asChild>\n            <Link to={`${createPaymentPath}?package_id=${record.id}`}>\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Record Payment\n            </Link>\n          </Button>\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            onClick={() => setIsRenewalDialogOpen(true)}\n            disabled={record.status === \"completed\" || record.status === \"expired\"}\n          >\n            <RefreshCw className=\"mr-2 h-4 w-4\" />\n            Renew Package\n          </Button>\n          <PaymentPackageDeleteButton redirect=\"list\" />\n        </TopToolbar>\n      }\n    >\n      <div className=\"mt-4\">\n        <Tabs defaultValue=\"details\" className=\"w-full\">\n          <TabsList className=\"w-full\">\n            <TabsTrigger value=\"details\" className=\"flex-1\">Details</TabsTrigger>\n            <TabsTrigger value=\"payments\" className=\"flex-1\">Payments</TabsTrigger>\n            <TabsTrigger value=\"usage\" className=\"flex-1\">Usage</TabsTrigger>\n            <TabsTrigger value=\"installments\" className=\"flex-1\">Payment Tracking</TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"details\" className=\"pt-4\">\n            {/* Package History */}\n            {(renewedFromPackage && renewedFromPackage.length > 0) || (renewedToPackages && renewedToPackages.length > 0) ? (\n              <Card className=\"mb-4\">\n                <CardContent className=\"pt-6\">\n                  <h3 className=\"text-lg font-semibold mb-4\">Package History</h3>\n                  <div className=\"space-y-3\">\n                    {renewedFromPackage && renewedFromPackage.length > 0 && (\n                      <div className=\"flex items-center gap-2 p-3 border rounded-lg bg-blue-50 dark:bg-blue-900/20\">\n                        <ArrowLeft className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                        <div className=\"flex-1\">\n                          <p className=\"text-sm text-muted-foreground\">Renewed from</p>\n                          <Link\n                            to={`/payment_packages/${renewedFromPackage[0].id}/show`}\n                            className=\"font-medium text-blue-600 dark:text-blue-400 hover:underline\"\n                          >\n                            Package #{renewedFromPackage[0].id}\n                          </Link>\n                        </div>\n                      </div>\n                    )}\n                    {renewedToPackages && renewedToPackages.length > 0 && (\n                      <div className=\"space-y-2\">\n                        <p className=\"text-sm text-muted-foreground\">Renewed to:</p>\n                        {renewedToPackages.map((pkg) => (\n                          <div key={pkg.id} className=\"flex items-center gap-2 p-3 border rounded-lg bg-green-50 dark:bg-green-900/20\">\n                            <RefreshCw className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                            <div className=\"flex-1\">\n                              <Link\n                                to={`/payment_packages/${pkg.id}/show`}\n                                className=\"font-medium text-green-600 dark:text-green-400 hover:underline\"\n                              >\n                                Package #{pkg.id}\n                              </Link>\n                              <p className=\"text-xs text-muted-foreground mt-1\">\n                                Status: {pkg.status} | Started: {new Date(pkg.start_date).toLocaleDateString()}\n                              </p>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            ) : null}\n            <PackageDetailsView package={record} sessionsUsed={sessionsUsed} hoursUsed={hoursUsed} />\n          </TabsContent>\n\n          <TabsContent value=\"payments\" className=\"pt-4\">\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h3 className=\"text-lg font-semibold\">Payment History</h3>\n                  <Button variant=\"outline\" size=\"sm\" asChild>\n                    <Link to={`${createPaymentPath}?package_id=${record.id}`}>\n                      <Plus className=\"mr-2 h-4 w-4\" />\n                      Record Payment\n                    </Link>\n                  </Button>\n                </div>\n                {transactionsLoading ? (\n                  <p className=\"text-sm text-muted-foreground\">Loading transactions...</p>\n                ) : !transactions || transactions.length === 0 ? (\n                  <div className=\"text-center py-8\">\n                    <p className=\"text-sm text-muted-foreground mb-4\">No payments recorded yet</p>\n                    <Button variant=\"outline\" size=\"sm\" asChild>\n                      <Link to={`${createPaymentPath}?package_id=${record.id}`}>\n                        <Plus className=\"mr-2 h-4 w-4\" />\n                        Record First Payment\n                      </Link>\n                    </Button>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {transactions.map((transaction) => (\n                      <div\n                        key={transaction.id}\n                        className=\"flex items-center justify-between p-4 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800\"\n                      >\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-2 mb-2\">\n                            <p className=\"text-lg font-semibold\">AED {transaction.amount_received.toLocaleString()}</p>\n                            <Badge variant=\"outline\">{transaction.payment_method}</Badge>\n                          </div>\n                          <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                            <div>\n                              <span className=\"font-medium\">Paid:</span> <DateField source=\"date_paid\" record={transaction} />\n                            </div>\n                            <div>\n                              <span className=\"font-medium\">Received:</span> <DateField source=\"date_received\" record={transaction} />\n                            </div>\n                            {transaction.invoice_number && (\n                              <div>\n                                <span className=\"font-medium\">Invoice:</span> {transaction.invoice_number}\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"text-sm font-medium\">Net: AED {transaction.net_amount.toLocaleString()}</p>\n                          {transaction.bank_charge > 0 && (\n                            <p className=\"text-xs text-muted-foreground\">\n                              Fee: AED {transaction.bank_charge.toLocaleString()}\n                            </p>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                    <div className=\"mt-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg\">\n                      <div className=\"grid grid-cols-3 gap-4 text-sm\">\n                        <div>\n                          <p className=\"text-muted-foreground\">Total Paid</p>\n                          <p className=\"text-lg font-semibold\">AED {totalPaid.toLocaleString()}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Net Amount</p>\n                          <p className=\"text-lg font-semibold\">AED {totalNetAmount.toLocaleString()}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Remaining</p>\n                          <p className=\"text-lg font-semibold\">\n                            AED {(record.total_amount - totalPaid).toLocaleString()}\n                          </p>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"usage\" className=\"pt-4\">\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"mb-4\">\n                  <UsageTracker package={record} sessionsUsed={sessionsUsed} hoursUsed={hoursUsed} />\n                </div>\n                <div className=\"mt-6\">\n                  <div className=\"flex items-center justify-between mb-4\">\n                    <h3 className=\"text-lg font-semibold\">Usage Timeline</h3>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setIsAdjustmentDialogOpen(true)}\n                    >\n                      <Edit className=\"mr-2 h-4 w-4\" />\n                      Adjust Usage\n                    </Button>\n                  </div>\n                  {usageLoading ? (\n                    <p className=\"text-sm text-muted-foreground\">Loading usage records...</p>\n                  ) : !usageRecords || usageRecords.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <p className=\"text-sm text-muted-foreground mb-4\">No usage recorded yet</p>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setIsAdjustmentDialogOpen(true)}\n                      >\n                        <Edit className=\"mr-2 h-4 w-4\" />\n                        Add Manual Adjustment\n                      </Button>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {usageRecords.map((usage) => (\n                        <div\n                          key={usage.id}\n                          className={`flex items-center justify-between p-3 border rounded-lg ${\n                            usage.appointment_id\n                              ? \"hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer\"\n                              : \"\"\n                          }`}\n                          onClick={() => {\n                            if (usage.appointment_id) {\n                              window.open(`/appointments/${usage.appointment_id}/show`, \"_blank\");\n                            }\n                          }}\n                        >\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2\">\n                              <p className=\"font-medium\">\n                                {usage.quantity_used.toFixed(usage.usage_type === \"hours\" ? 1 : 0)}{\" \"}\n                                {usage.usage_type === \"hours\" ? \"hours\" : \"sessions\"}\n                              </p>\n                              {usage.is_manual_adjustment && (\n                                <Badge variant=\"outline\" className=\"text-xs\">Manual</Badge>\n                              )}\n                            </div>\n                            <div className=\"flex items-center gap-4 mt-1 text-xs text-muted-foreground\">\n                              <DateField source=\"usage_date\" record={usage} />\n                              {usage.appointment_id ? (\n                                <Link\n                                  to={`/appointments/${usage.appointment_id}/show`}\n                                  className=\"flex items-center gap-1 text-blue-600 dark:text-blue-400 hover:underline\"\n                                  onClick={(e) => e.stopPropagation()}\n                                >\n                                  Appointment #{usage.appointment_id}\n                                  <ExternalLink className=\"h-3 w-3\" />\n                                </Link>\n                              ) : null}\n                              {usage.notes && <span>{usage.notes}</span>}\n                            </div>\n                          </div>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            className=\"ml-2 text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950\"\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              setUsageToDelete(usage);\n                              setIsDeleteDialogOpen(true);\n                            }}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"installments\" className=\"pt-4\">\n            <InstallmentScheduleComponent packageId={record.id} packageData={record} />\n          </TabsContent>\n        </Tabs>\n      </div>\n\n      {/* Usage Adjustment Dialog */}\n      <Dialog open={isAdjustmentDialogOpen} onOpenChange={setIsAdjustmentDialogOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Adjust Package Usage</DialogTitle>\n            <DialogDescription>\n              Manually add or adjust usage for this package. This will create a manual adjustment record.\n            </DialogDescription>\n          </DialogHeader>\n          <Form\n            onSubmit={async (data: any) => {\n              await handleAdjustUsage({\n                usage_type: data.usage_type,\n                quantity_used: data.quantity_used,\n                usage_date: data.usage_date,\n                notes: data.notes,\n              });\n            }}\n            defaultValues={{\n              usage_type: record.package_type === \"session-based\" ? \"session\" : \"hours\",\n              usage_date: new Date().toISOString().split(\"T\")[0],\n            }}\n          >\n            <UsageAdjustmentForm package={record} />\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setIsAdjustmentDialogOpen(false)}\n              >\n                Cancel\n              </Button>\n              <Button type=\"submit\">\n                Save Adjustment\n              </Button>\n            </DialogFooter>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Renewal Dialog */}\n      <Dialog open={isRenewalDialogOpen} onOpenChange={setIsRenewalDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Renew Package</DialogTitle>\n            <DialogDescription>\n              Create a new package based on the current one. All fields are editable. The current package will be marked as completed.\n            </DialogDescription>\n          </DialogHeader>\n          <Form onSubmit={handleRenewalSubmit}>\n            <RenewalForm currentPackage={record} />\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => {\n                  setIsRenewalDialogOpen(false);\n                  setRenewalData(null);\n                }}\n              >\n                Cancel\n              </Button>\n              <Button type=\"submit\">\n                Continue to Confirm\n              </Button>\n            </DialogFooter>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Renewal Confirmation Dialog */}\n      <Dialog open={isRenewalConfirmOpen} onOpenChange={setIsRenewalConfirmOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Confirm Package Renewal</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to create a new package with these parameters? The current package (Package #{record.id}) will be marked as completed.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setIsRenewalConfirmOpen(false);\n                setRenewalData(null);\n              }}\n              disabled={isRenewalSubmitting}\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleRenewalConfirm}\n              disabled={isRenewalSubmitting}\n            >\n              {isRenewalSubmitting ? \"Creating...\" : \"Confirm Renewal\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Prompt to Record Payment After Renewal */}\n      <Dialog open={!!newPackageId} onOpenChange={(open) => !open && setNewPackageId(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Package Renewed Successfully</DialogTitle>\n            <DialogDescription>\n              A new package has been created. Would you like to record a payment for the new package?\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setNewPackageId(null)}\n            >\n              Later\n            </Button>\n            <Button onClick={handleRecordPaymentAfterRenewal}>\n              Record Payment\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Usage Confirmation Dialog */}\n      <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Usage Record</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete this usage record?\n              {usageToDelete && (\n                <div className=\"mt-2 p-2 bg-slate-100 dark:bg-slate-800 rounded text-sm\">\n                  <p className=\"font-medium\">\n                    {usageToDelete.quantity_used.toFixed(usageToDelete.usage_type === \"hours\" ? 1 : 0)}{\" \"}\n                    {usageToDelete.usage_type === \"hours\" ? \"hours\" : \"sessions\"}\n                  </p>\n                  <p className=\"text-muted-foreground text-xs mt-1\">\n                    Date: {new Date(usageToDelete.usage_date).toLocaleDateString()}\n                    {usageToDelete.appointment_id && `  From Appointment #${usageToDelete.appointment_id}`}\n                  </p>\n                </div>\n              )}\n              {usageToDelete && !usageToDelete.is_manual_adjustment && (\n                <p className=\"mt-2 text-sm text-amber-600 dark:text-amber-400\">\n                  Warning: This usage record was automatically created from an appointment. Deleting it may cause inconsistencies.\n                </p>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setIsDeleteDialogOpen(false);\n                setUsageToDelete(null);\n              }}\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleDeleteUsage}\n            >\n              Delete\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Show>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentPackageList.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\nimport { DataTable } from \"@/components/admin/data-table\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { PaymentPackageDeleteButton } from \"./PaymentPackageDeleteButton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { WithRecord } from \"ra-core\";\nimport type { PaymentPackage, Contact, Service } from \"../types\";\n\nconst filters = [\n  <SearchInput key=\"package-search\" source=\"q\" />,\n  <BooleanInput key=\"overdue-installments\" source=\"overdue_installments\" label=\"Overdue Installments\" />,\n  <SelectInput\n    key=\"status-filter\"\n    source=\"status\"\n    label=\"Status\"\n    choices={[\n      { id: \"active\", name: \"Ongoing\" },\n      { id: \"completed\", name: \"Completed\" },\n      { id: \"expired\", name: \"Expired\" },\n    ]}\n  />,\n  <ReferenceInput\n    key=\"patient-filter\"\n    source=\"patient_id\"\n    reference=\"clients\"\n    label=\"Patient\"\n  />,\n  <ReferenceInput\n    key=\"service-filter\"\n    source=\"service_id\"\n    reference=\"services\"\n    label=\"Service\"\n  />,\n  <DateInput\n    key=\"renewal-date-from\"\n    source=\"renewal_date@gte\"\n    label=\"Renewal Date From\"\n  />,\n  <DateInput\n    key=\"renewal-date-to\"\n    source=\"renewal_date@lte\"\n    label=\"Renewal Date To\"\n  />,\n];\n\nconst PaymentPackageListActions = () => (\n  <>\n    <ExportButton />\n    <CreateButton label=\"New Package\" />\n  </>\n);\n\nconst StatusBadge = ({ record }: { record: PaymentPackage }) => {\n  if (!record) return null;\n  \n  const statusColors = {\n    active: \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300\",\n    completed: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n    expired: \"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300\",\n  };\n\n  return (\n    <Badge className={statusColors[record.status] || statusColors.completed}>\n      {record.status}\n    </Badge>\n  );\n};\n\nconst UsageDisplay = ({ record }: { record: PaymentPackage }) => {\n  if (!record) return <span>-</span>;\n  \n  // TODO: Calculate actual usage from package_usage table\n  // For now, show placeholder\n  if (record.package_type === \"session-based\" && record.total_sessions) {\n    return <span>0/{record.total_sessions} sessions</span>;\n  }\n  if (record.package_type === \"time-based\" && record.total_hours) {\n    return <span>0/{record.total_hours} hours</span>;\n  }\n  return <span>-</span>;\n};\n\nconst AmountDisplay = ({ record }: { record: PaymentPackage }) => {\n  if (!record) return <span>-</span>;\n  \n  // TODO: Calculate amount paid from payment_transactions\n  // For now, show total amount\n  return <span>AED {record.total_amount.toLocaleString()}</span>;\n};\n\nexport const PaymentPackageList = () => {\n  return (\n    <DataTable rowClick=\"show\">\n      <DataTable.Col\n        source=\"patient_id\"\n        label=\"Patient\"\n        headerClassName=\"text-left\"\n        cellClassName=\"text-left\"\n      >\n        <ReferenceField source=\"patient_id\" reference=\"clients\" link=\"show\">\n          <WithRecord\n            render={(contact: Contact) => (\n              <span>\n                {contact.first_name} {contact.last_name}\n              </span>\n            )}\n          />\n        </ReferenceField>\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"service_id\"\n        label=\"Service\"\n        headerClassName=\"text-left\"\n        cellClassName=\"text-left\"\n      >\n        <ReferenceField source=\"service_id\" reference=\"services\" link=\"show\">\n          <WithRecord\n            render={(service: Service) => <span>{service.name}</span>}\n          />\n        </ReferenceField>\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"status\"\n        label=\"Status\"\n        headerClassName=\"text-center\"\n        cellClassName=\"text-center\"\n      >\n        <StatusBadge />\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"usage\"\n        label=\"Usage\"\n        headerClassName=\"text-center\"\n        cellClassName=\"text-center\"\n      >\n        <UsageDisplay />\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"renewal_date\"\n        label=\"Renewal Date\"\n        field={DateField}\n        headerClassName=\"text-right\"\n        cellClassName=\"text-right\"\n      />\n      <DataTable.Col\n        source=\"amount\"\n        label=\"Amount\"\n        headerClassName=\"text-right\"\n        cellClassName=\"text-right\"\n      >\n        <AmountDisplay />\n      </DataTable.Col>\n      <DataTable.Col\n        label=\"Actions\"\n        headerClassName=\"text-right\"\n        cellClassName=\"text-right\"\n      >\n        <div className=\"flex justify-end gap-2\">\n          <ShowButton />\n          <EditButton />\n          <PaymentPackageDeleteButton redirect=\"list\" />\n        </div>\n      </DataTable.Col>\n    </DataTable>\n  );\n};\n\nexport { PaymentPackageListActions, filters };\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentPackageForm.tsx",
      "content": "import { useState, useEffect } from \"react\";\nimport { required } from \"ra-core\";\nimport { useFormContext, useWatch } from \"react-hook-form\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { RadioButtonGroupInput } from \"@/components/admin/radio-button-group-input\";\nimport { NumberInput } from \"@/components/admin/number-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport type { PaymentPackage } from \"./types\";\n\n// Validation functions\nconst validatePositive = (value: any) => {\n  if (value == null || value === \"\") return undefined;\n  const num = typeof value === \"number\" ? value : parseFloat(value);\n  if (isNaN(num) || num <= 0) {\n    return \"Must be greater than 0\";\n  }\n  return undefined;\n};\n\nconst validatePositiveInteger = (value: any) => {\n  if (value == null || value === \"\") return undefined;\n  const num = typeof value === \"number\" ? value : parseInt(value, 10);\n  if (isNaN(num) || num <= 0 || !Number.isInteger(num)) {\n    return \"Must be a positive whole number\";\n  }\n  return undefined;\n};\n\nconst validateDateAfterStart = (startDate: string | undefined) => (value: any) => {\n  if (!value || !startDate) return undefined;\n  const valueDate = new Date(value);\n  const start = new Date(startDate);\n  if (valueDate <= start) {\n    return \"Must be after start date\";\n  }\n  return undefined;\n};\n\ntype PaymentPackageFormProps = {\n  record?: PaymentPackage | null;\n};\n\nconst packageTypeChoices = [\n  { id: \"session-based\", name: \"Session-based\" },\n  { id: \"time-based\", name: \"Time-based\" },\n  { id: \"post-payment\", name: \"Post-payment\" },\n];\n\nexport const PaymentPackageForm = ({ record }: PaymentPackageFormProps) => {\n  const packageType = useWatch({ name: \"package_type\" }) || record?.package_type || \"session-based\";\n  const [priceMode, setPriceMode] = useState<\"total\" | \"perHour\">(\"total\");\n  const { setValue } = useFormContext();\n  const startDate = useWatch({ name: \"start_date\" });\n  const patientId = useWatch({ name: \"patient_id\" });\n  const isPatientPreFilled = !!patientId && !record; // Pre-filled if patient_id exists and we're creating (not editing)\n\n  // Watch for changes in time-based fields to calculate price\n  const totalAmount = useWatch({ name: \"total_amount\" });\n  const pricePerHour = useWatch({ name: \"price_per_hour\" });\n  const durationDays = useWatch({ name: \"duration_days\" });\n  const hoursPerDay = useWatch({ name: \"hours_per_day\" });\n\n  // Auto-calculate price_per_hour when total_amount, duration_days, or hours_per_day changes\n  useEffect(() => {\n    if (packageType === \"time-based\" && priceMode === \"total\") {\n      if (totalAmount && durationDays && hoursPerDay && hoursPerDay > 0) {\n        const totalHours = durationDays * hoursPerDay;\n        if (totalHours > 0) {\n          const calculatedPricePerHour = totalAmount / totalHours;\n          setValue(\"price_per_hour\", calculatedPricePerHour, { shouldDirty: false, shouldValidate: false });\n          setValue(\"total_hours\", totalHours, { shouldDirty: false, shouldValidate: false });\n        }\n      }\n    }\n  }, [packageType, priceMode, totalAmount, durationDays, hoursPerDay, setValue]);\n\n  // Auto-calculate total_amount when price_per_hour, duration_days, or hours_per_day changes\n  useEffect(() => {\n    if (packageType === \"time-based\" && priceMode === \"perHour\") {\n      if (pricePerHour && durationDays && hoursPerDay && hoursPerDay > 0) {\n        const totalHours = durationDays * hoursPerDay;\n        if (totalHours > 0) {\n          const calculatedTotalAmount = pricePerHour * totalHours;\n          setValue(\"total_amount\", calculatedTotalAmount, { shouldDirty: false, shouldValidate: false });\n          setValue(\"total_hours\", totalHours, { shouldDirty: false, shouldValidate: false });\n        }\n      }\n    }\n  }, [packageType, priceMode, pricePerHour, durationDays, hoursPerDay, setValue]);\n\n  return (\n    <div className=\"flex flex-col gap-6\">\n      {/* Basic Information */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Basic Information</CardTitle>\n          <CardDescription>Select patient, service, and package type</CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n          <ReferenceInput\n            source=\"patient_id\"\n            reference=\"clients\"\n            filter={{ isClient: true, \"archived_at@is\": null }}\n          >\n            <AutocompleteInput\n              label=\"Patient (Client Only)\"\n              optionText={(contact: any) => `${contact.first_name} ${contact.last_name}`}\n              placeholder={isPatientPreFilled ? undefined : \"Select a client...\"}\n              helperText={isPatientPreFilled ? \"Client pre-selected from page\" : \"Search and select a client (only clients with converted deals can have payment packages)\"}\n              validate={required()}\n              readOnly={isPatientPreFilled}\n            />\n          </ReferenceInput>\n\n          <ReferenceInput\n            source=\"service_id\"\n            reference=\"services\"\n          >\n            <AutocompleteInput\n              label=\"Service\"\n              optionText=\"name\"\n              helperText={false}\n            />\n          </ReferenceInput>\n\n          <RadioButtonGroupInput\n            source=\"package_type\"\n            label=\"Package Type\"\n            choices={packageTypeChoices}\n            validate={required()}\n            row\n            helperText={false}\n          />\n        </CardContent>\n      </Card>\n\n      {/* Session-based Package Fields */}\n      {packageType === \"session-based\" && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Session-based Package Details</CardTitle>\n            <CardDescription>Enter total amount and number of sessions</CardDescription>\n          </CardHeader>\n          <CardContent className=\"flex flex-col gap-4\">\n            <NumberInput\n              source=\"total_amount\"\n              label=\"Total Amount (AED)\"\n              validate={[required(), validatePositive]}\n              helperText={false}\n              min={0}\n              step={0.01}\n            />\n            <NumberInput\n              source=\"total_sessions\"\n              label=\"Total Sessions\"\n              validate={[required(), validatePositiveInteger]}\n              helperText={false}\n              min={1}\n            />\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Time-based Package Fields */}\n      {packageType === \"time-based\" && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Time-based Package Details</CardTitle>\n            <CardDescription>Configure duration and pricing</CardDescription>\n          </CardHeader>\n          <CardContent className=\"flex flex-col gap-4\">\n            {/* Price Mode Toggle */}\n            <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n              <div className=\"flex flex-col\">\n                <Label className=\"text-sm font-medium\">Price Entry Mode</Label>\n                <span className=\"text-xs text-muted-foreground\">\n                  Choose how to enter the package price\n                </span>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <span className={`text-sm ${priceMode === \"total\" ? \"font-medium\" : \"text-muted-foreground\"}`}>\n                  Total Price\n                </span>\n                <Switch\n                  checked={priceMode === \"perHour\"}\n                  onCheckedChange={(checked) => setPriceMode(checked ? \"perHour\" : \"total\")}\n                />\n                <span className={`text-sm ${priceMode === \"perHour\" ? \"font-medium\" : \"text-muted-foreground\"}`}>\n                  Price Per Hour\n                </span>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Conditional Price Fields */}\n            {priceMode === \"total\" ? (\n              <NumberInput\n                source=\"total_amount\"\n                label=\"Total Amount (AED)\"\n                validate={[required(), validatePositive]}\n                helperText={false}\n                min={0}\n                step={0.01}\n              />\n            ) : (\n              <NumberInput\n                source=\"price_per_hour\"\n                label=\"Price Per Hour (AED)\"\n                validate={[required(), validatePositive]}\n                helperText={false}\n                min={0}\n                step={0.01}\n              />\n            )}\n\n            {/* Duration Fields */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <NumberInput\n                source=\"duration_days\"\n                label=\"Duration (Days)\"\n                validate={[required(), validatePositiveInteger]}\n                helperText={false}\n                min={1}\n              />\n              <NumberInput\n                source=\"hours_per_day\"\n                label=\"Hours Per Day\"\n                validate={[required(), validatePositive]}\n                helperText={false}\n                min={0.1}\n                max={24}\n                step={0.1}\n              />\n            </div>\n\n            {/* Calculated Display */}\n            <PriceCalculationDisplay\n              priceMode={priceMode}\n              totalAmount={totalAmount}\n              pricePerHour={pricePerHour}\n              durationDays={durationDays}\n              hoursPerDay={hoursPerDay}\n            />\n            \n            {/* Hidden field to store total_hours */}\n            <input type=\"hidden\" name=\"total_hours\" />\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Post-payment Package Fields */}\n      {packageType === \"post-payment\" && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Post-payment Package Details</CardTitle>\n            <CardDescription>Enter amount and optionally link to appointment</CardDescription>\n          </CardHeader>\n          <CardContent className=\"flex flex-col gap-4\">\n            <NumberInput\n              source=\"total_amount\"\n              label=\"Total Amount (AED)\"\n              validate={[required(), validatePositive]}\n              helperText={false}\n              min={0}\n              step={0.01}\n            />\n            <ReferenceInput\n              source=\"appointment_id\"\n              reference=\"appointments\"\n              filter={{ status: \"completed\" }}\n            >\n              <AutocompleteInput\n                label=\"Link to Appointment (Optional)\"\n                optionText={(appointment: any) => \n                  `${appointment.appointment_type} - ${new Date(appointment.appointment_date).toLocaleDateString()}`\n                }\n                helperText={false}\n              />\n            </ReferenceInput>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Common Fields */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Package Schedule</CardTitle>\n          <CardDescription>Set start date and optional end/renewal dates</CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n          <DateInput\n            source=\"start_date\"\n            label=\"Start Date\"\n            validate={required()}\n            helperText={false}\n          />\n          <DateInput\n            source=\"end_date\"\n            label=\"End Date (Optional)\"\n            validate={startDate ? validateDateAfterStart(startDate) : undefined}\n            helperText={false}\n          />\n          <DateInput\n            source=\"renewal_date\"\n            label=\"Renewal Date (Optional)\"\n            validate={startDate ? validateDateAfterStart(startDate) : undefined}\n            helperText={false}\n          />\n        </CardContent>\n      </Card>\n\n      {/* Payment Schedule */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Payment Schedule (Optional)</CardTitle>\n          <CardDescription>Set the next scheduled payment date</CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-4\">\n          <DateInput\n            source=\"next_payment_date\"\n            label=\"Next Payment Date\"\n            helperText=\"Optional: Set when the next payment is expected\"\n          />\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\n// Helper component to display calculated values\nconst PriceCalculationDisplay = ({\n  priceMode,\n  totalAmount,\n  pricePerHour,\n  durationDays,\n  hoursPerDay,\n}: {\n  priceMode: \"total\" | \"perHour\";\n  totalAmount?: number;\n  pricePerHour?: number;\n  durationDays?: number;\n  hoursPerDay?: number;\n}) => {\n  const [calculatedTotal, setCalculatedTotal] = useState<number | null>(null);\n  const [calculatedPricePerHour, setCalculatedPricePerHour] = useState<number | null>(null);\n  const [totalHours, setTotalHours] = useState<number | null>(null);\n\n  useEffect(() => {\n    if (durationDays && hoursPerDay) {\n      const hours = durationDays * hoursPerDay;\n      setTotalHours(hours);\n\n      if (priceMode === \"total\" && totalAmount && hours > 0) {\n        // Calculate price per hour from total\n        setCalculatedPricePerHour(totalAmount / hours);\n        setCalculatedTotal(null);\n      } else if (priceMode === \"perHour\" && pricePerHour && hours > 0) {\n        // Calculate total from price per hour\n        setCalculatedTotal(pricePerHour * hours);\n        setCalculatedPricePerHour(null);\n      } else {\n        setCalculatedTotal(null);\n        setCalculatedPricePerHour(null);\n      }\n    } else {\n      setCalculatedTotal(null);\n      setCalculatedPricePerHour(null);\n      setTotalHours(null);\n    }\n  }, [priceMode, totalAmount, pricePerHour, durationDays, hoursPerDay]);\n\n  if (!calculatedTotal && !calculatedPricePerHour && !totalHours) {\n    return null;\n  }\n\n  return (\n    <div className=\"p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border\">\n      <div className=\"text-sm font-medium mb-2\">Calculated Values</div>\n      <div className=\"space-y-1 text-sm\">\n        {totalHours !== null && (\n          <div>Total Hours: <span className=\"font-medium\">{totalHours.toFixed(1)}</span></div>\n        )}\n        {calculatedPricePerHour !== null && (\n          <div>Price Per Hour: <span className=\"font-medium\">AED {calculatedPricePerHour.toFixed(2)}</span></div>\n        )}\n        {calculatedTotal !== null && (\n          <div>Total Amount: <span className=\"font-medium\">AED {calculatedTotal.toFixed(2)}</span></div>\n        )}\n      </div>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentPackageEdit.tsx",
      "content": "import { EditBase, Form } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { PaymentPackageForm } from \"./PaymentPackageForm\";\n\nexport const PaymentPackageEdit = () => {\n  return (\n    <EditBase redirect=\"list\">\n      <div className=\"max-w-4xl w-full mx-auto mt-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Edit Payment Package</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Form className=\"flex flex-col gap-4\">\n              <PaymentPackageForm />\n              <FormToolbar>\n                <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n                  <DeleteButton redirect=\"list\" />\n                  <div className=\"flex flex-row gap-2 justify-end\">\n                    <CancelButton />\n                    <SaveButton />\n                  </div>\n                </div>\n              </FormToolbar>\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </EditBase>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentPackageDeleteButton.tsx",
      "content": "import * as React from \"react\";\nimport { Trash } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { humanize, singularize } from \"inflection\";\nimport type { UseDeleteOptions, RedirectionSideEffect } from \"ra-core\";\nimport {\n  useDeleteWithUndoController,\n  useGetRecordRepresentation,\n  useResourceTranslation,\n  useRecordContext,\n  useResourceContext,\n  useTranslate,\n} from \"ra-core\";\nimport { Confirm } from \"@/components/admin/confirm\";\n\nexport type PaymentPackageDeleteButtonProps = {\n  label?: string;\n  size?: \"default\" | \"sm\" | \"lg\" | \"icon\";\n  onClick?: React.ReactEventHandler<HTMLButtonElement>;\n  mutationOptions?: UseDeleteOptions;\n  redirect?: RedirectionSideEffect;\n  resource?: string;\n  successMessage?: string;\n  className?: string;\n  variant?:\n    | \"default\"\n    | \"destructive\"\n    | \"outline\"\n    | \"secondary\"\n    | \"ghost\"\n    | \"link\";\n};\n\nexport const PaymentPackageDeleteButton = (props: PaymentPackageDeleteButtonProps) => {\n  const {\n    label: labelProp,\n    onClick,\n    size,\n    mutationOptions,\n    redirect = \"list\",\n    successMessage,\n    variant = \"outline\",\n    className = \"cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\",\n  } = props;\n  const record = useRecordContext(props);\n  const resource = useResourceContext(props);\n  const [open, setOpen] = React.useState(false);\n\n  const { isPending, handleDelete } = useDeleteWithUndoController({\n    record,\n    resource,\n    redirect,\n    onClick,\n    mutationOptions,\n    successMessage,\n  });\n  const translate = useTranslate();\n  const getRecordRepresentation = useGetRecordRepresentation(resource);\n  let recordRepresentation = getRecordRepresentation(record);\n  const resourceName = translate(`resources.${resource}.forcedCaseName`, {\n    smart_count: 1,\n    _: humanize(\n      translate(`resources.${resource}.name`, {\n        smart_count: 1,\n        _: resource ? singularize(resource) : undefined,\n      }),\n      true,\n    ),\n  });\n  // We don't support React elements for this\n  if (React.isValidElement(recordRepresentation)) {\n    recordRepresentation = `#${record?.id}`;\n  }\n  const label = useResourceTranslation({\n    resourceI18nKey: `resources.${resource}.action.delete`,\n    baseI18nKey: \"ra.action.delete\",\n    options: {\n      name: resourceName,\n      recordRepresentation,\n    },\n    userText: labelProp,\n  });\n\n  const handleOpen = (e: React.MouseEvent<HTMLButtonElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (onClick) {\n      onClick(e);\n    }\n    setOpen(true);\n  };\n\n  const handleConfirm = (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setOpen(false);\n    handleDelete();\n  };\n\n  const handleClose = () => {\n    setOpen(false);\n  };\n\n  return (\n    <>\n      <Button\n        variant={variant}\n        type=\"button\"\n        onClick={handleOpen}\n        disabled={isPending}\n        aria-label={typeof label === \"string\" ? label : undefined}\n        size={size}\n        className={className}\n      >\n        <Trash />\n        {label}\n      </Button>\n\n      <Confirm\n        isOpen={open}\n        loading={isPending}\n        title=\"Delete Payment Package\"\n        content={`Are you sure you want to delete this payment package? This action is irreversible and will permanently delete the package and all associated data.`}\n        confirm=\"Delete\"\n        cancel=\"Cancel\"\n        confirmColor=\"warning\"\n        onClose={handleClose}\n        onConfirm={handleConfirm}\n      />\n    </>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentPackageCreate.tsx",
      "content": "import { CreateBase, Form, useRedirect, useRefresh, useNotify } from \"ra-core\";\nimport { useSearchParams } from \"react-router\";\nimport { useFormContext } from \"react-hook-form\";\nimport { useEffect } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { PaymentPackageForm } from \"./PaymentPackageForm\";\nimport type { PaymentPackage } from \"./types\";\n\nconst PaymentPackageCreateForm = () => {\n  const { setValue, getValues } = useFormContext();\n  const [searchParams] = useSearchParams();\n  const patientId = searchParams.get(\"patient_id\");\n\n  // Set patient_id from URL query parameter if provided\n  useEffect(() => {\n    if (patientId) {\n      // Convert to number if it's a numeric string\n      const patientIdValue = isNaN(Number(patientId)) ? patientId : Number(patientId);\n      // Only set if not already set to avoid overwriting user selection\n      const currentValue = getValues(\"patient_id\");\n      if (!currentValue) {\n        setValue(\"patient_id\", patientIdValue, { shouldDirty: false, shouldValidate: true });\n      }\n    }\n  }, [patientId, setValue, getValues]);\n\n  return <PaymentPackageForm />;\n};\n\nexport const PaymentPackageCreate = () => {\n  const [searchParams] = useSearchParams();\n  const patientId = searchParams.get(\"patient_id\");\n  const redirect = useRedirect();\n  const refresh = useRefresh();\n  const notify = useNotify();\n\n  // Prepare default values if patient_id is in URL\n  const defaultValues = patientId \n    ? { patient_id: isNaN(Number(patientId)) ? patientId : Number(patientId) } \n    : {};\n\n  const handleSuccess = (data: PaymentPackage) => {\n    if (!data?.id) {\n      console.error(\"PaymentPackageCreate: Missing package ID\", data);\n      notify(\"Package created but could not redirect\", { type: \"warning\" });\n      return;\n    }\n    \n    // Force refresh to ensure the new package appears in lists\n    refresh();\n    \n    // Small delay to ensure backend has processed\n    setTimeout(() => {\n      refresh();\n      redirect(\"show\", \"payment_packages\", data.id);\n    }, 100);\n  };\n\n  return (\n    <CreateBase \n      redirect={false}\n      record={defaultValues}\n      transform={(data) => {\n        // Convert patient_id to number if it's a string\n        // Form validation will ensure it's present\n        const result = {\n          ...data,\n        };\n        \n        if (data.patient_id) {\n          result.patient_id = typeof data.patient_id === 'string' ? Number(data.patient_id) : data.patient_id;\n        }\n        \n        return result;\n      }}\n      mutationOptions={{\n        onSuccess: (response) => {\n          console.log(\"PaymentPackageCreate: Success response\", response);\n          // Handle both response.data (react-admin structure) and direct data\n          const packageData = ((response as any)?.data ?? response) as PaymentPackage | undefined;\n          console.log(\"PaymentPackageCreate: Extracted package data\", packageData);\n          if (!packageData || !packageData.id) {\n            console.warn(\"PaymentPackageCreate: Invalid response structure\", response);\n            notify(\"Package created but could not redirect\", { type: \"warning\" });\n            // Still redirect to list if we can't get the ID\n            setTimeout(() => {\n              redirect(\"list\", \"payment_packages\");\n            }, 100);\n            return;\n          }\n          handleSuccess(packageData);\n        },\n        onError: (error) => {\n          console.error(\"PaymentPackageCreate: Error creating package\", error);\n          notify(\"Failed to create payment package\", { type: \"error\" });\n        },\n      }}\n    >\n      <div className=\"max-w-4xl w-full mx-auto mt-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Create Payment Package</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Form className=\"flex flex-col gap-4\" defaultValues={defaultValues}>\n              <PaymentPackageCreateForm />\n              <FormToolbar />\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </CreateBase>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PaymentCreateDialog.tsx",
      "content": "import { CreateBase, Form, useNotify, useRefresh } from \"ra-core\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { PaymentTransactionForm } from \"./PaymentTransactionForm\";\nimport type { PaymentTransaction } from \"./types\";\n\ntype PaymentCreateDialogProps = {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  defaultPackageId?: string | number;\n  defaultAppointmentId?: string | number;\n};\n\nexport const PaymentCreateDialog = ({\n  open,\n  onOpenChange,\n  defaultPackageId,\n  defaultAppointmentId,\n}: PaymentCreateDialogProps) => {\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const handleSuccess = (response: any) => {\n    // Handle both response.data (react-admin structure) and direct data\n    const transactionData = ((response as any)?.data ?? response) as PaymentTransaction | undefined;\n    \n    if (!transactionData) {\n      console.warn(\"PaymentCreateDialog: Invalid response structure\", response);\n      notify(\"Payment created but response was invalid\", { type: \"warning\" });\n      refresh();\n      onOpenChange(false);\n      return;\n    }\n\n    notify(\"Payment recorded successfully\", { type: \"success\" });\n    refresh();\n    onOpenChange(false);\n  };\n\n  const handleError = (error: any) => {\n    console.error(\"PaymentCreateDialog: Error creating payment\", error);\n    notify(\"Failed to record payment\", { type: \"error\" });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>Record Payment</DialogTitle>\n          <DialogDescription>\n            Create a payment transaction. Select a package or leave empty for a standalone payment.\n          </DialogDescription>\n        </DialogHeader>\n        <CreateBase\n          resource=\"payment_transactions\"\n          redirect={false}\n          transform={(data: any) => {\n            // Transform data before submission\n            const result: any = {\n              amount_received: data.amount_received,\n              bank_charge: data.bank_charge,\n              net_amount: data.net_amount,\n              payment_method: data.payment_method,\n              date_paid: data.date_paid,\n              date_received: data.date_received,\n              invoice_number: data.invoice_number || null,\n              installment_number: data.installment_number || null,\n            };\n\n            // Only include payment_package_id if it has a value\n            if (data.payment_package_id) {\n              result.payment_package_id = typeof data.payment_package_id === 'string' \n                ? Number(data.payment_package_id) \n                : data.payment_package_id;\n            }\n\n            // Include appointment_id if provided (for standalone payments)\n            if (data.appointment_id || defaultAppointmentId) {\n              result.appointment_id = data.appointment_id || defaultAppointmentId;\n              result.appointment_id = typeof result.appointment_id === 'string' \n                ? Number(result.appointment_id) \n                : result.appointment_id;\n            }\n\n            return result;\n          }}\n          mutationOptions={{\n            onSuccess: handleSuccess,\n            onError: handleError,\n          }}\n        >\n          <Form className=\"flex flex-col gap-4\">\n            <div className=\"overflow-y-auto max-h-[calc(90vh-200px)] pr-2\">\n              <PaymentTransactionForm \n                defaultPackageId={defaultPackageId} \n                defaultAppointmentId={defaultAppointmentId}\n              />\n            </div>\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => onOpenChange(false)}\n              >\n                Cancel\n              </Button>\n              <SaveButton \n                label=\"Record Payment\"\n                className=\"bg-blue-600 text-white hover:bg-blue-700\"\n              />\n            </DialogFooter>\n          </Form>\n        </CreateBase>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/PackageDetailsView.tsx",
      "content": "import { useGetList, WithRecord } from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Link } from \"react-router\";\nimport { ExternalLink } from \"lucide-react\";\nimport type { PaymentPackage, PaymentTransaction, Contact, Service } from \"../types\";\nimport { UsageTracker } from \"./UsageTracker\";\n\ntype PackageDetailsViewProps = {\n  package: PaymentPackage;\n  sessionsUsed?: number;\n  hoursUsed?: number;\n};\n\nexport const PackageDetailsView = ({ package: pkg, sessionsUsed = 0, hoursUsed = 0 }: PackageDetailsViewProps) => {\n  // Fetch payment transactions for this package\n  const { data: transactions, isLoading: transactionsLoading } = useGetList<PaymentTransaction>(\n    \"payment_transactions\",\n    {\n      pagination: { page: 1, perPage: 100 },\n      sort: { field: \"date_paid\", order: \"DESC\" },\n      filter: { payment_package_id: pkg.id },\n    },\n    { enabled: !!pkg.id }\n  );\n\n  // Calculate total paid\n  const totalPaid = transactions?.reduce((sum, t) => sum + t.amount_received, 0) || 0;\n  const totalNetAmount = transactions?.reduce((sum, t) => sum + t.net_amount, 0) || 0;\n\n  const statusColors = {\n    active: \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300\",\n    completed: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n    expired: \"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300\",\n  };\n\n  const packageTypeLabels = {\n    \"session-based\": \"Session-based\",\n    \"time-based\": \"Time-based\",\n    \"post-payment\": \"Post-payment\",\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Package Info Card */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-xl\">Package Details</CardTitle>\n            <Badge className={statusColors[pkg.status] || statusColors.completed}>\n              {pkg.status}\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Patient</p>\n              {pkg.patient_id ? (\n                <ReferenceField source=\"patient_id\" reference=\"clients\" record={pkg} link=\"show\">\n                  <WithRecord\n                    render={(contact: Contact) => (\n                      <p className=\"font-medium\">\n                        {contact.first_name} {contact.last_name}\n                      </p>\n                    )}\n                  />\n                </ReferenceField>\n              ) : (\n                <p className=\"font-medium text-muted-foreground\">No patient assigned</p>\n              )}\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Service</p>\n              {pkg.service_id ? (\n                <ReferenceField source=\"service_id\" reference=\"services\" record={pkg} link=\"show\">\n                  <WithRecord\n                    render={(service: Service) => <p className=\"font-medium\">{service.name}</p>}\n                  />\n                </ReferenceField>\n              ) : (\n                <p className=\"font-medium text-muted-foreground\">No service assigned</p>\n              )}\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Package Type</p>\n              <p className=\"font-medium\">{packageTypeLabels[pkg.package_type]}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Total Amount</p>\n              <p className=\"font-medium\">AED {pkg.total_amount.toLocaleString()}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Start Date</p>\n              <DateField source=\"start_date\" record={pkg} />\n            </div>\n            {pkg.renewal_date && (\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Renewal Date</p>\n                <DateField source=\"renewal_date\" record={pkg} />\n              </div>\n            )}\n            {pkg.end_date && (\n              <div>\n                <p className=\"text-sm text-muted-foreground\">End Date</p>\n                <DateField source=\"end_date\" record={pkg} />\n              </div>\n            )}\n          </div>\n          {pkg.package_type === \"session-based\" && pkg.total_sessions && (\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Total Sessions</p>\n              <p className=\"font-medium\">{pkg.total_sessions} sessions</p>\n            </div>\n          )}\n          {pkg.package_type === \"time-based\" && (\n            <div className=\"grid grid-cols-3 gap-4\">\n              {pkg.duration_days && (\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Duration</p>\n                  <p className=\"font-medium\">{pkg.duration_days} days</p>\n                </div>\n              )}\n              {pkg.hours_per_day && (\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Hours Per Day</p>\n                  <p className=\"font-medium\">{pkg.hours_per_day} hours</p>\n                </div>\n              )}\n              {pkg.total_hours && (\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Hours</p>\n                  <p className=\"font-medium\">{pkg.total_hours.toFixed(1)} hours</p>\n                </div>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Usage Tracker */}\n      <UsageTracker package={pkg} sessionsUsed={sessionsUsed} hoursUsed={hoursUsed} />\n\n      {/* Payment Summary */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Payment Summary</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-3 gap-4\">\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Total Paid</p>\n              <p className=\"text-lg font-semibold\">AED {totalPaid.toLocaleString()}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Net Amount</p>\n              <p className=\"text-lg font-semibold\">AED {totalNetAmount.toLocaleString()}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Remaining</p>\n              <p className=\"text-lg font-semibold\">\n                AED {(pkg.total_amount - totalPaid).toLocaleString()}\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Payment Transactions */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-lg\">Payment Transactions</CardTitle>\n            <Button asChild variant=\"outline\" size=\"sm\">\n              <Link to={`/payment_packages/${pkg.id}/show`}>\n                View All <ExternalLink className=\"ml-2 h-4 w-4\" />\n              </Link>\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {transactionsLoading ? (\n            <p className=\"text-sm text-muted-foreground\">Loading transactions...</p>\n          ) : !transactions || transactions.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground\">No payments recorded yet</p>\n          ) : (\n            <div className=\"space-y-3\">\n              {transactions.slice(0, 5).map((transaction) => (\n                <div\n                  key={transaction.id}\n                  className=\"flex items-center justify-between p-3 border rounded-lg\"\n                >\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-2\">\n                      <p className=\"font-medium\">AED {transaction.amount_received.toLocaleString()}</p>\n                      <Badge variant=\"outline\">{transaction.payment_method}</Badge>\n                    </div>\n                    <div className=\"flex items-center gap-4 mt-1 text-xs text-muted-foreground\">\n                      <DateField source=\"date_paid\" record={transaction} />\n                      {transaction.invoice_number && (\n                        <span>Invoice: {transaction.invoice_number}</span>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"text-right\">\n                    <p className=\"text-sm text-muted-foreground\">Net: AED {transaction.net_amount.toLocaleString()}</p>\n                    {transaction.bank_charge > 0 && (\n                      <p className=\"text-xs text-muted-foreground\">\n                        Fee: AED {transaction.bank_charge.toLocaleString()}\n                      </p>\n                    )}\n                  </div>\n                </div>\n              ))}\n              {transactions.length > 5 && (\n                <p className=\"text-sm text-muted-foreground text-center\">\n                  +{transactions.length - 5} more transactions\n                </p>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/InstallmentSchedule.tsx",
      "content": "import { useGetList } from \"ra-core\";\nimport type { Identifier } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { Clock, Calendar, DollarSign } from \"lucide-react\";\nimport type { PaymentPackage, PaymentTransaction } from \"./types\";\n\ntype InstallmentScheduleProps = {\n  packageId: Identifier;\n  packageData?: PaymentPackage;\n};\n\nexport const InstallmentSchedule = ({ packageId, packageData }: InstallmentScheduleProps) => {\n  // Fetch payment transactions for this package\n  const { data: transactions, isLoading: transactionsLoading } = useGetList<PaymentTransaction>(\n    \"payment_transactions\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date_paid\", order: \"DESC\" },\n      filter: { payment_package_id: packageId },\n    },\n    { enabled: !!packageId }\n  );\n\n  if (transactionsLoading) {\n    return (\n      <Card>\n        <CardContent className=\"pt-6\">\n          <p className=\"text-sm text-muted-foreground\">Loading payment information...</p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!packageData) {\n    return null;\n  }\n\n  const totalAmount = packageData.total_amount || 0;\n  const paidAmount = transactions?.reduce((sum, t) => sum + (t.amount_received || 0), 0) || 0;\n  const remainingAmount = totalAmount - paidAmount;\n  const progressPercentage = totalAmount > 0 ? (paidAmount / totalAmount) * 100 : 0;\n\n  // Find last payment date\n  const lastPayment = transactions && transactions.length > 0 ? transactions[0] : null;\n  const lastPaymentDate = lastPayment?.date_paid;\n\n  // Get next payment date from package\n  const nextPaymentDate = packageData.next_payment_date;\n\n  // Check if next payment is overdue\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n  const isOverdue = nextPaymentDate ? new Date(nextPaymentDate) < today : false;\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Payment Tracking</CardTitle>\n      </CardHeader>\n      <CardContent className=\"pt-6\">\n        {/* Summary */}\n        <div className=\"mb-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg\">\n          <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4 text-sm mb-4\">\n            <div>\n              <p className=\"text-muted-foreground\">Total Amount</p>\n              <p className=\"text-lg font-semibold\">AED {totalAmount.toLocaleString()}</p>\n            </div>\n            <div>\n              <p className=\"text-muted-foreground\">Paid Amount</p>\n              <p className=\"text-lg font-semibold\">AED {paidAmount.toLocaleString()}</p>\n            </div>\n            <div>\n              <p className=\"text-muted-foreground\">Remaining</p>\n              <p className={`text-lg font-semibold ${remainingAmount > 0 ? \"text-orange-600 dark:text-orange-400\" : \"text-green-600 dark:text-green-400\"}`}>\n                AED {remainingAmount.toLocaleString()}\n              </p>\n            </div>\n          </div>\n          {/* Progress Bar */}\n          <div className=\"mt-4\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <span className=\"text-sm font-medium\">Payment Progress</span>\n              <span className=\"text-sm text-muted-foreground\">{progressPercentage.toFixed(1)}%</span>\n            </div>\n            <div className=\"w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2\">\n              <div\n                className=\"bg-green-500 h-2 rounded-full transition-all\"\n                style={{ width: `${Math.min(progressPercentage, 100)}%` }}\n              />\n            </div>\n          </div>\n        </div>\n\n        {/* Payment Information Cards */}\n        <div className=\"space-y-3\">\n          {/* Last Payment */}\n          {lastPaymentDate ? (\n            <div className=\"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Calendar className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                <p className=\"font-medium text-sm\">Last Payment</p>\n              </div>\n              <div className=\"text-sm text-muted-foreground\">\n                <DateField source=\"date_paid\" record={lastPayment} />\n                {lastPayment && (\n                  <span className=\"ml-2\">\n                    - AED {lastPayment.amount_received.toLocaleString()}\n                  </span>\n                )}\n              </div>\n            </div>\n          ) : (\n            <div className=\"p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                <p className=\"font-medium text-sm text-muted-foreground\">Last Payment</p>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">No payments recorded yet</p>\n            </div>\n          )}\n\n          {/* Next Payment Due */}\n          {nextPaymentDate ? (\n            <div className={`p-4 rounded-lg border ${\n              isOverdue\n                ? \"bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800\"\n                : \"bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800\"\n            }`}>\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Clock className={`h-4 w-4 ${isOverdue ? \"text-red-600 dark:text-red-400\" : \"text-blue-600 dark:text-blue-400\"}`} />\n                <p className=\"font-medium text-sm\">Next Payment Scheduled</p>\n                {isOverdue && (\n                  <Badge variant=\"destructive\" className=\"ml-2\">\n                    Overdue\n                  </Badge>\n                )}\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                <DateField source=\"next_payment_date\" record={packageData} />\n                {remainingAmount > 0 && (\n                  <span className=\"ml-2\">\n                    - AED {remainingAmount.toLocaleString()} remaining\n                  </span>\n                )}\n              </p>\n            </div>\n          ) : (\n            <div className=\"p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                <p className=\"font-medium text-sm text-muted-foreground\">Next Payment Scheduled</p>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">No next payment date set</p>\n            </div>\n          )}\n\n          {/* Remaining Amount */}\n          {remainingAmount > 0 && (\n            <div className=\"p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-200 dark:border-orange-800\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <DollarSign className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\n                <p className=\"font-medium text-sm\">Remaining Balance</p>\n              </div>\n              <p className=\"text-lg font-semibold text-orange-700 dark:text-orange-400\">\n                AED {remainingAmount.toLocaleString()}\n              </p>\n            </div>\n          )}\n\n          {remainingAmount <= 0 && (\n            <div className=\"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800\">\n              <div className=\"flex items-center gap-2\">\n                <DollarSign className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                <p className=\"font-medium text-sm text-green-700 dark:text-green-400\">\n                  Package fully paid\n                </p>\n              </div>\n            </div>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/payments/BankChargeCalculator.tsx",
      "content": "import { usePaymentSettings } from \"@/hooks/usePaymentSettings\";\nimport type { PaymentSettings } from \"./types\";\n\nexport interface BankChargeCalculation {\n  baseFee: number;\n  vatAmount: number;\n  totalCharge: number;\n}\n\n/**\n * Calculates bank charge based on payment method and amount\n * Formula: (amount  fee_percentage + fixed_fee_amount)  (1 + vat_percentage/100)\n * \n * @param amount - The payment amount\n * @param paymentMethod - The payment method (POS, Tabby, Payment Link, Ziina, Cash)\n * @param settings - Payment settings data (optional, will fetch if not provided)\n * @returns Bank charge calculation breakdown or null if settings not found\n */\nexport function calculateBankCharge(\n  amount: number,\n  paymentMethod: PaymentSettings[\"payment_method\"],\n  settings?: PaymentSettings[]\n): BankChargeCalculation | null {\n  if (!settings || settings.length === 0) {\n    return null;\n  }\n\n  const setting = settings.find((s) => s.payment_method === paymentMethod);\n  if (!setting || !setting.is_active) {\n    return null;\n  }\n\n  const feePercentage = setting.fee_percentage || 0;\n  const fixedFee = setting.fixed_fee_amount || 0;\n  const vatPercentage = setting.vat_percentage || 0;\n\n  // Calculate base fee: (amount  fee_percentage) + fixed_fee_amount\n  const baseFee = (amount * (feePercentage / 100)) + fixedFee;\n\n  // Calculate VAT on the base fee\n  const vatAmount = baseFee * (vatPercentage / 100);\n\n  // Total charge = base fee + VAT\n  const totalCharge = baseFee + vatAmount;\n\n  return {\n    baseFee: Math.round(baseFee * 100) / 100, // Round to 2 decimal places\n    vatAmount: Math.round(vatAmount * 100) / 100,\n    totalCharge: Math.round(totalCharge * 100) / 100,\n  };\n}\n\n/**\n * Hook to get bank charge calculation with automatic settings fetching\n */\nexport function useBankChargeCalculation(\n  amount: number | null | undefined,\n  paymentMethod: PaymentSettings[\"payment_method\"] | null | undefined\n): {\n  calculation: BankChargeCalculation | null;\n  isLoading: boolean;\n} {\n  const { data: settings, isLoading } = usePaymentSettings();\n\n  if (!amount || !paymentMethod || !settings) {\n    return { calculation: null, isLoading };\n  }\n\n  const calculation = calculateBankCharge(amount, paymentMethod, settings);\n\n  return { calculation, isLoading };\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/utils.ts",
      "content": "import {\n  crmDateTimeInputString,\n  crmDateTimeStringToISO,\n} from \"../misc/timezone\";\n\nexport const getCurrentDate = () => crmDateTimeInputString();\n\nexport const formatNoteDate = (dateString: string) =>\n  crmDateTimeStringToISO(dateString) ?? dateString;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/index.ts",
      "content": "export * from \"./NoteCreate\";\nexport * from \"./NotesIterator\";\nexport * from \"./StatusSelector\";\nexport * from \"./UnifiedNotesIterator\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/UnifiedNotesIterator.tsx",
      "content": "import {\n  useGetList,\n  ResourceContextProvider,\n  useRecordContext,\n} from \"ra-core\";\nimport { useMemo } from \"react\";\n\nimport type { ContactNote, DealNote } from \"../types\";\nimport { Note } from \"./Note\";\nimport { UnifiedNoteCreate } from \"./UnifiedNoteCreate\";\n\nexport const UnifiedNotesIterator = ({\n  reference,\n  showStatus,\n  contactId,\n  dealId,\n  dealIds,\n  leadId,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  showStatus?: boolean;\n  contactId?: string | number;\n  dealId?: string | number;\n  dealIds?: (string | number)[]; // Support multiple deal IDs\n  leadId?: string | number;\n}) => {\n  // Fetch contact notes if we have a contactId or leadId\n  const contactNotesId = contactId || leadId;\n  // Support both camelCase and snake_case table names (legacy vs new)\n  const {\n    data: contactNotesCamel,\n    isPending: contactNotesPendingCamel,\n    error: contactNotesErrorCamel,\n    refetch: refetchContactNotesCamel,\n  } = useGetList<ContactNote>(\n    \"contactNotes\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: contactNotesId ? { contact_id: contactNotesId } : {},\n    },\n    {\n      enabled: !!contactNotesId,\n      retry: false,\n    },\n  );\n  const {\n    data: contactNotesSnake,\n    isPending: contactNotesPendingSnake,\n    error: contactNotesErrorSnake,\n    refetch: refetchContactNotesSnake,\n  } = useGetList<ContactNote>(\n    \"contact_notes\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: contactNotesId ? { contact_id: contactNotesId } : {},\n    },\n    {\n      enabled: !!contactNotesId,\n      retry: false,\n    },\n  );\n\n  // Use dealIds array if provided, otherwise fall back to single dealId\n  const dealIdsToFetch = dealIds && dealIds.length > 0 ? dealIds : (dealId ? [dealId] : []);\n  \n  // Fetch deal notes for all deals\n  const {\n    data: dealNotesCamel,\n    isPending: dealNotesPendingCamel,\n    error: dealNotesErrorCamel,\n    refetch: refetchDealNotesCamel,\n  } = useGetList<DealNote>(\n    \"dealNotes\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter:\n        dealIdsToFetch.length > 0\n          ? { \"deal_id@in\": `(${dealIdsToFetch.join(\",\")})` }\n          : { deal_id: -1 }, // Use -1 to return empty if no deals\n    },\n    {\n      enabled: dealIdsToFetch.length > 0,\n      retry: false,\n    },\n  );\n  const {\n    data: dealNotesSnake,\n    isPending: dealNotesPendingSnake,\n    error: dealNotesErrorSnake,\n    refetch: refetchDealNotesSnake,\n  } = useGetList<DealNote>(\n    \"deal_notes\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter:\n        dealIdsToFetch.length > 0\n          ? { \"deal_id@in\": `(${dealIdsToFetch.join(\",\")})` }\n          : { deal_id: -1 },\n    },\n    {\n      enabled: dealIdsToFetch.length > 0,\n      retry: false,\n    },\n  );\n\n  const contactNotes =\n    (contactNotesCamel && contactNotesCamel.length > 0\n      ? contactNotesCamel\n      : contactNotesSnake) || [];\n  const dealNotes =\n    (dealNotesCamel && dealNotesCamel.length > 0 ? dealNotesCamel : dealNotesSnake) ||\n    [];\n\n  // Only pending if both variants are pending; this prevents one failing call\n  // from keeping the loader spinning forever.\n  const contactNotesPending = contactNotesPendingCamel && contactNotesPendingSnake;\n  const dealNotesPending = dealNotesPendingCamel && dealNotesPendingSnake;\n\n  const contactNotesErrorState =\n    contactNotesErrorCamel || contactNotesErrorSnake || null;\n  const dealNotesErrorState = dealNotesErrorCamel || dealNotesErrorSnake || null;\n\n  // Merge and sort all notes by date\n  const allNotes = useMemo(() => {\n    const notes: Array<ContactNote | DealNote & { _noteType: \"contact\" | \"deal\" }> =\n      [];\n\n    if (contactNotes) {\n      contactNotes.forEach((note) => {\n        notes.push({ ...note, _noteType: \"contact\" } as any);\n      });\n    }\n\n    if (dealNotes) {\n      dealNotes.forEach((note) => {\n        notes.push({ ...note, _noteType: \"deal\" } as any);\n      });\n    }\n\n    // Sort by date descending\n    return notes.sort(\n      (a, b) =>\n        new Date(b.date).valueOf() - new Date(a.date).valueOf(),\n    );\n  }, [contactNotes, dealNotes]);\n\n  const hasNotes = allNotes.length > 0;\n  // Show an error banner only if both variants fail; otherwise show what we have\n  const hasError = contactNotesErrorState && dealNotesErrorState;\n\n  // Get the record from context (set by parent ShowBase)\n  const record = useRecordContext();\n\n  const handleRefetch = () => {\n    if (contactNotesId) {\n      refetchContactNotesCamel();\n      refetchContactNotesSnake();\n    }\n    if (dealIdsToFetch.length > 0) {\n      refetchDealNotesCamel();\n      refetchDealNotesSnake();\n    }\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      <UnifiedNoteCreate \n        reference={reference} \n        showStatus={showStatus}\n        onSuccess={handleRefetch}\n        contactId={contactNotesId}\n        dealId={dealIdsToFetch.length > 0 ? dealIdsToFetch[0] : dealId}\n      />\n      {hasError && (\n        <div className=\"text-sm text-destructive\">\n          Unable to load notes. You can still add a new note above.\n        </div>\n      )}\n      {hasNotes ? (\n        <div className=\"space-y-2\">\n          {allNotes.map((note, index) => {\n            const noteType = (note as any)._noteType || (reference === \"contacts\" ? \"contact\" : \"deal\");\n            const resource = noteType === \"contact\" ? \"contactNotes\" : \"dealNotes\";\n            \n            return (\n              <ResourceContextProvider key={`${resource}-${note.id}`} value={resource}>\n                <Note\n                  note={note}\n                  isLast={index === allNotes.length - 1}\n                  showStatus={showStatus}\n                />\n              </ResourceContextProvider>\n            );\n          })}\n        </div>\n      ) : (\n        <div className=\"text-sm text-muted-foreground\">No notes yet.</div>\n      )}\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/UnifiedNoteCreate.tsx",
      "content": "import {\n  CreateBase,\n  Form,\n  useGetIdentity,\n  useNotify,\n  useRecordContext,\n  useUpdate,\n  type Identifier,\n  type RaRecord,\n} from \"ra-core\";\nimport { useFormContext } from \"react-hook-form\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { cn } from \"@/lib/utils\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { NoteInputs } from \"./NoteInputs\";\n\nconst foreignKeyMapping = {\n  contacts: \"contact_id\",\n  \"lead-journey\": \"deal_id\",\n};\n\nexport const UnifiedNoteCreate = ({\n  reference,\n  showStatus,\n  className,\n  onSuccess: onSuccessCallback,\n  contactId,\n  dealId,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  showStatus?: boolean;\n  className?: string;\n  onSuccess?: () => void;\n  contactId?: string | number;\n  dealId?: string | number;\n}) => {\n  const record = useRecordContext();\n  const { identity } = useGetIdentity();\n\n  if (!record) return null;\n\n  // Determine which resource to use for creating notes\n  const noteResource = reference === \"contacts\" ? \"contactNotes\" : \"dealNotes\";\n  const recordId = reference === \"contacts\" ? (contactId || record.id) : (dealId || record.id);\n\n  return (\n    <Card className=\"bg-muted/30 py-3\">\n      <CardContent className=\"pt-0 px-4 pb-0\">\n        <CreateBase resource={noteResource} redirect={false}>\n          <Form>\n            <div className={className}>\n              <NoteInputs showStatus={showStatus} />\n              <UnifiedNoteCreateButton \n                reference={reference} \n                record={record}\n                recordId={recordId}\n                onSuccess={onSuccessCallback}\n              />\n            </div>\n          </Form>\n        </CreateBase>\n      </CardContent>\n    </Card>\n  );\n};\n\nconst UnifiedNoteCreateButton = ({\n  reference,\n  record,\n  recordId,\n  onSuccess: onSuccessCallback,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  record: RaRecord<Identifier>;\n  recordId?: string | number;\n  onSuccess?: () => void;\n}) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const { identity } = useGetIdentity();\n  const { reset } = useFormContext();\n\n  if (!record) return null;\n\n  const resetValues: {\n    text: null;\n    attachments: null;\n    tagged_user_ids?: undefined;\n  } = {\n    text: null,\n    attachments: null,\n    tagged_user_ids: undefined,\n  };\n\n  const handleSuccess = async (data: any) => {\n    reset(resetValues, { keepValues: false });\n    // Update contact last_seen first\n    await update(reference, {\n      id: (record && record.id) as unknown as Identifier,\n      data: { last_seen: new Date().toISOString() },\n      previousData: record,\n    });\n    notify(\"Note added\");\n    // Call the refetch callback after update completes to ensure data is synced\n    if (onSuccessCallback) {\n      onSuccessCallback();\n    }\n  };\n\n  return (\n    <div className=\"flex justify-end\">\n      <SaveButton\n        type=\"button\"\n        label=\"Add this note\"\n        transform={(data) => {\n          const { tagged_user_ids, ...restData } = data;\n          const result: any = {\n            ...restData,\n            [foreignKeyMapping[reference]]: recordId || record.id,\n            sales_id: identity?.id,\n            // Always save notes with current time\n            date: new Date().toISOString(),\n          };\n          // Only include tagged_user_ids if it's a non-empty array\n          // This avoids schema cache issues if the column doesn't exist yet\n          if (Array.isArray(tagged_user_ids) && tagged_user_ids.length > 0) {\n            result.tagged_user_ids = tagged_user_ids;\n          }\n          return result;\n        }}\n        mutationOptions={{\n          onSuccess: handleSuccess,\n        }}\n      >\n        Add this note\n      </SaveButton>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/StatusSelector.tsx",
      "content": "import {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\nimport { Status } from \"../misc/Status\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const StatusSelector = ({ status, setStatus }: any) => {\n  const { noteStatuses } = useConfigurationContext();\n\n  const currentStatus = noteStatuses.find((s) => s.value === status);\n\n  return (\n    <Select value={status} onValueChange={setStatus}>\n      <SelectTrigger className=\"w-32\">\n        <SelectValue>\n          {currentStatus && (\n            <div className=\"flex items-center gap-2\">\n              {currentStatus.label} <Status status={currentStatus.value} />\n            </div>\n          )}\n        </SelectValue>\n      </SelectTrigger>\n      <SelectContent>\n        {noteStatuses.map((statusOption) => (\n          <SelectItem key={statusOption.value} value={statusOption.value}>\n            <div className=\"flex items-center gap-2\">\n              {statusOption.label} <Status status={statusOption.value} />\n            </div>\n          </SelectItem>\n        ))}\n      </SelectContent>\n    </Select>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NotesPage.tsx",
      "content": "import { FileText, Search } from \"lucide-react\";\nimport {\n  ResourceContextProvider,\n  useGetIdentity,\n  useGetList,\n  WithRecord,\n} from \"ra-core\";\nimport { useEffect, useMemo, useState } from \"react\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\n\nimport type { ContactNote, Deal, DealNote, Contact } from \"../types\";\nimport { Note } from \"./Note\";\n\ntype NotesTab = \"all\" | \"mentions\" | \"authored\";\n\ntype UnifiedNote =\n  | (ContactNote & { _noteType: \"contact\" })\n  | (DealNote & { _noteType: \"deal\" });\n\nexport const NotesPage = () => {\n  const { identity } = useGetIdentity();\n\n  const [tab, setTab] = useState<NotesTab>(\"all\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const [perPage, setPerPage] = useState(50);\n\n  // When the user changes the scope (tab/search), reset pagination.\n  useEffect(() => {\n    setPerPage(50);\n  }, [tab, searchQuery]);\n\n  const baseFilter = useMemo(() => {\n    const filter: Record<string, unknown> = {};\n\n    if (tab === \"mentions\") {\n      if (Number.isInteger(identity?.id)) {\n        filter[\"tagged_user_ids@cs\"] = `{${identity!.id}}`;\n      } else {\n        // No identity yet; force empty result until we know who the user is.\n        filter[\"id@in\"] = \"(-1)\";\n      }\n    }\n\n    if (tab === \"authored\") {\n      if (Number.isInteger(identity?.id)) {\n        filter.sales_id = identity!.id;\n      } else {\n        filter[\"id@in\"] = \"(-1)\";\n      }\n    }\n\n    if (searchQuery.trim()) {\n      filter[\"text@ilike\"] = `%${searchQuery.trim()}%`;\n    }\n\n    return filter;\n  }, [tab, identity?.id, searchQuery]);\n\n  const listEnabled = tab === \"all\" || Number.isInteger(identity?.id);\n\n  const {\n    data: contactNotes,\n    total: contactNotesTotal,\n    isPending: contactNotesPending,\n    error: contactNotesError,\n  } = useGetList<ContactNote>(\n    \"contactNotes\",\n    {\n      pagination: { page: 1, perPage },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: baseFilter,\n    },\n    { enabled: listEnabled, retry: false },\n  );\n\n  const {\n    data: dealNotes,\n    total: dealNotesTotal,\n    isPending: dealNotesPending,\n    error: dealNotesError,\n  } = useGetList<DealNote>(\n    \"dealNotes\",\n    {\n      pagination: { page: 1, perPage },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: baseFilter,\n    },\n    { enabled: listEnabled, retry: false },\n  );\n\n  const mergedNotes = useMemo(() => {\n    const notes: UnifiedNote[] = [];\n    (contactNotes ?? []).forEach((n) => notes.push({ ...n, _noteType: \"contact\" }));\n    (dealNotes ?? []).forEach((n) => notes.push({ ...n, _noteType: \"deal\" }));\n\n    notes.sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());\n    return notes;\n  }, [contactNotes, dealNotes]);\n\n  const isPending = contactNotesPending && dealNotesPending;\n  const hasError = !!contactNotesError && !!dealNotesError;\n\n  const combinedTotal = (contactNotesTotal ?? 0) + (dealNotesTotal ?? 0);\n  const canLoadMore = combinedTotal > 0 && mergedNotes.length < combinedTotal;\n\n  return (\n    <div className=\"flex flex-col w-full lg:h-[calc(100vh-8rem)] h-auto -mx-4 -mt-4 p-6 gap-4 bg-background\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-shrink-0 pb-2\">\n        <div className=\"flex items-center gap-3\">\n          <FileText className=\"text-muted-foreground w-6 h-6\" />\n          <h1 className=\"text-2xl font-semibold text-foreground\">Notes</h1>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <Tabs value={tab} onValueChange={(v) => setTab(v as NotesTab)}>\n          <TabsList>\n            <TabsTrigger value=\"all\">All</TabsTrigger>\n            <TabsTrigger value=\"mentions\">Mentions</TabsTrigger>\n            <TabsTrigger value=\"authored\">Authored</TabsTrigger>\n          </TabsList>\n        </Tabs>\n\n        <div className=\"flex-shrink-0 w-full sm:max-w-md\">\n          <div className=\"flex flex-grow relative\">\n            <input\n              type=\"text\"\n              placeholder=\"Search notes...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8\"\n            />\n            <Search className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none\" />\n          </div>\n        </div>\n      </div>\n\n      {/* Feed */}\n      <Card className=\"border-border/50 shadow-sm\">\n        <CardHeader className=\"pb-2.5 px-4 pt-3 border-b border-border/50\">\n          <CardTitle className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\n            {tab === \"all\" ? \"All notes\" : tab === \"mentions\" ? \"Mentions\" : \"Authored\"}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"p-4\">\n          {hasError ? (\n            <div className=\"text-sm text-destructive\">\n              Unable to load notes right now.\n            </div>\n          ) : isPending ? (\n            <div className=\"text-sm text-muted-foreground\">Loading notes</div>\n          ) : mergedNotes.length > 0 ? (\n            <div className=\"space-y-4\">\n              {mergedNotes.map((note, index) => {\n                const resource = note._noteType === \"contact\" ? \"contactNotes\" : \"dealNotes\";\n\n                const context =\n                  note._noteType === \"contact\" ? (\n                    <ReferenceField\n                      record={note}\n                      source=\"contact_id\"\n                      reference=\"contacts\"\n                      link=\"show\"\n                    >\n                      <WithRecord\n                        render={(contact: Contact) => (\n                          <span className=\"font-medium text-foreground\">\n                            {`${contact.first_name ?? \"\"} ${contact.last_name ?? \"\"}`.trim() ||\n                              `Lead #${contact.id}`}\n                          </span>\n                        )}\n                      />\n                    </ReferenceField>\n                  ) : (\n                    <ReferenceField\n                      record={note}\n                      source=\"deal_id\"\n                      reference=\"lead-journey\"\n                      link=\"show\"\n                    >\n                      <WithRecord\n                        render={(deal: Deal) => (\n                          <span className=\"font-medium text-foreground\">\n                            {deal.name ||\n                              `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim() ||\n                              `Deal #${deal.id}`}\n                          </span>\n                        )}\n                      />\n                    </ReferenceField>\n                  );\n\n                return (\n                  <div key={`${resource}-${note.id}`} className=\"space-y-2\">\n                    <ResourceContextProvider value={resource}>\n                      <Note\n                        note={note}\n                        isLast={index === mergedNotes.length - 1}\n                        context={context}\n                      />\n                    </ResourceContextProvider>\n                  </div>\n                );\n              })}\n\n              {canLoadMore && (\n                <div className=\"flex justify-center pt-2\">\n                  <button\n                    type=\"button\"\n                    className=\"text-sm text-muted-foreground hover:text-foreground underline underline-offset-4\"\n                    onClick={() => setPerPage((p) => p + 50)}\n                  >\n                    Load more\n                  </button>\n                </div>\n              )}\n            </div>\n          ) : (\n            <div className=\"text-sm text-muted-foreground\">No notes yet.</div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nNotesPage.path = \"/notes\";\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NotesIterator.tsx",
      "content": "import { useListContext } from \"ra-core\";\n\nimport { Note } from \"./Note\";\nimport { NoteCreate } from \"./NoteCreate\";\n\nexport const NotesIterator = ({\n  reference,\n  showStatus,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  showStatus?: boolean;\n}) => {\n  const { data, error, isPending } = useListContext();\n  return (\n    <div className=\"space-y-3\">\n      <NoteCreate reference={reference} showStatus={showStatus} />\n      {error ? (\n        <div className=\"text-sm text-destructive\">\n          Unable to load notes. You can still add a new note above.\n        </div>\n      ) : isPending ? (\n        <div className=\"text-sm text-muted-foreground\">Loading notes</div>\n      ) : data && data.length > 0 ? (\n        <div className=\"space-y-2\">\n          {data.map((note, index) => (\n            <Note\n              note={note}\n              isLast={index === data.length - 1}\n              key={index}\n              showStatus={showStatus}\n            />\n          ))}\n        </div>\n      ) : (\n        <div className=\"text-sm text-muted-foreground\">No notes yet.</div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NoteInputs.tsx",
      "content": "import { Fragment, useRef, useState } from \"react\";\nimport { useFormContext } from \"react-hook-form\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport { useInput, useNotify } from \"ra-core\";\nimport {\n  FormControl,\n  FormError,\n  FormField,\n} from \"@/components/admin/form\";\nimport { InputHelperText } from \"@/components/admin/input-helper-text\";\nimport { Paperclip, X } from \"lucide-react\";\n\nimport { SmartTextInput } from \"../misc/SmartTextInput\";\nimport type { AttachmentNote } from \"../types\";\nimport { supabase } from \"../providers/supabase/supabase\";\n\nexport const NoteInputs = ({ showStatus }: { showStatus?: boolean }) => {\n  // showStatus is intentionally ignored  user requested removing Status UI.\n  void showStatus;\n\n  const notify = useNotify();\n  const { setValue, watch } = useFormContext();\n  const { id, field } = useInput({ source: \"text\" });\n  const fileInputRef = useRef<HTMLInputElement | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n\n  const attachments = (watch(\"attachments\") as AttachmentNote[] | undefined) ?? [];\n\n  const handleUsersTagged = (userIds: number[]) => {\n    // Update the tagged_user_ids field when users are tagged\n    setValue(\"tagged_user_ids\", userIds.length > 0 ? userIds : undefined, { shouldDirty: true });\n  };\n\n  const uploadAttachment = async (file: File): Promise<AttachmentNote> => {\n    const ext = file.name.split(\".\").pop() || \"png\";\n    const base =\n      (globalThis.crypto as any)?.randomUUID?.() ??\n      `${Date.now()}-${Math.random().toString(16).slice(2)}`;\n    const path = `${base}.${ext}`;\n\n    const { error: uploadError } = await supabase.storage\n      .from(\"attachments\")\n      .upload(path, file, {\n        contentType: file.type || undefined,\n        upsert: false,\n      });\n\n    if (uploadError) throw uploadError;\n\n    const { data } = supabase.storage.from(\"attachments\").getPublicUrl(path);\n    return {\n      src: data.publicUrl,\n      title: file.name || `image.${ext}`,\n      path,\n      type: file.type || undefined,\n      // rawFile is only for client-side; we don't persist it\n      rawFile: file,\n    };\n  };\n\n  const addFiles = async (files: File[]) => {\n    const imageFiles = files.filter((f) => f.type?.startsWith(\"image/\"));\n    if (imageFiles.length === 0) return;\n\n    setIsUploading(true);\n    try {\n      const uploaded = await Promise.all(imageFiles.map(uploadAttachment));\n      const next = [...attachments, ...uploaded].map(({ rawFile: _raw, ...rest }) => rest as any);\n      // store without rawFile (DB column is jsonb[])\n      setValue(\"attachments\", next, { shouldDirty: true });\n      notify(`${uploaded.length} image${uploaded.length === 1 ? \"\" : \"s\"} attached`, {\n        type: \"success\",\n      });\n    } catch (e: any) {\n      console.error(\"NoteInputs: upload failed\", e);\n      notify(\"Failed to upload image\", { type: \"error\" });\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const handlePaste = async (e: React.ClipboardEvent) => {\n    const items = e.clipboardData?.items;\n    if (!items) return;\n    const imageItems = Array.from(items).filter((it) => it.type?.startsWith(\"image/\"));\n    if (imageItems.length === 0) return;\n\n    e.preventDefault();\n    const files = imageItems\n      .map((it) => it.getAsFile())\n      .filter((f): f is File => !!f)\n      .map((f) => (f.name ? f : new File([f], `pasted-image-${Date.now()}.png`, { type: f.type })));\n\n    await addFiles(files);\n  };\n\n  const handleDrop = async (e: React.DragEvent) => {\n    const files = Array.from(e.dataTransfer?.files ?? []);\n    if (files.length === 0) return;\n    const hasImages = files.some((f) => f.type?.startsWith(\"image/\"));\n    if (!hasImages) return;\n    e.preventDefault();\n    e.stopPropagation();\n    await addFiles(files);\n  };\n\n  const removeAttachmentAt = (index: number) => {\n    const next = attachments.filter((_, i) => i !== index);\n    setValue(\"attachments\", next.length ? next : undefined, { shouldDirty: true });\n  };\n\n  return (\n    <Fragment>\n      <FormField id={id} className=\"m-0\" name={field.name}>\n        <FormControl>\n          <SmartTextInput\n            value={field.value || \"\"}\n            onChange={field.onChange}\n            onBlur={field.onBlur}\n            multiline\n            placeholder=\"Add a note. Try tagging someone with @username\"\n            rows={6}\n            onUsersTagged={handleUsersTagged}\n            onPaste={handlePaste as any}\n            onDrop={handleDrop as any}\n            onDragOver={(e: React.DragEvent) => {\n              // allow dropping images\n              if (Array.from(e.dataTransfer?.items ?? []).some((it) => it.type?.startsWith(\"image/\"))) {\n                e.preventDefault();\n              }\n            }}\n          />\n        </FormControl>\n        <InputHelperText helperText={false} />\n        <FormError />\n      </FormField>\n\n      <div className=\"mt-2 flex items-center justify-between gap-2\">\n        <div className=\"flex items-center gap-2\">\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\"image/*\"\n            multiple\n            className=\"hidden\"\n            onChange={async (e) => {\n              const files = Array.from(e.target.files ?? []);\n              // reset so selecting the same file twice works\n              e.currentTarget.value = \"\";\n              await addFiles(files);\n            }}\n          />\n          <Button\n            type=\"button\"\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"gap-2\"\n            disabled={isUploading}\n            onClick={() => fileInputRef.current?.click()}\n            title=\"Attach images (you can also paste or drag & drop)\"\n          >\n            <Paperclip className=\"h-4 w-4\" />\n            {isUploading ? \"Uploading...\" : \"Attach images\"}\n          </Button>\n          <span className=\"text-xs text-muted-foreground\">\n            Tip: paste an image from clipboard or drag & drop into the note.\n          </span>\n        </div>\n      </div>\n\n      {attachments.length > 0 && (\n        <div className=\"mt-3\">\n          <div className=\"text-xs text-muted-foreground mb-2\">Attachments</div>\n          <div className=\"grid grid-cols-4 gap-3\">\n            {attachments.map((att, index) => (\n              <div key={`${att.src}-${index}`} className=\"relative border rounded-md overflow-hidden\">\n                <img\n                  src={att.src}\n                  alt={att.title}\n                  className=\"w-full h-20 object-cover cursor-pointer\"\n                  onClick={() => window.open(att.src, \"_blank\")}\n                />\n                <button\n                  type=\"button\"\n                  className={cn(\n                    \"absolute top-1 right-1 rounded-full bg-background/80 border p-1\",\n                    \"hover:bg-background\",\n                  )}\n                  onClick={() => removeAttachmentAt(index)}\n                  title=\"Remove\"\n                >\n                  <X className=\"h-3 w-3\" />\n                </button>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </Fragment>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NoteCreate.tsx",
      "content": "import {\n  CreateBase,\n  Form,\n  useGetIdentity,\n  useListContext,\n  useNotify,\n  useRecordContext,\n  useResourceContext,\n  useUpdate,\n  type Identifier,\n  type RaRecord,\n} from \"ra-core\";\nimport { useFormContext } from \"react-hook-form\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { cn } from \"@/lib/utils\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { NoteInputs } from \"./NoteInputs\";\n\nconst foreignKeyMapping = {\n  contacts: \"contact_id\",\n  \"lead-journey\": \"deal_id\",\n};\n\nexport const NoteCreate = ({\n  reference,\n  showStatus,\n  className,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  showStatus?: boolean;\n  className?: string;\n}) => {\n  const resource = useResourceContext();\n  const record = useRecordContext();\n  const { identity } = useGetIdentity();\n\n  if (!record) return null;\n\n  return (\n    <Card className=\"bg-muted/30 py-3\">\n      <CardContent className=\"pt-0 px-4 pb-0\">\n        <CreateBase resource={resource} redirect={false}>\n          <Form>\n            <div className={className}>\n              <NoteInputs showStatus={showStatus} />\n              <NoteCreateButton reference={reference} record={record} />\n            </div>\n          </Form>\n        </CreateBase>\n      </CardContent>\n    </Card>\n  );\n};\n\nconst NoteCreateButton = ({\n  reference,\n  record,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  record: RaRecord<Identifier>;\n}) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const { identity } = useGetIdentity();\n  const { reset } = useFormContext();\n  const { refetch } = useListContext();\n\n  if (!record) return null;\n\n  const resetValues: {\n    text: null;\n    attachments: null;\n    tagged_user_ids?: undefined;\n  } = {\n    text: null,\n    attachments: null,\n    tagged_user_ids: undefined,\n  };\n\n  const handleSuccess = (data: any) => {\n    reset(resetValues, { keepValues: false });\n    refetch();\n    update(reference, {\n      id: (record && record.id) as unknown as Identifier,\n      data: { last_seen: new Date().toISOString() },\n      previousData: record,\n    });\n    notify(\"Note added\");\n  };\n\n  return (\n    <div className=\"flex justify-end\">\n      <SaveButton\n        type=\"button\"\n        label=\"Add this note\"\n        transform={(data) => {\n          const { tagged_user_ids, ...restData } = data;\n          const result: any = {\n            ...restData,\n            [foreignKeyMapping[reference]]: record.id,\n            sales_id: identity?.id,\n            // Always save notes with current time\n            date: new Date().toISOString(),\n          };\n          // Only include tagged_user_ids if it's a non-empty array\n          // This avoids schema cache issues if the column doesn't exist yet\n          if (Array.isArray(tagged_user_ids) && tagged_user_ids.length > 0) {\n            result.tagged_user_ids = tagged_user_ids;\n          }\n          return result;\n        }}\n        mutationOptions={{\n          onSuccess: handleSuccess,\n        }}\n      >\n        Add this note\n      </SaveButton>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NoteAttachments.tsx",
      "content": "import { Paperclip } from \"lucide-react\";\n\nimport type { AttachmentNote, ContactNote, DealNote } from \"../types\";\n\nexport const NoteAttachments = ({ note }: { note: ContactNote | DealNote }) => {\n  if (!note.attachments || note.attachments.length === 0) {\n    return null;\n  }\n\n  const imageAttachments = note.attachments.filter(\n    (attachment: AttachmentNote) => isImageMimeType(attachment.type),\n  );\n  const otherAttachments = note.attachments.filter(\n    (attachment: AttachmentNote) => !isImageMimeType(attachment.type),\n  );\n\n  return (\n    <div className=\"flex flex-col\">\n      {imageAttachments.length > 0 && (\n        <div className=\"grid grid-cols-4 gap-8\">\n          {imageAttachments.map((attachment: AttachmentNote, index: number) => (\n            <div key={index}>\n              <img\n                src={attachment.src}\n                alt={attachment.title}\n                className=\"w-[200px] h-[100px] object-cover cursor-pointer object-left border border-border\"\n                onClick={() => window.open(attachment.src, \"_blank\")}\n              />\n            </div>\n          ))}\n        </div>\n      )}\n      {otherAttachments.length > 0 &&\n        otherAttachments.map((attachment: AttachmentNote, index: number) => (\n          <div key={index} className=\"flex items-center gap-2\">\n            <Paperclip className=\"w-4 h-4\" />\n            <a\n              href={attachment.src}\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"underline hover:no-underline\"\n            >\n              {attachment.title}\n            </a>\n          </div>\n        ))}\n    </div>\n  );\n};\n\nconst isImageMimeType = (mimeType?: string): boolean => {\n  if (!mimeType) {\n    return false;\n  }\n  return mimeType.startsWith(\"image/\");\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/Note.tsx",
      "content": "import { CircleX, Edit, Save, Trash2 } from \"lucide-react\";\nimport {\n  Form,\n  useDelete,\n  useNotify,\n  useResourceContext,\n  useUpdate,\n  WithRecord,\n} from \"ra-core\";\nimport { useState, type ReactNode } from \"react\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\n\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { Status } from \"../misc/Status\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ContactNote, DealNote } from \"../types\";\nimport { NoteInputs } from \"./NoteInputs\";\n\nexport const Note = ({\n  showStatus,\n  note,\n  context,\n}: {\n  showStatus?: boolean;\n  note: DealNote | ContactNote;\n  isLast: boolean;\n  context?: ReactNode;\n}) => {\n  const [isHover, setHover] = useState(false);\n  const [isEditing, setEditing] = useState(false);\n  const resource = useResourceContext();\n  const notify = useNotify();\n\n  const [update, { isPending }] = useUpdate();\n\n  const [deleteNote] = useDelete(\n    resource,\n    { id: note.id, previousData: note },\n    {\n      mutationMode: \"undoable\",\n      onSuccess: () => {\n        notify(\"Note deleted\", { type: \"info\", undoable: true });\n      },\n    },\n  );\n\n  const handleDelete = () => {\n    deleteNote();\n  };\n\n  const handleEnterEditMode = () => {\n    setEditing(!isEditing);\n  };\n\n  const handleCancelEdit = () => {\n    setEditing(false);\n    setHover(false);\n  };\n\n  const handleNoteUpdate: SubmitHandler<FieldValues> = (values) => {\n    update(\n      resource,\n      { id: note.id, data: values, previousData: note },\n      {\n        onSuccess: () => {\n          setEditing(false);\n          setHover(false);\n        },\n      },\n    );\n  };\n\n  return (\n    <Card\n      id={`note-${note.id}`}\n      className=\"hover:shadow-md transition-shadow py-3 gap-2\"\n      onMouseEnter={() => setHover(true)}\n      onMouseLeave={() => setHover(false)}\n    >\n      <CardHeader className=\"pb-2 px-4 pt-0\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <div className=\"flex items-start gap-2 flex-1 min-w-0\">\n            <div className=\"flex-1 min-w-0\">\n              {/* Keep header on a single line; truncate if it overflows */}\n              <div className=\"flex items-center gap-2 min-w-0 whitespace-nowrap overflow-hidden\">\n                <span className=\"text-sm font-medium flex-shrink-0\">\n                  <ReferenceField\n                    record={note}\n                    resource={resource}\n                    source=\"sales_id\"\n                    reference=\"sales\"\n                    link={false}\n                  >\n                    <WithRecord render={(record) => <SaleName sale={record} />} />\n                  </ReferenceField>\n                </span>\n                <span className=\"text-sm text-muted-foreground truncate min-w-0 overflow-hidden text-ellipsis\">\n                  added a note\n                  {context ? (\n                    <>\n                      {\" \"}\n                      on <span className=\"inline whitespace-nowrap\">{context}</span>\n                    </>\n                  ) : null}\n                </span>\n                {showStatus && note.status && (\n                  <Status className=\"ml-1 flex-shrink-0\" status={note.status} />\n                )}\n              </div>\n            </div>\n          </div>\n          <div className={`flex items-center gap-1 ${isHover ? \"opacity-100\" : \"opacity-0\"} transition-opacity`}>\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleEnterEditMode}\n                    className=\"h-7 w-7 p-0 cursor-pointer\"\n                  >\n                    <Edit className=\"w-3.5 h-3.5\" />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Edit note</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleDelete}\n                    className=\"h-7 w-7 p-0 cursor-pointer text-destructive hover:text-destructive\"\n                  >\n                    <Trash2 className=\"w-3.5 h-3.5\" />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Delete note</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent className=\"pt-0 px-4 pb-0\">\n        {isEditing ? (\n          <Form onSubmit={handleNoteUpdate} record={note}>\n            <NoteInputs showStatus={showStatus} />\n            <div className=\"flex justify-end gap-2 mt-3\">\n              <Button\n                variant=\"outline\"\n                onClick={handleCancelEdit}\n                type=\"button\"\n                size=\"sm\"\n                className=\"cursor-pointer\"\n              >\n                <CircleX className=\"w-4 h-4 mr-2\" />\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={isPending}\n                size=\"sm\"\n                className=\"cursor-pointer\"\n              >\n                <Save className=\"w-4 h-4 mr-2\" />\n                Save\n              </Button>\n            </div>\n          </Form>\n        ) : (\n          <div className=\"flex items-start justify-between gap-3\">\n            <div className=\"flex-1 [&_p:empty]:min-h-[0.75em]\">\n              {note.text?.split(\"\\n\").map((paragraph: string, index: number) => (\n                <p className=\"text-sm leading-5 m-0 mb-1.5 last:mb-0\" key={index}>\n                  {paragraph}\n                </p>\n              ))}\n            </div>\n            <span className=\"text-xs text-muted-foreground whitespace-nowrap mt-0.5\">\n              <RelativeDate date={note.date} />\n            </span>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/usePapaParse.tsx",
      "content": "import * as Papa from \"papaparse\";\nimport { useCallback, useMemo, useRef, useState } from \"react\";\n\nexport type ImportError = {\n  row: number;\n  message: string;\n  data?: unknown;\n};\n\ntype Import =\n  | {\n      state: \"idle\";\n    }\n  | {\n      state: \"parsing\";\n    }\n  | {\n      state: \"running\" | \"complete\";\n\n      rowCount: number;\n      importCount: number;\n      errorCount: number;\n      errors: ImportError[];\n\n      // The remaining time in milliseconds\n      remainingTime: number | null;\n    }\n  | {\n      state: \"error\";\n\n      error: Error;\n    };\n\ntype usePapaParseProps<T> = {\n  // The import batch size\n  batchSize?: number;\n\n  // processBatch returns the number of imported items\n  // It can throw errors or return an array of errors for individual rows\n  processBatch(batch: T[], startRowIndex: number): Promise<ImportError[]>;\n};\n\nexport function usePapaParse<T>({\n  batchSize = 10,\n  processBatch,\n}: usePapaParseProps<T>) {\n  const importIdRef = useRef<number>(0);\n\n  const [importer, setImporter] = useState<Import>({\n    state: \"idle\",\n  });\n\n  const reset = useCallback(() => {\n    setImporter({\n      state: \"idle\",\n    });\n    importIdRef.current += 1;\n  }, []);\n\n  const parseCsv = useCallback(\n    (file: File) => {\n      setImporter({\n        state: \"parsing\",\n      });\n\n      const importId = importIdRef.current;\n      Papa.parse<T>(file, {\n        header: true,\n        skipEmptyLines: true,\n        async complete(results) {\n          if (importIdRef.current !== importId) {\n            return;\n          }\n\n          const csvErrors: ImportError[] = results.errors.map((err) => ({\n            row: (err.row ?? 0) + 1, // Convert to 1-based row number\n            message: err.message || \"CSV parsing error\",\n            data: err,\n          }));\n\n          setImporter({\n            state: \"running\",\n            rowCount: results.data.length,\n            errorCount: csvErrors.length,\n            importCount: 0,\n            remainingTime: null,\n            errors: csvErrors,\n          });\n\n          let totalTime = 0;\n          const importErrors: ImportError[] = [...csvErrors];\n          \n          for (let i = 0; i < results.data.length; i += batchSize) {\n            if (importIdRef.current !== importId) {\n              return;\n            }\n\n            const batch = results.data.slice(i, i + batchSize);\n            const startRowIndex = i + 1; // 1-based row number\n            try {\n              const start = Date.now();\n              const batchErrors = await processBatch(batch, startRowIndex);\n              totalTime += Date.now() - start;\n\n              // Add batch errors to the list\n              if (batchErrors && batchErrors.length > 0) {\n                importErrors.push(...batchErrors);\n              }\n\n              const meanTime = totalTime / (i + batch.length);\n              const successfulCount = batch.length - (batchErrors?.length || 0);\n              setImporter((previous) => {\n                if (previous.state === \"running\") {\n                  const importCount = previous.importCount + successfulCount;\n                  return {\n                    ...previous,\n                    importCount,\n                    errorCount: importErrors.length,\n                    errors: importErrors,\n                    remainingTime:\n                      meanTime * (results.data.length - importCount),\n                  };\n                }\n                return previous;\n              });\n            } catch (error) {\n              console.error(\"Failed to import batch\", error);\n              // If processBatch throws, mark all rows in batch as errors\n              const batchErrors: ImportError[] = batch.map((_, idx) => ({\n                row: startRowIndex + idx,\n                message: error instanceof Error ? error.message : String(error),\n                data: batch[idx],\n              }));\n              importErrors.push(...batchErrors);\n              \n              setImporter((previous) =>\n                previous.state === \"running\"\n                  ? {\n                      ...previous,\n                      errorCount: importErrors.length,\n                      errors: importErrors,\n                    }\n                  : previous,\n              );\n            }\n          }\n\n          setImporter((previous) =>\n            previous.state === \"running\"\n              ? {\n                  ...previous,\n                  state: \"complete\",\n                  remainingTime: null,\n                  errors: importErrors,\n                }\n              : previous,\n          );\n        },\n        error(error) {\n          console.error(error);\n          setImporter({\n            state: \"error\",\n            error,\n          });\n        },\n        dynamicTyping: true,\n      });\n    },\n    [batchSize, processBatch],\n  );\n\n  return useMemo(\n    () => ({\n      importer,\n      parseCsv,\n      reset,\n    }),\n    [importer, parseCsv, reset],\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/useAppBarHeight.ts",
      "content": "import { useIsMobile } from \"@/hooks/use-mobile\";\n\nconst DENSE_NAVBAR_HEIGHT = 48;\nconst DENSE_NAVBAR_HEIGHT_MOBILE = 64;\n\nexport default function useAppBarHeight(): number {\n  const isMobile = useIsMobile();\n  return isMobile ? DENSE_NAVBAR_HEIGHT_MOBILE : DENSE_NAVBAR_HEIGHT;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/unsupportedDomains.const.ts",
      "content": "// If you want to add more domains to the list, you can do so by adding them to the DOMAINS_NOT_SUPPORTING_FAVICON array.\nexport const DOMAINS_NOT_SUPPORTING_FAVICON = [\n  \"gmail.com\",\n  \"yahoo.com\",\n  \"hotmail.com\",\n  \"aol.com\",\n  \"hotmail.co.uk\",\n  \"hotmail.fr\",\n  \"msn.com\",\n  \"yahoo.fr\",\n  \"wanadoo.fr\",\n  \"orange.fr\",\n  \"comcast.net\",\n  \"yahoo.co.uk\",\n  \"yahoo.com.br\",\n  \"yahoo.co.in\",\n  \"live.com\",\n  \"rediffmail.com\",\n  \"free.fr\",\n  \"gmx.de\",\n  \"web.de\",\n  \"yandex.ru\",\n  \"ymail.com\",\n  \"libero.it\",\n  \"outlook.com\",\n  \"uol.com.br\",\n  \"bol.com.br\",\n  \"mail.ru\",\n  \"cox.net\",\n  \"hotmail.it\",\n  \"sbcglobal.net\",\n  \"sfr.fr\",\n  \"live.fr\",\n  \"verizon.net\",\n  \"live.co.uk\",\n  \"googlemail.com\",\n  \"yahoo.es\",\n  \"ig.com.br\",\n  \"live.nl\",\n  \"bigpond.com\",\n  \"terra.com.br\",\n  \"yahoo.it\",\n  \"neuf.fr\",\n  \"yahoo.de\",\n  \"alice.it\",\n  \"rocketmail.com\",\n  \"att.net\",\n  \"laposte.net\",\n  \"facebook.com\",\n  \"bellsouth.net\",\n  \"yahoo.in\",\n  \"hotmail.es\",\n  \"charter.net\",\n  \"yahoo.ca\",\n  \"yahoo.com.au\",\n  \"rambler.ru\",\n  \"hotmail.de\",\n  \"tiscali.it\",\n  \"shaw.ca\",\n  \"yahoo.co.jp\",\n  \"sky.com\",\n  \"earthlink.net\",\n  \"optonline.net\",\n  \"freenet.de\",\n  \"t-online.de\",\n  \"aliceadsl.fr\",\n  \"virgilio.it\",\n  \"home.nl\",\n  \"qq.com\",\n  \"telenet.be\",\n  \"me.com\",\n  \"yahoo.com.ar\",\n  \"tiscali.co.uk\",\n  \"yahoo.com.mx\",\n  \"voila.fr\",\n  \"gmx.net\",\n  \"mail.com\",\n  \"planet.nl\",\n  \"tin.it\",\n  \"live.it\",\n  \"ntlworld.com\",\n  \"arcor.de\",\n  \"yahoo.co.id\",\n  \"frontiernet.net\",\n  \"hetnet.nl\",\n  \"live.com.au\",\n  \"yahoo.com.sg\",\n  \"zonnet.nl\",\n  \"club-internet.fr\",\n  \"juno.com\",\n  \"optusnet.com.au\",\n  \"blueyonder.co.uk\",\n  \"bluewin.ch\",\n  \"skynet.be\",\n  \"sympatico.ca\",\n  \"windstream.net\",\n  \"mac.com\",\n  \"centurytel.net\",\n  \"chello.nl\",\n  \"live.ca\",\n  \"aim.com\",\n  \"bigpond.net.au\",\n  \"online.de\",\n  \"apple.com\",\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/timezone.ts",
      "content": "import { getCrmTimeZone, getCrmTimeZoneOffsetMinutes } from \"@/hooks/useTimezone\";\n\nexport type DateInput = Date | string | number | null | undefined;\n\nconst DAY_IN_MS = 24 * 60 * 60 * 1000;\nconst pad = (value: number) => value.toString().padStart(2, \"0\");\n\n/**\n * Gets the current CRM timezone\n * @deprecated Use getCrmTimeZone() function instead\n */\nexport function CRM_TIME_ZONE(): string {\n  return getCrmTimeZone();\n}\n\n/**\n * Gets the current CRM timezone label (e.g., \"UTC+4\")\n */\nexport function getCrmTimeZoneLabel(): string {\n  const offsetMinutes = getCrmTimeZoneOffsetMinutes();\n  const offsetHours = Math.floor(Math.abs(offsetMinutes) / 60);\n  const offsetMins = Math.abs(offsetMinutes) % 60;\n  const sign = offsetMinutes >= 0 ? \"+\" : \"-\";\n  \n  const result = offsetMins === 0 \n    ? `UTC${sign}${offsetHours}`\n    : `UTC${sign}${offsetHours}:${String(offsetMins).padStart(2, \"0\")}`;\n  return result;\n}\n\n/**\n * Gets the current CRM timezone label (e.g., \"UTC+4\")\n * @deprecated Use getCrmTimeZoneLabel() function instead for dynamic updates\n * This constant is initialized with a safe fallback to avoid module load errors\n */\nexport const CRM_TIME_ZONE_LABEL = (() => {\n  try {\n    if (typeof window !== \"undefined\") {\n      return getCrmTimeZoneLabel();\n    }\n  } catch (error) {\n    // Silently fall back to default\n  }\n  return \"UTC+4\"; // Safe fallback\n})();\n\n/**\n * Gets a formatter for date-time using the current CRM timezone\n */\nfunction getDateTimeFormatter() {\n  return new Intl.DateTimeFormat(\"en-GB\", {\n    timeZone: getCrmTimeZone(),\n    year: \"numeric\",\n    month: \"2-digit\",\n    day: \"2-digit\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    hour12: false,\n  });\n}\n\n/**\n * Gets a formatter for date using the current CRM timezone\n */\nfunction getDateFormatter() {\n  return new Intl.DateTimeFormat(\"en-GB\", {\n    timeZone: getCrmTimeZone(),\n    year: \"numeric\",\n    month: \"2-digit\",\n    day: \"2-digit\",\n  });\n}\n\n/**\n * Gets a formatter for YYYY-MM-DD date strings using the current CRM timezone\n */\nfunction getYmdDateFormatter() {\n  return new Intl.DateTimeFormat(\"en-CA\", {\n    timeZone: getCrmTimeZone(),\n    year: \"numeric\",\n    month: \"2-digit\",\n    day: \"2-digit\",\n  });\n}\n\n/**\n * Gets a formatter for time using the current CRM timezone\n */\nfunction getTimeFormatter() {\n  return new Intl.DateTimeFormat(\"en-GB\", {\n    timeZone: getCrmTimeZone(),\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    hour12: false,\n  });\n}\n\n/**\n * Gets a formatter for date-time parts using the current CRM timezone\n */\nfunction getPartsFormatter() {\n  return new Intl.DateTimeFormat(\"en-CA\", {\n    timeZone: getCrmTimeZone(),\n    year: \"numeric\",\n    month: \"2-digit\",\n    day: \"2-digit\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: false,\n  });\n}\n\n/**\n * Formats a date as DD/MM/YYYY or DD/MM (without year if same year as current)\n * This ensures consistent DD/MM/YYYY format regardless of browser locale\n */\nfunction formatDateDDMMYYYY(date: Date, includeYear: boolean = true): string {\n  try {\n    if (!date || isNaN(date.getTime())) {\n      return \"\";\n    }\n    const dateFormatter = getDateFormatter();\n    const parts = dateFormatter.formatToParts(date);\n    const day = parts.find((p) => p.type === \"day\")?.value || \"\";\n    const month = parts.find((p) => p.type === \"month\")?.value || \"\";\n    const year = parts.find((p) => p.type === \"year\")?.value || \"\";\n\n    if (!day || !month) {\n      return \"\";\n    }\n\n    if (includeYear) {\n      return `${day}/${month}/${year}`;\n    }\n    return `${day}/${month}`;\n  } catch (error) {\n    console.warn(\"Error formatting date:\", error, date);\n    return \"\";\n  }\n}\n\nfunction parseDate(value: DateInput): Date | undefined {\n  if (value instanceof Date) {\n    return value;\n  }\n  if (typeof value === \"string\" || typeof value === \"number\") {\n    const parsed = new Date(value);\n    if (!Number.isNaN(parsed.getTime())) {\n      return parsed;\n    }\n  }\n  return undefined;\n}\n\nfunction getZonedParts(value: DateInput) {\n  const date = parseDate(value);\n  if (!date) return undefined;\n  const partsFormatter = getPartsFormatter();\n  const parts = partsFormatter.formatToParts(date).reduce<Record<string, number>>(\n    (acc, part) => {\n      if (part.type !== \"literal\") {\n        acc[part.type] = Number(part.value);\n      }\n      return acc;\n    },\n    {},\n  );\n\n  return {\n    year: parts.year,\n    month: parts.month,\n    day: parts.day,\n    hour: parts.hour ?? 0,\n    minute: parts.minute ?? 0,\n    second: parts.second ?? 0,\n    millisecond: 0,\n  };\n}\n\n/**\n * Converts a timezone-local time to a UTC Date object.\n * \n * CRITICAL: This function SUBTRACTS the timezone offset from the UTC timestamp.\n * \n * Example for UTC+4:\n * - Input: {year: 2025, month: 12, day: 26, hour: 0, minute: 0} (00:00 in CRM timezone)\n * - Creates: Date.UTC(2025, 11, 26, 0, 0, 0) = 2025-12-26T00:00:00Z\n * - Subtracts offset: 00:00 - 4 hours = 2025-12-25T20:00:00Z\n * - Result: Date representing 00:00 in UTC+4 (which is 20:00 UTC previous day)\n * \n * When this Date is formatted in CRM timezone using extractCrmTime(), it correctly shows 00:00.\n * \n * DO NOT change the subtraction operation - it depends on getCrmTimeZoneOffsetMinutes()\n * returning a positive value for timezones ahead of UTC.\n */\nfunction buildUtcFromZoned(parts: {\n  year?: number;\n  month?: number;\n  day?: number;\n  hour?: number;\n  minute?: number;\n  second?: number;\n  millisecond?: number;\n}) {\n  if (\n    parts.year === undefined ||\n    parts.month === undefined ||\n    parts.day === undefined\n  ) {\n    return undefined;\n  }\n\n  // Get offset: positive for timezones ahead of UTC (e.g., +240 for UTC+4)\n  const offsetMinutes = getCrmTimeZoneOffsetMinutes();\n  const offsetMs = offsetMinutes * 60 * 1000;\n\n  // CRITICAL: We SUBTRACT the offset to convert timezone time to UTC\n  // This works because getCrmTimeZoneOffsetMinutes() returns positive for UTC+4\n  // DO NOT change this to addition - it will break timezone conversions!\n  return new Date(\n    Date.UTC(\n      parts.year,\n      parts.month - 1,\n      parts.day,\n      parts.hour ?? 0,\n      parts.minute ?? 0,\n      parts.second ?? 0,\n      parts.millisecond ?? 0,\n    ) - offsetMs,\n  );\n}\n\nexport function formatCrmDateTime(value: DateInput) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return getDateTimeFormatter().format(date);\n}\n\n/**\n * Formats a date as DD/MM/YYYY using the CRM timezone.\n * This ensures consistent DD/MM/YYYY format regardless of browser locale.\n */\nexport function formatCrmDate(value: DateInput) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return formatDateDDMMYYYY(date, true);\n}\n\n/**\n * Formats a date as DD/MM (without year) using the CRM timezone.\n * Useful for dates like birthdays or recurring events where year is not needed.\n */\nexport function formatCrmDateShort(value: DateInput) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return formatDateDDMMYYYY(date, false);\n}\n\nexport function formatCrmTime(value: DateInput) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return getTimeFormatter().format(date);\n}\n\n/**\n * Extracts hour and minute from a Date object as they appear in the CRM timezone.\n * Returns a string in \"HH:MM\" format.\n * \n * IMPORTANT: This function formats the Date in CRM timezone, so it correctly extracts\n * the time components regardless of the Date's internal UTC representation.\n * \n * Works with Dates created by buildUtcFromZoned() and convertFullCalendarDateToCrmDate():\n * - These Dates have UTC timestamps that represent CRM timezone times\n * - When formatted in CRM timezone, they show the correct time\n * \n * Example: Date representing 00:00 in UTC+4 (stored as 20:00 UTC previous day)\n * - extractCrmTime() formats it in CRM timezone  returns \"00:00\" \n * \n * DO NOT change the timezone formatting - it's critical for correct time extraction.\n */\nexport function extractCrmTime(value: DateInput): string {\n  const date = parseDate(value);\n  if (!date) return \"00:00\";\n  const partsFormatter = getPartsFormatter();\n  const parts = partsFormatter.formatToParts(date).reduce<Record<string, number>>(\n    (acc, part) => {\n      if (part.type !== \"literal\") {\n        acc[part.type] = Number(part.value);\n      }\n      return acc;\n    },\n    {},\n  );\n  const hour = parts.hour ?? 0;\n  const minute = parts.minute ?? 0;\n  return `${pad(hour)}:${pad(minute)}`;\n}\n\nexport function crmDateInputString(value: DateInput = new Date()) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return getDateFormatter().format(date);\n}\n\n/**\n * Returns a date string in YYYY-MM-DD format, using the CRM timezone.\n * This is ideal for `<input type=\"date\">` values and react-hook-form state.\n */\nexport function crmDateYmdInputString(value: DateInput = new Date()) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return getYmdDateFormatter().format(date);\n}\n\nexport function crmDateStringToDate(value: string | null | undefined) {\n  if (!value) return undefined;\n  const [year, month, day] = value.split(\"-\").map((v) => Number(v));\n  if (!year || !month || !day) return undefined;\n  return buildUtcFromZoned({ year, month, day, hour: 0, minute: 0, second: 0 });\n}\n\nexport function crmDateStringToISO(value: string | null | undefined) {\n  const date = crmDateStringToDate(value);\n  return date?.toISOString();\n}\n\nexport function crmStartOfDay(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n  return buildUtcFromZoned({ ...parts, hour: 0, minute: 0, second: 0 });\n}\n\nexport function crmEndOfDay(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n  return buildUtcFromZoned({\n    ...parts,\n    hour: 23,\n    minute: 59,\n    second: 59,\n    millisecond: 999,\n  });\n}\n\nexport function crmAddDays(value: DateInput, days: number) {\n  const start = crmStartOfDay(value);\n  if (!start) return undefined;\n  return new Date(start.getTime() + days * DAY_IN_MS);\n}\n\nexport function crmStartOfWeek(value: DateInput = new Date(), weekStartsOn = 0) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n\n  const midpoint = buildUtcFromZoned({ ...parts, hour: 12, minute: 0, second: 0 });\n  if (!midpoint) return undefined;\n\n  const tzDay = midpoint.getUTCDay();\n  const diff = (tzDay - weekStartsOn + 7) % 7;\n  return crmAddDays(midpoint, -diff);\n}\n\nexport function crmEndOfWeek(value: DateInput = new Date(), weekStartsOn = 0) {\n  const start = crmStartOfWeek(value, weekStartsOn);\n  if (!start) return undefined;\n  return new Date(start.getTime() + 7 * DAY_IN_MS - 1);\n}\n\nexport function crmStartOfMonth(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n  return buildUtcFromZoned({\n    year: parts.year,\n    month: parts.month,\n    day: 1,\n    hour: 0,\n    minute: 0,\n    second: 0,\n  });\n}\n\nexport function crmEndOfYesterday(value: DateInput = new Date()) {\n  const yesterday = crmAddDays(value, -1);\n  if (!yesterday) return undefined;\n  return crmEndOfDay(yesterday);\n}\n\nexport function crmDayOfWeek(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n  const midday = buildUtcFromZoned({ ...parts, hour: 12, minute: 0, second: 0 });\n  return midday?.getUTCDay();\n}\n\nexport function crmDateTimeInputString(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return \"\";\n  return `${parts.year}-${pad(parts.month)}-${pad(parts.day)}T${pad(parts.hour)}:${pad(parts.minute)}`;\n}\n\nexport function crmDateTimeStringToDate(value: string | null | undefined) {\n  if (!value) return undefined;\n  const [datePart, timePart] = value.split(\"T\");\n  if (!datePart || !timePart) return undefined;\n  const [year, month, day] = datePart.split(\"-\").map((v) => Number(v));\n  const [hour, minute] = timePart.split(\":\").map((v) => Number(v));\n  if (!year || !month || !day || Number.isNaN(hour) || Number.isNaN(minute)) {\n    return undefined;\n  }\n  return buildUtcFromZoned({\n    year,\n    month,\n    day,\n    hour,\n    minute,\n    second: 0,\n    millisecond: 0,\n  });\n}\n\nexport function crmDateTimeStringToISO(value: string | null | undefined) {\n  const date = crmDateTimeStringToDate(value);\n  return date?.toISOString();\n}\n\n/**\n * Formats a date as relative time (e.g., \"2 days ago\") for recent dates,\n * or as DD/MM/YYYY for older dates (more than 7 days ago).\n */\nexport function formatRelativeOrDate(value: DateInput, baseDate: Date = new Date()) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  \n  const diffMs = baseDate.getTime() - date.getTime();\n  const diffDays = Math.floor(diffMs / DAY_IN_MS);\n  \n  // For dates within the last 7 days, use relative format\n  if (diffDays >= 0 && diffDays <= 7) {\n    if (diffDays === 0) return \"today\";\n    if (diffDays === 1) return \"yesterday\";\n    return `${diffDays} days ago`;\n  }\n  \n  // For older dates, use DD/MM/YYYY format\n  return formatCrmDate(date);\n}\n\n/**\n * Gets today's date at midnight in CRM timezone\n * This is the recommended way to get \"today\" for date navigation\n */\nexport function crmToday(): Date {\n  const today = crmStartOfDay(new Date());\n  if (!today) {\n    // Fallback: use local timezone start of day\n    const now = new Date();\n    return new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  }\n  return today;\n}\n\n/**\n * Re-export timezone functions for convenience\n */\nexport { getCrmTimeZone, getCrmTimeZoneOffsetMinutes, getCrmTimeZoneOffsetLabel } from \"@/hooks/useTimezone\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/timezone-api.ts",
      "content": "/**\n * TIMEZONE API - Centralized Timezone Utilities\n * \n *  IMPORTANT: Always use functions from this file for timezone-aware date/time operations.\n * DO NOT use native Date methods directly (getHours(), getUTCHours(), toISOString(), etc.)\n * without going through these utilities.\n * \n * This ensures all time calculations respect the CRM timezone configuration.\n */\n\nimport { getCrmTimeZone } from \"@/hooks/useTimezone\";\nimport { extractCrmTime, formatCrmDate, crmDateTimeStringToDate } from \"./timezone\";\n\n// Re-export all safe timezone utilities\nexport {\n  // Date/time formatting (always in CRM timezone)\n  formatCrmDate,\n  formatCrmDateShort,\n  formatCrmTime,\n  formatCrmDateTime,\n  extractCrmTime,\n  \n  // Date/time parsing and conversion\n  crmDateTimeStringToDate,\n  crmDateTimeStringToISO,\n  crmDateStringToISO,\n  crmDateYmdInputString,\n  crmDateTimeInputString,\n  \n  // Date manipulation (timezone-aware)\n  crmStartOfDay,\n  crmEndOfDay,\n  crmAddDays,\n  crmAddHours,\n  crmAddMinutes,\n  crmDayOfWeek,\n  crmStartOfWeek,\n  crmEndOfWeek,\n  crmStartOfMonth,\n  crmEndOfYesterday,\n  \n  // Relative date formatting\n  formatRelativeOrDate,\n  \n  // Types\n  type DateInput,\n} from \"./timezone\";\n\n// Re-export timezone info\nexport {\n  getCrmTimeZone,\n  getCrmTimeZoneOffsetMinutes,\n  getCrmTimeZoneLabel,\n} from \"@/hooks/useTimezone\";\n\n/**\n * Helper: Get current date/time in CRM timezone\n * Use this instead of new Date() when you need CRM timezone-aware dates\n */\nexport function getCurrentCrmDate(): Date {\n  return new Date(); // Date objects are always UTC internally, formatting handles timezone\n}\n\n/**\n * Helper: Create a Date from year, month, day, hour, minute in CRM timezone\n * Use this instead of new Date(year, month, day, hour, minute)\n */\nexport function createCrmDate(\n  year: number,\n  month: number, // 1-12 (not 0-11 like Date constructor)\n  day: number,\n  hour: number = 0,\n  minute: number = 0,\n  second: number = 0\n): Date | undefined {\n  const dateTimeString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}T${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;\n  return crmDateTimeStringToDate(dateTimeString);\n}\n\n/**\n * Helper: Parse a date string and return Date in CRM timezone\n * Use this instead of new Date(dateString)\n */\nexport function parseCrmDateString(dateString: string): Date | undefined {\n  return crmDateTimeStringToDate(dateString);\n}\n\n/**\n * Helper: Get time components from a Date as they appear in CRM timezone\n * Returns {hour, minute, second} in CRM timezone\n */\nexport function getCrmTimeComponents(date: Date): { hour: number; minute: number; second: number } | null {\n  const timeStr = extractCrmTime(date);\n  const [hour, minute] = timeStr.split(':').map(Number);\n  if (isNaN(hour) || isNaN(minute)) return null;\n  \n  // Get seconds from the date\n  const partsFormatter = new Intl.DateTimeFormat(\"en-CA\", {\n    timeZone: getCrmTimeZone(),\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: false,\n  });\n  const parts = partsFormatter.formatToParts(date);\n  const second = parseInt(parts.find(p => p.type === \"second\")?.value || \"0\", 10);\n  \n  return { hour, minute, second };\n}\n\n/**\n * Helper: Get date components from a Date as they appear in CRM timezone\n * Returns {year, month, day} in CRM timezone\n */\nexport function getCrmDateComponents(date: Date): { year: number; month: number; day: number } | null {\n  const dateStr = formatCrmDate(date);\n  if (!dateStr) return null;\n  \n  const [day, month, year] = dateStr.split('/').map(Number);\n  if (isNaN(year) || isNaN(month) || isNaN(day)) return null;\n  \n  return { year, month, day };\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/textParsing.ts",
      "content": "import { crmDateStringToISO, crmDateTimeStringToISO, crmStartOfDay } from \"./timezone\";\n\n/**\n * Parses natural language date/time expressions from text\n * Returns the parsed date string in ISO format or null\n * \n * Examples:\n * - \"tomorrow\" -> tomorrow's date\n * - \"next week\" -> date 7 days from now\n * - \"in 3 days\" -> date 3 days from now\n * - \"today at 3pm\" -> today at 3pm\n * - \"tomorrow at 2:30\" -> tomorrow at 2:30pm\n * - \"next Monday\" -> next Monday\n * - \"Dec 25\" -> December 25 of current year\n * - \"12/25\" -> December 25 of current year\n * - \"2024-12-25\" -> December 25, 2024\n * - \"3pm\" -> today at 3pm\n * - \"14:30\" -> today at 2:30pm\n */\nexport function parseDateFromText(text: string): string | null {\n  if (!text || typeof text !== \"string\") return null;\n\n  const now = new Date();\n  const today = crmStartOfDay(now);\n  if (!today) return null;\n\n  const lowerText = text.toLowerCase().trim();\n\n  // Relative dates\n  if (lowerText === \"today\" || lowerText === \"now\") {\n    return today.toISOString();\n  }\n\n  if (lowerText === \"tomorrow\") {\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    return tomorrow.toISOString();\n  }\n\n  if (lowerText === \"day after tomorrow\" || lowerText === \"day after tmrw\") {\n    const dayAfterTomorrow = new Date(today);\n    dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);\n    return dayAfterTomorrow.toISOString();\n  }\n\n  if (lowerText === \"next week\") {\n    const nextWeek = new Date(today);\n    nextWeek.setDate(nextWeek.getDate() + 7);\n    return nextWeek.toISOString();\n  }\n\n  if (lowerText === \"next month\") {\n    const nextMonth = new Date(today);\n    nextMonth.setMonth(nextMonth.getMonth() + 1);\n    return nextMonth.toISOString();\n  }\n\n  // \"in X days\"\n  const inDaysMatch = lowerText.match(/in\\s+(\\d+)\\s+days?/);\n  if (inDaysMatch) {\n    const days = parseInt(inDaysMatch[1], 10);\n    const futureDate = new Date(today);\n    futureDate.setDate(futureDate.getDate() + days);\n    return futureDate.toISOString();\n  }\n\n  // \"X days from now\"\n  const daysFromNowMatch = lowerText.match(/(\\d+)\\s+days?\\s+from\\s+now/);\n  if (daysFromNowMatch) {\n    const days = parseInt(daysFromNowMatch[1], 10);\n    const futureDate = new Date(today);\n    futureDate.setDate(futureDate.getDate() + days);\n    return futureDate.toISOString();\n  }\n\n  // Time patterns: \"3pm\", \"3:30pm\", \"15:30\", \"14:30\"\n  const timePatterns = [\n    /(\\d{1,2}):?(\\d{2})?\\s*(am|pm)?/i,\n    /(\\d{1,2})\\s*(am|pm)/i,\n  ];\n\n  for (const pattern of timePatterns) {\n    const match = lowerText.match(pattern);\n    if (match) {\n      let hours = parseInt(match[1], 10);\n      const minutes = match[2] ? parseInt(match[2], 10) : 0;\n      const ampm = match[3]?.toLowerCase();\n\n      if (ampm === \"pm\" && hours !== 12) {\n        hours += 12;\n      } else if (ampm === \"am\" && hours === 12) {\n        hours = 0;\n      }\n\n      const dateWithTime = new Date(today);\n      dateWithTime.setHours(hours, minutes, 0, 0);\n      return dateWithTime.toISOString();\n    }\n  }\n\n  // \"today at 3pm\" or \"tomorrow at 2:30\"\n  const todayAtMatch = lowerText.match(/today\\s+at\\s+(\\d{1,2}):?(\\d{2})?\\s*(am|pm)?/i);\n  if (todayAtMatch) {\n    let hours = parseInt(todayAtMatch[1], 10);\n    const minutes = todayAtMatch[2] ? parseInt(todayAtMatch[2], 10) : 0;\n    const ampm = todayAtMatch[3]?.toLowerCase();\n\n    if (ampm === \"pm\" && hours !== 12) {\n      hours += 12;\n    } else if (ampm === \"am\" && hours === 12) {\n      hours = 0;\n    }\n\n    const dateWithTime = new Date(today);\n    dateWithTime.setHours(hours, minutes, 0, 0);\n    return dateWithTime.toISOString();\n  }\n\n  const tomorrowAtMatch = lowerText.match(/tomorrow\\s+at\\s+(\\d{1,2}):?(\\d{2})?\\s*(am|pm)?/i);\n  if (tomorrowAtMatch) {\n    let hours = parseInt(tomorrowAtMatch[1], 10);\n    const minutes = tomorrowAtMatch[2] ? parseInt(tomorrowAtMatch[2], 10) : 0;\n    const ampm = tomorrowAtMatch[3]?.toLowerCase();\n\n    if (ampm === \"pm\" && hours !== 12) {\n      hours += 12;\n    } else if (ampm === \"am\" && hours === 12) {\n      hours = 0;\n    }\n\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    tomorrow.setHours(hours, minutes, 0, 0);\n    return tomorrow.toISOString();\n  }\n\n  // Date formats: \"12/25\", \"12/25/2024\", \"Dec 25\", \"December 25\"\n  const dateFormats = [\n    /(\\d{1,2})\\/(\\d{1,2})(?:\\/(\\d{4}))?/,\n    /(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\\s+(\\d{1,2})(?:\\s+(\\d{4}))?/i,\n  ];\n\n  for (const pattern of dateFormats) {\n    const match = lowerText.match(pattern);\n    if (match) {\n      let month: number, day: number, year: number;\n\n      if (pattern === dateFormats[0]) {\n        // MM/DD or MM/DD/YYYY\n        month = parseInt(match[1], 10);\n        day = parseInt(match[2], 10);\n        year = match[3] ? parseInt(match[3], 10) : now.getFullYear();\n      } else {\n        // \"Dec 25\" or \"December 25\"\n        const monthNames = [\n          \"jan\", \"feb\", \"mar\", \"apr\", \"may\", \"jun\",\n          \"jul\", \"aug\", \"sep\", \"oct\", \"nov\", \"dec\",\n        ];\n        month = monthNames.indexOf(match[1].toLowerCase().substring(0, 3)) + 1;\n        day = parseInt(match[2], 10);\n        year = match[3] ? parseInt(match[3], 10) : now.getFullYear();\n      }\n\n      if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {\n        const parsedDate = new Date(year, month - 1, day);\n        if (parsedDate.getFullYear() === year && parsedDate.getMonth() === month - 1 && parsedDate.getDate() === day) {\n          return crmStartOfDay(parsedDate)?.toISOString() || null;\n        }\n      }\n    }\n  }\n\n  // ISO date format: \"2024-12-25\"\n  const isoDateMatch = lowerText.match(/(\\d{4}-\\d{2}-\\d{2})/);\n  if (isoDateMatch) {\n    const isoDate = crmDateStringToISO(isoDateMatch[1]);\n    if (isoDate) return isoDate;\n  }\n\n  // ISO datetime format: \"2024-12-25T15:30\"\n  const isoDateTimeMatch = lowerText.match(/(\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2})/);\n  if (isoDateTimeMatch) {\n    const isoDateTime = crmDateTimeStringToISO(isoDateTimeMatch[1]);\n    if (isoDateTime) return isoDateTime;\n  }\n\n  return null;\n}\n\n/**\n * Extracts @mentions from text\n * Returns an array of user IDs that were mentioned\n */\nexport function extractMentions(text: string): string[] {\n  if (!text || typeof text !== \"string\") return [];\n\n  // Match @username patterns\n  // Format: @username or @user name (first name and optionally last name)\n  // Stop at the next space or end of string to prevent matching text after the mention\n  const mentionRegex = /@(\\w+(?:\\s+\\w+)?)(?=\\s|$)/g;\n  const mentions: string[] = [];\n  let match;\n\n  while ((match = mentionRegex.exec(text)) !== null) {\n    const mentionText = match[1].trim();\n    if (mentionText && !mentions.includes(mentionText)) {\n      mentions.push(mentionText);\n    }\n  }\n\n  return mentions;\n}\n\n/**\n * Finds the position of the current @mention being typed\n * Returns the start position and the query text after @\n */\nexport function findCurrentMention(text: string, cursorPosition: number): { start: number; query: string } | null {\n  if (!text || cursorPosition < 0) return null;\n\n  // Find the @ symbol before the cursor\n  let start = cursorPosition - 1;\n  while (start >= 0 && text[start] !== \"@\" && text[start] !== \" \" && text[start] !== \"\\n\") {\n    start--;\n  }\n\n  if (start < 0 || text[start] !== \"@\") {\n    return null;\n  }\n\n  // Find the end of the mention (whitespace or end of string)\n  let end = start + 1;\n  while (end < text.length && text[end] !== \" \" && text[end] !== \"\\n\" && text[end] !== \"@\") {\n    end++;\n  }\n\n  const query = text.substring(start + 1, end).trim();\n  return { start, query };\n}\n\n/**\n * Finds date patterns in text that should be auto-extracted\n * Returns the matched text and parsed date, or null if no match\n * These patterns will be removed from text and used to set due_date\n */\nexport function findAutoExtractDatePattern(text: string): { matchedText: string; date: string } | null {\n  if (!text || typeof text !== \"string\") return null;\n\n  const trimmedText = text.trim();\n  const lowerText = trimmedText.toLowerCase();\n  \n  // Patterns that should be auto-extracted (removed from description)\n  // These are checked in order of specificity (longer patterns first)\n  const autoExtractPatterns = [\n    /^(day\\s+after\\s+tomorrow|day\\s+after\\s+tmrw)$/i,\n    /^(next\\s+week|next\\s+month)$/i,\n    /^(in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)$/i,\n    /^(today|tomorrow)$/i,\n  ];\n\n  for (const pattern of autoExtractPatterns) {\n    const match = trimmedText.match(pattern);\n    if (match) {\n      const matchedText = match[0];\n      const parsedDate = parseDateFromText(matchedText);\n      if (parsedDate) {\n        return {\n          matchedText: matchedText,\n          date: parsedDate,\n        };\n      }\n    }\n  }\n\n  return null;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/isLinkedInUrl.ts",
      "content": "const LINKEDIN_URL_REGEX = /^http(?:s)?:\\/\\/(?:www\\.)?linkedin.com\\//;\n\nexport const isLinkedinUrl = (url: string) => {\n  if (!url) return;\n  try {\n    // Parse the URL to ensure it is valid\n    const parsedUrl = new URL(url);\n    if (!parsedUrl.href.match(LINKEDIN_URL_REGEX)) {\n      return \"URL must be from linkedin.com\";\n    }\n  } catch {\n    // If URL parsing fails, return false\n    return \"Must be a valid URL\";\n  }\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/fetchWithTimeout.ts",
      "content": "type FetchParams = Parameters<typeof fetch>;\n\nexport async function fetchWithTimeout(\n  resource: string,\n  options: FetchParams[1] & { timeout?: number } = {},\n) {\n  const { timeout = 2000 } = options;\n\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort(), timeout);\n\n  const response = await fetch(resource, {\n    ...options,\n    signal: controller.signal,\n  });\n  clearTimeout(id);\n\n  return response;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/Status.tsx",
      "content": "import { cn } from \"@/lib/utils\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const Status = ({\n  status,\n  className,\n}: {\n  status: string;\n  className?: string;\n}) => {\n  const { noteStatuses } = useConfigurationContext();\n  if (!status || !noteStatuses) return null;\n  const statusObject = noteStatuses.find((s: any) => s.value === status);\n\n  if (!statusObject) return null;\n  return (\n    <div className={cn(\"group relative inline-block mr-2\", className)}>\n      <span\n        className=\"inline-block w-2.5 h-2.5 rounded-full\"\n        style={{ backgroundColor: statusObject.color }}\n      />\n      <div className=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-gray-800 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10\">\n        {statusObject.label}\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/SmartTextInput.tsx",
      "content": "import * as React from \"react\";\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { useGetList } from \"ra-core\";\nimport { Calendar, User } from \"lucide-react\";\n\nimport { cn } from \"@/lib/utils\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\n\nimport {\n  extractMentions,\n  findCurrentMention,\n  parseDateFromText,\n} from \"./textParsing\";\nimport { crmDateInputString } from \"./timezone\";\nimport type { Sale } from \"../types\";\n\nexport type SmartTextInputProps = {\n  value: string;\n  onChange: (value: string) => void;\n  multiline?: boolean;\n  placeholder?: string;\n  className?: string;\n  inputClassName?: string;\n  rows?: number;\n  onDateDetected?: (date: string) => void;\n  onUsersTagged?: (userIds: number[]) => void;\n} & React.ComponentProps<\"textarea\"> &\n  React.ComponentProps<\"input\">;\n\n/**\n * SmartTextInput\n * - @mention autocomplete (tagging)\n * - date detection + optional insert date suggestion\n *\n * IMPORTANT: This component intentionally uses a plain, controlled input/textarea\n * (no overlay rendering / no caret hacks) to keep cursor behavior stable.\n */\nexport const SmartTextInput = React.forwardRef<\n  HTMLTextAreaElement | HTMLInputElement,\n  SmartTextInputProps\n>((props, ref) => {\n  const {\n    value = \"\",\n    onChange,\n    multiline = false,\n    placeholder,\n    className,\n    inputClassName,\n    rows,\n    onDateDetected,\n    onUsersTagged,\n    ...rest\n  } = props;\n\n  const [cursorPosition, setCursorPosition] = useState(0);\n  const [showSuggestions, setShowSuggestions] = useState(false);\n  const [suggestionType, setSuggestionType] = useState<\"date\" | \"mention\" | null>(null);\n  const [suggestionQuery, setSuggestionQuery] = useState(\"\");\n  const [selectedIndex, setSelectedIndex] = useState(0);\n\n  const inputRef = useRef<HTMLTextAreaElement | HTMLInputElement | null>(null);\n\n  const setRefs = useCallback(\n    (node: HTMLTextAreaElement | HTMLInputElement | null) => {\n      inputRef.current = node;\n      if (typeof ref === \"function\") {\n        ref(node);\n      } else if (ref) {\n        (ref as React.MutableRefObject<\n          HTMLTextAreaElement | HTMLInputElement | null\n        >).current = node;\n      }\n    },\n    [ref],\n  );\n\n  // Users list for mention autocomplete\n  const { data: salesData, isLoading: isLoadingSales, error: salesError } =\n    useGetList<Sale>(\"sales\", {\n      pagination: { page: 1, perPage: 100 },\n      sort: { field: \"last_name\", order: \"ASC\" },\n    });\n\n  const sales = useMemo(() => {\n    const all = salesData || [];\n    return all.filter((s) => !s.disabled);\n  }, [salesData]);\n\n  const filteredSales = useMemo(() => {\n    if (suggestionType !== \"mention\") return [];\n    const q = suggestionQuery.trim().toLowerCase();\n    if (!q) return sales;\n    return sales.filter((sale) => {\n      const full = `${sale.first_name || \"\"} ${sale.last_name || \"\"}`.trim();\n      return (\n        sale.first_name?.toLowerCase().includes(q) ||\n        sale.last_name?.toLowerCase().includes(q) ||\n        full.toLowerCase().includes(q) ||\n        sale.email?.toLowerCase().includes(q)\n      );\n    });\n  }, [sales, suggestionQuery, suggestionType]);\n\n  useEffect(() => {\n    if (suggestionType === \"mention\" && filteredSales.length > 0) {\n      setSelectedIndex((prev) => Math.min(prev, filteredSales.length - 1));\n    }\n  }, [filteredSales.length, suggestionType]);\n\n  const updateCursorFromElement = useCallback(() => {\n    const el = inputRef.current;\n    if (!el) return;\n    const pos = (el as HTMLTextAreaElement | HTMLInputElement).selectionStart ?? 0;\n    setCursorPosition(pos);\n  }, []);\n\n  const findMostRecentDatePattern = useCallback(\n    (text: string, cursorPos: number): { matchedText: string; date: string } | null => {\n      if (!text || !text.trim()) return null;\n\n      const datePatterns = [\n        {\n          pattern: /\\b(day\\s+after\\s+tomorrow|day\\s+after\\s+tmrw)\\b/gi,\n          parse: (match: string) => parseDateFromText(match),\n        },\n        {\n          pattern: /\\b(next\\s+week|next\\s+month)\\b/gi,\n          parse: (match: string) => parseDateFromText(match),\n        },\n        {\n          pattern: /\\b(in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)\\b/gi,\n          parse: (match: string) => parseDateFromText(match),\n        },\n        {\n          pattern: /\\b(today|tomorrow)\\b/gi,\n          parse: (match: string) => parseDateFromText(match),\n        },\n      ];\n\n      const textBeforeCursor = text.substring(0, cursorPos);\n\n      let closest: { matchedText: string; date: string; endPos: number } | null =\n        null;\n\n      for (const { pattern, parse } of datePatterns) {\n        const matches = Array.from(textBeforeCursor.matchAll(pattern));\n        for (const match of matches) {\n          const start = match.index!;\n          const end = start + match[0].length;\n          const matchedText = match[0];\n\n          const charAfter = textBeforeCursor[end];\n          const isAtWordBoundary = !charAfter || /[\\s\\n.,!?;:]/.test(charAfter);\n          if (!isAtWordBoundary) continue;\n\n          const parsedDate = parse(matchedText);\n          if (!parsedDate) continue;\n\n          if (!closest || end > closest.endPos) {\n            closest = { matchedText, date: parsedDate, endPos: end };\n          }\n        }\n      }\n\n      return closest ? { matchedText: closest.matchedText, date: closest.date } : null;\n    },\n    [],\n  );\n\n  // Debounced date detection (doesn't change the text, only notifies)\n  useEffect(() => {\n    if (!onDateDetected) return;\n    if (!value || !value.trim()) return;\n\n    const timeout = setTimeout(() => {\n      const datePattern = findMostRecentDatePattern(value, cursorPosition);\n      if (datePattern) onDateDetected(datePattern.date);\n    }, 120);\n\n    return () => clearTimeout(timeout);\n  }, [cursorPosition, findMostRecentDatePattern, onDateDetected, value]);\n\n  // Suggestions: mentions or date\n  useEffect(() => {\n    if (!value) {\n      setShowSuggestions(false);\n      setSuggestionType(null);\n      setSelectedIndex(0);\n      return;\n    }\n\n    // Mention suggestion\n    const mentionInfo = findCurrentMention(value, cursorPosition);\n    if (mentionInfo) {\n      setSuggestionType(\"mention\");\n      setSuggestionQuery(mentionInfo.query);\n      setShowSuggestions(true);\n      setSelectedIndex(0);\n      return;\n    }\n\n    // Date suggestion near cursor\n    const textBeforeCursor = value.substring(\n      Math.max(0, cursorPosition - 30),\n      cursorPosition,\n    );\n    const trimmedText = textBeforeCursor.trim();\n\n    const datePatterns = [\n      /(today|tomorrow|day\\s+after\\s+tomorrow|day\\s+after\\s+tmrw|next\\s+week|next\\s+month|in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)$/i,\n      /(today|tomorrow)\\s+at\\s+\\d{1,2}:?(\\d{2})?\\s*(am|pm)?$/i,\n      /\\d{1,2}\\/\\d{1,2}(\\/\\d{4})?$/,\n      /\\d{4}-\\d{2}-\\d{2}$/,\n      /(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\\s+\\d{1,2}(\\s+\\d{4})?$/i,\n      /\\d{1,2}:?\\d{2}?\\s*(am|pm)?$/i,\n    ];\n\n    const hasDatePattern = datePatterns.some((p) => p.test(trimmedText));\n    if (hasDatePattern) {\n      const parsed = parseDateFromText(trimmedText);\n      if (parsed) {\n        setSuggestionType(\"date\");\n        setSuggestionQuery(trimmedText);\n        setShowSuggestions(true);\n        setSelectedIndex(0);\n        return;\n      }\n    }\n\n    setShowSuggestions(false);\n    setSuggestionType(null);\n    setSelectedIndex(0);\n  }, [cursorPosition, value]);\n\n  const emitTaggedUsers = useCallback(\n    (text: string) => {\n      if (!onUsersTagged) return;\n      const taggedUsers = extractMentions(text)\n        .map((mention) => {\n          const matchedSale = sales.find(\n            (s) =>\n              `${s.first_name} ${s.last_name}`.toLowerCase() ===\n                mention.toLowerCase() ||\n              s.first_name?.toLowerCase() === mention.toLowerCase() ||\n              s.last_name?.toLowerCase() === mention.toLowerCase(),\n          );\n          return matchedSale?.id;\n        })\n        .filter((id): id is number => id !== undefined);\n\n      onUsersTagged(taggedUsers);\n    },\n    [onUsersTagged, sales],\n  );\n\n  const handleInputChange = useCallback(\n    (e: React.ChangeEvent<HTMLTextAreaElement | HTMLInputElement>) => {\n      const next = e.target.value;\n      const nextCursor = e.target.selectionStart ?? 0;\n\n      setCursorPosition(nextCursor);\n      onChange(next);\n      emitTaggedUsers(next);\n\n      // If the parent re-renders and selection is lost, we restore it next frame.\n      // This is minimal and only uses the browsers current cursor position.\n      requestAnimationFrame(() => {\n        const el = inputRef.current;\n        if (!el) return;\n        if (document.activeElement !== el) return;\n        try {\n          (el as HTMLTextAreaElement | HTMLInputElement).setSelectionRange(\n            nextCursor,\n            nextCursor,\n          );\n        } catch {\n          // ignore\n        }\n      });\n    },\n    [emitTaggedUsers, onChange],\n  );\n\n  const insertMention = useCallback(\n    (sale: Sale) => {\n      const mentionInfo = findCurrentMention(value, cursorPosition);\n      if (!mentionInfo) return;\n\n      const mentionText = `@${sale.first_name} ${sale.last_name}`;\n      const before = value.substring(0, mentionInfo.start);\n      const after = value.substring(cursorPosition);\n      const next = `${before}${mentionText} ${after}`;\n      const nextCursor = before.length + mentionText.length + 1;\n\n      onChange(next);\n      emitTaggedUsers(next);\n      setShowSuggestions(false);\n      setSelectedIndex(0);\n      setCursorPosition(nextCursor);\n\n      requestAnimationFrame(() => {\n        const el = inputRef.current;\n        if (!el) return;\n        (el as HTMLTextAreaElement | HTMLInputElement).focus();\n        try {\n          (el as HTMLTextAreaElement | HTMLInputElement).setSelectionRange(\n            nextCursor,\n            nextCursor,\n          );\n        } catch {\n          // ignore\n        }\n      });\n    },\n    [cursorPosition, emitTaggedUsers, onChange, value],\n  );\n\n  const insertDateSuggestion = useCallback(() => {\n    if (!suggestionQuery) return;\n\n    const parsedDate = parseDateFromText(suggestionQuery);\n    if (!parsedDate) return;\n\n    const dateStr = crmDateInputString(new Date(parsedDate));\n\n    const textBeforeCursor = value.substring(\n      Math.max(0, cursorPosition - 30),\n      cursorPosition,\n    );\n    const trimmedBefore = textBeforeCursor.trim();\n\n    const datePatterns = [\n      /^(today|tomorrow|next\\s+week|in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)$/i,\n      /^(today|tomorrow)\\s+at\\s+\\d{1,2}:?(\\d{2})?\\s*(am|pm)?$/i,\n      /^\\d{1,2}\\/\\d{1,2}(\\/\\d{4})?$/,\n      /^\\d{4}-\\d{2}-\\d{2}$/,\n      /^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\\s+\\d{1,2}(\\s+\\d{4})?$/i,\n      /^\\d{1,2}:?\\d{2}?\\s*(am|pm)?$/i,\n    ];\n\n    // Replace either the full trimmed chunk (if it matches) or the last word\n    const matchesPattern = datePatterns.some((p) => p.test(trimmedBefore));\n\n    let replaceStart = cursorPosition;\n    if (matchesPattern && trimmedBefore.length > 0) {\n      replaceStart = Math.max(0, cursorPosition - trimmedBefore.length);\n    } else {\n      const words = trimmedBefore.split(/\\s+/);\n      const lastWord = words[words.length - 1] || \"\";\n      replaceStart = Math.max(0, cursorPosition - lastWord.length);\n    }\n\n    const before = value.substring(0, replaceStart);\n    const after = value.substring(cursorPosition);\n    const next = `${before}${dateStr} ${after}`;\n    const nextCursor = before.length + dateStr.length + 1;\n\n    onChange(next);\n    setShowSuggestions(false);\n    setCursorPosition(nextCursor);\n    onDateDetected?.(parsedDate);\n\n    requestAnimationFrame(() => {\n      const el = inputRef.current;\n      if (!el) return;\n      (el as HTMLTextAreaElement | HTMLInputElement).focus();\n      try {\n        (el as HTMLTextAreaElement | HTMLInputElement).setSelectionRange(\n          nextCursor,\n          nextCursor,\n        );\n      } catch {\n        // ignore\n      }\n    });\n  }, [cursorPosition, onChange, onDateDetected, suggestionQuery, value]);\n\n  const handleKeyDown = useCallback(\n    (e: React.KeyboardEvent<HTMLTextAreaElement | HTMLInputElement>) => {\n      if (!showSuggestions) return;\n\n      if (suggestionType === \"mention\") {\n        if (e.key === \"ArrowDown\") {\n          e.preventDefault();\n          setSelectedIndex((prev) =>\n            Math.min(prev + 1, Math.max(0, filteredSales.length - 1)),\n          );\n          return;\n        }\n\n        if (e.key === \"ArrowUp\") {\n          e.preventDefault();\n          setSelectedIndex((prev) => Math.max(prev - 1, 0));\n          return;\n        }\n\n        if (e.key === \"Enter\") {\n          e.preventDefault();\n          const sale = filteredSales[selectedIndex];\n          if (sale) insertMention(sale);\n          return;\n        }\n\n        if (e.key === \"Escape\") {\n          e.preventDefault();\n          setShowSuggestions(false);\n          setSelectedIndex(0);\n          return;\n        }\n      }\n\n      if (suggestionType === \"date\" && e.key === \"Enter\") {\n        e.preventDefault();\n        insertDateSuggestion();\n      }\n    },\n    [\n      filteredSales,\n      insertDateSuggestion,\n      insertMention,\n      selectedIndex,\n      showSuggestions,\n      suggestionType,\n    ],\n  );\n\n  const handleSelect = useCallback(() => {\n    updateCursorFromElement();\n  }, [updateCursorFromElement]);\n\n  const handleBlur = useCallback(\n    (e: React.FocusEvent<HTMLTextAreaElement | HTMLInputElement>) => {\n      // One last date detect on blur\n      if (onDateDetected && value) {\n        const pos = e.target.selectionStart ?? value.length;\n        const datePattern = findMostRecentDatePattern(value, pos);\n        if (datePattern) onDateDetected(datePattern.date);\n      }\n\n      if (rest.onBlur) {\n        rest.onBlur(e as any);\n      }\n    },\n    [findMostRecentDatePattern, onDateDetected, rest, value],\n  );\n\n  const InputComponent = multiline ? Textarea : Input;\n\n  return (\n    <div className={cn(\"relative\", className)}>\n      <InputComponent\n        {...(rest as any)}\n        ref={setRefs as any}\n        value={value}\n        onChange={handleInputChange}\n        onKeyDown={handleKeyDown}\n        onSelect={handleSelect as any}\n        onKeyUp={handleSelect as any}\n        onClick={handleSelect as any}\n        onBlur={handleBlur as any}\n        placeholder={placeholder}\n        className={cn(inputClassName, multiline && \"px-3 py-2\")}\n        rows={multiline ? rows : undefined}\n      />\n\n      {showSuggestions && (\n        <div className=\"absolute top-full z-20 w-full mt-1 rounded-md border bg-popover text-popover-foreground shadow-md\">\n          {suggestionType === \"mention\" && (\n            <Command>\n              <CommandList>\n                {isLoadingSales ? (\n                  <CommandEmpty>Loading users...</CommandEmpty>\n                ) : filteredSales.length > 0 ? (\n                  <CommandGroup>\n                    {filteredSales.map((sale, index) => (\n                      <CommandItem\n                        key={sale.id}\n                        onSelect={() => insertMention(sale)}\n                        data-selected={index === selectedIndex}\n                        className={cn(\n                          \"cursor-pointer\",\n                          index === selectedIndex &&\n                            \"bg-accent text-accent-foreground\",\n                        )}\n                      >\n                        <User className=\"mr-2 h-4 w-4\" />\n                        <span>\n                          {sale.first_name} {sale.last_name}\n                        </span>\n                        {sale.email && (\n                          <span className=\"ml-2 text-xs text-muted-foreground\">\n                            {sale.email}\n                          </span>\n                        )}\n                      </CommandItem>\n                    ))}\n                  </CommandGroup>\n                ) : sales.length === 0 ? (\n                  <CommandEmpty>\n                    {salesError ? \"Error loading users\" : \"No users available\"}\n                  </CommandEmpty>\n                ) : (\n                  <CommandEmpty>\n                    No users found matching &quot;{suggestionQuery}&quot;\n                  </CommandEmpty>\n                )}\n              </CommandList>\n            </Command>\n          )}\n\n          {suggestionType === \"date\" && (\n            <Command>\n              <CommandList>\n                <CommandGroup>\n                  <CommandItem onSelect={insertDateSuggestion} className=\"cursor-pointer\">\n                    <Calendar className=\"mr-2 h-4 w-4\" />\n                    <span>\n                      Add date:{\" \"}\n                      {crmDateInputString(\n                        new Date(parseDateFromText(suggestionQuery) || new Date()),\n                      )}\n                    </span>\n                  </CommandItem>\n                </CommandGroup>\n              </CommandList>\n            </Command>\n          )}\n        </div>\n      )}\n    </div>\n  );\n});\n\nSmartTextInput.displayName = \"SmartTextInput\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/RelativeDate.tsx",
      "content": "import { getCrmTimeZoneLabel, formatCrmDateTime } from \"./timezone\";\n\ntype Mode = \"utc+4\" | \"local\";\n\n// Always render using the enforced CRM timezone.\n// The `mode` prop is kept for backward compatibility but ignored.\nexport function RelativeDate({\n  date,\n}: {\n  date: string;\n  mode?: Mode;\n}) {\n  const formatted = formatCrmDateTime(date);\n  if (!formatted) return null;\n  return <span title={getCrmTimeZoneLabel()}>{formatted}</span>;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/ImageEditorField.tsx",
      "content": "import { useFieldValue } from \"ra-core\";\nimport { createRef, useCallback, useState } from \"react\";\nimport type { ReactCropperElement } from \"react-cropper\";\nimport { Cropper } from \"react-cropper\";\nimport { useDropzone } from \"react-dropzone\";\nimport { useFormContext } from \"react-hook-form\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\nimport \"cropperjs/dist/cropper.css\";\n\nconst ImageEditorField = (props: ImageEditorFieldProps) => {\n  const { getValues } = useFormContext();\n  const source = getValues(props.source);\n  const imageUrl = source?.src;\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n\n  const { type = \"image\", emptyText, linkPosition = \"none\" } = props;\n\n  const commonProps = {\n    src: imageUrl,\n    onClick: () => setIsDialogOpen(true),\n    style: { cursor: \"pointer\" },\n    className: `${props.className || \"\"}`,\n  };\n\n  const width = props.width || (type === \"avatar\" ? 50 : 200);\n  const height = props.height || (type === \"avatar\" ? 50 : 200);\n\n  return (\n    <>\n      <div\n        className={`flex ${\n          linkPosition === \"right\" ? \"flex-row\" : \"flex-col\"\n        } items-center ${\n          linkPosition === \"right\" ? \"gap-2\" : \"gap-1\"\n        } rounded p-${props.backgroundImageColor ? \"4\" : \"0\"}`}\n        style={{\n          backgroundColor: props.backgroundImageColor || \"transparent\",\n        }}\n      >\n        {props.type === \"avatar\" ? (\n          <Avatar\n            {...commonProps}\n            className={`cursor-pointer`}\n            style={{ width, height }}\n          >\n            <AvatarImage src={imageUrl} />\n            <AvatarFallback>{emptyText}</AvatarFallback>\n          </Avatar>\n        ) : (\n          <img\n            {...commonProps}\n            className=\"cursor-pointer object-cover\"\n            style={{ width, height }}\n            alt=\"Editable content\"\n          />\n        )}\n        {linkPosition !== \"none\" && (\n          <button\n            type=\"button\"\n            onClick={() => setIsDialogOpen(true)}\n            className=\"text-xs underline hover:no-underline cursor-pointer text-center\"\n          >\n            Change\n          </button>\n        )}\n      </div>\n      <ImageEditorDialog\n        open={isDialogOpen}\n        onClose={() => setIsDialogOpen(false)}\n        {...props}\n      />\n    </>\n  );\n};\n\nconst ImageEditorDialog = (props: ImageEditorDialogProps) => {\n  const { setValue, handleSubmit } = useFormContext();\n  const cropperRef = createRef<ReactCropperElement>();\n  const initialValue = useFieldValue({ source: props.source });\n  const [file, setFile] = useState<File | undefined>();\n  const [imageSrc, setImageSrc] = useState<string | undefined>(\n    initialValue?.src,\n  );\n  const onDrop = useCallback((files: File[]) => {\n    const preview = URL.createObjectURL(files[0]);\n    setFile(files[0]);\n    setImageSrc(preview);\n  }, []);\n\n  const updateImage = () => {\n    const cropper = cropperRef.current?.cropper;\n    const croppedImage = cropper?.getCroppedCanvas().toDataURL();\n    if (croppedImage) {\n      setImageSrc(croppedImage);\n\n      const newFile = file ?? new File([], initialValue?.src);\n      setValue(\n        props.source,\n        {\n          src: croppedImage,\n          title: newFile.name,\n          rawFile: newFile,\n        },\n        { shouldDirty: true },\n      );\n      props.onClose();\n\n      if (props.onSave) {\n        handleSubmit(props.onSave)();\n      }\n    }\n  };\n\n  const deleteImage = () => {\n    setValue(props.source, null, { shouldDirty: true });\n    if (props.onSave) {\n      handleSubmit(props.onSave)();\n    }\n    setImageSrc(undefined);\n    props.onClose();\n  };\n\n  const { getRootProps, getInputProps } = useDropzone({\n    accept: { \"image/jpeg\": [\".jpeg\", \".png\"] },\n    onDrop,\n    maxFiles: 1,\n  });\n\n  return (\n    <Dialog open={props.open} onOpenChange={props.onClose}>\n      {props.type === \"avatar\" && (\n        <style>\n          {`\n                        .cropper-crop-box,\n                        .cropper-view-box {\n                            border-radius: 50%;\n                        }\n                    `}\n        </style>\n      )}\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Upload and resize image</DialogTitle>\n          <DialogDescription className=\"sr-only\">\n            Upload an image file and crop it to the desired size.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"flex flex-col gap-2 justify-center\">\n          <div\n            className=\"flex flex-row justify-center bg-gray-50 cursor-pointer p-4 border-2 border-dashed border-gray-300 rounded-lg hover:bg-gray-100 transition-colors\"\n            {...getRootProps()}\n          >\n            <input {...getInputProps()} />\n            <p className=\"text-gray-600\">\n              Drop a file to upload, or click to select it.\n            </p>\n          </div>\n\n          {imageSrc && (\n            <Cropper\n              ref={cropperRef}\n              src={imageSrc}\n              aspectRatio={1}\n              guides={false}\n              cropBoxResizable={false}\n            />\n          )}\n        </div>\n\n        <DialogFooter className=\"flex justify-between w-full\">\n          <Button type=\"button\" onClick={updateImage}>\n            Update Image\n          </Button>\n          <Button type=\"button\" variant=\"destructive\" onClick={deleteImage}>\n            Delete\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default ImageEditorField;\n\nexport interface ImageEditorFieldProps {\n  source: string;\n  width?: number;\n  height?: number;\n  type?: \"avatar\" | \"image\";\n  onSave?: any;\n  linkPosition?: \"right\" | \"bottom\" | \"none\";\n  backgroundImageColor?: string;\n  className?: string;\n  emptyText?: string;\n}\n\nexport interface ImageEditorDialogProps extends ImageEditorFieldProps {\n  open: boolean;\n  onClose: () => void;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/ContactOption.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\n\nimport type { Contact } from \"../types\";\n\n// eslint-disable-next-line react-refresh/only-export-components\nconst ContactOptionRender = () => {\n  const record: Contact | undefined = useRecordContext();\n  if (!record) return null;\n  return (\n    <div className=\"flex flex-row gap-4 items-center justify-start\">\n      <div className=\"flex flex-col items-start gap-1\">\n        <span>\n          {record.first_name} {record.last_name}\n        </span>\n        <span className=\"text-xs text-muted-foreground\">\n          {record.title}\n          {record.title && record.company_name && \" at \"}\n          {record.company_name}\n        </span>\n      </div>\n    </div>\n  );\n};\nexport const contactOptionText = <ContactOptionRender />;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/AsideSection.tsx",
      "content": "import type { ReactNode } from \"react\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { cn } from \"@/lib/utils\";\n\nexport type AsideSectionProps = {\n  title: string;\n  children?: ReactNode;\n  noGap?: boolean;\n};\n\nexport function AsideSection({ title, children, noGap }: AsideSectionProps) {\n  return (\n    <div className=\"mb-6 text-sm\">\n      <h3 className=\"font-medium pb-1\">{title}</h3>\n      <Separator />\n      <div className={cn(\"pt-2 flex flex-col\", { \"gap-1\": !noGap })}>\n        {children}\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/login/StartPage.tsx",
      "content": "import { useQuery } from \"@tanstack/react-query\";\nimport { useDataProvider } from \"ra-core\";\nimport { Navigate } from \"react-router-dom\";\nimport { LoginPage } from \"@/components/admin/login-page\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport { LoginSkeleton } from \"./LoginSkeleton\";\n\nexport const StartPage = () => {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const {\n    data: isInitialized,\n    error,\n    isPending,\n  } = useQuery({\n    queryKey: [\"init\"],\n    queryFn: async () => {\n      return dataProvider.isInitialized();\n    },\n  });\n\n  if (isPending) return <LoginSkeleton />;\n  if (error) return <LoginPage />;\n  if (isInitialized) return <LoginPage />;\n\n  return <Navigate to=\"/sign-up\" />;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/login/SignupPage.tsx",
      "content": "import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Loader2 } from \"lucide-react\";\nimport { useDataProvider, useLogin, useNotify } from \"ra-core\";\nimport { useForm, type SubmitHandler } from \"react-hook-form\";\nimport { Navigate } from \"react-router\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { SignUpData } from \"../types\";\nimport { LoginSkeleton } from \"./LoginSkeleton\";\n\nexport const SignupPage = () => {\n  const queryClient = useQueryClient();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const { darkModeLogo: logo, title } = useConfigurationContext();\n  const { data: isInitialized, isPending } = useQuery({\n    queryKey: [\"init\"],\n    queryFn: async () => {\n      return dataProvider.isInitialized();\n    },\n  });\n\n  const { isPending: isSignUpPending, mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SignUpData) => {\n      return dataProvider.signUp(data);\n    },\n    onSuccess: (data) => {\n      login({\n        email: data.email,\n        password: data.password,\n        redirectTo: \"/contacts\",\n      }).then(() => {\n        notify(\"Initial user successfully created\");\n        // FIXME: We should probably provide a hook for that in the ra-core package\n        queryClient.invalidateQueries({\n          queryKey: [\"auth\", \"canAccess\"],\n        });\n      });\n    },\n    onError: () => {\n      notify(\"An error occurred. Please try again.\");\n    },\n  });\n\n  const login = useLogin();\n  const notify = useNotify();\n\n  const {\n    register,\n    handleSubmit,\n    formState: { isValid },\n  } = useForm<SignUpData>({\n    mode: \"onChange\",\n  });\n\n  if (isPending) {\n    return <LoginSkeleton />;\n  }\n\n  // For the moment, we only allow one user to sign up. Other users must be created by the administrator.\n  if (isInitialized) {\n    return <Navigate to=\"/login\" />;\n  }\n\n  const onSubmit: SubmitHandler<SignUpData> = async (data) => {\n    mutate(data);\n  };\n\n  return (\n    <div className=\"h-screen p-8\">\n      <div className=\"flex items-center gap-4\">\n        <img\n          src={logo}\n          alt={title}\n          width={24}\n          className=\"filter brightness-0 invert\"\n        />\n        <h1 className=\"text-xl font-semibold\">{title}</h1>\n      </div>\n      <div className=\"h-full\">\n        <div className=\"max-w-sm mx-auto h-full flex flex-col justify-center gap-4\">\n          <h1 className=\"text-2xl font-bold mb-4\">Welcome to BestDOC CRM</h1>\n          <p className=\"text-base mb-4\">\n            Create the first user account to complete the setup.\n          </p>\n          <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"first_name\">First name</Label>\n              <Input\n                {...register(\"first_name\", { required: true })}\n                id=\"first_name\"\n                type=\"text\"\n                required\n              />\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"last_name\">Last name</Label>\n              <Input\n                {...register(\"last_name\", { required: true })}\n                id=\"last_name\"\n                type=\"text\"\n                required\n              />\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                {...register(\"email\", { required: true })}\n                id=\"email\"\n                type=\"email\"\n                required\n              />\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input\n                {...register(\"password\", { required: true })}\n                id=\"password\"\n                type=\"password\"\n                required\n              />\n            </div>\n            <div className=\"flex justify-between items-center mt-8\">\n              <Button\n                type=\"submit\"\n                disabled={!isValid || isSignUpPending}\n                className=\"w-full\"\n              >\n                {isSignUpPending ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n                    Creating...\n                  </>\n                ) : (\n                  \"Create account\"\n                )}\n              </Button>\n            </div>\n          </form>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nSignupPage.path = \"/sign-up\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/login/LoginSkeleton.tsx",
      "content": "import { Skeleton } from \"@/components/ui/skeleton\";\n\nexport const LoginSkeleton = () => {\n  return (\n    <div className=\"max-w-screen-xl mx-auto h-screen pt-8\">\n      <div className=\"h-full\">\n        <div className=\"max-w-sm mx-auto h-full flex flex-col justify-center gap-8\">\n          <Skeleton className=\"w-full h-[100px]\" />\n          <Skeleton className=\"w-4/5 h-[50px]\" />\n          <Skeleton className=\"w-full h-9\" />\n          <Skeleton className=\"w-full h-9\" />\n          <Skeleton className=\"w-full h-9\" />\n          <Skeleton className=\"w-2/5 h-9\" />\n        </div>\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/TopToolbar.tsx",
      "content": "import { cn } from \"@/lib/utils\";\nimport type { HTMLAttributes, ReactNode } from \"react\";\n\nexport interface TopToolbarProps extends HTMLAttributes<HTMLDivElement> {\n  children?: ReactNode;\n}\n\nexport const TopToolbar = (inProps: TopToolbarProps) => {\n  const { className, children, ...props } = inProps;\n\n  return (\n    <div\n      className={cn(\n        \"flex flex-auto items-end gap-2 whitespace-nowrap w-full\",\n        className,\n      )}\n      {...props}\n    >\n      {children}\n    </div>\n  );\n};\n\nexport default TopToolbar;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/NotificationsMenu.tsx",
      "content": "import { useMemo, useState, useEffect } from \"react\";\nimport { Link } from \"react-router\";\nimport { Bell, CheckSquare, FileText } from \"lucide-react\";\nimport { useGetIdentity, useGetList, useUpdate } from \"ra-core\";\nimport { useQueryClient } from \"@tanstack/react-query\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { cn } from \"@/lib/utils\";\n\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport type { ContactNote, DealNote, Task } from \"../types\";\n\ntype NotificationItem =\n  | {\n      kind: \"task\";\n      id: Task[\"id\"];\n      text: string;\n      date: string;\n      contactId: Task[\"contact_id\"];\n      done: boolean;\n      task: Task;\n      isNew: boolean;\n    }\n  | {\n      kind: \"contactNote\";\n      id: ContactNote[\"id\"];\n      text: string;\n      date: string;\n      contactId: ContactNote[\"contact_id\"];\n      isNew: boolean;\n    }\n  | {\n      kind: \"dealNote\";\n      id: DealNote[\"id\"];\n      text: string;\n      date: string;\n      dealId: DealNote[\"deal_id\"];\n      isNew: boolean;\n    };\n\nconst storageKey = (userId: number) => `crm.notifications.lastSeen.${userId}`;\n\nconst safeIso = (v: any) => {\n  if (!v) return null;\n  const d = new Date(v);\n  if (Number.isNaN(d.getTime())) return null;\n  return d.toISOString();\n};\n\nexport const NotificationsMenu = () => {\n  const queryClient = useQueryClient();\n  const { identity } = useGetIdentity();\n  const userId = Number.isInteger(identity?.id) ? (identity!.id as number) : null;\n\n  const [open, setOpen] = useState(false);\n  const [lastSeenIso, setLastSeenIso] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (!userId) return;\n    const stored = globalThis.localStorage?.getItem(storageKey(userId));\n    setLastSeenIso(stored || null);\n  }, [userId]);\n\n  const mentionsFilter = useMemo(() => {\n    if (!userId) return { \"id@in\": \"(-1)\" };\n    return { \"tagged_user_ids@cs\": `{${userId}}` };\n  }, [userId]);\n\n  const { data: tasks = [], isPending: isTasksPending } = useGetList<Task>(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 25 },\n      sort: { field: \"created_at\", order: \"DESC\" },\n      filter: mentionsFilter,\n    },\n    { enabled: !!userId },\n  );\n\n  const { data: contactNotes = [], isPending: isContactNotesPending } =\n    useGetList<ContactNote>(\n      \"contactNotes\",\n      {\n        pagination: { page: 1, perPage: 25 },\n        sort: { field: \"date\", order: \"DESC\" },\n        filter: mentionsFilter,\n      },\n      { enabled: !!userId },\n    );\n\n  const { data: dealNotes = [], isPending: isDealNotesPending } = useGetList<DealNote>(\n    \"dealNotes\",\n    {\n      pagination: { page: 1, perPage: 25 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: mentionsFilter,\n    },\n    { enabled: !!userId },\n  );\n\n  const lastSeenDate = useMemo(() => {\n    if (!lastSeenIso) return null;\n    const d = new Date(lastSeenIso);\n    return Number.isNaN(d.getTime()) ? null : d;\n  }, [lastSeenIso]);\n\n  const items: NotificationItem[] = useMemo(() => {\n    const since = lastSeenDate?.getTime() ?? null;\n\n    const mappedTasks: NotificationItem[] = tasks.map((t) => {\n      const date =\n        safeIso(t.created_at) ||\n        safeIso(t.due_date) ||\n        new Date().toISOString();\n      const isNew = since ? new Date(date).getTime() > since : false;\n      return {\n        kind: \"task\",\n        id: t.id,\n        text: t.text || \"Task\",\n        date,\n        contactId: t.contact_id,\n        done: !!t.done_date,\n        task: t,\n        isNew,\n      };\n    });\n\n    const mappedContactNotes: NotificationItem[] = contactNotes.map((n) => {\n      const date = safeIso(n.date) || new Date().toISOString();\n      const isNew = since ? new Date(date).getTime() > since : false;\n      return {\n        kind: \"contactNote\",\n        id: n.id,\n        text: n.text || \"Note\",\n        date,\n        contactId: n.contact_id,\n        isNew,\n      };\n    });\n\n    const mappedDealNotes: NotificationItem[] = dealNotes.map((n) => {\n      const date = safeIso(n.date) || new Date().toISOString();\n      const isNew = since ? new Date(date).getTime() > since : false;\n      return {\n        kind: \"dealNote\",\n        id: n.id,\n        text: n.text || \"Note\",\n        date,\n        dealId: n.deal_id,\n        isNew,\n      };\n    });\n\n    const merged = [...mappedTasks, ...mappedContactNotes, ...mappedDealNotes];\n    merged.sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());\n    return merged.slice(0, 40);\n  }, [contactNotes, dealNotes, lastSeenDate, tasks]);\n\n  const unreadCount = useMemo(\n    () => items.reduce((acc, it) => acc + (it.isNew ? 1 : 0), 0),\n    [items],\n  );\n\n  const [updateTask, { isPending: isUpdatingTask }] = useUpdate();\n\n  const markAllAsRead = () => {\n    if (!userId) return;\n    const now = new Date().toISOString();\n    globalThis.localStorage?.setItem(storageKey(userId), now);\n    setLastSeenIso(now);\n  };\n\n  const handleOpenChange = (nextOpen: boolean) => {\n    setOpen(nextOpen);\n    // When closing the menu, mark all currently visible notifications as seen.\n    if (!nextOpen && userId) {\n      const now = new Date().toISOString();\n      globalThis.localStorage?.setItem(storageKey(userId), now);\n      setLastSeenIso(now);\n    }\n  };\n\n  const isPending = isTasksPending || isContactNotesPending || isDealNotesPending;\n\n  return (\n    <DropdownMenu modal={false} open={open} onOpenChange={handleOpenChange}>\n      <DropdownMenuTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className=\"relative inline-flex\"\n          aria-label=\"Notifications\"\n        >\n          <Bell className=\"h-[1.2rem] w-[1.2rem]\" />\n          {unreadCount > 0 && (\n            <span className=\"absolute -top-0.5 -right-0.5 h-4 min-w-4 px-1 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-[10px] font-semibold\">\n              {unreadCount > 9 ? \"9+\" : unreadCount}\n            </span>\n          )}\n        </Button>\n      </DropdownMenuTrigger>\n\n      <DropdownMenuContent align=\"end\" className=\"w-[420px] p-0\">\n        <div className=\"px-3 py-2 flex items-center justify-between\">\n          <div className=\"text-sm font-medium\">Mentions</div>\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"h-7 px-2\"\n            onClick={markAllAsRead}\n            disabled={!userId}\n          >\n            Mark all read\n          </Button>\n        </div>\n        <DropdownMenuSeparator />\n\n        <div className=\"max-h-[70vh] overflow-auto\">\n          {!userId ? (\n            <div className=\"px-3 py-8 text-sm text-muted-foreground\">\n              Sign in to see notifications.\n            </div>\n          ) : isPending ? (\n            <div className=\"px-3 py-8 text-sm text-muted-foreground\">Loading</div>\n          ) : items.length === 0 ? (\n            <div className=\"px-3 py-8 text-sm text-muted-foreground\">\n              No mentions yet.\n            </div>\n          ) : (\n            <div className=\"py-1\">\n              {items.map((it) => {\n                const href =\n                  it.kind === \"task\"\n                    ? `/contacts/${it.contactId}/show?tab=tasks#task-${it.id}`\n                    : it.kind === \"contactNote\"\n                      ? `/contacts/${it.contactId}/show?tab=notes#note-${it.id}`\n                      : `/lead-journey/${it.dealId}/show?tab=notes#note-${it.id}`;\n\n                return (\n                  <div\n                    key={`${it.kind}-${it.id}`}\n                    className={cn(\n                      \"px-3 py-2 flex items-start gap-2 hover:bg-accent/60\",\n                      it.isNew && \"bg-accent/30\",\n                    )}\n                  >\n                    <div className=\"mt-0.5 flex-shrink-0\">\n                      {it.kind === \"task\" ? (\n                        <CheckSquare className=\"h-4 w-4 text-muted-foreground\" />\n                      ) : (\n                        <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                      )}\n                    </div>\n\n                    {it.kind === \"task\" ? (\n                      <Checkbox\n                        checked={it.done}\n                        disabled={isUpdatingTask}\n                        onCheckedChange={() => {\n                          updateTask(\"tasks\", {\n                            id: it.id,\n                            data: { done_date: it.done ? null : new Date().toISOString() },\n                            previousData: it.task,\n                          });\n                          // Keep the dropdown list in sync\n                          queryClient.invalidateQueries({ queryKey: [\"tasks\", \"getList\"] });\n                        }}\n                        className=\"mt-1 h-4 w-4\"\n                      />\n                    ) : (\n                      <span className=\"mt-1 h-4 w-4 flex-shrink-0\" />\n                    )}\n\n                    <div className=\"flex-1 min-w-0\">\n                      <Link\n                        to={href}\n                        className=\"block no-underline text-foreground\"\n                        onClick={() => setOpen(false)}\n                      >\n                        <div className=\"flex items-center justify-between gap-2\">\n                          <div className=\"text-xs text-muted-foreground\">\n                            {it.kind === \"task\" ? \"Task\" : \"Note\"}\n                            {it.isNew ? \"  New\" : \"\"}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground whitespace-nowrap\">\n                            <RelativeDate date={it.date} />\n                          </div>\n                        </div>\n                        <div className=\"text-sm leading-5 mt-0.5 line-clamp-2\">\n                          {it.text}\n                        </div>\n                      </Link>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </div>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n};\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/Layout.tsx",
      "content": "import { Suspense, type ReactNode } from \"react\";\nimport { ErrorBoundary } from \"react-error-boundary\";\nimport { Notification } from \"@/components/admin/notification\";\nimport { Error } from \"@/components/admin/error\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\nimport Header from \"./Header\";\n\nexport const Layout = ({ children }: { children: ReactNode }) => (\n  <>\n    <Header />\n    <main className=\"max-w-screen-xl mx-auto pt-4 px-4\" id=\"main-content\">\n      <ErrorBoundary FallbackComponent={Error}>\n        <Suspense fallback={<Skeleton className=\"h-12 w-12 rounded-full\" />}>\n          {children}\n        </Suspense>\n      </ErrorBoundary>\n    </main>\n    <Notification />\n  </>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/Header.tsx",
      "content": "import { DropdownMenuItem } from \"@/components/ui/dropdown-menu\";\nimport {\n  NavigationMenu,\n  NavigationMenuContent,\n  NavigationMenuItem,\n  NavigationMenuLink,\n  NavigationMenuList,\n  NavigationMenuTrigger,\n} from \"@/components/ui/navigation-menu\";\nimport { Settings, User, Moon, Sun, RotateCw, LoaderCircle, Bug } from \"lucide-react\";\nimport { CanAccess } from \"ra-core\";\nimport { Link, matchPath, useLocation } from \"react-router\";\nimport { UserMenu } from \"@/components/admin/user-menu\";\nimport { useUserMenu } from \"@/hooks/user-menu-context\";\nimport { useTheme } from \"@/components/admin/theme-provider\";\nimport { useRefresh, useLoading } from \"ra-core\";\nimport React, { useState, useEffect } from \"react\";\nimport { getCrmTimeZone } from \"../misc/timezone\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { NotificationsMenu } from \"./NotificationsMenu\";\n\n// Navigation groups configuration - easy to extend\nconst navigationGroups = [\n  {\n    label: \"Contacts\",\n    items: [\n      { label: \"Leads\", path: \"/contacts\", matchPattern: \"/contacts/*\" },\n      { label: \"Clients\", path: \"/clients\", matchPattern: \"/clients/*\" },\n      { label: \"Staff\", path: \"/staff\", matchPattern: \"/staff/*\" },\n      { label: \"Lead Journey\", path: \"/lead-journey\", matchPattern: \"/lead-journey/*\" },\n    ],\n  },\n  {\n    label: \"Tasks & Notes\",\n    items: [\n      { label: \"Tasks\", path: \"/tasks\", matchPattern: \"/tasks\" },\n      { label: \"Notes\", path: \"/notes\", matchPattern: \"/notes\" },\n    ],\n  },\n  {\n    label: \"Appointments\",\n    items: [\n      { label: \"Appointments\", path: \"/appointments\", matchPattern: \"/appointments\" },\n    ],\n  },\n  {\n    label: \"Payments\",\n    items: [\n      { label: \"Payment Packages\", path: \"/payment_packages\", matchPattern: \"/payment_packages/*\" },\n      { label: \"Payment Transactions\", path: \"/payment_transactions\", matchPattern: \"/payment_transactions/*\" },\n    ],\n  },\n];\n\nconst Header = () => {\n  const { darkModeLogo, lightModeLogo, title } = useConfigurationContext();\n  const location = useLocation();\n\n  // Check if any path in a group is active\n  const isGroupActive = (group: typeof navigationGroups[0]) => {\n    return group.items.some((item) => matchPath(item.matchPattern, location.pathname));\n  };\n\n  // Check if a specific item is active\n  const isItemActive = (matchPattern: string) => {\n    return matchPath(matchPattern, location.pathname);\n  };\n\n  return (\n    <nav className=\"flex-grow\">\n      <header className=\"bg-secondary\">\n        <div className=\"px-4\">\n          <div className=\"flex justify-between items-center flex-1\">\n            <Link\n              to=\"/\"\n              className=\"flex items-center gap-2 text-secondary-foreground no-underline\"\n            >\n              <img\n                className=\"[.light_&]:hidden h-6\"\n                src={darkModeLogo}\n                alt={title}\n              />\n              <img\n                className=\"[.dark_&]:hidden h-6\"\n                src={lightModeLogo}\n                alt={title}\n              />\n              <h1 className=\"text-xl font-semibold\">{title}</h1>\n            </Link>\n            <div className=\"flex items-center gap-6\">\n              <NavigationMenu viewport={false}>\n                <NavigationMenuList className=\"gap-0\">\n                  {navigationGroups.map((group) => {\n                    // If only one item, render as direct link\n                    if (group.items.length === 1) {\n                      const item = group.items[0];\n                      const isActive = isItemActive(item.matchPattern);\n                      return (\n                        <NavigationMenuItem key={group.label}>\n                          <NavigationMenuLink asChild>\n                            <Link\n                              to={item.path}\n                              className={`px-6 py-3 text-sm font-medium transition-colors border-b-2 rounded-none h-auto ${\n                                isActive\n                                  ? \"text-secondary-foreground border-secondary-foreground\"\n                                  : \"text-secondary-foreground/70 border-transparent hover:text-secondary-foreground/80\"\n                              }`}\n                            >\n                              {group.label}\n                            </Link>\n                          </NavigationMenuLink>\n                        </NavigationMenuItem>\n                      );\n                    }\n                    // Multiple items, render as dropdown\n                    return (\n                      <NavigationMenuItem key={group.label}>\n                        <NavigationMenuTrigger\n                          className={`px-6 py-3 text-sm font-medium transition-colors border-b-2 rounded-none h-auto bg-transparent hover:bg-transparent focus:bg-transparent data-[state=open]:bg-transparent ${\n                            isGroupActive(group)\n                              ? \"text-secondary-foreground border-secondary-foreground\"\n                              : \"text-secondary-foreground/70 border-transparent hover:text-secondary-foreground/80\"\n                          }`}\n                        >\n                          {group.label}\n                        </NavigationMenuTrigger>\n                        <NavigationMenuContent className=\"left-0 top-full mt-0 z-50\">\n                          <div className=\"w-[200px] p-2\">\n                            {group.items.map((item) => (\n                              <NavigationMenuLink\n                                key={item.path}\n                                asChild\n                                data-active={isItemActive(item.matchPattern)}\n                              >\n                                <Link\n                                  to={item.path}\n                                  className={`block rounded-sm px-3 py-2 text-sm transition-colors ${\n                                    isItemActive(item.matchPattern)\n                                      ? \"bg-accent text-accent-foreground font-medium\"\n                                      : \"hover:bg-accent hover:text-accent-foreground\"\n                                  }`}\n                                >\n                                  {item.label}\n                                </Link>\n                              </NavigationMenuLink>\n                            ))}\n                          </div>\n                        </NavigationMenuContent>\n                      </NavigationMenuItem>\n                    );\n                  })}\n                </NavigationMenuList>\n              </NavigationMenu>\n            </div>\n            <div className=\"flex items-center\">\n              <NotificationsMenu />\n              <CrmDateTime />\n              <UserMenu>\n                <ConfigurationMenu />\n                <CanAccess resource=\"sales\" action=\"list\">\n                  <UsersMenu />\n                </CanAccess>\n                <BugReportMenu />\n                <ThemeModeMenu />\n                <RefreshMenu />\n              </UserMenu>\n            </div>\n          </div>\n        </div>\n      </header>\n    </nav>\n  );\n};\n\nconst UsersMenu = () => {\n  const { onClose } = useUserMenu() ?? {};\n  return (\n    <DropdownMenuItem asChild onClick={onClose}>\n      <Link to=\"/settings\" className=\"flex items-center gap-2\">\n        <User /> Users and Settings\n      </Link>\n    </DropdownMenuItem>\n  );\n};\n\nconst ThemeModeMenu = () => {\n  const { theme, setTheme } = useTheme();\n  const { onClose } = useUserMenu() ?? {};\n\n  // Get current effective theme (handle system theme)\n  const getEffectiveTheme = (): \"light\" | \"dark\" => {\n    if (theme === \"system\") {\n      return window.matchMedia(\"(prefers-color-scheme: dark)\").matches ? \"dark\" : \"light\";\n    }\n    return theme;\n  };\n\n  const currentTheme = getEffectiveTheme();\n\n  const handleToggle = () => {\n    // Toggle between light and dark\n    const newTheme = currentTheme === \"light\" ? \"dark\" : \"light\";\n    setTheme(newTheme);\n    onClose?.();\n  };\n\n  // Show the opposite theme name (what it will switch to)\n  const targetTheme = currentTheme === \"light\" ? \"dark\" : \"light\";\n  const targetIcon = targetTheme === \"dark\" ? Moon : Sun;\n  const targetLabel = targetTheme === \"dark\" ? \"Dark\" : \"Light\";\n\n  return (\n    <DropdownMenuItem onClick={handleToggle} className=\"flex items-center gap-2\">\n      {targetIcon === Moon ? (\n        <Moon className=\"h-4 w-4\" />\n      ) : (\n        <Sun className=\"h-4 w-4\" />\n      )}\n      {targetLabel} Mode\n    </DropdownMenuItem>\n  );\n};\n\nconst RefreshMenu = () => {\n  const refresh = useRefresh();\n  const loading = useLoading();\n  const { onClose } = useUserMenu() ?? {};\n\n  const handleRefresh = () => {\n    refresh();\n    onClose?.();\n  };\n\n  return (\n    <DropdownMenuItem onClick={handleRefresh} className=\"flex items-center gap-2\">\n      {loading ? (\n        <LoaderCircle className=\"h-4 w-4 animate-spin\" />\n      ) : (\n        <RotateCw className=\"h-4 w-4\" />\n      )}\n      Refresh\n    </DropdownMenuItem>\n  );\n};\n\nconst ConfigurationMenu = () => {\n  const { onClose } = useUserMenu() ?? {};\n  return (\n    <DropdownMenuItem asChild onClick={onClose}>\n      <Link to=\"/settings\" className=\"flex items-center gap-2\">\n        <Settings />\n        My info\n      </Link>\n    </DropdownMenuItem>\n  );\n};\n\nconst BugReportMenu = () => {\n  const { onClose } = useUserMenu() ?? {};\n  return (\n    <DropdownMenuItem asChild onClick={onClose}>\n      <Link to=\"/bug-reports\" className=\"flex items-center gap-2\">\n        <Bug />\n        Report a Bug\n      </Link>\n    </DropdownMenuItem>\n  );\n};\n\nconst CrmDateTime = () => {\n  const [currentTime, setCurrentTime] = useState(new Date());\n\n  useEffect(() => {\n    // Update time every second\n    const interval = setInterval(() => {\n      setCurrentTime(new Date());\n    }, 1000);\n\n    return () => clearInterval(interval);\n  }, []);\n\n  // Format date as \"Mon 29 Dec\" in CRM timezone\n  const dateFormatter = new Intl.DateTimeFormat(\"en-US\", {\n    timeZone: getCrmTimeZone(),\n    weekday: \"short\",\n    day: \"numeric\",\n    month: \"short\",\n  });\n  const dateStr = dateFormatter.format(currentTime);\n  \n  // Format time as \"9:23 PM\" (12-hour format, no seconds) in CRM timezone\n  const timeFormatter = new Intl.DateTimeFormat(\"en-US\", {\n    timeZone: getCrmTimeZone(),\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    hour12: true,\n  });\n  const timeStr = timeFormatter.format(currentTime);\n\n  return (\n    <div className=\"flex items-center gap-2 text-sm text-secondary-foreground/90\">\n      <span className=\"font-semibold\">{dateStr} {timeStr}</span>\n    </div>\n  );\n};\n\nexport default Header;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/FormToolbar.tsx",
      "content": "import { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\n\nexport const FormToolbar = () => (\n  <div\n    role=\"toolbar\"\n    className=\"sticky flex pt-4 pb-4 md:pb-0 bottom-0 bg-linear-to-b from-transparent to-card to-10% flex-row justify-end gap-2\"\n  >\n    <CancelButton />\n    <SaveButton />\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/filters/filterUtils.ts",
      "content": "type Primitive = string | number;\n\nexport const parseInFilter = (value?: string): string[] => {\n  if (!value) return [];\n  return value\n    .replace(/[()]/g, \"\")\n    .split(\",\")\n    .map((item) => item.trim())\n    .filter(Boolean);\n};\n\nexport const buildInFilter = (values: Primitive[]): string | undefined => {\n  if (!values.length) return undefined;\n  return `(${values.join(\",\")})`;\n};\n\nexport const parseOverlapFilter = (value?: string): string[] => {\n  if (!value) return [];\n  return value\n    .replace(/[{}]/g, \"\")\n    .split(\",\")\n    .map((item) => item.trim())\n    .filter(Boolean);\n};\n\nexport const buildOverlapFilter = (\n  values: Primitive[],\n): string | undefined => {\n  if (!values.length) return undefined;\n  return `{${values.join(\",\")}}`;\n};\n\nexport const toggleValueInList = (\n  list: Primitive[],\n  value: Primitive,\n): Primitive[] => {\n  const asString = String(value);\n  const hasValue = list.some((item) => String(item) === asString);\n  return hasValue\n    ? list.filter((item) => String(item) !== asString)\n    : [...list, value];\n};\n\nexport type RangeFilter = {\n  field: string;\n  gte?: string;\n  lte?: string;\n};\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/filters/FilterOptionButton.tsx",
      "content": "import { CircleX } from \"lucide-react\";\nimport type { ReactNode } from \"react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\n\nexport const FilterOptionButton = ({\n  label,\n  selected,\n  onToggle,\n  className,\n}: {\n  label: ReactNode;\n  selected: boolean;\n  onToggle: () => void;\n  className?: string;\n}) => (\n  <Button\n    variant={selected ? \"secondary\" : \"ghost\"}\n    size=\"sm\"\n    onClick={onToggle}\n    className={cn(\n      \"cursor-pointer flex flex-row items-center justify-between gap-2 px-2.5 w-full\",\n      className,\n    )}\n  >\n    {label}\n    {selected && <CircleX className=\"h-4 w-4 opacity-50\" />}\n  </Button>\n);\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/filters/FilterCategory.tsx",
      "content": "import { Translate } from \"ra-core\";\nimport type { ReactNode } from \"react\";\n\nimport { Button } from \"@/components/ui/button\";\n\nexport const FilterCategory = ({\n  icon,\n  label,\n  children,\n  count,\n  onClear,\n}: {\n  icon: ReactNode;\n  label: string;\n  children?: ReactNode;\n  count?: number;\n  onClear?: () => void;\n}) => (\n  <div className=\"flex flex-col gap-2\">\n    <div className=\"flex flex-row items-center justify-between gap-2\">\n      <h3 className=\"flex flex-row items-center gap-2 font-bold text-sm\">\n        {icon}\n        <Translate i18nKey={label} />\n      </h3>\n      <div className=\"flex flex-row items-center gap-1\">\n        {count !== undefined && count > 0 ? (\n          <span className=\"text-xs text-muted-foreground\">{count}</span>\n        ) : null}\n        {onClear ? (\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"h-7 px-2 text-xs\"\n            onClick={onClear}\n            disabled={!count}\n          >\n            Clear\n          </Button>\n        ) : null}\n      </div>\n    </div>\n    <div className=\"flex flex-col items-start pl-4\">{children}</div>\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/stages.ts",
      "content": "import type { ConfigurationContextValue } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\n\nexport type DealsByStage = Record<Deal[\"stage\"], Deal[]>;\n\nexport const getDealsByStage = (\n  unorderedDeals: Deal[],\n  stages: ConfigurationContextValue[\"dealStages\"] | ConfigurationContextValue[\"leadStages\"],\n) => {\n  if (!stages || stages.length === 0) return {};\n\n  const initialColumns = stages.reduce(\n    (obj, stage) => ({ ...obj, [stage.value]: [] }),\n    {} as Record<Deal[\"stage\"], Deal[]>,\n  );\n\n  const dealsByStage: Record<Deal[\"stage\"], Deal[]> = unorderedDeals.reduce(\n    (acc, deal) => {\n      if (!acc[deal.stage]) {\n        acc[deal.stage] = [];\n      }\n      acc[deal.stage].push(deal);\n      return acc;\n    },\n    { ...initialColumns },\n  );\n\n  // order each column by index\n  stages.forEach((stage) => {\n    dealsByStage[stage.value] = (dealsByStage[stage.value] ?? []).sort(\n      (recordA: Deal, recordB: Deal) => recordA.index - recordB.index,\n    );\n  });\n  return dealsByStage;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/index.ts",
      "content": "import * as React from \"react\";\nconst DealList = React.lazy(() => import(\"./DealList\"));\n\nexport default {\n  list: DealList,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/dealUtils.ts",
      "content": "import { formatCrmDate } from \"../misc/timezone\";\n\nexport function getRelativeTimeString(dateString: string): string {\n  const date = new Date(dateString);\n  date.setHours(0, 0, 0, 0);\n\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const diff = date.getTime() - today.getTime();\n  const unitDiff = Math.round(diff / (1000 * 60 * 60 * 24));\n\n  // Check if the date is more than one week old\n  if (Math.abs(unitDiff) > 7) {\n    return formatCrmDate(date);\n  }\n\n  // Intl.RelativeTimeFormat for dates within the last week\n  const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: \"auto\" });\n  return ucFirst(rtf.format(unitDiff, \"day\"));\n}\n\nfunction ucFirst(str: string): string {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/deal.ts",
      "content": "import type { DealStage } from \"../types\";\n\nexport const findDealLabel = (dealStages: DealStage[], dealValue: string) => {\n  return dealStages.find((dealStage) => dealStage.value === dealValue)?.label;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/createLeadJourneyDeal.ts",
      "content": "import type { DataProvider, Identifier } from \"ra-core\";\n\ntype MinimalContactLike = {\n  id: Identifier;\n  first_name?: string | null;\n  last_name?: string | null;\n  sales_id?: Identifier | null;\n  company_id?: Identifier | null;\n};\n\n/**\n * \"Lead Journey\" is backed by the `deals` table (resource name: \"lead-journey\").\n *\n * The schema has evolved over time:\n * - legacy: deals.contact_ids[] (array of contact IDs)\n * - current: deals.lead_id (single contact ID)\n * - optional newer: deals.first_name / deals.last_name (denormalized for display)\n *\n * This helper writes the correct record and gracefully falls back based on\n * which columns exist in the DB, so imports don't silently miss Lead Journey.\n */\nexport async function createLeadJourneyDealForContact(\n  dataProvider: DataProvider,\n  contact: MinimalContactLike,\n  fallbackSalesId?: Identifier,\n) {\n  const now = new Date().toISOString();\n  const name =\n    `${contact.first_name ?? \"\"} ${contact.last_name ?? \"\"}`.trim() || \"New Lead\";\n  const sales_id = (contact.sales_id ?? fallbackSalesId ?? null) as any;\n\n  const baseData: any = {\n    name,\n    stage: \"new\",\n    index: 0,\n    sales_id,\n    company_id: (contact.company_id ?? null) as any,\n    created_at: now,\n    updated_at: now,\n  };\n\n  // Attempt 1: newest schema (lead_id + first/last name columns)\n  try {\n    return await dataProvider.create(\"lead-journey\", {\n      data: {\n        ...baseData,\n        lead_id: contact.id,\n        first_name: contact.first_name ?? null,\n        last_name: contact.last_name ?? null,\n      },\n    });\n  } catch {\n    // ignore - fall through\n  }\n\n  // Attempt 2: schema with lead_id but without first/last name columns\n  try {\n    return await dataProvider.create(\"lead-journey\", {\n      data: {\n        ...baseData,\n        lead_id: contact.id,\n      },\n    });\n  } catch {\n    // ignore - fall through\n  }\n\n  // Attempt 3: legacy schema (contact_ids array, no lead_id column)\n  return await dataProvider.create(\"lead-journey\", {\n    data: {\n      ...baseData,\n      contact_ids: [contact.id],\n    },\n  });\n}\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/OnlyMineInput.tsx",
      "content": "import { useGetIdentity, useListFilterContext } from \"ra-core\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\n\nexport const OnlyMineInput = (_: { alwaysOn: boolean; source: string }) => {\n  const { filterValues, displayedFilters, setFilters } = useListFilterContext();\n  const { identity } = useGetIdentity();\n\n  const handleChange = () => {\n    const newFilterValues = { ...filterValues };\n    if (typeof filterValues.sales_id !== \"undefined\") {\n      delete newFilterValues.sales_id;\n    } else {\n      newFilterValues.sales_id = identity && identity?.id;\n    }\n    setFilters(newFilterValues, displayedFilters);\n  };\n  return (\n    <div className=\"mt-auto pb-2.25\">\n      <div className=\"flex items-center space-x-2\">\n        <Switch\n          id=\"only-mine\"\n          checked={typeof filterValues.sales_id !== \"undefined\"}\n          onCheckedChange={handleChange}\n        />\n        <Label htmlFor=\"only-mine\">Only leads I manage</Label>\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/LeadJourneyTopFilter.tsx",
      "content": "import { subMonths } from \"date-fns\";\nimport {\n  ChevronDown,\n  ChevronUp,\n  Clock,\n  Filter,\n  Stethoscope,\n  Users,\n  X,\n} from \"lucide-react\";\nimport { FilterLiveForm, useGetIdentity, useGetList, useListContext } from \"ra-core\";\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  crmEndOfYesterday,\n  crmStartOfMonth,\n  crmStartOfWeek,\n} from \"../misc/timezone\";\n\nexport const LeadJourneyTopFilter = ({ \n  isExpanded \n}: { \n  isExpanded: boolean;\n}) => {\n  const { identity } = useGetIdentity();\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  const { data: salesData } = useGetList(\"sales\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"first_name\", order: \"ASC\" },\n  });\n\n  const startOfWeek = crmStartOfWeek();\n  const startOfMonth = crmStartOfMonth();\n  const endOfYesterday = crmEndOfYesterday();\n\n  return (\n    <>\n      {/* Collapsible Filter Section */}\n      {isExpanded && (\n        <Card className=\"mb-4\">\n          <CardContent className=\"p-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n              {/* Last Activity */}\n              <div className=\"flex flex-col gap-2\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                  <Clock className=\"h-4 w-4\" />\n                  Last activity\n                </div>\n                <div className=\"flex flex-col gap-1\">\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"Today\"\n                    value={{\n                      \"updated_at@gte\": endOfYesterday?.toISOString(),\n                      \"updated_at@lte\": undefined,\n                    }}\n                  />\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"This week\"\n                    value={{\n                      \"updated_at@gte\": startOfWeek?.toISOString(),\n                      \"updated_at@lte\": undefined,\n                    }}\n                  />\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"Before this week\"\n                    value={{\n                      \"updated_at@gte\": undefined,\n                      \"updated_at@lte\": startOfWeek?.toISOString(),\n                    }}\n                  />\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"Before this month\"\n                    value={{\n                      \"updated_at@gte\": undefined,\n                      \"updated_at@lte\": startOfMonth?.toISOString(),\n                    }}\n                  />\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"Before last month\"\n                    value={{\n                      \"updated_at@gte\": undefined,\n                      \"updated_at@lte\": subMonths(\n                        startOfMonth ?? new Date(),\n                        1,\n                      ).toISOString(),\n                    }}\n                  />\n                </div>\n              </div>\n\n              {/* Services */}\n              <div className=\"flex flex-col gap-2\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                  <Stethoscope className=\"h-4 w-4\" />\n                  Services\n                </div>\n                <div className=\"flex flex-col gap-1\">\n                  {servicesData &&\n                    servicesData.map((service) => (\n                      <ToggleFilterButton\n                        key={service.id}\n                        className=\"w-full justify-start\"\n                        label={service.name}\n                        value={{ \"services_interested@cs\": `{${service.id}}` }}\n                      />\n                    ))}\n                </div>\n              </div>\n\n              {/* Account Manager */}\n              <div className=\"flex flex-col gap-2\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                  <Users className=\"h-4 w-4\" />\n                  Account Manager\n                </div>\n                <div className=\"flex flex-col gap-1\">\n                  {salesData &&\n                    salesData.map((sale) => (\n                      <ToggleFilterButton\n                        key={sale.id}\n                        className=\"w-full justify-start\"\n                        label={`${sale.first_name} ${sale.last_name}`}\n                        value={{ sales_id: sale.id }}\n                      />\n                    ))}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </>\n  );\n};\n\nexport const LeadJourneySearchAndFilter = ({ \n  onFilterToggle, \n  isFilterExpanded \n}: { \n  onFilterToggle: () => void;\n  isFilterExpanded: boolean;\n}) => {\n  const { filterValues, setFilters } = useListContext();\n\n  const hasActiveFilters = filterValues && Object.keys(filterValues).length > 0 && \n    Object.keys(filterValues).some(key => key !== \"archived_at@is\" && key !== \"q\");\n\n  const clearAllFilters = () => {\n    const baseFilter = { \"archived_at@is\": null };\n    setFilters(baseFilter, {});\n  };\n\n  return (\n    <div className=\"flex items-center gap-2 flex-1\">\n      <div className=\"flex-1 max-w-md\">\n        <FilterLiveForm>\n          <SearchInput \n            source=\"q\" \n            placeholder=\"Search name, company...\"\n          />\n        </FilterLiveForm>\n      </div>\n      {hasActiveFilters && (\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={clearAllFilters}\n          className=\"text-muted-foreground\"\n        >\n          <X className=\"h-4 w-4 mr-1\" />\n          Clear\n        </Button>\n      )}\n      <Button\n        variant=\"outline\"\n        size=\"sm\"\n        onClick={onFilterToggle}\n        className=\"flex items-center gap-2\"\n      >\n        <Filter className=\"h-4 w-4\" />\n        Filters\n        {isFilterExpanded ? (\n          <ChevronUp className=\"h-4 w-4\" />\n        ) : (\n          <ChevronDown className=\"h-4 w-4\" />\n        )}\n      </Button>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/LeadJourneyListFilter.tsx",
      "content": "import { subMonths } from \"date-fns\";\nimport {\n  CheckSquare,\n  Clock,\n  Stethoscope,\n  Tag,\n  TrendingUp,\n  Users,\n} from \"lucide-react\";\nimport { FilterLiveForm, useGetIdentity, useGetList } from \"ra-core\";\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { Status } from \"../misc/Status\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport {\n  crmEndOfYesterday,\n  crmStartOfMonth,\n  crmStartOfWeek,\n} from \"../misc/timezone\";\n\nexport const LeadJourneyListFilter = () => {\n  const { noteStatuses, leadStages } = useConfigurationContext();\n  const { identity } = useGetIdentity();\n  const { data } = useGetList(\"tags\", {\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const startOfWeek = crmStartOfWeek();\n  const startOfMonth = crmStartOfMonth();\n  const endOfYesterday = crmEndOfYesterday();\n\n  return (\n    <div className=\"w-52 min-w-52 order-first pt-0.75 flex flex-col gap-4\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" placeholder=\"Search name, company...\" />\n      </FilterLiveForm>\n\n      <FilterCategory label=\"Last activity\" icon={<Clock />}>\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Today\"\n          value={{\n            \"updated_at@gte\": endOfYesterday?.toISOString(),\n            \"updated_at@lte\": undefined,\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"This week\"\n          value={{\n            \"updated_at@gte\": startOfWeek?.toISOString(),\n            \"updated_at@lte\": undefined,\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Before this week\"\n          value={{\n            \"updated_at@gte\": undefined,\n            \"updated_at@lte\": startOfWeek?.toISOString(),\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Before this month\"\n          value={{\n            \"updated_at@gte\": undefined,\n            \"updated_at@lte\": startOfMonth?.toISOString(),\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Before last month\"\n          value={{\n            \"updated_at@gte\": undefined,\n            \"updated_at@lte\": subMonths(\n              startOfMonth ?? new Date(),\n              1,\n            ).toISOString(),\n          }}\n        />\n      </FilterCategory>\n\n      <FilterCategory label=\"Stage\" icon={<TrendingUp />}>\n        {leadStages.map((stage) => (\n          <ToggleFilterButton\n            key={stage.value}\n            className=\"w-full justify-between\"\n            label={stage.label}\n            value={{ stage: stage.value }}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory icon={<Users />} label=\"Account Manager\">\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label={\"Me\"}\n          value={{ sales_id: identity?.id }}\n        />\n      </FilterCategory>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealShow.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport { Archive, ArchiveRestore, Phone, Mail, MapPin, Stethoscope } from \"lucide-react\";\nimport { useEffect } from \"react\";\nimport {\n  ShowBase,\n  useDataProvider,\n  useGetList,\n  useGetOne,\n  useNotify,\n  useRecordContext,\n  useRedirect,\n  useRefresh,\n  useUpdate,\n  RecordContextProvider,\n  useListContext,\n} from \"ra-core\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Link, useLocation } from \"react-router\";\nimport { subHours } from \"date-fns\";\n\nimport { NotesIterator } from \"../notes/NotesIterator\";\nimport { UnifiedNotesIterator } from \"../notes/UnifiedNotesIterator\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal, Contact, DealNote, ContactNote } from \"../types\";\nimport { TagsListEdit } from \"../contacts/TagsListEdit\";\nimport { ServicesListEdit } from \"../contacts/ServicesListEdit\";\nimport { QuotesIterator } from \"../quotes/QuotesIterator\";\nimport { AddQuote } from \"../quotes/AddQuote\";\nimport { TasksIterator } from \"../tasks/TasksIterator\";\nimport { AddTask } from \"../tasks/AddTask\";\nimport { findDealLabel } from \"./deal\";\n\nexport const DealShow = ({ open, id }: { open: boolean; id?: string }) => {\n  const redirect = useRedirect();\n  const handleClose = () => {\n    redirect(\"list\", \"lead-journey\");\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={(open) => !open && handleClose()}>\n      <DialogContent className=\"lg:max-w-4xl p-4 overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        {id ? (\n          <ShowBase id={id} resource=\"lead-journey\">\n            <DealShowContent />\n          </ShowBase>\n        ) : (\n          <>\n            <DialogTitle className=\"sr-only\">Deal Details</DialogTitle>\n            <DialogDescription className=\"sr-only\">View deal information</DialogDescription>\n          </>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nconst DealShowContent = () => {\n  const { leadStages } = useConfigurationContext();\n  const record = useRecordContext<Deal>();\n  const location = useLocation();\n  if (!record) return null;\n\n  // Fetch Contact data using lead_id\n  const { data: contact } = useGetOne<Contact>(\n    \"contacts\",\n    { id: record.lead_id },\n    { enabled: !!record.lead_id }\n  );\n\n  // Fetch services from database to match with services_interested IDs\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 100 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  // Fetch notes, quotes, and tasks for notification badges\n  const { data: dealNotes } = useGetList<DealNote>(\"dealNotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: { deal_id: record.id },\n  }, { enabled: !!record.id });\n\n  const { data: contactNotes } = useGetList<ContactNote>(\"contactNotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record.lead_id ? { contact_id: record.lead_id } : {},\n  }, { enabled: !!record.lead_id });\n\n  const { data: quotes } = useGetList(\"quotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record.lead_id ? { contact_id: record.lead_id } : {},\n  }, { enabled: !!record.lead_id });\n\n  const { data: tasks } = useGetList(\"tasks\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record.lead_id ? { contact_id: record.lead_id } : {},\n  }, { enabled: !!record.lead_id });\n\n  // Calculate notification counts for last 24 hours\n  const twentyFourHoursAgo = subHours(new Date(), 24);\n  \n  const newNotesCount = [\n    ...(dealNotes || []).filter(note => new Date(note.date) > twentyFourHoursAgo),\n    ...(contactNotes || []).filter(note => new Date(note.date) > twentyFourHoursAgo),\n  ].length;\n  \n  const newQuotesCount = (quotes || []).filter(quote => {\n    const createdAt = quote.created_at || quote.date;\n    return createdAt && new Date(createdAt) > twentyFourHoursAgo;\n  }).length;\n  \n  const newTasksCount = (tasks || []).filter(task => {\n    // Show tasks that are due within the next 24 hours or overdue\n    if (!task.due_date) return false;\n    const dueDate = new Date(task.due_date);\n    const now = new Date();\n    return dueDate <= now || (dueDate > now && dueDate <= new Date(now.getTime() + 24 * 60 * 60 * 1000));\n  }).length;\n\n  const displayName = contact \n    ? `${contact.first_name || \"\"} ${contact.last_name || \"\"}`.trim() || \"New Lead\"\n    : record.first_name || record.last_name\n    ? `${record.first_name ?? \"\"} ${record.last_name ?? \"\"}`.trim()\n    : record.name || \"New Lead\";\n\n  // Deep-link scrolling for #note-123 / #task-456 inside the dialog.\n  // We retry a few frames because the tab content may mount slightly later.\n  const defaultTab = (() => {\n    const tab = new URLSearchParams(location.search).get(\"tab\");\n    if (tab === \"notes\" || tab === \"quotes\" || tab === \"tasks\") return tab;\n    return \"notes\";\n  })();\n\n  useEffect(() => {\n    const hash = (location.hash || \"\").replace(/^#/, \"\");\n    if (!hash) return;\n\n    let tries = 0;\n    const tryScroll = () => {\n      tries += 1;\n      const el = document.getElementById(hash);\n      if (el) {\n        el.scrollIntoView({ block: \"center\", behavior: \"smooth\" });\n        return;\n      }\n      if (tries < 24) setTimeout(tryScroll, 150);\n    };\n\n    tryScroll();\n  }, [location.hash, defaultTab]);\n\n  return (\n    <>\n      <DialogTitle className=\"sr-only\">{displayName}</DialogTitle>\n      <DialogDescription className=\"sr-only\">Deal details and information</DialogDescription>\n      <div className=\"space-y-2\">\n        {record.archived_at ? <ArchivedTitle /> : null}\n        <div className=\"flex-1\">\n          <div className=\"flex justify-between items-start mb-8\">\n            <div className=\"flex items-center gap-4\">\n              <h2 className=\"text-2xl font-semibold\">{displayName}</h2>\n              <span className=\"text-sm font-medium text-muted-foreground\">\n                {record.stage === \"converted\" ? \"Client\" : findDealLabel(leadStages, record.stage)}\n              </span>\n            </div>\n            <div className={`flex gap-2 ${record.archived_at ? \"\" : \"pr-12\"}`}>\n              {record.archived_at ? (\n                <>\n                  <UnarchiveButton record={record} />\n                  <DeleteButton />\n                </>\n              ) : (\n                <>\n                  <ArchiveButton record={record} />\n                  <AddToClientsButton record={record} />\n                  {contact && (\n                    <Button asChild variant=\"outline\" size=\"sm\" className=\"h-9\">\n                      <Link to={`/contacts/${contact.id}/show`}>See Contact</Link>\n                    </Button>\n                  )}\n                </>\n              )}\n            </div>\n          </div>\n\n          {/* Lead Information Section - All in one row */}\n          {contact && (\n            <div className=\"m-4\">\n              <Separator className=\"mb-4\" />\n              <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n                {/* Phone Numbers */}\n                <div className=\"flex flex-col\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide flex items-center gap-2 mb-1\">\n                    <Phone className=\"h-4 w-4\" />\n                    Phone\n                  </span>\n                  {contact.phone_jsonb && contact.phone_jsonb.length > 0 ? (\n                    <div className=\"flex flex-col gap-1\">\n                      {contact.phone_jsonb.map((phone, index) => (\n                        <span key={index} className=\"text-sm\">\n                          {phone.number}\n                        </span>\n                      ))}\n                    </div>\n                  ) : (\n                    <span className=\"text-sm text-muted-foreground\"></span>\n                  )}\n                </div>\n\n                {/* Services Interested */}\n                <div className=\"flex flex-col\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide flex items-center gap-2 mb-1\">\n                    <Stethoscope className=\"h-4 w-4\" />\n                    Services Interested\n                  </span>\n                  <RecordContextProvider value={contact}>\n                    <ServicesListEdit />\n                  </RecordContextProvider>\n                </div>\n\n                {/* Tags */}\n                <div className=\"flex flex-col\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide mb-1\">\n                    Tags\n                  </span>\n                  <RecordContextProvider value={contact}>\n                    <TagsListEdit />\n                  </RecordContextProvider>\n                </div>\n\n                {/* Stage */}\n                <div className=\"flex flex-col\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide mb-1\">\n                    Stage\n                  </span>\n                  <StageSelect deal={record} leadStages={leadStages} />\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Email and Address Section */}\n          {contact && (\n            <div className=\"m-4 space-y-4\">\n              <Separator />\n              \n              {/* Email Addresses */}\n              {contact.email_jsonb && contact.email_jsonb.length > 0 && (\n                <div className=\"flex flex-col gap-2\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide flex items-center gap-2\">\n                    <Mail className=\"h-4 w-4\" />\n                    Email\n                  </span>\n                  <div className=\"flex flex-col gap-1\">\n                    {contact.email_jsonb.map((email, index) => (\n                      <div key={index} className=\"flex items-center gap-2\">\n                        <a \n                          href={`mailto:${email.email}`}\n                          className=\"text-sm text-primary hover:underline\"\n                        >\n                          {email.email}\n                        </a>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {email.type}\n                        </Badge>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Address */}\n              {(contact.flat_villa_number || contact.building_street || contact.area) && (\n                <div className=\"flex flex-col gap-2\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide flex items-center gap-2\">\n                    <MapPin className=\"h-4 w-4\" />\n                    Address\n                  </span>\n                  <div className=\"text-sm\">\n                    {contact.flat_villa_number && <span>{contact.flat_villa_number}, </span>}\n                    {contact.building_street && <span>{contact.building_street}, </span>}\n                    {contact.area && <span>{contact.area}</span>}\n                    {contact.google_maps_link && (\n                      <a\n                        href={contact.google_maps_link}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"ml-2 text-primary hover:underline\"\n                      >\n                        View on Map\n                      </a>\n                    )}\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* Tabs for Notes, Quotes, Tasks */}\n          <div className=\"m-4\">\n            <Separator className=\"mb-4\" />\n            <Tabs defaultValue={defaultTab}>\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"notes\" className=\"relative gap-2\">\n                  <span>Notes</span>\n                  {newNotesCount > 0 && (\n                    <span className=\"h-5 min-w-5 px-1.5 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-[10px] font-semibold\">\n                      {newNotesCount}\n                    </span>\n                  )}\n                </TabsTrigger>\n                <TabsTrigger value=\"quotes\" className=\"relative gap-2\">\n                  <span>Quotes</span>\n                  {newQuotesCount > 0 && (\n                    <span className=\"h-5 min-w-5 px-1.5 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-[10px] font-semibold\">\n                      {newQuotesCount}\n                    </span>\n                  )}\n                </TabsTrigger>\n                <TabsTrigger value=\"tasks\" className=\"relative gap-2\">\n                  <span>Tasks</span>\n                  {newTasksCount > 0 && (\n                    <span className=\"h-5 min-w-5 px-1.5 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-[10px] font-semibold\">\n                      {newTasksCount}\n                    </span>\n                  )}\n                </TabsTrigger>\n              </TabsList>\n              <TabsContent value=\"notes\" className=\"pt-4\">\n                <UnifiedNotesIterator\n                  reference=\"lead-journey\"\n                  dealId={record.id}\n                  // Prefer lead_id when present, fallback to the first legacy contact_ids entry\n                  contactId={\n                    record.lead_id ?? (Array.isArray(record.contact_ids) ? record.contact_ids[0] : undefined)\n                  }\n                  leadId={record.lead_id}\n                />\n              </TabsContent>\n              <TabsContent value=\"quotes\" className=\"pt-4\">\n                {record.lead_id && contact ? (\n                  <RecordContextProvider value={contact}>\n                    <ReferenceManyField\n                      target=\"contact_id\"\n                      reference=\"quotes\"\n                      sort={{ field: \"created_at\", order: \"DESC\" }}\n                    >\n                      <QuotesIterator />\n                    </ReferenceManyField>\n                  </RecordContextProvider>\n                ) : null}\n                {record.lead_id && contact && (\n                  <div className=\"mt-4\">\n                    <RecordContextProvider value={contact}>\n                      <AddQuote />\n                    </RecordContextProvider>\n                  </div>\n                )}\n              </TabsContent>\n              <TabsContent value=\"tasks\" className=\"pt-4\">\n                {record.lead_id && contact ? (\n                  <RecordContextProvider value={contact}>\n                    <ReferenceManyField\n                      target=\"contact_id\"\n                      reference=\"tasks\"\n                      sort={{ field: \"due_date\", order: \"ASC\" }}\n                    >\n                      <TasksIterator showAll />\n                    </ReferenceManyField>\n                  </RecordContextProvider>\n                ) : null}\n                {record.lead_id && contact && (\n                  <div className=\"mt-4\">\n                    <RecordContextProvider value={contact}>\n                      <AddTask />\n                    </RecordContextProvider>\n                  </div>\n                )}\n              </TabsContent>\n            </Tabs>\n          </div>\n        </div>\n      </div>\n    </>\n  );\n};\n\nconst ArchivedTitle = () => (\n  <div className=\"bg-orange-500 px-6 py-4\">\n    <h3 className=\"text-lg font-bold text-white\">Archived Deal</h3>\n  </div>\n);\n\nconst ArchiveButton = ({ record }: { record: Deal }) => {\n  const [update] = useUpdate();\n  const redirect = useRedirect();\n  const notify = useNotify();\n  const refresh = useRefresh();\n  const handleClick = () => {\n    update(\n      \"lead-journey\",\n      {\n        id: record.id,\n        data: { archived_at: new Date().toISOString() },\n        previousData: record,\n      },\n      {\n        onSuccess: () => {\n          redirect(\"list\", \"lead-journey\");\n          notify(\"Deal archived\", { type: \"info\", undoable: false });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error: deal not archived\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  return (\n    <Button\n      onClick={handleClick}\n      size=\"sm\"\n      variant=\"outline\"\n      className=\"flex items-center gap-2 h-9\"\n    >\n      <Archive className=\"w-4 h-4\" />\n      Archive\n    </Button>\n  );\n};\n\nconst UnarchiveButton = ({ record }: { record: Deal }) => {\n  const dataProvider = useDataProvider();\n  const redirect = useRedirect();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const { mutate } = useMutation({\n    mutationFn: () => dataProvider.unarchiveDeal(record),\n    onSuccess: () => {\n      redirect(\"list\", \"lead-journey\");\n      notify(\"Deal unarchived\", {\n        type: \"info\",\n        undoable: false,\n      });\n      refresh();\n    },\n    onError: () => {\n      notify(\"Error: deal not unarchived\", { type: \"error\" });\n    },\n  });\n\n  const handleClick = () => {\n    mutate();\n  };\n\n  return (\n    <Button\n      onClick={handleClick}\n      size=\"sm\"\n      variant=\"outline\"\n      className=\"flex items-center gap-2 h-9\"\n    >\n      <ArchiveRestore className=\"w-4 h-4\" />\n      Send back to the board\n    </Button>\n  );\n};\n\nconst AddToClientsButton = ({ record }: { record: Deal }) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n  const isClient = record.stage === \"converted\";\n\n  const handleClick = () => {\n    if (isClient) {\n      // Already a client, maybe show a message or navigate to client page\n      notify(\"This lead is already a client\", { type: \"info\", undoable: false });\n    } else {\n      // Convert to client by updating stage to \"converted\"\n      update(\n        \"lead-journey\",\n        {\n          id: record.id,\n          data: { stage: \"converted\" },\n          previousData: record,\n        },\n        {\n          onSuccess: () => {\n            notify(\"Lead converted to client\", { type: \"success\", undoable: false });\n            refresh();\n          },\n          onError: () => {\n            notify(\"Error: lead not converted to client\", { type: \"error\" });\n          },\n        },\n      );\n    }\n  };\n\n  return (\n    <Button\n      onClick={handleClick}\n      size=\"sm\"\n      variant={isClient ? \"default\" : \"outline\"}\n      className=\"flex items-center gap-2 h-9\"\n      disabled={isClient}\n    >\n      {isClient ? \"Client\" : \"Add to Clients\"}\n    </Button>\n  );\n};\n\nconst StageSelect = ({ deal, leadStages }: { deal: Deal; leadStages: any[] }) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const handleStageChange = (newStage: string) => {\n    if (newStage === deal.stage) return;\n    \n    update(\n      \"lead-journey\",\n      {\n        id: deal.id,\n        data: { stage: newStage },\n        previousData: deal,\n      },\n      {\n        onSuccess: () => {\n          notify(\"Deal stage updated\", { type: \"info\" });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error updating deal stage\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  return (\n    <Select value={deal.stage} onValueChange={handleStageChange}>\n      <SelectTrigger className=\"h-8 text-sm\">\n        <SelectValue>\n          {deal.stage === \"converted\" ? \"Client\" : findDealLabel(leadStages, deal.stage)}\n        </SelectValue>\n      </SelectTrigger>\n      <SelectContent>\n        {leadStages.map((stage) => (\n          <SelectItem key={stage.value} value={stage.value}>\n            {stage.label}\n          </SelectItem>\n        ))}\n      </SelectContent>\n    </Select>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealListContent.tsx",
      "content": "import { DragDropContext, type OnDragEndResponder } from \"@hello-pangea/dnd\";\nimport isEqual from \"lodash/isEqual\";\nimport { useDataProvider, useListContext, type DataProvider } from \"ra-core\";\nimport { useEffect, useState } from \"react\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\nimport { DealColumn } from \"./DealColumn\";\nimport type { DealsByStage } from \"./stages\";\nimport { getDealsByStage } from \"./stages\";\n\nexport const DealListContent = () => {\n  const { leadStages } = useConfigurationContext();\n  const { data: unorderedDeals, isPending, refetch } = useListContext<Deal>();\n  const dataProvider = useDataProvider();\n\n  const [dealsByStage, setDealsByStage] = useState<DealsByStage>(\n    getDealsByStage([], leadStages),\n  );\n\n  useEffect(() => {\n    if (unorderedDeals) {\n      const newDealsByStage = getDealsByStage(unorderedDeals, leadStages);\n      if (!isEqual(newDealsByStage, dealsByStage)) {\n        setDealsByStage(newDealsByStage);\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [unorderedDeals]);\n\n  if (isPending) return null;\n\n  const onDragEnd: OnDragEndResponder = (result) => {\n    const { destination, source } = result;\n\n    if (!destination) {\n      return;\n    }\n\n    if (\n      destination.droppableId === source.droppableId &&\n      destination.index === source.index\n    ) {\n      return;\n    }\n\n    const sourceStage = source.droppableId;\n    const destinationStage = destination.droppableId;\n    const sourceDeal = dealsByStage[sourceStage][source.index]!;\n    const destinationDeal = dealsByStage[destinationStage][\n      destination.index\n    ] ?? {\n      stage: destinationStage,\n      index: undefined, // undefined if dropped after the last item\n    };\n\n    // compute local state change synchronously\n    setDealsByStage(\n      updateDealStageLocal(\n        sourceDeal,\n        { stage: sourceStage, index: source.index },\n        { stage: destinationStage, index: destination.index },\n        dealsByStage,\n      ),\n    );\n\n    // persist the changes\n    updateDealStage(sourceDeal, destinationDeal, dataProvider).then(() => {\n      refetch();\n    });\n  };\n\n  return (\n    <DragDropContext onDragEnd={onDragEnd}>\n      <div \n        className=\"grid gap-4 h-[calc(100vh-14rem)] mt-4\" \n        style={{\n          gridTemplateColumns: `repeat(${leadStages.length}, minmax(0, 1fr))`\n        }}\n      >\n        {leadStages.map((stage) => (\n          <DealColumn\n            stage={stage.value}\n            deals={dealsByStage[stage.value]}\n            key={stage.value}\n          />\n        ))}\n      </div>\n    </DragDropContext>\n  );\n};\n\nconst updateDealStageLocal = (\n  sourceDeal: Deal,\n  source: { stage: string; index: number },\n  destination: {\n    stage: string;\n    index?: number; // undefined if dropped after the last item\n  },\n  dealsByStage: DealsByStage,\n) => {\n  if (source.stage === destination.stage) {\n    // moving deal inside the same column\n    const column = dealsByStage[source.stage];\n    column.splice(source.index, 1);\n    column.splice(destination.index ?? column.length + 1, 0, sourceDeal);\n    return {\n      ...dealsByStage,\n      [destination.stage]: column,\n    };\n  } else {\n    // moving deal across columns\n    const sourceColumn = dealsByStage[source.stage];\n    const destinationColumn = dealsByStage[destination.stage];\n    sourceColumn.splice(source.index, 1);\n    destinationColumn.splice(\n      destination.index ?? destinationColumn.length + 1,\n      0,\n      sourceDeal,\n    );\n    return {\n      ...dealsByStage,\n      [source.stage]: sourceColumn,\n      [destination.stage]: destinationColumn,\n    };\n  }\n};\n\nexport const updateDealStage = async (\n  source: Deal,\n  destination: {\n    stage: string;\n    index?: number; // undefined if dropped after the last item\n  },\n  dataProvider: DataProvider,\n) => {\n  if (source.stage === destination.stage) {\n    // moving deal inside the same column\n    // Fetch all the deals in this stage (because the list may be filtered, but we need to update even non-filtered deals)\n    const { data: columnDeals } = await dataProvider.getList(\"lead-journey\", {\n      sort: { field: \"index\", order: \"ASC\" },\n      // Keep this large so reordering works even with many deals in a stage\n      pagination: { page: 1, perPage: 5000 },\n      filter: { stage: source.stage },\n    });\n    const destinationIndex = destination.index ?? columnDeals.length + 1;\n\n    if (source.index > destinationIndex) {\n      // deal moved up, eg\n      // dest   src\n      //  <------\n      // [4, 7, 23, 5]\n      await Promise.all([\n        // for all deals between destinationIndex and source.index, increase the index\n        ...columnDeals\n          .filter(\n            (deal) =>\n              deal.index >= destinationIndex && deal.index < source.index,\n          )\n          .map((deal) =>\n            dataProvider.update(\"lead-journey\", {\n              id: deal.id,\n              data: { index: deal.index + 1 },\n              previousData: deal,\n            }),\n          ),\n        // for the deal that was moved, update its index\n        dataProvider.update(\"lead-journey\", {\n          id: source.id,\n          data: { index: destinationIndex },\n          previousData: source,\n        }),\n      ]);\n    } else {\n      // deal moved down, e.g\n      // src   dest\n      //  ------>\n      // [4, 7, 23, 5]\n      await Promise.all([\n        // for all deals between source.index and destinationIndex, decrease the index\n        ...columnDeals\n          .filter(\n            (deal) =>\n              deal.index <= destinationIndex && deal.index > source.index,\n          )\n          .map((deal) =>\n            dataProvider.update(\"lead-journey\", {\n              id: deal.id,\n              data: { index: deal.index - 1 },\n              previousData: deal,\n            }),\n          ),\n        // for the deal that was moved, update its index\n        dataProvider.update(\"lead-journey\", {\n          id: source.id,\n          data: { index: destinationIndex },\n          previousData: source,\n        }),\n      ]);\n    }\n  } else {\n    // moving deal across columns\n    // Fetch all the deals in both stages (because the list may be filtered, but we need to update even non-filtered deals)\n    const [{ data: sourceDeals }, { data: destinationDeals }] =\n      await Promise.all([\n        dataProvider.getList(\"lead-journey\", {\n          sort: { field: \"index\", order: \"ASC\" },\n          pagination: { page: 1, perPage: 5000 },\n          filter: { stage: source.stage },\n        }),\n        dataProvider.getList(\"lead-journey\", {\n          sort: { field: \"index\", order: \"ASC\" },\n          pagination: { page: 1, perPage: 5000 },\n          filter: { stage: destination.stage },\n        }),\n      ]);\n    const destinationIndex = destination.index ?? destinationDeals.length + 1;\n\n    await Promise.all([\n      // decrease index on the deals after the source index in the source columns\n      ...sourceDeals\n        .filter((deal) => deal.index > source.index)\n        .map((deal) =>\n          dataProvider.update(\"lead-journey\", {\n            id: deal.id,\n            data: { index: deal.index - 1 },\n            previousData: deal,\n          }),\n        ),\n      // increase index on the deals after the destination index in the destination columns\n      ...destinationDeals\n        .filter((deal) => deal.index >= destinationIndex)\n        .map((deal) =>\n          dataProvider.update(\"lead-journey\", {\n            id: deal.id,\n            data: { index: deal.index + 1 },\n            previousData: deal,\n          }),\n        ),\n      // change the dragged deal to take the destination index and column\n      dataProvider.update(\"lead-journey\", {\n        id: source.id,\n        data: {\n          index: destinationIndex,\n          stage: destination.stage,\n        },\n        previousData: source,\n      }),\n    ]);\n  }\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealList.tsx",
      "content": "import { useGetIdentity, useListContext } from \"ra-core\";\nimport { matchPath, useLocation } from \"react-router\";\nimport { useState } from \"react\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { List } from \"@/components/admin/list\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { Button } from \"@/components/ui/button\";\n\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { DealArchivedList } from \"./DealArchivedList\";\nimport { DealCreate } from \"./DealCreate\";\nimport { DealEdit } from \"./DealEdit\";\nimport { DealEmpty } from \"./DealEmpty\";\nimport { DealListContent } from \"./DealListContent\";\nimport { DealShow } from \"./DealShow\";\nimport { ContactCreateDialog } from \"./ContactCreateDialog\";\nimport {\n  LeadJourneySearchAndFilter,\n  LeadJourneyTopFilter,\n} from \"./LeadJourneyTopFilter\";\n\nconst DealList = () => {\n  const { identity } = useGetIdentity();\n  const [createLeadDialogOpen, setCreateLeadDialogOpen] = useState(false);\n  const [isFilterExpanded, setIsFilterExpanded] = useState(false);\n  const [showArchived, setShowArchived] = useState(false);\n\n  if (!identity) return null;\n\n  const dealFilters = [\n    <ReferenceInput source=\"lead_id\" reference=\"contacts\">\n      <AutocompleteInput\n        label={false}\n        placeholder=\"Lead\"\n        optionText={(choice: any) =>\n          `${choice.first_name} ${choice.last_name || \"\"}`\n        }\n      />\n    </ReferenceInput>,\n  ];\n\n  return (\n    <List\n      // Lead Journey is a kanban board; pagination can hide newly created/imported leads\n      // (e.g. new deals often start with low index values like 0).\n      // Use a large page size so the board reflects the full pipeline.\n      perPage={5000}\n      // If a contact is deleted, the FK sets deals.lead_id to NULL (ON DELETE SET NULL).\n      // We don't want orphaned deals to keep showing as Lead Journey cards.\n      filter={{ \"archived_at@is\": null, \"lead_id@not.is\": null }}\n      title={false}\n      // Lower index = higher priority/top of column (see DealListContent updateDealStage)\n      sort={{ field: \"index\", order: \"ASC\" }}\n      filters={dealFilters}\n      actions={\n        <DealActions\n          onNewLeadClick={() => setCreateLeadDialogOpen(true)}\n          isFilterExpanded={isFilterExpanded}\n          onFilterToggle={() => setIsFilterExpanded(!isFilterExpanded)}\n          onArchivedClick={() => setShowArchived(true)}\n        />\n      }\n      pagination={null}\n    >\n      <DealLayout\n        createLeadDialogOpen={createLeadDialogOpen}\n        setCreateLeadDialogOpen={setCreateLeadDialogOpen}\n        isFilterExpanded={isFilterExpanded}\n        showArchived={showArchived}\n        setShowArchived={setShowArchived}\n      />\n    </List>\n  );\n};\n\nconst DealLayout = ({\n  createLeadDialogOpen,\n  setCreateLeadDialogOpen,\n  isFilterExpanded,\n  showArchived,\n  setShowArchived,\n}: {\n  createLeadDialogOpen: boolean;\n  setCreateLeadDialogOpen: (open: boolean) => void;\n  isFilterExpanded: boolean;\n  showArchived: boolean;\n  setShowArchived: (open: boolean) => void;\n}) => {\n  const location = useLocation();\n  const matchCreate = matchPath(\"/lead-journey/create\", location.pathname);\n  const matchShow = matchPath(\"/lead-journey/:id/show\", location.pathname);\n  const matchEdit = matchPath(\"/lead-journey/:id\", location.pathname);\n\n  const { data, isPending, filterValues } = useListContext();\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  if (isPending) return null;\n  if (!data?.length && !hasFilters)\n    return (\n      <>\n        <DealEmpty>\n          <DealShow open={!!matchShow} id={matchShow?.params.id} />\n          <DealArchivedList open={showArchived} onOpenChange={setShowArchived} />\n        </DealEmpty>\n      </>\n    );\n\n  return (\n    <div className=\"w-full\">\n      <LeadJourneyTopFilter isExpanded={isFilterExpanded} />\n      <DealListContent />\n      <DealArchivedList open={showArchived} onOpenChange={setShowArchived} />\n      <DealCreate open={!!matchCreate} />\n      <DealEdit open={!!matchEdit && !matchCreate} id={matchEdit?.params.id} />\n      <DealShow open={!!matchShow} id={matchShow?.params.id} />\n      <ContactCreateDialog\n        open={createLeadDialogOpen}\n        onOpenChange={setCreateLeadDialogOpen}\n      />\n    </div>\n  );\n};\n\nconst DealActions = ({\n  onNewLeadClick,\n  isFilterExpanded,\n  onFilterToggle,\n  onArchivedClick,\n}: {\n  onNewLeadClick: () => void;\n  isFilterExpanded: boolean;\n  onFilterToggle: () => void;\n  onArchivedClick: () => void;\n}) => (\n  <TopToolbar className=\"flex items-center gap-4 w-full\">\n    <LeadJourneySearchAndFilter\n      isFilterExpanded={isFilterExpanded}\n      onFilterToggle={onFilterToggle}\n    />\n    <div className=\"ml-auto flex items-center gap-2\">\n      <Button variant=\"outline\" onClick={onArchivedClick}>\n        Archived\n      </Button>\n      <Button onClick={onNewLeadClick}>New Lead</Button>\n    </div>\n  </TopToolbar>\n);\n\nexport default DealList;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealInputs.tsx",
      "content": "import { required } from \"ra-core\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\n\nimport { contactOptionText } from \"../misc/ContactOption\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const DealInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-8\">\n      <DealInfoInputs />\n      <LeadReferenceInput />\n      <StageInput />\n    </div>\n  );\n};\n\nconst DealInfoInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4 flex-1\">\n      <div className=\"grid grid-cols-2 gap-4\">\n        <TextInput\n          source=\"first_name\"\n          label=\"First Name\"\n          helperText={false}\n        />\n        <TextInput\n          source=\"last_name\"\n          label=\"Last Name\"\n          helperText={false}\n        />\n      </div>\n    </div>\n  );\n};\n\nconst LeadReferenceInput = () => {\n  return (\n    <div className=\"flex flex-col gap-4 flex-1\">\n      <h3 className=\"text-base font-medium\">Linked to Lead</h3>\n      <ReferenceInput source=\"lead_id\" reference=\"contacts\">\n        <AutocompleteInput \n          label=\"Lead\"\n          optionText={contactOptionText}\n          validate={required()} \n        />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst StageInput = () => {\n  const { leadStages } = useConfigurationContext();\n  return (\n    <div className=\"flex flex-col gap-4 flex-1\">\n      <h3 className=\"text-base font-medium\">Stage</h3>\n      <SelectInput\n        source=\"stage\"\n        choices={leadStages.map((stage) => ({\n          id: stage.value,\n          name: stage.label,\n        }))}\n        defaultValue=\"new\"\n        helperText={false}\n        validate={required()}\n      />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealEmpty.tsx",
      "content": "import { useGetList } from \"ra-core\";\nimport { matchPath, useLocation, Link } from \"react-router\";\nimport type { ReactNode } from \"react\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { Progress } from \"@/components/ui/progress\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\nimport type { Contact } from \"../types\";\nimport { DealCreate } from \"./DealCreate\";\n\nexport const DealEmpty = ({ children }: { children?: ReactNode }) => {\n  const location = useLocation();\n  const matchCreate = matchPath(\"/lead-journey/create\", location.pathname);\n  const appbarHeight = useAppBarHeight();\n\n  // get Contact data\n  const { data: contacts, isPending: contactsLoading } = useGetList<Contact>(\n    \"contacts\",\n    {\n      pagination: { page: 1, perPage: 1 },\n    },\n  );\n\n  if (contactsLoading) return <Progress value={50} />;\n\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-12\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No lead statuses found\" />\n      {contacts && contacts.length > 0 ? (\n        <>\n          <div className=\"flex flex-col items-center gap-0\">\n            <h3 className=\"text-lg font-bold\">No lead statuses found</h3>\n            <p className=\"text-sm text-center text-muted-foreground mb-4\">\n              It seems your lead journey is empty.\n            </p>\n          </div>\n          <div className=\"flex space-x-8\">\n            <CreateButton label=\"Create Lead Status\" />\n          </div>\n          <DealCreate open={!!matchCreate} />\n          {children}\n        </>\n      ) : (\n        <div className=\"flex flex-col items-center gap-0\">\n          <h3 className=\"text-lg font-bold\">No lead statuses found</h3>\n          <p className=\"text-sm text-center text-muted-foreground mb-4\">\n            It seems your leads list is empty.\n            <br />\n            <Link to=\"/contacts/create\" className=\"hover:underline\">\n              Add your first lead\n            </Link>{\" \"}\n            before creating a lead status.\n          </p>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealEdit.tsx",
      "content": "import {\n  EditBase,\n  Form,\n  useNotify,\n  useRecordContext,\n  useRedirect,\n} from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\n\nimport { FormToolbar } from \"../layout/FormToolbar\";\nimport type { Deal } from \"../types\";\nimport { DealInputs } from \"./DealInputs\";\n\nexport const DealEdit = ({ open, id }: { open: boolean; id?: string }) => {\n  const redirect = useRedirect();\n  const notify = useNotify();\n\n  const handleClose = () => {\n    redirect(\"/lead-journey\", undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={() => handleClose()}>\n      <DialogContent className=\"lg:max-w-4xl p-4 overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        {id ? (\n          <EditBase\n            id={id}\n            mutationMode=\"pessimistic\"\n            mutationOptions={{\n              onSuccess: () => {\n                notify(\"Deal updated\");\n                redirect(`/lead-journey/${id}/show`, undefined, undefined, undefined, {\n                  _scrollToTop: false,\n                });\n              },\n            }}\n          >\n            <EditHeader />\n            <DialogDescription className=\"sr-only\">Edit deal information</DialogDescription>\n            <Form>\n              <DealInputs />\n              <FormToolbar />\n            </Form>\n          </EditBase>\n        ) : null}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nfunction EditHeader() {\n  const deal = useRecordContext<Deal>();\n  if (!deal) {\n    return null;\n  }\n\n  return (\n    <DialogTitle className=\"pb-0\">\n      <div className=\"flex justify-between items-start mb-8\">\n        <div className=\"flex items-center gap-4\">\n          <h2 className=\"text-2xl font-semibold\">\n            Edit {deal.first_name || deal.last_name\n              ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n              : deal.name || \"New Lead\"} deal\n          </h2>\n        </div>\n        <div className=\"flex gap-2 pr-12\">\n          <DeleteButton />\n          <Button asChild variant=\"outline\" className=\"h-9\">\n            <Link to={`/lead-journey/${deal.id}/show`}>Back to deal</Link>\n          </Button>\n        </div>\n      </div>\n    </DialogTitle>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealCreate.tsx",
      "content": "import { useQueryClient } from \"@tanstack/react-query\";\nimport {\n  Form,\n  useDataProvider,\n  useGetIdentity,\n  useListContext,\n  useRedirect,\n  type GetListResult,\n} from \"ra-core\";\nimport { Create } from \"@/components/admin/create\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Dialog, DialogContent, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\n\nimport type { Deal } from \"../types\";\nimport { DealInputs } from \"./DealInputs\";\n\nexport const DealCreate = ({ open }: { open: boolean }) => {\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const { data: allDeals } = useListContext<Deal>();\n\n  const handleClose = () => {\n    redirect(\"/lead-journey\");\n  };\n\n  const queryClient = useQueryClient();\n\n  const onSuccess = async (deal: Deal) => {\n    if (!allDeals) {\n      redirect(\"/lead-journey\");\n      return;\n    }\n    // increase the index of all deals in the same stage as the new deal\n    // first, get the list of deals in the same stage\n    const deals = allDeals.filter(\n      (d: Deal) => d.stage === deal.stage && d.id !== deal.id,\n    );\n    // update the actual deals in the database\n    await Promise.all(\n      deals.map(async (oldDeal) =>\n        dataProvider.update(\"lead-journey\", {\n          id: oldDeal.id,\n          data: { index: oldDeal.index + 1 },\n          previousData: oldDeal,\n        }),\n      ),\n    );\n    // refresh the list of deals in the cache as we used dataProvider.update(),\n    // which does not update the cache\n    const dealsById = deals.reduce(\n      (acc, d) => ({\n        ...acc,\n        [d.id]: { ...d, index: d.index + 1 },\n      }),\n      {} as { [key: string]: Deal },\n    );\n    const now = Date.now();\n    queryClient.setQueriesData<GetListResult | undefined>(\n      { queryKey: [\"lead-journey\", \"getList\"] },\n      (res) => {\n        if (!res) return res;\n        return {\n          ...res,\n          data: res.data.map((d: Deal) => dealsById[d.id] || d),\n        };\n      },\n      { updatedAt: now },\n    );\n    redirect(\"/lead-journey\");\n  };\n\n  const { identity } = useGetIdentity();\n\n  return (\n    <Dialog open={open} onOpenChange={() => handleClose()}>\n      <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        <DialogTitle className=\"sr-only\">Create New Deal</DialogTitle>\n        <DialogDescription className=\"sr-only\">Create a new deal in the lead journey</DialogDescription>\n        <Create resource=\"lead-journey\" mutationOptions={{ onSuccess }}>\n          <Form\n            defaultValues={{\n              sales_id: identity?.id,\n              contact_ids: [],\n              index: 0,\n            }}\n          >\n            <DealInputs />\n            <FormToolbar>\n              <SaveButton />\n            </FormToolbar>\n          </Form>\n        </Create>\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealColumn.tsx",
      "content": "import { Droppable } from \"@hello-pangea/dnd\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\nimport { findDealLabel } from \"./deal\";\nimport { DealCard } from \"./DealCard\";\n\nexport const DealColumn = ({\n  stage,\n  deals,\n}: {\n  stage: string;\n  deals: Deal[];\n}) => {\n  const leadCount = deals.length;\n  const { leadStages } = useConfigurationContext();\n  \n  return (\n    <div className=\"flex flex-col h-full min-w-0\">\n      <Card className=\"flex flex-col h-full gap-0 border-border/50 shadow-sm bg-card\">\n        <CardHeader className=\"flex-shrink-0 pb-2.5 px-4 pt-3 border-b border-border/50\">\n          <CardTitle className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n            <span className=\"truncate\">{findDealLabel(leadStages, stage)}</span>\n            {leadCount > 0 && (\n              <span className=\"text-xs font-medium text-foreground bg-muted px-1.5 py-0.5 rounded flex-shrink-0\">\n                {leadCount}\n              </span>\n            )}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex-1 overflow-y-auto min-h-0 p-2 bg-muted/20\">\n          <Droppable droppableId={stage}>\n            {(droppableProvided, snapshot) => (\n              <div\n                ref={droppableProvided.innerRef}\n                {...droppableProvided.droppableProps}\n                // Don't force height - let content determine height so scroll works\n                className={`flex flex-col gap-2 min-h-[150px] ${\n                  snapshot.isDraggingOver ? \"bg-muted/50 rounded-lg transition-colors\" : \"\"\n                }`}\n              >\n                {deals.map((deal, index) => (\n                  <DealCard key={deal.id} deal={deal} index={index} />\n                ))}\n                {droppableProvided.placeholder}\n              </div>\n            )}\n          </Droppable>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealCard.tsx",
      "content": "import { Draggable } from \"@hello-pangea/dnd\";\nimport { useGetOne, useRedirect, useDataProvider, useRefresh, useNotify } from \"ra-core\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  ContextMenu,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuTrigger,\n} from \"@/components/ui/context-menu\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal, Contact } from \"../types\";\nimport { updateDealStage } from \"./DealListContent\";\nimport { findDealLabel } from \"./deal\";\n\nexport const DealCard = ({ deal, index }: { deal: Deal; index: number }) => {\n  if (!deal) return null;\n\n  return (\n    <Draggable draggableId={String(deal.id)} index={index}>\n      {(provided, snapshot) => (\n        <DealCardContent provided={provided} snapshot={snapshot} deal={deal} />\n      )}\n    </Draggable>\n  );\n};\n\nexport const DealCardContent = ({\n  provided,\n  snapshot,\n  deal,\n}: {\n  provided?: any;\n  snapshot?: any;\n  deal: Deal;\n}) => {\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const refresh = useRefresh();\n  const notify = useNotify();\n  const { leadStages } = useConfigurationContext();\n  \n  // Fetch the lead (contact) associated with this deal\n  const { data: lead } = useGetOne<Contact>(\n    \"contacts\",\n    { id: deal.lead_id },\n    { enabled: !!deal.lead_id },\n  );\n\n  const handleClick = () => {\n    redirect(`/lead-journey/${deal.id}/show`, undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  const handleMoveTo = (stageValue: string) => {\n    updateDealStage(\n      deal,\n      { stage: stageValue, index: undefined },\n      dataProvider\n    )\n    .then(() => {\n        notify(\"Deal moved\", { type: \"success\" });\n        refresh();\n    })\n    .catch((error) => {\n        notify(`Error moving deal: ${error.message}`, { type: \"error\" });\n    });\n  };\n\n  const handleArchive = () => {\n    dataProvider.update(\"lead-journey\", {\n        id: deal.id,\n        data: { archived_at: new Date().toISOString() },\n        previousData: deal\n    })\n    .then(() => {\n        notify(\"Deal archived\", { type: \"success\" });\n        refresh();\n    })\n    .catch((error) => {\n        notify(`Error archiving deal: ${error.message}`, { type: \"error\" });\n    });\n  };\n\n  const handleEditContact = () => {\n     if (deal.lead_id) {\n         redirect(`/contacts/${deal.lead_id}`);\n     }\n  };\n\n  if (!lead && !deal.lead_id) {\n    // Fallback if no lead is associated\n    return (\n      <div\n        className=\"cursor-pointer\"\n        {...provided?.draggableProps}\n        {...provided?.dragHandleProps}\n        ref={provided?.innerRef}\n        onClick={handleClick}\n      >\n        <ContextMenu>\n          <ContextMenuTrigger>\n            <Card\n              className={`py-4 transition-all duration-200 ${\n                snapshot?.isDragging\n                  ? \"opacity-90 transform rotate-1 shadow-lg\"\n                  : \"shadow-sm hover:shadow-md\"\n              }`}\n            >\n              <CardContent className=\"px-4 flex\">\n                <div>\n                  <p className=\"text-sm font-medium mb-2\">\n                    {deal.first_name || deal.last_name\n                      ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                      : deal.name || \"New Lead\"}\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </ContextMenuTrigger>\n          <ContextMenuContent>\n            <ContextMenuSub>\n              <ContextMenuSubTrigger>Move to</ContextMenuSubTrigger>\n              <ContextMenuSubContent>\n                {leadStages\n                  .filter((stage) => stage.value !== deal.stage)\n                  .map((stage) => (\n                    <ContextMenuItem\n                      key={stage.value}\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        handleMoveTo(stage.value);\n                      }}\n                    >\n                      {stage.label}\n                    </ContextMenuItem>\n                  ))}\n              </ContextMenuSubContent>\n            </ContextMenuSub>\n            <ContextMenuItem onClick={(e) => {\n                e.stopPropagation();\n                handleArchive();\n            }}>\n              Archive\n            </ContextMenuItem>\n          </ContextMenuContent>\n        </ContextMenu>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      className=\"cursor-pointer\"\n      {...provided?.draggableProps}\n      {...provided?.dragHandleProps}\n      ref={provided?.innerRef}\n      onClick={handleClick}\n    >\n      <ContextMenu>\n        <ContextMenuTrigger>\n          <Card\n            className={`py-4 transition-all duration-200 ${\n              snapshot?.isDragging\n                ? \"opacity-90 transform rotate-1 shadow-lg\"\n                : \"shadow-sm hover:shadow-md\"\n            }`}\n          >\n            <CardContent className=\"px-4 flex\">\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-sm font-medium mb-1\">\n                  {lead\n                    ? `${lead.first_name ?? \"\"} ${lead.last_name ?? \"\"}`.trim() || \"New Lead\"\n                    : deal.first_name || deal.last_name\n                    ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                    : deal.name || \"New Lead\"}\n                </p>\n                {lead?.description && (\n                  <p className=\"text-xs text-muted-foreground line-clamp-2\">\n                    {lead.description}\n                  </p>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </ContextMenuTrigger>\n        <ContextMenuContent>\n          <ContextMenuSub>\n            <ContextMenuSubTrigger>Move to</ContextMenuSubTrigger>\n            <ContextMenuSubContent>\n              {leadStages\n                .filter((stage) => stage.value !== deal.stage)\n                .map((stage) => (\n                  <ContextMenuItem\n                    key={stage.value}\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      handleMoveTo(stage.value);\n                    }}\n                  >\n                    {stage.label}\n                  </ContextMenuItem>\n                ))}\n            </ContextMenuSubContent>\n          </ContextMenuSub>\n          <ContextMenuItem onClick={(e) => {\n              e.stopPropagation();\n              handleArchive();\n          }}>\n            Archive\n          </ContextMenuItem>\n          {deal.lead_id && (\n             <ContextMenuItem onClick={(e) => {\n                e.stopPropagation();\n                handleEditContact();\n             }}>\n                Edit Contact\n             </ContextMenuItem>\n          )}\n        </ContextMenuContent>\n      </ContextMenu>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealArchivedList.tsx",
      "content": "/* eslint-disable react-refresh/only-export-components */\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { useEffect, useState, useMemo } from \"react\";\nimport { useGetOne, useRedirect } from \"ra-core\";\nimport { Dialog, DialogContent, DialogDescription, DialogTitle } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Search } from \"lucide-react\";\n\nimport type { Deal, Contact } from \"../types\";\nimport { formatCrmDate } from \"../misc/timezone\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { findDealLabel } from \"./deal\";\n\ninterface DealArchivedListProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport const DealArchivedList = ({ open, onOpenChange }: DealArchivedListProps) => {\n  const { identity } = useGetIdentity();\n  const { leadStages } = useConfigurationContext();\n  const {\n    data: archivedLists,\n    total,\n    isPending,\n  } = useGetList(\"lead-journey\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"archived_at\", order: \"DESC\" },\n    filter: { \"archived_at@not.is\": null },\n  });\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  // Fetch all leads for search - must be called before any conditional returns\n  const { data: allLeads } = useGetList(\"contacts\", {\n    pagination: { page: 1, perPage: 10000 },\n    sort: { field: \"id\", order: \"ASC\" },\n  }, { enabled: !!archivedLists && archivedLists.length > 0 });\n\n  useEffect(() => {\n    if (!isPending && total === 0) {\n      onOpenChange(false);\n    }\n  }, [isPending, total, onOpenChange]);\n\n  useEffect(() => {\n    // We don't want to close the dialog just because the list updates\n  }, [archivedLists]);\n\n  // Create a map of lead_id to lead name for quick lookup - must be called before conditional return\n  const leadNameMap = useMemo(() => {\n    if (!allLeads) return new Map();\n    const map = new Map();\n    allLeads.forEach((lead: any) => {\n      const fullName = `${lead.first_name || \"\"} ${lead.last_name || \"\"}`.trim();\n      if (fullName) {\n        map.set(lead.id, fullName);\n      }\n    });\n    return map;\n  }, [allLeads]);\n\n  // Filter deals by search query - must be called before conditional return\n  const filteredDeals = useMemo(() => {\n    if (!archivedLists || !searchQuery.trim()) return archivedLists || [];\n    \n    const query = searchQuery.toLowerCase();\n    return archivedLists.filter((deal: Deal) => {\n      const dealFirstName = deal.first_name?.toLowerCase() || \"\";\n      const dealLastName = deal.last_name?.toLowerCase() || \"\";\n      const dealName = deal.name?.toLowerCase() || \"\";\n      const dealFullName = `${dealFirstName} ${dealLastName}`.trim().toLowerCase();\n      const leadName = deal.lead_id ? leadNameMap.get(deal.lead_id)?.toLowerCase() : \"\";\n      return dealFullName.includes(query) || dealName.includes(query) || leadName?.includes(query);\n    });\n  }, [archivedLists, searchQuery, leadNameMap]);\n\n  // Group filtered archived lists by date - must be called before conditional return\n  const archivedListsByDate: { [date: string]: Deal[] } = useMemo(() => {\n    if (!filteredDeals || filteredDeals.length === 0) return {};\n    return filteredDeals.reduce(\n      (acc, deal) => {\n        const date = new Date(deal.archived_at).toDateString();\n        if (!acc[date]) {\n          acc[date] = [];\n        }\n        acc[date].push(deal);\n        return acc;\n      },\n      {} as { [date: string]: Deal[] },\n    );\n  }, [filteredDeals]);\n\n  if (!identity || isPending || !total || !archivedLists) return null;\n\n  return (\n    <div className=\"w-full flex flex-row items-center justify-center\">\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n          <DialogTitle>Archived Lead Journey</DialogTitle>\n          <DialogDescription>\n            View and search through archived lead journeys\n          </DialogDescription>\n          <div className=\"flex flex-col gap-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4\" />\n              <Input\n                type=\"text\"\n                placeholder=\"Search archived leads...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n              />\n            </div>\n            {Object.keys(archivedListsByDate).length === 0 ? (\n              <div className=\"text-center text-muted-foreground py-8\">\n                No archived leads found\n              </div>\n            ) : (\n              <div className=\"flex flex-col gap-8\">\n                {Object.entries(archivedListsByDate).map(([date, deals]) => (\n                  <div key={date} className=\"flex flex-col gap-4\">\n                    <h4 className=\"font-bold\">{getRelativeTimeString(date)}</h4>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8\">\n                      {deals.map((deal: Deal) => (\n                        <div key={deal.id}>\n                          <ArchivedDealCard deal={deal} leadStages={leadStages} />\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n};\n\nexport function getRelativeTimeString(dateString: string): string {\n  const date = new Date(dateString);\n  date.setHours(0, 0, 0, 0);\n\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const diff = date.getTime() - today.getTime();\n  const unitDiff = Math.round(diff / (1000 * 60 * 60 * 24));\n\n  // Check if the date is more than one week old\n  if (Math.abs(unitDiff) > 7) {\n    return formatCrmDate(date);\n  }\n\n  // Intl.RelativeTimeFormat for dates within the last week\n  const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: \"auto\" });\n  return ucFirst(rtf.format(unitDiff, \"day\"));\n}\n\nfunction ucFirst(str: string): string {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nconst ArchivedDealCard = ({ deal, leadStages }: { deal: Deal; leadStages: any[] }) => {\n  const redirect = useRedirect();\n  const stageLabel = deal.stage === \"converted\" \n    ? \"Client\" \n    : findDealLabel(leadStages, deal.stage) || deal.stage;\n  \n  const archivedDate = deal.archived_at ? formatCrmDate(deal.archived_at) : null;\n  \n  // Fetch the lead (contact) associated with this deal\n  const { data: lead } = useGetOne<Contact>(\n    \"contacts\",\n    { id: deal.lead_id },\n    { enabled: !!deal.lead_id },\n  );\n\n  const handleClick = () => {\n    redirect(`/lead-journey/${deal.id}/show`, undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  return (\n    <div\n      className=\"cursor-pointer\"\n      onClick={handleClick}\n    >\n      <Card className=\"py-4 transition-all duration-200 shadow-sm hover:shadow-md\">\n        <CardContent className=\"px-4 flex\">\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-medium mb-1\">\n              {lead\n                ? `${lead.first_name} ${lead.last_name || \"\"}`.trim()\n                : deal.first_name || deal.last_name\n                ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                : deal.name || \"New Lead\"}\n            </p>\n            {lead?.description && (\n              <p className=\"text-xs text-muted-foreground line-clamp-2\">\n                {lead.description}\n              </p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/ContactList.tsx",
      "content": "import { useListContext } from \"ra-core\";\nimport { Link as RouterLink } from \"react-router\";\n\nexport const ContactList = () => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error) return <div className=\"h-8\" />;\n  return (\n    <div className=\"flex flex-row flex-wrap gap-4 mt-4\">\n      {data.map((contact) => (\n        <div className=\"flex flex-row gap-4 items-center\" key={contact.id}>\n          <div className=\"flex flex-col\">\n            <RouterLink\n              to={`/contacts/${contact.id}/show`}\n              className=\"text-sm hover:underline\"\n            >\n              {contact.first_name} {contact.last_name}\n            </RouterLink>\n            <span className=\"text-xs text-muted-foreground\">\n              {contact.title}\n              {contact.title && contact.company_name && \" at \"}\n              {contact.company_name}\n            </span>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/ContactCreateDialog.tsx",
      "content": "import {\n  CreateBase,\n  Form,\n  useDataProvider,\n  useGetIdentity,\n  useRedirect,\n  useRefresh,\n} from \"ra-core\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\n\nimport type { Contact } from \"../types\";\nimport { LeadInputs } from \"../contacts/LeadInputs\";\nimport { createLeadJourneyDealForContact } from \"./createLeadJourneyDeal\";\n\nexport const ContactCreateDialog = ({ \n  open, \n  onOpenChange \n}: { \n  open: boolean;\n  onOpenChange?: (open: boolean) => void;\n}) => {\n  const { identity } = useGetIdentity();\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const refresh = useRefresh();\n\n  const handleClose = () => {\n    if (onOpenChange) {\n      onOpenChange(false);\n    } else {\n      redirect(\"/lead-journey\");\n    }\n  };\n\n  const handleSuccess = async (data: Contact) => {\n    try {\n      await createLeadJourneyDealForContact(dataProvider, data, identity?.id);\n\n      // Force refresh of the lead journey list\n      refresh();\n      \n      // Small delay to ensure the backend has processed the creation\n      setTimeout(() => {\n        refresh();\n        handleClose();\n      }, 100);\n    } catch (error) {\n      console.error(\"Error creating lead-journey entry:\", error);\n      // Still refresh and close even if lead-journey creation fails\n      refresh();\n      handleClose();\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={(open) => {\n      if (!open) {\n        handleClose();\n      } else if (onOpenChange) {\n        onOpenChange(open);\n      }\n    }}>\n      <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        <DialogTitle className=\"sr-only\">Create New Contact</DialogTitle>\n        <DialogDescription className=\"sr-only\">Create a new contact and lead</DialogDescription>\n        <CreateBase\n          resource=\"contacts\"\n          redirect={false}\n          transform={(data: Contact) => ({\n            ...data,\n            first_seen: new Date().toISOString(),\n            last_seen: new Date().toISOString(),\n            tags: [],\n            services_interested: data.services_interested || [],\n          })}\n          mutationOptions={{\n            onSuccess: handleSuccess,\n          }}\n        >\n          <Form\n            defaultValues={{\n              sales_id: identity?.id,\n              phone_has_whatsapp: false,\n              services_interested: [],\n            }}\n          >\n            <Card>\n              <CardContent>\n                <LeadInputs />\n                <FormToolbar>\n                  <SaveButton />\n                </FormToolbar>\n              </CardContent>\n            </Card>\n          </Form>\n        </CreateBase>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/Welcome.tsx",
      "content": "import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nexport const Welcome = () => (\n  <Card>\n    <CardHeader className=\"px-4\">\n      <CardTitle>Your CRM Starter Kit</CardTitle>\n    </CardHeader>\n    <CardContent className=\"px-4\">\n      <p className=\"text-sm mb-4\">\n        <b>BestDOC CRM</b> helps you manage leads, clients, tasks, and notes.\n      </p>\n      <p className=\"text-sm mb-4\">\n        This demo runs on a mock API, so you can explore and modify the data. It\n        resets on reload. The full version uses Supabase for the backend.\n      </p>\n      <p className=\"text-sm text-muted-foreground\">\n        Tip: connect Supabase to persist data across reloads.\n      </p>\n    </CardContent>\n  </Card>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/TasksListFilter.tsx",
      "content": "import {\n  ListContextProvider,\n  ResourceContextProvider,\n  useGetIdentity,\n  useGetList,\n  useList,\n} from \"ra-core\";\n\nimport { TasksIterator } from \"../tasks/TasksIterator\";\n\nexport const TasksListFilter = ({\n  title,\n  filter,\n}: {\n  title: string;\n  filter: any;\n}) => {\n  const { identity } = useGetIdentity();\n\n  const {\n    data: tasks,\n    total,\n    isPending,\n  } = useGetList(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 100 },\n      sort: { field: \"due_date\", order: \"ASC\" },\n      filter: {\n        ...filter,\n        sales_id: identity?.id,\n      },\n    },\n    { enabled: !!identity },\n  );\n\n  const listContext = useList({\n    data: tasks,\n    isPending,\n    resource: \"tasks\",\n    perPage: 5,\n  });\n\n  if (isPending || !tasks || !total) return null;\n\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium mb-2\">\n        {title}\n      </p>\n      <ResourceContextProvider value=\"tasks\">\n        <ListContextProvider value={listContext}>\n          <TasksIterator showContact />\n        </ListContextProvider>\n      </ResourceContextProvider>\n      {total > listContext.perPage && (\n        <div className=\"flex justify-center\">\n          <a\n            href=\"#\"\n            onClick={(e) => {\n              listContext.setPerPage(listContext.perPage + 10);\n              e.preventDefault();\n            }}\n            className=\"text-sm underline hover:no-underline\"\n          >\n            Load more\n          </a>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/TasksListEmpty.tsx",
      "content": "import { useGetIdentity, useGetList } from \"ra-core\";\n\nexport const TasksListEmpty = () => {\n  const { identity } = useGetIdentity();\n\n  const { total } = useGetList(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 1 },\n      filter: {\n        sales_id: identity?.id,\n      },\n    },\n    { enabled: !!identity },\n  );\n\n  if (total) return null;\n\n  return (\n    <p className=\"text-sm\">Tasks added to your contacts will appear here.</p>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/TasksList.tsx",
      "content": "import { CheckSquare } from \"lucide-react\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { AddTask } from \"../tasks/AddTask\";\nimport { TasksListEmpty } from \"./TasksListEmpty\";\nimport { TasksListFilter } from \"./TasksListFilter\";\nimport {\n  crmAddDays,\n  crmDayOfWeek,\n  crmEndOfDay,\n  crmEndOfWeek,\n  crmStartOfDay,\n} from \"../misc/timezone\";\n\nconst startOfTodayDate = crmStartOfDay();\nconst endOfTodayDate = crmEndOfDay();\nconst endOfTomorrowDate = crmEndOfDay(crmAddDays(new Date(), 1));\nconst endOfWeekDate = crmEndOfWeek();\n\nconst todayDayOfWeek = crmDayOfWeek();\nconst isBeforeFriday =\n  todayDayOfWeek !== undefined ? todayDayOfWeek < 5 : new Date().getUTCDay() < 5; // Friday is 5\nconst startOfTodayDateISO = (startOfTodayDate ?? new Date()).toISOString();\nconst endOfTodayDateISO = (endOfTodayDate ?? new Date()).toISOString();\nconst endOfTomorrowDateISO = (endOfTomorrowDate ?? new Date()).toISOString();\nconst endOfWeekDateISO = (endOfWeekDate ?? new Date()).toISOString();\n\nconst taskFilters = {\n  overdue: { \"done_date@is\": null, \"due_date@lt\": startOfTodayDateISO },\n  today: {\n    \"done_date@is\": null,\n    \"due_date@gte\": startOfTodayDateISO,\n    \"due_date@lte\": endOfTodayDateISO,\n  },\n  tomorrow: {\n    \"done_date@is\": null,\n    \"due_date@gt\": endOfTodayDateISO,\n    \"due_date@lt\": endOfTomorrowDateISO,\n  },\n  thisWeek: {\n    \"done_date@is\": null,\n    \"due_date@gte\": endOfTomorrowDateISO,\n    \"due_date@lte\": endOfWeekDateISO,\n  },\n  later: { \"done_date@is\": null, \"due_date@gt\": endOfWeekDateISO },\n};\n\nexport const TasksList = () => {\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <div className=\"flex items-center\">\n        <div className=\"mr-3 flex\">\n          <CheckSquare className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground flex-1\">\n          Upcoming Tasks\n        </h2>\n        <AddTask display=\"icon\" selectContact />\n      </div>\n      <Card className=\"p-4 mb-2\">\n        <div className=\"flex flex-col gap-4\">\n          <TasksListEmpty />\n          <TasksListFilter title=\"Overdue\" filter={taskFilters.overdue} />\n          <TasksListFilter title=\"Today\" filter={taskFilters.today} />\n          <TasksListFilter title=\"Tomorrow\" filter={taskFilters.tomorrow} />\n          {isBeforeFriday && (\n            <TasksListFilter title=\"This week\" filter={taskFilters.thisWeek} />\n          )}\n          <TasksListFilter title=\"Later\" filter={taskFilters.later} />\n        </div>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/RecentLeads.tsx",
      "content": "import { Plus, Users } from \"lucide-react\";\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\nimport { SimpleList } from \"../simple-list/SimpleList\";\nimport type { Contact } from \"../types\";\n\nimport { RelativeDate } from \"../misc/RelativeDate\";\n\nexport const RecentLeads = () => {\n  const { identity } = useGetIdentity();\n  const {\n    data: contactData,\n    total: contactTotal,\n    isPending: contactsLoading,\n  } = useGetList<Contact>(\n    \"contacts\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"last_seen\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <div className=\"flex items-center\">\n        <div className=\"mr-3 flex\">\n          <Users className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          Recent Leads\n        </h2>\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"ml-auto text-muted-foreground\"\n                asChild\n              >\n                <Link to=\"/contacts/create\">\n                  <Plus className=\"w-4 h-4 text-primary\" />\n                </Link>\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>Create contact</TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      </div>\n      <Card className=\"py-0\">\n        <SimpleList<Contact>\n          linkType=\"show\"\n          data={contactData}\n          total={contactTotal}\n          isPending={contactsLoading}\n          resource=\"contacts\"\n          className=\"[&>li:first-child>a]:rounded-t-xl [&>li:last-child>a]:rounded-b-xl\"\n          primaryText={(contact) =>\n            `${contact.first_name} ${contact.last_name || \"\"}`\n          }\n          secondaryText={(contact) => (\n            <>\n              {contact.title ? `${contact.title} at ` : \"\"}\n              {contact.company_name}\n            </>\n          )}\n          tertiaryText={(contact) => (\n            <RelativeDate date={contact.last_seen} />\n          )}\n          empty={\n            <div className=\"p-4\">\n              <p className=\"text-sm\">\n                No recent leads found.\n              </p>\n            </div>\n          }\n        />\n      </Card>\n    </div>\n  );\n};\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/PackagesExpiringSoon.tsx",
      "content": "import { useGetList } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Link } from \"react-router\";\nimport { Calendar, AlertCircle } from \"lucide-react\";\nimport type { PaymentPackage } from \"../types\";\nimport { crmAddDays, crmToday } from \"../misc/timezone\";\n\nexport const PackagesExpiringSoon = () => {\n  const today = crmToday();\n  const sevenDaysFromNow = crmAddDays(today, 7);\n  \n  const { data: packages, isLoading, error } = useGetList<PaymentPackage>(\"payment_packages\", {\n    pagination: { page: 1, perPage: 100 },\n    filter: {\n      status: \"active\",\n      \"renewal_date@gte\": today?.toISOString().split(\"T\")[0],\n      \"renewal_date@lte\": sevenDaysFromNow?.toISOString().split(\"T\")[0],\n    },\n    sort: { field: \"renewal_date\", order: \"ASC\" },\n  }, {\n    retry: false,\n    onError: (err) => {\n      console.warn(\"Error fetching expiring packages:\", err);\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\n            <Calendar className=\"w-4 h-4\" />\n            Packages Expiring Soon\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-sm text-muted-foreground\">Loading...</div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (error) {\n    return null; // Silently fail if there's an error\n  }\n\n  const expiringCount = packages?.length || 0;\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\n          <Calendar className=\"w-4 h-4\" />\n          Packages Expiring Soon\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        {expiringCount > 0 ? (\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <div className=\"text-2xl font-bold\">{expiringCount}</div>\n                <div className=\"text-xs text-muted-foreground\">\n                  expiring in 7 days\n                </div>\n              </div>\n              <Badge variant=\"outline\" className=\"bg-yellow-50 text-yellow-700 border-yellow-200\">\n                <AlertCircle className=\"w-3 h-3 mr-1\" />\n                Action Needed\n              </Badge>\n            </div>\n            <Link to=\"/payment_packages?filter[status]=active&filter[renewal_date@lte]=7days\">\n              <Button variant=\"outline\" size=\"sm\" className=\"w-full cursor-pointer\">\n                View All Expiring\n              </Button>\n            </Link>\n            {packages && packages.length > 0 && (\n              <div className=\"space-y-2 mt-3\">\n                {packages.slice(0, 3).map((pkg) => (\n                  <Link\n                    key={pkg.id}\n                    to={`/payment_packages/${pkg.id}/show`}\n                    className=\"block p-2 rounded-lg border hover:bg-accent transition-colors\"\n                  >\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"text-sm font-medium\">\n                        Package #{pkg.id}\n                      </div>\n                      {pkg.renewal_date && (\n                        <div className=\"text-xs text-muted-foreground\">\n                          {new Date(pkg.renewal_date).toLocaleDateString()}\n                        </div>\n                      )}\n                    </div>\n                  </Link>\n                ))}\n                {packages.length > 3 && (\n                  <div className=\"text-xs text-muted-foreground text-center pt-1\">\n                    +{packages.length - 3} more\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n        ) : (\n          <div className=\"text-sm text-muted-foreground\">\n            No packages expiring in the next 7 days\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/OverdueInstallments.tsx",
      "content": "import { useDataProvider } from \"ra-core\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"react-router\";\nimport { AlertCircle } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport type { CrmDataProvider } from \"../providers/types\";\n\nexport const OverdueInstallments = () => {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n\n  const { data, isLoading, error } = useQuery({\n    queryKey: [\"overdueInstallments\"],\n    queryFn: async () => {\n      try {\n        return await dataProvider.getOverdueInstallments();\n      } catch (err) {\n        console.warn(\"Error fetching overdue installments:\", err);\n        return { total: 0, data: [] };\n      }\n    },\n    retry: false,\n    staleTime: 30000, // Cache for 30 seconds\n  });\n\n  const overdueCount = data?.total || 0;\n  const installments = data?.data || [];\n\n  if (isLoading) {\n    return null;\n  }\n\n  if (error || overdueCount === 0) {\n    return null;\n  }\n\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <div className=\"flex items-center\">\n        <div className=\"mr-3 flex\">\n          <AlertCircle className=\"text-red-600 dark:text-red-400 w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground flex-1\">\n          Overdue Installments\n        </h2>\n      </div>\n      <Card className=\"p-4 mb-2\">\n        <CardHeader className=\"p-0 pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-lg\">\n              {overdueCount} Overdue Payment{overdueCount !== 1 ? \"s\" : \"\"}\n            </CardTitle>\n            <Button variant=\"outline\" size=\"sm\" asChild>\n              <Link to=\"/payment_packages?filter[overdue_installments]=true\">\n                View All\n              </Link>\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent className=\"p-0\">\n          <div className=\"space-y-2\">\n            {installments.slice(0, 5).map((installment: any) => {\n              const packageData = installment.payment_packages;\n              return (\n                <Link\n                  key={installment.id}\n                  to={`/payment_packages/${packageData?.id}/show`}\n                  className=\"block p-3 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors\"\n                >\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"font-medium text-sm truncate\">\n                        Package #{packageData?.id}\n                      </p>\n                      <div className=\"flex items-center gap-2 mt-1\">\n                        <Badge variant=\"destructive\" className=\"text-xs\">\n                          Overdue\n                        </Badge>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Installment {installment.installment_number}\n                        </span>\n                      </div>\n                    </div>\n                    <div className=\"text-right\">\n                      <p className=\"font-semibold text-sm\">\n                        AED {installment.amount_due.toLocaleString()}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Due: {new Date(installment.due_date).toLocaleDateString()}\n                      </p>\n                    </div>\n                  </div>\n                </Link>\n              );\n            })}\n            {overdueCount > 5 && (\n              <p className=\"text-sm text-muted-foreground text-center pt-2\">\n                +{overdueCount - 5} more overdue installment{overdueCount - 5 !== 1 ? \"s\" : \"\"}\n              </p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/LowUsageWarnings.tsx",
      "content": "import { useMemo, useState, useEffect, useCallback } from \"react\";\nimport { useGetList } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Link } from \"react-router\";\nimport { AlertTriangle, Package } from \"lucide-react\";\nimport type { PaymentPackage } from \"../types\";\nimport { usePackageUsage } from \"@/hooks/usePackageUsage\";\n\ninterface PackageWithUsage extends PaymentPackage {\n  remaining: number;\n  usageType: string;\n  percentage: number;\n}\n\nconst PackageUsageItem = ({ pkg }: { pkg: PackageWithUsage }) => {\n  return (\n    <Link\n      to={`/payment_packages/${pkg.id}/show`}\n      className=\"block p-2 rounded-lg border hover:bg-accent transition-colors\"\n    >\n      <div className=\"flex items-center justify-between mb-1\">\n        <div className=\"text-sm font-medium\">\n          Package #{pkg.id}\n        </div>\n        <Badge \n          variant=\"outline\" \n          className={pkg.remaining <= 0 ? \"bg-red-50 text-red-700 border-red-200\" : \"bg-yellow-50 text-yellow-700 border-yellow-200\"}\n        >\n          {pkg.remaining} {pkg.usageType} left\n        </Badge>\n      </div>\n      <div className=\"text-xs text-muted-foreground\">\n        {Math.round(pkg.percentage)}% used\n      </div>\n    </Link>\n  );\n};\n\nconst PackageUsageCalculator = ({ \n  pkg, \n  onUsageCalculated \n}: { \n  pkg: PaymentPackage;\n  onUsageCalculated: (pkgId: number, hasLowUsage: boolean, usageData: PackageWithUsage | null) => void;\n}) => {\n  const { sessionsUsed, hoursUsed, isLoading } = usePackageUsage(pkg.id);\n  \n  const usageData = useMemo(() => {\n    let remaining = 0;\n    let total = 0;\n    let usageType = \"\";\n    \n    if (pkg.package_type === \"session-based\" && pkg.total_sessions) {\n      total = pkg.total_sessions;\n      remaining = total - (sessionsUsed || 0);\n      usageType = \"sessions\";\n    } else if (pkg.package_type === \"time-based\" && pkg.total_hours) {\n      total = pkg.total_hours;\n      remaining = total - (hoursUsed || 0);\n      usageType = \"hours\";\n    } else {\n      return null; // Skip post-payment packages\n    }\n    \n    if (remaining > 2) return null; // Only show if 2 or fewer remaining\n    \n    const percentage = total > 0 ? ((total - remaining) / total) * 100 : 0;\n    \n    return {\n      ...pkg,\n      remaining,\n      usageType,\n      percentage,\n    };\n  }, [pkg, sessionsUsed, hoursUsed]);\n  \n  useEffect(() => {\n    if (!isLoading && usageData !== undefined) {\n      onUsageCalculated(pkg.id as number, usageData !== null, usageData);\n    }\n  }, [isLoading, usageData, pkg.id, onUsageCalculated]);\n  \n  if (isLoading || !usageData) return null;\n  \n  return <PackageUsageItem pkg={usageData} />;\n};\n\nexport const LowUsageWarnings = () => {\n  const { data: packages, isLoading, error } = useGetList<PaymentPackage>(\"payment_packages\", {\n    pagination: { page: 1, perPage: 50 },\n    filter: {\n      status: \"active\",\n      \"package_type@in\": \"('session-based','time-based')\",\n    },\n    sort: { field: \"created_at\", order: \"DESC\" },\n  }, {\n    retry: false,\n    onError: (err) => {\n      console.warn(\"Error fetching packages for low usage warnings:\", err);\n    },\n  });\n\n  const [lowUsagePackagesMap, setLowUsagePackagesMap] = useState<Map<number, PackageWithUsage>>(new Map());\n\n  const handleUsageCalculated = useCallback((pkgId: number, hasLowUsage: boolean, usageData: PackageWithUsage | null) => {\n    setLowUsagePackagesMap(prev => {\n      const newMap = new Map(prev);\n      if (hasLowUsage && usageData) {\n        newMap.set(pkgId, usageData);\n      } else {\n        newMap.delete(pkgId);\n      }\n      return newMap;\n    });\n  }, []);\n\n  const lowUsagePackages = useMemo(() => {\n    return Array.from(lowUsagePackagesMap.values());\n  }, [lowUsagePackagesMap]);\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\n            <Package className=\"w-4 h-4\" />\n            Low Usage Warnings\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-sm text-muted-foreground\">Loading...</div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (error) {\n    return null; // Silently fail if there's an error\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\n          <Package className=\"w-4 h-4\" />\n          Low Usage Warnings\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <div className=\"text-2xl font-bold\">\n                {lowUsagePackages.length}\n              </div>\n              <div className=\"text-xs text-muted-foreground\">\n                packages with low usage\n              </div>\n            </div>\n            <Badge variant=\"outline\" className=\"bg-orange-50 text-orange-700 border-orange-200\">\n              <AlertTriangle className=\"w-3 h-3 mr-1\" />\n              Warning\n            </Badge>\n          </div>\n          <Link to=\"/payment_packages?filter[status]=active\">\n            <Button variant=\"outline\" size=\"sm\" className=\"w-full cursor-pointer\">\n              View All Packages\n            </Button>\n          </Link>\n          {packages && packages.length > 0 && (\n            <div className=\"space-y-2 mt-3\">\n              {packages.slice(0, 10).map((pkg) => (\n                <PackageUsageCalculator \n                  key={pkg.id} \n                  pkg={pkg} \n                  onUsageCalculated={handleUsageCalculated}\n                />\n              ))}\n            </div>\n          )}\n          {lowUsagePackages.length === 0 && (\n            <div className=\"text-sm text-muted-foreground\">\n              No packages with low usage warnings\n            </div>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/LeadStatusChart.tsx",
      "content": "import { ResponsiveBar } from \"@nivo/bar\";\nimport { Users } from \"lucide-react\";\nimport { useGetList, useRedirect } from \"ra-core\";\nimport { memo, useMemo } from \"react\";\nimport { Card, CardHeader, CardTitle, CardContent, CardDescription } from \"@/components/ui/card\";\n\nimport type { Deal } from \"../types\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\n// Define a color map for stages to ensure consistency\nconst STAGE_COLORS: Record<string, string> = {\n  new: \"#3b82f6\",       // Blue 500\n  contacted: \"#6366f1\", // Indigo 500\n  quoted: \"#8b5cf6\",    // Violet 500\n  qualified: \"#06b6d4\", // Cyan 500\n  \"not-qualified\": \"#94a3b8\", // Slate 400\n  converted: \"#22c55e\", // Green 500\n};\n\nexport const LeadStatusChart = memo(() => {\n  const { leadStages } = useConfigurationContext();\n  const redirect = useRedirect();\n  \n  const { data, isPending } = useGetList<Deal>(\"lead-journey\", {\n    pagination: { perPage: 1000, page: 1 },\n    sort: {\n      field: \"created_at\",\n      order: \"ASC\",\n    },\n    // Filter out archived leads and orphaned deals (deals without a lead_id)\n    // This matches the filter used in DealList to ensure consistency\n    filter: { \"archived_at@is\": null, \"lead_id@not.is\": null },\n  });\n\n  const chartData = useMemo(() => {\n    if (!data || data.length === 0) return [];\n    \n    // Count leads by stage\n    const stageCounts = leadStages.reduce((acc, stage) => {\n      acc[stage.value] = 0;\n      return acc;\n    }, {} as Record<string, number>);\n\n    data.forEach((deal) => {\n      if (stageCounts.hasOwnProperty(deal.stage)) {\n        stageCounts[deal.stage] = (stageCounts[deal.stage] || 0) + 1;\n      }\n    });\n\n    // Convert to chart format\n    return leadStages.map((stage) => ({\n      id: stage.value,\n      stage: stage.label,\n      value: stageCounts[stage.value] || 0,\n      color: STAGE_COLORS[stage.value] || \"#cbd5e1\",\n    }));\n  }, [data, leadStages]);\n\n  const handleBarClick = (node: any) => {\n    // Navigate to the list view filtered by the clicked stage\n    const filter = JSON.stringify({ stage: node.data.id });\n    redirect(`/lead-journey?filter=${encodeURIComponent(filter)}`);\n  };\n\n  if (isPending) return null;\n  if (!chartData || chartData.length === 0) return null;\n\n  return (\n    <Card className=\"col-span-1 shadow-sm hover:shadow-md transition-shadow duration-200\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center space-x-2\">\n          <div className=\"p-2 bg-primary/10 rounded-full\">\n            <Users className=\"w-5 h-5 text-primary\" />\n          </div>\n          <div>\n            <CardTitle>Lead Journey Overview</CardTitle>\n            <CardDescription>\n              Distribution of leads across pipeline stages\n            </CardDescription>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"h-[400px] w-full\">\n          <ResponsiveBar\n            data={chartData}\n            keys={[\"value\"]}\n            indexBy=\"stage\"\n            margin={{ top: 20, right: 30, bottom: 60, left: 60 }}\n            padding={0.4}\n            valueScale={{ type: \"linear\" }}\n            indexScale={{ type: \"band\", round: true }}\n            colors={({ data }: any) => data.color}\n            borderRadius={6}\n            borderColor={{\n              from: \"color\",\n              modifiers: [[\"darker\", 1.6]],\n            }}\n            axisTop={null}\n            axisRight={null}\n            axisBottom={{\n              tickSize: 0,\n              tickPadding: 16,\n              tickRotation: -45,\n              legend: \"\",\n              legendPosition: \"middle\",\n              legendOffset: 32,\n            }}\n            axisLeft={{\n              tickSize: 0,\n              tickPadding: 16,\n              tickRotation: 0,\n              legend: \"\",\n              legendPosition: \"middle\",\n              legendOffset: -40,\n              tickValues: 5,\n            }}\n            enableLabel={true}\n            labelSkipWidth={12}\n            labelSkipHeight={12}\n            labelTextColor=\"#ffffff\"\n            role=\"application\"\n            ariaLabel=\"Lead Status Distribution Chart\"\n            barAriaLabel={(e) =>\n              `${e.id}: ${e.formattedValue} in stage: ${e.indexValue}`\n            }\n            onClick={handleBarClick}\n            cursor=\"pointer\"\n            theme={{\n              axis: {\n                ticks: {\n                  text: {\n                    fill: \"var(--muted-foreground)\",\n                    fontSize: 12,\n                    fontFamily: \"inherit\",\n                  },\n                },\n              },\n              grid: {\n                line: {\n                  stroke: \"var(--border)\",\n                  strokeWidth: 1,\n                  strokeDasharray: \"4 4\",\n                },\n              },\n              tooltip: {\n                container: {\n                  background: \"var(--popover)\",\n                  color: \"var(--popover-foreground)\",\n                  fontSize: 12,\n                  borderRadius: \"6px\",\n                  boxShadow: \"0 4px 6px -1px rgb(0 0 0 / 0.1)\",\n                  padding: \"8px 12px\",\n                  border: \"1px solid var(--border)\",\n                },\n              },\n            }}\n            tooltip={({ id, value, indexValue, color }) => (\n              <div className=\"flex flex-col gap-1\">\n                <div className=\"flex items-center gap-2\">\n                  <div\n                    className=\"w-3 h-3 rounded-full\"\n                    style={{ backgroundColor: color }}\n                  />\n                  <span className=\"font-semibold text-sm\">{indexValue}</span>\n                </div>\n                <div className=\"text-xs text-muted-foreground pl-5\">\n                  <span className=\"font-medium text-foreground\">{value}</span>{\" \"}\n                  leads\n                </div>\n              </div>\n            )}\n            animate={true}\n            motionConfig=\"gentle\"\n          />\n        </div>\n      </CardContent>\n    </Card>\n  );\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/LatestNotes.tsx",
      "content": "import { formatDistance } from \"date-fns\";\nimport { FileText, CheckSquare, ArrowRightLeft, Receipt } from \"lucide-react\";\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport type { Contact, ContactNote, Quote, Task, Deal } from \"../types\";\n\nexport const LatestNotes = () => {\n  const { identity } = useGetIdentity();\n  const { data: contactNotesData, isPending: contactNotesLoading } = useGetList(\n    \"contactNotes\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  const { data: dealNotesData, isPending: dealNotesLoading } = useGetList(\n    \"dealNotes\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  const { data: quotesData, isPending: quotesLoading } = useGetList<Quote>(\n    \"quotes\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"updated_at\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  const { data: tasksData, isPending: tasksLoading } = useGetList<Task>(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"due_date\", order: \"DESC\" },\n      filter: identity?.id ? { sales_id: identity.id } : {},\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  const { data: dealsData, isPending: dealsLoading } = useGetList<Deal>(\n    \"lead-journey\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"updated_at\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n\n  if (\n    contactNotesLoading ||\n    dealNotesLoading ||\n    quotesLoading ||\n    tasksLoading ||\n    dealsLoading\n  ) {\n    return null;\n  }\n\n  // TypeScript guards\n  if (\n    !contactNotesData ||\n    !dealNotesData ||\n    !quotesData ||\n    !tasksData ||\n    !dealsData\n  ) {\n    return null;\n  }\n\n  // Combine all activities\n  const allActivities = ([] as any[])\n    .concat(\n      // Notes\n      contactNotesData.map((note) => ({\n        ...note,\n        type: \"contactNote\",\n        activityDate: note.date,\n      })),\n      dealNotesData.map((note) => ({\n        ...note,\n        type: \"dealNote\",\n        activityDate: note.date,\n      })),\n      // Quotes - use updated_at if available, otherwise created_at\n      quotesData.map((quote) => ({\n        ...quote,\n        type: \"quote\",\n        activityDate: quote.updated_at || quote.created_at,\n      })),\n      // Tasks - use done_date if completed, otherwise due_date for created tasks\n      tasksData.map((task) => ({\n        ...task,\n        type: task.done_date ? \"taskCompleted\" : \"taskCreated\",\n        activityDate: task.done_date || task.due_date,\n      })),\n      // Status changes - deals that were updated (stage changes)\n      dealsData\n        .filter((deal) => deal.updated_at && deal.updated_at !== deal.created_at)\n        .map((deal) => ({\n          ...deal,\n          type: \"statusChange\",\n          activityDate: deal.updated_at,\n        })),\n    )\n    .sort(\n      (a, b) =>\n        new Date(b.activityDate).valueOf() - new Date(a.activityDate).valueOf(),\n    )\n    .slice(0, 10);\n\n  return (\n    <div>\n      <div className=\"flex items-center mb-4\">\n        <div className=\"ml-8 mr-8 flex\">\n          <FileText className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          My Latest Activity\n        </h2>\n      </div>\n      <Card>\n        <CardContent>\n          {allActivities.map((activity) => (\n            <div\n              id={`${activity.type}_${activity.id}`}\n              key={`${activity.type}_${activity.id}`}\n              className=\"mb-8\"\n            >\n              <div className=\"text-sm text-muted-foreground\">\n                {activity.type === \"contactNote\" && (\n                  <>\n                    <FileText className=\"inline w-4 h-4 mr-1\" />\n                    Note on <Contact record={activity} />, added{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"dealNote\" && (\n                  <>\n                    <FileText className=\"inline w-4 h-4 mr-1\" />\n                    Note on <Deal record={activity} />, added{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"quote\" && (\n                  <>\n                    <Receipt className=\"inline w-4 h-4 mr-1\" />\n                    Quote for <Contact record={activity} />{\" \"}\n                    {activity.status && `(${activity.status})`}, updated{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"taskCompleted\" && (\n                  <>\n                    <CheckSquare className=\"inline w-4 h-4 mr-1\" />\n                    Task completed for <Contact record={activity} />, done{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"taskCreated\" && (\n                  <>\n                    <CheckSquare className=\"inline w-4 h-4 mr-1\" />\n                    Task created for <Contact record={activity} />, due{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"statusChange\" && (\n                  <>\n                    <ArrowRightLeft className=\"inline w-4 h-4 mr-1\" />\n                    Status changed for <Deal record={activity} /> to{\" \"}\n                    <span className=\"font-medium\">{activity.stage}</span>,{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n              </div>\n              <div>\n                {(activity.type === \"contactNote\" ||\n                  activity.type === \"dealNote\") && (\n                  <p className=\"text-sm line-clamp-3 overflow-hidden\">\n                    {activity.text}\n                  </p>\n                )}\n                {activity.type === \"quote\" && (\n                  <p className=\"text-sm line-clamp-3 overflow-hidden\">\n                    {activity.description || `Amount: .${activity.amount}`}\n                  </p>\n                )}\n                {(activity.type === \"taskCompleted\" ||\n                  activity.type === \"taskCreated\") && (\n                  <p className=\"text-sm line-clamp-3 overflow-hidden\">\n                    {activity.text}\n                  </p>\n                )}\n                {activity.type === \"statusChange\" && (\n                  <p className=\"text-sm line-clamp-3 overflow-hidden\">\n                    {activity.description || activity.name}\n                  </p>\n                )}\n              </div>\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nconst Deal = ({ record }: { record: any }) => (\n  <>\n    Deal{\" \"}\n    <ReferenceField\n      record={record}\n      source={record.deal_id ? \"deal_id\" : \"id\"}\n      reference=\"lead-journey\"\n      link=\"show\"\n    >\n      <TextField source=\"name\" />\n    </ReferenceField>\n  </>\n);\n\nconst Contact = ({ record }: { record: any }) => (\n  <>\n    Contact{\" \"}\n    <ReferenceField<ContactNote | Quote | Task, Contact>\n      record={record}\n      source=\"contact_id\"\n      reference=\"contacts\"\n      link=\"show\"\n    />\n  </>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DealsPipeline.tsx",
      "content": "import { DollarSign } from \"lucide-react\";\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { SimpleList } from \"../simple-list/SimpleList\";\nimport { findDealLabel } from \"../deals/deal\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\n\n/**\n * This component displays the deals pipeline for the current user.\n * It's currently not used in the application but can be added to the dashboard.\n */\nexport const DealsPipeline = () => {\n  const { identity } = useGetIdentity();\n  const { dealStages, dealPipelineStatuses } = useConfigurationContext();\n  const { data, total, isPending } = useGetList<Deal>(\n    \"lead-journey\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"last_seen\", order: \"DESC\" },\n      filter: { \"stage@neq\": \"lost\", sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n\n  const getOrderedDeals = (data?: Deal[]): Deal[] | undefined => {\n    if (!data) {\n      return;\n    }\n    const deals: Deal[] = [];\n    dealStages\n      .filter((stage) => !dealPipelineStatuses.includes(stage.value))\n      .forEach((stage) =>\n        data\n          .filter((deal) => deal.stage === stage.value)\n          .forEach((deal) => deals.push(deal)),\n      );\n    return deals;\n  };\n\n  return (\n    <>\n      <div className=\"flex items-center mb-4\">\n        <div className=\"ml-8 mr-8 flex\">\n          <DollarSign className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <Link\n          className=\"text-xl font-semibold text-muted-foreground hover:underline\"\n          to=\"/lead-journey\"\n        >\n          Deals Pipeline\n        </Link>\n      </div>\n      <Card>\n        <SimpleList<Deal>\n          resource=\"lead-journey\"\n          linkType=\"show\"\n          data={getOrderedDeals(data)}\n          total={total}\n          isPending={isPending}\n          primaryText={(deal) => deal.name}\n          secondaryText={(deal) =>\n            `${deal.amount.toLocaleString(\"en-US\", {\n              notation: \"compact\",\n              style: \"currency\",\n              currency: \"AED\",\n              currencyDisplay: \"narrowSymbol\",\n              minimumSignificantDigits: 3,\n            })} , ${findDealLabel(dealStages, deal.stage)}`\n          }\n        />\n      </Card>\n    </>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DealsChart.tsx",
      "content": "import { ResponsiveBar } from \"@nivo/bar\";\nimport { format, startOfMonth } from \"date-fns\";\nimport { DollarSign } from \"lucide-react\";\nimport { useGetList } from \"ra-core\";\nimport { memo, useMemo } from \"react\";\n\nimport type { Deal } from \"../types\";\n\nconst multiplier = {\n  opportunity: 0.2,\n  \"proposal-sent\": 0.5,\n  \"in-negociation\": 0.8,\n  delayed: 0.3,\n};\n\nconst threeMonthsAgo = new Date(\n  new Date().setMonth(new Date().getMonth() - 6),\n).toISOString();\n\nconst DEFAULT_LOCALE = \"en-US\";\nconst CURRENCY = \"AED\";\n\nexport const DealsChart = memo(() => {\n  const acceptedLanguages = navigator\n    ? navigator.languages || [navigator.language]\n    : [DEFAULT_LOCALE];\n\n  const { data, isPending } = useGetList<Deal>(\"deals\", {\n    pagination: { perPage: 100, page: 1 },\n    sort: {\n      field: \"created_at\",\n      order: \"ASC\",\n    },\n    filter: {\n      \"created_at@gte\": threeMonthsAgo,\n    },\n  });\n  const months = useMemo(() => {\n    if (!data || data.length === 0) return [];\n    const dealsByMonth = data.reduce((acc, deal) => {\n      const month = startOfMonth(deal.created_at ?? new Date()).toISOString();\n      if (!acc[month]) {\n        acc[month] = [];\n      }\n      acc[month].push(deal);\n      return acc;\n    }, {} as any);\n\n    const amountByMonth = Object.keys(dealsByMonth).map((month) => {\n      return {\n        date: format(month, \"MMM\"),\n        won: dealsByMonth[month]\n          .filter((deal: Deal) => deal.stage === \"won\")\n          .reduce((acc: number, deal: Deal) => {\n            const amount = Number(deal.amount) || 0;\n            acc += amount;\n            return acc;\n          }, 0),\n        pending: dealsByMonth[month]\n          .filter((deal: Deal) => ![\"won\", \"lost\"].includes(deal.stage))\n          .reduce((acc: number, deal: Deal) => {\n            const amount = Number(deal.amount) || 0;\n            // @ts-expect-error - multiplier type issue\n            const multiplierValue = multiplier[deal.stage] || 0;\n            acc += amount * multiplierValue;\n            return acc;\n          }, 0),\n        lost: dealsByMonth[month]\n          .filter((deal: Deal) => deal.stage === \"lost\")\n          .reduce((acc: number, deal: Deal) => {\n            const amount = Number(deal.amount) || 0;\n            acc -= amount;\n            return acc;\n          }, 0),\n      };\n    });\n\n    return amountByMonth;\n  }, [data]);\n\n  if (isPending) return null; // FIXME return skeleton instead\n  if (!months || months.length === 0) return null;\n  \n  const range = months.reduce(\n    (acc, month) => {\n      const lost = Number(month.lost) || 0;\n      const won = Number(month.won) || 0;\n      const pending = Number(month.pending) || 0;\n      acc.min = Math.min(acc.min, lost);\n      acc.max = Math.max(acc.max, won + pending);\n      return acc;\n    },\n    { min: 0, max: 0 },\n  );\n  \n  // Ensure range values are valid numbers\n  const minValue = isNaN(range.min) ? 0 : range.min;\n  const maxValue = isNaN(range.max) ? 0 : range.max;\n  return (\n    <div className=\"flex flex-col\">\n      <div className=\"flex items-center mb-4\">\n        <div className=\"mr-3 flex\">\n          <DollarSign className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          Upcoming Deal Revenue\n        </h2>\n      </div>\n      <div className=\"h-[400px]\">\n        <ResponsiveBar\n          data={months}\n          indexBy=\"date\"\n          keys={[\"won\", \"pending\", \"lost\"]}\n          colors={[\"#61cdbb\", \"#97e3d5\", \"#e25c3b\"]}\n          margin={{ top: 30, right: 50, bottom: 30, left: 0 }}\n          padding={0.3}\n          valueScale={{\n            type: \"linear\",\n            min: minValue * 1.2,\n            max: Math.max(maxValue * 1.2, 1),\n          }}\n          indexScale={{ type: \"band\", round: true }}\n          enableGridX={true}\n          enableGridY={false}\n          enableLabel={false}\n          tooltip={({ value, indexValue }) => (\n            <div className=\"p-2 bg-secondary rounded shadow inline-flex items-center gap-1 text-secondary-foreground\">\n              <strong>{indexValue}: </strong>&nbsp;{value > 0 ? \"+\" : \"\"}\n              {value.toLocaleString(acceptedLanguages.at(0) ?? DEFAULT_LOCALE, {\n                style: \"currency\",\n                currency: CURRENCY,\n              })}\n            </div>\n          )}\n          axisTop={{\n            tickSize: 0,\n            tickPadding: 12,\n            style: {\n              ticks: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n              legend: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n            },\n          }}\n          axisBottom={{\n            legendPosition: \"middle\",\n            legendOffset: 50,\n            tickSize: 0,\n            tickPadding: 12,\n            style: {\n              ticks: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n              legend: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n            },\n          }}\n          axisLeft={null}\n          axisRight={{\n            format: (v: any) => `${Math.abs(v / 1000)}k`,\n            tickValues: 8,\n            style: {\n              ticks: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n              legend: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n            },\n          }}\n          markers={\n            [\n              {\n                axis: \"y\",\n                value: 0,\n                lineStyle: { strokeOpacity: 0 },\n                textStyle: { fill: \"#2ebca6\" },\n                legend: \"Won\",\n                legendPosition: \"top-left\",\n                legendOrientation: \"vertical\",\n              },\n              {\n                axis: \"y\",\n                value: 0,\n                lineStyle: {\n                  stroke: \"#f47560\",\n                  strokeWidth: 1,\n                },\n                textStyle: { fill: \"#e25c3b\" },\n                legend: \"Lost\",\n                legendPosition: \"bottom-left\",\n                legendOrientation: \"vertical\",\n              },\n            ] as any\n          }\n        />\n      </div>\n    </div>\n  );\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DashboardStepper.tsx",
      "content": "import { CheckCircle, Circle } from \"lucide-react\";\nimport type { Identifier } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { ContactImportButton } from \"../contacts/ContactImportButton\";\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\n\nexport const DashboardStepper = ({\n  step,\n  contactId,\n}: {\n  step: number;\n  contactId?: Identifier;\n}) => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex justify-center items-center\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <Card className=\"w-full max-w-[600px]\">\n        <CardContent className=\"px-6\">\n          <div className=\"flex items-center justify-between mb-8\">\n            <h3 className=\"text-lg font-bold\">What's next?</h3>\n            <div className=\"w-[150px]\">\n              <Progress value={(step / 3) * 100} className=\"mb-2\" />\n              <div className=\"text-right text-sm\">{step}/3 done</div>\n            </div>\n          </div>\n          <div className=\"flex flex-col gap-12\">\n            <div className=\"flex gap-8 items-center\">\n              <CheckCircle className=\"text-green-600 w-5 h-5\" />\n              <h4 className=\"font-bold\">Install BestDOC CRM</h4>\n            </div>\n            <div className=\"flex gap-8 items-start\">\n              {step > 1 ? (\n                <CheckCircle className=\"text-green-600 w-5 h-5 mt-1\" />\n              ) : (\n                <Circle className=\"text-muted-foreground w-5 h-5 mt-1\" />\n              )}\n\n              <div className=\"flex flex-col gap-4\">\n                <h4 className=\"font-bold\">Add your first contact</h4>\n\n                <div className=\"flex gap-8\">\n                  <CreateButton label=\"New Contact\" resource=\"contacts\" />\n                  <ContactImportButton />\n                </div>\n              </div>\n            </div>\n            <div className=\"flex gap-8 items-start\">\n              <Circle className=\"text-muted-foreground w-5 h-5 mt-1\" />\n              <div className=\"flex flex-col gap-4\">\n                <h4 className=\"font-bold\">Add your first note</h4>\n                <p>Go to a contact page and add a note</p>\n                <Button asChild disabled={step < 2} className=\"w-[100px]\">\n                  <Link to={`/contacts/${contactId}/show`}>Add note</Link>\n                </Button>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DashboardActivityLog.tsx",
      "content": "import { Clock } from \"lucide-react\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { ActivityLog } from \"../activity/ActivityLog\";\n\nexport function DashboardActivityLog() {\n  return (\n    <div className=\"flex flex-col\">\n      <div className=\"flex items-center mb-2\">\n        <div className=\"mr-3 flex\">\n          <Clock className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          Latest Activity\n        </h2>\n      </div>\n      <Card className=\"mb-2 p-6\">\n        <ActivityLog pageSize={10} />\n      </Card>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/Dashboard.tsx",
      "content": "import { useGetList } from \"ra-core\";\n\nimport type { Contact, ContactNote } from \"../types\";\nimport { DashboardActivityLog } from \"./DashboardActivityLog\";\nimport { RecentLeads } from \"./RecentLeads\";\nimport { LeadStatusChart } from \"./LeadStatusChart\";\nimport { TasksList } from \"./TasksList\";\nimport { Welcome } from \"./Welcome\";\nimport { OverdueInstallments } from \"./OverdueInstallments\";\nimport { PackagesExpiringSoon } from \"./PackagesExpiringSoon\";\nimport { LowUsageWarnings } from \"./LowUsageWarnings\";\nimport { BulkStatusChange } from \"./BulkStatusChange\";\n\nexport const Dashboard = () => {\n  const {\n    total: totalContact,\n    isPending: isPendingContact,\n  } = useGetList<Contact>(\"contacts\", {\n    pagination: { page: 1, perPage: 1 },\n  });\n\n  const { total: totalContactNotes, isPending: isPendingContactNotes } =\n    useGetList<ContactNote>(\"contactNotes\", {\n      pagination: { page: 1, perPage: 1 },\n    });\n\n  const { total: totalDeal, isPending: isPendingDeal } = useGetList<Contact>(\n    \"lead-journey\",\n    {\n      pagination: { page: 1, perPage: 1 },\n    },\n  );\n\n  const isPending = isPendingContact || isPendingContactNotes || isPendingDeal;\n\n  if (isPending) {\n    return null;\n  }\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-12 gap-6 mt-1\">\n      <div className=\"md:col-span-3\">\n        <div className=\"flex flex-col gap-4\">\n          {import.meta.env.VITE_IS_DEMO === \"true\" ? <Welcome /> : null}\n          <OverdueInstallments />\n          <PackagesExpiringSoon />\n          <LowUsageWarnings />\n          <RecentLeads />\n        </div>\n      </div>\n      <div className=\"md:col-span-6\">\n        <div className=\"flex flex-col gap-6\">\n          <BulkStatusChange />\n          {totalDeal ? <LeadStatusChart /> : null}\n          <DashboardActivityLog />\n        </div>\n      </div>\n\n      <div className=\"md:col-span-3\">\n        <TasksList />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/BulkStatusChange.tsx",
      "content": "import React, { useState, useMemo, useCallback } from \"react\";\nimport { useGetList, useNotify, useDataProvider } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport { Calendar, CheckCircle2, XCircle, Clock, User, Package } from \"lucide-react\";\nimport type { Appointment } from \"../types\";\nimport { format } from \"date-fns\";\nimport { crmToday, crmStartOfDay, crmAddDays, crmDateYmdInputString } from \"../misc/timezone\";\nimport { supabase } from \"../providers/supabase/supabase\";\n\ntype DateFilter = \"today\" | \"yesterday\" | \"before\";\n\ninterface CancelledDialogState {\n  open: boolean;\n  appointmentIds: (string | number)[];\n  countAsUsage: boolean | null;\n}\n\nexport const BulkStatusChange = () => {\n  const [dateFilter, setDateFilter] = useState<DateFilter>(\"today\");\n  const [selectedAppointments, setSelectedAppointments] = useState<Set<string | number>>(new Set());\n  const [cancelledDialog, setCancelledDialog] = useState<CancelledDialogState>({\n    open: false,\n    appointmentIds: [],\n    countAsUsage: null,\n  });\n  const [isUpdating, setIsUpdating] = useState(false);\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n\n  // Calculate date range based on filter\n  const dateRange = useMemo(() => {\n    const today = crmToday();\n    const todayStart = crmStartOfDay(today);\n    \n    switch (dateFilter) {\n      case \"today\":\n        // Today: from today to today (inclusive)\n        return {\n          from: todayStart,\n          to: todayStart, // Same date for inclusive range\n        };\n      case \"yesterday\":\n        // Yesterday: from yesterday to yesterday (inclusive)\n        const yesterdayDate = crmAddDays(today, -1);\n        const yesterdayStart = crmStartOfDay(yesterdayDate);\n        return {\n          from: yesterdayStart,\n          to: yesterdayStart, // Same date for inclusive range\n        };\n      case \"before\":\n        // Before: appointments strictly before yesterday (not including yesterday)\n        // If yesterday is Jan 1, this shows Dec 31 and earlier\n        const beforeYesterday = crmAddDays(today, -1);\n        const beforeYesterdayStart = crmStartOfDay(beforeYesterday);\n        return {\n          from: null,\n          to: beforeYesterdayStart, // Will use @lt to exclude yesterday itself\n        };\n      default:\n        return { from: todayStart, to: todayStart };\n    }\n  }, [dateFilter]);\n\n  // Fetch appointments - include both scheduled and completed\n  const now = new Date();\n  \n  // Build filter similar to AppointmentsPage\n  const apiFilter = useMemo(() => {\n    const filter: Record<string, unknown> = {};\n    \n    let dateFrom: string | undefined;\n    let dateTo: string | undefined;\n    \n    // Use CRM timezone-aware date formatting\n    if (dateRange.from) {\n      dateFrom = crmDateYmdInputString(dateRange.from) || undefined;\n    }\n    \n    if (dateRange.to) {\n      // For the end date, we want to include the full day, so use the date as-is\n      // The @lte filter will include appointments up to and including this date\n      dateTo = crmDateYmdInputString(dateRange.to) || undefined;\n    }\n    \n    if (dateFrom && dateTo) {\n      // If from and to are the same, use equality check for better performance\n      if (dateFrom === dateTo) {\n        filter[\"appointment_date\"] = dateFrom;\n      } else {\n        filter[\"appointment_date@gte\"] = dateFrom;\n        filter[\"appointment_date@lte\"] = dateTo;\n      }\n    } else {\n      if (dateFrom) {\n        filter[\"appointment_date@gte\"] = dateFrom;\n      }\n      if (dateTo) {\n        // For \"before\" filter, use @lt to exclude the date\n        if (dateFilter === \"before\") {\n          filter[\"appointment_date@lt\"] = dateTo;\n        } else {\n          filter[\"appointment_date@lte\"] = dateTo;\n        }\n      }\n    }\n    \n    // For \"before\" filter, only show scheduled appointments (not completed)\n    // For \"today\" and \"yesterday\", show both scheduled and completed\n    if (dateFilter === \"before\") {\n      filter[\"status\"] = \"scheduled\";\n    } else {\n      filter[\"status@in\"] = \"(scheduled,completed)\";\n    }\n    \n    return filter;\n  }, [dateRange, dateFilter]);\n\n  const { data: appointments, isLoading, error } = useGetList<Appointment>(\"appointments\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"end_time\", order: \"DESC\" },\n    filter: apiFilter,\n  }, {\n    retry: false,\n    onError: (err) => {\n      console.warn(\"Error fetching appointments for bulk status:\", err);\n    },\n  });\n\n  // Debug logging\n  React.useEffect(() => {\n    if (appointments !== undefined) {\n      const today = crmToday();\n      const yesterday = crmAddDays(today, -1);\n      console.log(\"BulkStatusChange Debug:\", {\n        dateFilter,\n        today: crmDateYmdInputString(today),\n        yesterday: crmDateYmdInputString(yesterday),\n        dateRange: {\n          from: dateRange.from ? crmDateYmdInputString(dateRange.from) : null,\n          to: dateRange.to ? crmDateYmdInputString(dateRange.to) : null,\n        },\n        apiFilter,\n        totalAppointments: appointments?.length || 0,\n        appointments: appointments?.slice(0, 5).map(a => ({\n          id: a.id,\n          date: a.appointment_date,\n          status: a.status,\n          end_time: a.end_time,\n        })),\n        error: error?.message,\n      });\n    }\n  }, [appointments, error, dateFilter, apiFilter, dateRange]);\n\n  // Filter appointments - \"finished\" means the appointment's end_time has passed\n  // For \"before\": show all scheduled appointments (they're old and should be updated)\n  // For \"today\" and \"yesterday\": only show appointments that have finished (end_time < now)\n  const finishedAppointments = useMemo(() => {\n    if (!appointments) return [];\n    \n    if (dateFilter === \"before\") {\n      // For \"before\" filter, show all scheduled appointments regardless of end_time\n      // These are old appointments that still need status updates\n      return appointments.filter((apt) => apt.status === \"scheduled\");\n    } else {\n      // For \"today\" and \"yesterday\", only show appointments that have finished\n      // \"Finished\" means the appointment's end_time has passed the current time\n      return appointments.filter((apt) => {\n        if (!apt.end_time) return false;\n        const endTime = new Date(apt.end_time);\n        return endTime < now;\n      });\n    }\n  }, [appointments, now, dateFilter]);\n\n  // Separate scheduled and completed appointments\n  const scheduledAppointments = useMemo(() => {\n    return finishedAppointments.filter((apt) => apt.status === \"scheduled\");\n  }, [finishedAppointments]);\n\n  const completedAppointments = useMemo(() => {\n    return finishedAppointments.filter((apt) => apt.status === \"completed\");\n  }, [finishedAppointments]);\n\n  const handleSelectAll = useCallback(() => {\n    // Only select scheduled appointments (completed ones can't be changed)\n    if (selectedAppointments.size === scheduledAppointments.length) {\n      setSelectedAppointments(new Set());\n    } else {\n      setSelectedAppointments(new Set(scheduledAppointments.map((apt) => apt.id)));\n    }\n  }, [selectedAppointments, scheduledAppointments]);\n\n  const handleSelectAppointment = useCallback((id: string | number) => {\n    // Only allow selecting scheduled appointments\n    const appointment = finishedAppointments.find((apt) => apt.id === id);\n    if (appointment && appointment.status !== \"scheduled\") {\n      return; // Don't allow selecting completed appointments\n    }\n\n    setSelectedAppointments((prev) => {\n      const next = new Set(prev);\n      if (next.has(id)) {\n        next.delete(id);\n      } else {\n        next.add(id);\n      }\n      return next;\n    });\n  }, [finishedAppointments]);\n\n  const handleMarkCompleted = useCallback(async () => {\n    if (selectedAppointments.size === 0) {\n      notify(\"Please select at least one appointment\", { type: \"warning\" });\n      return;\n    }\n\n    setIsUpdating(true);\n    const errors: string[] = [];\n    let successCount = 0;\n\n    try {\n      const updatePromises = Array.from(selectedAppointments).map(async (id) => {\n        const appointment = finishedAppointments.find((apt) => apt.id === id);\n        if (!appointment) {\n          errors.push(`Appointment ${id} not found`);\n          return;\n        }\n\n        try {\n          await dataProvider.update(\"appointments\", {\n            id,\n            data: { status: \"completed\" },\n            previousData: appointment,\n          });\n          successCount++;\n        } catch (error: any) {\n          const errorMsg = error?.message || error?.body?.message || String(error);\n          errors.push(`Appointment ${id}: ${errorMsg}`);\n          console.error(`Error updating appointment ${id}:`, error);\n        }\n      });\n\n      await Promise.allSettled(updatePromises);\n\n      if (errors.length > 0) {\n        notify(\n          `Updated ${successCount} appointment(s). ${errors.length} error(s): ${errors.slice(0, 2).join(\", \")}${errors.length > 2 ? \"...\" : \"\"}`,\n          { type: \"warning\" }\n        );\n      } else {\n        notify(`Marked ${successCount} appointment(s) as completed`, { type: \"success\" });\n      }\n      \n      setSelectedAppointments(new Set());\n    } catch (error: any) {\n      console.error(\"Error marking appointments as completed:\", error);\n      const errorMsg = error?.message || error?.body?.message || String(error);\n      notify(`Failed to update appointments: ${errorMsg}`, { type: \"error\" });\n    } finally {\n      setIsUpdating(false);\n    }\n  }, [selectedAppointments, dataProvider, notify, finishedAppointments]);\n\n  const handleMarkCancelled = useCallback(() => {\n    if (selectedAppointments.size === 0) {\n      notify(\"Please select at least one appointment\", { type: \"warning\" });\n      return;\n    }\n\n    // Open dialog to ask about usage\n    setCancelledDialog({\n      open: true,\n      appointmentIds: Array.from(selectedAppointments),\n      countAsUsage: null,\n    });\n  }, [selectedAppointments, notify]);\n\n  const handleConfirmCancelled = useCallback(async () => {\n    if (cancelledDialog.countAsUsage === null) {\n      notify(\"Please select whether to count as usage\", { type: \"warning\" });\n      return;\n    }\n\n    setIsUpdating(true);\n    const errors: string[] = [];\n    let successCount = 0;\n\n    try {\n      const updatePromises = cancelledDialog.appointmentIds.map(async (id) => {\n        const appointment = finishedAppointments.find((apt) => apt.id === id);\n        if (!appointment) {\n          errors.push(`Appointment ${id} not found`);\n          return;\n        }\n\n        try {\n          await dataProvider.update(\"appointments\", {\n            id,\n            data: { status: \"cancelled\" },\n            previousData: appointment,\n          });\n          successCount++;\n        } catch (error: any) {\n          const errorMsg = error?.message || error?.body?.message || String(error);\n          errors.push(`Appointment ${id}: ${errorMsg}`);\n          console.error(`Error updating appointment ${id}:`, error);\n        }\n      });\n\n      await Promise.allSettled(updatePromises);\n\n      if (errors.length > 0) {\n        notify(\n          `Updated ${successCount} appointment(s). ${errors.length} error(s): ${errors.slice(0, 2).join(\", \")}${errors.length > 2 ? \"...\" : \"\"}`,\n          { type: \"warning\" }\n        );\n      }\n\n      // If countAsUsage is true, manually create usage records\n      if (cancelledDialog.countAsUsage) {\n        const appointmentsToProcess = finishedAppointments.filter((apt) =>\n          cancelledDialog.appointmentIds.includes(apt.id)\n        );\n\n        for (const apt of appointmentsToProcess) {\n          if (apt.payment_package_id) {\n            try {\n              // Get package details\n              const { data: packageData } = await supabase\n                .from(\"payment_packages\")\n                .select(\"*\")\n                .eq(\"id\", apt.payment_package_id)\n                .eq(\"status\", \"active\")\n                .single();\n\n              if (packageData) {\n                if (packageData.package_type === \"session-based\") {\n                  // Create usage record for session-based\n                  await supabase.from(\"package_usage\").insert({\n                    payment_package_id: apt.payment_package_id,\n                    appointment_id: apt.id,\n                    usage_type: \"session\",\n                    quantity_used: 1,\n                    usage_date: apt.appointment_date,\n                    is_manual_adjustment: true,\n                    notes: \"Usage counted for cancelled appointment\",\n                  });\n                } else if (packageData.package_type === \"time-based\") {\n                  // Calculate hours for time-based\n                  const startTime = new Date(apt.start_time);\n                  const endTime = new Date(apt.end_time);\n                  const hoursUsed = (endTime.getTime() - startTime.getTime()) / (1000 * 60 * 60);\n\n                  if (hoursUsed > 0) {\n                    await supabase.from(\"package_usage\").insert({\n                      payment_package_id: apt.payment_package_id,\n                      appointment_id: apt.id,\n                      usage_type: \"hours\",\n                      quantity_used: hoursUsed,\n                      usage_date: apt.appointment_date,\n                      is_manual_adjustment: true,\n                      notes: \"Usage counted for cancelled appointment\",\n                    });\n                  }\n                }\n              }\n            } catch (error) {\n              console.error(`Error creating usage for appointment ${apt.id}:`, error);\n            }\n          }\n        }\n      }\n\n      if (errors.length === 0) {\n        notify(\n          `Marked ${successCount} appointment(s) as cancelled${cancelledDialog.countAsUsage ? \" (usage counted)\" : \"\"}`,\n          { type: \"success\" }\n        );\n      }\n      \n      setSelectedAppointments(new Set());\n      setCancelledDialog({ open: false, appointmentIds: [], countAsUsage: null });\n    } catch (error: any) {\n      console.error(\"Error marking appointments as cancelled:\", error);\n      const errorMsg = error?.message || error?.body?.message || String(error);\n      notify(`Failed to update appointments: ${errorMsg}`, { type: \"error\" });\n    } finally {\n      setIsUpdating(false);\n    }\n  }, [cancelledDialog, dataProvider, notify, finishedAppointments]);\n\n  const getPatientName = (patientId: string | number, patients: any[]) => {\n    const patient = patients?.find((p) => p.id === patientId);\n    if (!patient) return \"Unknown\";\n    return `${patient.first_name} ${patient.last_name}`.trim();\n  };\n\n  const { data: patients } = useGetList(\"clients\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n\n  return (\n    <>\n      <Card className=\"shadow-sm hover:shadow-md transition-shadow duration-200\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"p-2 bg-blue-500/10 rounded-lg\">\n                <Calendar className=\"w-5 h-5 text-blue-600 dark:text-blue-400\" />\n              </div>\n              <div>\n                <CardTitle className=\"text-lg font-semibold\">Appointment Status</CardTitle>\n                <CardDescription className=\"text-sm\">\n                  Update finished appointments in bulk\n                </CardDescription>\n              </div>\n            </div>\n            {finishedAppointments.length > 0 && (\n              <div className=\"flex items-center gap-2\">\n                <Badge variant=\"secondary\" className=\"text-sm font-medium\">\n                  {finishedAppointments.length} finished\n                </Badge>\n                {scheduledAppointments.length > 0 && (\n                  <Badge variant=\"outline\" className=\"text-sm font-medium\">\n                    {scheduledAppointments.length} scheduled\n                  </Badge>\n                )}\n              </div>\n            )}\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Date Filter */}\n          <div className=\"flex gap-2\">\n            <Button\n              variant={dateFilter === \"today\" ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => {\n                setDateFilter(\"today\");\n                setSelectedAppointments(new Set());\n              }}\n              className=\"flex-1\"\n            >\n              Today\n            </Button>\n            <Button\n              variant={dateFilter === \"yesterday\" ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => {\n                setDateFilter(\"yesterday\");\n                setSelectedAppointments(new Set());\n              }}\n              className=\"flex-1\"\n            >\n              Yesterday\n            </Button>\n            <Button\n              variant={dateFilter === \"before\" ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => {\n                setDateFilter(\"before\");\n                setSelectedAppointments(new Set());\n              }}\n              className=\"flex-1\"\n            >\n              Before\n            </Button>\n          </div>\n\n          {/* Select All */}\n          {finishedAppointments.length > 0 && (\n            <div className=\"flex items-center justify-between p-3 bg-muted/50 rounded-lg border\">\n              <div className=\"flex items-center gap-3\">\n                <Checkbox\n                  checked={selectedAppointments.size === scheduledAppointments.length && scheduledAppointments.length > 0}\n                  onCheckedChange={handleSelectAll}\n                  className=\"h-4 w-4\"\n                  disabled={scheduledAppointments.length === 0}\n                />\n                <Label className=\"text-sm font-medium cursor-pointer\">\n                  Select All ({scheduledAppointments.length} scheduled, {completedAppointments.length} completed)\n                </Label>\n              </div>\n              <Badge variant=\"outline\" className=\"font-medium\">\n                {selectedAppointments.size} selected\n              </Badge>\n            </div>\n          )}\n\n          {/* Appointments List */}\n          <div className=\"space-y-2 max-h-[350px] overflow-y-auto\">\n            {isLoading ? (\n              <div className=\"text-sm text-muted-foreground text-center py-8\">\n                Loading appointments...\n              </div>\n            ) : finishedAppointments.length === 0 ? (\n              <div className=\"text-center py-8\">\n                <Calendar className=\"w-12 h-12 mx-auto text-muted-foreground/50 mb-3\" />\n                <p className=\"text-sm font-medium text-muted-foreground mb-1\">\n                  No finished appointments\n                </p>\n                <p className=\"text-xs text-muted-foreground\">\n                  Appointments that have passed their end time will appear here\n                </p>\n              </div>\n            ) : (\n              <>\n                {/* Scheduled Appointments */}\n                {scheduledAppointments.map((apt) => {\n                  const endTime = apt.end_time ? new Date(apt.end_time) : null;\n                  const startTime = apt.start_time ? new Date(apt.start_time) : null;\n                  const isSelected = selectedAppointments.has(apt.id);\n                  const hasPackage = !!apt.payment_package_id;\n\n                  return (\n                    <div\n                      key={apt.id}\n                      className={`group flex items-start gap-3 p-3 rounded-lg border transition-all ${\n                        isSelected \n                          ? \"bg-blue-50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-800 shadow-sm\" \n                          : \"bg-card hover:bg-muted/50 border-border\"\n                      }`}\n                    >\n                      <Checkbox\n                        checked={isSelected}\n                        onCheckedChange={() => handleSelectAppointment(apt.id)}\n                        className=\"mt-1 h-4 w-4\"\n                      />\n                      <div className=\"flex-1 min-w-0 space-y-2\">\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <User className=\"w-3.5 h-3.5 text-muted-foreground flex-shrink-0\" />\n                              <span className=\"text-sm font-semibold truncate\">\n                                {getPatientName(apt.patient_id, patients || [])}\n                              </span>\n                              {hasPackage && (\n                                <Package className=\"w-3.5 h-3.5 text-blue-600 dark:text-blue-400 flex-shrink-0\" />\n                              )}\n                            </div>\n                            <div className=\"flex items-center gap-3 text-xs text-muted-foreground\">\n                              <span className=\"flex items-center gap-1\">\n                                <Clock className=\"w-3 h-3\" />\n                                {startTime && endTime \n                                  ? `${format(startTime, \"HH:mm\")} - ${format(endTime, \"HH:mm\")}`\n                                  : \"N/A\"}\n                              </span>\n                              <span></span>\n                              <span>{format(new Date(apt.appointment_date), \"MMM d\")}</span>\n                              <span></span>\n                              <span className=\"capitalize\">{apt.appointment_type.replace(/_/g, \" \")}</span>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n                \n                {/* Completed Appointments */}\n                {completedAppointments.map((apt) => {\n                  const endTime = apt.end_time ? new Date(apt.end_time) : null;\n                  const startTime = apt.start_time ? new Date(apt.start_time) : null;\n                  const hasPackage = !!apt.payment_package_id;\n\n                  return (\n                    <div\n                      key={apt.id}\n                      className=\"group flex items-start gap-3 p-3 rounded-lg border bg-green-50/50 dark:bg-green-950/10 border-green-200 dark:border-green-800/50 opacity-75\"\n                    >\n                      <Checkbox\n                        checked={false}\n                        disabled={true}\n                        className=\"mt-1 h-4 w-4\"\n                      />\n                      <div className=\"flex-1 min-w-0 space-y-2\">\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <User className=\"w-3.5 h-3.5 text-muted-foreground flex-shrink-0\" />\n                              <span className=\"text-sm font-semibold truncate\">\n                                {getPatientName(apt.patient_id, patients || [])}\n                              </span>\n                              {hasPackage && (\n                                <Package className=\"w-3.5 h-3.5 text-blue-600 dark:text-blue-400 flex-shrink-0\" />\n                              )}\n                              <Badge variant=\"default\" className=\"ml-2 bg-green-600 text-white text-xs\">\n                                <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n                                Completed\n                              </Badge>\n                            </div>\n                            <div className=\"flex items-center gap-3 text-xs text-muted-foreground\">\n                              <span className=\"flex items-center gap-1\">\n                                <Clock className=\"w-3 h-3\" />\n                                {startTime && endTime \n                                  ? `${format(startTime, \"HH:mm\")} - ${format(endTime, \"HH:mm\")}`\n                                  : \"N/A\"}\n                              </span>\n                              <span></span>\n                              <span>{format(new Date(apt.appointment_date), \"MMM d\")}</span>\n                              <span></span>\n                              <span className=\"capitalize\">{apt.appointment_type.replace(/_/g, \" \")}</span>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n              </>\n            )}\n          </div>\n\n          {/* Action Buttons */}\n          {scheduledAppointments.length > 0 && (\n            <div className=\"flex gap-2 pt-2 border-t\">\n              <Button\n                variant=\"default\"\n                size=\"sm\"\n                className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                onClick={handleMarkCompleted}\n                disabled={selectedAppointments.size === 0 || isUpdating}\n              >\n                <CheckCircle2 className=\"w-4 h-4 mr-2\" />\n                Complete ({selectedAppointments.size})\n              </Button>\n              <Button\n                variant=\"destructive\"\n                size=\"sm\"\n                className=\"flex-1\"\n                onClick={handleMarkCancelled}\n                disabled={selectedAppointments.size === 0 || isUpdating}\n              >\n                <XCircle className=\"w-4 h-4 mr-2\" />\n                Cancel ({selectedAppointments.size})\n              </Button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Cancelled Dialog */}\n      <Dialog open={cancelledDialog.open} onOpenChange={(open) => {\n        if (!open) {\n          setCancelledDialog({ open: false, appointmentIds: [], countAsUsage: null });\n        }\n      }}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Mark as Cancelled</DialogTitle>\n            <DialogDescription>\n              Do you want to count these {cancelledDialog.appointmentIds.length} cancelled appointment(s) as usage in their payment packages?\n            </DialogDescription>\n          </DialogHeader>\n          <RadioGroup\n            value={cancelledDialog.countAsUsage === null ? \"\" : cancelledDialog.countAsUsage ? \"yes\" : \"no\"}\n            onValueChange={(value) => {\n              setCancelledDialog((prev) => ({\n                ...prev,\n                countAsUsage: value === \"yes\" ? true : value === \"no\" ? false : null,\n              }));\n            }}\n            className=\"space-y-3 py-4\"\n          >\n            <div className=\"flex items-center space-x-3 p-3 rounded-lg border hover:bg-accent cursor-pointer\">\n              <RadioGroupItem value=\"yes\" id=\"yes\" />\n              <Label htmlFor=\"yes\" className=\"cursor-pointer flex-1\">\n                Yes, count as usage\n              </Label>\n            </div>\n            <div className=\"flex items-center space-x-3 p-3 rounded-lg border hover:bg-accent cursor-pointer\">\n              <RadioGroupItem value=\"no\" id=\"no\" />\n              <Label htmlFor=\"no\" className=\"cursor-pointer flex-1\">\n                No, don't count as usage\n              </Label>\n            </div>\n          </RadioGroup>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setCancelledDialog({ open: false, appointmentIds: [], countAsUsage: null })}\n            >\n              Cancel\n            </Button>\n            <Button onClick={handleConfirmCancelled} disabled={cancelledDialog.countAsUsage === null || isUpdating}>\n              Confirm\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/useContactImport.tsx",
      "content": "import { useDataProvider, useGetIdentity, type DataProvider } from \"ra-core\";\nimport { useCallback, useMemo } from \"react\";\n\nimport { createLeadJourneyDealForContact } from \"../deals/createLeadJourneyDeal\";\nimport type { Company, Tag } from \"../types\";\nimport type { ImportError } from \"../misc/usePapaParse\";\n\nexport type ContactImportSchema = {\n  // Auto-generated fields (ignored if present in CSV):\n  // id - auto-generated by database\n  // sales_id - always uses current user\n  // nb_tasks - auto-calculated\n  // sales - computed from sales_id\n  first_name: string;\n  last_name: string;\n  gender: string;\n  email_jsonb?: string;\n  phone_jsonb?: string;\n  flat_villa_number?: string;\n  building_street?: string;\n  area?: string;\n  google_maps_link?: string;\n  phone_has_whatsapp?: string;\n  services_interested?: string;\n  description?: string;\n  first_seen: string;\n  last_seen: string;\n  tags?: string;\n  // Legacy fields for backward compatibility\n  title?: string;\n  company?: string;\n  email_work?: string;\n  email_home?: string;\n  email_other?: string;\n  phone_work?: string;\n  phone_home?: string;\n  phone_other?: string;\n  background?: string;\n  avatar?: string;\n  has_newsletter?: string;\n  status?: string;\n  linkedin_url?: string;\n};\n\nexport function useContactImport() {\n  const today = new Date().toISOString();\n  const user = useGetIdentity();\n  const dataProvider = useDataProvider();\n\n  // company cache to avoid creating the same company multiple times and costly roundtrips\n  // Cache is dependent of dataProvider, so it's safe to use it as a dependency\n  const companiesCache = useMemo(\n    () => new Map<string, Company>(),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [dataProvider],\n  );\n  const getCompanies = useCallback(\n    async (names: string[]) =>\n      fetchRecordsWithCache<Company>(\n        \"companies\",\n        companiesCache,\n        names,\n        (name) => ({\n          name,\n          created_at: new Date().toISOString(),\n          sales_id: user?.identity?.id,\n        }),\n        dataProvider,\n      ),\n    [companiesCache, user?.identity?.id, dataProvider],\n  );\n\n  // Tags cache to avoid creating the same tag multiple times and costly roundtrips\n  // Cache is dependent of dataProvider, so it's safe to use it as a dependency\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const tagsCache = useMemo(() => new Map<string, Tag>(), [dataProvider]);\n  const getTags = useCallback(\n    async (names: string[]) =>\n      fetchRecordsWithCache<Tag>(\n        \"tags\",\n        tagsCache,\n        names,\n        (name) => ({\n          name,\n          color: \"#f9f9f9\",\n        }),\n        dataProvider,\n      ),\n    [tagsCache, dataProvider],\n  );\n\n  const processBatch = useCallback(\n    async (batch: ContactImportSchema[], startRowIndex: number): Promise<ImportError[]> => {\n      const errors: ImportError[] = [];\n      \n      const [companies, tags] = await Promise.all([\n        getCompanies(\n          batch\n            .map((contact) => contact.company?.trim())\n            .filter((name) => name),\n        ),\n        getTags(batch.flatMap((batch) => parseTags(batch.tags))),\n      ]);\n\n      const results = await Promise.allSettled(\n        batch.map(\n          async (row, batchIndex) => {\n            const rowNumber = startRowIndex + batchIndex;\n            const {\n              first_name,\n              last_name,\n              gender,\n              email_jsonb,\n              phone_jsonb,\n              flat_villa_number,\n              building_street,\n              area,\n              google_maps_link,\n              phone_has_whatsapp,\n              services_interested,\n              description,\n              first_seen,\n              last_seen,\n              tags: tagNames,\n              // Legacy fields for backward compatibility\n              title,\n              company: companyName,\n              email_work,\n              email_home,\n              email_other,\n              phone_work,\n              phone_home,\n              phone_other,\n              background,\n              has_newsletter,\n              status,\n              linkedin_url,\n            } = row;\n            \n            // Ignore id, sales_id, nb_tasks, and sales from CSV - these are auto-generated\n\n            // Parse email_jsonb if provided, otherwise fall back to legacy fields\n            let parsedEmailJsonb: Array<{ email: string; type: string }> = [];\n            if (email_jsonb) {\n              try {\n                parsedEmailJsonb = JSON.parse(email_jsonb);\n              } catch {\n                // If parsing fails, try legacy fields\n                parsedEmailJsonb = [\n                  { email: email_work, type: \"Work\" },\n                  { email: email_home, type: \"Home\" },\n                  { email: email_other, type: \"Other\" },\n                ].filter(({ email }) => email);\n              }\n            } else if (email_work || email_home || email_other) {\n              parsedEmailJsonb = [\n                { email: email_work, type: \"Work\" },\n                { email: email_home, type: \"Home\" },\n                { email: email_other, type: \"Other\" },\n              ].filter(({ email }) => email);\n            }\n\n            // Parse phone_jsonb if provided, otherwise fall back to legacy fields\n            let parsedPhoneJsonb: Array<{ number: string; type: string }> = [];\n            if (phone_jsonb) {\n              try {\n                parsedPhoneJsonb = JSON.parse(phone_jsonb);\n              } catch {\n                // If parsing fails, try legacy fields\n                parsedPhoneJsonb = [\n                  { number: phone_work, type: \"Work\" },\n                  { number: phone_home, type: \"Home\" },\n                  { number: phone_other, type: \"Other\" },\n                ].filter(({ number }) => number);\n              }\n            } else if (phone_work || phone_home || phone_other) {\n              parsedPhoneJsonb = [\n                { number: phone_work, type: \"Work\" },\n                { number: phone_home, type: \"Home\" },\n                { number: phone_other, type: \"Other\" },\n              ].filter(({ number }) => number);\n            }\n\n            // Parse services_interested (semicolon-separated)\n            // Convert to string first in case PapaParse converted it to a number\n            const parsedServicesInterested = services_interested\n              ? String(services_interested)\n                  .split(\";\")\n                  .map((s) => s.trim())\n                  .filter(Boolean)\n                  .map((s) => parseInt(s, 10))\n                  .filter((n) => !isNaN(n))\n              : [];\n\n            const company = companyName?.trim()\n              ? companies.get(companyName.trim())\n              : undefined;\n            const tagList = parseTags(tagNames || \"\")\n              .map((name) => tags.get(name))\n              .filter((tag): tag is Tag => !!tag);\n\n            // Always use current user's ID for sales_id (ignore any sales_id in CSV)\n            const finalSalesId = user?.identity?.id;\n\n            // Validate required fields\n            if (!first_name?.trim() && !last_name?.trim()) {\n              throw new Error(\"Either first_name or last_name is required\");\n            }\n\n            // Create the contact first\n            const contactResponse = await dataProvider.create(\"contacts\", {\n              data: {\n                first_name,\n                last_name,\n                gender,\n                title,\n                email_jsonb: parsedEmailJsonb,\n                phone_jsonb: parsedPhoneJsonb,\n                flat_villa_number,\n                building_street,\n                area,\n                google_maps_link,\n                phone_has_whatsapp: phone_has_whatsapp === \"TRUE\" || phone_has_whatsapp === \"true\",\n                services_interested: parsedServicesInterested,\n                description,\n                background,\n                first_seen: first_seen\n                  ? new Date(first_seen).toISOString()\n                  : today,\n                last_seen: last_seen\n                  ? new Date(last_seen).toISOString()\n                  : today,\n                has_newsletter,\n                status,\n                company_id: company?.id,\n                tags: tagList.map((tag) => tag.id),\n                sales_id: finalSalesId,\n                linkedin_url,\n              },\n            });\n\n            // Extract contact ID from response (handle both response.data and direct data)\n            const contact = ((contactResponse as any)?.data ?? contactResponse) as { id: number | string } | undefined;\n            const contactId = contact?.id;\n\n            // Create corresponding lead-journey entry if contact was created successfully\n            if (contactId) {\n              try {\n                await createLeadJourneyDealForContact(\n                  dataProvider,\n                  {\n                    id: contactId,\n                    first_name,\n                    last_name,\n                    sales_id: finalSalesId,\n                    company_id: company?.id ?? null,\n                  },\n                  finalSalesId,\n                );\n              } catch (error) {\n                // Log error but don't fail the import if lead-journey creation fails\n                // Using console.error here as logger may not be available in this context\n                // eslint-disable-next-line no-console\n                console.error(\"Error creating lead-journey entry for imported contact:\", error);\n              }\n            }\n\n            return contactResponse;\n          },\n        ),\n      );\n      \n      // Process results and collect errors\n      results.forEach((result, index) => {\n        if (result.status === \"rejected\") {\n          const rowNumber = startRowIndex + index;\n          const errorMessage = result.reason?.message || result.reason || \"Unknown error\";\n          errors.push({\n            row: rowNumber,\n            message: String(errorMessage),\n            data: batch[index],\n          });\n        }\n      });\n      \n      return errors;\n    },\n    [dataProvider, getCompanies, getTags, user?.identity?.id, today],\n  );\n\n  return processBatch;\n}\n\nconst fetchRecordsWithCache = async function <T>(\n  resource: string,\n  cache: Map<string, T>,\n  names: string[],\n  getCreateData: (name: string) => Partial<T>,\n  dataProvider: DataProvider,\n) {\n  const trimmedNames = [...new Set(names.map((name) => name.trim()))];\n  const uncachedRecordNames = trimmedNames.filter((name) => !cache.has(name));\n\n  // check the backend for existing records\n  if (uncachedRecordNames.length > 0) {\n    const response = await dataProvider.getList(resource, {\n      filter: {\n        \"name@in\": `(${uncachedRecordNames\n          .map((name) => `\"${name}\"`)\n          .join(\",\")})`,\n      },\n      pagination: { page: 1, perPage: trimmedNames.length },\n      sort: { field: \"id\", order: \"ASC\" },\n    });\n    for (const record of response.data) {\n      cache.set(record.name.trim(), record);\n    }\n  }\n\n  // create missing records in parallel\n  await Promise.all(\n    uncachedRecordNames.map(async (name) => {\n      if (cache.has(name)) return;\n      const response = await dataProvider.create(resource, {\n        data: getCreateData(name),\n      });\n      cache.set(name, response.data);\n    }),\n  );\n\n  // now all records are in cache, return a map of all records\n  return trimmedNames.reduce((acc, name) => {\n    acc.set(name, cache.get(name) as T);\n    return acc;\n  }, new Map<string, T>());\n};\n\nconst parseTags = (tags: string) =>\n  tags\n    ? String(tags)\n        .split(\",\")\n        .map((tag: string) => tag.trim())\n        .filter((tag: string) => tag)\n    : [];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/index.tsx",
      "content": "import type { Contact } from \"../types\";\nimport { ContactCreate } from \"./ContactCreate\";\nimport { ContactEdit } from \"./ContactEdit\";\nimport { ContactList } from \"./ContactList\";\nimport { ContactShow } from \"./ContactShow\";\n\nexport default {\n  list: ContactList,\n  show: ContactShow,\n  edit: ContactEdit,\n  create: ContactCreate,\n  recordRepresentation: (record: Contact) =>\n    record?.first_name + \" \" + record?.last_name,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/formatImportError.ts",
      "content": "import type { ImportError } from \"../misc/usePapaParse\";\n\nexport interface FormattedImportError {\n  row: number;\n  title: string;\n  message: string;\n  steps: string[];\n  data?: unknown;\n}\n\n/**\n * Formats import errors into plain English with actionable steps to fix them\n */\nexport function formatImportError(error: ImportError): FormattedImportError {\n  const { row, message, data } = error;\n  \n  // CSV parsing errors\n  if (message.includes(\"CSV parsing error\") || message.includes(\"Quoted field not terminated\")) {\n    return {\n      row,\n      title: \"CSV Format Error\",\n      message: \"The CSV file has formatting issues that prevent it from being read correctly.\",\n      steps: [\n        \"Open your CSV file in a text editor or spreadsheet application\",\n        \"Check for unclosed quotes or special characters in your data\",\n        \"Ensure all text fields with commas are properly quoted\",\n        \"Save the file and try importing again\",\n      ],\n      data,\n    };\n  }\n\n  // Missing required fields\n  if (message.includes(\"first_name\") || message.includes(\"last_name\") || message.includes(\"required\")) {\n    return {\n      row,\n      title: \"Missing Required Information\",\n      message: \"This row is missing required contact information.\",\n      steps: [\n        \"Open your CSV file\",\n        `Go to row ${row}`,\n        \"Make sure at least one of these columns has a value: 'first_name' or 'last_name'\",\n        \"Add the missing information and save the file\",\n        \"Try importing again\",\n      ],\n      data,\n    };\n  }\n\n  // Invalid date format\n  if (message.includes(\"date\") || message.includes(\"Invalid Date\") || message.includes(\"toISOString\")) {\n    return {\n      row,\n      title: \"Invalid Date Format\",\n      message: \"The date format in this row is not recognized.\",\n      steps: [\n        \"Open your CSV file\",\n        `Go to row ${row}`,\n        \"Check the date columns (first_seen, last_seen)\",\n        \"Make sure dates are in a standard format like: YYYY-MM-DD or YYYY-MM-DDTHH:mm:ss\",\n        \"Example: 2024-01-15 or 2024-01-15T10:30:00\",\n        \"Update the date and save the file\",\n        \"Try importing again\",\n      ],\n      data,\n    };\n  }\n\n  // Invalid JSON format\n  if (message.includes(\"JSON\") || message.includes(\"parse\") || message.includes(\"Unexpected token\")) {\n    return {\n      row,\n      title: \"Invalid Data Format\",\n      message: \"Some data in this row is not in the correct format.\",\n      steps: [\n        \"Open your CSV file\",\n        `Go to row ${row}`,\n        \"Check columns that contain JSON data (like email_jsonb or phone_jsonb)\",\n        \"If using JSON format, ensure it's valid JSON syntax\",\n        \"Alternatively, use the simple column format (email_work, phone_work, etc.)\",\n        \"Save the file and try importing again\",\n      ],\n      data,\n    };\n  }\n\n  // Email validation errors\n  if (message.includes(\"email\") || message.includes(\"Email\")) {\n    return {\n      row,\n      title: \"Invalid Email Address\",\n      message: \"One or more email addresses in this row are not valid.\",\n      steps: [\n        \"Open your CSV file\",\n        `Go to row ${row}`,\n        \"Check all email columns (email_work, email_home, email_other, or email_jsonb)\",\n        \"Make sure email addresses follow the format: name@domain.com\",\n        \"Remove any spaces or invalid characters\",\n        \"Save the file and try importing again\",\n      ],\n      data,\n    };\n  }\n\n  // Phone validation errors\n  if (message.includes(\"phone\") || message.includes(\"Phone\")) {\n    return {\n      row,\n      title: \"Invalid Phone Number\",\n      message: \"One or more phone numbers in this row are not valid.\",\n      steps: [\n        \"Open your CSV file\",\n        `Go to row ${row}`,\n        \"Check all phone columns (phone_work, phone_home, phone_other, or phone_jsonb)\",\n        \"Ensure phone numbers contain only digits, spaces, dashes, or plus signs\",\n        \"Save the file and try importing again\",\n      ],\n      data,\n    };\n  }\n\n  // Database/constraint errors\n  if (message.includes(\"duplicate\") || message.includes(\"unique\") || message.includes(\"constraint\")) {\n    return {\n      row,\n      title: \"Duplicate Entry\",\n      message: \"This contact already exists in the system.\",\n      steps: [\n        \"This contact may already be imported\",\n        \"Check if the contact exists in your contact list\",\n        \"If you want to update an existing contact, edit it directly instead of importing\",\n        \"Or remove this row from your CSV file and try importing again\",\n      ],\n      data,\n    };\n  }\n\n  // Foreign key errors (company, tag, etc.)\n  if (message.includes(\"foreign key\") || message.includes(\"company\") || message.includes(\"tag\")) {\n    return {\n      row,\n      title: \"Invalid Reference\",\n      message: \"This row references a company, tag, or other item that doesn't exist.\",\n      steps: [\n        \"Open your CSV file\",\n        `Go to row ${row}`,\n        \"Check the company name or tag names\",\n        \"Make sure the company exists in your system (create it first if needed)\",\n        \"Make sure tag names match exactly with existing tags (case-sensitive)\",\n        \"Or remove the company/tag reference and add it later\",\n        \"Save the file and try importing again\",\n      ],\n      data,\n    };\n  }\n\n  // Generic database errors\n  if (message.includes(\"database\") || message.includes(\"Database\") || message.includes(\"SQL\")) {\n    return {\n      row,\n      title: \"Database Error\",\n      message: \"There was a problem saving this contact to the database.\",\n      steps: [\n        \"This might be a temporary issue\",\n        \"Check your internet connection\",\n        \"Try importing again\",\n        \"If the problem persists, contact support\",\n      ],\n      data,\n    };\n  }\n\n  // Unknown error - provide generic help\n  return {\n    row,\n    title: \"Import Error\",\n    message: message || \"An unexpected error occurred while importing this row.\",\n    steps: [\n      \"Open your CSV file\",\n      `Go to row ${row}`,\n      \"Review the data in this row for any obvious issues\",\n      \"Compare it with the sample CSV template\",\n      \"Make sure all required fields are filled\",\n      \"Check for special characters or formatting issues\",\n      \"Save the file and try importing again\",\n      \"If the problem persists, try importing fewer rows at a time\",\n    ],\n    data,\n  };\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/exportToVCard.ts",
      "content": "import type { Contact, Company } from \"../types\";\n\n/**\n * Folds a long line according to vCard specification (max 75 chars per line)\n * Continuation lines start with a space\n */\nfunction foldLine(line: string): string {\n  const maxLength = 75;\n  if (line.length <= maxLength) return line;\n\n  const result: string[] = [];\n  let currentLine = line.substring(0, maxLength);\n  let remaining = line.substring(maxLength);\n\n  result.push(currentLine);\n\n  while (remaining.length > 0) {\n    // Continuation lines start with a space and can have 74 more chars\n    const chunkSize = maxLength - 1;\n    currentLine = \" \" + remaining.substring(0, chunkSize);\n    remaining = remaining.substring(chunkSize);\n    result.push(currentLine);\n  }\n\n  return result.join(\"\\r\\n\");\n}\n\n/**\n * Converts a contact and their company to vCard 3.0 format\n */\nexport function exportToVCard(\n  contact: Contact,\n  company?: Company,\n  photoData?: { base64: string; mimeType: string },\n): string {\n  const lines: string[] = [];\n\n  // vCard header\n  lines.push(\"BEGIN:VCARD\");\n  lines.push(\"VERSION:3.0\");\n\n  // Name (N: Family Name;Given Name;Additional Names;Honorific Prefixes;Honorific Suffixes)\n  lines.push(`N:${contact.last_name};${contact.first_name};;;`);\n\n  // Formatted name\n  lines.push(`FN:${contact.first_name} ${contact.last_name}`);\n\n  // Title/Job position\n  if (contact.title) {\n    lines.push(`TITLE:${contact.title}`);\n  }\n\n  // Organization\n  if (company?.name) {\n    lines.push(`ORG:${company.name}`);\n  }\n\n  // Emails\n  if (contact.email_jsonb && contact.email_jsonb.length > 0) {\n    contact.email_jsonb.forEach((emailObj) => {\n      const type = emailObj.type.toUpperCase();\n      lines.push(`EMAIL;TYPE=${type}:${emailObj.email}`);\n    });\n  }\n\n  // Phone numbers\n  if (contact.phone_jsonb && contact.phone_jsonb.length > 0) {\n    contact.phone_jsonb.forEach((phoneObj) => {\n      const type = phoneObj.type.toUpperCase();\n      lines.push(`TEL;TYPE=${type}:${phoneObj.number}`);\n    });\n  }\n\n  // LinkedIn URL\n  if (contact.linkedin_url) {\n    lines.push(`URL:${contact.linkedin_url}`);\n  }\n\n  // Background/Note\n  if (contact.background) {\n    // Escape newlines and special characters in notes\n    const escapedNote = contact.background\n      .replace(/\\\\/g, \"\\\\\\\\\")\n      .replace(/\\n/g, \"\\\\n\")\n      .replace(/,/g, \"\\\\,\")\n      .replace(/;/g, \"\\\\;\");\n    lines.push(`NOTE:${escapedNote}`);\n  }\n\n  // Photo/Avatar - vCard 3.0 format with base64 encoding\n  if (photoData) {\n    // Extract image type from MIME type (e.g., \"image/png\" -> \"PNG\")\n    const imageType = photoData.mimeType.split(\"/\")[1]?.toUpperCase() || \"PNG\";\n\n    // vCard 3.0 format: PHOTO;ENCODING=b;TYPE=PNG:\n    const photoLine = `PHOTO;ENCODING=b;TYPE=${imageType}:${photoData.base64}`;\n    lines.push(foldLine(photoLine));\n  }\n\n  // vCard footer\n  lines.push(\"END:VCARD\");\n\n  return lines.join(\"\\r\\n\");\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/TagsListEdit.tsx",
      "content": "import { Edit, Plus } from \"lucide-react\";\nimport {\n  useGetList,\n  useGetMany,\n  useRecordContext,\n  useUpdate,\n  type Identifier,\n} from \"ra-core\";\nimport { useCallback, useState } from \"react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nimport { TagChip } from \"../tags/TagChip\";\nimport { TagCreateModal } from \"../tags/TagCreateModal\";\nimport type { Contact, Tag } from \"../types\";\n\nexport const TagsListEdit = () => {\n  const record = useRecordContext<Contact>();\n  const [open, setOpen] = useState(false);\n\n  const { data: allTags, isPending: isPendingAllTags } = useGetList<Tag>(\n    \"tags\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"name\", order: \"ASC\" },\n    },\n  );\n  const { data: tags, isPending: isPendingRecordTags } = useGetMany<Tag>(\n    \"tags\",\n    { ids: record?.tags },\n    { enabled: record && record.tags && record.tags.length > 0 },\n  );\n  const [update] = useUpdate<Contact>();\n\n  const unselectedTags =\n    allTags && record && allTags.filter((tag) => !record.tags.includes(tag.id));\n\n  const handleTagAdd = (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    const tags = [...record.tags, id];\n    update(\"contacts\", {\n      id: record.id,\n      data: { tags },\n      previousData: record,\n    });\n  };\n\n  const handleTagDelete = async (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    const tags = record.tags.filter((tagId) => tagId !== id);\n    await update(\"contacts\", {\n      id: record.id,\n      data: { tags },\n      previousData: record,\n    });\n  };\n\n  const openTagCreateDialog = () => {\n    setOpen(true);\n  };\n\n  const handleTagCreateClose = () => {\n    setOpen(false);\n  };\n\n  const handleTagCreated = useCallback(\n    async (tag: Tag) => {\n      if (!record) {\n        throw new Error(\"No contact record found\");\n      }\n\n      await update(\n        \"contacts\",\n        {\n          id: record.id,\n          data: { tags: [...record.tags, tag.id] },\n          previousData: record,\n        },\n        {\n          onSuccess: () => {\n            setOpen(false);\n          },\n        },\n      );\n    },\n    [update, record],\n  );\n\n  if (isPendingRecordTags || isPendingAllTags) return null;\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      {tags?.map((tag) => (\n        <div key={tag.id}>\n          <TagChip tag={tag} onUnlink={() => handleTagDelete(tag.id)} />\n        </div>\n      ))}\n\n      <div>\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button variant=\"outline\" size=\"sm\" className=\"h-6 cursor-pointer\">\n              <Plus className=\"h-3 w-3 mr-1\" />\n              Add tag\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent>\n            {unselectedTags?.map((tag) => (\n              <DropdownMenuItem\n                key={tag.id}\n                onClick={() => handleTagAdd(tag.id)}\n              >\n                <Badge\n                  variant=\"secondary\"\n                  className=\"text-xs font-normal text-black\"\n                  style={{\n                    backgroundColor: tag.color,\n                  }}\n                >\n                  {tag.name}\n                </Badge>\n              </DropdownMenuItem>\n            ))}\n            <DropdownMenuItem onClick={openTagCreateDialog}>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"w-full justify-start p-0 cursor-pointer\"\n              >\n                <Edit className=\"h-3 w-3 mr-2\" />\n                Create new tag\n              </Button>\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n      </div>\n\n      <TagCreateModal\n        open={open}\n        onClose={handleTagCreateClose}\n        onSuccess={handleTagCreated}\n      />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/TagsList.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\nimport { ReferenceArrayField } from \"@/components/admin/reference-array-field\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\n\nconst ColoredBadge = (props: any) => {\n  const record = useRecordContext();\n  if (!record) return null;\n  return (\n    <Badge\n      {...props}\n      style={{ backgroundColor: record.color, border: 0 }}\n      variant=\"outline\"\n      className={cn(\"text-black font-normal\", props.className)}\n    >\n      {record.name}\n    </Badge>\n  );\n};\n\nexport const TagsList = () => (\n  <ReferenceArrayField\n    className=\"inline-block\"\n    resource=\"contacts\"\n    source=\"tags\"\n    reference=\"tags\"\n  >\n    <SingleFieldList>\n      <ColoredBadge source=\"name\" />\n    </SingleFieldList>\n  </ReferenceArrayField>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ServicesListEdit.tsx",
      "content": "import { X, Plus } from \"lucide-react\";\nimport {\n  useGetList,\n  useGetMany,\n  useRecordContext,\n  useUpdate,\n  type Identifier,\n} from \"ra-core\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nimport type { Contact, Service } from \"../types\";\n\nexport const ServicesListEdit = () => {\n  const record = useRecordContext<Contact>();\n\n  const { data: allServices, isPending: isPendingAllServices } = useGetList<Service>(\n    \"services\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"name\", order: \"ASC\" },\n    },\n  );\n  const { data: services, isPending: isPendingRecordServices } = useGetMany<Service>(\n    \"services\",\n    { ids: record?.services_interested || [] },\n    { enabled: record && record.services_interested && record.services_interested.length > 0 },\n  );\n  const [update] = useUpdate<Contact>();\n\n  const unselectedServices =\n    allServices && record && record.services_interested\n      ? allServices.filter((service) => !record.services_interested.includes(service.id))\n      : allServices;\n\n  const handleServiceAdd = (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    const services_interested = [...(record.services_interested || []), id];\n    update(\"contacts\", {\n      id: record.id,\n      data: { services_interested },\n      previousData: record,\n    });\n  };\n\n  const handleServiceDelete = async (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    // Prevent deletion if there's only 1 service remaining\n    const currentServicesCount = (record.services_interested || []).length;\n    if (currentServicesCount <= 1) {\n      return;\n    }\n    const services_interested = (record.services_interested || []).filter((serviceId) => serviceId !== id);\n    await update(\"contacts\", {\n      id: record.id,\n      data: { services_interested },\n      previousData: record,\n    });\n  };\n\n  if (isPendingRecordServices || isPendingAllServices) return null;\n\n  const servicesCount = record?.services_interested?.length || 0;\n  const canRemoveService = servicesCount > 1;\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      {services?.map((service) => (\n        <Badge\n          key={service.id}\n          variant=\"secondary\"\n          className=\"text-xs font-normal pr-1\"\n        >\n          {service.name}\n          {canRemoveService && (\n            <button\n              onClick={() => handleServiceDelete(service.id)}\n              className=\"ml-1 hover:bg-secondary-foreground/20 rounded-full p-0.5\"\n              aria-label={`Remove ${service.name}`}\n            >\n              <X className=\"h-3 w-3\" />\n            </button>\n          )}\n        </Badge>\n      ))}\n\n      {unselectedServices && unselectedServices.length > 0 && (\n        <div>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" size=\"sm\" className=\"h-6 cursor-pointer\">\n                <Plus className=\"h-3 w-3 mr-1\" />\n                Add service\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent>\n              {unselectedServices.map((service) => (\n                <DropdownMenuItem\n                  key={service.id}\n                  onClick={() => handleServiceAdd(service.id)}\n                >\n                  {service.name}\n                </DropdownMenuItem>\n              ))}\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      )}\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/LeadInputs.tsx",
      "content": "import { email, required } from \"ra-core\";\nimport { ArrayInput } from \"@/components/admin/array-input\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { SimpleFormIterator } from \"@/components/admin/simple-form-iterator\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { RadioButtonGroupInput } from \"@/components/admin/radio-button-group-input\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { useFormContext } from \"react-hook-form\";\nimport { MapPin } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useInput, FieldTitle, useResourceContext } from \"ra-core\";\nimport {\n  FormControl,\n  FormField,\n  FormLabel,\n} from \"@/components/admin/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { InputHelperText } from \"@/components/admin/input-helper-text\";\nimport { FormError } from \"@/components/admin/form\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nexport const LeadInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-6\">\n      <BasicInformation />\n      <AddressInformation />\n    </div>\n  );\n};\n\nconst BasicInformation = () => {\n  const { contactGender } = useConfigurationContext();\n  // Filter to only show male and female options for the toggle\n  const genderOptions = contactGender.filter(g => g.value === \"male\" || g.value === \"female\");\n  \n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-lg font-semibold\">Basic Information</CardTitle>\n      </CardHeader>\n      <CardContent className=\"flex flex-col gap-6\">\n        <div className=\"grid grid-cols-2 gap-4\">\n          <TextInput\n            source=\"first_name\"\n            label=\"First Name\"\n            validate={required()}\n            helperText={false}\n          />\n          <TextInput\n            source=\"last_name\"\n            label=\"Last Name\"\n            helperText={false}\n          />\n        </div>\n\n        <RadioButtonGroupInput\n          source=\"gender\"\n          label=\"Gender\"\n          choices={genderOptions}\n          optionText=\"label\"\n          optionValue=\"value\"\n          helperText={false}\n          row\n          defaultValue={genderOptions[0]?.value}\n        />\n\n        <div className=\"space-y-4\">\n          <ArrayInput source=\"phone_jsonb\" label=\"Phone Number\" helperText={false}>\n            <SimpleFormIterator\n              inline\n              disableReordering\n              disableClear\n              className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n            >\n              <TextInput\n                source=\"number\"\n                className=\"w-full\"\n                helperText={false}\n                label={false}\n                placeholder=\"Phone number\"\n                validate={required()}\n              />\n            </SimpleFormIterator>\n          </ArrayInput>\n\n          <BooleanInput\n            source=\"phone_has_whatsapp\"\n            label=\"Phone number has WhatsApp\"\n            helperText={false}\n          />\n        </div>\n\n        <ArrayInput source=\"email_jsonb\" label=\"Email\" helperText={false}>\n          <SimpleFormIterator\n            inline\n            disableReordering\n            disableClear\n            className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n          >\n            <TextInput\n              source=\"email\"\n              className=\"w-full\"\n              helperText={false}\n              label={false}\n              placeholder=\"Email\"\n              validate={email()}\n            />\n          </SimpleFormIterator>\n        </ArrayInput>\n\n        <TextInput\n          source=\"description\"\n          label=\"Description\"\n          multiline\n          rows={4}\n          helperText={false}\n          placeholder=\"Add a description about this lead\"\n        />\n      </CardContent>\n    </Card>\n  );\n};\n\n// Custom Coordinates Input Component\nconst CoordinatesInput = () => {\n  const resource = useResourceContext();\n  const { watch, setValue } = useFormContext();\n  const latitude = watch(\"latitude\");\n  const longitude = watch(\"longitude\");\n  const { field, id, isRequired } = useInput({\n    source: \"coordinates\",\n    validate: required(),\n  });\n\n  // Format coordinates for display - prioritize lat/lng from form, fallback to field value\n  const displayValue =\n    latitude != null && longitude != null\n      ? `${latitude}, ${longitude}`\n      : field.value || \"\";\n\n  // Parse coordinates from \"lat, lng\" format and update latitude/longitude\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value;\n    field.onChange(value);\n\n    const parts = value.split(\",\").map((s) => s.trim());\n    if (parts.length === 2) {\n      const lat = parseFloat(parts[0]);\n      const lng = parseFloat(parts[1]);\n      if (!isNaN(lat) && !isNaN(lng)) {\n        setValue(\"latitude\", lat, { shouldDirty: true });\n        setValue(\"longitude\", lng, { shouldDirty: true });\n      }\n    }\n  };\n\n  return (\n    <FormField id={id} name={field.name}>\n      <FormLabel>\n        <FieldTitle\n          label=\"Coordinates (Latitude, Longitude)\"\n          source=\"coordinates\"\n          resource={resource}\n          isRequired={isRequired}\n        />\n      </FormLabel>\n      <FormControl>\n        <Input\n          name={field.name}\n          onBlur={field.onBlur}\n          value={displayValue}\n          onChange={handleChange}\n          placeholder=\"25.157134, 55.409436\"\n        />\n      </FormControl>\n      <InputHelperText helperText={false} />\n      <FormError />\n    </FormField>\n  );\n};\n\nconst AddressInformation = () => {\n  const { watch, setValue } = useFormContext();\n  const latitude = watch(\"latitude\");\n  const longitude = watch(\"longitude\");\n\n  // Generate Google Maps link from coordinates\n  const generateGoogleMapsLink = () => {\n    if (latitude != null && longitude != null) {\n      const link = `https://www.google.com/maps?q=${latitude},${longitude}`;\n      setValue(\"google_maps_link\", link, { shouldDirty: true });\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-lg font-semibold\">Address Information</CardTitle>\n      </CardHeader>\n      <CardContent className=\"flex flex-col gap-6\">\n        {/* Two-column layout for Flat/Villa Number and Building/Street */}\n        <div className=\"grid grid-cols-2 gap-4\">\n          <TextInput\n            source=\"flat_villa_number\"\n            label=\"Flat/Villa Number\"\n            helperText={false}\n            validate={required()}\n            placeholder=\"e.g., Villa 123\"\n          />\n          <TextInput\n            source=\"building_street\"\n            label=\"Building/Street\"\n            helperText={false}\n            validate={required()}\n            placeholder=\"e.g., Sheikh Zayed Road\"\n          />\n        </div>\n\n        {/* Two-column layout for Area and City */}\n        <div className=\"grid grid-cols-2 gap-4\">\n          <TextInput\n            source=\"area\"\n            label=\"Area\"\n            helperText={false}\n            validate={required()}\n            placeholder=\"e.g., Dubai Marina\"\n          />\n          <TextInput\n            source=\"city\"\n            label=\"City\"\n            helperText={false}\n            validate={required()}\n            placeholder=\"e.g., Dubai\"\n          />\n        </div>\n\n        {/* Google Maps Link with button */}\n        <div className=\"flex flex-col gap-2\">\n          <div className=\"flex items-end gap-2\">\n            <div className=\"flex-1\">\n              <TextInput\n                source=\"google_maps_link\"\n                label=\"Google Maps Link\"\n                helperText={false}\n                placeholder=\"https://maps.google.com/...\"\n              />\n            </div>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              size=\"icon\"\n              onClick={generateGoogleMapsLink}\n              disabled={latitude == null || longitude == null}\n              className=\"h-9 w-9 shrink-0 mb-0.5\"\n              title=\"Generate Google Maps link from coordinates\"\n            >\n              <MapPin className=\"h-4 w-4 text-red-500\" />\n            </Button>\n          </div>\n          <p className=\"text-xs text-muted-foreground px-1\">\n            Enter coordinates below and click the location icon to create a Google Maps link\n          </p>\n        </div>\n\n        {/* Coordinates field */}\n        <div className=\"flex flex-col gap-2\">\n          <CoordinatesInput />\n          <p className=\"text-xs text-muted-foreground px-1\">\n            Enter coordinates manually in the field below\n          </p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ExportVCardButton.tsx",
      "content": "import { Download } from \"lucide-react\";\nimport { useGetOne, useRecordContext } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport type { Contact, Company } from \"../types\";\nimport { exportToVCard } from \"./exportToVCard\";\n\nexport const ExportVCardButton = () => {\n  const contact = useRecordContext<Contact>();\n\n  // Fetch the company data on mount\n  const { data: company } = useGetOne<Company>(\n    \"companies\",\n    { id: contact?.company_id },\n    { enabled: !!contact?.company_id },\n  );\n\n  const handleExport = async () => {\n    if (!contact) return;\n\n    // Fetch and convert avatar to base64 if it exists\n    let photoData: { base64: string; mimeType: string } | undefined = undefined;\n\n    if (contact.avatar?.src) {\n      try {\n        const response = await fetch(contact.avatar.src);\n        const blob = await response.blob();\n        const mimeType = blob.type || \"image/png\";\n\n        // Convert blob to base64\n        const base64 = await new Promise<string>((resolve, reject) => {\n          const reader = new FileReader();\n          reader.onloadend = () => {\n            const result = reader.result as string;\n            // Remove the data URL prefix (data:image/png;base64,)\n            const base64Data = result.split(\",\")[1];\n            resolve(base64Data);\n          };\n          reader.onerror = reject;\n          reader.readAsDataURL(blob);\n        });\n\n        photoData = { base64, mimeType };\n      } catch (error) {\n        console.error(\"Failed to fetch avatar image:\", error);\n        // Continue without the photo\n      }\n    }\n\n    // Generate vCard content\n    const vCardContent = exportToVCard(contact, company, photoData);\n\n    // Create blob and download\n    const blob = new Blob([vCardContent], {\n      type: \"text/vcard;charset=utf-8\",\n    });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement(\"a\");\n    link.href = url;\n    link.download = `${contact.first_name}_${contact.last_name}.vcf`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  };\n\n  if (!contact) return null;\n\n  return (\n    <Button\n      variant=\"outline\"\n      size=\"sm\"\n      onClick={handleExport}\n      className=\"h-6 cursor-pointer\"\n    >\n      <Download className=\"w-4 h-4\" />\n      Export to vCard\n    </Button>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactShow.tsx",
      "content": "import {\n  ShowBase,\n  useShowContext,\n  useGetList,\n  RecordContextProvider,\n  useRefresh,\n  useUpdate,\n  useNotify,\n} from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Edit, Save, CircleX } from \"lucide-react\";\nimport { useMemo, useState, useEffect } from \"react\";\nimport type { SubmitHandler, FieldValues } from \"react-hook-form\";\nimport { useForm, FormProvider } from \"react-hook-form\";\nimport { useLocation } from \"react-router\";\n\nimport type { Contact, Task, Quote, Deal } from \"../types\";\nimport { ContactAside } from \"./ContactAside\";\nimport { QuoteItem } from \"../quotes/QuoteItem\";\nimport { AddQuote } from \"../quotes/AddQuote\";\nimport { Task as TaskComponent } from \"../tasks/Task\";\nimport { AddTask } from \"../tasks/AddTask\";\nimport { UnifiedNotesIterator } from \"../notes/UnifiedNotesIterator\";\nimport { ActivityLog } from \"../activity/ActivityLog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport {\n  crmAddDays,\n  crmEndOfDay,\n  crmEndOfWeek,\n  crmStartOfDay,\n} from \"../misc/timezone\";\n\nexport const ContactShow = () => (\n  <ShowBase>\n    <ContactShowContent />\n  </ShowBase>\n);\n\nconst ContactShowContent = () => {\n  const { record, isPending } = useShowContext<Contact>();\n  const refresh = useRefresh();\n  const [isEditingDescription, setIsEditingDescription] = useState(false);\n  const [update, { isPending: isUpdating }] = useUpdate();\n  const notify = useNotify();\n  const location = useLocation();\n\n  // Fetch deals associated with this contact to get deal IDs for notes\n  // Fetch both archived and non-archived deals\n  const { data: deals } = useGetList<Deal>(\"lead-journey\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record?.id ? { lead_id: record.id } : {},\n    sort: { field: \"archived_at\", order: \"ASC\" }, // Non-archived first\n  }, { enabled: !!record?.id });\n  \n  // Separate archived and non-archived deals\n  const sortedDeals = useMemo(() => {\n    if (!deals) return [];\n    const active = deals.filter(d => !d.archived_at);\n    const archived = deals.filter(d => d.archived_at);\n    return [...active, ...archived];\n  }, [deals]);\n\n  // Get all deal IDs for fetching notes from all deals\n  const dealIds = useMemo(() => {\n    return deals?.map(deal => deal.id) || [];\n  }, [deals]);\n\n  const { data: quotes } = useGetList<Quote>(\"quotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n    filter: record?.id ? { contact_id: record.id } : {},\n  }, { enabled: !!record?.id });\n\n  const { data: tasks } = useGetList<Task>(\"tasks\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record?.id ? { contact_id: record.id } : {},\n  }, { enabled: !!record?.id });\n\n  const [showCompletedTasks, setShowCompletedTasks] = useState(false);\n\n  const groupedTasks = useMemo(() => {\n    const empty = {\n      overdue: [] as Task[],\n      today: [] as Task[],\n      tomorrow: [] as Task[],\n      thisWeek: [] as Task[],\n      later: [] as Task[],\n      completed: [] as Task[],\n    };\n    if (!tasks) return empty;\n\n    const startOfToday = crmStartOfDay() ?? new Date();\n    const endOfToday = crmEndOfDay() ?? new Date();\n    const endOfTomorrow = crmEndOfDay(crmAddDays(new Date(), 1)) ?? new Date();\n    const endOfWeek = crmEndOfWeek() ?? new Date();\n\n    for (const task of tasks) {\n      if (task.done_date) {\n        empty.completed.push(task);\n        continue;\n      }\n\n      const due = task.due_date ? new Date(task.due_date) : null;\n      if (!due || Number.isNaN(due.getTime())) {\n        empty.later.push(task);\n        continue;\n      }\n\n      if (due < startOfToday) empty.overdue.push(task);\n      else if (due <= endOfToday) empty.today.push(task);\n      else if (due <= endOfTomorrow) empty.tomorrow.push(task);\n      else if (due <= endOfWeek) empty.thisWeek.push(task);\n      else empty.later.push(task);\n    }\n\n    const byDueDateAsc = (a: Task, b: Task) =>\n      new Date(a.due_date || 0).getTime() - new Date(b.due_date || 0).getTime();\n\n    empty.overdue.sort(byDueDateAsc);\n    empty.today.sort(byDueDateAsc);\n    empty.tomorrow.sort(byDueDateAsc);\n    empty.thisWeek.sort(byDueDateAsc);\n    empty.later.sort(byDueDateAsc);\n\n    empty.completed.sort(\n      (a, b) => new Date(b.done_date || 0).getTime() - new Date(a.done_date || 0).getTime(),\n    );\n\n    return empty;\n  }, [tasks]);\n\n  const form = useForm<{ description: string }>({\n    defaultValues: {\n      description: record?.description || \"\",\n    },\n  });\n\n  // Reset form when record ID changes (different contact)\n  useEffect(() => {\n    if (record) {\n      form.reset({ description: record.description || \"\" });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [record?.id]);\n\n  // If we deep-link with a hash (#note-123 / #task-456), scroll to it once content renders.\n  useEffect(() => {\n    if (!record) return;\n    const hash = (location.hash || \"\").replace(/^#/, \"\");\n    if (!hash) return;\n\n    let tries = 0;\n    const tryScroll = () => {\n      tries += 1;\n      const el = document.getElementById(hash);\n      if (el) {\n        el.scrollIntoView({ block: \"center\", behavior: \"smooth\" });\n        return;\n      }\n      if (tries < 20) {\n        setTimeout(tryScroll, 150);\n      }\n    };\n    tryScroll();\n  }, [location.hash, record]);\n\n  const handleDescriptionUpdate: SubmitHandler<FieldValues> = (values) => {\n    if (!record) return;\n    update(\n      \"contacts\",\n      { id: record.id, data: { description: values.description || null }, previousData: record },\n      {\n        onSuccess: () => {\n          setIsEditingDescription(false);\n          refresh();\n          notify(\"Description updated\", { type: \"info\" });\n        },\n        onError: (error: any) => {\n          console.error(\"Error updating description:\", error);\n          notify(\n            error?.message?.includes(\"description\") \n              ? \"Description column not found. Please ensure migrations are applied.\"\n              : \"Failed to update description\",\n            { type: \"error\" }\n          );\n        },\n      },\n    );\n  };\n\n  const handleCancelEdit = () => {\n    if (record) {\n      form.reset({ description: record.description || \"\" });\n    }\n    setIsEditingDescription(false);\n  };\n\n  if (isPending || !record) return null;\n\n  const defaultTab = (() => {\n    const tab = new URLSearchParams(location.search).get(\"tab\");\n    if (tab === \"notes\" || tab === \"quotes\" || tab === \"tasks\" || tab === \"activity\" || tab === \"packages\") {\n      return tab;\n    }\n    return \"activity\";\n  })();\n\n  return (\n    <div className=\"mt-2 mb-2 flex gap-8\">\n      <div className=\"flex-1\">\n        <Card>\n          <CardContent>\n            <div className=\"flex\">\n              <div className=\"flex-1\">\n                <h5 className=\"text-xl font-semibold\">\n                  {record.first_name} {record.last_name}\n                </h5>\n                <div className=\"inline-flex text-sm text-muted-foreground\">\n                  {record.title}\n                  {record.title && record.company_id != null && \" at \"}\n                  {record.company_id != null && (\n                    <ReferenceField\n                      source=\"company_id\"\n                      reference=\"companies\"\n                      link=\"show\"\n                    >\n                      &nbsp;\n                      <TextField source=\"name\" />\n                    </ReferenceField>\n                  )}\n                </div>\n                <div className=\"mt-4\">\n                  {isEditingDescription ? (\n                    <FormProvider {...form}>\n                      <form onSubmit={form.handleSubmit(handleDescriptionUpdate)}>\n                        <div className=\"flex flex-col gap-2\">\n                          <Textarea\n                            {...form.register(\"description\")}\n                            placeholder=\"Add a description...\"\n                            rows={4}\n                            className=\"text-sm\"\n                          />\n                          <div className=\"flex justify-end gap-2\">\n                            <Button\n                              variant=\"outline\"\n                              onClick={handleCancelEdit}\n                              type=\"button\"\n                              size=\"sm\"\n                              className=\"cursor-pointer\"\n                            >\n                              <CircleX className=\"w-4 h-4 mr-2\" />\n                              Cancel\n                            </Button>\n                            <Button\n                              type=\"submit\"\n                              disabled={isUpdating}\n                              size=\"sm\"\n                              className=\"cursor-pointer\"\n                            >\n                              <Save className=\"w-4 h-4 mr-2\" />\n                              Save\n                            </Button>\n                          </div>\n                        </div>\n                      </form>\n                    </FormProvider>\n                  ) : (\n                    <div className=\"group relative\">\n                      {record.description ? (\n                        <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                          {record.description}\n                        </p>\n                      ) : (\n                        <p className=\"text-sm text-muted-foreground italic\">\n                          No description\n                        </p>\n                      )}\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => {\n                          form.reset({ description: record.description || \"\" });\n                          setIsEditingDescription(true);\n                        }}\n                        className=\"mt-2 h-7 cursor-pointer\"\n                      >\n                        <Edit className=\"w-3.5 h-3.5 mr-2\" />\n                        {record.description ? \"Edit description\" : \"Add description\"}\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n            \n            <Tabs defaultValue={defaultTab} className=\"mt-6\">\n              <TabsList className=\"w-full\">\n                <TabsTrigger value=\"activity\" className=\"flex-1\">Activity</TabsTrigger>\n                <TabsTrigger value=\"notes\" className=\"flex-1\">Notes</TabsTrigger>\n                <TabsTrigger value=\"quotes\" className=\"flex-1\">Quotes</TabsTrigger>\n                <TabsTrigger value=\"tasks\" className=\"flex-1\">Tasks</TabsTrigger>\n              </TabsList>\n              \n              <TabsContent value=\"activity\" className=\"pt-4\">\n                <Card className=\"mb-2 p-6\">\n                  <ActivityLog contactId={record.id} pageSize={10} context=\"contact\" />\n                </Card>\n              </TabsContent>\n              \n              <TabsContent value=\"notes\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <UnifiedNotesIterator\n                    reference=\"contacts\"\n                    showStatus\n                    contactId={record.id}\n                    leadId={record.id}\n                    dealIds={dealIds}\n                  />\n                </RecordContextProvider>\n              </TabsContent>\n              \n              <TabsContent value=\"quotes\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <AddQuote />\n                </RecordContextProvider>\n                {quotes && quotes.length > 0 && (\n                  <div className=\"mt-4 space-y-2\">\n                    {quotes.map((quote) => (\n                      <QuoteItem quote={quote} key={quote.id} />\n                    ))}\n                  </div>\n                )}\n              </TabsContent>\n              \n              <TabsContent value=\"tasks\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <AddTask />\n                </RecordContextProvider>\n                <div className=\"mt-4 space-y-6\">\n                  {tasks && tasks.length > 0 ? (\n                    <>\n                      {groupedTasks.overdue.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Overdue\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.overdue.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.today.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Today\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.today.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.tomorrow.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Tomorrow\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.tomorrow.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.thisWeek.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            This Week\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.thisWeek.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.later.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Later\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.later.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.completed.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            className=\"cursor-pointer\"\n                            onClick={() => setShowCompletedTasks((v) => !v)}\n                          >\n                            {showCompletedTasks ? \"Hide\" : \"Show\"} completed (\n                            {groupedTasks.completed.length})\n                          </Button>\n                          {showCompletedTasks && (\n                            <div className=\"space-y-2\">\n                              {groupedTasks.completed.map((task) => (\n                                <TaskComponent task={task} key={task.id} />\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </>\n                  ) : (\n                    <p className=\"text-sm text-muted-foreground\">No tasks yet</p>\n                  )}\n                </div>\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n      <ContactAside deals={sortedDeals} />\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactMergeButton.tsx",
      "content": "import { useState, useEffect } from \"react\";\nimport { Merge, CircleX, AlertTriangle, ArrowDown } from \"lucide-react\";\nimport {\n  useDataProvider,\n  useRecordContext,\n  useGetList,\n  useGetManyReference,\n  required,\n  Form,\n  useNotify,\n  useRedirect,\n} from \"ra-core\";\nimport type { Identifier } from \"ra-core\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport type { Contact } from \"../types\";\nimport { contactOptionText } from \"../misc/ContactOption\";\n\nexport const ContactMergeButton = () => {\n  const [mergeDialogOpen, setMergeDialogOpen] = useState(false);\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        className=\"h-6 cursor-pointer\"\n        size=\"sm\"\n        onClick={() => setMergeDialogOpen(true)}\n      >\n        <Merge className=\"w-4 h-4\" />\n        Merge with another contact\n      </Button>\n      <ContactMergeDialog\n        open={mergeDialogOpen}\n        onClose={() => setMergeDialogOpen(false)}\n      />\n    </>\n  );\n};\n\ninterface ContactMergeDialogProps {\n  open: boolean;\n  onClose: () => void;\n}\n\nconst ContactMergeDialog = ({ open, onClose }: ContactMergeDialogProps) => {\n  const loserContact = useRecordContext<Contact>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const [winnerId, setWinnerId] = useState<Identifier | null>(null);\n  const [suggestedWinnerId, setSuggestedWinnerId] = useState<Identifier | null>(\n    null,\n  );\n  const [isMerging, setIsMerging] = useState(false);\n  const { mutateAsync } = useMutation({\n    mutationKey: [\"contacts\", \"merge\", { loserId: loserContact?.id, winnerId }],\n    mutationFn: async () => {\n      return dataProvider.mergeContacts(loserContact?.id, winnerId);\n    },\n  });\n\n  // Find potential contacts with matching first and last name\n  const { data: matchingContacts } = useGetList(\n    \"contacts\",\n    {\n      filter: {\n        first_name: loserContact?.first_name,\n        last_name: loserContact?.last_name,\n        \"id@neq\": `${loserContact?.id}`, // Exclude current contact\n      },\n      pagination: { page: 1, perPage: 10 },\n    },\n    { enabled: open && !!loserContact },\n  );\n\n  // Get counts of items to be merged\n  const canFetchCounts = open && !!loserContact && !!winnerId;\n  const { total: tasksCount } = useGetManyReference(\n    \"tasks\",\n    {\n      target: \"contact_id\",\n      id: loserContact?.id,\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  const { total: notesCount } = useGetManyReference(\n    \"contactNotes\",\n    {\n      target: \"contact_id\",\n      id: loserContact?.id,\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  const { total: dealsCount } = useGetList(\n    \"deals\",\n    {\n      filter: { \"contact_ids@cs\": `{${loserContact?.id}}` },\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  useEffect(() => {\n    if (matchingContacts && matchingContacts.length > 0) {\n      const suggestedWinnerId = matchingContacts[0].id;\n      setSuggestedWinnerId(suggestedWinnerId);\n      setWinnerId(suggestedWinnerId);\n    }\n  }, [matchingContacts]);\n\n  const handleMerge = async () => {\n    if (!winnerId || !loserContact) {\n      notify(\"Please select a contact to merge with\", { type: \"warning\" });\n      return;\n    }\n\n    try {\n      setIsMerging(true);\n      await mutateAsync();\n      setIsMerging(false);\n      notify(\"Contacts merged successfully\", { type: \"success\" });\n      redirect(`/contacts/${winnerId}/show`);\n      onClose();\n    } catch (error) {\n      setIsMerging(false);\n      notify(\"Failed to merge contacts\", { type: \"error\" });\n      console.error(\"Merge failed:\", error);\n    }\n  };\n\n  if (!loserContact) return null;\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"md:min-w-lg max-w-2xl\">\n        <DialogHeader>\n          <DialogTitle>Merge Contact</DialogTitle>\n          <DialogDescription>\n            Merge this contact with another one.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"p-4 bg-primary/5 rounded-lg border border-primary/20\">\n            <p className=\"font-medium text-sm\">\n              Current Contact (will be deleted)\n            </p>\n            <div className=\"font-medium text-sm mt-4\">{contactOptionText}</div>\n\n            <div className=\"flex justify-center my-4\">\n              <ArrowDown className=\"h-5 w-5 text-muted-foreground\" />\n            </div>\n\n            <p className=\"font-medium text-sm mb-2\">\n              Target Contact (will be kept)\n            </p>\n            <Form>\n              <ReferenceInput\n                source=\"winner_id\"\n                reference=\"contacts\"\n                filter={{ \"id@neq\": loserContact.id }}\n              >\n                <AutocompleteInput\n                  label=\"\"\n                  optionText={contactOptionText}\n                  validate={required()}\n                  onChange={setWinnerId}\n                  defaultValue={suggestedWinnerId}\n                  helperText={false}\n                />\n              </ReferenceInput>\n            </Form>\n          </div>\n\n          {winnerId && (\n            <>\n              <div className=\"space-y-2\">\n                <p className=\"font-medium text-sm\">What will be merged:</p>\n                <ul className=\"text-sm text-muted-foreground space-y-1 ml-4\">\n                  {notesCount != null && notesCount > 0 && (\n                    <li>\n                       {notesCount} note\n                      {notesCount !== 1 ? \"s\" : \"\"} will be reassigned\n                    </li>\n                  )}\n                  {tasksCount != null && tasksCount > 0 && (\n                    <li>\n                       {tasksCount} task\n                      {tasksCount !== 1 ? \"s\" : \"\"} will be reassigned\n                    </li>\n                  )}\n                  {dealsCount != null && dealsCount > 0 && (\n                    <li>\n                       {dealsCount} deal\n                      {dealsCount !== 1 ? \"s\" : \"\"} will be updated\n                    </li>\n                  )}\n                  {loserContact.email_jsonb?.length > 0 && (\n                    <li>\n                       {loserContact.email_jsonb.length} email address\n                      {loserContact.email_jsonb.length !== 1 ? \"es\" : \"\"} will\n                      be added\n                    </li>\n                  )}\n                  {loserContact.phone_jsonb?.length > 0 && (\n                    <li>\n                       {loserContact.phone_jsonb.length} phone number\n                      {loserContact.phone_jsonb.length !== 1 ? \"s\" : \"\"} will be\n                      added\n                    </li>\n                  )}\n                  {!notesCount &&\n                    !tasksCount &&\n                    !dealsCount &&\n                    !loserContact.email_jsonb?.length &&\n                    !loserContact.phone_jsonb?.length && (\n                      <li className=\"text-muted-foreground/60\">\n                        No additional data to merge\n                      </li>\n                    )}\n                </ul>\n              </div>\n              <Alert variant=\"destructive\">\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertTitle>Warning: Destructive Operation</AlertTitle>\n                <AlertDescription>\n                  All data will be transferred to the second contact. This\n                  action cannot be undone.\n                </AlertDescription>\n              </Alert>\n            </>\n          )}\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"ghost\" onClick={onClose} disabled={isMerging}>\n            <CircleX />\n            Cancel\n          </Button>\n          <Button onClick={handleMerge} disabled={!winnerId || isMerging}>\n            <Merge />\n            {isMerging ? \"Merging...\" : \"Merge Contacts\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactListFilter.tsx",
      "content": "import { subMonths } from \"date-fns\";\nimport isEqual from \"lodash/isEqual\";\nimport {\n  CheckSquare,\n  Clock,\n  Stethoscope,\n  Tag,\n  TrendingUp,\n  Users,\n} from \"lucide-react\";\nimport {\n  FilterLiveForm,\n  useGetIdentity,\n  useGetList,\n  useListContext,\n} from \"ra-core\";\n\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { FilterOptionButton } from \"../filters/FilterOptionButton\";\nimport {\n  buildInFilter,\n  buildOverlapFilter,\n  parseInFilter,\n  parseOverlapFilter,\n  RangeFilter,\n  toggleValueInList,\n} from \"../filters/filterUtils\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport {\n  crmEndOfYesterday,\n  crmStartOfMonth,\n  crmStartOfWeek,\n} from \"../misc/timezone\";\n\nexport const ContactListFilter = () => {\n  const { filterValues = {}, setFilters } = useListContext();\n  const { leadStages } = useConfigurationContext();\n  const { identity } = useGetIdentity();\n  const { data } = useGetList(\"tags\", {\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: salesData } = useGetList(\"sales\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"first_name\", order: \"ASC\" },\n  });\n\n  const startOfWeek = crmStartOfWeek();\n  const startOfMonth = crmStartOfMonth();\n  const endOfYesterday = crmEndOfYesterday();\n  const lastSeenRanges = Array.isArray(filterValues.last_seen_ranges)\n    ? (filterValues.last_seen_ranges as RangeFilter[])\n    : [];\n  const selectedLeadStages = parseInFilter(filterValues[\"lead_stage@in\"]);\n  const selectedServices = parseOverlapFilter(\n    filterValues[\"services_interested@ov\"],\n  );\n  const selectedTags = parseOverlapFilter(filterValues[\"tags@ov\"]);\n  const selectedManagers = parseInFilter(filterValues[\"sales_id@in\"]);\n  const hasPendingTasks =\n    typeof filterValues[\"nb_tasks@gt\"] !== \"undefined\" &&\n    filterValues[\"nb_tasks@gt\"] !== null;\n\n  const updateFilters = (changes: Record<string, unknown>) => {\n    const next = { ...filterValues, ...changes };\n    Object.entries(changes).forEach(([key, value]) => {\n      if (\n        value === undefined ||\n        value === null ||\n        (Array.isArray(value) && value.length === 0)\n      ) {\n        delete next[key];\n      }\n    });\n    setFilters(next);\n  };\n\n  const toggleLastSeenRange = (range: RangeFilter) => {\n    const isSelected = lastSeenRanges.some((item) => isEqual(item, range));\n    const nextRanges = isSelected\n      ? lastSeenRanges.filter((item) => !isEqual(item, range))\n      : [...lastSeenRanges, range];\n    updateFilters({\n      last_seen_ranges: nextRanges.length ? nextRanges : undefined,\n    });\n  };\n\n  const toggleLeadStage = (value: string) => {\n    const next = toggleValueInList(selectedLeadStages, value);\n    updateFilters({ \"lead_stage@in\": buildInFilter(next) });\n  };\n\n  const toggleService = (id: number) => {\n    const next = toggleValueInList(selectedServices, id);\n    updateFilters({ \"services_interested@ov\": buildOverlapFilter(next) });\n  };\n\n  const toggleTag = (id: number) => {\n    const next = toggleValueInList(selectedTags, id);\n    updateFilters({ \"tags@ov\": buildOverlapFilter(next) });\n  };\n\n  const toggleManager = (id: string | number | undefined) => {\n    if (typeof id === \"undefined\") return;\n    const next = toggleValueInList(selectedManagers, id);\n    updateFilters({ \"sales_id@in\": buildInFilter(next) });\n  };\n\n  const toggleTasks = () => {\n    if (hasPendingTasks) {\n      updateFilters({ \"nb_tasks@gt\": undefined });\n    } else {\n      updateFilters({ \"nb_tasks@gt\": 0 });\n    }\n  };\n\n  const clearLastSeen = () => updateFilters({ last_seen_ranges: undefined });\n  const clearStatuses = () => updateFilters({ \"lead_stage@in\": undefined });\n  const clearServices = () =>\n    updateFilters({ \"services_interested@ov\": undefined });\n  const clearTags = () => updateFilters({ \"tags@ov\": undefined });\n  const clearManagers = () => updateFilters({ \"sales_id@in\": undefined });\n\n  return (\n    <div className=\"w-52 min-w-52 order-first pt-0.75 flex flex-col gap-4\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" placeholder=\"Search name, company...\" />\n      </FilterLiveForm>\n\n      <FilterCategory\n        label=\"Last activity\"\n        icon={<Clock />}\n        count={lastSeenRanges.length}\n        onClear={clearLastSeen}\n      >\n        <FilterOptionButton\n          label=\"Today\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              gte: endOfYesterday?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              gte: endOfYesterday?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"This week\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              gte: startOfWeek?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              gte: startOfWeek?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before this week\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: startOfWeek?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: startOfWeek?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before this month\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: startOfMonth?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: startOfMonth?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before last month\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: subMonths(startOfMonth ?? new Date(), 1).toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: subMonths(startOfMonth ?? new Date(), 1).toISOString(),\n            })\n          }\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Status\"\n        icon={<TrendingUp />}\n        count={selectedLeadStages.length}\n        onClear={clearStatuses}\n      >\n        {leadStages.map((stage) => (\n          <FilterOptionButton\n            key={stage.value}\n            label={stage.label}\n            selected={selectedLeadStages.includes(stage.value)}\n            onToggle={() => toggleLeadStage(stage.value)}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Services interested in\"\n        icon={<Stethoscope />}\n        count={selectedServices.length}\n        onClear={clearServices}\n      >\n        {servicesData && servicesData.length > 0 ? (\n          servicesData.map((service) => (\n            <FilterOptionButton\n              key={service.id}\n              label={service.name}\n              selected={selectedServices.includes(String(service.id))}\n              onToggle={() => toggleService(service.id)}\n            />\n          ))\n        ) : (\n          <div className=\"text-xs text-muted-foreground\">\n            No services available\n          </div>\n        )}\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Tags\"\n        icon={<Tag />}\n        count={selectedTags.length}\n        onClear={clearTags}\n      >\n        {data &&\n          data.map((record) => (\n            <FilterOptionButton\n              key={record.id}\n              label={\n                <Badge\n                  variant=\"secondary\"\n                  className=\"text-black text-xs font-normal cursor-pointer\"\n                  style={{\n                    backgroundColor: record?.color,\n                  }}\n                >\n                  {record?.name}\n                </Badge>\n              }\n              selected={selectedTags.includes(String(record.id))}\n              onToggle={() => toggleTag(record.id)}\n            />\n          ))}\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<CheckSquare />}\n        label=\"Tasks\"\n        count={hasPendingTasks ? 1 : 0}\n        onClear={() => updateFilters({ \"nb_tasks@gt\": undefined })}\n      >\n        <FilterOptionButton\n          label={\"With pending tasks\"}\n          selected={hasPendingTasks}\n          onToggle={toggleTasks}\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<Users />}\n        label=\"Account Manager\"\n        count={selectedManagers.length}\n        onClear={clearManagers}\n      >\n        <FilterOptionButton\n          label={\"Me\"}\n          selected={selectedManagers.includes(String(identity?.id))}\n          onToggle={() => toggleManager(identity?.id)}\n        />\n        {salesData &&\n          salesData\n            .filter((manager) => manager.id !== identity?.id)\n            .map((manager) => (\n              <FilterOptionButton\n                key={manager.id}\n                label={`${manager.first_name} ${manager.last_name}`}\n                selected={selectedManagers.includes(String(manager.id))}\n                onToggle={() => toggleManager(manager.id)}\n              />\n            ))}\n      </FilterCategory>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactListContent.tsx",
      "content": "import { RecordContextProvider, useListContext, useGetList } from \"ra-core\";\nimport { type MouseEvent, useCallback, useMemo, useRef } from \"react\";\nimport { Link } from \"react-router\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport { Status } from \"../misc/Status\";\nimport type { Contact, Deal } from \"../types\";\nimport { TagsList } from \"./TagsList\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { formatRelativeOrDate } from \"../misc/timezone\";\n\n// Helper function to get badge color for lead stage\nconst getStageBadgeColor = (stage: string): string => {\n  switch (stage) {\n    case \"new\":\n      return \"bg-blue-500 hover:bg-blue-600\";\n    case \"contacted\":\n      return \"bg-yellow-500 hover:bg-yellow-600\";\n    case \"quoted\":\n      return \"bg-purple-500 hover:bg-purple-600\";\n    case \"qualified\":\n      return \"bg-green-500 hover:bg-green-600\";\n    case \"not-qualified\":\n      return \"bg-red-500 hover:bg-red-600\";\n    case \"converted\":\n      return \"bg-emerald-600 hover:bg-emerald-700\";\n    default:\n      return \"bg-gray-500 hover:bg-gray-600\";\n  }\n};\n\nexport const ContactListContent = () => {\n  const {\n    data: contacts,\n    error,\n    isPending,\n    onSelect,\n    onToggleItem,\n    selectedIds,\n  } = useListContext<Contact>();\n  const isSmall = useIsMobile();\n  const { leadStages } = useConfigurationContext();\n  const lastClickedIndexRef = useRef<number | null>(null);\n\n  // Fetch all deals to get contact stages and identify clients\n  const { data: allDeals } = useGetList<Deal>(\"lead-journey\", {\n    pagination: { page: 1, perPage: 10000 },\n    sort: { field: \"id\", order: \"ASC\" },\n    filter: { \"archived_at@is\": null, \"lead_id@not.is\": null },\n  }, { enabled: !isPending });\n\n  // Create a map of contact ID to deal stage\n  const contactStageMap = useMemo(() => {\n    if (!allDeals) return new Map<number | string, string>();\n    const map = new Map<number | string, string>();\n    allDeals.forEach((deal) => {\n      if (deal.lead_id) {\n        map.set(deal.lead_id, deal.stage);\n      }\n    });\n    return map;\n  }, [allDeals]);\n\n  // Create a Set of client contact IDs for quick lookup\n  const clientContactIds = useMemo(() => {\n    if (!allDeals) return new Set<number | string>();\n    return new Set(\n      allDeals\n        .filter((deal) => deal.stage === \"converted\")\n        .map((deal) => deal.lead_id)\n        .filter((id): id is number | string => id !== undefined && id !== null)\n    );\n  }, [allDeals]);\n\n  // StopPropagation does not work for some reason on Checkbox, this handler is a workaround\n  const handleLinkClick = useCallback(function handleLinkClick(\n    e: MouseEvent<HTMLAnchorElement>,\n  ) {\n    // Prevent navigation if clicking on checkbox or if shift key is pressed\n    if (\n      e.target instanceof HTMLButtonElement ||\n      (e.target as HTMLElement).closest('[data-slot=\"checkbox\"]') ||\n      e.shiftKey\n    ) {\n      e.preventDefault();\n    }\n  }, []);\n\n  const handleCheckboxClick = useCallback(\n    (contactId: number | string, index: number, event: MouseEvent) => {\n      event.stopPropagation();\n      event.preventDefault();\n      \n      if (event.shiftKey && lastClickedIndexRef.current !== null) {\n        // Shift-click: select range from last clicked to current\n        const start = Math.min(lastClickedIndexRef.current, index);\n        const end = Math.max(lastClickedIndexRef.current, index);\n        const rangeIds = contacts\n          .slice(start, end + 1)\n          .map((contact) => contact.id);\n        \n        // Click would toggle the current item, so apply the *toggled* state to the whole range.\n        // Use onSelect (set selected IDs in one shot) to avoid flaky toggling/batching issues.\n        const currentIsSelected = selectedIds.includes(contactId);\n        const targetIsSelected = !currentIsSelected;\n\n        if (onSelect) {\n          const rangeSet = new Set(rangeIds);\n          const selectedSet = new Set(selectedIds);\n          if (targetIsSelected) {\n            rangeIds.forEach((id) => selectedSet.add(id));\n          } else {\n            selectedIds.forEach((id) => {\n              if (rangeSet.has(id)) selectedSet.delete(id);\n            });\n          }\n          onSelect(Array.from(selectedSet));\n        } else {\n          // Fallback (should rarely happen): toggle items to match target state\n          rangeIds.forEach((id) => {\n            const isSelected = selectedIds.includes(id);\n            if (isSelected !== targetIsSelected) {\n              onToggleItem(id);\n            }\n          });\n        }\n      } else {\n        // Normal click: toggle single item\n        onToggleItem(contactId);\n      }\n      lastClickedIndexRef.current = index;\n    },\n    [contacts, onSelect, onToggleItem, selectedIds],\n  );\n\n  if (isPending) {\n    return <Skeleton className=\"w-full h-9\" />;\n  }\n\n  if (error) {\n    return null;\n  }\n  const now = Date.now();\n\n  return (\n    <div className=\"divide-y\">\n      {contacts.map((contact, index) => (\n        <RecordContextProvider key={contact.id} value={contact}>\n          <Link\n            to={`/contacts/${contact.id}/show`}\n            className=\"flex flex-row gap-4 items-center px-4 py-2 hover:bg-muted transition-colors first:rounded-t-xl last:rounded-b-xl\"\n            onClick={handleLinkClick}\n          >\n            <div \n              onClick={(e) => {\n                e.stopPropagation();\n                e.preventDefault();\n              }}\n            >\n              <Checkbox\n                className=\"cursor-pointer\"\n                checked={selectedIds.includes(contact.id)}\n                // Use mousedown to reliably capture shiftKey with Radix checkbox\n                onMouseDown={(e) => handleCheckboxClick(contact.id, index, e)}\n                // Prevent Radix default click toggling; selection is controlled by react-admin\n                onClick={(e) => {\n                  e.preventDefault();\n                  e.stopPropagation();\n                }}\n              />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"font-medium flex items-center gap-2\">\n                {`${contact.first_name ?? \"\"} ${contact.last_name ?? \"\"}`.trim() || \"New Lead\"}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">\n                {contact.title}\n                {contact.title && contact.company_id != null && \" at \"}\n                {contact.company_id != null && (\n                  <ReferenceField\n                    source=\"company_id\"\n                    reference=\"companies\"\n                    link={false}\n                  >\n                    <TextField source=\"name\" />\n                  </ReferenceField>\n                )}\n                {contact.nb_tasks\n                  ? ` - ${contact.nb_tasks} task${\n                      contact.nb_tasks > 1 ? \"s\" : \"\"\n                    }`\n                  : \"\"}\n                &nbsp;&nbsp;\n                <TagsList />\n              </div>\n            </div>\n            {contact.last_seen && (\n              <div className=\"text-right ml-4 flex items-center gap-2\">\n                {/* Lead Stage Badge */}\n                {(() => {\n                  const stage = contactStageMap.get(contact.id);\n                  if (stage) {\n                    const stageConfig = leadStages.find((s) => s.value === stage);\n                    const label = stage === \"converted\" ? \"Client\" : (stageConfig?.label || stage);\n                    return (\n                      <Badge\n                        variant=\"default\"\n                        className={`text-xs text-white ${getStageBadgeColor(stage)}`}\n                      >\n                        {label}\n                      </Badge>\n                    );\n                  }\n                  return null;\n                })()}\n                <div\n                  className=\"text-sm text-muted-foreground\"\n                  title={contact.last_seen}\n                >\n                  {!isSmall && \"last activity \"}\n                  {formatRelativeOrDate(contact.last_seen, new Date(now))}{\" \"}\n                  <Status status={contact.status} />\n                </div>\n              </div>\n            )}\n          </Link>\n        </RecordContextProvider>\n      ))}\n\n      {contacts.length === 0 && (\n        <div className=\"p-4\">\n          <div className=\"text-muted-foreground\">No contacts found</div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactList.tsx",
      "content": "import jsonExport from \"jsonexport/dist\";\nimport {\n  downloadCSV,\n  useDataProvider,\n  useGetIdentity,\n  useListContext,\n  useNotify,\n  useRefresh,\n  type Exporter,\n} from \"ra-core\";\nimport { BulkActionsToolbar } from \"@/components/admin/bulk-actions-toolbar\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SortButton } from \"@/components/admin/sort-button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Layers } from \"lucide-react\";\nimport * as React from \"react\";\n\nimport type { Company, Contact, Sale, Tag } from \"../types\";\nimport { ContactEmpty } from \"./ContactEmpty\";\nimport { ContactImportButton } from \"./ContactImportButton\";\nimport { ContactListContent } from \"./ContactListContent\";\nimport { ContactListFilter } from \"./ContactListFilter\";\nimport { ContactArchivedList } from \"./ContactArchivedList\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\n\nexport const ContactList = () => {\n  const { identity } = useGetIdentity();\n  const [showArchived, setShowArchived] = React.useState(false);\n\n  if (!identity) return null;\n\n  return (\n    <List\n      title={false}\n      actions={<ContactListActions onArchivedClick={() => setShowArchived(true)} />}\n      perPage={25}\n      sort={{ field: \"last_seen\", order: \"DESC\" }}\n      exporter={exporter}\n      filter={{ \"archived_at@is\": null }}\n    >\n      <ContactListLayout showArchived={showArchived} setShowArchived={setShowArchived} />\n    </List>\n  );\n};\n\nconst ContactListLayout = ({ showArchived, setShowArchived }: { showArchived: boolean; setShowArchived: (open: boolean) => void }) => {\n  const { data, isPending, filterValues } = useListContext();\n  const { identity } = useGetIdentity();\n\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  if (!identity || isPending) return null;\n\n  if (!data?.length && !hasFilters) return (\n    <>\n      <ContactEmpty />\n      <ContactArchivedList open={showArchived} onOpenChange={setShowArchived} />\n    </>\n  );\n\n  return (\n    <div className=\"flex flex-row gap-8\">\n      <ContactListFilter />\n      <div className=\"w-full flex flex-col gap-4\">\n        <Card className=\"py-0\">\n          <ContactListContent />\n        </Card>\n      </div>\n      <BulkActionsToolbar />\n      <ContactArchivedList open={showArchived} onOpenChange={setShowArchived} />\n    </div>\n  );\n};\n\nconst ContactListActions = ({ onArchivedClick }: { onArchivedClick: () => void }) => {\n  const { filterValues = {}, setFilters } = useListContext<Contact>();\n  \n  // Parse current lead_stage filter\n  const parseLeadStages = (filter: string | undefined): string[] => {\n    if (!filter) return [];\n    return filter\n      .replace(/[()]/g, \"\")\n      .split(\",\")\n      .map((s) => s.trim())\n      .filter(Boolean);\n  };\n\n  const currentStages = parseLeadStages(filterValues[\"lead_stage@in\"] as string | undefined);\n  const hasConverted = currentStages.includes(\"converted\");\n  const allNonConvertedStages = [\"new\", \"contacted\", \"quoted\", \"qualified\", \"not-qualified\"];\n  \n  // Determine if clients should be shown based on current filter\n  const shouldShowClients = React.useMemo(() => {\n    if (currentStages.length === 0) return true; // No filter = show all\n    if (hasConverted) return true; // \"converted\" is included\n    // Check if filter only contains non-converted stages (clients hidden)\n    const onlyNonConverted = currentStages.length > 0 && \n      currentStages.every((s) => allNonConvertedStages.includes(s));\n    return !onlyNonConverted; // If only non-converted, clients are hidden\n  }, [currentStages, hasConverted, allNonConvertedStages]);\n\n  const handleToggleClients = (checked: boolean) => {\n    const updated = { ...filterValues };\n\n    if (checked) {\n      // Show clients: include \"converted\" or remove exclusion\n      if (currentStages.length === 0) {\n        // No filter, show all (including clients) - remove filter\n        delete updated[\"lead_stage@in\"];\n      } else if (hasConverted) {\n        // Already includes \"converted\", do nothing\n        return;\n      } else {\n        // Add \"converted\" to existing stages\n        const newStages = [...currentStages, \"converted\"];\n        updated[\"lead_stage@in\"] = `(${newStages.join(\",\")})`;\n      }\n    } else {\n      // Hide clients: exclude \"converted\" stage\n      const stagesWithoutConverted = currentStages.filter((s) => s !== \"converted\");\n      \n      if (stagesWithoutConverted.length > 0) {\n        // Keep other selected stages, exclude \"converted\"\n        updated[\"lead_stage@in\"] = `(${stagesWithoutConverted.join(\",\")})`;\n      } else {\n        // No other stages selected, show all non-converted stages\n        updated[\"lead_stage@in\"] = `(${allNonConvertedStages.join(\",\")})`;\n      }\n    }\n\n    setFilters(updated);\n  };\n\n  return (\n    <TopToolbar>\n      <SortButton fields={[\"first_name\", \"last_name\", \"last_seen\"]} />\n      <ContactImportButton />\n      <ExportButton exporter={exporter} />\n      <BulkLeadStageButton />\n      <div className=\"flex items-center gap-2 px-2\">\n        <Switch\n          id=\"show-clients\"\n          checked={shouldShowClients}\n          onCheckedChange={handleToggleClients}\n        />\n        <Label htmlFor=\"show-clients\" className=\"text-sm font-normal cursor-pointer\">\n          Show Clients\n        </Label>\n      </div>\n      <Button variant=\"outline\" onClick={onArchivedClick}>\n        Archived\n      </Button>\n      <CreateButton />\n    </TopToolbar>\n  );\n};\n\nconst BulkLeadStageButton = () => {\n  const { selectedIds } = useListContext<Contact>();\n  const { leadStages } = useConfigurationContext();\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const [open, setOpen] = React.useState(false);\n  const [stage, setStage] = React.useState<string>(\"new\");\n  const [isSaving, setIsSaving] = React.useState(false);\n\n  const selectedCount = selectedIds?.length ?? 0;\n\n  const stageOptions = React.useMemo(() => {\n    // Ensure we only show the stages requested (and keep order stable)\n    const allowed = new Set([\n      \"new\",\n      \"contacted\",\n      \"quoted\",\n      \"qualified\",\n      \"not-qualified\",\n      \"converted\",\n    ]);\n    const fromConfig =\n      leadStages?.filter((s) => allowed.has(s.value)) ?? [];\n    if (fromConfig.length > 0) return fromConfig;\n    // Fallback (in case config is missing)\n    return [\n      { value: \"new\", label: \"New\" },\n      { value: \"contacted\", label: \"Contacted\" },\n      { value: \"quoted\", label: \"Quoted\" },\n      { value: \"qualified\", label: \"Qualified\" },\n      { value: \"not-qualified\", label: \"Not Qualified\" },\n      { value: \"converted\", label: \"Converted\" },\n    ];\n  }, [leadStages]);\n\n  const selectedStageLabel =\n    stageOptions.find((s) => s.value === stage)?.label ?? stage;\n\n  const handleOpen = (e: React.MouseEvent<HTMLButtonElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (!selectedCount) {\n      notify(\"Select at least one lead first\", { type: \"info\" });\n      return;\n    }\n    setOpen(true);\n  };\n\n  const handleConfirm = async (e: React.MouseEvent<HTMLButtonElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (!selectedCount) return;\n\n    setIsSaving(true);\n    try {\n      // Fetch deals for selected leads (contacts)\n      const { data: deals } = await dataProvider.getList(\"lead-journey\", {\n        pagination: { page: 1, perPage: 10000 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: {\n          \"archived_at@is\": null,\n          \"lead_id@in\": `(${selectedIds.join(\",\")})`,\n        },\n      });\n\n      const dealsToUpdate = Array.isArray(deals) ? deals : [];\n\n      if (dealsToUpdate.length === 0) {\n        notify(\"No lead journey records found for selected leads\", {\n          type: \"info\",\n        });\n        setOpen(false);\n        return;\n      }\n\n      await Promise.all(\n        dealsToUpdate.map((deal: any) =>\n          dataProvider.update(\"lead-journey\", {\n            id: deal.id,\n            data: { stage },\n            previousData: deal,\n          }),\n        ),\n      );\n\n      notify(\n        `${selectedCount} lead${selectedCount === 1 ? \"\" : \"s\"} updated to ${selectedStageLabel}`,\n        { type: \"success\" },\n      );\n      setOpen(false);\n      refresh();\n    } catch (error: any) {\n      console.error(\"BulkLeadStageButton: update failed\", error);\n      notify(\"Failed to update lead stage\", { type: \"error\" });\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  return (\n    <>\n      <Button\n        type=\"button\"\n        variant=\"outline\"\n        className=\"flex items-center gap-2 h-9\"\n        onClick={handleOpen}\n        disabled={isSaving}\n        title={\n          selectedCount\n            ? `Change stage for ${selectedCount} selected lead${selectedCount === 1 ? \"\" : \"s\"}`\n            : \"Select leads to enable\"\n        }\n      >\n        <Layers className=\"h-4 w-4\" />\n        Bulk Stage\n      </Button>\n\n      <Dialog open={open} onOpenChange={(v) => !isSaving && setOpen(v)}>\n        <DialogContent\n          onPointerDownOutside={(e) => {\n            if (isSaving) e.preventDefault();\n          }}\n        >\n          <DialogHeader>\n            <DialogTitle>Bulk change lead stage</DialogTitle>\n            <DialogDescription>\n              Update the stage for {selectedCount} selected lead\n              {selectedCount === 1 ? \"\" : \"s\"}.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"flex flex-col gap-2\">\n            <div className=\"text-sm font-medium\">New stage</div>\n            <Select value={stage} onValueChange={setStage}>\n              <SelectTrigger className=\"w-full\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {stageOptions.map((opt) => (\n                  <SelectItem key={opt.value} value={opt.value}>\n                    {opt.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <DialogFooter>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setOpen(false)}\n              disabled={isSaving}\n            >\n              Cancel\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"default\"\n              onClick={handleConfirm}\n              disabled={isSaving || !selectedCount}\n            >\n              {isSaving ? \"Updating...\" : \"Update stage\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n};\n\nconst exporter: Exporter<Contact> = async (records, fetchRelatedRecords) => {\n  const companies = await fetchRelatedRecords<Company>(\n    records,\n    \"company_id\",\n    \"companies\",\n  );\n  const sales = await fetchRelatedRecords<Sale>(records, \"sales_id\", \"sales\");\n  const tags = await fetchRelatedRecords<Tag>(records, \"tags\", \"tags\");\n\n  const contacts = records.map((contact) => {\n    const exportedContact = {\n      id: contact.id,\n      first_name: contact.first_name || \"\",\n      last_name: contact.last_name || \"\",\n      gender: contact.gender || \"\",\n      email_jsonb: JSON.stringify(contact.email_jsonb || []),\n      phone_jsonb: JSON.stringify(contact.phone_jsonb || []),\n      flat_villa_number: contact.flat_villa_number || \"\",\n      building_street: contact.building_street || \"\",\n      area: contact.area || \"\",\n      google_maps_link: contact.google_maps_link || \"\",\n      phone_has_whatsapp: contact.phone_has_whatsapp ? \"TRUE\" : \"FALSE\",\n      services_interested: Array.isArray(contact.services_interested)\n        ? contact.services_interested.join(\";\")\n        : \"\",\n      description: contact.description || \"\",\n      first_seen: contact.first_seen || \"\",\n      last_seen: contact.last_seen || \"\",\n      tags: contact.tags.map((tagId) => tags[tagId]?.name || \"\").filter(Boolean).join(\", \") || \"\",\n      sales_id: contact.sales_id || \"\",\n      nb_tasks: contact.nb_tasks || 0,\n      sales: sales[contact.sales_id]\n        ? `${sales[contact.sales_id].first_name} ${sales[contact.sales_id].last_name}`\n        : \"\",\n    };\n    return exportedContact;\n  });\n  return jsonExport(contacts, {}, (_err: any, csv: string) => {\n    downloadCSV(csv, \"contacts\");\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactInputs.tsx",
      "content": "import { email, required } from \"ra-core\";\nimport type { FocusEvent, ClipboardEventHandler } from \"react\";\nimport { useFormContext } from \"react-hook-form\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { RadioButtonGroupInput } from \"@/components/admin/radio-button-group-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { ArrayInput } from \"@/components/admin/array-input\";\nimport { SimpleFormIterator } from \"@/components/admin/simple-form-iterator\";\n\nimport { isLinkedinUrl } from \"../misc/isLinkedInUrl\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Sale } from \"../types\";\nimport { AutocompleteCompanyInput } from \"../companies/AutocompleteCompanyInput.tsx\";\n\nexport const ContactInputs = () => {\n  const isMobile = useIsMobile();\n\n  return (\n    <div className=\"flex flex-col gap-2 p-1\">\n      <div className={`flex gap-6 ${isMobile ? \"flex-col\" : \"flex-row\"}`}>\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <ContactIdentityInputs />\n          <ContactPositionInputs />\n        </div>\n        <Separator\n          orientation={isMobile ? \"horizontal\" : \"vertical\"}\n          className=\"flex-shrink-0\"\n        />\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <ContactPersonalInformationInputs />\n          <ContactMiscInputs />\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst ContactIdentityInputs = () => {\n  const { contactGender } = useConfigurationContext();\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Identity</h6>\n      <RadioButtonGroupInput\n        label={false}\n        row\n        source=\"gender\"\n        choices={contactGender}\n        helperText={false}\n        optionText=\"label\"\n        optionValue=\"value\"\n        defaultValue={contactGender[0].value}\n      />\n      <TextInput source=\"first_name\" validate={required()} helperText={false} />\n      <TextInput source=\"last_name\" validate={required()} helperText={false} />\n    </div>\n  );\n};\n\nconst ContactPositionInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Position</h6>\n      <TextInput source=\"title\" helperText={false} />\n      <ReferenceInput source=\"company_id\" reference=\"companies\" perPage={10}>\n        <AutocompleteCompanyInput />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst ContactPersonalInformationInputs = () => {\n  const { getValues, setValue } = useFormContext();\n\n  // set first and last name based on email\n  const handleEmailChange = (email: string) => {\n    const { first_name, last_name } = getValues();\n    if (first_name || last_name || !email) return;\n    const [first, last] = email.split(\"@\")[0].split(\".\");\n    setValue(\"first_name\", first.charAt(0).toUpperCase() + first.slice(1));\n    setValue(\n      \"last_name\",\n      last ? last.charAt(0).toUpperCase() + last.slice(1) : \"\",\n    );\n  };\n\n  const handleEmailPaste: ClipboardEventHandler<\n    HTMLTextAreaElement | HTMLInputElement\n  > = (e) => {\n    const email = e.clipboardData?.getData(\"text/plain\");\n    handleEmailChange(email);\n  };\n\n  const handleEmailBlur = (\n    e: FocusEvent<HTMLTextAreaElement | HTMLInputElement>,\n  ) => {\n    const email = e.target.value;\n    handleEmailChange(email);\n  };\n\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Personal info</h6>\n      <ArrayInput\n        source=\"email_jsonb\"\n        label=\"Email addresses\"\n        helperText={false}\n      >\n        <SimpleFormIterator\n          inline\n          disableReordering\n          disableClear\n          className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n        >\n          <TextInput\n            source=\"email\"\n            className=\"w-full\"\n            helperText={false}\n            label={false}\n            placeholder=\"Email\"\n            validate={email()}\n            onPaste={handleEmailPaste}\n            onBlur={handleEmailBlur}\n          />\n          <SelectInput\n            source=\"type\"\n            helperText={false}\n            label={false}\n            optionText=\"id\"\n            choices={personalInfoTypes}\n            defaultValue=\"Work\"\n            className=\"w-24 min-w-24\"\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n      <ArrayInput source=\"phone_jsonb\" label=\"Phone numbers\" helperText={false}>\n        <SimpleFormIterator\n          inline\n          disableReordering\n          disableClear\n          className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n        >\n          <TextInput\n            source=\"number\"\n            className=\"w-full\"\n            helperText={false}\n            label={false}\n            placeholder=\"Phone number\"\n          />\n          <SelectInput\n            source=\"type\"\n            helperText={false}\n            label={false}\n            optionText=\"id\"\n            choices={personalInfoTypes}\n            defaultValue=\"Work\"\n            className=\"w-24 min-w-24\"\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n      <TextInput\n        source=\"linkedin_url\"\n        label=\"Linkedin URL\"\n        helperText={false}\n        validate={isLinkedinUrl}\n      />\n    </div>\n  );\n};\n\nconst personalInfoTypes = [{ id: \"Work\" }, { id: \"Home\" }, { id: \"Other\" }];\n\nconst ContactMiscInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Misc</h6>\n      <TextInput\n        source=\"background\"\n        label=\"Background info (bio, how you met, etc)\"\n        multiline\n        helperText={false}\n      />\n      <BooleanInput source=\"has_newsletter\" helperText={false} />\n      <ReferenceInput\n        reference=\"sales\"\n        source=\"sales_id\"\n        sort={{ field: \"last_name\", order: \"ASC\" }}\n        filter={{\n          \"disabled@neq\": true,\n        }}\n      >\n        <SelectInput\n          helperText={false}\n          label=\"Account manager\"\n          optionText={saleOptionRenderer}\n          validate={required()}\n        />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst saleOptionRenderer = (choice: Sale) =>\n  `${choice.first_name} ${choice.last_name}`;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactImportButton.tsx",
      "content": "import { useEffect, useState } from \"react\";\nimport type { MouseEvent } from \"react\";\nimport { Upload, Loader2, AlertCircle } from \"lucide-react\";\nimport { Form, useRefresh } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { FileInput } from \"@/components/admin/file-input\";\nimport { FileField } from \"@/components/admin/file-field\";\n\nimport { usePapaParse } from \"../misc/usePapaParse\";\nimport type { ContactImportSchema } from \"./useContactImport\";\nimport { useContactImport } from \"./useContactImport\";\nimport { formatImportError } from \"./formatImportError\";\nimport * as sampleCsv from \"./contacts_export.csv?raw\";\n\nexport const ContactImportButton = () => {\n  const [modalOpen, setModalOpen] = useState(false);\n\n  const handleOpenModal = () => {\n    setModalOpen(true);\n  };\n\n  const handleCloseModal = () => {\n    setModalOpen(false);\n  };\n\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        onClick={handleOpenModal}\n        className=\"flex items-center gap-2 cursor-pointer\"\n      >\n        <Upload /> Import\n      </Button>\n      <ContactImportDialog open={modalOpen} onClose={handleCloseModal} />\n    </>\n  );\n};\n\nconst SAMPLE_URL = `data:text/csv;name=crm_contacts_sample.csv;charset=utf-8,${encodeURIComponent(\n  sampleCsv.default,\n)}`;\n\ntype ContactImportModalProps = {\n  open: boolean;\n  onClose(): void;\n};\n\nexport function ContactImportDialog({\n  open,\n  onClose,\n}: ContactImportModalProps) {\n  const refresh = useRefresh();\n  const processBatch = useContactImport();\n  const { importer, parseCsv, reset } = usePapaParse<ContactImportSchema>({\n    batchSize: 10,\n    processBatch,\n  });\n\n  const [file, setFile] = useState<File | null>(null);\n\n  useEffect(() => {\n    if (importer.state === \"complete\") {\n      // Refresh to show imported contacts in lead journey\n      refresh();\n      // Additional refresh after a short delay to ensure backend has processed all lead-journey entries\n      setTimeout(() => {\n        refresh();\n      }, 500);\n    }\n  }, [importer.state, refresh]);\n\n  const handleFileChange = (file: File | null) => {\n    setFile(file);\n  };\n\n  const startImport = () => {\n    if (!file) return;\n    parseCsv(file);\n  };\n\n  const handleClose = () => {\n    reset();\n    onClose();\n  };\n\n  const handleReset = (e: MouseEvent<HTMLButtonElement>) => {\n    e.preventDefault();\n    reset();\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"max-w-2xl\">\n        <Form className=\"flex flex-col gap-4\">\n          <DialogHeader>\n            <DialogTitle>Import</DialogTitle>\n            <DialogDescription className=\"sr-only\">\n              Import contacts from a CSV file. Upload a file to begin the import process.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"flex flex-col space-y-2\">\n            {importer.state === \"running\" && (\n              <div className=\"flex flex-col gap-2\">\n                <Alert>\n                  <AlertDescription className=\"flex flex-row gap-4\">\n                    <Loader2 className=\"h-5 w-5 animate-spin\" />\n                    The import is running, please do not close this tab.\n                  </AlertDescription>\n                </Alert>\n\n                <div className=\"text-sm\">\n                  Imported{\" \"}\n                  <strong>\n                    {importer.importCount} / {importer.rowCount}\n                  </strong>{\" \"}\n                  contacts, with <strong>{importer.errorCount}</strong> errors.\n                  {importer.remainingTime !== null && (\n                    <>\n                      {\" \"}\n                      Estimated remaining time:{\" \"}\n                      <strong>\n                        {millisecondsToTime(importer.remainingTime)}\n                      </strong>\n                      .{\" \"}\n                      <button\n                        onClick={handleReset}\n                        className=\"text-red-600 underline hover:text-red-800\"\n                      >\n                        Stop import\n                      </button>\n                    </>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {importer.state === \"error\" && (\n              <Alert variant=\"destructive\">\n                <AlertCircle className=\"h-5 w-5\" />\n                <AlertDescription>\n                  Failed to import this file: {importer.error.message || \"Please make sure you provided a valid CSV file.\"}\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {(importer.state === \"complete\" || importer.state === \"running\") && importer.errorCount > 0 && (\n              <Alert variant=\"destructive\">\n                <AlertCircle className=\"h-5 w-5\" />\n                <AlertDescription className=\"flex flex-col gap-2\">\n                  <div>\n                    {importer.state === \"complete\" ? (\n                      <>Contacts import complete. Imported {importer.importCount} contacts, with <strong>{importer.errorCount} errors</strong>.</>\n                    ) : (\n                      <>Importing... {importer.errorCount} errors so far.</>\n                    )}\n                  </div>\n                  {importer.errors && importer.errors.length > 0 && (\n                    <Accordion type=\"single\" collapsible className=\"w-full\">\n                      <AccordionItem value=\"errors\" className=\"border-none\">\n                        <AccordionTrigger className=\"py-2 text-sm hover:no-underline\">\n                          View error details ({importer.errors.length})\n                        </AccordionTrigger>\n                        <AccordionContent>\n                          <div className=\"max-h-96 overflow-y-auto space-y-4 pr-2\">\n                            {importer.errors.map((error, index) => {\n                              const formatted = formatImportError(error);\n                              return (\n                                <div\n                                  key={index}\n                                  className=\"rounded-md border border-destructive/20 bg-destructive/5 p-4\"\n                                >\n                                  <div className=\"font-semibold text-base mb-1\">\n                                    Row {formatted.row}: {formatted.title}\n                                  </div>\n                                  <div className=\"text-sm text-muted-foreground mb-3\">\n                                    {formatted.message}\n                                  </div>\n                                  <div className=\"mt-3\">\n                                    <div className=\"text-xs font-medium mb-2 text-foreground\">\n                                      How to fix:\n                                    </div>\n                                    <ol className=\"list-decimal list-inside space-y-1.5 text-xs text-muted-foreground\">\n                                      {formatted.steps.map((step, stepIndex) => (\n                                        <li key={stepIndex} className=\"pl-1\">\n                                          {step}\n                                        </li>\n                                      ))}\n                                    </ol>\n                                  </div>\n                                </div>\n                              );\n                            })}\n                          </div>\n                        </AccordionContent>\n                      </AccordionItem>\n                    </Accordion>\n                  )}\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {importer.state === \"complete\" && importer.errorCount === 0 && (\n              <Alert>\n                <AlertDescription>\n                  Contacts import complete. Successfully imported {importer.importCount} contacts.\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {importer.state === \"idle\" && (\n              <>\n                <Alert>\n                  <AlertDescription className=\"flex flex-col gap-4\">\n                    Here is a sample CSV file you can use as a template\n                    <Button asChild variant=\"outline\" size=\"sm\">\n                      <Link\n                        to={SAMPLE_URL}\n                        download={\"crm_contacts_sample.csv\"}\n                      >\n                        Download CSV sample\n                      </Link>\n                    </Button>{\" \"}\n                  </AlertDescription>\n                </Alert>\n\n                <FileInput\n                  source=\"csv\"\n                  label=\"CSV File\"\n                  accept={{ \"text/csv\": [\".csv\"] }}\n                  onChange={handleFileChange}\n                >\n                  <FileField source=\"src\" title=\"title\" target=\"_blank\" />\n                </FileInput>\n              </>\n            )}\n          </div>\n        </Form>\n\n        <div className=\"flex justify-start pt-6\">\n          <FormToolbar>\n            {importer.state === \"idle\" ? (\n              <Button onClick={startImport} disabled={!file}>\n                Import\n              </Button>\n            ) : (\n              <Button\n                variant=\"outline\"\n                onClick={handleClose}\n                disabled={importer.state === \"running\"}\n              >\n                Close\n              </Button>\n            )}\n          </FormToolbar>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction millisecondsToTime(ms: number) {\n  const seconds = Math.floor((ms / 1000) % 60);\n  const minutes = Math.floor((ms / (60 * 1000)) % 60);\n\n  return `${minutes}m ${seconds}s`;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactEmpty.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\nimport { ContactImportButton } from \"./ContactImportButton\";\n\nexport const ContactEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-3\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No contacts found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h6 className=\"text-lg font-bold\">No contacts found</h6>\n        <p className=\"text-sm text-muted-foreground text-center mb-4\">\n          It seems your contact list is empty.\n        </p>\n      </div>\n      <div className=\"flex flex-row gap-2\">\n        <CreateButton label=\"New Contact\" />\n        <ContactImportButton />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactEdit.tsx",
      "content": "import { EditBase, Form, useEditContext } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport type { Contact } from \"../types\";\nimport { ContactAside } from \"./ContactAside\";\nimport { LeadInputs } from \"./LeadInputs\";\n\nexport const ContactEdit = () => (\n  <EditBase\n    redirect=\"show\"\n    transform={(data: Contact) => {\n      // Split full name back into first_name and last_name before saving\n      if (data.first_name) {\n        const parts = data.first_name.trim().split(/\\s+/);\n        data.first_name = parts[0] || \"\";\n        data.last_name = parts.slice(1).join(\" \") || \"\";\n      }\n      return data;\n    }}\n  >\n    <ContactEditContent />\n  </EditBase>\n);\n\nconst ContactEditContent = () => {\n  const { isPending, record } = useEditContext<Contact>();\n  if (isPending || !record) return null;\n  \n  // Combine first_name and last_name for the form's default value\n  const fullName = record.first_name && record.last_name\n    ? `${record.first_name} ${record.last_name}`.trim()\n    : record.first_name || \"\";\n  \n  return (\n    <div className=\"mt-2 flex justify-center\">\n      <div className=\"w-[90%] max-w-6xl flex gap-8\">\n        <div className=\"flex-1\">\n          <Form \n            className=\"flex flex-1 flex-col gap-6\"\n            defaultValues={{\n              ...record,\n              first_name: fullName,\n            }}\n          >\n            <LeadInputs />\n            <div className=\"flex justify-end pt-4 border-t\">\n              <FormToolbar />\n            </div>\n          </Form>\n        </div>\n        <ContactAside link=\"show\" />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactCreate.tsx",
      "content": "import { CreateBase, Form, useDataProvider, useGetIdentity, useNotify, useRedirect, useRefresh } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport type { Contact } from \"../types\";\nimport { createLeadJourneyDealForContact } from \"../deals/createLeadJourneyDeal\";\nimport { LeadInputs } from \"./LeadInputs\";\n\nexport const ContactCreate = () => {\n  const { identity } = useGetIdentity();\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const redirect = useRedirect();\n  const refresh = useRefresh();\n\n  const handleSuccess = async (data: Contact) => {\n    if (!data?.id) {\n      console.error(\"ContactCreate: Missing contact ID\", data);\n      return;\n    }\n    try {\n      await createLeadJourneyDealForContact(dataProvider, data, identity?.id);\n      \n      // Force refresh to ensure the new lead appears in lists\n      refresh();\n      \n      // Small delay to ensure backend has processed\n      setTimeout(() => {\n        refresh();\n      }, 100);\n      \n      redirect(\"show\", \"contacts\", data.id);\n    } catch (error) {\n      notify(\"Lead created but could not add to journey\", { type: \"warning\" });\n      console.error(\"ContactCreate: lead-journey create failed\", error);\n      // Still redirect even if lead-journey creation fails\n      refresh();\n      redirect(\"show\", \"contacts\", data.id);\n    }\n  };\n  return (\n    <CreateBase\n      redirect={false}\n      transform={(data: Contact) => ({\n        ...data,\n        first_seen: new Date().toISOString(),\n        last_seen: new Date().toISOString(),\n        tags: [],\n        services_interested: data.services_interested || [],\n      })}\n      mutationOptions={{\n        onSuccess: async (response) => {\n          // Handle both response.data (react-admin structure) and direct data\n          const contact = ((response as any)?.data ?? response) as Contact | undefined;\n          if (!contact || !contact.id) {\n            console.warn(\"ContactCreate: Invalid response structure\", response);\n            return;\n          }\n          await handleSuccess(contact);\n        },\n      }}\n    >\n      <div className=\"mt-2 flex justify-center\">\n        <div className=\"w-[90%] max-w-6xl\">\n          <Form \n            className=\"flex flex-col gap-6\"\n            defaultValues={{ \n              sales_id: identity?.id,\n              phone_has_whatsapp: false,\n              services_interested: [],\n            }}\n          >\n            <LeadInputs />\n            <div className=\"flex justify-end pt-4 border-t\">\n              <FormToolbar />\n            </div>\n          </Form>\n        </div>\n      </div>\n    </CreateBase>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactAside.tsx",
      "content": "import { Linkedin, Mail, Phone, MapPin, Archive, ArchiveRestore } from \"lucide-react\";\nimport { useRecordContext, WithRecord, useUpdate, useNotify, useRefresh } from \"ra-core\";\nimport type { ReactNode } from \"react\";\nimport { ArrayField } from \"@/components/admin/array-field\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { DeleteButton } from \"@/components/admin\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { EmailField } from \"@/components/admin/email-field\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\n\nimport { TagsListEdit } from \"./TagsListEdit\";\nimport { ServicesListEdit } from \"./ServicesListEdit\";\nimport { AccountManagerEdit } from \"./AccountManagerEdit\";\nimport { AsideSection } from \"../misc/AsideSection\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Contact, Deal } from \"../types\";\nimport { ContactMergeButton } from \"./ContactMergeButton\";\nimport { ExportVCardButton } from \"./ExportVCardButton\";\nimport { findDealLabel } from \"../deals/deal\";\n\nexport const ContactAside = ({ link = \"edit\", deals = [] }: { link?: \"edit\" | \"show\"; deals?: Deal[] }) => {\n  const { contactGender, leadStages } = useConfigurationContext();\n  const record = useRecordContext<Contact>();\n\n  if (!record) return null;\n  \n  // Separate archived and non-archived deals\n  const activeDeals = deals.filter(d => !d.archived_at);\n  const archivedDeals = deals.filter(d => d.archived_at);\n  const sortedDeals = [...activeDeals, ...archivedDeals];\n\n  return (\n    <div className=\"hidden sm:block w-64 min-w-64 text-sm\">\n      <div className=\"mb-4 -ml-1 flex items-center gap-2\">\n        {link === \"edit\" ? (\n          <EditButton label=\"Edit Contact\" />\n        ) : (\n          <ShowButton label=\"Show Contact\" />\n        )}\n        {sortedDeals.length > 0 && (\n          <CondensedDealArchiveButton deal={sortedDeals[0]} />\n        )}\n      </div>\n\n      {sortedDeals.length > 0 && (\n        <AsideSection title=\"Status\" noGap>\n          {sortedDeals.map((deal) => (\n            <CondensedDealListItem key={deal.id} deal={deal} />\n          ))}\n        </AsideSection>\n      )}\n\n      <AsideSection title=\"Personal info\">\n        <ArrayField source=\"email_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Mail className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<EmailField source=\"email\" />}\n            />\n          </SingleFieldList>\n        </ArrayField>\n\n        {record.has_newsletter && (\n          <p className=\"pl-6 text-sm text-muted-foreground\">\n            Subscribed to newsletter\n          </p>\n        )}\n\n        {record.linkedin_url && (\n          <PersonalInfoRow\n            icon={<Linkedin className=\"w-4 h-4 text-muted-foreground\" />}\n            primary={\n              <a\n                className=\"underline hover:no-underline text-sm text-muted-foreground\"\n                href={record.linkedin_url}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                title={record.linkedin_url}\n              >\n                LinkedIn\n              </a>\n            }\n          />\n        )}\n        <ArrayField source=\"phone_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Phone className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<TextField source=\"number\" />}\n              showType\n            />\n          </SingleFieldList>\n        </ArrayField>\n        {contactGender\n          .map((genderOption) => {\n            if (record.gender === genderOption.value) {\n              return (\n                <PersonalInfoRow\n                  key={genderOption.value}\n                  primary={<span>{genderOption.label}</span>}\n                />\n              );\n            }\n            return null;\n          })\n          .filter(Boolean)}\n        \n        {/* Address as subcategory */}\n        <div className=\"mt-4 pt-4 border-t\">\n          <h4 className=\"text-xs font-medium text-muted-foreground mb-2\">Address</h4>\n          {record.flat_villa_number && (\n            <div className=\"text-sm text-muted-foreground\">\n              <TextField source=\"flat_villa_number\" record={record} />\n            </div>\n          )}\n          {record.building_street && (\n            <div className=\"text-sm text-muted-foreground\">\n              <TextField source=\"building_street\" record={record} />\n            </div>\n          )}\n          {record.area && (\n            <div className=\"text-sm text-muted-foreground\">\n              <TextField source=\"area\" record={record} />\n            </div>\n          )}\n          {record.google_maps_link && (\n            <div className=\"flex items-center gap-2\">\n              <MapPin className=\"w-4 h-4 text-muted-foreground\" />\n              <a\n                className=\"text-sm text-muted-foreground underline hover:no-underline\"\n                href={record.google_maps_link}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n              >\n                View on Maps\n              </a>\n            </div>\n          )}\n          {!record.flat_villa_number && !record.building_street && !record.area && !record.google_maps_link && (\n            <div className=\"text-sm text-muted-foreground\">No address information</div>\n          )}\n        </div>\n      </AsideSection>\n\n      <AsideSection title=\"Services interested in\">\n        <ServicesListEdit />\n      </AsideSection>\n\n      <AsideSection title=\"Tags\">\n        <TagsListEdit />\n      </AsideSection>\n\n      <AsideSection title=\"Account Manager\">\n        <AccountManagerEdit />\n      </AsideSection>\n\n      {link !== \"edit\" && (\n        <>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <ExportVCardButton />\n            <ContactMergeButton />\n          </div>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <DeleteButton\n              className=\"h-6 cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\"\n              size=\"sm\"\n            />\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nconst PersonalInfoRow = ({\n  icon,\n  primary,\n  showType,\n}: {\n  icon?: ReactNode;\n  primary: ReactNode;\n  showType?: boolean;\n}) => (\n  <div className=\"flex flex-row items-center gap-2 min-h-6\">\n    {icon && icon}\n    <div className=\"flex flex-wrap gap-x-2 gap-y-0\">\n      {primary}\n      {showType ? (\n        <WithRecord\n          render={(row) =>\n            row.type !== \"Other\" && (\n              <TextField source=\"type\" className=\"text-muted-foreground\" />\n            )\n          }\n        />\n      ) : null}\n    </div>\n  </div>\n);\n\nconst CondensedDealArchiveButton = ({ deal }: { deal: Deal }) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const isArchived = deal.archived_at != null;\n\n  const handleArchive = () => {\n    update(\n      \"lead-journey\",\n      {\n        id: deal.id,\n        data: { archived_at: new Date().toISOString() },\n        previousData: deal,\n      },\n      {\n        onSuccess: () => {\n          notify(\"Deal archived\", { type: \"info\" });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error archiving deal\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  const handleUnarchive = () => {\n    update(\n      \"lead-journey\",\n      {\n        id: deal.id,\n        data: { archived_at: null },\n        previousData: deal,\n      },\n      {\n        onSuccess: () => {\n          notify(\"Deal unarchived\", { type: \"info\" });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error unarchiving deal\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  return isArchived ? (\n    <Button\n      onClick={handleUnarchive}\n      variant=\"outline\"\n      title=\"Unarchive\"\n      className=\"h-9 px-4 py-2\"\n    >\n      <ArchiveRestore className=\"w-4 h-4\" />\n      <span className=\"ml-2\">Archived</span>\n    </Button>\n  ) : (\n    <Button\n      onClick={handleArchive}\n      variant=\"outline\"\n      title=\"Archive\"\n      className=\"h-9 px-4 py-2\"\n    >\n      <Archive className=\"w-4 h-4\" />\n      <span className=\"ml-2\">Archive</span>\n    </Button>\n  );\n};\n\nconst CondensedDealListItem = ({ deal }: { deal: Deal }) => {\n  const { leadStages } = useConfigurationContext();\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const isArchived = deal.archived_at != null;\n\n  const handleStageChange = (newStage: string) => {\n    if (newStage === deal.stage) return;\n    \n    update(\n      \"lead-journey\",\n      {\n        id: deal.id,\n        data: { stage: newStage },\n        previousData: deal,\n      },\n      {\n        onSuccess: () => {\n          notify(\"Deal stage updated\", { type: \"info\" });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error updating deal stage\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  return (\n    <div className=\"flex items-center gap-2 py-1.5\">\n      {isArchived && (\n        <span className=\"text-xs px-1.5 py-0.5 bg-orange-100 text-orange-800 rounded flex-shrink-0\">\n          Archived\n        </span>\n      )}\n      <Select value={deal.stage} onValueChange={handleStageChange} className=\"flex-1\">\n        <SelectTrigger>\n          <SelectValue />\n        </SelectTrigger>\n        <SelectContent>\n          {leadStages.map((stage) => (\n            <SelectItem key={stage.value} value={stage.value}>\n              {stage.label}\n            </SelectItem>\n          ))}\n        </SelectContent>\n      </Select>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactArchivedList.tsx",
      "content": "/* eslint-disable react-refresh/only-export-components */\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { useEffect, useState, useMemo } from \"react\";\nimport { useRedirect } from \"ra-core\";\nimport { Dialog, DialogContent, DialogDescription, DialogTitle } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Search } from \"lucide-react\";\n\nimport type { Contact } from \"../types\";\nimport { formatCrmDate } from \"../misc/timezone\";\n\ninterface ContactArchivedListProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport const ContactArchivedList = ({ open, onOpenChange }: ContactArchivedListProps) => {\n  const { identity } = useGetIdentity();\n  const {\n    data: archivedContacts,\n    total,\n    isPending,\n  } = useGetList<Contact>(\"contacts\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"archived_at\", order: \"DESC\" },\n    filter: { \"archived_at@not.is\": null },\n  });\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  useEffect(() => {\n    if (!isPending && total === 0) {\n      onOpenChange(false);\n    }\n  }, [isPending, total, onOpenChange]);\n\n  // Filter contacts by search query\n  const filteredContacts = useMemo(() => {\n    if (!archivedContacts || !searchQuery.trim()) return archivedContacts || [];\n    \n    const query = searchQuery.toLowerCase();\n    return archivedContacts.filter((contact: Contact) => {\n      const firstName = contact.first_name?.toLowerCase() || \"\";\n      const lastName = contact.last_name?.toLowerCase() || \"\";\n      const fullName = `${firstName} ${lastName}`.trim().toLowerCase();\n      const title = contact.title?.toLowerCase() || \"\";\n      const companyName = contact.company_name?.toLowerCase() || \"\";\n      return fullName.includes(query) || title.includes(query) || companyName.includes(query);\n    });\n  }, [archivedContacts, searchQuery]);\n\n  // Group filtered archived contacts by date\n  const archivedContactsByDate: { [date: string]: Contact[] } = useMemo(() => {\n    if (!filteredContacts || filteredContacts.length === 0) return {};\n    return filteredContacts.reduce(\n      (acc, contact) => {\n        const date = contact.archived_at ? new Date(contact.archived_at).toDateString() : \"Unknown\";\n        if (!acc[date]) {\n          acc[date] = [];\n        }\n        acc[date].push(contact);\n        return acc;\n      },\n      {} as { [date: string]: Contact[] },\n    );\n  }, [filteredContacts]);\n\n  if (!identity || isPending || !total || !archivedContacts) return null;\n\n  return (\n    <div className=\"w-full flex flex-row items-center justify-center\">\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n          <DialogTitle>Archived Leads</DialogTitle>\n          <DialogDescription>\n            View and search through archived leads\n          </DialogDescription>\n          <div className=\"flex flex-col gap-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4\" />\n              <Input\n                type=\"text\"\n                placeholder=\"Search archived leads...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n              />\n            </div>\n            {Object.keys(archivedContactsByDate).length === 0 ? (\n              <div className=\"text-center text-muted-foreground py-8\">\n                No archived leads found\n              </div>\n            ) : (\n              <div className=\"flex flex-col gap-8\">\n                {Object.entries(archivedContactsByDate).map(([date, contacts]) => (\n                  <div key={date} className=\"flex flex-col gap-4\">\n                    <h4 className=\"font-bold\">{getRelativeTimeString(date)}</h4>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8\">\n                      {contacts.map((contact: Contact) => (\n                        <div key={contact.id}>\n                          <ArchivedContactCard contact={contact} />\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n};\n\nexport function getRelativeTimeString(dateString: string): string {\n  const date = new Date(dateString);\n  \n  // Validate date is valid\n  if (isNaN(date.getTime())) {\n    return dateString; // Return original string if invalid\n  }\n  \n  date.setHours(0, 0, 0, 0);\n\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const diff = date.getTime() - today.getTime();\n  const unitDiff = Math.round(diff / (1000 * 60 * 60 * 24));\n\n  // Validate unitDiff is a finite number\n  if (!isFinite(unitDiff)) {\n    return formatCrmDate(date);\n  }\n\n  // Check if the date is more than one week old\n  if (Math.abs(unitDiff) > 7) {\n    return formatCrmDate(date);\n  }\n\n  // Intl.RelativeTimeFormat for dates within the last week\n  const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: \"auto\" });\n  return ucFirst(rtf.format(unitDiff, \"day\"));\n}\n\nfunction ucFirst(str: string): string {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nconst ArchivedContactCard = ({ contact }: { contact: Contact }) => {\n  const redirect = useRedirect();\n  \n  const archivedDate = contact.archived_at ? formatCrmDate(contact.archived_at) : null;\n  \n  const handleClick = () => {\n    redirect(`/contacts/${contact.id}/show`, undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  return (\n    <div\n      className=\"cursor-pointer\"\n      onClick={handleClick}\n    >\n      <Card className=\"py-4 transition-all duration-200 shadow-sm hover:shadow-md\">\n        <CardContent className=\"px-4 flex\">\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-medium mb-1\">\n              {`${contact.first_name || \"\"} ${contact.last_name || \"\"}`.trim() || \"New Lead\"}\n            </p>\n            {contact.title && (\n              <p className=\"text-xs text-muted-foreground\">\n                {contact.title}\n                {contact.company_name && ` at ${contact.company_name}`}\n              </p>\n            )}\n            {archivedDate && (\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Archived {archivedDate}\n              </p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/Avatar.tsx",
      "content": "import {\n  AvatarFallback,\n  AvatarImage,\n  Avatar as ShadcnAvatar,\n} from \"@/components/ui/avatar\";\nimport { useRecordContext } from \"ra-core\";\n\nimport type { Contact } from \"../types\";\n\nexport const Avatar = (props: {\n  record?: Contact;\n  width?: 20 | 25 | 40;\n  height?: 20 | 25 | 40;\n  title?: string;\n}) => {\n  const record = useRecordContext<Contact>(props);\n  // If we come from company page, the record is defined (to pass the company as a prop),\n  // but neither of those fields are and this lead to an error when creating contact.\n  if (!record?.avatar && !record?.first_name && !record?.last_name) {\n    return null;\n  }\n\n  const size = props.width || props.height;\n  const sizeClass =\n    props.width === 20\n      ? `w-[20px] h-[20px]`\n      : props.width === 25\n        ? \"w-[25px] h-[25px]\"\n        : \"w-10 h-10\";\n\n  return (\n    <ShadcnAvatar className={sizeClass} title={props.title}>\n      <AvatarImage src={record.avatar?.src ?? undefined} />\n      <AvatarFallback className={size && size < 40 ? \"text-[10px]\" : \"text-sm\"}>\n        {record.first_name?.charAt(0).toUpperCase()}\n        {record.last_name?.charAt(0).toUpperCase()}\n      </AvatarFallback>\n    </ShadcnAvatar>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/AccountManagerEdit.tsx",
      "content": "import {\n  useGetList,\n  useRecordContext,\n  useUpdate,\n  useGetOne,\n} from \"ra-core\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport type { Contact, Sale } from \"../types\";\nimport { SaleName } from \"../sales/SaleName\";\n\nexport const AccountManagerEdit = () => {\n  const record = useRecordContext<Contact>();\n  const [update] = useUpdate<Contact>();\n\n  const { data: allSales, isPending: isPendingSales } = useGetList<Sale>(\n    \"sales\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"last_name\", order: \"ASC\" },\n      filter: { \"disabled@neq\": true },\n    },\n  );\n\n  const { data: currentSale } = useGetOne<Sale>(\n    \"sales\",\n    { id: record?.sales_id },\n    { enabled: !!record?.sales_id },\n  );\n\n  const handleChange = (newSalesId: string) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    const salesId = newSalesId === \"none\" ? null : Number(newSalesId);\n    update(\"contacts\", {\n      id: record.id,\n      data: { sales_id: salesId },\n      previousData: record,\n    });\n  };\n\n  if (isPendingSales) return null;\n\n  return (\n    <Select\n      value={record?.sales_id?.toString() || \"none\"}\n      onValueChange={handleChange}\n    >\n      <SelectTrigger className=\"w-full h-8 text-sm\">\n        <SelectValue>\n          {currentSale ? (\n            <SaleName sale={currentSale} />\n          ) : (\n            <span className=\"text-muted-foreground\">No account manager</span>\n          )}\n        </SelectValue>\n      </SelectTrigger>\n      <SelectContent>\n        <SelectItem value=\"none\">\n          <span className=\"text-muted-foreground\">No account manager</span>\n        </SelectItem>\n        {allSales?.map((sale) => (\n          <SelectItem key={sale.id} value={sale.id.toString()}>\n            {`${sale.first_name} ${sale.last_name}`}\n          </SelectItem>\n        ))}\n      </SelectContent>\n    </Select>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/sizes.ts",
      "content": "export const sizes = [\n  { id: 1, name: \"1 employee\" },\n  { id: 10, name: \"2-9 employees\" },\n  { id: 50, name: \"10-49 employees\" },\n  { id: 250, name: \"50-249 employees\" },\n  { id: 500, name: \"250 or more employees\" },\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/index.ts",
      "content": "import { CompanyList } from \"./CompanyList\";\nimport { CompanyCreate } from \"./CompanyCreate\";\nimport { CompanyShow } from \"./CompanyShow\";\nimport { CompanyEdit } from \"./CompanyEdit\";\n\nexport default {\n  list: CompanyList,\n  create: CompanyCreate,\n  edit: CompanyEdit,\n  show: CompanyShow,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/GridList.tsx",
      "content": "import { RecordContextProvider, useListContext } from \"ra-core\";\n\nimport type { Company } from \"../types\";\nimport { CompanyCard } from \"./CompanyCard\";\n\nconst times = (nbChildren: number, fn: (key: number) => any) =>\n  Array.from({ length: nbChildren }, (_, key) => fn(key));\n\nconst LoadingGridList = () => (\n  <div className=\"flex flex-wrap w-[1008px] gap-1\">\n    {times(15, (key) => (\n      <div\n        className=\"h-[200px] w-[194px] flex flex-col bg-gray-200\"\n        key={key}\n      />\n    ))}\n  </div>\n);\n\nconst LoadedGridList = () => {\n  const { data, error, isPending } = useListContext<Company>();\n\n  if (isPending || error) return null;\n\n  return (\n    <div\n      className=\"w-full gap-2 grid\"\n      style={{\n        gridTemplateColumns: \"repeat(auto-fill, minmax(180px, 1fr))\",\n      }}\n    >\n      {data.map((record) => (\n        <RecordContextProvider key={record.id} value={record}>\n          <CompanyCard />\n        </RecordContextProvider>\n      ))}\n\n      {data.length === 0 && <div className=\"p-2\">No companies found</div>}\n    </div>\n  );\n};\n\nexport const ImageList = () => {\n  const { isPending } = useListContext();\n  return isPending ? <LoadingGridList /> : <LoadedGridList />;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyShow.tsx",
      "content": "import { formatDistance } from \"date-fns\";\nimport { UserPlus } from \"lucide-react\";\nimport {\n  RecordContextProvider,\n  ShowBase,\n  useListContext,\n  useRecordContext,\n  useShowContext,\n} from \"ra-core\";\nimport {\n  Link as RouterLink,\n  useLocation,\n  useMatch,\n  useNavigate,\n} from \"react-router-dom\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { SortButton } from \"@/components/admin/sort-button\";\n\nimport { ActivityLog } from \"../activity/ActivityLog\";\nimport { TagsList } from \"../contacts/TagsList\";\nimport { findDealLabel } from \"../deals/deal\";\nimport { Status } from \"../misc/Status\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Company, Contact, Deal } from \"../types\";\nimport { CompanyAside } from \"./CompanyAside\";\n\nexport const CompanyShow = () => (\n  <ShowBase>\n    <CompanyShowContent />\n  </ShowBase>\n);\n\nconst CompanyShowContent = () => {\n  const { record, isPending } = useShowContext<Company>();\n  const navigate = useNavigate();\n\n  // Get tab from URL or default to \"activity\"\n  const tabMatch = useMatch(\"/companies/:id/show/:tab\");\n  const currentTab = tabMatch?.params?.tab || \"activity\";\n\n  const handleTabChange = (value: string) => {\n    if (value === currentTab) return;\n    if (value === \"activity\") {\n      navigate(`/companies/${record?.id}/show`);\n      return;\n    }\n    navigate(`/companies/${record?.id}/show/${value}`);\n  };\n\n  if (isPending || !record) return null;\n\n  return (\n    <div className=\"mt-2 flex pb-2 gap-8\">\n      <div className=\"flex-1\">\n        <Card>\n          <CardContent>\n            <div className=\"flex mb-3\">\n              <h5 className=\"text-xl flex-1\">{record.name}</h5>\n            </div>\n            <Tabs defaultValue={currentTab} onValueChange={handleTabChange}>\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"activity\">Activity</TabsTrigger>\n                <TabsTrigger value=\"contacts\">\n                  {record.nb_contacts\n                    ? record.nb_contacts === 1\n                      ? \"1 Contact\"\n                      : `${record.nb_contacts} Contacts`\n                    : \"No Contacts\"}\n                </TabsTrigger>\n                {record.nb_deals ? (\n                  <TabsTrigger value=\"deals\">\n                    {record.nb_deals === 1\n                      ? \"1 deal\"\n                      : `${record.nb_deals} deals`}\n                  </TabsTrigger>\n                ) : null}\n              </TabsList>\n              <TabsContent value=\"activity\" className=\"pt-2\">\n                <ActivityLog companyId={record.id} context=\"company\" />\n              </TabsContent>\n              <TabsContent value=\"contacts\">\n                {record.nb_contacts ? (\n                  <ReferenceManyField\n                    reference=\"contacts_summary\"\n                    target=\"company_id\"\n                    sort={{ field: \"last_name\", order: \"ASC\" }}\n                  >\n                    <div className=\"flex flex-col gap-4\">\n                      <div className=\"flex flex-row justify-end space-x-2 mt-1\">\n                        {!!record.nb_contacts && (\n                          <SortButton\n                            fields={[\"last_name\", \"first_name\", \"last_seen\"]}\n                          />\n                        )}\n                        <CreateRelatedContactButton />\n                      </div>\n                      <ContactsIterator />\n                    </div>\n                  </ReferenceManyField>\n                ) : (\n                  <div className=\"flex flex-col gap-4\">\n                    <div className=\"flex flex-row justify-end space-x-2 mt-1\">\n                      <CreateRelatedContactButton />\n                    </div>\n                  </div>\n                )}\n              </TabsContent>\n              <TabsContent value=\"deals\">\n                {record.nb_deals ? (\n                  <ReferenceManyField\n                    reference=\"lead-journey\"\n                    target=\"company_id\"\n                    sort={{ field: \"name\", order: \"ASC\" }}\n                  >\n                    <DealsIterator />\n                  </ReferenceManyField>\n                ) : null}\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n      <CompanyAside />\n    </div>\n  );\n};\n\nconst ContactsIterator = () => {\n  const location = useLocation();\n  const { data: contacts, error, isPending } = useListContext<Contact>();\n\n  if (isPending || error) return null;\n\n  const now = Date.now();\n  return (\n    <div className=\"pt-0\">\n      {contacts.map((contact) => (\n        <RecordContextProvider key={contact.id} value={contact}>\n          <div className=\"p-0 text-sm\">\n            <RouterLink\n              to={`/contacts/${contact.id}/show`}\n              state={{ from: location.pathname }}\n              className=\"flex items-center justify-between hover:bg-muted py-2 transition-colors\"\n            >\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"font-medium\">\n                  {`${contact.first_name} ${contact.last_name}`}\n                </div>\n                <div className=\"text-sm text-muted-foreground\">\n                  {contact.title}\n                  {contact.nb_tasks\n                    ? ` - ${contact.nb_tasks} task${\n                        contact.nb_tasks > 1 ? \"s\" : \"\"\n                      }`\n                    : \"\"}\n                  &nbsp; &nbsp;\n                  <TagsList />\n                </div>\n              </div>\n              {contact.last_seen && (\n                <div className=\"text-right\">\n                  <div className=\"text-sm text-muted-foreground\">\n                    last activity {formatDistance(contact.last_seen, now)} ago{\" \"}\n                    <Status status={contact.status} />\n                  </div>\n                </div>\n              )}\n            </RouterLink>\n          </div>\n        </RecordContextProvider>\n      ))}\n    </div>\n  );\n};\n\nconst CreateRelatedContactButton = () => {\n  const company = useRecordContext<Company>();\n  return (\n    <Button variant=\"outline\" asChild size=\"sm\" className=\"h-9\">\n      <RouterLink\n        to=\"/contacts/create\"\n        state={company ? { record: { company_id: company.id } } : undefined}\n        className=\"flex items-center gap-2\"\n      >\n        <UserPlus className=\"h-4 w-4\" />\n        Add contact\n      </RouterLink>\n    </Button>\n  );\n};\n\nconst DealsIterator = () => {\n  const { data: deals, error, isPending } = useListContext<Deal>();\n  const { dealStages } = useConfigurationContext();\n  if (isPending || error) return null;\n\n  const now = Date.now();\n  return (\n    <div>\n      <div>\n        {deals.map((deal) => (\n          <div key={deal.id} className=\"p-0 text-sm\">\n            <RouterLink\n              to={`/lead-journey/${deal.id}/show`}\n              className=\"flex items-center justify-between hover:bg-muted py-2 px-4 transition-colors\"\n            >\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"font-medium\">{deal.name}</div>\n                <div className=\"text-sm text-muted-foreground\">\n                  {findDealLabel(dealStages, deal.stage)},{\" \"}\n                  {deal.amount.toLocaleString(\"en-US\", {\n                    notation: \"compact\",\n                    style: \"currency\",\n                    currency: \"AED\",\n                    currencyDisplay: \"narrowSymbol\",\n                    minimumSignificantDigits: 3,\n                  })}\n                  {deal.category ? `, ${deal.category}` : \"\"}\n                </div>\n              </div>\n              <div className=\"text-right\">\n                <div className=\"text-sm text-muted-foreground\">\n                  last activity {formatDistance(deal.updated_at, now)} ago{\" \"}\n                </div>\n              </div>\n            </RouterLink>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyListFilter.tsx",
      "content": "import { Building, Truck, Users } from \"lucide-react\";\nimport { FilterLiveForm, useGetIdentity } from \"ra-core\";\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { sizes } from \"./sizes\";\n\nexport const CompanyListFilter = () => {\n  const { identity } = useGetIdentity();\n  const { companySectors } = useConfigurationContext();\n  const sectors = companySectors.map((sector) => ({\n    id: sector,\n    name: sector,\n  }));\n  return (\n    <div className=\"w-52 min-w-52 flex flex-col gap-8\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" />\n      </FilterLiveForm>\n\n      <FilterCategory icon={<Building className=\"h-4 w-4\" />} label=\"Size\">\n        {sizes.map((size) => (\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label={size.name}\n            value={{ size: size.id }}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory icon={<Truck className=\"h-4 w-4\" />} label=\"Sector\">\n        {sectors.map((sector) => (\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label={sector.name}\n            value={{ sector: sector.id }}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<Users className=\"h-4 w-4\" />}\n        label=\"Account Manager\"\n      >\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label={\"Me\"}\n          value={{ sales_id: identity?.id }}\n        />\n      </FilterCategory>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyList.tsx",
      "content": "import { useGetIdentity, useListContext } from \"ra-core\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { ListPagination } from \"@/components/admin/list-pagination\";\nimport { SortButton } from \"@/components/admin/sort-button\";\n\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { CompanyEmpty } from \"./CompanyEmpty\";\nimport { CompanyListFilter } from \"./CompanyListFilter\";\nimport { ImageList } from \"./GridList\";\n\nexport const CompanyList = () => {\n  const { identity } = useGetIdentity();\n  if (!identity) return null;\n  return (\n    <List\n      title={false}\n      perPage={25}\n      sort={{ field: \"name\", order: \"ASC\" }}\n      actions={<CompanyListActions />}\n      pagination={<ListPagination rowsPerPageOptions={[10, 25, 50, 100]} />}\n    >\n      <CompanyListLayout />\n    </List>\n  );\n};\n\nconst CompanyListLayout = () => {\n  const { data, isPending, filterValues } = useListContext();\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  if (isPending) return null;\n  if (!data?.length && !hasFilters) return <CompanyEmpty />;\n\n  return (\n    <div className=\"w-full flex flex-row gap-8\">\n      <CompanyListFilter />\n      <div className=\"flex flex-col flex-1 gap-4\">\n        <ImageList />\n      </div>\n    </div>\n  );\n};\n\nconst CompanyListActions = () => {\n  return (\n    <TopToolbar>\n      <SortButton fields={[\"name\", \"created_at\", \"nb_contacts\"]} />\n      <ExportButton />\n      <CreateButton label=\"New Company\" />\n    </TopToolbar>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyInputs.tsx",
      "content": "import { required, useRecordContext } from \"ra-core\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { ArrayInput } from \"@/components/admin/array-input\";\nimport { SimpleFormIterator } from \"@/components/admin/simple-form-iterator\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport ImageEditorField from \"../misc/ImageEditorField\";\nimport { isLinkedinUrl } from \"../misc/isLinkedInUrl\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Company, Sale } from \"../types\";\nimport { sizes } from \"./sizes\";\n\nconst isUrl = (url: string) => {\n  if (!url) return;\n  const UrlRegex = new RegExp(\n    /^(http:\\/\\/www\\.|https:\\/\\/www\\.|http:\\/\\/|https:\\/\\/)?[a-z0-9]+([-.]{1}[a-z0-9]+)*\\.[a-z]{2,5}(:[0-9]{1,5})?(\\/.*)?$/i,\n  );\n  if (!UrlRegex.test(url)) {\n    return \"Must be a valid URL\";\n  }\n};\n\nexport const CompanyInputs = () => {\n  const isMobile = useIsMobile();\n\n  return (\n    <div className=\"flex flex-col gap-4 p-1\">\n      <CompanyDisplayInputs />\n      <div className={`flex gap-6 ${isMobile ? \"flex-col\" : \"flex-row\"}`}>\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <CompanyContactInputs />\n          <CompanyContextInputs />\n        </div>\n        <Separator orientation={isMobile ? \"horizontal\" : \"vertical\"} />\n        <div className=\"flex flex-col gap-8 flex-1\">\n          <CompanyAddressInputs />\n          <CompanyAdditionalInformationInputs />\n          <CompanyAccountManagerInput />\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst CompanyDisplayInputs = () => {\n  const record = useRecordContext<Company>();\n  return (\n    <div className=\"flex gap-4 flex-1 flex-row\">\n      <ImageEditorField\n        source=\"logo\"\n        type=\"avatar\"\n        width={60}\n        height={60}\n        emptyText={record?.name.charAt(0)}\n        linkPosition=\"bottom\"\n      />\n      <TextInput\n        source=\"name\"\n        className=\"w-full h-fit\"\n        validate={required()}\n        helperText={false}\n        placeholder=\"Company name\"\n      />\n    </div>\n  );\n};\n\nconst CompanyContactInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Contact</h6>\n      <TextInput source=\"website\" helperText={false} validate={isUrl} />\n      <TextInput\n        source=\"linkedin_url\"\n        helperText={false}\n        validate={isLinkedinUrl}\n      />\n      <TextInput source=\"phone_number\" helperText={false} />\n    </div>\n  );\n};\n\nconst CompanyContextInputs = () => {\n  const { companySectors } = useConfigurationContext();\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Context</h6>\n      <SelectInput\n        source=\"sector\"\n        choices={companySectors.map((sector) => ({\n          id: sector,\n          name: sector,\n        }))}\n        helperText={false}\n      />\n      <SelectInput source=\"size\" choices={sizes} helperText={false} />\n      <TextInput source=\"revenue\" helperText={false} />\n      <TextInput source=\"tax_identifier\" helperText={false} />\n    </div>\n  );\n};\n\nconst CompanyAddressInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Address</h6>\n      <TextInput source=\"address\" helperText={false} />\n      <TextInput source=\"city\" helperText={false} />\n      <TextInput source=\"zipcode\" helperText={false} />\n      <TextInput source=\"stateAbbr\" helperText={false} />\n      <TextInput source=\"country\" helperText={false} />\n    </div>\n  );\n};\n\nconst CompanyAdditionalInformationInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Additional information</h6>\n      <TextInput source=\"description\" multiline helperText={false} />\n      <ArrayInput source=\"context_links\" helperText={false}>\n        <SimpleFormIterator disableReordering fullWidth getItemLabel={false}>\n          <TextInput\n            source=\"\"\n            label={false}\n            helperText={false}\n            validate={isUrl}\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n    </div>\n  );\n};\n\nconst CompanyAccountManagerInput = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Account manager</h6>\n      <ReferenceInput\n        source=\"sales_id\"\n        reference=\"sales\"\n        filter={{\n          \"disabled@neq\": true,\n        }}\n      >\n        <SelectInput\n          label=\"Account manager\"\n          helperText={false}\n          optionText={saleOptionRenderer}\n        />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst saleOptionRenderer = (choice: Sale) =>\n  `${choice.first_name} ${choice.last_name}`;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyEmpty.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\n\nexport const CompanyEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-6\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No companies found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h6 className=\"text-lg font-bold\">No companies found</h6>\n        <p className=\"text-sm text-center text-muted-foreground mb-4\">\n          It seems your company list is empty.\n        </p>\n      </div>\n      <div className=\"flex space-x-2\">\n        <CreateButton label=\"Create Company\" />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyEdit.tsx",
      "content": "import { EditBase, Form } from \"ra-core\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { CompanyInputs } from \"./CompanyInputs\";\nimport { CompanyAside } from \"./CompanyAside\";\nimport { FormToolbar } from \"../layout/FormToolbar\";\n\nexport const CompanyEdit = () => (\n  <EditBase\n    actions={false}\n    redirect=\"show\"\n    transform={(values) => {\n      // add https:// before website if not present\n      if (values.website && !values.website.startsWith(\"http\")) {\n        values.website = `https://${values.website}`;\n      }\n      return values;\n    }}\n  >\n    <div className=\"mt-2 flex gap-8\">\n      <Form className=\"flex flex-1 flex-col gap-4 pb-2\">\n        <Card>\n          <CardContent>\n            <CompanyInputs />\n            <FormToolbar />\n          </CardContent>\n        </Card>\n      </Form>\n\n      <CompanyAside link=\"show\" />\n    </div>\n  </EditBase>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyCreate.tsx",
      "content": "import { CreateBase, Form, useGetIdentity } from \"ra-core\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport { CompanyInputs } from \"./CompanyInputs\";\n\nexport const CompanyCreate = () => {\n  const { identity } = useGetIdentity();\n  return (\n    <CreateBase\n      redirect=\"show\"\n      transform={(values) => {\n        // add https:// before website if not present\n        if (values.website && !values.website.startsWith(\"http\")) {\n          values.website = `https://${values.website}`;\n        }\n        return values;\n      }}\n    >\n      <div className=\"mt-2 flex lg:mr-72\">\n        <div className=\"flex-1\">\n          <Form defaultValues={{ sales_id: identity?.id }}>\n            <Card>\n              <CardContent>\n                <CompanyInputs />\n                <FormToolbar>\n                  <div className=\"flex flex-row gap-2 justify-end\">\n                    <CancelButton />\n                    <SaveButton label=\"Create Company\" />\n                  </div>\n                </FormToolbar>\n              </CardContent>\n            </Card>\n          </Form>\n        </div>\n      </div>\n    </CreateBase>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyCard.tsx",
      "content": "import { DollarSign } from \"lucide-react\";\nimport { Link } from \"react-router\";\nimport { useCreatePath, useRecordContext } from \"ra-core\";\nimport { Card } from \"@/components/ui/card\";\n\nimport type { Company } from \"../types\";\n\nexport const CompanyCard = (props: { record?: Company }) => {\n  const createPath = useCreatePath();\n  const record = useRecordContext<Company>(props);\n  if (!record) return null;\n\n  return (\n    <Link\n      to={createPath({\n        resource: \"companies\",\n        id: record.id,\n        type: \"show\",\n      })}\n      className=\"no-underline\"\n    >\n      <Card className=\"h-[200px] flex flex-col justify-between p-4 hover:bg-muted\">\n        <div className=\"flex flex-col items-center gap-1\">\n          <div className=\"text-center mt-1\">\n            <h6 className=\"text-sm font-medium\">{record.name}</h6>\n            <p className=\"text-xs text-muted-foreground\">{record.sector}</p>\n          </div>\n        </div>\n        <div className=\"flex flex-row w-full justify-between gap-2\">\n          <div className=\"flex items-center\">\n          </div>\n          {record.nb_deals ? (\n            <div className=\"flex items-center ml-2 gap-0.5\">\n              <DollarSign className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"text-sm font-medium\">{record.nb_deals}</span>\n              <span className=\"text-xs text-muted-foreground\">\n                {record.nb_deals\n                  ? record.nb_deals > 1\n                    ? \"deals\"\n                    : \"deal\"\n                  : \"deal\"}\n              </span>\n            </div>\n          ) : null}\n        </div>\n      </Card>\n    </Link>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyAvatar.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\n\nimport type { Company } from \"../types\";\n\nexport const CompanyAvatar = (props: {\n  record?: Company;\n  width?: 20 | 40;\n  height?: 20 | 40;\n}) => {\n  const { width = 40 } = props;\n  const record = useRecordContext<Company>(props);\n  if (!record) return null;\n\n  const sizeClass = width !== 40 ? `w-[20px] h-[20px]` : \"w-10 h-10\";\n\n  return (\n    <Avatar className={sizeClass}>\n      <AvatarImage\n        src={record.logo?.src}\n        alt={record.name}\n        className=\"object-contain\"\n      />\n      <AvatarFallback className={width !== 40 ? \"text-xs\" : \"text-sm\"}>\n        {record.name.charAt(0)}\n      </AvatarFallback>\n    </Avatar>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyAside.tsx",
      "content": "import { Globe, Linkedin, Phone } from \"lucide-react\";\nimport { useRecordContext } from \"ra-core\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { UrlField } from \"@/components/admin/url-field\";\nimport { SelectField } from \"@/components/admin/select-field\";\n\nimport { AsideSection } from \"../misc/AsideSection\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { Company } from \"../types\";\nimport { sizes } from \"./sizes\";\n\ninterface CompanyAsideProps {\n  link?: string;\n}\n\nexport const CompanyAside = ({ link = \"edit\" }: CompanyAsideProps) => {\n  const record = useRecordContext<Company>();\n  if (!record) return null;\n\n  return (\n    <div className=\"hidden sm:block w-[250px] min-w-[250px] space-y-4\">\n      <div className=\"flex flex-row space-x-1\">\n        {link === \"edit\" ? (\n          <EditButton label=\"Edit Company\" />\n        ) : (\n          <ShowButton label=\"Show Company\" />\n        )}\n      </div>\n\n      <CompanyInfo record={record} />\n\n      <AddressInfo record={record} />\n\n      <ContextInfo record={record} />\n\n      <AdditionalInfo record={record} />\n\n      {link !== \"edit\" && (\n        <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n          <DeleteButton\n            className=\"h-6 cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\"\n            size=\"sm\"\n          />\n        </div>\n      )}\n    </div>\n  );\n};\n\nconst CompanyInfo = ({ record }: { record: Company }) => {\n  if (!record.website && !record.linkedin_url && !record.phone_number) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Company Info\">\n      {record.website && (\n        <div className=\"flex flex-row items-center gap-1 min-h-[24px]\">\n          <Globe className=\"w-4 h-4\" />\n          <UrlField\n            source=\"website\"\n            target=\"_blank\"\n            rel=\"noopener\"\n            content={record.website\n              .replace(\"http://\", \"\")\n              .replace(\"https://\", \"\")}\n          />\n        </div>\n      )}\n      {record.linkedin_url && (\n        <div className=\"flex flex-row items-center gap-1 min-h-[24px]\">\n          <Linkedin className=\"w-4 h-4\" />\n          <a\n            className=\"underline hover:no-underline\"\n            href={record.linkedin_url}\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            title={record.linkedin_url}\n          >\n            LinkedIn\n          </a>\n        </div>\n      )}\n      {record.phone_number && (\n        <div className=\"flex flex-row items-center gap-1 min-h-[24px]\">\n          <Phone className=\"w-4 h-4\" />\n          <TextField source=\"phone_number\" />\n        </div>\n      )}\n    </AsideSection>\n  );\n};\n\nconst ContextInfo = ({ record }: { record: Company }) => {\n  if (!record.revenue && !record.id) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Context\">\n      {record.sector && (\n        <span>\n          Sector: <TextField source=\"sector\" />\n        </span>\n      )}\n      {record.size && (\n        <span>\n          Size: <SelectField source=\"size\" choices={sizes} />\n        </span>\n      )}\n      {record.revenue && (\n        <span>\n          Revenue: <TextField source=\"revenue\" />\n        </span>\n      )}\n      {record.tax_identifier && (\n        <span>\n          Tax Identifier: <TextField source=\"tax_identifier\" />\n        </span>\n      )}\n    </AsideSection>\n  );\n};\n\nconst AddressInfo = ({ record }: { record: Company }) => {\n  if (!record.address && !record.city && !record.zipcode && !record.stateAbbr) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Main Address\" noGap>\n      <TextField source=\"address\" />\n      <TextField source=\"city\" />\n      <TextField source=\"zipcode\" />\n      <TextField source=\"stateAbbr\" />\n      <TextField source=\"country\" />\n    </AsideSection>\n  );\n};\n\nconst AdditionalInfo = ({ record }: { record: Company }) => {\n  if (\n    !record.created_at &&\n    !record.sales_id &&\n    !record.description &&\n    !record.context_links\n  ) {\n    return null;\n  }\n  const getBaseURL = (url: string) => {\n    const urlObject = new URL(url.startsWith(\"http\") ? url : `https://${url}`);\n    return urlObject.hostname;\n  };\n\n  return (\n    <AsideSection title=\"Additional Info\">\n      {record.description && (\n        <p className=\"text-sm  mb-1\">{record.description}</p>\n      )}\n      {record.context_links && (\n        <div className=\"flex flex-col\">\n          {record.context_links.map((link, index) =>\n            link ? (\n              <a\n                key={index}\n                className=\"text-sm underline hover:no-underline mb-1\"\n                href={link.startsWith(\"http\") ? link : `https://${link}`}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                title={link}\n              >\n                {getBaseURL(link)}\n              </a>\n            ) : null,\n          )}\n        </div>\n      )}\n      {record.sales_id !== null && (\n        <div className=\"inline-flex text-sm text-muted-foreground mb-1\">\n          Followed by&nbsp;\n          <ReferenceField source=\"sales_id\" reference=\"sales\" record={record}>\n            <SaleName />\n          </ReferenceField>\n        </div>\n      )}\n      {record.created_at && (\n        <p className=\"text-sm text-muted-foreground mb-1\">\n          Added on{\" \"}\n          <DateField\n            source=\"created_at\"\n            record={record}\n            options={{\n              year: \"numeric\",\n              month: \"long\",\n              day: \"numeric\",\n            }}\n          />\n        </p>\n      )}\n    </AsideSection>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/AutocompleteCompanyInput.tsx",
      "content": "import { useCreate, useGetIdentity, useNotify } from \"ra-core\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport type { InputProps } from \"ra-core\";\n\nexport const AutocompleteCompanyInput = ({\n  validate,\n}: Pick<InputProps, \"validate\">) => {\n  const [create] = useCreate();\n  const { identity } = useGetIdentity();\n  const notify = useNotify();\n  const handleCreateCompany = async (name?: string) => {\n    if (!name) return;\n    try {\n      const newCompany = await create(\n        \"companies\",\n        {\n          data: {\n            name,\n            sales_id: identity?.id,\n            created_at: new Date().toISOString(),\n          },\n        },\n        { returnPromise: true },\n      );\n      return newCompany;\n    } catch {\n      notify(\"An error occurred while creating the company\", {\n        type: \"error\",\n      });\n    }\n  };\n\n  return (\n    <AutocompleteInput\n      optionText=\"name\"\n      helperText={false}\n      onCreate={handleCreateCompany}\n      createItemLabel=\"Create %{item}\"\n      createLabel=\"Start typing to create a new company\"\n      validate={validate}\n    />\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/index.tsx",
      "content": "import type { Contact } from \"../types\";\nimport { ClientCreate } from \"./ClientCreate\";\nimport { ClientEdit } from \"./ClientEdit\";\nimport { ClientList } from \"./ClientList\";\nimport { ClientShow } from \"./ClientShow\";\n\nexport default {\n  list: ClientList,\n  show: ClientShow,\n  edit: ClientEdit,\n  create: ClientCreate,\n  recordRepresentation: (record: Contact) =>\n    record?.first_name + \" \" + record?.last_name,\n};\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientShow.tsx",
      "content": "import { ShowBase, useShowContext, useGetList, RecordContextProvider, useRefresh, useUpdate, useNotify } from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Edit, Save, CircleX } from \"lucide-react\";\nimport { useMemo, useState, useEffect } from \"react\";\nimport type { SubmitHandler, FieldValues } from \"react-hook-form\";\nimport { useForm, FormProvider } from \"react-hook-form\";\n\nimport type { Contact, Task, Quote, Deal, PaymentPackage, Service } from \"../types\";\nimport { ContactAside } from \"../contacts/ContactAside\";\nimport { QuoteItem } from \"../quotes/QuoteItem\";\nimport { AddQuote } from \"../quotes/AddQuote\";\nimport { Task as TaskComponent } from \"../tasks/Task\";\nimport { AddTask } from \"../tasks/AddTask\";\nimport { UnifiedNotesIterator } from \"../notes/UnifiedNotesIterator\";\nimport { ActivityLog } from \"../activity/ActivityLog\";\nimport { usePackageUsage } from \"@/hooks/usePackageUsage\";\nimport { Link } from \"react-router\";\nimport { Plus, ExternalLink } from \"lucide-react\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport {\n  crmAddDays,\n  crmEndOfDay,\n  crmEndOfWeek,\n  crmStartOfDay,\n} from \"../misc/timezone\";\n\nexport const ClientShow = () => (\n  <ShowBase>\n    <ClientShowContent />\n  </ShowBase>\n);\n\nconst ClientShowContent = () => {\n  const { record, isPending } = useShowContext<Contact>();\n  const refresh = useRefresh();\n  const [isEditingDescription, setIsEditingDescription] = useState(false);\n  const [update, { isPending: isUpdating }] = useUpdate();\n  const notify = useNotify();\n\n  // Fetch deals associated with this contact to get deal IDs for notes\n  // Fetch both archived and non-archived deals\n  const { data: deals } = useGetList<Deal>(\"lead-journey\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record?.id ? { lead_id: record.id } : {},\n    sort: { field: \"archived_at\", order: \"ASC\" }, // Non-archived first\n  }, { enabled: !!record?.id });\n  \n  // Separate archived and non-archived deals\n  const sortedDeals = useMemo(() => {\n    if (!deals) return [];\n    const active = deals.filter(d => !d.archived_at);\n    const archived = deals.filter(d => d.archived_at);\n    return [...active, ...archived];\n  }, [deals]);\n\n  // Get all deal IDs for fetching notes from all deals\n  const dealIds = useMemo(() => {\n    return deals?.map(deal => deal.id) || [];\n  }, [deals]);\n\n  const { data: quotes } = useGetList<Quote>(\"quotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n    filter: record?.id ? { contact_id: record.id } : {},\n  }, { enabled: !!record?.id });\n\n  const { data: tasks } = useGetList<Task>(\"tasks\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record?.id ? { contact_id: record.id } : {},\n  }, { enabled: !!record?.id });\n\n  const { data: paymentPackages } = useGetList<PaymentPackage>(\"payment_packages\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record?.id ? { patient_id: record.id } : {},\n    sort: { field: \"created_at\", order: \"DESC\" },\n  }, { enabled: !!record?.id });\n\n  const { data: services } = useGetList<Service>(\"services\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n\n  const [showCompletedTasks, setShowCompletedTasks] = useState(false);\n\n  const groupedTasks = useMemo(() => {\n    const empty = {\n      overdue: [] as Task[],\n      today: [] as Task[],\n      tomorrow: [] as Task[],\n      thisWeek: [] as Task[],\n      later: [] as Task[],\n      completed: [] as Task[],\n    };\n    if (!tasks) return empty;\n\n    const startOfToday = crmStartOfDay() ?? new Date();\n    const endOfToday = crmEndOfDay() ?? new Date();\n    const endOfTomorrow = crmEndOfDay(crmAddDays(new Date(), 1)) ?? new Date();\n    const endOfWeek = crmEndOfWeek() ?? new Date();\n\n    for (const task of tasks) {\n      if (task.done_date) {\n        empty.completed.push(task);\n        continue;\n      }\n\n      const due = task.due_date ? new Date(task.due_date) : null;\n      if (!due || Number.isNaN(due.getTime())) {\n        empty.later.push(task);\n        continue;\n      }\n\n      if (due < startOfToday) empty.overdue.push(task);\n      else if (due <= endOfToday) empty.today.push(task);\n      else if (due <= endOfTomorrow) empty.tomorrow.push(task);\n      else if (due <= endOfWeek) empty.thisWeek.push(task);\n      else empty.later.push(task);\n    }\n\n    const byDueDateAsc = (a: Task, b: Task) =>\n      new Date(a.due_date || 0).getTime() - new Date(b.due_date || 0).getTime();\n\n    empty.overdue.sort(byDueDateAsc);\n    empty.today.sort(byDueDateAsc);\n    empty.tomorrow.sort(byDueDateAsc);\n    empty.thisWeek.sort(byDueDateAsc);\n    empty.later.sort(byDueDateAsc);\n\n    empty.completed.sort(\n      (a, b) => new Date(b.done_date || 0).getTime() - new Date(a.done_date || 0).getTime(),\n    );\n\n    return empty;\n  }, [tasks]);\n\n  const form = useForm<{ description: string }>({\n    defaultValues: {\n      description: record?.description || \"\",\n    },\n  });\n\n  // Reset form when record ID changes (different contact)\n  useEffect(() => {\n    if (record) {\n      form.reset({ description: record.description || \"\" });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [record?.id]);\n\n  const handleDescriptionUpdate: SubmitHandler<FieldValues> = (values) => {\n    if (!record) return;\n    update(\n      \"contacts\",\n      { id: record.id, data: { description: values.description || null }, previousData: record },\n      {\n        onSuccess: () => {\n          setIsEditingDescription(false);\n          refresh();\n          notify(\"Description updated\", { type: \"info\" });\n        },\n        onError: (error: any) => {\n          console.error(\"Error updating description:\", error);\n          notify(\n            error?.message?.includes(\"description\") \n              ? \"Description column not found. Please ensure migrations are applied.\"\n              : \"Failed to update description\",\n            { type: \"error\" }\n          );\n        },\n      },\n    );\n  };\n\n  const handleCancelEdit = () => {\n    if (record) {\n      form.reset({ description: record.description || \"\" });\n    }\n    setIsEditingDescription(false);\n  };\n\n  if (isPending || !record) return null;\n\n  return (\n    <div className=\"mt-2 mb-2 flex gap-8\">\n      <div className=\"flex-1\">\n        <Card>\n          <CardContent>\n            <div className=\"flex\">\n              <div className=\"flex-1\">\n                <div className=\"flex items-center gap-2\">\n                  <h5 className=\"text-xl font-semibold\">\n                    {record.first_name} {record.last_name}\n                  </h5>\n                  <Badge variant=\"default\" className=\"text-xs text-white bg-emerald-600 hover:bg-emerald-700\">\n                    Client\n                  </Badge>\n                </div>\n                <div className=\"inline-flex text-sm text-muted-foreground\">\n                  {record.title}\n                  {record.title && record.company_id != null && \" at \"}\n                  {record.company_id != null && (\n                    <ReferenceField\n                      source=\"company_id\"\n                      reference=\"companies\"\n                      link=\"show\"\n                    >\n                      &nbsp;\n                      <TextField source=\"name\" />\n                    </ReferenceField>\n                  )}\n                </div>\n                <div className=\"mt-4\">\n                  {isEditingDescription ? (\n                    <FormProvider {...form}>\n                      <form onSubmit={form.handleSubmit(handleDescriptionUpdate)}>\n                        <div className=\"flex flex-col gap-2\">\n                          <Textarea\n                            {...form.register(\"description\")}\n                            placeholder=\"Add a description...\"\n                            rows={4}\n                            className=\"text-sm\"\n                          />\n                          <div className=\"flex justify-end gap-2\">\n                            <Button\n                              variant=\"outline\"\n                              onClick={handleCancelEdit}\n                              type=\"button\"\n                              size=\"sm\"\n                              className=\"cursor-pointer\"\n                            >\n                              <CircleX className=\"w-4 h-4 mr-2\" />\n                              Cancel\n                            </Button>\n                            <Button\n                              type=\"submit\"\n                              disabled={isUpdating}\n                              size=\"sm\"\n                              className=\"cursor-pointer\"\n                            >\n                              <Save className=\"w-4 h-4 mr-2\" />\n                              Save\n                            </Button>\n                          </div>\n                        </div>\n                      </form>\n                    </FormProvider>\n                  ) : (\n                    <div className=\"group relative\">\n                      {record.description ? (\n                        <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                          {record.description}\n                        </p>\n                      ) : (\n                        <p className=\"text-sm text-muted-foreground italic\">\n                          No description\n                        </p>\n                      )}\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => {\n                          form.reset({ description: record.description || \"\" });\n                          setIsEditingDescription(true);\n                        }}\n                        className=\"mt-2 h-7 cursor-pointer\"\n                      >\n                        <Edit className=\"w-3.5 h-3.5 mr-2\" />\n                        {record.description ? \"Edit description\" : \"Add description\"}\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n            \n            <Tabs defaultValue=\"activity\" className=\"mt-6\">\n              <TabsList className=\"w-full\">\n                <TabsTrigger value=\"activity\" className=\"flex-1\">Activity</TabsTrigger>\n                <TabsTrigger value=\"notes\" className=\"flex-1\">Notes</TabsTrigger>\n                <TabsTrigger value=\"quotes\" className=\"flex-1\">Quotes</TabsTrigger>\n                <TabsTrigger value=\"tasks\" className=\"flex-1\">Tasks</TabsTrigger>\n                <TabsTrigger value=\"packages\" className=\"flex-1\">Payment Packages</TabsTrigger>\n              </TabsList>\n              \n              <TabsContent value=\"activity\" className=\"pt-4\">\n                <Card className=\"mb-2 p-6\">\n                  <ActivityLog contactId={record.id} pageSize={10} context=\"contact\" />\n                </Card>\n              </TabsContent>\n              \n              <TabsContent value=\"notes\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <UnifiedNotesIterator\n                    reference=\"contacts\"\n                    showStatus\n                    contactId={record.id}\n                    leadId={record.id}\n                    dealIds={dealIds}\n                  />\n                </RecordContextProvider>\n              </TabsContent>\n              \n              <TabsContent value=\"quotes\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <AddQuote />\n                </RecordContextProvider>\n                {quotes && quotes.length > 0 && (\n                  <div className=\"mt-4 space-y-2\">\n                    {quotes.map((quote) => (\n                      <QuoteItem quote={quote} key={quote.id} />\n                    ))}\n                  </div>\n                )}\n              </TabsContent>\n              \n              <TabsContent value=\"tasks\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <AddTask />\n                </RecordContextProvider>\n                <div className=\"mt-4 space-y-6\">\n                  {tasks && tasks.length > 0 ? (\n                    <>\n                      {groupedTasks.overdue.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Overdue\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.overdue.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.today.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Today\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.today.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.tomorrow.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Tomorrow\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.tomorrow.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.thisWeek.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            This Week\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.thisWeek.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.later.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Later\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.later.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.completed.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            className=\"cursor-pointer\"\n                            onClick={() => setShowCompletedTasks((v) => !v)}\n                          >\n                            {showCompletedTasks ? \"Hide\" : \"Show\"} completed (\n                            {groupedTasks.completed.length})\n                          </Button>\n                          {showCompletedTasks && (\n                            <div className=\"space-y-2\">\n                              {groupedTasks.completed.map((task) => (\n                                <TaskComponent task={task} key={task.id} />\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </>\n                  ) : (\n                    <p className=\"text-sm text-muted-foreground\">No tasks yet</p>\n                  )}\n                </div>\n              </TabsContent>\n              \n              <TabsContent value=\"packages\" className=\"pt-4\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h3 className=\"text-lg font-semibold\">Payment Packages</h3>\n                  <Link to={`/payment_packages/create?patient_id=${record.id}`}>\n                    <Button size=\"sm\" className=\"cursor-pointer\">\n                      <Plus className=\"w-4 h-4 mr-2\" />\n                      Create Package\n                    </Button>\n                  </Link>\n                </div>\n                {paymentPackages && paymentPackages.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {paymentPackages.map((pkg) => (\n                      <PackageCard key={pkg.id} package={pkg} services={services || []} />\n                    ))}\n                  </div>\n                ) : (\n                  <p className=\"text-sm text-muted-foreground\">No payment packages yet</p>\n                )}\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n      <ContactAside deals={sortedDeals} />\n    </div>\n  );\n};\n\n// Package Card Component\nconst PackageCard = ({ package: pkg, services }: { package: PaymentPackage; services: Service[] }) => {\n  const { sessionsUsed, hoursUsed } = usePackageUsage(pkg.id);\n  const service = services.find(s => s.id === pkg.service_id);\n  \n  const statusColors = {\n    active: \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300\",\n    completed: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n    expired: \"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300\",\n  };\n\n  return (\n    <Card>\n      <CardContent className=\"pt-6\">\n        <div className=\"flex items-start justify-between mb-4\">\n          <div>\n            <div className=\"flex items-center gap-2 mb-2\">\n              <h4 className=\"font-semibold\">\n                {service?.name || \"Service\"} Package #{pkg.id}\n              </h4>\n              <Badge className={statusColors[pkg.status] || statusColors.completed}>\n                {pkg.status}\n              </Badge>\n            </div>\n            <p className=\"text-sm text-muted-foreground\">\n              {pkg.package_type === \"session-based\" && pkg.total_sessions && (\n                <>Usage: {sessionsUsed || 0} / {pkg.total_sessions} sessions</>\n              )}\n              {pkg.package_type === \"time-based\" && pkg.total_hours && (\n                <>Usage: {hoursUsed || 0} / {pkg.total_hours} hours</>\n              )}\n              {pkg.package_type === \"post-payment\" && \"Post-payment package\"}\n            </p>\n          </div>\n          <Link to={`/payment_packages/${pkg.id}/show`}>\n            <Button variant=\"outline\" size=\"sm\" className=\"cursor-pointer\">\n              <ExternalLink className=\"w-4 h-4 mr-2\" />\n              View Details\n            </Button>\n          </Link>\n        </div>\n        <div className=\"grid grid-cols-3 gap-4 text-sm\">\n          <div>\n            <p className=\"text-muted-foreground\">Total Amount</p>\n            <p className=\"font-medium\">AED {pkg.total_amount.toLocaleString()}</p>\n          </div>\n          {pkg.renewal_date && (\n            <div>\n              <p className=\"text-muted-foreground\">Renewal Date</p>\n              <DateField source=\"renewal_date\" record={pkg} />\n            </div>\n          )}\n          <div>\n            <p className=\"text-muted-foreground\">Start Date</p>\n            <DateField source=\"start_date\" record={pkg} />\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientListFilter.tsx",
      "content": "import { subMonths } from \"date-fns\";\nimport isEqual from \"lodash/isEqual\";\nimport {\n  Archive,\n  CheckSquare,\n  Clock,\n  Stethoscope,\n  Tag,\n  Users,\n} from \"lucide-react\";\nimport {\n  FilterLiveForm,\n  useGetIdentity,\n  useGetList,\n  useListContext,\n} from \"ra-core\";\n\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { FilterOptionButton } from \"../filters/FilterOptionButton\";\nimport {\n  buildInFilter,\n  buildOverlapFilter,\n  parseInFilter,\n  parseOverlapFilter,\n  RangeFilter,\n  toggleValueInList,\n} from \"../filters/filterUtils\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport {\n  crmEndOfYesterday,\n  crmStartOfMonth,\n  crmStartOfWeek,\n} from \"../misc/timezone\";\n\nexport const ClientListFilter = () => {\n  const { filterValues = {}, setFilters } = useListContext();\n  const { identity } = useGetIdentity();\n  const { data } = useGetList(\"tags\", {\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: salesData } = useGetList(\"sales\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"first_name\", order: \"ASC\" },\n  });\n  const startOfWeek = crmStartOfWeek();\n  const startOfMonth = crmStartOfMonth();\n  const endOfYesterday = crmEndOfYesterday();\n  const lastSeenRanges = Array.isArray(filterValues.last_seen_ranges)\n    ? (filterValues.last_seen_ranges as RangeFilter[])\n    : [];\n  const selectedServices = parseOverlapFilter(\n    filterValues[\"services_interested@ov\"],\n  );\n  const selectedTags = parseOverlapFilter(filterValues[\"tags@ov\"]);\n  const selectedManagers = parseInFilter(filterValues[\"sales_id@in\"]);\n  const hasPendingTasks =\n    typeof filterValues[\"nb_tasks@gt\"] !== \"undefined\" &&\n    filterValues[\"nb_tasks@gt\"] !== null;\n  const archivedState = filterValues.hasArchivedDeals;\n\n  const updateFilters = (changes: Record<string, unknown>) => {\n    const next = { ...filterValues, ...changes };\n    Object.entries(changes).forEach(([key, value]) => {\n      if (\n        value === undefined ||\n        value === null ||\n        (Array.isArray(value) && value.length === 0)\n      ) {\n        delete next[key];\n      }\n    });\n    setFilters(next);\n  };\n\n  const toggleLastSeenRange = (range: RangeFilter) => {\n    const isSelected = lastSeenRanges.some((item) => isEqual(item, range));\n    const nextRanges = isSelected\n      ? lastSeenRanges.filter((item) => !isEqual(item, range))\n      : [...lastSeenRanges, range];\n    updateFilters({\n      last_seen_ranges: nextRanges.length ? nextRanges : undefined,\n    });\n  };\n\n  const toggleService = (id: number) => {\n    const next = toggleValueInList(selectedServices, id);\n    updateFilters({ \"services_interested@ov\": buildOverlapFilter(next) });\n  };\n\n  const toggleTag = (id: number) => {\n    const next = toggleValueInList(selectedTags, id);\n    updateFilters({ \"tags@ov\": buildOverlapFilter(next) });\n  };\n\n  const toggleManager = (id: string | number | undefined) => {\n    if (typeof id === \"undefined\") return;\n    const next = toggleValueInList(selectedManagers, id);\n    updateFilters({ \"sales_id@in\": buildInFilter(next) });\n  };\n\n  const toggleTasks = () => {\n    if (hasPendingTasks) {\n      updateFilters({ \"nb_tasks@gt\": undefined });\n    } else {\n      updateFilters({ \"nb_tasks@gt\": 0 });\n    }\n  };\n\n  const setArchivedFilter = (value: boolean | undefined) => {\n    updateFilters({ hasArchivedDeals: value });\n  };\n\n  const clearLastSeen = () => updateFilters({ last_seen_ranges: undefined });\n  const clearServices = () =>\n    updateFilters({ \"services_interested@ov\": undefined });\n  const clearTags = () => updateFilters({ \"tags@ov\": undefined });\n  const clearManagers = () => updateFilters({ \"sales_id@in\": undefined });\n\n  return (\n    <div className=\"w-52 min-w-52 order-first pt-0.75 flex flex-col gap-4\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" placeholder=\"Search name, company...\" />\n      </FilterLiveForm>\n\n      <FilterCategory\n        label=\"Last activity\"\n        icon={<Clock />}\n        count={lastSeenRanges.length}\n        onClear={clearLastSeen}\n      >\n        <FilterOptionButton\n          label=\"Today\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              gte: endOfYesterday?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              gte: endOfYesterday?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"This week\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              gte: startOfWeek?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              gte: startOfWeek?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before this week\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: startOfWeek?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: startOfWeek?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before this month\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: startOfMonth?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: startOfMonth?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before last month\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: subMonths(startOfMonth ?? new Date(), 1).toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: subMonths(startOfMonth ?? new Date(), 1).toISOString(),\n            })\n          }\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Archive status\"\n        icon={<Archive />}\n        count={typeof archivedState === \"boolean\" ? 1 : 0}\n        onClear={() => setArchivedFilter(undefined)}\n      >\n        <FilterOptionButton\n          label=\"Unarchived\"\n          selected={archivedState === false}\n          onToggle={() =>\n            setArchivedFilter(archivedState === false ? undefined : false)\n          }\n        />\n        <FilterOptionButton\n          label=\"Archived\"\n          selected={archivedState === true}\n          onToggle={() =>\n            setArchivedFilter(archivedState === true ? undefined : true)\n          }\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Services interested in\"\n        icon={<Stethoscope />}\n        count={selectedServices.length}\n        onClear={clearServices}\n      >\n        {servicesData && servicesData.length > 0 ? (\n          servicesData.map((service) => (\n            <FilterOptionButton\n              key={service.id}\n              label={service.name}\n              selected={selectedServices.includes(String(service.id))}\n              onToggle={() => toggleService(service.id)}\n            />\n          ))\n        ) : (\n          <div className=\"text-xs text-muted-foreground\">\n            No services available\n          </div>\n        )}\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Tags\"\n        icon={<Tag />}\n        count={selectedTags.length}\n        onClear={clearTags}\n      >\n        {data &&\n          data.map((record) => (\n            <FilterOptionButton\n              key={record.id}\n              label={\n                <Badge\n                  variant=\"secondary\"\n                  className=\"text-black text-xs font-normal cursor-pointer\"\n                  style={{\n                    backgroundColor: record?.color,\n                  }}\n                >\n                  {record?.name}\n                </Badge>\n              }\n              selected={selectedTags.includes(String(record.id))}\n              onToggle={() => toggleTag(record.id)}\n            />\n          ))}\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<CheckSquare />}\n        label=\"Tasks\"\n        count={hasPendingTasks ? 1 : 0}\n        onClear={() => updateFilters({ \"nb_tasks@gt\": undefined })}\n      >\n        <FilterOptionButton\n          label={\"With pending tasks\"}\n          selected={hasPendingTasks}\n          onToggle={toggleTasks}\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<Users />}\n        label=\"Account Manager\"\n        count={selectedManagers.length}\n        onClear={clearManagers}\n      >\n        <FilterOptionButton\n          label={\"Me\"}\n          selected={selectedManagers.includes(String(identity?.id))}\n          onToggle={() => toggleManager(identity?.id)}\n        />\n        {salesData &&\n          salesData\n            .filter((manager) => manager.id !== identity?.id)\n            .map((manager) => (\n              <FilterOptionButton\n                key={manager.id}\n                label={`${manager.first_name} ${manager.last_name}`}\n                selected={selectedManagers.includes(String(manager.id))}\n                onToggle={() => toggleManager(manager.id)}\n              />\n            ))}\n      </FilterCategory>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientListContent.tsx",
      "content": "import { RecordContextProvider, useListContext } from \"ra-core\";\nimport { type MouseEvent, useCallback, useRef } from \"react\";\nimport { Link } from \"react-router\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport type { Contact } from \"../types\";\nimport { TagsList } from \"../contacts/TagsList\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { formatRelativeOrDate } from \"../misc/timezone\";\n\nexport const ClientListContent = () => {\n  const {\n    data: clients,\n    error,\n    isPending,\n    onSelect,\n    onToggleItem,\n    selectedIds,\n  } = useListContext<Contact>();\n  const isSmall = useIsMobile();\n  const lastClickedIndexRef = useRef<number | null>(null);\n\n  // StopPropagation does not work for some reason on Checkbox, this handler is a workaround\n  const handleLinkClick = useCallback(function handleLinkClick(\n    e: MouseEvent<HTMLAnchorElement>,\n  ) {\n    // Prevent navigation if clicking on checkbox or if shift key is pressed\n    if (\n      e.target instanceof HTMLButtonElement ||\n      (e.target as HTMLElement).closest('[data-slot=\"checkbox\"]') ||\n      e.shiftKey\n    ) {\n      e.preventDefault();\n    }\n  }, []);\n\n  const handleCheckboxClick = useCallback(\n    (clientId: number | string, index: number, event: MouseEvent) => {\n      event.stopPropagation();\n      event.preventDefault();\n      \n      if (event.shiftKey && lastClickedIndexRef.current !== null) {\n        // Shift-click: select range from last clicked to current\n        const start = Math.min(lastClickedIndexRef.current, index);\n        const end = Math.max(lastClickedIndexRef.current, index);\n        const rangeIds = clients\n          .slice(start, end + 1)\n          .map((client) => client.id);\n        \n        // Click would toggle the current item, so apply the *toggled* state to the whole range.\n        // Use onSelect (set selected IDs in one shot) to avoid flaky toggling/batching issues.\n        const currentIsSelected = selectedIds.includes(clientId);\n        const targetIsSelected = !currentIsSelected;\n\n        if (onSelect) {\n          const rangeSet = new Set(rangeIds);\n          const selectedSet = new Set(selectedIds);\n          if (targetIsSelected) {\n            rangeIds.forEach((id) => selectedSet.add(id));\n          } else {\n            selectedIds.forEach((id) => {\n              if (rangeSet.has(id)) selectedSet.delete(id);\n            });\n          }\n          onSelect(Array.from(selectedSet));\n        } else {\n          // Fallback (should rarely happen): toggle items to match target state\n          rangeIds.forEach((id) => {\n            const isSelected = selectedIds.includes(id);\n            if (isSelected !== targetIsSelected) {\n              onToggleItem(id);\n            }\n          });\n        }\n      } else {\n        // Normal click: toggle single item\n        onToggleItem(clientId);\n      }\n      lastClickedIndexRef.current = index;\n    },\n    [clients, onSelect, onToggleItem, selectedIds],\n  );\n\n  if (isPending) {\n    return <Skeleton className=\"w-full h-9\" />;\n  }\n\n  if (error) {\n    return null;\n  }\n  const now = Date.now();\n\n  return (\n    <div className=\"divide-y\">\n      {clients.map((client, index) => (\n        <RecordContextProvider key={client.id} value={client}>\n          <Link\n            to={`/clients/${client.id}/show`}\n            className=\"flex flex-row gap-4 items-center px-4 py-2 hover:bg-muted transition-colors first:rounded-t-xl last:rounded-b-xl\"\n            onClick={handleLinkClick}\n          >\n            <div \n              onClick={(e) => {\n                e.stopPropagation();\n                e.preventDefault();\n              }}\n            >\n              <Checkbox\n                className=\"cursor-pointer\"\n                checked={selectedIds.includes(client.id)}\n                // Use mousedown to reliably capture shiftKey with Radix checkbox\n                onMouseDown={(e) => handleCheckboxClick(client.id, index, e)}\n                // Prevent Radix default click toggling; selection is controlled by react-admin\n                onClick={(e) => {\n                  e.preventDefault();\n                  e.stopPropagation();\n                }}\n              />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"font-medium flex items-center gap-2\">\n                {`${client.first_name ?? \"\"} ${client.last_name ?? \"\"}`.trim() || \"New Lead\"}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">\n                {client.title}\n                {client.title && client.company_id != null && \" at \"}\n                {client.company_id != null && (\n                  <ReferenceField\n                    source=\"company_id\"\n                    reference=\"companies\"\n                    link={false}\n                  >\n                    <TextField source=\"name\" />\n                  </ReferenceField>\n                )}\n                {client.nb_tasks\n                  ? ` - ${client.nb_tasks} task${\n                      client.nb_tasks > 1 ? \"s\" : \"\"\n                    }`\n                  : \"\"}\n                &nbsp;&nbsp;\n                <TagsList />\n              </div>\n            </div>\n            <div className=\"text-right ml-4 flex items-center gap-2\">\n              <Badge variant=\"default\" className=\"text-xs text-white bg-emerald-600 hover:bg-emerald-700\">\n                Client\n              </Badge>\n              {client.last_seen && (\n                <div\n                  className=\"text-sm text-muted-foreground\"\n                  title={client.last_seen}\n                >\n                  {!isSmall && \"last activity \"}\n                  {formatRelativeOrDate(client.last_seen, new Date(now))}\n                </div>\n              )}\n            </div>\n          </Link>\n        </RecordContextProvider>\n      ))}\n\n      {clients.length === 0 && (\n        <div className=\"p-4\">\n          <div className=\"text-muted-foreground\">No clients found</div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientList.tsx",
      "content": "import jsonExport from \"jsonexport/dist\";\nimport {\n  downloadCSV,\n  useGetIdentity,\n  useListContext,\n  type Exporter,\n} from \"ra-core\";\nimport { BulkActionsToolbar } from \"@/components/admin/bulk-actions-toolbar\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SortButton } from \"@/components/admin/sort-button\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport type { Company, Contact, Sale, Tag } from \"../types\";\nimport { ClientEmpty } from \"./ClientEmpty\";\nimport { ClientListContent } from \"./ClientListContent\";\nimport { ClientListFilter } from \"./ClientListFilter\";\nimport { ClientArchivedList } from \"./ClientArchivedList\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\n\nexport const ClientList = () => {\n  const { identity } = useGetIdentity();\n  const [showArchived, setShowArchived] = useState(false);\n\n  if (!identity) return null;\n\n  return (\n    <List\n      title={false}\n      actions={<ClientListActions onArchivedClick={() => setShowArchived(true)} />}\n      perPage={25}\n      sort={{ field: \"last_seen\", order: \"DESC\" }}\n      exporter={exporter}\n      filter={{ isClient: true, \"archived_at@is\": null }}\n    >\n      <ClientListLayout showArchived={showArchived} setShowArchived={setShowArchived} />\n    </List>\n  );\n};\n\nconst ClientListLayout = ({ showArchived, setShowArchived }: { showArchived: boolean; setShowArchived: (open: boolean) => void }) => {\n  const { data, isPending, filterValues } = useListContext();\n  const { identity } = useGetIdentity();\n\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  if (!identity || isPending) return null;\n\n  if (!data?.length && !hasFilters) return (\n    <>\n      <ClientEmpty />\n      <ClientArchivedList open={showArchived} onOpenChange={setShowArchived} />\n    </>\n  );\n\n  return (\n    <div className=\"flex flex-row gap-8\">\n      <ClientListFilter />\n      <div className=\"w-full flex flex-col gap-4\">\n        <Card className=\"py-0\">\n          <ClientListContent />\n        </Card>\n      </div>\n      <BulkActionsToolbar />\n      <ClientArchivedList open={showArchived} onOpenChange={setShowArchived} />\n    </div>\n  );\n};\n\nconst ClientListActions = ({ onArchivedClick }: { onArchivedClick: () => void }) => (\n  <TopToolbar>\n    <SortButton fields={[\"first_name\", \"last_name\", \"last_seen\"]} />\n    <ExportButton exporter={exporter} />\n    <Button variant=\"outline\" onClick={onArchivedClick}>\n      Archived\n    </Button>\n    <CreateButton />\n  </TopToolbar>\n);\n\nconst exporter: Exporter<Contact> = async (records, fetchRelatedRecords) => {\n  const companies = await fetchRelatedRecords<Company>(\n    records,\n    \"company_id\",\n    \"companies\",\n  );\n  const sales = await fetchRelatedRecords<Sale>(records, \"sales_id\", \"sales\");\n  const tags = await fetchRelatedRecords<Tag>(records, \"tags\", \"tags\");\n\n  const clients = records.map((client) => {\n    const exportedClient = {\n      ...client,\n      company:\n        client.company_id != null\n          ? companies[client.company_id].name\n          : undefined,\n      sales: `${sales[client.sales_id].first_name} ${\n        sales[client.sales_id].last_name\n      }`,\n      tags: client.tags.map((tagId) => tags[tagId].name).join(\", \"),\n      email_work: client.email_jsonb?.find((email) => email.type === \"Work\")\n        ?.email,\n      email_home: client.email_jsonb?.find((email) => email.type === \"Home\")\n        ?.email,\n      email_other: client.email_jsonb?.find((email) => email.type === \"Other\")\n        ?.email,\n      email_jsonb: JSON.stringify(client.email_jsonb),\n      email_fts: undefined,\n      phone_work: client.phone_jsonb?.find((phone) => phone.type === \"Work\")\n        ?.number,\n      phone_home: client.phone_jsonb?.find((phone) => phone.type === \"Home\")\n        ?.number,\n      phone_other: client.phone_jsonb?.find((phone) => phone.type === \"Other\")\n        ?.number,\n      phone_jsonb: JSON.stringify(client.phone_jsonb),\n      phone_fts: undefined,\n    };\n    delete exportedClient.email_fts;\n    delete exportedClient.phone_fts;\n    return exportedClient;\n  });\n  return jsonExport(clients, {}, (_err: any, csv: string) => {\n    downloadCSV(csv, \"clients\");\n  });\n};\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientEmpty.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\n\nexport const ClientEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-3\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No clients found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h6 className=\"text-lg font-bold\">No clients found</h6>\n        <p className=\"text-sm text-muted-foreground text-center mb-4\">\n          It seems your client list is empty.\n        </p>\n      </div>\n      <div className=\"flex flex-row gap-2\">\n        <CreateButton label=\"New Client\" />\n      </div>\n    </div>\n  );\n};\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientEdit.tsx",
      "content": "import { EditBase, Form, useEditContext } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport type { Contact } from \"../types\";\nimport { ClientAside } from \"./ClientAside\";\nimport { LeadInputs } from \"../contacts/LeadInputs\";\n\nexport const ClientEdit = () => (\n  <EditBase\n    redirect=\"show\"\n    transform={(data: Contact) => {\n      // Split full name back into first_name and last_name before saving\n      if (data.first_name) {\n        const parts = data.first_name.trim().split(/\\s+/);\n        data.first_name = parts[0] || \"\";\n        data.last_name = parts.slice(1).join(\" \") || \"\";\n      }\n      return data;\n    }}\n  >\n    <ClientEditContent />\n  </EditBase>\n);\n\nconst ClientEditContent = () => {\n  const { isPending, record } = useEditContext<Contact>();\n  if (isPending || !record) return null;\n  \n  // Combine first_name and last_name for the form's default value\n  const fullName = record.first_name && record.last_name\n    ? `${record.first_name} ${record.last_name}`.trim()\n    : record.first_name || \"\";\n  \n  return (\n    <div className=\"mt-2 flex justify-center\">\n      <div className=\"w-[90%] max-w-6xl flex gap-8\">\n        <div className=\"flex-1\">\n          <Form \n            className=\"flex flex-1 flex-col gap-6\"\n            defaultValues={{\n              ...record,\n              first_name: fullName,\n            }}\n          >\n            <LeadInputs />\n            <div className=\"flex justify-end pt-4 border-t\">\n              <FormToolbar />\n            </div>\n          </Form>\n        </div>\n        <ClientAside link=\"show\" />\n      </div>\n    </div>\n  );\n};\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientCreate.tsx",
      "content": "import { CreateBase, Form, useDataProvider, useGetIdentity, useNotify } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport type { Contact } from \"../types\";\nimport { createLeadJourneyDealForContact } from \"../deals/createLeadJourneyDeal\";\nimport { LeadInputs } from \"../contacts/LeadInputs\";\n\nexport const ClientCreate = () => {\n  const { identity } = useGetIdentity();\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n\n  const handleSuccess = async (data: Contact) => {\n    if (!data?.id) {\n      console.error(\"ClientCreate: Missing contact ID\", data);\n      return;\n    }\n    try {\n      await createLeadJourneyDealForContact(dataProvider, data, identity?.id);\n    } catch (error) {\n      notify(\"Client created but could not add to journey\", { type: \"warning\" });\n      console.error(\"ClientCreate: lead-journey create failed\", error);\n    }\n  };\n  return (\n    <CreateBase\n      redirect=\"show\"\n      transform={(data: Contact) => ({\n        ...data,\n        first_seen: new Date().toISOString(),\n        last_seen: new Date().toISOString(),\n        tags: [],\n        services_interested: data.services_interested || [],\n      })}\n      mutationOptions={{\n        onSuccess: (response) => {\n          // Handle both response.data (react-admin structure) and direct data\n          const contact = ((response as any)?.data ?? response) as Contact | undefined;\n          if (!contact || !contact.id) {\n            console.warn(\"ClientCreate: Invalid response structure\", response);\n            return;\n          }\n          handleSuccess(contact);\n        },\n      }}\n    >\n      <div className=\"mt-2 flex justify-center\">\n        <div className=\"w-[90%] max-w-6xl\">\n          <Form \n            className=\"flex flex-col gap-6\"\n            defaultValues={{ \n              sales_id: identity?.id,\n              phone_has_whatsapp: false,\n              services_interested: [],\n            }}\n          >\n            <LeadInputs />\n            <div className=\"flex justify-end pt-4 border-t\">\n              <FormToolbar />\n            </div>\n          </Form>\n        </div>\n      </div>\n    </CreateBase>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientAside.tsx",
      "content": "import { Linkedin, Mail, Phone } from \"lucide-react\";\nimport { useRecordContext, WithRecord } from \"ra-core\";\nimport type { ReactNode } from \"react\";\nimport { ArrayField } from \"@/components/admin/array-field\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { DeleteButton } from \"@/components/admin\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { EmailField } from \"@/components/admin/email-field\";\n\nimport { TagsListEdit } from \"../contacts/TagsListEdit\";\nimport { ServicesListEdit } from \"../contacts/ServicesListEdit\";\nimport { AccountManagerEdit } from \"../contacts/AccountManagerEdit\";\nimport { AsideSection } from \"../misc/AsideSection\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Contact } from \"../types\";\nimport { ContactMergeButton } from \"../contacts/ContactMergeButton\";\nimport { ExportVCardButton } from \"../contacts/ExportVCardButton\";\n\nexport const ClientAside = ({ link = \"edit\" }: { link?: \"edit\" | \"show\" }) => {\n  const { contactGender } = useConfigurationContext();\n  const record = useRecordContext<Contact>();\n\n  if (!record) return null;\n  return (\n    <div className=\"hidden sm:block w-64 min-w-64 text-sm\">\n      <div className=\"mb-4 -ml-1\">\n        {link === \"edit\" ? (\n          <EditButton label=\"Edit Client\" />\n        ) : (\n          <ShowButton label=\"Show Client\" />\n        )}\n      </div>\n\n      <AsideSection title=\"Personal info\">\n        <ArrayField source=\"email_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Mail className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<EmailField source=\"email\" />}\n            />\n          </SingleFieldList>\n        </ArrayField>\n\n        {record.has_newsletter && (\n          <p className=\"pl-6 text-sm text-muted-foreground\">\n            Subscribed to newsletter\n          </p>\n        )}\n\n        {record.linkedin_url && (\n          <PersonalInfoRow\n            icon={<Linkedin className=\"w-4 h-4 text-muted-foreground\" />}\n            primary={\n              <a\n                className=\"underline hover:no-underline text-sm text-muted-foreground\"\n                href={record.linkedin_url}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                title={record.linkedin_url}\n              >\n                LinkedIn\n              </a>\n            }\n          />\n        )}\n        <ArrayField source=\"phone_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Phone className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<TextField source=\"number\" />}\n              showType\n            />\n          </SingleFieldList>\n        </ArrayField>\n        {contactGender\n          .map((genderOption) => {\n            if (record.gender === genderOption.value) {\n              return (\n                <PersonalInfoRow\n                  key={genderOption.value}\n                  primary={<span>{genderOption.label}</span>}\n                />\n              );\n            }\n            return null;\n          })\n          .filter(Boolean)}\n      </AsideSection>\n      <AsideSection title=\"Account Manager\">\n        <AccountManagerEdit />\n      </AsideSection>\n\n      <AsideSection title=\"Services interested in\">\n        <ServicesListEdit />\n      </AsideSection>\n\n      <AsideSection title=\"Tags\">\n        <TagsListEdit />\n      </AsideSection>\n\n      {link !== \"edit\" && (\n        <>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <ExportVCardButton />\n            <ContactMergeButton />\n          </div>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <DeleteButton\n              className=\"h-6 cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\"\n              size=\"sm\"\n            />\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nconst PersonalInfoRow = ({\n  icon,\n  primary,\n  showType,\n}: {\n  icon?: ReactNode;\n  primary: ReactNode;\n  showType?: boolean;\n}) => (\n  <div className=\"flex flex-row items-center gap-2 min-h-6\">\n    {icon && icon}\n    <div className=\"flex flex-wrap gap-x-2 gap-y-0\">\n      {primary}\n      {showType ? (\n        <WithRecord\n          render={(row) =>\n            row.type !== \"Other\" && (\n              <TextField source=\"type\" className=\"text-muted-foreground\" />\n            )\n          }\n        />\n      ) : null}\n    </div>\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientArchivedList.tsx",
      "content": "/* eslint-disable react-refresh/only-export-components */\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { useEffect, useState, useMemo } from \"react\";\nimport { useRedirect } from \"ra-core\";\nimport { Dialog, DialogContent, DialogDescription, DialogTitle } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Search } from \"lucide-react\";\n\nimport type { Contact } from \"../types\";\nimport { formatCrmDate } from \"../misc/timezone\";\n\ninterface ClientArchivedListProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport const ClientArchivedList = ({ open, onOpenChange }: ClientArchivedListProps) => {\n  const { identity } = useGetIdentity();\n  const {\n    data: archivedClients,\n    total,\n    isPending,\n  } = useGetList<Contact>(\"contacts\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"archived_at\", order: \"DESC\" },\n    filter: { \n      \"archived_at@not.is\": null,\n      isClient: true \n    },\n  });\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  useEffect(() => {\n    if (!isPending && total === 0) {\n      onOpenChange(false);\n    }\n  }, [isPending, total, onOpenChange]);\n\n  // Filter clients by search query\n  const filteredClients = useMemo(() => {\n    if (!archivedClients || !searchQuery.trim()) return archivedClients || [];\n    \n    const query = searchQuery.toLowerCase();\n    return archivedClients.filter((client: Contact) => {\n      const firstName = client.first_name?.toLowerCase() || \"\";\n      const lastName = client.last_name?.toLowerCase() || \"\";\n      const fullName = `${firstName} ${lastName}`.trim().toLowerCase();\n      const title = client.title?.toLowerCase() || \"\";\n      const companyName = client.company_name?.toLowerCase() || \"\";\n      return fullName.includes(query) || title.includes(query) || companyName.includes(query);\n    });\n  }, [archivedClients, searchQuery]);\n\n  // Group filtered archived clients by date\n  const archivedClientsByDate: { [date: string]: Contact[] } = useMemo(() => {\n    if (!filteredClients || filteredClients.length === 0) return {};\n    return filteredClients.reduce(\n      (acc, client) => {\n        const date = client.archived_at ? new Date(client.archived_at).toDateString() : \"Unknown\";\n        if (!acc[date]) {\n          acc[date] = [];\n        }\n        acc[date].push(client);\n        return acc;\n      },\n      {} as { [date: string]: Contact[] },\n    );\n  }, [filteredClients]);\n\n  if (!identity || isPending || !total || !archivedClients) return null;\n\n  return (\n    <div className=\"w-full flex flex-row items-center justify-center\">\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n          <DialogTitle>Archived Clients</DialogTitle>\n          <DialogDescription>\n            View and search through archived clients\n          </DialogDescription>\n          <div className=\"flex flex-col gap-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4\" />\n              <Input\n                type=\"text\"\n                placeholder=\"Search archived clients...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n              />\n            </div>\n            {Object.keys(archivedClientsByDate).length === 0 ? (\n              <div className=\"text-center text-muted-foreground py-8\">\n                No archived clients found\n              </div>\n            ) : (\n              <div className=\"flex flex-col gap-8\">\n                {Object.entries(archivedClientsByDate).map(([date, clients]) => (\n                  <div key={date} className=\"flex flex-col gap-4\">\n                    <h4 className=\"font-bold\">{getRelativeTimeString(date)}</h4>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8\">\n                      {clients.map((client: Contact) => (\n                        <div key={client.id}>\n                          <ArchivedClientCard client={client} />\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n};\n\nexport function getRelativeTimeString(dateString: string): string {\n  // Handle \"Unknown\" or invalid date strings\n  if (dateString === \"Unknown\" || !dateString) {\n    return \"Unknown\";\n  }\n\n  const date = new Date(dateString);\n  \n  // Check if date is invalid\n  if (isNaN(date.getTime())) {\n    return dateString; // Return the original string if date is invalid\n  }\n\n  date.setHours(0, 0, 0, 0);\n\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const diff = date.getTime() - today.getTime();\n  const unitDiff = Math.round(diff / (1000 * 60 * 60 * 24));\n\n  // Check if unitDiff is not a finite number\n  if (!isFinite(unitDiff)) {\n    return formatCrmDate(date);\n  }\n\n  // Check if the date is more than one week old\n  if (Math.abs(unitDiff) > 7) {\n    return formatCrmDate(date);\n  }\n\n  // Intl.RelativeTimeFormat for dates within the last week\n  const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: \"auto\" });\n  return ucFirst(rtf.format(unitDiff, \"day\"));\n}\n\nfunction ucFirst(str: string): string {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nconst ArchivedClientCard = ({ client }: { client: Contact }) => {\n  const redirect = useRedirect();\n  \n  const archivedDate = client.archived_at ? formatCrmDate(client.archived_at) : null;\n  \n  const handleClick = () => {\n    redirect(`/clients/${client.id}/show`, undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  return (\n    <div\n      className=\"cursor-pointer\"\n      onClick={handleClick}\n    >\n      <Card className=\"py-4 transition-all duration-200 shadow-sm hover:shadow-md\">\n        <CardContent className=\"px-4 flex\">\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-medium mb-1\">\n              {`${client.first_name || \"\"} ${client.last_name || \"\"}`.trim() || \"New Client\"}\n            </p>\n            {client.title && (\n              <p className=\"text-xs text-muted-foreground\">\n                {client.title}\n                {client.company_name && ` at ${client.company_name}`}\n              </p>\n            )}\n            {archivedDate && (\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Archived {archivedDate}\n              </p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/bug-reports/index.ts",
      "content": "export { BugReportPage } from \"./BugReportPage\";\nexport { BugReportsPage } from \"./BugReportsPage\";\nexport { BugReportList } from \"./BugReportList\";\nexport { BugReportShow } from \"./BugReportShow\";\n\nimport { BugReportsPage } from \"./BugReportsPage\";\nimport { BugReportShow } from \"./BugReportShow\";\nimport { Bug } from \"lucide-react\";\nimport type { BugReport } from \"../types\";\n\nexport default {\n  list: BugReportsPage,\n  show: BugReportShow,\n  icon: Bug,\n  recordRepresentation: (record: BugReport) => {\n    return record.title || `Bug Report #${record.id}`;\n  },\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/bug-reports/BugReportsPage.tsx",
      "content": "import { List } from \"@/components/admin/list\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { BugReportList } from \"./BugReportList\";\n\nconst filters = [\n  <SearchInput key=\"search\" source=\"q\" placeholder=\"Search bug reports...\" />,\n  <SelectInput\n    key=\"status-filter\"\n    source=\"status\"\n    label=\"Status\"\n    choices={[\n      { id: \"open\", name: \"Open\" },\n      { id: \"in_progress\", name: \"In Progress\" },\n      { id: \"resolved\", name: \"Resolved\" },\n      { id: \"closed\", name: \"Closed\" },\n    ]}\n  />,\n  <SelectInput\n    key=\"priority-filter\"\n    source=\"priority\"\n    label=\"Priority\"\n    choices={[\n      { id: \"low\", name: \"Low\" },\n      { id: \"medium\", name: \"Medium\" },\n      { id: \"high\", name: \"High\" },\n      { id: \"critical\", name: \"Critical\" },\n    ]}\n  />,\n];\n\nexport const BugReportsPage = () => {\n  return (\n    <List filters={filters}>\n      <BugReportList />\n    </List>\n  );\n};\n\nBugReportsPage.path = \"/bug-reports-list\";\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/bug-reports/BugReportShow.tsx",
      "content": "import { ShowBase, useShowContext } from \"ra-core\";\nimport { Show } from \"@/components/admin/show\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport type { BugReport } from \"../types\";\nimport { Image } from \"lucide-react\";\n\nexport const BugReportShow = () => (\n  <ShowBase>\n    <BugReportShowContent />\n  </ShowBase>\n);\n\nconst BugReportShowContent = () => {\n  const { record, isPending } = useShowContext<BugReport>();\n\n  if (isPending || !record) {\n    return null;\n  }\n\n  const statusColors = {\n    open: \"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300\",\n    in_progress: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300\",\n    resolved: \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300\",\n    closed: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n  };\n\n  const priorityColors = {\n    low: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n    medium: \"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300\",\n    high: \"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300\",\n    critical: \"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300\",\n  };\n\n  return (\n    <Show>\n      <div className=\"space-y-6\">\n        {/* Header Info */}\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-start justify-between\">\n              <div className=\"flex-1\">\n                <CardTitle className=\"text-2xl mb-2\">{record.title}</CardTitle>\n                <div className=\"flex items-center gap-3 flex-wrap\">\n                  <Badge className={statusColors[record.status] || statusColors.open}>\n                    {record.status}\n                  </Badge>\n                  <Badge className={priorityColors[record.priority] || priorityColors.medium}>\n                    {record.priority}\n                  </Badge>\n                </div>\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <label className=\"text-sm font-medium text-muted-foreground\">Reported By</label>\n                <div className=\"mt-1\">\n                  <ReferenceField source=\"reported_by\" reference=\"sales\" />\n                </div>\n              </div>\n              <div>\n                <label className=\"text-sm font-medium text-muted-foreground\">Created At</label>\n                <div className=\"mt-1\">\n                  <DateField source=\"created_at\" showTime />\n                </div>\n              </div>\n              <div>\n                <label className=\"text-sm font-medium text-muted-foreground\">Updated At</label>\n                <div className=\"mt-1\">\n                  <DateField source=\"updated_at\" showTime />\n                </div>\n              </div>\n              {record.url && (\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">URL</label>\n                  <div className=\"mt-1\">\n                    <a\n                      href={record.url}\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                      className=\"text-blue-600 dark:text-blue-400 hover:underline text-sm break-all\"\n                    >\n                      {record.url}\n                    </a>\n                  </div>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Description */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Description</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <TextField source=\"description\" className=\"whitespace-pre-wrap\" />\n          </CardContent>\n        </Card>\n\n        {/* Steps to Reproduce */}\n        {record.steps_to_reproduce && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Steps to Reproduce</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"whitespace-pre-wrap text-sm\">\n                {record.steps_to_reproduce}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Screenshots */}\n        {record.screenshot_urls && record.screenshot_urls.length > 0 && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Image className=\"w-5 h-5\" />\n                Screenshots ({record.screenshot_urls.length})\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\n                {record.screenshot_urls.map((url, index) => (\n                  <div key={index} className=\"relative group\">\n                    <a\n                      href={url}\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                      className=\"block\"\n                    >\n                      <img\n                        src={url}\n                        alt={`Screenshot ${index + 1}`}\n                        className=\"w-full h-48 object-cover rounded-lg border border-slate-200 dark:border-slate-700 hover:border-blue-500 dark:hover:border-blue-400 transition-colors cursor-pointer\"\n                      />\n                    </a>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Technical Info */}\n        {(record.browser_info || record.device_info) && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Technical Information</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              {record.browser_info && (\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Browser</label>\n                  <div className=\"mt-1 text-sm\">{record.browser_info}</div>\n                </div>\n              )}\n              {record.device_info && (\n                <div>\n                  <label className=\"text-sm font-medium text-muted-foreground\">Device</label>\n                  <div className=\"mt-1 text-sm\">{record.device_info}</div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    </Show>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/bug-reports/BugReportPage.tsx",
      "content": "import React, { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { useCreate, useGetIdentity, useNotify, useGetList } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { supabase } from \"../providers/supabase/supabase\";\nimport { Upload, X, Image as ImageIcon, CheckCircle2, Bug, List } from \"lucide-react\";\nimport { BugReportList } from \"./BugReportList\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { List as ListComponent } from \"@/components/admin/list\";\nimport type { BugReport } from \"../types\";\n\ntype BugReportFormData = {\n  title: string;\n  description: string;\n  steps_to_reproduce: string;\n  priority: \"low\" | \"medium\" | \"high\" | \"critical\";\n  screenshot_urls: string[];\n};\n\nconst filters = [\n  <SearchInput key=\"search\" source=\"q\" placeholder=\"Search bug reports...\" />,\n  <SelectInput\n    key=\"status-filter\"\n    source=\"status\"\n    label=\"Status\"\n    choices={[\n      { id: \"open\", name: \"Open\" },\n      { id: \"in_progress\", name: \"In Progress\" },\n      { id: \"resolved\", name: \"Resolved\" },\n      { id: \"closed\", name: \"Closed\" },\n    ]}\n  />,\n  <SelectInput\n    key=\"priority-filter\"\n    source=\"priority\"\n    label=\"Priority\"\n    choices={[\n      { id: \"low\", name: \"Low\" },\n      { id: \"medium\", name: \"Medium\" },\n      { id: \"high\", name: \"High\" },\n      { id: \"critical\", name: \"Critical\" },\n    ]}\n  />,\n];\n\nconst BugReportForm = ({ onSuccess }: { onSuccess?: () => void }) => {\n  const { identity } = useGetIdentity();\n  const [create] = useCreate();\n  const notify = useNotify();\n  const [screenshots, setScreenshots] = useState<File[]>([]);\n  const [uploading, setUploading] = useState(false);\n  const [submitted, setSubmitted] = useState(false);\n\n  const {\n    register,\n    handleSubmit,\n    setValue,\n    watch,\n    formState: { errors },\n    reset,\n  } = useForm<BugReportFormData>({\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      steps_to_reproduce: \"\",\n      priority: \"medium\",\n      screenshot_urls: [],\n    },\n  });\n\n  const priority = watch(\"priority\");\n\n  const handleScreenshotUpload = async (files: FileList | null) => {\n    if (!files || files.length === 0) return;\n\n    const imageFiles = Array.from(files).filter((f) => f.type.startsWith(\"image/\"));\n    if (imageFiles.length === 0) {\n      notify(\"Please select image files only\", { type: \"error\" });\n      return;\n    }\n\n    if (screenshots.length + imageFiles.length > 5) {\n      notify(\"Maximum 5 screenshots allowed\", { type: \"error\" });\n      return;\n    }\n\n    setScreenshots((prev) => [...prev, ...imageFiles]);\n  };\n\n  const removeScreenshot = (index: number) => {\n    setScreenshots((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  const uploadScreenshots = async (): Promise<string[]> => {\n    if (screenshots.length === 0) return [];\n\n    const uploadedUrls: string[] = [];\n\n    for (const file of screenshots) {\n      const ext = file.name.split(\".\").pop() || \"png\";\n      const base = `${Date.now()}-${Math.random().toString(16).slice(2)}`;\n      const path = `bug-reports/${base}.${ext}`;\n\n      const { error: uploadError } = await supabase.storage\n        .from(\"attachments\")\n        .upload(path, file, {\n          contentType: file.type || undefined,\n          upsert: false,\n        });\n\n      if (uploadError) {\n        throw new Error(`Failed to upload ${file.name}: ${uploadError.message}`);\n      }\n\n      const { data } = supabase.storage.from(\"attachments\").getPublicUrl(path);\n      uploadedUrls.push(data.publicUrl);\n    }\n\n    return uploadedUrls;\n  };\n\n  const onSubmit = async (data: BugReportFormData) => {\n    if (!identity?.id) {\n      notify(\"Please log in to submit a bug report\", { type: \"error\" });\n      return;\n    }\n\n    setUploading(true);\n    try {\n      // Upload screenshots first\n      const screenshotUrls = await uploadScreenshots();\n\n      // Get browser and device info\n      const browserInfo = `${navigator.userAgent}`;\n      const deviceInfo = `${window.screen.width}x${window.screen.height}`;\n      const url = window.location.href;\n\n      // Create bug report\n      await create(\n        \"bug_reports\",\n        {\n          data: {\n            reported_by: identity.id,\n            title: data.title,\n            description: data.description,\n            steps_to_reproduce: data.steps_to_reproduce || null,\n            screenshot_urls: screenshotUrls,\n            priority: data.priority,\n            status: \"open\",\n            browser_info: browserInfo,\n            device_info: deviceInfo,\n            url: url,\n          },\n        },\n        {\n          onSuccess: () => {\n            notify(\"Bug report submitted successfully! Thank you for your feedback.\", {\n              type: \"success\",\n            });\n            setSubmitted(true);\n            reset();\n            setScreenshots([]);\n            // Call onSuccess callback to refresh list and switch tabs\n            if (onSuccess) {\n              setTimeout(() => {\n                onSuccess();\n                setSubmitted(false);\n              }, 2000);\n            } else {\n              setTimeout(() => setSubmitted(false), 5000);\n            }\n          },\n          onError: (error: unknown) => {\n            const errorMessage =\n              error instanceof Error\n                ? error.message\n                : \"Failed to submit bug report. Please try again.\";\n            notify(errorMessage, { type: \"error\" });\n          },\n        }\n      );\n    } catch (error) {\n      const errorMessage =\n        error instanceof Error\n          ? error.message\n          : \"Failed to upload screenshots. Please try again.\";\n      notify(errorMessage, { type: \"error\" });\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  if (submitted) {\n    return (\n      <Card className=\"border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950/20\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex flex-col items-center justify-center py-12\">\n            <CheckCircle2 className=\"w-16 h-16 text-green-600 dark:text-green-400 mb-4\" />\n            <h2 className=\"text-2xl font-bold text-green-900 dark:text-green-100 mb-2\">\n              Bug Report Submitted!\n            </h2>\n            <p className=\"text-green-700 dark:text-green-300 text-center\">\n              Thank you for reporting this issue. Our team will review it and get back to you soon.\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-2xl font-bold\">Report a Bug</CardTitle>\n        <CardDescription>\n          Help us improve by reporting any issues you encounter. Please provide as much detail as\n          possible.\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n          <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n            {/* Title */}\n            <div>\n              <Label htmlFor=\"title\" className=\"text-sm font-medium mb-1.5 block\">\n                Title <span className=\"text-red-500\">*</span>\n              </Label>\n              <Input\n                id=\"title\"\n                {...register(\"title\", { required: \"Title is required\" })}\n                placeholder=\"Brief description of the bug\"\n                className=\"h-10\"\n              />\n              {errors.title && (\n                <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">\n                  {errors.title.message}\n                </p>\n              )}\n            </div>\n\n            {/* Description */}\n            <div>\n              <Label htmlFor=\"description\" className=\"text-sm font-medium mb-1.5 block\">\n                Description <span className=\"text-red-500\">*</span>\n              </Label>\n              <Textarea\n                id=\"description\"\n                {...register(\"description\", { required: \"Description is required\" })}\n                placeholder=\"Describe what happened and what you expected to happen\"\n                rows={5}\n                className=\"resize-none\"\n              />\n              {errors.description && (\n                <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">\n                  {errors.description.message}\n                </p>\n              )}\n            </div>\n\n            {/* Steps to Reproduce */}\n            <div>\n              <Label htmlFor=\"steps_to_reproduce\" className=\"text-sm font-medium mb-1.5 block\">\n                Steps to Reproduce\n              </Label>\n              <Textarea\n                id=\"steps_to_reproduce\"\n                {...register(\"steps_to_reproduce\")}\n                placeholder=\"1. Go to...&#10;2. Click on...&#10;3. See error...\"\n                rows={5}\n                className=\"resize-none\"\n              />\n              <p className=\"text-xs text-slate-500 dark:text-slate-400 mt-1\">\n                Help us reproduce the issue by listing the steps you took\n              </p>\n            </div>\n\n            {/* Priority */}\n            <div>\n              <Label htmlFor=\"priority\" className=\"text-sm font-medium mb-1.5 block\">\n                Priority\n              </Label>\n              <Select\n                value={priority}\n                onValueChange={(value) => setValue(\"priority\", value as any)}\n              >\n                <SelectTrigger className=\"h-10\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"low\">Low - Minor issue, doesn't affect functionality</SelectItem>\n                  <SelectItem value=\"medium\">Medium - Some impact on usability</SelectItem>\n                  <SelectItem value=\"high\">High - Significant impact on functionality</SelectItem>\n                  <SelectItem value=\"critical\">Critical - Blocks core functionality</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Screenshots */}\n            <div>\n              <Label className=\"text-sm font-medium mb-1.5 block\">\n                Screenshots (Optional)\n              </Label>\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center gap-2\">\n                  <label\n                    htmlFor=\"screenshot-upload\"\n                    className=\"flex items-center gap-2 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors\"\n                  >\n                    <Upload className=\"w-4 h-4\" />\n                    <span className=\"text-sm\">Upload Screenshots</span>\n                  </label>\n                  <input\n                    id=\"screenshot-upload\"\n                    type=\"file\"\n                    accept=\"image/*\"\n                    multiple\n                    className=\"hidden\"\n                    onChange={(e) => handleScreenshotUpload(e.target.files)}\n                    disabled={screenshots.length >= 5}\n                  />\n                  <span className=\"text-xs text-slate-500 dark:text-slate-400\">\n                    {screenshots.length}/5 images\n                  </span>\n                </div>\n\n                {screenshots.length > 0 && (\n                  <div className=\"grid grid-cols-2 md:grid-cols-3 gap-3\">\n                    {screenshots.map((file, index) => (\n                      <div\n                        key={index}\n                        className=\"relative group border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden\"\n                      >\n                        <img\n                          src={URL.createObjectURL(file)}\n                          alt={`Screenshot ${index + 1}`}\n                          className=\"w-full h-32 object-cover\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => removeScreenshot(index)}\n                          className=\"absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity\"\n                        >\n                          <X className=\"w-4 h-4\" />\n                        </button>\n                        <div className=\"p-2 bg-slate-50 dark:bg-slate-800\">\n                          <p className=\"text-xs text-slate-600 dark:text-slate-400 truncate\">\n                            {file.name}\n                          </p>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n              <p className=\"text-xs text-slate-500 dark:text-slate-400 mt-1\">\n                Upload up to 5 screenshots to help us understand the issue better\n              </p>\n            </div>\n\n            {/* Submit Button */}\n            <div className=\"flex justify-end gap-3 pt-4 border-t border-slate-200 dark:border-slate-700\">\n              <Button\n                type=\"submit\"\n                disabled={uploading}\n                className=\"px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl shadow-lg shadow-blue-500/25 hover:shadow-xl hover:shadow-blue-500/30 transition-all duration-200 font-medium disabled:opacity-50\"\n              >\n                {uploading ? (\n                  <span className=\"flex items-center gap-2\">\n                    <svg\n                      className=\"animate-spin h-4 w-4\"\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                    >\n                      <circle\n                        className=\"opacity-25\"\n                        cx=\"12\"\n                        cy=\"12\"\n                        r=\"10\"\n                        stroke=\"currentColor\"\n                        strokeWidth=\"4\"\n                      ></circle>\n                      <path\n                        className=\"opacity-75\"\n                        fill=\"currentColor\"\n                        d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n                      ></path>\n                    </svg>\n                    Submitting...\n                  </span>\n                ) : (\n                  \"Submit Bug Report\"\n                )}\n              </Button>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n    );\n};\n\nexport const BugReportPage = () => {\n  const { identity } = useGetIdentity();\n  const [activeTab, setActiveTab] = useState(\"submit\");\n  const { data: bugReports, isLoading, refetch } = useGetList<BugReport>(\"bug_reports\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n    // Show all bug reports, not just user's own\n  });\n\n  const handleFormSuccess = () => {\n    refetch();\n    setActiveTab(\"view\");\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-6xl\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold mb-2\">Bug Reports</h1>\n        <p className=\"text-muted-foreground\">\n          Report bugs or view all submitted bug reports\n        </p>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-2\">\n          <TabsTrigger value=\"submit\" className=\"flex items-center gap-2\">\n            <Bug className=\"w-4 h-4\" />\n            Report a Bug\n          </TabsTrigger>\n          <TabsTrigger value=\"view\" className=\"flex items-center gap-2\">\n            <List className=\"w-4 h-4\" />\n            All Bug Reports ({bugReports?.length || 0})\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"submit\" className=\"mt-6\">\n          <BugReportForm onSuccess={handleFormSuccess} />\n        </TabsContent>\n\n        <TabsContent value=\"view\" className=\"mt-6\">\n          <ListComponent resource=\"bug_reports\" filters={filters}>\n            <BugReportList />\n          </ListComponent>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n};\n\nBugReportPage.path = \"/bug-reports\";\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/bug-reports/BugReportList.tsx",
      "content": "import { DataTable } from \"@/components/admin/data-table\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { WithRecord, useUpdate, useNotify } from \"ra-core\";\nimport { CheckCircle2 } from \"lucide-react\";\nimport type { BugReport } from \"../types\";\n\nconst StatusBadge = ({ record }: { record: BugReport }) => {\n  if (!record) return null;\n  \n  const statusColors = {\n    open: \"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300\",\n    in_progress: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300\",\n    resolved: \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300\",\n    closed: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n  };\n\n  return (\n    <Badge className={statusColors[record.status] || statusColors.open}>\n      {record.status}\n    </Badge>\n  );\n};\n\nconst PriorityBadge = ({ record }: { record: BugReport }) => {\n  if (!record) return null;\n  \n  const priorityColors = {\n    low: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n    medium: \"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300\",\n    high: \"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300\",\n    critical: \"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300\",\n  };\n\n  return (\n    <Badge className={priorityColors[record.priority] || priorityColors.medium}>\n      {record.priority}\n    </Badge>\n  );\n};\n\nconst MarkAsFixedButton = ({ record }: { record: BugReport }) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n\n  const handleMarkAsFixed = async () => {\n    try {\n      await update(\n        \"bug_reports\",\n        {\n          id: record.id,\n          data: {\n            status: \"resolved\",\n          },\n          previousData: record,\n        },\n        {\n          onSuccess: () => {\n            notify(\"Bug report marked as resolved\", { type: \"success\" });\n          },\n          onError: (error: unknown) => {\n            const errorMessage =\n              error instanceof Error\n                ? error.message\n                : \"Failed to update bug report\";\n            notify(errorMessage, { type: \"error\" });\n          },\n        }\n      );\n    } catch (error) {\n      notify(\"Failed to mark as fixed\", { type: \"error\" });\n    }\n  };\n\n  return (\n    <Button\n      size=\"sm\"\n      variant=\"outline\"\n      onClick={handleMarkAsFixed}\n      className=\"h-8 text-xs\"\n    >\n      <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n      Mark Fixed\n    </Button>\n  );\n};\n\nexport const BugReportList = () => {\n  return (\n    <DataTable>\n      <DataTable.Col\n        source=\"id\"\n        label=\"ID\"\n        sortable\n      />\n      <DataTable.Col\n        source=\"title\"\n        label=\"Title\"\n        sortable\n      />\n      <DataTable.Col\n        source=\"reported_by\"\n        label=\"Reported By\"\n        sortable\n      >\n        <ReferenceField source=\"reported_by\" reference=\"sales\" />\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"status\"\n        label=\"Status\"\n        sortable\n      >\n        <WithRecord render={(record) => <StatusBadge record={record} />} />\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"priority\"\n        label=\"Priority\"\n        sortable\n      >\n        <WithRecord render={(record) => <PriorityBadge record={record} />} />\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"created_at\"\n        label=\"Created\"\n        sortable\n      >\n        <DateField showTime />\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"updated_at\"\n        label=\"Updated\"\n        sortable\n      >\n        <DateField showTime />\n      </DataTable.Col>\n      <DataTable.Col\n        source=\"actions\"\n        label=\"Actions\"\n      >\n        <WithRecord\n          render={(record) => (\n            <div className=\"flex items-center gap-2\">\n              <ShowButton />\n              {record.status !== \"resolved\" && record.status !== \"closed\" && (\n                <MarkAsFixedButton record={record} />\n              )}\n            </div>\n          )}\n        />\n      </DataTable.Col>\n    </DataTable>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/useAppointmentTypes.ts",
      "content": "import { useMemo } from \"react\";\nimport { useGetList } from \"ra-core\";\nimport type { Service } from \"../types\";\nimport type { AppointmentTypeConfig } from \"./types\";\n\n// Default color palette for services\nconst DEFAULT_COLORS = [\n  \"#3b82f6\", // blue\n  \"#a855f7\", // purple\n  \"#10b981\", // green\n  \"#f97316\", // orange\n  \"#ec4899\", // pink\n  \"#ef4444\", // red\n  \"#06b6d4\", // cyan\n  \"#f59e0b\", // amber\n  \"#8b5cf6\", // violet\n  \"#14b8a6\", // teal\n];\n\n// Map service names to colors for consistency\nconst SERVICE_COLOR_MAP: Record<string, string> = {\n  \"doctor on call\": \"#3b82f6\",\n  \"lab test\": \"#a855f7\",\n  \"teleconsultation\": \"#10b981\",\n  \"physiotherapy\": \"#f97316\",\n  \"caregiver\": \"#ec4899\",\n  \"iv therapy\": \"#ef4444\",\n  \"nurse on call\": \"#06b6d4\",\n  \"blood test\": \"#8b5cf6\",\n  \"nanny\": \"#14b8a6\",\n  \"elderly care\": \"#f59e0b\",\n};\n\n// Map service names to allowed appointment_type constraint values\n// These are the only values allowed by the database constraint\nconst SERVICE_TO_APPOINTMENT_TYPE_MAP: Record<string, string> = {\n  \"doctor on call\": \"doctor_on_call\",\n  \"nurse on call\": \"doctor_on_call\", // Map to doctor_on_call as closest match\n  \"lab test\": \"lab_test\",\n  \"blood test\": \"lab_test\", // Map to lab_test\n  \"teleconsultation\": \"teleconsultation\",\n  \"physiotherapy\": \"physiotherapy\",\n  \"caregiver\": \"caregiver\",\n  \"nanny\": \"caregiver\", // Map to caregiver\n  \"elderly care\": \"caregiver\", // Map to caregiver\n  \"iv therapy\": \"iv_therapy\",\n};\n\n// Allowed appointment type values (from database constraint)\nconst ALLOWED_APPOINTMENT_TYPES = [\n  \"doctor_on_call\",\n  \"lab_test\",\n  \"teleconsultation\",\n  \"physiotherapy\",\n  \"caregiver\",\n  \"iv_therapy\",\n] as const;\n\n/**\n * Hook to fetch services from the database and convert them to appointment types\n */\nexport const useAppointmentTypes = (): AppointmentTypeConfig[] => {\n  const { data: services } = useGetList<Service>(\"services\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  return useMemo(() => {\n    if (!services || services.length === 0) {\n      // Fallback to default types if no services found\n      return [\n        { value: \"doctor_on_call\", label: \"Doctor on Call\", color: \"#3b82f6\" },\n        { value: \"lab_test\", label: \"Lab Test\", color: \"#a855f7\" },\n        { value: \"teleconsultation\", label: \"Teleconsultation\", color: \"#10b981\" },\n        { value: \"physiotherapy\", label: \"Physiotherapy\", color: \"#f97316\" },\n        { value: \"caregiver\", label: \"Caregiver\", color: \"#ec4899\" },\n        { value: \"iv_therapy\", label: \"IV Therapy\", color: \"#ef4444\" },\n      ];\n    }\n\n    // Map all services to appointment types - show all services from Services Management\n    // Use service ID as the value to ensure uniqueness, but store the mapped appointment_type\n    return services.map((service, index) => {\n      // Map service name to allowed appointment_type value\n      const serviceNameLower = service.name.toLowerCase();\n      const mappedType = SERVICE_TO_APPOINTMENT_TYPE_MAP[serviceNameLower] || \n                    (serviceNameLower.replace(/\\s+/g, \"_\") as string);\n      \n      // Validate that the mapped type is in the allowed list, fallback to first allowed type if not\n      const appointmentType = ALLOWED_APPOINTMENT_TYPES.includes(mappedType as any) \n        ? mappedType \n        : ALLOWED_APPOINTMENT_TYPES[0];\n      \n      // Get color from database first, then fallback to map or default\n      const color = service.color || SERVICE_COLOR_MAP[serviceNameLower] || DEFAULT_COLORS[index % DEFAULT_COLORS.length];\n\n      return {\n        value: `service_${service.id}`, // Use service ID as unique value\n        label: service.name, // Use the exact service name from Services Management\n        color,\n        serviceId: service.id, // Include service ID for unique identification\n        appointmentType, // Store the mapped appointment type for submission\n      };\n    });\n  }, [services]);\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/types.ts",
      "content": "export type AppointmentFilterState = {\n  staffIds: string[];\n  appointmentTypes: string[];\n  statuses: string[];\n  dateFrom: string | null;\n  dateTo: string | null;\n};\n\nexport type AppointmentViewMode = \"calendar\" | \"table\" | \"map\";\n\nexport type AppointmentTypeConfig = {\n  value: string;\n  label: string;\n  color: string;\n  serviceId?: string | number; // Optional service ID for unique identification\n  appointmentType?: string; // The mapped appointment type value for database storage\n};\n\nexport type StatusConfig = {\n  value: string;\n  label: string;\n  color: string;\n  icon?: string;\n};\n\nexport const APPOINTMENT_TYPES: AppointmentTypeConfig[] = [\n  { value: \"doctor_on_call\", label: \"Doctor on Call\", color: \"#3b82f6\" },\n  { value: \"lab_test\", label: \"Lab Test\", color: \"#10b981\" },\n  { value: \"teleconsultation\", label: \"Teleconsultation\", color: \"#8b5cf6\" },\n  { value: \"physiotherapy\", label: \"Physiotherapy\", color: \"#f59e0b\" },\n  { value: \"caregiver\", label: \"Caregiver\", color: \"#ef4444\" },\n  { value: \"iv_therapy\", label: \"IV Therapy\", color: \"#06b6d4\" },\n];\n\nexport const APPOINTMENT_STATUSES: StatusConfig[] = [\n  { value: \"scheduled\", label: \"Scheduled\", color: \"#f59e0b\", icon: \"Clock\" },\n  { value: \"completed\", label: \"Completed\", color: \"#10b981\", icon: \"CheckCircle\" },\n  { value: \"cancelled\", label: \"Cancelled\", color: \"#ef4444\", icon: \"XCircle\" },\n];\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/recurrenceUtils.ts",
      "content": "import type { RecurrenceConfig } from \"../types\";\nimport { addDays, addWeeks, addMonths, addYears, startOfDay, isBefore, isAfter, format } from \"date-fns\";\n\nexport interface BaseAppointmentData {\n  patient_id: number;\n  appointment_date: string; // YYYY-MM-DD\n  start_time: string; // ISO datetime string\n  end_time: string; // ISO datetime string\n  duration_minutes: number;\n  appointment_type: string;\n  status: string;\n  notes?: string | null;\n  mini_notes?: string | null;\n  full_notes?: string | null;\n  pickup_instructions?: string | null;\n  primary_staff_id?: number | null;\n  driver_id?: number | null;\n  payment_package_id?: number | null;\n}\n\nexport interface GeneratedAppointment extends BaseAppointmentData {\n  recurrence_sequence: number;\n}\n\nconst MAX_OCCURRENCES = 1000; // Prevent performance issues\n\n/**\n * Generates recurring appointment instances based on recurrence configuration\n * @param baseAppointment Base appointment data\n * @param recurrenceConfig Recurrence configuration\n * @returns Array of appointment instances with calculated dates/times\n */\nexport function generateRecurringAppointments(\n  baseAppointment: BaseAppointmentData,\n  recurrenceConfig: RecurrenceConfig\n): GeneratedAppointment[] {\n  const appointments: GeneratedAppointment[] = [];\n  \n  // Parse the base start and end times\n  const baseStartDate = new Date(baseAppointment.start_time);\n  const baseEndDate = new Date(baseAppointment.end_time);\n  const baseDate = new Date(baseAppointment.appointment_date + \"T00:00:00\");\n  \n  // Determine end date\n  let endDate: Date | null = null;\n  let maxOccurrences: number | null = null;\n  \n  if (recurrenceConfig.end_type === \"date\" && recurrenceConfig.end_date) {\n    endDate = new Date(recurrenceConfig.end_date + \"T23:59:59\");\n  } else if (recurrenceConfig.end_type === \"occurrences\") {\n    // If occurrences is explicitly set, use it; otherwise default to 100\n    if (recurrenceConfig.occurrences != null && recurrenceConfig.occurrences > 0) {\n      maxOccurrences = Math.min(recurrenceConfig.occurrences, MAX_OCCURRENCES);\n    } else {\n      // Default: 100 occurrences if end_type is \"occurrences\" but occurrences not set\n      maxOccurrences = 100;\n    }\n  } else {\n    // Default: 100 occurrences if neither specified\n    maxOccurrences = 100;\n  }\n  \n  // Validate end_date is after start_date\n  if (endDate && isBefore(endDate, baseStartDate)) {\n    throw new Error(\"End date must be after start date\");\n  }\n  \n  // Validate occurrences > 0\n  if (maxOccurrences !== null && maxOccurrences <= 0) {\n    throw new Error(\"Occurrences must be greater than 0\");\n  }\n  \n  let sequence = 0;\n  \n  // Always include the first appointment (parent)\n  appointments.push({\n    ...baseAppointment,\n    recurrence_sequence: sequence++,\n  });\n  \n  // Special handling for weekly pattern with multiple days_of_week\n  if (recurrenceConfig.pattern === \"weekly\" && \n      recurrenceConfig.days_of_week && \n      recurrenceConfig.days_of_week.length > 0) {\n    // Generate all appointments for selected days in each week\n    let weekOffset = 0;\n    const baseDayOfWeek = baseStartDate.getDay();\n    const sortedDaysOfWeek = [...recurrenceConfig.days_of_week].sort((a, b) => a - b);\n    \n    let shouldStop = false;\n    while (true) {\n      // Check if we've exceeded max occurrences\n      if (maxOccurrences !== null && appointments.length >= maxOccurrences) {\n        break;\n      }\n      \n      // Check if we've generated too many (safety check)\n      if (appointments.length >= MAX_OCCURRENCES) {\n        break;\n      }\n      \n      // Calculate the reference date for this week (base date + week offset)\n      const weekReferenceDate = addWeeks(baseStartDate, weekOffset * recurrenceConfig.interval);\n      const weekReferenceDayOfWeek = weekReferenceDate.getDay();\n      \n      // Find the start of the week (Sunday) that contains the reference date\n      const weekStartDate = addDays(weekReferenceDate, -weekReferenceDayOfWeek);\n      \n      // Generate appointments for all selected days in this week\n      let foundAnyInWeek = false;\n      let skippedBaseDateInWeek0 = false;\n      \n      for (const targetDayOfWeek of sortedDaysOfWeek) {\n        // Check BEFORE processing if we've exceeded max occurrences\n        if (maxOccurrences !== null && appointments.length >= maxOccurrences) {\n          shouldStop = true;\n          break;\n        }\n        \n        // Calculate the target date: start of week + target day of week\n        const targetDate = addDays(weekStartDate, targetDayOfWeek);\n        \n        // In week 0, skip the base date (already added as parent) and only include days >= base date\n        if (weekOffset === 0) {\n          if (targetDayOfWeek === baseDayOfWeek) {\n            skippedBaseDateInWeek0 = true; // Mark that we skipped the base date\n            continue; // Skip base date, already added\n          }\n          if (isBefore(targetDate, baseStartDate)) {\n            continue; // Skip days before base date in week 0\n          }\n        }\n        \n        // Check if this date exceeds end date\n        if (endDate && isAfter(targetDate, endDate)) {\n          continue;\n        }\n        \n        // Calculate time difference from base\n        const timeDiff = targetDate.getTime() - baseStartDate.getTime();\n        const targetEndDate = new Date(baseEndDate.getTime() + timeDiff);\n        \n        // Format dates\n        const appointmentDate = format(targetDate, \"yyyy-MM-dd\");\n        const startTimeISO = targetDate.toISOString();\n        const endTimeISO = targetEndDate.toISOString();\n        \n        appointments.push({\n          ...baseAppointment,\n          appointment_date: appointmentDate,\n          start_time: startTimeISO,\n          end_time: endTimeISO,\n          recurrence_sequence: sequence++,\n        });\n        \n        foundAnyInWeek = true;\n        \n        // Check AFTER adding if we've reached the limit\n        if (maxOccurrences !== null && appointments.length >= maxOccurrences) {\n          shouldStop = true;\n          break;\n        }\n      }\n      \n      // Break out of outer loop if we've reached the limit\n      if (shouldStop) {\n        break;\n      }\n      \n      // If we didn't find any valid dates in this week, check if we skipped the base date in week 0\n      // If so, we should continue to next week (the parent appointment counts as week 0)\n      if (!foundAnyInWeek) {\n        if (weekOffset === 0 && skippedBaseDateInWeek0) {\n          // Week 0 had the base date which was already added as parent, so continue to next week\n          // But only if we haven't reached max occurrences yet\n          if (maxOccurrences === null || appointments.length < maxOccurrences) {\n            weekOffset++;\n            continue;\n          }\n        }\n        // Otherwise, we're done\n        break;\n      }\n      \n      // Move to next week interval\n      weekOffset++;\n      \n      // Check if next week would exceed end date\n      const nextWeekReference = addWeeks(baseStartDate, weekOffset * recurrenceConfig.interval);\n      if (endDate && isAfter(nextWeekReference, endDate)) {\n        break;\n      }\n    }\n  } else {\n    // Standard logic for other patterns (daily, monthly, yearly, etc.)\n    let currentDate = new Date(baseStartDate);\n    \n    while (true) {\n      // Check if we've exceeded max occurrences\n      if (maxOccurrences !== null && appointments.length >= maxOccurrences) {\n        break;\n      }\n      \n      // Calculate next date based on pattern\n      const nextDate = calculateNextDate(\n        currentDate,\n        recurrenceConfig,\n        baseStartDate\n      );\n      \n      // Check if next date exceeds end date\n      if (endDate && isAfter(nextDate, endDate)) {\n        break;\n      }\n      \n      // Check if we've generated too many (safety check)\n      if (appointments.length >= MAX_OCCURRENCES) {\n        break;\n      }\n      \n      // Calculate time difference from base\n      const timeDiff = nextDate.getTime() - baseStartDate.getTime();\n      const nextEndDate = new Date(baseEndDate.getTime() + timeDiff);\n      \n      // Format dates\n      const appointmentDate = format(nextDate, \"yyyy-MM-dd\");\n      const startTimeISO = nextDate.toISOString();\n      const endTimeISO = nextEndDate.toISOString();\n      \n      appointments.push({\n        ...baseAppointment,\n        appointment_date: appointmentDate,\n        start_time: startTimeISO,\n        end_time: endTimeISO,\n        recurrence_sequence: sequence++,\n      });\n      \n      currentDate = nextDate;\n    }\n  }\n  \n  return appointments;\n}\n\n/**\n * Calculates the next occurrence date based on recurrence pattern\n */\nfunction calculateNextDate(\n  currentDate: Date,\n  config: RecurrenceConfig,\n  baseStartDate: Date\n): Date {\n  const { pattern, interval, days_of_week, day_of_month, week_of_month, month, custom_unit } = config;\n  \n  switch (pattern) {\n    case \"daily\":\n      return addDays(currentDate, interval);\n    \n    case \"weekly\":\n      if (days_of_week && days_of_week.length > 0) {\n        // Find next occurrence of any specified day of week\n        return findNextDayOfWeek(currentDate, days_of_week, interval);\n      }\n      return addWeeks(currentDate, interval);\n    \n    case \"monthly\":\n      if (day_of_month !== null && day_of_month !== undefined) {\n        // Specific day of month (e.g., 15th of every month)\n        return addMonthsToDayOfMonth(currentDate, interval, day_of_month);\n      } else if (week_of_month !== null && week_of_month !== undefined && days_of_week && days_of_week.length > 0) {\n        // Specific week and day (e.g., first Monday of every month)\n        return addMonthsToWeekDay(currentDate, interval, week_of_month, days_of_week[0]);\n      }\n      return addMonths(currentDate, interval);\n    \n    case \"yearly\":\n      if (month !== null && month !== undefined) {\n        // Specific month\n        if (day_of_month !== null && day_of_month !== undefined) {\n          return addYearsToDayOfMonth(currentDate, interval, month, day_of_month);\n        } else if (week_of_month !== null && week_of_month !== undefined && days_of_week && days_of_week.length > 0) {\n          return addYearsToWeekDay(currentDate, interval, month, week_of_month, days_of_week[0]);\n        }\n      }\n      return addYears(currentDate, interval);\n    \n    case \"custom\":\n      if (custom_unit === \"days\") {\n        // If days_of_week is specified, find next occurrence of selected days\n        if (days_of_week && days_of_week.length > 0) {\n          return findNextDayOfWeek(currentDate, days_of_week, interval);\n        }\n        return addDays(currentDate, interval);\n      } else if (custom_unit === \"weeks\") {\n        // If days_of_week is specified, find next occurrence of selected days\n        if (days_of_week && days_of_week.length > 0) {\n          return findNextDayOfWeek(currentDate, days_of_week, interval);\n        }\n        return addWeeks(currentDate, interval);\n      } else if (custom_unit === \"months\") {\n        return addMonths(currentDate, interval);\n      }\n      // Default to days\n      return addDays(currentDate, interval);\n    \n    default:\n      return addDays(currentDate, interval);\n  }\n}\n\n/**\n * Finds the next occurrence of any specified day of week\n */\nfunction findNextDayOfWeek(currentDate: Date, daysOfWeek: number[], interval: number): Date {\n  let nextDate = new Date(currentDate);\n  let weeksAdded = 0;\n  const maxIterations = interval * 7; // Safety limit\n  \n  for (let i = 0; i < maxIterations; i++) {\n    nextDate = addDays(nextDate, 1);\n    const dayOfWeek = nextDate.getDay();\n    \n    if (daysOfWeek.includes(dayOfWeek)) {\n      // Check if we've completed the interval\n      const weeksSinceStart = Math.floor((nextDate.getTime() - currentDate.getTime()) / (7 * 24 * 60 * 60 * 1000));\n      if (weeksSinceStart >= interval) {\n        return nextDate;\n      }\n    }\n  }\n  \n  // Fallback: add interval weeks\n  return addWeeks(currentDate, interval);\n}\n\n/**\n * Adds months while preserving day of month (handles month-end edge cases)\n */\nfunction addMonthsToDayOfMonth(currentDate: Date, interval: number, dayOfMonth: number): Date {\n  let nextDate = addMonths(currentDate, interval);\n  const targetDay = Math.min(dayOfMonth, getDaysInMonth(nextDate));\n  nextDate.setDate(targetDay);\n  return nextDate;\n}\n\n/**\n * Adds months while preserving week and day (e.g., first Monday)\n */\nfunction addMonthsToWeekDay(\n  currentDate: Date,\n  interval: number,\n  weekOfMonth: number,\n  dayOfWeek: number\n): Date {\n  let nextDate = addMonths(currentDate, interval);\n  return setWeekDayOfMonth(nextDate, weekOfMonth, dayOfWeek);\n}\n\n/**\n * Adds years while preserving month and day of month\n */\nfunction addYearsToDayOfMonth(\n  currentDate: Date,\n  interval: number,\n  month: number,\n  dayOfMonth: number\n): Date {\n  let nextDate = addYears(currentDate, interval);\n  nextDate.setMonth(month - 1); // month is 1-12, setMonth expects 0-11\n  const targetDay = Math.min(dayOfMonth, getDaysInMonth(nextDate));\n  nextDate.setDate(targetDay);\n  return nextDate;\n}\n\n/**\n * Adds years while preserving month, week, and day\n */\nfunction addYearsToWeekDay(\n  currentDate: Date,\n  interval: number,\n  month: number,\n  weekOfMonth: number,\n  dayOfWeek: number\n): Date {\n  let nextDate = addYears(currentDate, interval);\n  nextDate.setMonth(month - 1);\n  return setWeekDayOfMonth(nextDate, weekOfMonth, dayOfWeek);\n}\n\n/**\n * Sets the date to a specific week and day of month (e.g., first Monday)\n */\nfunction setWeekDayOfMonth(date: Date, weekOfMonth: number, dayOfWeek: number): Date {\n  // Start from the first day of the month\n  const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);\n  \n  // Find the first occurrence of the target day of week\n  const firstDayOfWeek = firstDay.getDay();\n  let daysToAdd = (dayOfWeek - firstDayOfWeek + 7) % 7;\n  \n  // Add weeks (weekOfMonth is 1-based: 1 = first, 2 = second, etc.)\n  daysToAdd += (weekOfMonth - 1) * 7;\n  \n  const targetDate = new Date(firstDay);\n  targetDate.setDate(1 + daysToAdd);\n  \n  // If the target date is in the next month, go back to the last occurrence\n  if (targetDate.getMonth() !== date.getMonth()) {\n    targetDate.setDate(targetDate.getDate() - 7);\n  }\n  \n  return targetDate;\n}\n\n/**\n * Gets the number of days in a month\n */\nfunction getDaysInMonth(date: Date): number {\n  return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/index.tsx",
      "content": "export { AppointmentsPage } from \"./AppointmentsPage\";\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/VirtualizedTable.tsx",
      "content": "import React, { useMemo } from \"react\";\nimport { useVirtualizer } from \"@tanstack/react-virtual\";\nimport { MoreHorizontal, Repeat } from \"lucide-react\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { format } from \"date-fns\";\nimport type { Appointment, PaymentPackage, Service } from \"../types\";\nimport { APPOINTMENT_STATUSES } from \"./types\";\nimport { useGetList } from \"ra-core\";\nimport type { Contact, Staff } from \"../types\";\nimport { formatCrmDate } from \"../misc/timezone\";\nimport { Link } from \"react-router\";\n\ntype VirtualizedTableProps = {\n  appointments: Appointment[];\n  loading: boolean;\n  onAppointmentClick: (appointment: Appointment) => void;\n};\n\nconst ITEM_HEIGHT = 80;\n\n\nexport const VirtualizedTable: React.FC<VirtualizedTableProps> = ({\n  appointments,\n  loading,\n  onAppointmentClick,\n}) => {\n  const parentRef = React.useRef<HTMLDivElement>(null);\n  const { data: patientsData } = useGetList<Contact>(\"clients\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n  const { data: staffData } = useGetList<Staff>(\"staff\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n  \n  // Get unique payment package IDs from appointments\n  const packageIds = useMemo(() => {\n    const ids = appointments\n      .map(a => a.payment_package_id)\n      .filter((id): id is number => id !== null && id !== undefined);\n    return [...new Set(ids)];\n  }, [appointments]);\n  \n  // Fetch payment packages\n  const { data: paymentPackages } = useGetList<PaymentPackage>(\"payment_packages\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: packageIds.length > 0 ? { id: packageIds } : { id: [] },\n  }, { enabled: packageIds.length > 0 });\n  \n  const { data: services } = useGetList<Service>(\"services\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n  \n  // Create a map for quick lookup\n  const packageMap = useMemo(() => {\n    const map = new Map<number, PaymentPackage>();\n    paymentPackages?.forEach(pkg => {\n      if (pkg.id) map.set(Number(pkg.id), pkg);\n    });\n    return map;\n  }, [paymentPackages]);\n\n  const sortedAppointments = useMemo(() => {\n    return [...appointments].sort((a, b) => {\n      // Parse dates - start_time is an ISO datetime string\n      let dateA: Date;\n      let dateB: Date;\n      \n      try {\n        if (a.start_time) {\n          dateA = new Date(a.start_time);\n        } else if (a.appointment_date) {\n          dateA = new Date(a.appointment_date + \"T00:00:00\");\n        } else {\n          dateA = new Date(0); // Fallback to epoch\n        }\n        \n        if (b.start_time) {\n          dateB = new Date(b.start_time);\n        } else if (b.appointment_date) {\n          dateB = new Date(b.appointment_date + \"T00:00:00\");\n        } else {\n          dateB = new Date(0); // Fallback to epoch\n        }\n        \n        // Validate dates\n        if (isNaN(dateA.getTime())) dateA = new Date(0);\n        if (isNaN(dateB.getTime())) dateB = new Date(0);\n        \n        return dateA.getTime() - dateB.getTime();\n      } catch (error) {\n        console.warn(\"Error sorting appointments:\", error);\n        return 0;\n      }\n    });\n  }, [appointments]);\n\n  const virtualizer = useVirtualizer({\n    count: sortedAppointments.length,\n    getScrollElement: () => parentRef.current,\n    estimateSize: () => ITEM_HEIGHT,\n    overscan: 5,\n  });\n\n  const getStatusBadge = (status: string) => {\n    const statusConfig = APPOINTMENT_STATUSES.find((s) => s.value === status);\n    if (!statusConfig) {\n      return (\n        <Badge className=\"bg-[--muted] text-[--muted-foreground]\">\n          {status}\n        </Badge>\n      );\n    }\n\n    const variantMap: Record<string, \"default\" | \"secondary\" | \"destructive\" | \"outline\"> = {\n      scheduled: \"secondary\",\n      cancelled: \"destructive\",\n      completed: \"default\",\n    };\n\n    return (\n      <Badge\n        variant={variantMap[status] || \"outline\"}\n        className={`${\n          status === \"scheduled\"\n            ? \"bg-[--warning]/10 text-[--warning]\"\n            : status === \"cancelled\"\n            ? \"bg-[--error]/10 text-[--error]\"\n            : status === \"completed\"\n            ? \"bg-[--primary]/10 text-[--primary]\"\n            : \"\"\n        } inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium`}\n      >\n        {statusConfig.label}\n      </Badge>\n    );\n  };\n\n  const getPatientName = (patientId: string | number) => {\n    const patient = patientsData?.find((p) => p.id === patientId);\n    if (!patient) return \"Unknown\";\n    return `${patient.first_name} ${patient.last_name}`.trim();\n  };\n\n  const getPatientInitials = (patientId: string | number) => {\n    const patient = patientsData?.find((p) => p.id === patientId);\n    if (!patient) return \"U\";\n    const first = patient.first_name?.[0] || \"\";\n    const last = patient.last_name?.[0] || \"\";\n    return (first + last).toUpperCase() || \"U\";\n  };\n\n  const formatAppointmentType = (type: string) => {\n    return type\n      .split(\"_\")\n      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\n      .join(\" \");\n  };\n\n  if (loading) {\n    return (\n      <Card className=\"bg-[--card] border border-[--border] rounded-xl shadow-lg p-6\">\n        <div className=\"space-y-4\">\n          {Array.from({ length: 5 }).map((_, i) => (\n            <Skeleton key={i} className=\"h-20 w-full\" />\n          ))}\n        </div>\n      </Card>\n    );\n  }\n\n  if (sortedAppointments.length === 0) {\n    return (\n      <Card className=\"bg-[--card] border border-[--border] rounded-xl shadow-lg p-6\">\n        <div className=\"text-center py-12 text-[--muted-foreground]\">\n          No appointments found\n        </div>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"bg-[--card] border border-[--border] rounded-xl shadow-lg overflow-hidden\">\n      <div className=\"overflow-x-auto\">\n        <div className=\"min-w-full\">\n          {/* Table Header */}\n          <div className=\"grid grid-cols-[150px_200px_150px_100px_120px_150px_200px_100px] gap-4 px-4 py-3 border-b border-[--border] bg-[--muted]/50\">\n            <div className=\"text-xs font-semibold text-[--muted-foreground] uppercase\">\n              Time\n            </div>\n            <div className=\"text-xs font-semibold text-[--muted-foreground] uppercase\">\n              Patient\n            </div>\n            <div className=\"text-xs font-semibold text-[--muted-foreground] uppercase\">\n              Type\n            </div>\n            <div className=\"text-xs font-semibold text-[--muted-foreground] uppercase\">\n              Duration\n            </div>\n            <div className=\"text-xs font-semibold text-[--muted-foreground] uppercase\">\n              Status\n            </div>\n            <div className=\"text-xs font-semibold text-[--muted-foreground] uppercase\">\n              Package\n            </div>\n            <div className=\"text-xs font-semibold text-[--muted-foreground] uppercase\">\n              Notes\n            </div>\n            <div className=\"text-xs font-semibold text-[--muted-foreground] uppercase\">\n              Actions\n            </div>\n          </div>\n\n          {/* Virtualized Rows */}\n          <div\n            ref={parentRef}\n            className=\"overflow-y-auto\"\n            style={{ height: \"600px\" }}\n          >\n            <div\n              style={{\n                height: `${virtualizer.getTotalSize()}px`,\n                width: \"100%\",\n                position: \"relative\",\n              }}\n            >\n              {virtualizer.getVirtualItems().map((virtualRow) => {\n                const appointment = sortedAppointments[virtualRow.index];\n                \n                // Parse dates - start_time and end_time are ISO datetime strings\n                let startTime: Date;\n                let endTime: Date;\n                \n                try {\n                  if (appointment.start_time) {\n                    startTime = new Date(appointment.start_time);\n                  } else if (appointment.appointment_date) {\n                    startTime = new Date(appointment.appointment_date + \"T00:00:00\");\n                  } else {\n                    startTime = new Date();\n                  }\n                  \n                  if (appointment.end_time) {\n                    endTime = new Date(appointment.end_time);\n                  } else if (appointment.appointment_date) {\n                    endTime = new Date(appointment.appointment_date + \"T01:00:00\");\n                  } else {\n                    endTime = new Date();\n                  }\n                  \n                  // Validate dates\n                  if (isNaN(startTime.getTime())) startTime = new Date();\n                  if (isNaN(endTime.getTime())) endTime = new Date();\n                } catch (error) {\n                  console.warn(\"Error parsing appointment times:\", error);\n                  startTime = new Date();\n                  endTime = new Date();\n                }\n\n                return (\n                  <div\n                    key={virtualRow.key}\n                    data-index={virtualRow.index}\n                    ref={virtualizer.measureElement}\n                    style={{\n                      position: \"absolute\",\n                      top: 0,\n                      left: 0,\n                      width: \"100%\",\n                      height: `${virtualRow.size}px`,\n                      transform: `translateY(${virtualRow.start}px)`,\n                    }}\n                    className=\"grid grid-cols-[150px_200px_150px_100px_120px_150px_200px_100px] gap-4 px-4 py-3 border-b border-[--border] hover:bg-[--accent] cursor-pointer items-center\"\n                    onClick={() => onAppointmentClick(appointment)}\n                  >\n                    {/* Time */}\n                    <div className=\"flex items-center gap-2\">\n                      <div>\n                        <div className=\"text-sm text-[--foreground] font-medium\">\n                          {format(startTime, \"HH:mm\")} - {format(endTime, \"HH:mm\")}\n                        </div>\n                        <div className=\"text-xs text-[--muted-foreground]\">\n                          {formatCrmDate(appointment.appointment_date)}\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Patient */}\n                    <div className=\"flex items-center space-x-3\">\n                      <div className=\"w-8 h-8 rounded-full bg-[--muted] flex items-center justify-center text-xs font-medium text-[--foreground]\">\n                        {getPatientInitials(appointment.patient_id)}\n                      </div>\n                      <span className=\"text-sm text-[--foreground]\">\n                        {getPatientName(appointment.patient_id)}\n                      </span>\n                    </div>\n\n                    {/* Type */}\n                    <div className=\"text-sm text-[--foreground]\">\n                      {formatAppointmentType(appointment.appointment_type)}\n                    </div>\n\n                    {/* Duration */}\n                    <div className=\"text-sm text-[--foreground]\">\n                      {appointment.duration_minutes} min\n                    </div>\n\n                    {/* Status */}\n                    <div>{getStatusBadge(appointment.status)}</div>\n\n                    {/* Package */}\n                    <div>\n                      {appointment.payment_package_id ? (() => {\n                        const pkg = packageMap.get(Number(appointment.payment_package_id));\n                        if (!pkg) return <span className=\"text-xs text-[--muted-foreground]\">Loading...</span>;\n                        const service = services?.find(s => s.id === pkg.service_id);\n                        const statusColors = {\n                          active: \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300\",\n                          completed: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n                          expired: \"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300\",\n                        };\n                        return (\n                          <Link\n                            to={`/payment_packages/${pkg.id}/show`}\n                            onClick={(e) => e.stopPropagation()}\n                            className=\"flex items-center gap-1 hover:underline\"\n                          >\n                            <span className=\"text-xs text-[--foreground]\">\n                              #{pkg.id}\n                            </span>\n                            <Badge className={`${statusColors[pkg.status] || statusColors.completed} text-xs`}>\n                              {pkg.status}\n                            </Badge>\n                          </Link>\n                        );\n                      })() : (\n                        <span className=\"text-xs text-[--muted-foreground]\">-</span>\n                      )}\n                    </div>\n\n                    {/* Notes */}\n                    <div className=\"text-sm text-[--foreground] truncate\">\n                      {appointment.notes || appointment.mini_notes || \"No notes\"}\n                    </div>\n\n                    {/* Actions */}\n                    <div>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"p-2 text-[--muted-foreground] hover:text-[--foreground] hover:bg-[--accent] rounded-lg transition-colors\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          // TODO: Open actions menu\n                        }}\n                      >\n                        <MoreHorizontal className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        </div>\n      </div>\n    </Card>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/CustomMultiSelect.tsx",
      "content": "import React, { useState, useRef, useEffect } from \"react\";\nimport { Check, ChevronDown, X } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\n\nexport type MultiSelectOption = {\n  value: string;\n  label: string;\n  color?: string;\n  icon?: React.ReactNode;\n  serviceId?: string | number; // Optional service ID for unique identification\n};\n\ntype CustomMultiSelectProps = {\n  options: MultiSelectOption[];\n  selected: string[];\n  onChange: (selected: string[]) => void;\n  placeholder: string;\n  className?: string;\n};\n\nexport const CustomMultiSelect: React.FC<CustomMultiSelectProps> = ({\n  options,\n  selected,\n  onChange,\n  placeholder,\n  className,\n}) => {\n  const [isOpen, setIsOpen] = useState(false);\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, []);\n\n  const handleSelectAll = () => {\n    if (!options || !Array.isArray(options)) return;\n    if (selected.length === options.length) {\n      onChange([]);\n    } else {\n      onChange(options.map((opt) => opt.value));\n    }\n  };\n\n  const handleToggle = (value: string) => {\n    if (selected.includes(value)) {\n      onChange(selected.filter((v) => v !== value));\n    } else {\n      onChange([...selected, value]);\n    }\n  };\n\n  const getDisplayText = () => {\n    if (!options || !Array.isArray(options) || selected.length === 0) return placeholder;\n    if (selected.length === 1) {\n      const option = options.find((opt) => opt.value === selected[0]);\n      return option?.label || placeholder;\n    }\n    if (selected.length === options.length) {\n      return `All ${placeholder}`;\n    }\n    return `${selected.length} selected`;\n  };\n\n  const getVisibleIndicators = () => {\n    if (!options || !Array.isArray(options) || selected.length === 0) return [];\n    const selectedOptions = options.filter((opt) => selected.includes(opt.value));\n    return selectedOptions.slice(0, 2);\n  };\n\n  const visibleIndicators = getVisibleIndicators();\n  const remainingCount = (selected?.length || 0) - visibleIndicators.length;\n\n  return (\n    <div ref={containerRef} className={cn(\"relative\", className)}>\n      <Button\n        type=\"button\"\n        variant=\"outline\"\n        onClick={() => setIsOpen(!isOpen)}\n        className={cn(\n          \"w-full px-3 py-2 text-left bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg hover:border-blue-500 dark:hover:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm justify-between transition-colors\",\n          isOpen && \"border-blue-500 dark:border-blue-400\",\n          className\n        )}\n      >\n        <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n          {visibleIndicators.length > 0 && (\n            <div className=\"flex items-center gap-1 flex-shrink-0\">\n              {visibleIndicators.map((opt, idx) => (\n                <div\n                  key={opt.serviceId !== undefined ? `${opt.value}-${opt.serviceId}` : `${opt.value}-${idx}`}\n                  className=\"w-2 h-2 rounded-full flex-shrink-0\"\n                  style={{ backgroundColor: opt.color || \"#6b7280\" }}\n                />\n              ))}\n              {remainingCount > 0 && (\n                <span className=\"text-xs text-[--muted-foreground]\">+{remainingCount}</span>\n              )}\n            </div>\n          )}\n          <span className={cn(\n            \"truncate text-slate-700 dark:text-slate-200\",\n            visibleIndicators.length > 0 && \"ml-2\"\n          )}>\n            {getDisplayText()}\n          </span>\n        </div>\n        <ChevronDown\n          className={cn(\n            \"w-4 h-4 text-slate-500 dark:text-slate-400 flex-shrink-0 transition-all\",\n            isOpen && \"transform rotate-180 text-blue-600 dark:text-blue-400\"\n          )}\n        />\n      </Button>\n\n      {isOpen && (\n        <div className=\"absolute z-50 mt-1 w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-xl overflow-hidden\">\n          <button\n            type=\"button\"\n            onClick={handleSelectAll}\n            className=\"w-full flex items-center gap-2 px-3 py-2.5 text-sm hover:bg-blue-50 dark:hover:bg-slate-700 text-left border-b border-slate-200 dark:border-slate-700 transition-colors\"\n          >\n            <Check\n              className={cn(\n                \"w-4 h-4 flex-shrink-0\",\n                options && Array.isArray(options) && selected.length === options.length\n                  ? \"text-blue-600 dark:text-blue-400\"\n                  : \"text-slate-400 dark:text-slate-500\"\n              )}\n            />\n            <span className=\"text-slate-700 dark:text-slate-200 font-medium\">Select All</span>\n          </button>\n          <div className=\"max-h-60 overflow-y-auto\">\n            {(options || []).map((option, index) => {\n              const isSelected = selected.includes(option.value);\n              // Use serviceId if available for unique key, otherwise use value + index\n              const uniqueKey = option.serviceId !== undefined \n                ? `${option.value}-${option.serviceId}` \n                : `${option.value}-${index}`;\n              return (\n                <button\n                  key={uniqueKey}\n                  type=\"button\"\n                  onClick={() => handleToggle(option.value)}\n                  className={cn(\n                    \"w-full flex items-center gap-2.5 px-3 py-2.5 text-sm text-left transition-colors\",\n                    isSelected\n                      ? \"bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30\"\n                      : \"hover:bg-slate-50 dark:hover:bg-slate-700/50\"\n                  )}\n                >\n                  <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                    {option.color && (\n                      <div\n                        className=\"w-3 h-3 rounded-full flex-shrink-0 border border-slate-200 dark:border-slate-600\"\n                        style={{ backgroundColor: option.color }}\n                      />\n                    )}\n                    {option.icon && <span className=\"flex-shrink-0 text-slate-600 dark:text-slate-300\">{option.icon}</span>}\n                    <span className={cn(\n                      \"flex-1 text-slate-700 dark:text-slate-200\",\n                      isSelected && \"font-medium\"\n                    )}>\n                      {option.label}\n                    </span>\n                  </div>\n                  {isSelected && (\n                    <Check className=\"w-4 h-4 flex-shrink-0 text-blue-600 dark:text-blue-400\" />\n                  )}\n                </button>\n              );\n            })}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentsPage.tsx",
      "content": "import React, { useState, useMemo, useCallback, useEffect } from \"react\";\nimport { Grid3X3, List, Plus, Map, ChevronLeft, ChevronRight, Calendar as CalendarIcon, X } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useGetList, useNotify, useDelete, useDataProvider } from \"ra-core\";\nimport { AppointmentFiltersTop } from \"./AppointmentFiltersTop\";\nimport { AppointmentCalendar } from \"./AppointmentCalendar\";\nimport { VirtualizedTable } from \"./VirtualizedTable\";\nimport { AppointmentMapView } from \"./AppointmentMapView\";\nimport { AppointmentModal } from \"./AppointmentModal\";\nimport { AppointmentDetailsDrawer } from \"./AppointmentDetailsDrawer\";\nimport { AppointmentContextMenu } from \"./AppointmentContextMenu\";\nimport { AppointmentDeleteDialog } from \"./AppointmentDeleteDialog\";\nimport type { AppointmentFilterState, AppointmentViewMode } from \"./types\";\nimport type { Appointment } from \"../types\";\nimport { crmAddDays, crmStartOfDay, crmToday, crmDateYmdInputString } from \"../misc/timezone\";\nimport { format, isToday, startOfDay, startOfMonth, endOfMonth, startOfWeek, endOfWeek, addMonths, subMonths, addDays, getDaysInMonth, isSameMonth, isSameDay } from \"date-fns\";\n\n// Calendar Popup Component\ntype CalendarPopupProps = {\n  selectedDate: Date;\n  onDateSelect: (date: Date) => void;\n  onClose: () => void;\n};\n\nconst CalendarPopup: React.FC<CalendarPopupProps> = ({ selectedDate, onDateSelect, onClose }) => {\n  const [displayMonth, setDisplayMonth] = useState(startOfMonth(selectedDate));\n  const today = crmToday();\n\n  // Update display month when selectedDate changes\n  useEffect(() => {\n    setDisplayMonth(startOfMonth(selectedDate));\n  }, [selectedDate]);\n\n  const monthStart = startOfMonth(displayMonth);\n  const monthEnd = endOfMonth(displayMonth);\n  const calendarStart = startOfWeek(monthStart, { weekStartsOn: 1 }); // Monday\n  const calendarEnd = endOfWeek(monthEnd, { weekStartsOn: 1 });\n\n  const days: Date[] = [];\n  let currentDay = calendarStart;\n  while (currentDay <= calendarEnd) {\n    days.push(currentDay);\n    currentDay = addDays(currentDay, 1);\n  }\n\n  const handlePreviousMonth = () => {\n    setDisplayMonth(subMonths(displayMonth, 1));\n  };\n\n  const handleNextMonth = () => {\n    setDisplayMonth(addMonths(displayMonth, 1));\n  };\n\n  const handleToday = () => {\n    onDateSelect(today);\n  };\n\n  const handleDateClick = (date: Date) => {\n    // Use crmStartOfDay to ensure proper timezone handling\n    onDateSelect(crmStartOfDay(date));\n  };\n\n  const monthYear = format(displayMonth, \"MMMM yyyy\");\n  const weekDays = [\"M\", \"T\", \"W\", \"T\", \"F\", \"S\", \"S\"];\n\n  return (\n    <div className=\"absolute top-2 left-2 z-[2000] bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 p-4 w-[280px]\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={handlePreviousMonth}\n            className=\"h-6 w-6 p-0\"\n          >\n            <ChevronLeft className=\"w-3 h-3\" />\n          </Button>\n          <span className=\"text-sm font-medium text-slate-900 dark:text-slate-100\">\n            {monthYear}\n          </span>\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={handleNextMonth}\n            className=\"h-6 w-6 p-0\"\n          >\n            <ChevronRight className=\"w-3 h-3\" />\n          </Button>\n        </div>\n        <Button\n          type=\"button\"\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={onClose}\n          className=\"h-6 w-6 p-0\"\n        >\n          <X className=\"w-4 h-4\" />\n        </Button>\n      </div>\n\n      {/* Week Days Header */}\n      <div className=\"grid grid-cols-7 gap-1 mb-2\">\n        {weekDays.map((day, index) => (\n          <div\n            key={index}\n            className=\"text-center text-xs font-medium text-slate-500 dark:text-slate-400 py-1\"\n          >\n            {day}\n          </div>\n        ))}\n      </div>\n\n      {/* Calendar Grid */}\n      <div className=\"grid grid-cols-7 gap-1 mb-3\">\n        {days.map((day, index) => {\n          const isCurrentMonth = isSameMonth(day, displayMonth);\n          const isSelected = isSameDay(day, selectedDate);\n          const isTodayDate = isSameDay(day, today);\n\n          return (\n            <button\n              key={index}\n              type=\"button\"\n              onClick={() => handleDateClick(day)}\n              className={`\n                h-8 w-8 rounded text-xs font-medium transition-colors\n                ${!isCurrentMonth ? \"text-slate-300 dark:text-slate-600\" : \"text-slate-900 dark:text-slate-100\"}\n                ${isSelected ? \"bg-blue-600 text-white dark:bg-blue-500\" : \"\"}\n                ${!isSelected && isTodayDate ? \"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300\" : \"\"}\n                ${!isSelected && !isTodayDate && isCurrentMonth ? \"hover:bg-slate-100 dark:hover:bg-slate-700\" : \"\"}\n              `}\n            >\n              {format(day, \"d\")}\n            </button>\n          );\n        })}\n      </div>\n\n      {/* Footer Buttons */}\n      <div className=\"flex items-center justify-between gap-2 pt-2 border-t border-slate-200 dark:border-slate-700\">\n        <Button\n          type=\"button\"\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={handleToday}\n          className=\"h-8 px-3 text-xs flex-1\"\n        >\n          Today\n        </Button>\n        <Button\n          type=\"button\"\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={onClose}\n          className=\"h-8 px-3 text-xs flex-1\"\n        >\n          Close\n        </Button>\n      </div>\n    </div>\n  );\n};\n\nexport const AppointmentsPage = () => {\n  try {\n    return <AppointmentsPageContent />;\n  } catch (error) {\n    console.error(\"Error in AppointmentsPage:\", error);\n    return (\n      <div className=\"min-h-screen bg-[--background] text-[--foreground] flex flex-col items-center justify-center p-8\">\n        <div className=\"text-center max-w-md\">\n          <h2 className=\"text-2xl font-bold mb-4\">Error Loading Appointments</h2>\n          <p className=\"text-[--muted-foreground]\">\n            {error instanceof Error ? error.message : \"An unexpected error occurred\"}\n          </p>\n        </div>\n      </div>\n    );\n  }\n};\n\nconst AppointmentsPageContent = () => {\n  const [viewMode, setViewMode] = useState<AppointmentViewMode>(\"calendar\");\n  const [calendarView, setCalendarView] = useState<\"month\" | \"week\" | \"day\" | \"list\">(\"month\");\n  const [currentDate, setCurrentDate] = useState<Date>(new Date());\n  const [filters, setFilters] = useState<AppointmentFilterState>({\n    staffIds: [],\n    appointmentTypes: [],\n    statuses: [],\n    dateFrom: null,\n    dateTo: null,\n  });\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null);\n  const [isModalOpen, setIsModalOpen] = useState(false);\n  const [isDrawerOpen, setIsDrawerOpen] = useState(false);\n  const [editingAppointment, setEditingAppointment] = useState<Appointment | null>(null);\n  const [deletingAppointment, setDeletingAppointment] = useState<Appointment | null>(null);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isDeleting, setIsDeleting] = useState(false);\n  const [contextMenu, setContextMenu] = useState<{\n    appointment: Appointment;\n    x: number;\n    y: number;\n  } | null>(null);\n  const [isCalendarPopupOpen, setIsCalendarPopupOpen] = useState(false);\n  const notify = useNotify();\n\n  // Calculate date range for fetching appointments (1 month past to 2 months future)\n  const dateRange = useMemo(() => {\n    const today = new Date();\n    const startDate = crmStartOfDay(crmAddDays(today, -30));\n    const endDate = crmStartOfDay(crmAddDays(today, 60));\n    return {\n      from: startDate?.toISOString(),\n      to: endDate?.toISOString(),\n    };\n  }, []);\n\n  // Build filter for API call\n  const apiFilter = useMemo(() => {\n    const filter: Record<string, unknown> = {};\n    \n    // Build appointment_date filter - prioritize dateRange, then filters\n    let dateFrom: string | undefined;\n    let dateTo: string | undefined;\n    \n    // Use dateRange if available\n    if (dateRange.from && dateRange.to) {\n      dateFrom = dateRange.from instanceof Date \n        ? dateRange.from.toISOString().split(\"T\")[0]\n        : typeof dateRange.from === \"string\" \n          ? dateRange.from.split(\"T\")[0]\n          : dateRange.from;\n      dateTo = dateRange.to instanceof Date\n        ? dateRange.to.toISOString().split(\"T\")[0]\n        : typeof dateRange.to === \"string\"\n          ? dateRange.to.split(\"T\")[0]\n          : dateRange.to;\n    }\n    \n    // Override with filters if provided\n    if (filters.dateFrom) {\n      const fromDate = new Date(filters.dateFrom);\n      fromDate.setHours(0, 0, 0, 0);\n      dateFrom = fromDate.toISOString().split(\"T\")[0];\n    }\n    \n    if (filters.dateTo) {\n      const toDate = new Date(filters.dateTo);\n      toDate.setHours(23, 59, 59, 999);\n      dateTo = toDate.toISOString().split(\"T\")[0];\n    }\n    \n    if (dateFrom && dateTo) {\n      filter[\"appointment_date@gte\"] = dateFrom;\n      filter[\"appointment_date@lte\"] = dateTo;\n    } else {\n      if (dateFrom) {\n        filter[\"appointment_date@gte\"] = dateFrom;\n      }\n      if (dateTo) {\n        filter[\"appointment_date@lte\"] = dateTo;\n      }\n    }\n\n    // Note: staff_ids is not a column - it's stored in appointment_staff_assignments junction table\n    // We'll filter appointments by staff in the application layer after fetching\n    // For now, skip this filter to avoid schema errors\n    // TODO: Implement proper filtering through appointment_staff_assignments table\n\n    if (filters.appointmentTypes.length > 0) {\n      // For text fields, join with commas (Supabase handles the formatting)\n      filter[\"appointment_type@in\"] = `(${filters.appointmentTypes.join(\",\")})`;\n    }\n\n    if (filters.statuses.length > 0) {\n      filter[\"status@in\"] = `(${filters.statuses.join(\",\")})`;\n    }\n\n    return filter;\n  }, [filters, dateRange]);\n\n  // Fetch appointments - with error handling for missing resource\n  // Disable the query initially to prevent blocking app initialization\n  const [queryEnabled, setQueryEnabled] = useState(false);\n  \n  // Enable query after component mounts\n  useEffect(() => {\n    // Small delay to ensure app is fully loaded\n    const timer = setTimeout(() => {\n      setQueryEnabled(true);\n    }, 100);\n    return () => clearTimeout(timer);\n  }, []);\n\n  const {\n    data: appointments,\n    isPending: appointmentsLoading,\n    refetch: refetchAppointments,\n    error: appointmentsError,\n  } = useGetList<Appointment>(\n    \"appointments\",\n    {\n      pagination: { page: 1, perPage: 10000 },\n      sort: { field: \"appointment_date\", order: \"ASC\" },\n      filter: apiFilter,\n    },\n    {\n      enabled: queryEnabled, // Only enable after mount\n      retry: false,\n      // Don't wait indefinitely - treat as empty if resource doesn't exist\n      onError: (error) => {\n        console.warn(\"Appointments resource not found or error:\", error);\n        // Don't throw - just log\n      },\n      // Set a timeout to fail faster\n      staleTime: 0,\n      gcTime: 0,\n    }\n  );\n\n  // Fetch staff assignments to populate staff_ids on appointments\n  const { data: staffAssignments } = useGetList<{ appointment_id: number | string; staff_id: number }>(\n    \"appointment_staff_assignments\",\n    {\n      pagination: { page: 1, perPage: 10000 },\n    },\n    {\n      enabled: queryEnabled && !!appointments && appointments.length > 0,\n      retry: false,\n      onError: (error) => {\n        console.warn(\"Failed to load staff assignments:\", error);\n      },\n    }\n  );\n\n  // Enrich appointments with staff_ids from assignments\n  const enrichedAppointments = useMemo(() => {\n    if (!appointments) return [];\n    if (!staffAssignments) return appointments;\n    \n    // Group assignments by appointment_id\n    const assignmentsByAppointment = (staffAssignments || []).reduce((acc: Record<string | number, number[]>, assignment: { appointment_id: number | string; staff_id: number }) => {\n      const appId = assignment.appointment_id;\n      if (!acc[appId]) {\n        acc[appId] = [];\n      }\n      acc[appId].push(assignment.staff_id);\n      return acc;\n    }, {});\n    \n    // Add staff_ids to each appointment\n    return appointments.map((appointment: Appointment) => ({\n      ...appointment,\n      staff_ids: assignmentsByAppointment[appointment.id] || [],\n    }));\n  }, [appointments, staffAssignments]);\n\n  // Filtered appointments (client-side filtering for staff_ids and other logic)\n  const filteredAppointments = useMemo(() => {\n    if (!enrichedAppointments) return [];\n    \n    let filtered = enrichedAppointments;\n    \n    // Filter by staff IDs if specified\n    if (filters.staffIds.length > 0) {\n      filtered = filtered.filter((appointment: Appointment) => {\n        const appointmentStaffIds = appointment.staff_ids || [];\n        return filters.staffIds.some((filterStaffId) =>\n          appointmentStaffIds.includes(parseInt(filterStaffId, 10))\n        );\n      });\n    }\n    \n    return filtered;\n  }, [enrichedAppointments, filters.staffIds]);\n\n  // Use filtered appointments (which includes staff_ids enrichment and filtering)\n  const safeAppointments = filteredAppointments || [];\n\n  // Count appointments for current date\n  const appointmentsForCurrentDate = useMemo(() => {\n    if (!safeAppointments) return 0;\n    const currentDateStr = format(currentDate, \"yyyy-MM-dd\");\n    return safeAppointments.filter((appointment: Appointment) => {\n      if (!appointment.appointment_date) return false;\n      const appointmentDate = new Date(appointment.appointment_date);\n      const appointmentDateStr = format(appointmentDate, \"yyyy-MM-dd\");\n      return appointmentDateStr === currentDateStr;\n    }).length;\n  }, [safeAppointments, currentDate]);\n\n  // Check if current date is today in CRM timezone\n  const isCurrentDateToday = useMemo(() => {\n    const currentDateStr = crmDateYmdInputString(currentDate);\n    const todayStr = crmDateYmdInputString(crmToday());\n    return currentDateStr === todayStr;\n  }, [currentDate]);\n\n  // Format date display based on current view\n  const getDateDisplay = useCallback(() => {\n    if (viewMode === \"map\") {\n      // Map view: Full date with badge\n      return format(currentDate, \"EEEE, MMMM d, yyyy\");\n    }\n\n    if (viewMode === \"calendar\") {\n      if (calendarView === \"month\") {\n        // Month view: \"December 2025\"\n        return format(currentDate, \"MMMM yyyy\");\n      } else if (calendarView === \"week\") {\n        // Week view: \"Dec 2025\" or \"Dec - Jan 2025\"\n        const weekStart = new Date(currentDate);\n        const dayOfWeek = weekStart.getDay();\n        // Adjust to Monday (assuming week starts on Monday)\n        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\n        weekStart.setDate(weekStart.getDate() + mondayOffset);\n        \n        const weekEnd = new Date(weekStart);\n        weekEnd.setDate(weekEnd.getDate() + 6);\n        \n        const startMonth = format(weekStart, \"MMM\");\n        const endMonth = format(weekEnd, \"MMM\");\n        const year = format(weekStart, \"yyyy\");\n        \n        if (startMonth === endMonth) {\n          return `${startMonth} ${year}`;\n        } else {\n          return `${startMonth} - ${endMonth} ${year}`;\n        }\n      } else if (calendarView === \"day\" || calendarView === \"list\") {\n        // Day/List view: Full date with badge\n        return format(currentDate, \"EEEE, MMMM d, yyyy\");\n      }\n    }\n    \n    // Default: Full date\n    return format(currentDate, \"EEEE, MMMM d, yyyy\");\n  }, [viewMode, calendarView, currentDate]);\n\n  // Determine if appointment badge should be shown\n  const shouldShowAppointmentBadge = useCallback(() => {\n    if (viewMode === \"map\") {\n      return true; // Map view always shows badge\n    }\n    \n    if (viewMode === \"calendar\") {\n      // Only show badge for day and list views\n      return calendarView === \"day\" || calendarView === \"list\";\n    }\n    \n    return false;\n  }, [viewMode, calendarView]);\n\n  // Show error state if resource doesn't exist (but still allow page to render)\n  const showError = appointmentsError && !appointmentsLoading;\n  \n  // If loading for more than 2 seconds, assume resource doesn't exist and show page\n  const [loadingTimeout, setLoadingTimeout] = useState(false);\n  useEffect(() => {\n    if (appointmentsLoading) {\n      const timer = setTimeout(() => {\n        setLoadingTimeout(true);\n        console.warn(\"Appointments query taking too long, showing page with empty data\");\n      }, 2000); // Reduced to 2 seconds\n      return () => clearTimeout(timer);\n    } else {\n      setLoadingTimeout(false);\n    }\n  }, [appointmentsLoading]);\n  \n  // Show page even if loading (with empty data) after timeout or if we have data/error\n  const shouldShowLoading = appointmentsLoading && !loadingTimeout && !appointments && !appointmentsError;\n\n  const handleApplyFilters = useCallback(() => {\n    refetchAppointments();\n  }, [refetchAppointments]);\n\n  const handleNewAppointment = useCallback((initialDate?: Date, initialEndDate?: Date) => {\n    setEditingAppointment(null);\n    // Store initial date/time for the form\n    if (initialDate) {\n      setInitialDateTime({ start: initialDate, end: initialEndDate || initialDate });\n    } else {\n      setInitialDateTime(null);\n    }\n    setIsModalOpen(true);\n  }, []);\n\n  const [initialDateTime, setInitialDateTime] = useState<{ start: Date; end: Date } | null>(null);\n\n  const handleAppointmentClick = useCallback((appointment: Appointment) => {\n    setSelectedAppointment(appointment);\n    setIsDrawerOpen(true);\n  }, []);\n\n  const handleAppointmentRightClick = useCallback(\n    (appointment: Appointment, event: React.MouseEvent) => {\n      event.preventDefault();\n      setContextMenu({\n        appointment,\n        x: event.clientX,\n        y: event.clientY,\n      });\n    },\n    []\n  );\n\n  const handleEditAppointment = useCallback((appointment: Appointment) => {\n    setEditingAppointment(appointment);\n    setIsModalOpen(true);\n    setIsDrawerOpen(false);\n    setContextMenu(null);\n  }, []);\n\n  const [deleteAppointment] = useDelete();\n  const dataProvider = useDataProvider();\n\n  const handleDeleteAppointment = useCallback(\n    (appointment: Appointment) => {\n      if (!appointment?.id) {\n        notify(\"Cannot delete: appointment ID is missing\", { type: \"error\" });\n        return;\n      }\n      setDeletingAppointment(appointment);\n      setIsDeleteDialogOpen(true);\n    },\n    [notify]\n  );\n\n  const handleConfirmDelete = useCallback(\n    async (deleteFutureOnly: boolean) => {\n      if (!deletingAppointment?.id) {\n        return;\n      }\n\n      setIsDeleting(true);\n      try {\n        // First, delete all staff assignments for this appointment\n        try {\n          const { data: assignments } = await dataProvider.getList(\"appointment_staff_assignments\", {\n            pagination: { page: 1, perPage: 1000 },\n            filter: { appointment_id: deletingAppointment.id },\n          });\n          \n          for (const assignment of assignments || []) {\n            await dataProvider.delete(\"appointment_staff_assignments\", { id: assignment.id });\n          }\n        } catch (staffError) {\n          console.warn(\"Error deleting staff assignments:\", staffError);\n          // Continue with appointment deletion even if staff assignments fail\n        }\n\n        // Delete the appointment with deleteFutureOnly flag\n        await deleteAppointment(\n          \"appointments\",\n          { \n            id: deletingAppointment.id,\n            meta: { deleteFutureOnly } // Pass flag via meta\n          },\n          {\n            onSuccess: () => {\n              notify(\n                deleteFutureOnly \n                  ? \"Appointment and future appointments deleted successfully\" \n                  : \"Appointment deleted successfully\",\n                { type: \"success\" }\n              );\n              refetchAppointments();\n              setContextMenu(null);\n              setIsDrawerOpen(false);\n              setIsDeleteDialogOpen(false);\n              setDeletingAppointment(null);\n            },\n            onError: (error: any) => {\n              console.error(\"Error deleting appointment:\", error);\n              const errorMessage = error?.message || error?.body?.message || \"Failed to delete appointment\";\n              notify(`Failed to delete appointment: ${errorMessage}`, { type: \"error\" });\n            },\n          }\n        );\n      } catch (error) {\n        console.error(\"Error in handleConfirmDelete:\", error);\n        notify(\"Failed to delete appointment\", { type: \"error\" });\n      } finally {\n        setIsDeleting(false);\n      }\n    },\n    [deletingAppointment, deleteAppointment, dataProvider, notify, refetchAppointments]\n  );\n\n\n  const handleModalClose = useCallback(() => {\n    setIsModalOpen(false);\n    setEditingAppointment(null);\n    setInitialDateTime(null);\n  }, []);\n\n  const handleModalSuccess = useCallback(() => {\n    setIsModalOpen(false);\n    const editedAppointmentId = editingAppointment?.id;\n    setEditingAppointment(null);\n    \n    // Refetch appointments to get updated data including staff_ids\n    refetchAppointments().then(() => {\n      // Update selectedAppointment if it was the one being edited\n      // We need to wait a bit for the enriched appointments to update\n      setTimeout(() => {\n        if (editedAppointmentId && selectedAppointment?.id === editedAppointmentId) {\n          // Find the updated appointment from enriched appointments\n          const updatedAppointment = enrichedAppointments.find(\n            (app) => app.id === editedAppointmentId\n          );\n          if (updatedAppointment) {\n            setSelectedAppointment(updatedAppointment);\n          }\n        }\n      }, 100);\n    });\n    \n    notify(\"Appointment saved successfully\", { type: \"success\" });\n  }, [notify, refetchAppointments, editingAppointment, selectedAppointment, enrichedAppointments]);\n\n  const handleDateNavigation = useCallback((direction: \"prev\" | \"next\" | \"today\") => {\n    if (direction === \"today\") {\n      // Get today's date at midnight in CRM timezone\n      const today = crmToday();\n      setCurrentDate(today);\n    } else if (direction === \"prev\") {\n      setCurrentDate((prev) => {\n        const newDate = new Date(prev);\n        if (calendarView === \"month\") {\n          newDate.setMonth(newDate.getMonth() - 1);\n        } else if (calendarView === \"week\") {\n          newDate.setDate(newDate.getDate() - 7);\n        } else {\n          newDate.setDate(newDate.getDate() - 1);\n        }\n        return newDate;\n      });\n    } else {\n      setCurrentDate((prev) => {\n        const newDate = new Date(prev);\n        if (calendarView === \"month\") {\n          newDate.setMonth(newDate.getMonth() + 1);\n        } else if (calendarView === \"week\") {\n          newDate.setDate(newDate.getDate() + 7);\n        } else {\n          newDate.setDate(newDate.getDate() + 1);\n        }\n        return newDate;\n      });\n    }\n  }, [calendarView]);\n\n  return (\n    <div className=\"min-h-screen bg-white dark:bg-slate-900 flex flex-col overflow-hidden\" style={{ \n      width: '95vw', \n      maxWidth: '95vw',\n      marginLeft: 'calc(-50vw + 50% + 2.5vw - 1rem)',\n      marginRight: 'calc(-50vw + 50% + 2.5vw - 1rem)'\n    }}>\n      {/* Error Banner */}\n      {showError && (\n        <div className=\"bg-amber-50 dark:bg-amber-950/20 border-b border-amber-200 dark:border-amber-800 px-6 py-4\">\n          <div className=\"max-w-7xl mx-auto\">\n            <p className=\"text-sm font-semibold text-amber-900 dark:text-amber-200 mb-2\">\n               Appointments table not found in database\n            </p>\n            <p className=\"text-xs text-amber-800 dark:text-amber-300 mb-2\">\n              {appointmentsError instanceof Error && appointmentsError.message.includes(\"schema cache\")\n                ? \"The appointments table needs to be created. Run the migration to fix this:\"\n                : \"The appointments resource is not available. Please apply the database migration.\"}\n            </p>\n            <div className=\"bg-amber-100 dark:bg-amber-900/30 rounded-lg p-3 text-xs font-mono text-amber-900 dark:text-amber-200\">\n              <p className=\"mb-1\">For local development:</p>\n              <p className=\"mb-1\">  make supabase-apply-appointments</p>\n              <p className=\"mb-1\">  or</p>\n              <p>  npx supabase migration up</p>\n              <p className=\"mt-2 mb-1\">For remote Supabase:</p>\n              <p>  npx supabase db push</p>\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* Main Content - Full Width */}\n      <div className=\"flex-1 flex flex-col h-full overflow-hidden w-full\">\n        {/* Top Bar - Filters, View Toggle, New Appointment */}\n        <div className=\"bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 py-4 flex-shrink-0\">\n          <div className=\"flex items-center justify-between\">\n            {/* Filters on Left */}\n            <div className=\"flex items-center\">\n              <AppointmentFiltersTop\n                filters={filters}\n                onFiltersChange={setFilters}\n                onApply={handleApplyFilters}\n              />\n            </div>\n\n            {/* View Toggle and New Appointment on Right */}\n            <div className=\"flex items-center gap-4\">\n              <div className=\"flex items-center bg-slate-100 dark:bg-slate-700 rounded-lg p-1\">\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setViewMode(\"calendar\")}\n                  className={`px-3 py-1.5 rounded-md transition-all text-xs ${\n                    viewMode === \"calendar\"\n                      ? \"bg-white dark:bg-slate-600 text-slate-900 dark:text-slate-100 shadow-sm\"\n                      : \"text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                  }`}\n                >\n                  <Grid3X3 className=\"w-3 h-3 mr-1.5\" />\n                  Calendar\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setViewMode(\"table\")}\n                  className={`px-3 py-1.5 rounded-md transition-all text-xs ${\n                    viewMode === \"table\"\n                      ? \"bg-white dark:bg-slate-600 text-slate-900 dark:text-slate-100 shadow-sm\"\n                      : \"text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                  }`}\n                >\n                  <List className=\"w-3 h-3 mr-1.5\" />\n                  Table\n                </Button>\n              </div>\n              <Button\n                onClick={handleNewAppointment}\n                className=\"inline-flex items-center justify-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 text-sm font-medium\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                New Appointment\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Navigation Bar - Date Controls and View Options */}\n        {viewMode === \"calendar\" && (\n          <div className=\"bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 py-3 flex-shrink-0\">\n            <div className=\"flex items-center justify-between relative\">\n              {/* Date Navigation on Left */}\n              <div className=\"flex items-center gap-2 flex-shrink-0\">\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => handleDateNavigation(\"prev\")}\n                  className=\"h-8 w-8 p-0\"\n                >\n                  <ChevronLeft className=\"w-4 h-4\" />\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant={isCurrentDateToday ? \"default\" : \"ghost\"}\n                  size=\"sm\"\n                  onClick={() => handleDateNavigation(\"today\")}\n                  className=\"h-8 px-3 text-xs\"\n                >\n                  Today\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => handleDateNavigation(\"next\")}\n                  className=\"h-8 w-8 p-0\"\n                >\n                  <ChevronRight className=\"w-4 h-4\" />\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setIsCalendarPopupOpen(!isCalendarPopupOpen)}\n                  className=\"h-8 w-8 p-0\"\n                >\n                  <CalendarIcon className=\"w-4 h-4\" />\n                </Button>\n              </div>\n\n              {/* Current Date and Appointment Count in Center - Absolutely Centered */}\n              <div className=\"absolute left-1/2 transform -translate-x-1/2 flex items-center gap-3\">\n                <div className=\"text-base font-medium text-slate-900 dark:text-slate-100 whitespace-nowrap\">\n                  {getDateDisplay()}\n                </div>\n                {shouldShowAppointmentBadge() && appointmentsForCurrentDate > 0 && (\n                  <div className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${\n                    isCurrentDateToday \n                      ? \"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300\"\n                      : \"bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300\"\n                  }`}>\n                    {appointmentsForCurrentDate} appointment{appointmentsForCurrentDate !== 1 ? 's' : ''}\n                  </div>\n                )}\n              </div>\n\n              {/* View Options on Right */}\n              <div className=\"flex items-center bg-slate-100 dark:bg-slate-700 rounded-lg p-1 flex-shrink-0\">\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setCalendarView(\"month\")}\n                  className={`px-3 py-1.5 rounded-md transition-all text-xs ${\n                    calendarView === \"month\"\n                      ? \"bg-white dark:bg-slate-600 text-slate-900 dark:text-slate-100 shadow-sm\"\n                      : \"text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                  }`}\n                >\n                  Month\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setCalendarView(\"week\")}\n                  className={`px-3 py-1.5 rounded-md transition-all text-xs ${\n                    calendarView === \"week\"\n                      ? \"bg-white dark:bg-slate-600 text-slate-900 dark:text-slate-100 shadow-sm\"\n                      : \"text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                  }`}\n                >\n                  Week\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setCalendarView(\"day\")}\n                  className={`px-3 py-1.5 rounded-md transition-all text-xs ${\n                    calendarView === \"day\"\n                      ? \"bg-white dark:bg-slate-600 text-slate-900 dark:text-slate-100 shadow-sm\"\n                      : \"text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                  }`}\n                >\n                  Day\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setCalendarView(\"list\")}\n                  className={`px-3 py-1.5 rounded-md transition-all text-xs ${\n                    calendarView === \"list\"\n                      ? \"bg-white dark:bg-slate-600 text-slate-900 dark:text-slate-100 shadow-sm\"\n                      : \"text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                  }`}\n                >\n                  List\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setViewMode(\"map\")}\n                  className={`px-3 py-1.5 rounded-md transition-all text-xs ${\n                    viewMode === \"map\"\n                      ? \"bg-white dark:bg-slate-600 text-slate-900 dark:text-slate-100 shadow-sm\"\n                      : \"text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                  }`}\n                >\n                  <Map className=\"w-3 h-3 mr-1.5\" />\n                  Map\n                </Button>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Map View Navigation Bar */}\n        {viewMode === \"map\" && (\n          <div className=\"bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 py-3 flex-shrink-0\">\n            <div className=\"flex items-center justify-between relative\">\n              {/* Date Navigation on Left */}\n              <div className=\"flex items-center gap-2 flex-shrink-0\">\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => {\n                    const newDate = new Date(currentDate);\n                    newDate.setDate(newDate.getDate() - 1);\n                    setCurrentDate(newDate);\n                  }}\n                  className=\"h-8 w-8 p-0\"\n                >\n                  <ChevronLeft className=\"w-4 h-4\" />\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant={isCurrentDateToday ? \"default\" : \"ghost\"}\n                  size=\"sm\"\n                  onClick={() => handleDateNavigation(\"today\")}\n                  className=\"h-8 px-3 text-xs\"\n                >\n                  Today\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => {\n                    const newDate = new Date(currentDate);\n                    newDate.setDate(newDate.getDate() + 1);\n                    setCurrentDate(newDate);\n                  }}\n                  className=\"h-8 w-8 p-0\"\n                >\n                  <ChevronRight className=\"w-4 h-4\" />\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setIsCalendarPopupOpen(!isCalendarPopupOpen)}\n                  className=\"h-8 w-8 p-0\"\n                >\n                  <CalendarIcon className=\"w-4 h-4\" />\n                </Button>\n              </div>\n\n              {/* Current Date and Appointment Count in Center - Absolutely Centered */}\n              <div className=\"absolute left-1/2 transform -translate-x-1/2 flex items-center gap-3\">\n                <div className=\"text-base font-medium text-slate-900 dark:text-slate-100 whitespace-nowrap\">\n                  {getDateDisplay()}\n                </div>\n                <div className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${\n                  isCurrentDateToday \n                    ? \"bg-orange-500 text-white\"\n                    : \"bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-300\"\n                }`}>\n                  {appointmentsForCurrentDate} appointment{appointmentsForCurrentDate !== 1 ? 's' : ''}\n                </div>\n              </div>\n\n              {/* View Options on Right */}\n              <div className=\"flex items-center bg-slate-100 dark:bg-slate-700 rounded-lg p-1 flex-shrink-0\">\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => {\n                    setViewMode(\"calendar\");\n                    setCalendarView(\"month\");\n                  }}\n                  className=\"px-3 py-1.5 rounded-md transition-all text-xs text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                >\n                  Month\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => {\n                    setViewMode(\"calendar\");\n                    setCalendarView(\"week\");\n                  }}\n                  className=\"px-3 py-1.5 rounded-md transition-all text-xs text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                >\n                  Week\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => {\n                    setViewMode(\"calendar\");\n                    setCalendarView(\"day\");\n                  }}\n                  className=\"px-3 py-1.5 rounded-md transition-all text-xs text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                >\n                  Day\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => {\n                    setViewMode(\"calendar\");\n                    setCalendarView(\"list\");\n                  }}\n                  className=\"px-3 py-1.5 rounded-md transition-all text-xs text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                >\n                  List\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className={`px-3 py-1.5 rounded-md transition-all text-xs ${\n                    viewMode === \"map\"\n                      ? \"bg-white dark:bg-slate-600 text-slate-900 dark:text-slate-100 shadow-sm\"\n                      : \"text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100\"\n                  }`}\n                >\n                  <Map className=\"w-3 h-3 mr-1.5\" />\n                  Map\n                </Button>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Calendar, Table, or Map View - Full Width */}\n        <div className=\"flex-1 flex flex-col min-h-0 overflow-hidden relative\">\n          {viewMode === \"calendar\" ? (\n            <AppointmentCalendar\n              appointments={safeAppointments}\n              loading={shouldShowLoading}\n              onAppointmentClick={handleAppointmentClick}\n              onAppointmentRightClick={handleAppointmentRightClick}\n              onAppointmentUpdate={refetchAppointments}\n              onDateSelect={(start, end) => handleNewAppointment(start, end)}\n              currentDate={currentDate}\n              view={calendarView}\n              onDateChange={setCurrentDate}\n            />\n          ) : viewMode === \"map\" ? (\n            <AppointmentMapView\n              appointments={safeAppointments}\n              loading={shouldShowLoading}\n              onAppointmentClick={handleAppointmentClick}\n              selectedDate={currentDate}\n              onDateChange={setCurrentDate}\n            />\n          ) : (\n            <VirtualizedTable\n              appointments={safeAppointments}\n              loading={shouldShowLoading}\n              onAppointmentClick={handleAppointmentClick}\n            />\n          )}\n          \n          {/* Calendar Popup Overlay - Available in all views */}\n          {isCalendarPopupOpen && (\n            <CalendarPopup\n              selectedDate={currentDate}\n              onDateSelect={(date) => {\n                // Ensure we create a new date object to trigger re-renders\n                const newDate = new Date(date);\n                setCurrentDate(newDate);\n                setIsCalendarPopupOpen(false);\n              }}\n              onClose={() => setIsCalendarPopupOpen(false)}\n            />\n          )}\n        </div>\n      </div>\n\n      {/* Modals and Drawers */}\n      <AppointmentModal\n        open={isModalOpen}\n        onClose={handleModalClose}\n        appointment={editingAppointment}\n        initialDateTime={initialDateTime}\n        onSuccess={handleModalSuccess}\n      />\n\n      <AppointmentDetailsDrawer\n        open={isDrawerOpen}\n        onClose={() => {\n          setIsDrawerOpen(false);\n          setSelectedAppointment(null);\n        }}\n        appointment={selectedAppointment}\n        onEdit={handleEditAppointment}\n        onDelete={handleDeleteAppointment}\n      />\n\n      {contextMenu && (\n        <AppointmentContextMenu\n          appointment={contextMenu.appointment}\n          x={contextMenu.x}\n          y={contextMenu.y}\n          onClose={() => setContextMenu(null)}\n          onEdit={handleEditAppointment}\n          onDelete={handleDeleteAppointment}\n        />\n      )}\n\n      <AppointmentDeleteDialog\n        open={isDeleteDialogOpen}\n        onClose={() => {\n          setIsDeleteDialogOpen(false);\n          setDeletingAppointment(null);\n        }}\n        appointment={deletingAppointment}\n        onConfirm={handleConfirmDelete}\n        isDeleting={isDeleting}\n      />\n\n    </div>\n  );\n};\n\nAppointmentsPage.path = \"/appointments\";\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentModal.tsx",
      "content": "import React, { useState } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { AppointmentForm } from \"./AppointmentForm\";\nimport { AppointmentEditDialog } from \"./AppointmentEditDialog\";\nimport type { Appointment, RecurrenceConfig } from \"../types\";\nimport { useCreate, useUpdate, useNotify, useDataProvider } from \"ra-core\";\nimport { crmDateTimeStringToISO } from \"../misc/timezone\";\nimport { logger } from \"@/lib/logger\";\nimport { useAppointmentTypes } from \"./useAppointmentTypes\";\nimport { useQueryClient } from \"@tanstack/react-query\";\n\ntype AppointmentFormData = {\n  patient_id: string;\n  appointment_date: string;\n  start_time: string;\n  end_time: string;\n  duration_minutes: number;\n  appointment_type: string[]; // Changed to array for multiple types\n  status: string;\n  notes?: string;\n  mini_notes?: string;\n  full_notes?: string;\n  pickup_instructions?: string;\n  primary_staff_id?: string;\n  driver_id?: string;\n  staff_ids?: string[];\n  payment_package_id?: string;\n  is_recurring?: boolean;\n  recurrence_pattern?: \"daily\" | \"weekly\" | \"monthly\" | \"yearly\" | \"custom\";\n  recurrence_interval?: number;\n  recurrence_end_type?: \"date\" | \"occurrences\";\n  recurrence_end_date?: string;\n  recurrence_occurrences?: number | string;\n  recurrence_days_of_week?: number[];\n  recurrence_day_of_month?: number;\n  recurrence_week_of_month?: number;\n  recurrence_month?: number;\n  recurrence_custom_unit?: \"days\" | \"weeks\" | \"months\";\n};\n\ntype AppointmentData = {\n  patient_id: number;\n  appointment_date: string;\n  start_time: string;\n  end_time: string;\n  duration_minutes: number;\n  appointment_type: string;\n  status: string;\n  notes?: string | null;\n  mini_notes?: string | null;\n  full_notes?: string | null;\n  pickup_instructions?: string | null;\n  primary_staff_id?: number | null;\n  driver_id?: number | null;\n  payment_package_id?: number | null;\n  recurrence_config?: RecurrenceConfig | null;\n  is_recurring: boolean;\n  // Note: staff_ids is NOT a database column - it's handled via appointment_staff_assignments table\n};\n\ntype AppointmentModalProps = {\n  open: boolean;\n  onClose: () => void;\n  appointment?: Appointment | null;\n  initialDateTime?: { start: Date; end: Date } | null;\n  onSuccess: () => void;\n};\n\nexport const AppointmentModal: React.FC<AppointmentModalProps> = ({\n  open,\n  onClose,\n  appointment,\n  initialDateTime,\n  onSuccess,\n}) => {\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [pendingFormData, setPendingFormData] = useState<AppointmentFormData | null>(null);\n  const [updateFutureOnly, setUpdateFutureOnly] = useState(false);\n  const [create] = useCreate();\n  const [update] = useUpdate();\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const appointmentTypes = useAppointmentTypes();\n  const queryClient = useQueryClient();\n\n  const isRecurring = appointment && (appointment.is_recurring || !!appointment.recurrence_id);\n\n  const performUpdate = async (formData: AppointmentFormData, updateFuture: boolean = false) => {\n    setIsSubmitting(true);\n    setError(null);\n    try {\n      // For recurring appointments, preserve the original date - only update time and other fields\n      let appointmentDate = formData.appointment_date; // YYYY-MM-DD\n      if (appointment && isRecurring) {\n        // Keep the original appointment date - don't change it\n        appointmentDate = appointment.appointment_date.split(\"T\")[0];\n      }\n      \n      const startTime = formData.start_time; // HH:MM\n      const endTime = formData.end_time; // HH:MM\n\n      // Create ISO datetime strings: YYYY-MM-DDTHH:MM:SS\n      const startDateTime = `${appointmentDate}T${startTime}:00`;\n      const endDateTime = `${appointmentDate}T${endTime}:00`;\n\n      // Convert to proper timezone-aware ISO strings using timezone utility\n      const startDateTimeISO = crmDateTimeStringToISO(startDateTime);\n      const endDateTimeISO = crmDateTimeStringToISO(endDateTime);\n\n      if (!startDateTimeISO || !endDateTimeISO) {\n        throw new Error(\"Invalid date/time format\");\n      }\n\n      // Prepare the appointment data (exclude staff_ids - it's not a database column)\n      const staffIds = formData.staff_ids?.map((id: string) => parseInt(id, 10)) || [];\n\n      // Build recurrence config if recurring appointment\n      let recurrenceConfig: RecurrenceConfig | undefined = undefined;\n      if (formData.is_recurring) {\n        const endType = formData.recurrence_end_type || \"occurrences\";\n        // Parse occurrences - handle string, number, or undefined\n        let occurrencesValue: number | null = null;\n        if (endType === \"occurrences\") {\n          const rawValue = formData.recurrence_occurrences;\n          if (rawValue !== null && rawValue !== undefined && rawValue !== \"\") {\n            const parsed = Number(rawValue);\n            occurrencesValue = isNaN(parsed) || parsed <= 0 ? 10 : parsed;\n          } else {\n            occurrencesValue = 10; // Default to 10 if not set\n          }\n        }\n        \n        recurrenceConfig = {\n          pattern: formData.recurrence_pattern || \"daily\",\n          interval: formData.recurrence_interval || 1,\n          end_type: endType,\n          end_date: endType === \"date\" ? (formData.recurrence_end_date || null) : null,\n          occurrences: occurrencesValue,\n          days_of_week: formData.recurrence_days_of_week && formData.recurrence_days_of_week.length > 0\n            ? formData.recurrence_days_of_week\n            : null,\n          day_of_month: formData.recurrence_day_of_month || null,\n          week_of_month: formData.recurrence_week_of_month || null,\n          month: formData.recurrence_month || null,\n          custom_unit: formData.recurrence_custom_unit || null,\n        };\n      }\n\n      // Handle multiple appointment types - convert service IDs to appointment types\n      // The form now uses service IDs (e.g., \"service_123\") as values, so we need to map them back\n      let appointmentType = \"doctor_on_call\"; // Default\n      \n      // Extract selected service IDs to store in custom_fields\n      const selectedServiceIds: number[] = [];\n      \n      if (Array.isArray(formData.appointment_type) && formData.appointment_type.length > 0) {\n        // Extract service IDs from selected values\n        formData.appointment_type.forEach((value) => {\n          if (typeof value === \"string\" && value.startsWith(\"service_\")) {\n            const serviceId = parseInt(value.replace(\"service_\", \"\"), 10);\n            if (!isNaN(serviceId)) {\n              selectedServiceIds.push(serviceId);\n            }\n          }\n        });\n        \n        // Find the first selected service and get its appointment type\n        const firstSelectedValue = formData.appointment_type[0];\n        const selectedType = appointmentTypes.find(t => t.value === firstSelectedValue);\n        if (selectedType?.appointmentType) {\n          appointmentType = selectedType.appointmentType;\n        } else if (firstSelectedValue.startsWith(\"service_\")) {\n          // Fallback: if it's a service ID format, try to extract and find the type\n          const serviceId = firstSelectedValue.replace(\"service_\", \"\");\n          const foundType = appointmentTypes.find(t => t.serviceId?.toString() === serviceId);\n          if (foundType?.appointmentType) {\n            appointmentType = foundType.appointmentType;\n          }\n        }\n      } else if (formData.appointment_type && typeof formData.appointment_type === \"string\") {\n        // Handle single string value (backward compatibility)\n        if (formData.appointment_type.startsWith(\"service_\")) {\n          const serviceId = parseInt(formData.appointment_type.replace(\"service_\", \"\"), 10);\n          if (!isNaN(serviceId)) {\n            selectedServiceIds.push(serviceId);\n          }\n          const foundType = appointmentTypes.find(t => t.serviceId?.toString() === serviceId.toString());\n          if (foundType?.appointmentType) {\n            appointmentType = foundType.appointmentType;\n          }\n        } else {\n          appointmentType = formData.appointment_type;\n        }\n      }\n\n      // Store selected service IDs in custom_fields so we can display only the selected services\n      // ALWAYS save selected_service_ids, even if empty, to prevent bundling issues\n      const customFields = appointment?.custom_fields || {};\n      const updatedCustomFields = {\n        ...customFields,\n        selected_service_ids: selectedServiceIds.length > 0 ? selectedServiceIds : [],\n      };\n      \n      const appointmentData: AppointmentData = {\n        patient_id: parseInt(formData.patient_id, 10),\n        appointment_date: startDateTimeISO.split(\"T\")[0], // Store date part only\n        start_time: startDateTimeISO,\n        end_time: endDateTimeISO,\n        duration_minutes: formData.duration_minutes,\n        appointment_type: appointmentType,\n        status: formData.status || \"scheduled\",\n        notes: formData.notes || null,\n        mini_notes: formData.mini_notes || null,\n        full_notes: formData.full_notes || null,\n        pickup_instructions: formData.pickup_instructions || null,\n        primary_staff_id: formData.primary_staff_id ? parseInt(formData.primary_staff_id, 10) : null,\n        driver_id: formData.driver_id ? parseInt(formData.driver_id, 10) : null,\n        payment_package_id: formData.payment_package_id ? parseInt(formData.payment_package_id, 10) : null,\n        custom_fields: updatedCustomFields,\n        // Include recurrence config if present\n        recurrence_config: recurrenceConfig || null,\n        is_recurring: !!formData.is_recurring,\n        // Note: staff_ids is NOT included here - it's handled separately via appointment_staff_assignments table\n      };\n\n      logger.debug(\"Saving appointment\", { appointmentData, recurrenceConfig });\n\n      if (appointment) {\n        // Update appointment - pass updateFutureOnly flag via meta for recurring appointments\n        await update(\n          \"appointments\",\n          {\n            id: appointment.id,\n            data: appointmentData,\n            previousData: appointment,\n            meta: isRecurring ? { updateFutureOnly: updateFuture } : undefined,\n          },\n          {\n            onSuccess: async (result: any) => {\n              // Update staff assignments for current appointment\n              const appointmentId = appointment.id;\n              const futureAppointmentIds = result?.meta?.futureAppointmentIds || [];\n              const appointmentsToUpdate = [appointmentId, ...futureAppointmentIds];\n              \n              try {\n                // Update staff assignments for all appointments (current + future if updateFutureOnly)\n                for (const aptId of appointmentsToUpdate) {\n                  // Delete existing assignments\n                  const { data: existingAssignments } = await dataProvider.getList(\"appointment_staff_assignments\", {\n                    pagination: { page: 1, perPage: 1000 },\n                    filter: { appointment_id: aptId },\n                  });\n                  \n                  for (const assignment of existingAssignments || []) {\n                    await dataProvider.delete(\"appointment_staff_assignments\", { id: assignment.id });\n                  }\n                  \n                  // Create new assignments\n                  for (const staffId of staffIds) {\n                    await dataProvider.create(\"appointment_staff_assignments\", {\n                      data: {\n                        appointment_id: aptId,\n                        staff_id: staffId,\n                        role: \"other\",\n                      },\n                    });\n                  }\n                }\n                \n                // Invalidate queries to refresh appointments and staff assignments\n                queryClient.invalidateQueries({\n                  predicate: ({ queryKey }) =>\n                    Array.isArray(queryKey) && (\n                      queryKey[0] === \"appointments\" || \n                      queryKey[0] === \"appointment_staff_assignments\"\n                    ),\n                });\n              } catch (staffError) {\n                logger.error(\"Error updating staff assignments\", staffError, { context: \"AppointmentModal\" });\n                // Don't fail the whole update if staff assignments fail\n              }\n              \n              const message = updateFuture && futureAppointmentIds.length > 0\n                ? `Appointment and ${futureAppointmentIds.length} future appointment(s) updated successfully`\n                : \"Appointment updated successfully\";\n              notify(message, { type: \"success\" });\n              onSuccess();\n            },\n            onError: (error: unknown) => {\n              logger.error(\"Error updating appointment\", error, { context: \"AppointmentModal\" });\n              const errorMessage = error instanceof Error \n                ? error.message \n                : (typeof error === \"object\" && error !== null && \"body\" in error && typeof error.body === \"object\" && error.body !== null && \"message\" in error.body && typeof error.body.message === \"string\")\n                  ? error.body.message\n                  : \"Failed to update appointment\";\n              setError(errorMessage);\n              notify(`Failed to update appointment: ${errorMessage}`, { type: \"error\" });\n            },\n          }\n        );\n      } else {\n        // Create new appointment\n        await create(\n          \"appointments\",\n          {\n            data: appointmentData,\n          },\n          {\n            onSuccess: async (result: { id: string | number }) => {\n              const appointmentId = result.id;\n              \n              // Create staff assignments\n              try {\n                for (const staffId of staffIds) {\n                  await dataProvider.create(\"appointment_staff_assignments\", {\n                    data: {\n                      appointment_id: appointmentId,\n                      staff_id: staffId,\n                      role: \"other\",\n                    },\n                  });\n                }\n                \n                // Invalidate queries to refresh appointments and staff assignments\n                queryClient.invalidateQueries({\n                  predicate: ({ queryKey }) =>\n                    Array.isArray(queryKey) && (\n                      queryKey[0] === \"appointments\" || \n                      queryKey[0] === \"appointment_staff_assignments\"\n                    ),\n                });\n              } catch (staffError) {\n                logger.error(\"Error creating staff assignments\", staffError, { context: \"AppointmentModal\" });\n                notify(\"Appointment created but staff assignments failed\", { type: \"warning\" });\n              }\n              \n              notify(\"Appointment created successfully\", { type: \"success\" });\n              onSuccess();\n            },\n            onError: (error: unknown) => {\n              logger.error(\"Error creating appointment\", error, { context: \"AppointmentModal\" });\n              const errorMessage = error instanceof Error \n                ? error.message \n                : (typeof error === \"object\" && error !== null && \"body\" in error && typeof error.body === \"object\" && error.body !== null && \"message\" in error.body && typeof error.body.message === \"string\")\n                  ? error.body.message\n                  : \"Failed to create appointment\";\n              setError(errorMessage);\n              notify(`Failed to create appointment: ${errorMessage}`, { type: \"error\" });\n            },\n          }\n        );\n      }\n    } catch (err) {\n      logger.error(\"Error in performUpdate\", err, { context: \"AppointmentModal\" });\n      setError(err instanceof Error ? err.message : \"Failed to save appointment\");\n      notify(\"Failed to save appointment\", { type: \"error\" });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleSubmit = async (formData: AppointmentFormData) => {\n    // If editing a recurring appointment, show the edit dialog first\n    if (appointment && isRecurring) {\n      setPendingFormData(formData);\n      setShowEditDialog(true);\n      return;\n    }\n    \n    // For non-recurring or new appointments, proceed directly\n    if (appointment) {\n      await performUpdate(formData, false);\n    } else {\n      // Create new appointment - use existing create logic\n      await performUpdate(formData, false);\n    }\n  };\n\n  const handleEditDialogConfirm = async (updateFuture: boolean) => {\n    setShowEditDialog(false);\n    if (pendingFormData) {\n      await performUpdate(pendingFormData, updateFuture);\n      setPendingFormData(null);\n    }\n  };\n\n  const handleEditDialogClose = () => {\n    setShowEditDialog(false);\n    setPendingFormData(null);\n  };\n\n  return (\n    <>\n      <AppointmentEditDialog\n        open={showEditDialog}\n        onClose={handleEditDialogClose}\n        appointment={appointment}\n        onConfirm={handleEditDialogConfirm}\n        isSubmitting={isSubmitting}\n      />\n      <Dialog open={open} onOpenChange={onClose}>\n        <DialogContent className=\"!w-[33vw] !max-w-[600px] min-w-[500px] max-h-[90vh] overflow-hidden flex flex-col p-0 gap-0 bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 shadow-2xl rounded-xl\">\n        {/* Compact Header */}\n        <DialogHeader className=\"px-6 pt-6 pb-4 border-b border-slate-200 dark:border-slate-700\">\n          <DialogTitle className=\"text-2xl font-bold text-slate-900 dark:text-slate-100\">\n            {appointment ? \"Edit Appointment\" : \"New Appointment\"}\n          </DialogTitle>\n          <DialogDescription className=\"mt-1 text-slate-600 dark:text-slate-400 text-sm\">\n            {appointment ? \"Update appointment details\" : \"Create a new appointment\"}\n          </DialogDescription>\n        </DialogHeader>\n\n        {/* Scrollable Content */}\n        <div className=\"flex-1 overflow-y-auto px-6 py-4\">\n          {error && (\n            <div className=\"mb-6 p-4 bg-red-50 dark:bg-red-950/20 border border-red-200 dark:border-red-800 rounded-xl text-red-700 dark:text-red-300 text-sm shadow-sm\">\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-lg\"></span>\n                <span>{error}</span>\n              </div>\n            </div>\n          )}\n          <AppointmentForm\n            appointment={appointment}\n            initialDateTime={initialDateTime}\n            onSubmit={handleSubmit}\n            isSubmitting={isSubmitting}\n          />\n        </div>\n\n        {/* Compact Footer */}\n        <DialogFooter className=\"px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex items-center justify-end gap-3\">\n          <Button \n            variant=\"outline\" \n            onClick={onClose} \n            disabled={isSubmitting}\n            className=\"px-6 py-2.5 rounded-xl border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all\"\n          >\n            Cancel\n          </Button>\n          <Button\n            type=\"submit\"\n            form=\"appointment-form\"\n            disabled={isSubmitting}\n            className=\"px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl shadow-lg shadow-blue-500/25 hover:shadow-xl hover:shadow-blue-500/30 transition-all duration-200 font-medium disabled:opacity-50\"\n          >\n            {isSubmitting ? (\n              <span className=\"flex items-center gap-2\">\n                <svg className=\"animate-spin h-4 w-4\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                  <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                </svg>\n                Saving...\n              </span>\n            ) : (\n              \"Save Appointment\"\n            )}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n    </>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentMarker.tsx",
      "content": "import React, { useRef, useEffect, useState, useMemo } from \"react\";\nimport { Marker, useMap } from \"react-leaflet\";\nimport L from \"leaflet\";\nimport type { Appointment, Contact, Staff } from \"../types\";\nimport { APPOINTMENT_TYPES, APPOINTMENT_STATUSES } from \"./types\";\nimport { format } from \"date-fns\";\n\ntype AppointmentMarkerProps = {\n  position: [number, number];\n  appointment: Appointment;\n  patient: Contact | null;\n  staff: Staff | null;\n  isSelected: boolean;\n  isHovered: boolean;\n  isToday?: boolean;\n  onClick: () => void;\n  onHover: (hovered: boolean) => void;\n};\n\n// Status colors\nconst STATUS_COLORS: Record<string, string> = {\n  completed: \"#10b981\",\n  cancelled: \"#ef4444\",\n  scheduled: \"#f59e0b\",\n};\n\n// Appointment type colors\nconst TYPE_COLORS: Record<string, string> = {\n  doctor_on_call: \"#3b82f6\",\n  lab_test: \"#10b981\",\n  teleconsultation: \"#8b5cf6\",\n  physiotherapy: \"#f59e0b\",\n  caregiver: \"#ef4444\",\n  iv_therapy: \"#06b6d4\",\n};\n\n// Create custom marker icon\nconst createMarkerIcon = (\n  status: string,\n  type: string,\n  time: string,\n  isSelected: boolean,\n  isHovered: boolean,\n  isToday: boolean = false\n): L.DivIcon => {\n  // Use orange for today's appointments\n  const statusColor = isToday ? \"#f97316\" : (STATUS_COLORS[status] || \"#6b7280\");\n  const typeColor = TYPE_COLORS[type] || \"#6b7280\";\n  const scale = isHovered ? 1.25 : 1;\n  const size = 48 * scale;\n  const pointerSize = 8 * scale;\n  \n  // Status indicator dot\n  const statusDot = `\n    <div style=\"\n      position: absolute;\n      top: 2px;\n      right: 2px;\n      width: 6px;\n      height: 6px;\n      background-color: ${statusColor};\n      border: 2px solid white;\n      border-radius: 50%;\n      box-shadow: 0 1px 3px rgba(0,0,0,0.3);\n      z-index: 10;\n    \"></div>\n  `;\n  \n  // Selection ring\n  const selectionRing = isSelected ? `\n    <div style=\"\n      position: absolute;\n      top: -4px;\n      left: -4px;\n      width: ${size + 8}px;\n      height: ${size + 8}px;\n      border: 4px solid rgba(59, 130, 246, 0.3);\n      border-radius: 12px;\n      pointer-events: none;\n      z-index: -1;\n    \"></div>\n  ` : \"\";\n  \n  // Hover glow\n  const hoverGlow = isHovered ? `\n    <div style=\"\n      position: absolute;\n      top: -2px;\n      left: -2px;\n      width: ${size + 4}px;\n      height: ${size + 4}px;\n      border: 2px solid rgba(255, 255, 255, 0.5);\n      border-radius: 10px;\n      pointer-events: none;\n      z-index: -1;\n    \"></div>\n  ` : \"\";\n  \n  // Inner glow effect\n  const innerGlow = `\n    <div style=\"\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: radial-gradient(circle at center, rgba(255,255,255,0.2) 0%, transparent 70%);\n      border-radius: 8px;\n      pointer-events: none;\n    \"></div>\n  `;\n  \n  const borderColor = isSelected ? \"#3B82F6\" : typeColor;\n  \n  return L.divIcon({\n    className: \"appointment-marker\",\n    html: `\n      <div style=\"\n        position: relative;\n        width: ${size}px;\n        height: ${size}px;\n        transform: scale(${scale});\n        transition: transform 0.3s ease-out;\n      \">\n        ${selectionRing}\n        ${hoverGlow}\n        <div style=\"\n          position: relative;\n          width: ${size}px;\n          height: ${size}px;\n          background-color: ${statusColor};\n          border: 2.5px solid ${borderColor};\n          border-radius: 8px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          box-shadow: ${isSelected \n            ? \"0 4px 12px rgba(59, 130, 246, 0.4), 0 2px 4px rgba(0,0,0,0.2)\" \n            : \"0 2px 8px rgba(0,0,0,0.15)\"};\n          cursor: pointer;\n          font-family: Arial, sans-serif;\n          font-weight: bold;\n          font-size: ${12 * scale}px;\n          color: white;\n          text-shadow: \n            -1px -1px 0 #000,\n            1px -1px 0 #000,\n            -1px 1px 0 #000,\n            1px 1px 0 #000;\n        \">\n          ${innerGlow}\n          ${statusDot}\n          <div style=\"\n            position: relative;\n            z-index: 1;\n            text-align: center;\n            line-height: 1;\n          \">${time}</div>\n        </div>\n        <div style=\"\n          position: absolute;\n          bottom: -${pointerSize}px;\n          left: 50%;\n          transform: translateX(-50%);\n          width: 0;\n          height: 0;\n          border-left: ${pointerSize}px solid transparent;\n          border-right: ${pointerSize}px solid transparent;\n          border-top: ${pointerSize}px solid ${statusColor};\n          filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));\n        \"></div>\n      </div>\n    `,\n    iconSize: [size, size + pointerSize],\n    iconAnchor: [size / 2, size + pointerSize],\n    popupAnchor: [0, -(size + pointerSize)],\n  });\n};\n\nexport const AppointmentMarker: React.FC<AppointmentMarkerProps> = ({\n  position,\n  appointment,\n  isSelected,\n  isHovered,\n  isToday = false,\n  onClick,\n  onHover,\n}) => {\n  const markerRef = useRef<L.Marker>(null);\n  const [isAnimating, setIsAnimating] = useState(false);\n  \n  // Format time\n  const time = useMemo(() => {\n    try {\n      const timeStr = appointment.start_time;\n      if (timeStr) {\n        // Handle both HH:MM:SS and HH:MM formats\n        const parts = timeStr.split(\":\");\n        if (parts.length >= 2) {\n          return `${parts[0]}:${parts[1]}`;\n        }\n      }\n      return \"00:00\";\n    } catch {\n      return \"00:00\";\n    }\n  }, [appointment.start_time]);\n  \n  // Update icon when state changes\n  useEffect(() => {\n    if (markerRef.current) {\n      const icon = createMarkerIcon(\n        appointment.status,\n        appointment.appointment_type,\n        time,\n        isSelected,\n        isHovered,\n        isToday\n      );\n      markerRef.current.setIcon(icon);\n    }\n  }, [appointment.status, appointment.appointment_type, time, isSelected, isHovered, isToday]);\n  \n  // Bounce animation on hover\n  useEffect(() => {\n    if (isHovered && !isAnimating) {\n      setIsAnimating(true);\n      const marker = markerRef.current;\n      if (marker) {\n        const element = marker.getElement();\n        if (element) {\n          element.style.animation = \"bounce 0.75s ease-out\";\n          setTimeout(() => {\n            if (element) {\n              element.style.animation = \"\";\n            }\n            setIsAnimating(false);\n          }, 750);\n        }\n      }\n    }\n  }, [isHovered, isAnimating]);\n  \n  // Ripple effect on click\n  const handleClick = () => {\n    const marker = markerRef.current;\n    if (marker) {\n      const element = marker.getElement();\n      if (element) {\n        // Add ripple animation\n        element.style.animation = \"ping 0.6s ease-out\";\n        setTimeout(() => {\n          if (element) {\n            element.style.animation = \"\";\n          }\n        }, 600);\n      }\n    }\n    onClick();\n  };\n  \n  return (\n    <>\n      <Marker\n        ref={markerRef}\n        position={position}\n        icon={createMarkerIcon(\n          appointment.status,\n          appointment.appointment_type,\n          time,\n          isSelected,\n          isHovered,\n          isToday\n        )}\n        eventHandlers={{\n          click: handleClick,\n          mouseover: () => onHover(true),\n          mouseout: () => onHover(false),\n        }}\n      />\n      <style>{`\n        @keyframes bounce {\n          0%, 100% { transform: translateY(0) scale(1); }\n          25% { transform: translateY(-8px) scale(1.05); }\n          50% { transform: translateY(-4px) scale(1.02); }\n          75% { transform: translateY(-2px) scale(1.01); }\n        }\n        \n        @keyframes ping {\n          0% { transform: scale(1); opacity: 1; }\n          50% { transform: scale(1.2); opacity: 0.7; }\n          100% { transform: scale(1.4); opacity: 0; }\n        }\n        \n        .appointment-marker {\n          background: transparent !important;\n          border: none !important;\n        }\n      `}</style>\n    </>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentMapView.tsx",
      "content": "import React, { useMemo, useState, useCallback, useRef, useEffect } from \"react\";\nimport { ChevronLeft, ChevronRight, Calendar, MapPin } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { format, addDays, subDays, startOfDay, isToday } from \"date-fns\";\nimport type { Appointment, Contact, Staff } from \"../types\";\nimport { useGetList } from \"ra-core\";\nimport { AppointmentInfoWindow } from \"./AppointmentInfoWindow\";\nimport { extractCrmTime } from \"../misc/timezone\";\nimport { useOfficeLocation } from \"@/hooks/useOfficeLocation\";\n\n// Google Maps types\ndeclare global {\n  interface Window {\n    google: typeof google;\n    initMap: () => void;\n  }\n}\n\ntype AppointmentMapViewProps = {\n  appointments: Appointment[];\n  loading: boolean;\n  onAppointmentClick: (appointment: Appointment) => void;\n  selectedDate?: Date;\n  onDateChange?: (date: Date) => void;\n};\n\n// Default center (Dubai) - fallback if office location not available\nconst DEFAULT_CENTER = { lat: 25.2048, lng: 55.2708 };\n// Calculate zoom level for 1.5km scale (approximately zoom 13)\nconst DEFAULT_ZOOM = 13;\n\n// Status colors\nconst STATUS_COLORS: Record<string, string> = {\n  completed: \"#10b981\",\n  cancelled: \"#ef4444\",\n  scheduled: \"#f59e0b\",\n};\n\n// Appointment type colors\nconst TYPE_COLORS: Record<string, string> = {\n  doctor_on_call: \"#3b82f6\",\n  lab_test: \"#10b981\",\n  teleconsultation: \"#8b5cf6\",\n  physiotherapy: \"#f59e0b\",\n  caregiver: \"#ef4444\",\n  iv_therapy: \"#06b6d4\",\n};\n\n// Helper to get coordinates from patient\nconst getPatientCoordinates = (patient: Contact | null): { lat: number; lng: number } | null => {\n  if (!patient) return null;\n  \n  if (patient.latitude != null && patient.longitude != null) {\n    const lat = typeof patient.latitude === \"string\" ? parseFloat(patient.latitude) : patient.latitude;\n    const lng = typeof patient.longitude === \"string\" ? parseFloat(patient.longitude) : patient.longitude;\n    \n    if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {\n      return { lat, lng };\n    }\n  }\n  \n  return null;\n};\n\n// Helper to get fallback coordinates with random offset\n// Takes office location as parameter to use configured office location\nconst getFallbackCoordinates = (officeLocation?: { latitude: number; longitude: number } | null): { lat: number; lng: number } => {\n  const center = officeLocation \n    ? { lat: officeLocation.latitude, lng: officeLocation.longitude }\n    : DEFAULT_CENTER;\n  const offsetLat = (Math.random() - 0.5) * 0.01; // ~1km offset\n  const offsetLng = (Math.random() - 0.5) * 0.01;\n  return { lat: center.lat + offsetLat, lng: center.lng + offsetLng };\n};\n\n// Helper to format time as HH:MM in CRM timezone\nconst formatTimeForMarker = (timeStr: string | null | undefined): string => {\n  if (!timeStr) return \"00:00\";\n  \n  try {\n    // Parse the ISO string to a Date object and extract time in CRM timezone\n    // This ensures the time displayed matches the calendar views (8:00 AM instead of 4:00 AM UTC)\n    const date = new Date(timeStr);\n    if (isNaN(date.getTime())) {\n      return \"00:00\";\n    }\n    return extractCrmTime(date);\n  } catch {\n    return \"00:00\";\n  }\n};\n\n// Factory function to create the AppointmentMarkerOverlay class\n// This ensures google.maps is available before the class is defined\nconst createAppointmentMarkerOverlay = () => {\n  if (!window.google || !window.google.maps || !window.google.maps.OverlayView) {\n    throw new Error(\"Google Maps API and OverlayView must be loaded before creating AppointmentMarkerOverlay\");\n  }\n\n  // Custom marker class for Google Maps\n  class AppointmentMarkerOverlay extends window.google.maps.OverlayView {\n    private appointment: Appointment;\n    private position: { lat: number; lng: number };\n    private div: HTMLElement | null = null;\n    private onClick: () => void;\n    private onHover: (hovered: boolean) => void;\n    private isSelected: boolean;\n    private isHovered: boolean;\n    private isToday: boolean;\n    private time: string;\n\n  constructor(\n    appointment: Appointment,\n    position: { lat: number; lng: number },\n    time: string,\n    isSelected: boolean,\n    isHovered: boolean,\n    isToday: boolean,\n    onClick: () => void,\n    onHover: (hovered: boolean) => void\n  ) {\n    super();\n    this.appointment = appointment;\n    this.position = position;\n    this.time = time;\n    this.isSelected = isSelected;\n    this.isHovered = isHovered;\n    this.isToday = isToday;\n    this.onClick = onClick;\n    this.onHover = onHover;\n  }\n\n  onAdd(): void {\n    const div = document.createElement(\"div\");\n    div.style.position = \"absolute\";\n    div.style.cursor = \"pointer\";\n    // Dynamic z-index: selected > hovered > normal\n    // Use higher base z-index to ensure markers are above map tiles\n    div.style.zIndex = this.isSelected ? \"2000\" : (this.isHovered ? \"1500\" : \"1000\");\n    \n    const statusColor = this.isToday ? \"#f97316\" : (STATUS_COLORS[this.appointment.status] || \"#6b7280\");\n    const typeColor = TYPE_COLORS[this.appointment.appointment_type] || \"#6b7280\";\n    const scale = this.isHovered ? 1.15 : 1;\n    const size = 60;\n    const pointerSize = 10;\n    const borderColor = this.isSelected ? \"#3B82F6\" : typeColor;\n    const borderWidth = this.isSelected ? 3 : 2.5;\n\n    div.innerHTML = `\n      <div style=\"\n        position: relative;\n        width: ${size}px;\n        height: ${size + pointerSize}px;\n        transform: scale(${scale});\n        transition: transform 0.3s ease-out;\n      \">\n        ${this.isSelected ? `\n          <div class=\"selection-ring\" style=\"\n            position: absolute;\n            top: -6px;\n            left: -6px;\n            width: ${size + 12}px;\n            height: ${size + 12}px;\n            border: 3px solid rgba(59, 130, 246, 0.4);\n            border-radius: 50%;\n            pointer-events: none;\n            z-index: -1;\n            animation: pulse 2s ease-in-out infinite;\n          \"></div>\n        ` : \"\"}\n        <div class=\"marker-circle\" style=\"\n          position: relative;\n          width: ${size}px;\n          height: ${size}px;\n          background-color: ${statusColor};\n          border: ${borderWidth}px solid ${borderColor};\n          border-radius: 50%;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          box-shadow: ${this.isSelected \n            ? \"0 4px 16px rgba(59, 130, 246, 0.5), 0 2px 6px rgba(0,0,0,0.25)\" \n            : \"0 3px 10px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1)\"};\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n          font-weight: 600;\n          font-size: 13px;\n          color: white;\n          text-shadow: 0 1px 2px rgba(0,0,0,0.3);\n          transition: all 0.3s ease-out;\n          z-index: 1;\n        \">\n          <div class=\"marker-time\" style=\"\n            position: relative;\n            z-index: 1;\n            text-align: center;\n            line-height: 1.2;\n            letter-spacing: 0.3px;\n          \">${this.time}</div>\n        </div>\n        <div class=\"marker-pointer\" style=\"\n          position: absolute;\n          bottom: 0;\n          left: 50%;\n          transform: translateX(-50%);\n          width: 0;\n          height: 0;\n          border-left: ${pointerSize}px solid transparent;\n          border-right: ${pointerSize}px solid transparent;\n          border-top: ${pointerSize}px solid ${statusColor};\n          filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));\n          z-index: 0;\n        \"></div>\n      </div>\n      <style>\n        @keyframes pulse {\n          0%, 100% { opacity: 0.6; transform: scale(1); }\n          50% { opacity: 0.3; transform: scale(1.1); }\n        }\n      </style>\n    `;\n\n    div.addEventListener(\"click\", this.onClick);\n    div.addEventListener(\"mouseenter\", () => this.onHover(true));\n    div.addEventListener(\"mouseleave\", () => this.onHover(false));\n\n    this.div = div;\n    const panes = this.getPanes();\n    if (panes) {\n      panes.overlayMouseTarget.appendChild(div);\n    }\n  }\n\n  onRemove(): void {\n    if (this.div && this.div.parentNode) {\n      this.div.parentNode.removeChild(this.div);\n    }\n  }\n\n  draw(): void {\n    if (!this.div) return;\n    \n    const projection = this.getProjection();\n    if (!projection) return;\n\n    const point = projection.fromLatLngToDivPixel(\n      new window.google.maps.LatLng(this.position.lat, this.position.lng)\n    );\n\n    if (point) {\n      // Position marker so the pointer tip is at the exact location\n      // Size is 60px circle + 10px pointer = 70px total height\n      // Offset by half circle width (30px) and full height (70px) to place pointer tip at location\n      const size = 60;\n      const pointerSize = 10;\n      this.div.style.left = point.x - (size / 2) + \"px\";\n      this.div.style.top = point.y - (size + pointerSize) + \"px\";\n    }\n  }\n\n  updateState(isSelected: boolean, isHovered: boolean, isToday: boolean, time: string): void {\n    this.isSelected = isSelected;\n    this.isHovered = isHovered;\n    this.isToday = isToday;\n    this.time = time;\n    if (this.div) {\n      // Update in place instead of recreating to avoid map refresh\n      const statusColor = this.isToday ? \"#f97316\" : (STATUS_COLORS[this.appointment.status] || \"#6b7280\");\n      const typeColor = TYPE_COLORS[this.appointment.appointment_type] || \"#6b7280\";\n      const scale = this.isHovered ? 1.15 : 1;\n      const size = 60;\n      const pointerSize = 10;\n      const borderColor = this.isSelected ? \"#3B82F6\" : typeColor;\n      const borderWidth = this.isSelected ? 3 : 2.5;\n      \n      // Update z-index dynamically: selected > hovered > normal\n      this.div.style.zIndex = this.isSelected ? \"2000\" : (this.isHovered ? \"1500\" : \"1000\");\n      \n      // Update the container div\n      const containerDiv = this.div.querySelector('div') as HTMLElement;\n      if (containerDiv) {\n        containerDiv.style.transform = `scale(${scale})`;\n        \n        // Update selection ring\n        const selectionRing = containerDiv.querySelector('.selection-ring') as HTMLElement;\n        if (selectionRing) {\n          if (this.isSelected) {\n            selectionRing.style.display = 'block';\n          } else {\n            selectionRing.style.display = 'none';\n          }\n        }\n        \n        // Update marker circle\n        const markerCircle = containerDiv.querySelector('.marker-circle') as HTMLElement;\n        if (markerCircle) {\n          markerCircle.style.backgroundColor = statusColor;\n          markerCircle.style.borderColor = borderColor;\n          markerCircle.style.borderWidth = `${borderWidth}px`;\n          markerCircle.style.boxShadow = this.isSelected \n            ? \"0 4px 16px rgba(59, 130, 246, 0.5), 0 2px 6px rgba(0,0,0,0.25)\" \n            : \"0 3px 10px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1)\";\n          \n          // Update time text\n          const timeDiv = markerCircle.querySelector('.marker-time') as HTMLElement;\n          if (timeDiv) {\n            timeDiv.textContent = this.time;\n          }\n        }\n        \n        // Update pointer\n        const markerPointer = containerDiv.querySelector('.marker-pointer') as HTMLElement;\n        if (markerPointer) {\n          markerPointer.style.borderTopColor = statusColor;\n        }\n      }\n      \n      // Don't call draw() here - it's only for position updates, not visual state changes\n      // The draw() method will be called automatically by Google Maps when needed\n    }\n  }\n  }\n\n  return AppointmentMarkerOverlay;\n};\n\n// Type for the marker overlay class\ntype AppointmentMarkerOverlay = InstanceType<ReturnType<typeof createAppointmentMarkerOverlay>>;\n\nexport const AppointmentMapView: React.FC<AppointmentMapViewProps> = ({\n  appointments,\n  loading,\n  onAppointmentClick,\n  selectedDate: propSelectedDate,\n  onDateChange,\n}) => {\n  const [selectedAppointment, setSelectedAppointment] = useState<Appointment | null>(null);\n  const [hoveredAppointment, setHoveredAppointment] = useState<Appointment | null>(null);\n  const [mapType, setMapType] = useState<\"roadmap\" | \"satellite\">(\"roadmap\");\n  const [internalSelectedDate, setInternalSelectedDate] = useState<Date>(() => \n    propSelectedDate || startOfDay(new Date())\n  );\n  const mapRef = useRef<google.maps.Map | null>(null);\n  const markersRef = useRef<AppointmentMarkerOverlay[]>([]);\n  const mapContainerRef = useRef<HTMLDivElement>(null);\n  const [mapLoaded, setMapLoaded] = useState(false);\n  const [apiKeyMissing, setApiKeyMissing] = useState(false);\n  const warnedPatientsRef = useRef<Set<number>>(new Set());\n  const AppointmentMarkerOverlayClassRef = useRef<ReturnType<typeof createAppointmentMarkerOverlay> | null>(null);\n  const [scaleDistance, setScaleDistance] = useState<string>(\"\");\n  \n  // Use prop if provided, otherwise use internal state\n  const selectedDate = propSelectedDate || internalSelectedDate;\n  \n  const handleDateChange = useCallback((date: Date) => {\n    setInternalSelectedDate(date);\n    onDateChange?.(date);\n  }, [onDateChange]);\n\n  // Filter appointments for the selected date\n  const filteredAppointments = useMemo(() => {\n    if (!appointments || appointments.length === 0) return [];\n    \n    const selectedDateStr = format(selectedDate, \"yyyy-MM-dd\");\n    \n    return appointments.filter((appointment) => {\n      if (!appointment.appointment_date) return false;\n      const appointmentDate = new Date(appointment.appointment_date);\n      const appointmentDateStr = format(appointmentDate, \"yyyy-MM-dd\");\n      return appointmentDateStr === selectedDateStr;\n    });\n  }, [appointments, selectedDate]);\n\n  // Get office location from settings\n  const { officeLocation } = useOfficeLocation();\n\n  // Fetch patients and staff\n  const { data: patientsData } = useGetList<Contact>(\"clients\", {\n    pagination: { page: 1, perPage: 10000 },\n  }, {\n    retry: false,\n    enabled: true,\n    onError: (error) => {\n      console.warn(\"Failed to load patients:\", error);\n    },\n  });\n  \n  const { data: staffData } = useGetList<Staff>(\"staff\", {\n    pagination: { page: 1, perPage: 1000 },\n  }, {\n    retry: false,\n    enabled: true,\n    onError: (error) => {\n      console.warn(\"Failed to load staff:\", error);\n    },\n  });\n\n  // Create map of patients by ID\n  const patientsMap = useMemo(() => {\n    if (!patientsData) return new Map<number, Contact>();\n    return new Map(patientsData.map((p) => [Number(p.id), p]));\n  }, [patientsData]);\n\n  // Create map of staff by ID\n  const staffMap = useMemo(() => {\n    if (!staffData) return new Map<number, Staff>();\n    return new Map(staffData.map((s) => [Number(s.id), s]));\n  }, [staffData]);\n\n  // Process appointments with coordinates\n  const appointmentMarkers = useMemo(() => {\n    if (!filteredAppointments || filteredAppointments.length === 0) return [];\n    \n    const markers: Array<{\n      appointment: Appointment;\n      coordinates: { lat: number; lng: number };\n      patient: Contact | null;\n    }> = [];\n    \n    // Track coordinates to add small offsets for overlapping markers\n    const coordinateMap = new Map<string, number>();\n    \n    filteredAppointments.forEach((appointment) => {\n      const patient = patientsMap.get(Number(appointment.patient_id));\n      let coords = getPatientCoordinates(patient);\n      \n      if (!coords) {\n        coords = getFallbackCoordinates(officeLocation);\n        if (patient && !warnedPatientsRef.current.has(patient.id)) {\n          warnedPatientsRef.current.add(patient.id);\n          console.warn(`Patient ${patient.id} missing coordinates, using fallback location`);\n        }\n      }\n      \n      // Create a key for this coordinate (rounded to avoid floating point issues)\n      const coordKey = `${coords.lat.toFixed(6)},${coords.lng.toFixed(6)}`;\n      const count = coordinateMap.get(coordKey) || 0;\n      coordinateMap.set(coordKey, count + 1);\n      \n      // Add small offset for overlapping markers (spiral pattern)\n      if (count > 0) {\n        const angle = (count * 60) * (Math.PI / 180); // 60 degrees apart\n        const radius = 0.0003 * count; // ~30 meters per marker\n        coords = {\n          lat: coords.lat + Math.cos(angle) * radius,\n          lng: coords.lng + Math.sin(angle) * radius,\n        };\n      }\n      \n      markers.push({\n        appointment,\n        coordinates: coords,\n        patient,\n      });\n    });\n    \n    return markers;\n  }, [filteredAppointments, patientsMap, officeLocation]);\n\n  // Initialize Google Maps\n  useEffect(() => {\n    const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;\n    \n    // Debug logging in production to help diagnose issues\n    if (import.meta.env.PROD) {\n      console.debug(\"Google Maps API Key check:\", {\n        exists: !!apiKey,\n        length: apiKey?.length || 0,\n        value: apiKey ? `${apiKey.substring(0, 10)}...` : 'undefined',\n        isUndefinedString: apiKey === 'undefined',\n      });\n    }\n    \n    // Check if API key is missing or is the string \"undefined\"\n    if (!apiKey || apiKey === 'undefined' || apiKey.trim() === '') {\n      console.error(\"Google Maps API key not found. Please set VITE_GOOGLE_MAPS_API_KEY in your .env file\");\n      setApiKeyMissing(true);\n      return;\n    }\n    setApiKeyMissing(false);\n\n    // Helper to check if API is fully loaded\n    const isApiReady = () => {\n      return window.google && \n             window.google.maps && \n             window.google.maps.OverlayView && \n             window.google.maps.Map;\n    };\n\n    // Check if Google Maps is already loaded\n    if (isApiReady()) {\n      initializeMap();\n      return;\n    }\n\n    // Check if script is already being loaded or exists\n    const existingScript = document.querySelector(`script[src*=\"maps.googleapis.com/maps/api/js\"]`);\n    if (existingScript) {\n      // Script already exists, wait for it to load\n      if (isApiReady()) {\n        initializeMap();\n      } else {\n        // Wait for API to be ready\n        const checkReady = setInterval(() => {\n          if (isApiReady()) {\n            clearInterval(checkReady);\n            initializeMap();\n          }\n        }, 100);\n        // Timeout after 10 seconds\n        setTimeout(() => {\n          clearInterval(checkReady);\n          if (!isApiReady()) {\n            console.error(\"Google Maps API failed to load within timeout\");\n          }\n        }, 10000);\n      }\n      return;\n    }\n\n    // Load Google Maps script\n    const script = document.createElement(\"script\");\n    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&loading=async`;\n    script.async = true;\n    script.defer = true;\n    script.onload = () => {\n      // Wait for API to be fully ready (OverlayView might not be immediately available)\n      const checkReady = setInterval(() => {\n        if (isApiReady()) {\n          clearInterval(checkReady);\n          initializeMap();\n        }\n      }, 100);\n      // Timeout after 10 seconds\n      setTimeout(() => {\n        clearInterval(checkReady);\n        if (!isApiReady()) {\n          console.error(\"Google Maps API failed to initialize within timeout\");\n        }\n      }, 10000);\n    };\n    script.onerror = () => {\n      console.error(\"Failed to load Google Maps API\");\n    };\n    document.head.appendChild(script);\n\n    return () => {\n      // Cleanup\n      if (markersRef.current) {\n        markersRef.current.forEach(marker => marker.onRemove());\n        markersRef.current = [];\n      }\n    };\n  }, []);\n\n  const initializeMap = () => {\n    if (!mapContainerRef.current || !window.google || !window.google.maps || mapRef.current) return;\n\n    // Ensure OverlayView is available before creating the class\n    if (!window.google.maps.OverlayView) {\n      console.warn(\"OverlayView not yet available, retrying...\");\n      setTimeout(initializeMap, 100);\n      return;\n    }\n\n    // Create the AppointmentMarkerOverlay class now that google is available\n    if (!AppointmentMarkerOverlayClassRef.current) {\n      try {\n        AppointmentMarkerOverlayClassRef.current = createAppointmentMarkerOverlay();\n      } catch (error) {\n        console.error(\"Failed to create AppointmentMarkerOverlay:\", error);\n        return;\n      }\n    }\n\n    const map = new window.google.maps.Map(mapContainerRef.current, {\n      center: DEFAULT_CENTER,\n      zoom: DEFAULT_ZOOM,\n      mapTypeId: mapType === \"satellite\" ? window.google.maps.MapTypeId.SATELLITE : window.google.maps.MapTypeId.ROADMAP,\n      // Disable default map type controls\n      mapTypeControl: false,\n      // Disable other default controls we don't need\n      streetViewControl: false,\n      fullscreenControl: false,\n      zoomControl: true, // Keep zoom control\n      scaleControl: false, // Disable default scale control - we'll add custom one\n    });\n\n    mapRef.current = map;\n    setMapLoaded(true);\n\n    // Calculate zoom level for 1.5km scale (for 100px width)\n    const calculateZoomForDistance = (targetKm: number, lat: number): number => {\n      const targetMeters = targetKm * 1000;\n      const metersPerPixel = targetMeters / 100; // 100px scale bar\n      const metersPerPixelAtEquator = 156543.03392;\n      const zoom = Math.log2((metersPerPixelAtEquator * Math.cos((lat * Math.PI) / 180)) / metersPerPixel);\n      return Math.round(zoom);\n    };\n\n    // Set initial zoom to show 1.5km\n    const targetZoom = calculateZoomForDistance(1.5, DEFAULT_CENTER.lat);\n    map.setZoom(targetZoom);\n\n    // Update scale when zoom changes\n    const updateScale = () => {\n      if (!map || !window.google || !window.google.maps) return;\n      \n      const zoom = map.getZoom();\n      if (zoom === null || zoom === undefined) return;\n\n      // Calculate approximate distance in km for 100px at current zoom\n      // This is an approximation based on zoom level\n      const metersPerPixel = (156543.03392 * Math.cos((DEFAULT_CENTER.lat * Math.PI) / 180)) / Math.pow(2, zoom);\n      const distanceMeters = metersPerPixel * 100; // 100px width\n      const distanceKm = distanceMeters / 1000;\n\n      // Round to a nice number\n      let displayDistance: number;\n      let unit: string;\n      \n      if (distanceKm >= 1) {\n        // Round to nearest 0.5, 1, 2, 5, 10, etc.\n        if (distanceKm < 2) {\n          displayDistance = Math.round(distanceKm * 2) / 2;\n        } else if (distanceKm < 5) {\n          displayDistance = Math.round(distanceKm);\n        } else if (distanceKm < 10) {\n          displayDistance = Math.round(distanceKm / 5) * 5;\n        } else {\n          displayDistance = Math.round(distanceKm / 10) * 10;\n        }\n        unit = \"km\";\n      } else {\n        // Show in meters\n        displayDistance = Math.round(distanceMeters / 100) * 100;\n        unit = \"m\";\n      }\n\n      setScaleDistance(`${displayDistance} ${unit}`);\n    };\n\n    // Initial scale update (after a brief delay to ensure zoom is set)\n    setTimeout(() => {\n      updateScale();\n    }, 100);\n\n    // Update scale on zoom change\n    map.addListener('zoom_changed', updateScale);\n    map.addListener('bounds_changed', updateScale);\n  };\n\n  // Update map type\n  useEffect(() => {\n    if (mapRef.current && window.google && window.google.maps) {\n      mapRef.current.setMapTypeId(\n        mapType === \"satellite\" ? window.google.maps.MapTypeId.SATELLITE : window.google.maps.MapTypeId.ROADMAP\n      );\n    }\n  }, [mapType]);\n\n  // Optimized hover handler - only updates state when appointment actually changes\n  const handleMarkerHover = useCallback((appointment: Appointment | null) => {\n    setHoveredAppointment(prev => {\n      // Only update if the appointment actually changed\n      if (prev?.id === appointment?.id) {\n        return prev; // No change, return previous to prevent re-render\n      }\n      return appointment;\n    });\n  }, []);\n\n  // Update markers when appointments change (NOT when hover/selection changes)\n  useEffect(() => {\n    if (!mapRef.current || !mapLoaded || !window.google || !window.google.maps || !AppointmentMarkerOverlayClassRef.current) return;\n\n    // Remove existing markers\n    markersRef.current.forEach(marker => marker.onRemove());\n    markersRef.current = [];\n\n    const AppointmentMarkerOverlayClass = AppointmentMarkerOverlayClassRef.current;\n\n    // Add new markers\n    appointmentMarkers.forEach((markerData) => {\n      const appointment = markerData.appointment;\n      const isSelected = selectedAppointment?.id === appointment.id;\n      const isHovered = hoveredAppointment?.id === appointment.id;\n      const isAppointmentToday = isToday(new Date(appointment.appointment_date || ''));\n      \n      // Format time as HH:MM\n      const time = formatTimeForMarker(appointment.start_time);\n\n      const marker = new AppointmentMarkerOverlayClass(\n        appointment,\n        markerData.coordinates,\n        time,\n        isSelected,\n        isHovered,\n        isAppointmentToday,\n        () => {\n          setSelectedAppointment(appointment);\n          onAppointmentClick(appointment);\n        },\n        (hovered) => {\n          // Use the optimized hover handler\n          handleMarkerHover(hovered ? appointment : null);\n        }\n      );\n\n      marker.setMap(mapRef.current);\n      markersRef.current.push(marker);\n    });\n\n    // Fit bounds to show all markers, but with maximum zoom constraint (prevent zooming in too much)\n    // Only do this when markers are actually added/removed, not on hover/selection changes\n    if (appointmentMarkers.length > 0 && mapRef.current && window.google && window.google.maps) {\n      const bounds = new window.google.maps.LatLngBounds();\n      appointmentMarkers.forEach(marker => {\n        bounds.extend(marker.coordinates);\n      });\n      \n      // Calculate maximum allowed zoom for 1.5km scale (this is the minimum zoom level we want)\n      const calculateZoomForDistance = (targetKm: number, lat: number): number => {\n        const targetMeters = targetKm * 1000;\n        const metersPerPixel = targetMeters / 100;\n        const metersPerPixelAtEquator = 156543.03392;\n        const zoom = Math.log2((metersPerPixelAtEquator * Math.cos((lat * Math.PI) / 180)) / metersPerPixel);\n        return Math.round(zoom);\n      };\n      \n      const maxAllowedZoom = calculateZoomForDistance(1.5, DEFAULT_CENTER.lat);\n      \n      // Get the center of bounds for setting zoom manually if needed\n      const boundsCenter = bounds.getCenter();\n      \n      // Fit bounds but limit maximum zoom\n      mapRef.current.fitBounds(bounds, { padding: 50 });\n      \n      // Check if current zoom exceeded our limit and adjust if needed\n      setTimeout(() => {\n        if (mapRef.current) {\n          const currentZoom = mapRef.current.getZoom();\n          if (currentZoom !== null && currentZoom !== undefined && currentZoom > maxAllowedZoom) {\n            // If zoomed in too much, set to max allowed zoom and center on bounds\n            mapRef.current.setZoom(maxAllowedZoom);\n            mapRef.current.setCenter(boundsCenter);\n          }\n        }\n      }, 100);\n    }\n  }, [appointmentMarkers, mapLoaded, onAppointmentClick, handleMarkerHover]); // Removed selectedAppointment and hoveredAppointment from dependencies\n\n  // Update marker states when selection/hover changes\n  useEffect(() => {\n    markersRef.current.forEach((marker, index) => {\n      const appointment = appointmentMarkers[index]?.appointment;\n      if (appointment) {\n        const isSelected = selectedAppointment?.id === appointment.id;\n        const isHovered = hoveredAppointment?.id === appointment.id;\n        const isAppointmentToday = isToday(new Date(appointment.appointment_date || ''));\n        \n        // Format time as HH:MM\n        const time = formatTimeForMarker(appointment.start_time);\n\n        marker.updateState(isSelected, isHovered, isAppointmentToday, time);\n      }\n    });\n  }, [selectedAppointment, hoveredAppointment, appointmentMarkers]);\n\n  const handleMarkerClick = useCallback((appointment: Appointment) => {\n    setSelectedAppointment(appointment);\n    onAppointmentClick(appointment);\n  }, [onAppointmentClick]);\n\n  const handleInfoWindowClose = useCallback(() => {\n    setHoveredAppointment(null);\n  }, []);\n\n  const handleFitToMap = useCallback(() => {\n    if (mapRef.current && appointmentMarkers.length > 0 && window.google && window.google.maps) {\n      const bounds = new window.google.maps.LatLngBounds();\n      appointmentMarkers.forEach(marker => {\n        bounds.extend(marker.coordinates);\n      });\n      \n      // Calculate maximum allowed zoom for 1.5km scale\n      const calculateZoomForDistance = (targetKm: number, lat: number): number => {\n        const targetMeters = targetKm * 1000;\n        const metersPerPixel = targetMeters / 100;\n        const metersPerPixelAtEquator = 156543.03392;\n        const zoom = Math.log2((metersPerPixelAtEquator * Math.cos((lat * Math.PI) / 180)) / metersPerPixel);\n        return Math.round(zoom);\n      };\n      \n      const maxAllowedZoom = calculateZoomForDistance(1.5, DEFAULT_CENTER.lat);\n      const boundsCenter = bounds.getCenter();\n      \n      mapRef.current.fitBounds(bounds, { padding: 50 });\n      \n      // Ensure we don't zoom in beyond maximum allowed\n      setTimeout(() => {\n        if (mapRef.current) {\n          const currentZoom = mapRef.current.getZoom();\n          if (currentZoom !== null && currentZoom !== undefined && currentZoom > maxAllowedZoom) {\n            mapRef.current.setZoom(maxAllowedZoom);\n            mapRef.current.setCenter(boundsCenter);\n          }\n        }\n      }, 100);\n    }\n  }, [appointmentMarkers]);\n\n  const handleMapTypeChange = useCallback((type: \"roadmap\" | \"satellite\") => {\n    setMapType(type);\n  }, []);\n\n  if (loading) {\n    return (\n      <div className=\"w-full h-[625px] rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center\">\n        <div className=\"text-slate-500 dark:text-slate-400\">Loading map...</div>\n      </div>\n    );\n  }\n\n  // Show error message if API key is missing\n  if (apiKeyMissing) {\n    return (\n      <div className=\"w-full h-[625px] rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center\">\n        <div className=\"max-w-md p-6 bg-white dark:bg-slate-700 rounded-lg shadow-lg border border-slate-200 dark:border-slate-600\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <MapPin className=\"w-6 h-6 text-amber-500\" />\n            <h3 className=\"text-lg font-semibold text-slate-900 dark:text-slate-100\">\n              Google Maps API Key Required\n            </h3>\n          </div>\n          <p className=\"text-slate-600 dark:text-slate-300 mb-4\">\n            The map view requires a Google Maps API key to function. Please configure it in your environment variables.\n          </p>\n          <div className=\"space-y-2 text-sm text-slate-500 dark:text-slate-400\">\n            <p><strong>For Production (Vercel):</strong></p>\n            <ol className=\"list-decimal list-inside space-y-1 ml-2\">\n              <li>Go to your Vercel project settings</li>\n              <li>Navigate to Environment Variables</li>\n              <li>Add <code className=\"bg-slate-100 dark:bg-slate-800 px-1 rounded\">VITE_GOOGLE_MAPS_API_KEY</code> with your API key</li>\n              <li>Redeploy your application</li>\n            </ol>\n            <p className=\"mt-4\"><strong>For Local Development:</strong></p>\n            <p>Add <code className=\"bg-slate-100 dark:bg-slate-800 px-1 rounded\">VITE_GOOGLE_MAPS_API_KEY=your_key_here</code> to your <code className=\"bg-slate-100 dark:bg-slate-800 px-1 rounded\">.env.local</code> file</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full h-full flex flex-col\" style={{ flex: \"1 1 auto\", minHeight: 0 }}>\n      {/* Map Container */}\n      <div className=\"w-full flex-1 relative\" style={{ minHeight: \"800px\", height: \"100%\" }}>\n        <div ref={mapContainerRef} style={{ width: \"100%\", height: \"100%\", minHeight: \"800px\" }} />\n        \n        {/* Map Controls Overlay */}\n        <div className=\"absolute top-2 left-2 z-[1000] flex flex-col gap-2\">\n          {/* Map Type Toggle */}\n          <div className=\"bg-white dark:bg-slate-800 rounded-lg shadow-md border border-slate-200 dark:border-slate-700 overflow-hidden\">\n            <Button\n              type=\"button\"\n              variant={mapType === \"roadmap\" ? \"default\" : \"ghost\"}\n              size=\"sm\"\n              onClick={() => handleMapTypeChange(\"roadmap\")}\n              className=\"rounded-none border-0 h-8 px-3 text-xs\"\n            >\n              Map\n            </Button>\n            <Button\n              type=\"button\"\n              variant={mapType === \"satellite\" ? \"default\" : \"ghost\"}\n              size=\"sm\"\n              onClick={() => handleMapTypeChange(\"satellite\")}\n              className=\"rounded-none border-0 h-8 px-3 text-xs\"\n            >\n              Satellite\n            </Button>\n          </div>\n        </div>\n        \n        {/* Fit to Map Button - Positioned over Google logo on the map */}\n        <div \n          className=\"absolute pointer-events-auto\" \n          style={{ \n            position: 'absolute',\n            bottom: '32px', \n            left: '18px',\n            zIndex: 10000,\n            pointerEvents: 'auto'\n          }}\n        >\n          <Button\n            type=\"button\"\n            variant=\"default\"\n            size=\"sm\"\n            onClick={handleFitToMap}\n            className=\"bg-white hover:bg-slate-50 text-slate-900 shadow-lg border border-slate-200 h-9 px-3 text-xs\"\n            style={{ pointerEvents: 'auto' }}\n          >\n            <MapPin className=\"w-4 h-4 mr-1.5\" />\n            Fit to Map\n          </Button>\n        </div>\n        \n        {/* Info Window Overlay */}\n        {hoveredAppointment && (\n          <AppointmentInfoWindow\n            appointment={hoveredAppointment}\n            patient={patientsMap.get(Number(hoveredAppointment.patient_id)) || null}\n            staff={hoveredAppointment.primary_staff_id ? staffMap.get(Number(hoveredAppointment.primary_staff_id)) : null}\n            markerPosition={appointmentMarkers.find(m => m.appointment.id === hoveredAppointment.id)?.coordinates}\n            onClose={handleInfoWindowClose}\n          />\n        )}\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentInfoWindow.tsx",
      "content": "import React, { useEffect, useState, useRef } from \"react\";\nimport { X, Clock, MapPin, Users } from \"lucide-react\";\nimport type { Appointment, Contact, Staff } from \"../types\";\nimport { APPOINTMENT_TYPES, APPOINTMENT_STATUSES } from \"./types\";\nimport { format } from \"date-fns\";\nimport { formatCrmDate, extractCrmTime, getCrmTimeZone } from \"../misc/timezone\";\n\ntype AppointmentInfoWindowProps = {\n  appointment: Appointment;\n  patient: Contact | null;\n  staff: Staff | null;\n  markerPosition: [number, number] | undefined;\n  onClose: () => void;\n};\n\n// Status badge configs\nconst STATUS_BADGES: Record<string, { bg: string; text: string; icon: string }> = {\n  completed: {\n    bg: \"#f0fdf4\",\n    text: \"#10b981\",\n    icon: \"\",\n  },\n  cancelled: {\n    bg: \"#fef2f2\",\n    text: \"#ef4444\",\n    icon: \"\",\n  },\n  scheduled: {\n    bg: \"#fffbeb\",\n    text: \"#f59e0b\",\n    icon: \"\",\n  },\n};\n\n// Appointment type colors\nconst TYPE_COLORS: Record<string, string> = {\n  doctor_on_call: \"#3b82f6\",\n  lab_test: \"#10b981\",\n  teleconsultation: \"#8b5cf6\",\n  physiotherapy: \"#f59e0b\",\n  caregiver: \"#ef4444\",\n  iv_therapy: \"#06b6d4\",\n};\n\n// Helper to construct address\nconst getPatientAddress = (patient: Contact | null): string => {\n  if (!patient) return \"Address not available\";\n  \n  const parts = [\n    patient.flat_villa_number,\n    patient.building_street,\n    patient.area,\n    patient.city,\n  ].filter(Boolean);\n  \n  return parts.length > 0 ? parts.join(\", \") : \"Address not available\";\n};\n\n// Format time\nconst formatTime = (timeStr: string): string => {\n  try {\n    const parts = timeStr.split(\":\");\n    if (parts.length >= 2) {\n      return `${parts[0]}:${parts[1]}`;\n    }\n    return timeStr;\n  } catch {\n    return timeStr;\n  }\n};\n\nexport const AppointmentInfoWindow: React.FC<AppointmentInfoWindowProps> = ({\n  appointment,\n  patient,\n  staff,\n  onClose,\n}) => {\n  const [isVisible, setIsVisible] = useState(false);\n  const [mouseInside, setMouseInside] = useState(false);\n  const closeTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const infoWindowRef = useRef<HTMLDivElement>(null);\n  \n  const appointmentType = APPOINTMENT_TYPES.find(t => t.value === appointment.appointment_type);\n  const statusConfig = APPOINTMENT_STATUSES.find(s => s.value === appointment.status);\n  const statusBadge = STATUS_BADGES[appointment.status] || STATUS_BADGES.scheduled;\n  const typeColor = TYPE_COLORS[appointment.appointment_type] || \"#6b7280\";\n  \n  // Show with fade-in\n  useEffect(() => {\n    setIsVisible(true);\n  }, []);\n  \n  // Handle mouse leave with delay\n  const handleMouseLeave = () => {\n    setMouseInside(false);\n    if (closeTimeoutRef.current) {\n      clearTimeout(closeTimeoutRef.current);\n    }\n    closeTimeoutRef.current = setTimeout(() => {\n      if (!mouseInside) {\n        onClose();\n      }\n    }, 400);\n  };\n  \n  const handleMouseEnter = () => {\n    setMouseInside(true);\n    if (closeTimeoutRef.current) {\n      clearTimeout(closeTimeoutRef.current);\n    }\n  };\n  \n  useEffect(() => {\n    return () => {\n      if (closeTimeoutRef.current) {\n        clearTimeout(closeTimeoutRef.current);\n      }\n    };\n  }, []);\n  \n  const patientName = patient \n    ? `${patient.first_name || \"\"} ${patient.last_name || \"\"}`.trim() || \"Unknown Patient\"\n    : \"Unknown Patient\";\n  \n  const address = getPatientAddress(patient);\n  \n  // Format date and time in a readable format using CRM timezone\n  let fullDateTime = \"Date and time not available\";\n  \n  try {\n    const dateStr = appointment.appointment_date;\n    const timeStr = appointment.start_time;\n    \n    // Parse the date and time to a Date object\n    let dateObj: Date | null = null;\n    \n    // Priority: use start_time if it's a full ISO string, otherwise combine date and time\n    if (timeStr) {\n      // Check if start_time is already a full ISO datetime string\n      if (timeStr.includes('T') || timeStr.match(/^\\d{4}-\\d{2}-\\d{2}/)) {\n        // It's already a full datetime string\n        dateObj = new Date(timeStr);\n      } else if (dateStr) {\n        // Combine date and time strings\n        // Ensure time has seconds if missing\n        const timeWithSeconds = timeStr.includes(':') && timeStr.split(':').length === 2 \n          ? `${timeStr}:00` \n          : timeStr;\n        const combined = `${dateStr}T${timeWithSeconds}`;\n        dateObj = new Date(combined);\n      }\n    } else if (dateStr) {\n      // Only date available\n      if (dateStr.includes('T')) {\n        dateObj = new Date(dateStr);\n      } else {\n        dateObj = new Date(`${dateStr}T00:00:00`);\n      }\n    }\n    \n    if (dateObj && !isNaN(dateObj.getTime())) {\n      // Format date: \"Tuesday, December 2, 2025\" using CRM timezone\n      const formattedDate = format(dateObj, \"EEEE, MMMM d, yyyy\", {\n        timeZone: getCrmTimeZone()\n      });\n      \n      // Format time in CRM timezone: \"04:00 AM\" (12-hour format)\n      const crmTimeStr = extractCrmTime(dateObj);\n      const [hoursStr, minutesStr] = crmTimeStr.split(\":\");\n      const hours = parseInt(hoursStr, 10);\n      const minutes = parseInt(minutesStr || '0', 10);\n      const ampm = hours >= 12 ? 'PM' : 'AM';\n      const displayHours = hours % 12 || 12;\n      const formattedTime = `${displayHours}:${minutesStr.padStart(2, '0')} ${ampm}`;\n      \n      // Combine for display\n      fullDateTime = `${formattedDate}  ${formattedTime}`;\n    } else {\n      // Fallback: try to format manually from strings\n      if (dateStr && timeStr) {\n        // Extract date parts\n        const dateMatch = dateStr.match(/(\\d{4})-(\\d{2})-(\\d{2})/);\n        const timeMatch = timeStr.match(/(\\d{2}):(\\d{2})/);\n        \n        if (dateMatch && timeMatch) {\n          const [, year, month, day] = dateMatch;\n          const [, hourStr, minuteStr] = timeMatch;\n          \n          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', \n                             'July', 'August', 'September', 'October', 'November', 'December'];\n          const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\n          \n          const dateNum = parseInt(day, 10);\n          const monthNum = parseInt(month, 10) - 1;\n          const yearNum = parseInt(year, 10);\n          const hour = parseInt(hourStr, 10);\n          const minute = parseInt(minuteStr, 10);\n          \n          // Get day name\n          const tempDate = new Date(yearNum, monthNum, dateNum);\n          const dayName = dayNames[tempDate.getDay()];\n          \n          const formattedDate = `${dayName}, ${monthNames[monthNum]} ${dateNum}, ${yearNum}`;\n          const ampm = hour >= 12 ? 'PM' : 'AM';\n          const displayHour = hour % 12 || 12;\n          const formattedTime = `${displayHour}:${minuteStr} ${ampm}`;\n          \n          fullDateTime = `${formattedDate}  ${formattedTime}`;\n        }\n      }\n    }\n  } catch (error) {\n    console.error('Error formatting date/time:', error);\n    // Final fallback\n    if (appointment.appointment_date && appointment.start_time) {\n      fullDateTime = `${appointment.appointment_date}  ${formatTime(appointment.start_time)}`;\n    } else if (appointment.appointment_date) {\n      fullDateTime = appointment.appointment_date;\n    } else if (appointment.start_time) {\n      fullDateTime = formatTime(appointment.start_time);\n    }\n  }\n  \n  const staffName = staff \n    ? `${staff.first_name || \"\"} ${staff.last_name || \"\"}`.trim() || \"Unassigned\"\n    : \"Unassigned\";\n  \n  return (\n    <div\n      ref={infoWindowRef}\n      className=\"absolute z-[1000] pointer-events-auto\"\n      style={{\n        top: \"20px\",\n        right: \"20px\",\n        opacity: isVisible ? 1 : 0,\n        transition: \"opacity 0.2s ease-in\",\n      }}\n      onMouseEnter={handleMouseEnter}\n      onMouseLeave={handleMouseLeave}\n    >\n      <div\n        className=\"bg-white rounded-lg shadow-xl border border-gray-200 overflow-hidden\"\n        style={{\n          maxWidth: \"320px\",\n          minWidth: \"280px\",\n        }}\n      >\n        {/* Header */}\n        <div\n          className=\"relative px-4 pt-4 pb-3\"\n          style={{\n            background: `linear-gradient(to bottom, rgba(59, 130, 246, 0.08), transparent)`,\n          }}\n        >\n          {/* Close button */}\n          <button\n            onClick={onClose}\n            className=\"absolute top-3 right-3 w-6 h-6 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors\"\n            style={{ zIndex: 10 }}\n          >\n            <X className=\"w-4 h-4 text-gray-600\" />\n          </button>\n          \n          {/* Patient name and status */}\n          <div className=\"pr-10 mb-3\">\n            <div className=\"flex items-center gap-3 mb-2\">\n              <h3\n                className=\"font-semibold text-gray-900 flex-1\"\n                style={{ fontSize: \"16px\", lineHeight: \"1.4\" }}\n              >\n                {patientName}\n              </h3>\n              <span\n                className=\"px-2.5 py-1 rounded text-xs font-medium flex items-center gap-1.5 whitespace-nowrap\"\n                style={{\n                  backgroundColor: statusBadge.bg,\n                  color: statusBadge.text,\n                  fontSize: \"12px\",\n                }}\n              >\n                <Clock className=\"w-3.5 h-3.5\" />\n                {statusConfig?.label || appointment.status}\n              </span>\n            </div>\n            \n            {/* Appointment type button */}\n            <div>\n              <span\n                className=\"inline-block px-3 py-1.5 rounded text-sm font-medium text-white\"\n                style={{\n                  backgroundColor: typeColor,\n                  fontSize: \"12px\",\n                }}\n              >\n                {appointmentType?.label || appointment.appointment_type}\n              </span>\n            </div>\n          </div>\n        </div>\n        \n        {/* Content */}\n        <div className=\"px-4 pb-4 pt-2 space-y-4\">\n          {/* Time */}\n          <div className=\"flex items-start gap-3\">\n            <div\n              className=\"w-5 h-5 rounded flex items-center justify-center flex-shrink-0 mt-0.5\"\n              style={{ backgroundColor: \"#f3f4f6\" }}\n            >\n              <Clock className=\"w-4 h-4 text-gray-600\" />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"text-gray-500 mb-1\" style={{ fontSize: \"11px\", lineHeight: \"1.3\", fontWeight: \"500\" }}>\n                Time\n              </div>\n              <div className=\"text-gray-900 font-medium\" style={{ fontSize: \"14px\", lineHeight: \"1.5\" }}>\n                {fullDateTime}\n              </div>\n            </div>\n          </div>\n          \n          {/* Staff */}\n          <div className=\"flex items-start gap-3\">\n            <div\n              className=\"w-5 h-5 rounded flex items-center justify-center flex-shrink-0 mt-0.5\"\n              style={{ backgroundColor: \"#f3f4f6\" }}\n            >\n              <Users className=\"w-4 h-4 text-gray-600\" />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"text-gray-500 mb-1\" style={{ fontSize: \"11px\", lineHeight: \"1.3\", fontWeight: \"500\" }}>\n                Staff\n              </div>\n              <div className=\"text-gray-900\" style={{ fontSize: \"14px\", lineHeight: \"1.5\" }}>\n                {staff ? staffName : \"Staff not assigned\"}\n              </div>\n            </div>\n          </div>\n          \n          {/* Address */}\n          <div className=\"flex items-start gap-3\">\n            <div\n              className=\"w-5 h-5 rounded flex items-center justify-center flex-shrink-0 mt-0.5\"\n              style={{ backgroundColor: \"#f3f4f6\" }}\n            >\n              <MapPin className=\"w-4 h-4 text-red-500\" />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"text-gray-500 mb-1\" style={{ fontSize: \"11px\", lineHeight: \"1.3\", fontWeight: \"500\" }}>\n                Address\n              </div>\n              <div className=\"text-gray-900\" style={{ fontSize: \"14px\", lineHeight: \"1.5\" }}>\n                {address}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      \n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentForm.tsx",
      "content": "import React, { useState, useMemo } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectGroup, SelectItem, SelectLabel, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from \"@/components/ui/command\";\nimport { Check, ChevronsUpDown, Search } from \"lucide-react\";\nimport { useGetList } from \"ra-core\";\nimport type { Appointment, Contact, Staff, RecurrenceConfig, PaymentPackage, Service } from \"../types\";\nimport { APPOINTMENT_STATUSES } from \"./types\";\nimport { useAppointmentTypes } from \"./useAppointmentTypes\";\nimport { formatCrmTime, crmDateYmdInputString, extractCrmTime } from \"../misc/timezone\";\nimport { cn } from \"@/lib/utils\";\nimport { CustomMultiSelect, type MultiSelectOption } from \"./CustomMultiSelect\";\nimport { usePackageUsage } from \"@/hooks/usePackageUsage\";\n\ntype AppointmentFormProps = {\n  appointment?: Appointment | null;\n  initialDateTime?: { start: Date; end: Date } | null;\n  onSubmit: (data: any) => void;\n  isSubmitting: boolean;\n};\n\ntype AppointmentFormData = {\n  patient_id: string;\n  appointment_date: string;\n  start_time: string;\n  end_time: string;\n  duration_minutes: number;\n  appointment_type: string[]; // Changed to array for multiple types\n  status: string;\n  notes?: string;\n  mini_notes?: string;\n  full_notes?: string;\n  pickup_instructions?: string;\n  primary_staff_id?: string;\n  driver_id?: string;\n  staff_ids?: string[]; // Already an array for multiple staff\n  payment_package_id?: string;\n  // Recurrence fields\n  is_recurring?: boolean;\n  recurrence_pattern?: \"daily\" | \"weekly\" | \"monthly\" | \"yearly\" | \"custom\";\n  recurrence_interval?: number;\n  recurrence_end_type?: \"date\" | \"occurrences\";\n  recurrence_end_date?: string;\n  recurrence_occurrences?: number;\n  recurrence_days_of_week?: number[];\n  recurrence_day_of_month?: number;\n  recurrence_week_of_month?: number;\n  recurrence_month?: number;\n  recurrence_custom_unit?: \"days\" | \"weeks\" | \"months\";\n};\n\nexport const AppointmentForm: React.FC<AppointmentFormProps> = ({\n  appointment,\n  initialDateTime,\n  onSubmit,\n  isSubmitting,\n}) => {\n  const { data: patients } = useGetList<Contact>(\"clients\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n  const { data: staff } = useGetList<Staff>(\"staff\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n  const appointmentTypes = useAppointmentTypes();\n  const { data: services } = useGetList<Service>(\"services\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n  \n  // Helper to convert appointment type to service IDs for form\n  // Priority: Use selected_service_ids from custom_fields if available\n  const convertAppointmentTypeToServiceIds = React.useCallback((appointmentType: string | string[] | undefined, customFields?: Record<string, any>): string[] => {\n    // First, check if we have selected service IDs stored in custom_fields\n    const selectedServiceIds = customFields?.selected_service_ids;\n    if (Array.isArray(selectedServiceIds) && selectedServiceIds.length > 0) {\n      // Convert service IDs to service_ format\n      return selectedServiceIds.map(id => `service_${id}`);\n    }\n    \n    if (!appointmentType) return [];\n    const types = Array.isArray(appointmentType) ? appointmentType : [appointmentType];\n    \n    // If it's already in service_ format, return as is\n    if (types.some(t => typeof t === \"string\" && t.startsWith(\"service_\"))) {\n      return types.filter(t => typeof t === \"string\" && t.startsWith(\"service_\")) as string[];\n    }\n    \n    // Otherwise, find the FIRST service that matches this appointment type\n    // This prevents bundling multiple services that map to the same appointment_type\n    const matchingType = appointmentTypes.find(type => type.appointmentType === types[0] || types.includes(type.appointmentType || \"\"));\n    return matchingType ? [matchingType.value] : [];\n  }, [appointmentTypes]);\n\n  const {\n    register,\n    handleSubmit,\n    watch,\n    setValue,\n    formState: { errors },\n  } = useForm<AppointmentFormData>({\n    defaultValues: appointment\n      ? {\n          patient_id: appointment.patient_id.toString(),\n          appointment_date: appointment.appointment_date.split(\"T\")[0],\n          // Extract time in CRM timezone, not UTC\n          // appointment.start_time and end_time are ISO strings stored in UTC\n          // We need to format them in the configured CRM timezone for display\n          start_time: extractCrmTime(appointment.start_time) || \"\",\n          end_time: extractCrmTime(appointment.end_time) || \"\",\n          duration_minutes: appointment.duration_minutes,\n          appointment_type: convertAppointmentTypeToServiceIds(appointment.appointment_type, appointment.custom_fields),\n          status: appointment.status,\n          notes: appointment.notes || \"\",\n          mini_notes: appointment.mini_notes || \"\",\n          full_notes: appointment.full_notes || \"\",\n          pickup_instructions: appointment.pickup_instructions || \"\",\n          primary_staff_id: appointment.primary_staff_id?.toString() || \"\",\n          driver_id: appointment.driver_id?.toString() || \"\",\n          staff_ids: appointment.staff_ids?.map((id) => id.toString()) || [],\n          payment_package_id: appointment.payment_package_id?.toString() || \"\",\n        }\n      : (() => {\n          // Use initialDateTime if provided, otherwise use current date/time\n          if (initialDateTime) {\n            const start = initialDateTime.start;\n            const end = initialDateTime.end;\n            \n            // Ensure start and end are Date objects\n            const startDate = start instanceof Date ? start : new Date(start);\n            const endDate = end instanceof Date ? end : new Date(end);\n            \n            // Validate dates - check if they're valid Date objects\n            if (!(startDate instanceof Date && endDate instanceof Date) || \n                isNaN(startDate.getTime()) || \n                isNaN(endDate.getTime()) ||\n                startDate.getTime() === 0 ||\n                endDate.getTime() === 0) {\n              // Silently use defaults instead of logging\n              return {\n                appointment_date: new Date().toISOString().split(\"T\")[0],\n                status: \"scheduled\",\n                duration_minutes: 60,\n                start_time: \"\",\n                end_time: \"\",\n                patient_id: \"\",\n                appointment_type: [],\n                primary_staff_id: \"\",\n                driver_id: \"\",\n                staff_ids: [],\n                is_recurring: false,\n                recurrence_pattern: \"daily\",\n                recurrence_interval: 1,\n                recurrence_end_type: \"occurrences\",\n                recurrence_occurrences: 10,\n              };\n            }\n            \n            const durationMs = endDate.getTime() - startDate.getTime();\n            const durationMinutes = Math.max(Math.round(durationMs / (60 * 1000)), 15);\n            \n            // Format date as YYYY-MM-DD using timezone utility\n            const dateStr = crmDateYmdInputString(startDate) || new Date().toISOString().split(\"T\")[0];\n            \n            // Format time as HH:MM using timezone-aware extractor\n            // FullCalendar with timeZone set displays times in the configured CRM timezone,\n            // but returns Date objects in the browser's local timezone.\n            // We need to extract the time components as they appear in the CRM timezone.\n            const startTimeStr = extractCrmTime(startDate);\n            const endTimeStr = extractCrmTime(endDate);\n            \n          return {\n            appointment_date: dateStr,\n            start_time: startTimeStr || \"\",\n            end_time: endTimeStr || \"\",\n            duration_minutes: durationMinutes,\n            status: \"scheduled\",\n            appointment_type: [],\n            primary_staff_id: \"\",\n            driver_id: \"\",\n            staff_ids: [],\n          };\n          }\n          return {\n            appointment_date: new Date().toISOString().split(\"T\")[0],\n            status: \"scheduled\",\n            duration_minutes: 60,\n            start_time: \"\",\n            end_time: \"\",\n            patient_id: \"\",\n            appointment_type: [],\n            primary_staff_id: \"\",\n            driver_id: \"\",\n            staff_ids: [],\n            is_recurring: false,\n            recurrence_pattern: \"daily\",\n            recurrence_interval: 1,\n            recurrence_end_type: \"occurrences\",\n            recurrence_occurrences: 10,\n          };\n        })(),\n  });\n\n  const isRecurring = watch(\"is_recurring\");\n  const recurrencePattern = watch(\"recurrence_pattern\") || \"daily\";\n  const recurrenceEndType = watch(\"recurrence_end_type\") || \"occurrences\";\n  const recurrenceDaysOfWeek = watch(\"recurrence_days_of_week\") || [];\n  \n  // Patient combobox state\n  const [patientOpen, setPatientOpen] = useState(false);\n  const [patientSearch, setPatientSearch] = useState(\"\");\n  const selectedPatientId = watch(\"patient_id\");\n  const selectedAppointmentTypes = watch(\"appointment_type\") || [];\n  \n  // Fetch payment packages for selected patient\n  const { data: paymentPackages } = useGetList<PaymentPackage>(\"payment_packages\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: selectedPatientId ? { patient_id: selectedPatientId, status: \"active\" } : {},\n    sort: { field: \"created_at\", order: \"DESC\" },\n  }, { enabled: !!selectedPatientId });\n  \n  // Create patients map for quick lookup\n  const patientsMap = useMemo(() => {\n    if (!patients) return new Map<number, Contact>();\n    return new Map(patients.map((p) => [Number(p.id), p]));\n  }, [patients]);\n\n  // Filter packages that match the selected appointment type/service\n  const availablePackages = useMemo(() => {\n    if (!paymentPackages || !services || selectedAppointmentTypes.length === 0) {\n      return [];\n    }\n    \n    // Get service IDs from selected appointment types\n    const serviceIds = selectedAppointmentTypes\n      .filter(type => type.startsWith(\"service_\"))\n      .map(type => type.replace(\"service_\", \"\"));\n    \n    // Also get services that match appointment types\n    const matchingServices = appointmentTypes\n      .filter(type => selectedAppointmentTypes.includes(type.value))\n      .map(type => type.serviceId?.toString())\n      .filter(Boolean);\n    \n    const allServiceIds = [...new Set([...serviceIds, ...matchingServices])];\n    \n    // Filter packages that have matching service_id or no service_id (for post-payment)\n    return paymentPackages.filter(pkg => {\n      if (!pkg.service_id) return true; // Post-payment packages can be linked to any appointment\n      return allServiceIds.includes(pkg.service_id.toString());\n    });\n  }, [paymentPackages, services, selectedAppointmentTypes, appointmentTypes]);\n\n  // Get selected package\n  const selectedPackageId = watch(\"payment_package_id\");\n  const selectedPackage = availablePackages.find(p => p.id.toString() === selectedPackageId);\n  \n  // Get usage data for selected package\n  const { sessionsUsed, hoursUsed, isLoading: isLoadingUsage } = usePackageUsage(\n    selectedPackage?.id\n  );\n  \n  // Filter patients based on search\n  const filteredPatients = useMemo(() => {\n    if (!patients) return [];\n    if (!patientSearch) return patients;\n    const searchLower = patientSearch.toLowerCase();\n    return patients.filter((patient) => {\n      const fullName = `${patient.first_name} ${patient.last_name}`.toLowerCase();\n      return fullName.includes(searchLower) || \n             patient.first_name?.toLowerCase().includes(searchLower) ||\n             patient.last_name?.toLowerCase().includes(searchLower);\n    });\n  }, [patients, patientSearch]);\n  \n  const selectedPatient = patients?.find((p) => p.id.toString() === selectedPatientId);\n\n  const startTime = watch(\"start_time\");\n  const endTime = watch(\"end_time\");\n  const durationMinutes = watch(\"duration_minutes\");\n  const appointmentDate = watch(\"appointment_date\");\n  const hasSetFromCalendar = React.useRef(false);\n  const isUpdatingFromDuration = React.useRef(false);\n  const isUpdatingFromEndTime = React.useRef(false);\n  const [durationUnit, setDurationUnit] = useState<\"minutes\" | \"hours\">(\"minutes\");\n\n  // Register duration_minutes field for validation\n  React.useEffect(() => {\n    register(\"duration_minutes\", { required: true, min: 15 });\n  }, [register]);\n\n\n  // Update form values when initialDateTime is provided (for new appointments from calendar drag)\n  React.useEffect(() => {\n    if (!appointment && initialDateTime) {\n      const start = initialDateTime.start;\n      const end = initialDateTime.end;\n      \n      // Ensure start and end are Date objects\n      const startDate = start instanceof Date ? start : new Date(start);\n      const endDate = end instanceof Date ? end : new Date(end);\n      \n      // Validate dates - check if they're valid Date objects\n      if (!(startDate instanceof Date && endDate instanceof Date) || \n          isNaN(startDate.getTime()) || \n          isNaN(endDate.getTime()) ||\n          startDate.getTime() === 0 ||\n          endDate.getTime() === 0) {\n        // Silently skip update instead of logging\n        return;\n      }\n      \n      const durationMs = endDate.getTime() - startDate.getTime();\n      const durationMinutes = Math.max(Math.round(durationMs / (60 * 1000)), 15);\n      \n      // Format date and time in CRM timezone\n      const dateStr = crmDateYmdInputString(startDate) || `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, \"0\")}-${String(startDate.getDate()).padStart(2, \"0\")}`;\n      const startTimeStr = extractCrmTime(startDate);\n      const endTimeStr = extractCrmTime(endDate);\n      \n      hasSetFromCalendar.current = true;\n      setValue(\"appointment_date\", dateStr, { shouldValidate: false, shouldDirty: false });\n      setValue(\"start_time\", startTimeStr, { shouldValidate: false, shouldDirty: false });\n      setValue(\"end_time\", endTimeStr, { shouldValidate: false, shouldDirty: false });\n      setValue(\"duration_minutes\", durationMinutes, { shouldValidate: false, shouldDirty: false });\n      \n      // Reset the flag after a short delay to allow auto-calculation on user changes\n      setTimeout(() => {\n        hasSetFromCalendar.current = false;\n      }, 100);\n    }\n  }, [initialDateTime, appointment, setValue]);\n\n  // Auto-calculate end_time when start_time or duration changes\n  // Skip if we just set values from calendar selection to preserve the selected time range\n  React.useEffect(() => {\n    if (startTime && durationMinutes && !hasSetFromCalendar.current && !isUpdatingFromEndTime.current) {\n      isUpdatingFromDuration.current = true;\n      const [hours, minutes] = startTime.split(\":\").map(Number);\n      const start = new Date();\n      start.setHours(hours, minutes, 0, 0);\n      const end = new Date(start.getTime() + durationMinutes * 60 * 1000);\n      const endTimeStr = `${end.getHours().toString().padStart(2, \"0\")}:${end\n        .getMinutes()\n        .toString()\n        .padStart(2, \"0\")}`;\n      // Only set if end_time is not already set or if it would be different\n      const currentEndTime = watch(\"end_time\");\n      if (!currentEndTime || currentEndTime !== endTimeStr) {\n        setValue(\"end_time\", endTimeStr, { shouldValidate: false });\n      }\n      setTimeout(() => {\n        isUpdatingFromDuration.current = false;\n      }, 0);\n    }\n  }, [startTime, durationMinutes, setValue, watch]);\n\n  // Auto-calculate duration_minutes when start_time or end_time changes\n  // Skip if we just set values from calendar selection to preserve the selected time range\n  React.useEffect(() => {\n    if (startTime && endTime && !hasSetFromCalendar.current && !isUpdatingFromDuration.current) {\n      isUpdatingFromEndTime.current = true;\n      const [startHours, startMinutes] = startTime.split(\":\").map(Number);\n      const [endHours, endMinutes] = endTime.split(\":\").map(Number);\n      const start = new Date();\n      start.setHours(startHours, startMinutes, 0, 0);\n      const end = new Date();\n      end.setHours(endHours, endMinutes, 0, 0);\n      \n      // Handle case where end time is next day\n      if (end.getTime() < start.getTime()) {\n        end.setDate(end.getDate() + 1);\n      }\n      \n      const durationMs = end.getTime() - start.getTime();\n      const calculatedDurationMinutes = Math.max(Math.round(durationMs / (60 * 1000)), 15);\n      \n      // Only update if duration would be different (to avoid infinite loops)\n      if (calculatedDurationMinutes !== durationMinutes) {\n        setValue(\"duration_minutes\", calculatedDurationMinutes, { shouldValidate: false });\n      }\n      setTimeout(() => {\n        isUpdatingFromEndTime.current = false;\n      }, 0);\n    }\n  }, [startTime, endTime, setValue, durationMinutes]);\n\n  const onFormSubmit = (data: AppointmentFormData) => {\n    // Convert \"__none__\" back to empty string for payment_package_id\n    if (data.payment_package_id === \"__none__\") {\n      data.payment_package_id = \"\";\n    }\n    onSubmit(data);\n  };\n\n  // Generate time options with 15-minute intervals\n  const timeOptions = useMemo(() => {\n    const options = [];\n    for (let hour = 0; hour < 24; hour++) {\n      for (let minute = 0; minute < 60; minute += 15) {\n        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;\n        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;\n        const displayTime = `${displayHour}:${minute.toString().padStart(2, '0')} ${hour >= 12 ? 'PM' : 'AM'}`;\n        options.push({ value: timeString, label: displayTime });\n      }\n    }\n    return options;\n  }, []);\n\n  return (\n    <form id=\"appointment-form\" onSubmit={handleSubmit(onFormSubmit)} className=\"space-y-5\">\n      {/* Patient Selection */}\n      <div>\n        <Label htmlFor=\"patient_id\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n          Patient <span className=\"text-red-500\">*</span>\n        </Label>\n        <Popover open={patientOpen} onOpenChange={setPatientOpen}>\n          <PopoverTrigger asChild>\n            <Button\n              variant=\"outline\"\n              role=\"combobox\"\n              aria-expanded={patientOpen}\n              className=\"w-full h-9 justify-between rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 font-normal text-sm\"\n            >\n              {selectedPatient ? (\n                <span className=\"truncate\">\n                  {selectedPatient.first_name} {selectedPatient.last_name}\n                </span>\n              ) : (\n                <span className=\"text-slate-500 dark:text-slate-400\">Search for a patient...</span>\n              )}\n              <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n            </Button>\n          </PopoverTrigger>\n          <PopoverContent className=\"p-0\" align=\"start\" sideOffset={4} style={{ width: 'var(--radix-popover-trigger-width)' }}>\n            <Command className=\"rounded-lg border-0\">\n              <div className=\"flex items-center border-b px-3\">\n                <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n                <CommandInput\n                  placeholder=\"Search patients...\"\n                  value={patientSearch}\n                  onValueChange={setPatientSearch}\n                  className=\"border-0 focus:ring-0\"\n                />\n              </div>\n              <CommandList className=\"max-h-[300px]\">\n                <CommandEmpty>No patient found.</CommandEmpty>\n                <CommandGroup>\n                  {filteredPatients.map((patient) => (\n                    <CommandItem\n                      key={patient.id}\n                      value={`${patient.first_name} ${patient.last_name}`}\n                      onSelect={() => {\n                        setValue(\"patient_id\", patient.id.toString());\n                        setPatientOpen(false);\n                        setPatientSearch(\"\");\n                      }}\n                      className=\"cursor-pointer\"\n                    >\n                      <Check\n                        className={cn(\n                          \"mr-2 h-4 w-4\",\n                          selectedPatientId === patient.id.toString() ? \"opacity-100\" : \"opacity-0\"\n                        )}\n                      />\n                      <div className=\"flex flex-col\">\n                        <span className=\"font-medium\">\n                          {patient.first_name} {patient.last_name}\n                        </span>\n                        {patient.email && (\n                          <span className=\"text-xs text-slate-500 dark:text-slate-400\">\n                            {patient.email}\n                          </span>\n                        )}\n                      </div>\n                    </CommandItem>\n                  ))}\n                </CommandGroup>\n              </CommandList>\n            </Command>\n          </PopoverContent>\n        </Popover>\n        {errors.patient_id && (\n          <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">Patient is required</p>\n        )}\n      </div>\n\n      {/* Row 2: Date, Start, End, Duration */}\n      <div className=\"grid grid-cols-4 gap-3\">\n        <div>\n          <Label htmlFor=\"appointment_date\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Date <span className=\"text-red-500\">*</span>\n          </Label>\n          <Input\n            type=\"date\"\n            {...register(\"appointment_date\", { required: true })}\n            className=\"h-9 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm\"\n          />\n          {errors.appointment_date && (\n            <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">Required</p>\n          )}\n        </div>\n        <div>\n          <Label htmlFor=\"start_time\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Start <span className=\"text-red-500\">*</span>\n          </Label>\n          <Select\n            value={watch(\"start_time\") || \"\"}\n            onValueChange={(value) => setValue(\"start_time\", value)}\n          >\n            <SelectTrigger className=\"h-9 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm\">\n              <SelectValue placeholder=\"--:--\" />\n            </SelectTrigger>\n            <SelectContent className=\"max-h-[300px]\">\n              {timeOptions.map((time) => (\n                <SelectItem key={time.value} value={time.value}>\n                  {time.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          {errors.start_time && (\n            <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">Required</p>\n          )}\n        </div>\n        <div>\n          <Label htmlFor=\"end_time\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            End <span className=\"text-red-500\">*</span>\n          </Label>\n          <Select\n            value={watch(\"end_time\") || \"\"}\n            onValueChange={(value) => setValue(\"end_time\", value)}\n          >\n            <SelectTrigger className=\"h-9 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm\">\n              <SelectValue placeholder=\"--:--\" />\n            </SelectTrigger>\n            <SelectContent className=\"max-h-[300px]\">\n              {timeOptions.map((time) => (\n                <SelectItem key={time.value} value={time.value}>\n                  {time.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          {errors.end_time && (\n            <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">Required</p>\n          )}\n        </div>\n        <div>\n          <div className=\"flex items-center justify-between mb-1.5\">\n            <Label htmlFor=\"duration_minutes\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\n              Duration <span className=\"text-red-500\">*</span>\n            </Label>\n            <div className=\"flex items-center gap-2\">\n              <span className={cn(\"text-xs text-slate-600 dark:text-slate-400\", durationUnit === \"minutes\" && \"font-medium\")}>\n                M\n              </span>\n              <Switch\n                checked={durationUnit === \"hours\"}\n                onCheckedChange={(checked) => {\n                  const newUnit = checked ? \"hours\" : \"minutes\";\n                  setDurationUnit(newUnit);\n                  // Convert current value when switching units\n                  const currentValue = durationMinutes;\n                  if (newUnit === \"hours\") {\n                    // Convert minutes to hours (round to 1 decimal)\n                    const hoursValue = Math.round((currentValue / 60) * 10) / 10;\n                    // Store the hours value temporarily in a ref or state\n                    // We'll handle the conversion in the input's onChange\n                  } else {\n                    // Convert hours back to minutes\n                    // This will be handled by the input's onChange\n                  }\n                }}\n                className=\"h-4 w-7\"\n              />\n              <span className={cn(\"text-xs text-slate-600 dark:text-slate-400\", durationUnit === \"hours\" && \"font-medium\")}>\n                H\n              </span>\n            </div>\n          </div>\n          <Input\n            type=\"number\"\n            id=\"duration_minutes\"\n            value={durationUnit === \"hours\" \n              ? (durationMinutes / 60).toFixed(1)\n              : durationMinutes.toString()\n            }\n            onChange={(e) => {\n              const inputValue = parseFloat(e.target.value);\n              if (isNaN(inputValue) || inputValue < 0) {\n                // Allow empty input\n                if (e.target.value === \"\") return;\n                return;\n              }\n              \n              const newDurationMinutes = durationUnit === \"hours\" \n                ? Math.round(inputValue * 60)\n                : Math.round(inputValue);\n              \n              // Ensure minimum of 15 minutes\n              const finalDuration = Math.max(newDurationMinutes, 15);\n              setValue(\"duration_minutes\", finalDuration, { shouldValidate: true });\n            }}\n            onBlur={() => {\n              // Ensure value is set even if user didn't type anything\n              if (!durationMinutes || durationMinutes < 15) {\n                setValue(\"duration_minutes\", 15, { shouldValidate: true });\n              }\n            }}\n            className=\"h-9 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm\"\n            placeholder={durationUnit === \"hours\" ? \"1.0\" : \"60\"}\n            step={durationUnit === \"hours\" ? \"0.25\" : \"15\"}\n            min={durationUnit === \"hours\" ? \"0.25\" : \"15\"}\n            required\n          />\n          {errors.duration_minutes && (\n            <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">\n              {durationUnit === \"hours\" ? \"Min 0.25 hours (15 min)\" : \"Min 15 min\"}\n            </p>\n          )}\n        </div>\n      </div>\n\n      {/* Row 3: Type, Status */}\n      <div className=\"grid grid-cols-2 gap-3\">\n        <div>\n          <Label htmlFor=\"appointment_type\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Type <span className=\"text-red-500\">*</span>\n          </Label>\n          <CustomMultiSelect\n            options={appointmentTypes.map((type) => ({\n              value: type.value,\n              label: type.label,\n              color: type.color,\n              serviceId: type.serviceId,\n            }))}\n            selected={watch(\"appointment_type\") || []}\n            onChange={(selected) => {\n              setValue(\"appointment_type\", selected);\n              // Clear payment package if appointment type changes and package doesn't match\n              const currentPackageId = watch(\"payment_package_id\");\n              if (currentPackageId && availablePackages.length > 0) {\n                const currentPackage = availablePackages.find(p => p.id.toString() === currentPackageId);\n                if (!currentPackage) {\n                  setValue(\"payment_package_id\", \"\");\n                }\n              }\n            }}\n            placeholder=\"Select types\"\n            className=\"h-9\"\n          />\n          {errors.appointment_type && (\n            <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">Required</p>\n          )}\n        </div>\n        <div>\n          <Label htmlFor=\"status\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Status <span className=\"text-red-500\">*</span>\n          </Label>\n          <Select\n            value={watch(\"status\") || \"\"}\n            onValueChange={(value) => setValue(\"status\", value)}\n          >\n            <SelectTrigger className=\"h-9 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm\">\n              <SelectValue placeholder=\"Select\" />\n            </SelectTrigger>\n            <SelectContent>\n              {APPOINTMENT_STATUSES.map((status) => (\n                <SelectItem key={status.value} value={status.value}>\n                  {status.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      {/* Payment Package Link */}\n      {selectedPatientId && (\n        <div>\n          <Label htmlFor=\"payment_package_id\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Link to Payment Package (Optional)\n          </Label>\n          <Select\n            value={watch(\"payment_package_id\") || \"__none__\"}\n            onValueChange={(value) => {\n              if (value && value !== \"__none__\") {\n                const selectedPackage = availablePackages.find(p => p.id.toString() === value);\n                if (selectedPackage) {\n                  // Validate service type matches\n                  const packageService = services?.find(s => s.id === selectedPackage.service_id);\n                  if (packageService && selectedAppointmentTypes.length > 0) {\n                    const matches = selectedAppointmentTypes.some(type => {\n                      const serviceId = type.replace(\"service_\", \"\");\n                      return serviceId === packageService.id.toString() || \n                             appointmentTypes.some(at => at.value === type && at.serviceId === packageService.id);\n                    });\n                    if (!matches && selectedPackage.package_type !== \"post-payment\") {\n                      setValue(\"payment_package_id\", \"\");\n                      alert(`This package is for ${packageService.name}, which doesn't match the selected appointment type.`);\n                      return;\n                    }\n                  }\n                  setValue(\"payment_package_id\", value);\n                }\n              } else {\n                setValue(\"payment_package_id\", \"\");\n              }\n            }}\n          >\n            <SelectTrigger className=\"h-9 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm\">\n              <SelectValue placeholder=\"Select package (optional)\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"__none__\">None</SelectItem>\n              {availablePackages.length > 0 ? (\n                availablePackages.map((pkg) => {\n                  // Get patient name\n                  const patient = patientsMap.get(Number(pkg.patient_id));\n                  const patientName = patient \n                    ? `${patient.first_name} ${patient.last_name}`.trim()\n                    : `Patient #${pkg.patient_id}`;\n                  \n                  // Use package name if available, otherwise build from service\n                  const serviceName = services?.find(s => s.id === pkg.service_id)?.name || \"Service\";\n                  const packageName = (pkg as any).name || `${serviceName} Package`;\n                  \n                  // Build label: \"Package Name - Patient Name - Status\"\n                  const packageLabel = `${packageName} - ${patientName} - ${pkg.status}`;\n                  \n                  return (\n                    <SelectItem key={pkg.id} value={pkg.id.toString()}>\n                      {packageLabel}\n                    </SelectItem>\n                  );\n                })\n              ) : selectedAppointmentTypes.length > 0 ? (\n                <SelectGroup>\n                  <SelectLabel>No matching packages found</SelectLabel>\n                </SelectGroup>\n              ) : (\n                <SelectGroup>\n                  <SelectLabel>Select appointment type first</SelectLabel>\n                </SelectGroup>\n              )}\n            </SelectContent>\n          </Select>\n          {selectedPackage && (\n            <div className=\"mt-2 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700\">\n              <p className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                Package Details:\n              </p>\n              {isLoadingUsage ? (\n                <p className=\"text-xs text-slate-500 dark:text-slate-400\">Loading usage data...</p>\n              ) : (\n                <div className=\"space-y-1 text-xs text-slate-600 dark:text-slate-400\">\n                  {selectedPackage.package_type === \"session-based\" && selectedPackage.total_sessions && (\n                    <p>\n                      <span className=\"font-medium\">Sessions:</span> {sessionsUsed || 0} / {selectedPackage.total_sessions} used\n                      {selectedPackage.total_sessions > (sessionsUsed || 0) && (\n                        <span className=\"ml-1 text-green-600 dark:text-green-400\">\n                          ({selectedPackage.total_sessions - (sessionsUsed || 0)} remaining)\n                        </span>\n                      )}\n                    </p>\n                  )}\n                  {selectedPackage.package_type === \"time-based\" && (\n                    <>\n                      {selectedPackage.hours_per_day && (\n                        <p>\n                          <span className=\"font-medium\">Hours per day:</span> {selectedPackage.hours_per_day}\n                        </p>\n                      )}\n                      {selectedPackage.total_hours && (\n                        <p>\n                          <span className=\"font-medium\">Hours:</span> {hoursUsed || 0} / {selectedPackage.total_hours} used\n                          {selectedPackage.total_hours > (hoursUsed || 0) && (\n                            <span className=\"ml-1 text-green-600 dark:text-green-400\">\n                              ({selectedPackage.total_hours - (hoursUsed || 0)} remaining)\n                            </span>\n                          )}\n                        </p>\n                      )}\n                    </>\n                  )}\n                  {selectedPackage.package_type === \"post-payment\" && (\n                    <p>\n                      <span className=\"font-medium\">Next payment date:</span>{\" \"}\n                      {selectedPackage.next_payment_date ? (\n                        new Date(selectedPackage.next_payment_date).toLocaleDateString()\n                      ) : (\n                        <span className=\"text-yellow-600 dark:text-yellow-400\">Not set</span>\n                      )}\n                    </p>\n                  )}\n                </div>\n              )}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Row 4: Staff, Driver */}\n      <div className=\"grid grid-cols-2 gap-3\">\n        <div>\n          <Label htmlFor=\"staff_ids\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Staff\n          </Label>\n          <CustomMultiSelect\n            options={staff?.filter((s) => {\n              // Filter out Management and Driver staff types\n              const staffTypeLower = s.staff_type?.toLowerCase() || \"\";\n              return s.first_name && \n                     s.last_name && \n                     !staffTypeLower.includes(\"management\") && \n                     !staffTypeLower.includes(\"driver\");\n            }).map((s) => ({\n              value: s.id.toString(),\n              label: `${s.first_name.trim()} ${s.last_name.trim()}`.trim(),\n            })) || []}\n            selected={watch(\"staff_ids\") || []}\n            onChange={(selected) => setValue(\"staff_ids\", selected)}\n            placeholder=\"Select staff\"\n            className=\"h-9\"\n          />\n        </div>\n        <div>\n          <Label htmlFor=\"driver_id\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Driver\n          </Label>\n          <Select\n            value={watch(\"driver_id\") || \"\"}\n            onValueChange={(value) => setValue(\"driver_id\", value || \"\")}\n          >\n            <SelectTrigger className=\"h-9 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm\">\n              <SelectValue placeholder=\"Optional\" />\n            </SelectTrigger>\n            <SelectContent>\n              {staff?.filter((s) => s.staff_type.toLowerCase().includes(\"driver\")).map((s) => (\n                <SelectItem key={s.id} value={s.id.toString()}>\n                  {s.first_name} {s.last_name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      {/* Recurrence Configuration */}\n      <div className=\"space-y-4 pt-4 border-t border-slate-200 dark:border-slate-700\">\n        <div className=\"flex items-center space-x-2\">\n          <Checkbox\n            id=\"is_recurring\"\n            checked={isRecurring || false}\n            onCheckedChange={(checked) => {\n              setValue(\"is_recurring\", checked as boolean);\n              if (!checked) {\n                // Reset recurrence fields when disabled\n                setValue(\"recurrence_pattern\", \"daily\");\n                setValue(\"recurrence_interval\", 1);\n                setValue(\"recurrence_end_type\", \"occurrences\");\n                setValue(\"recurrence_occurrences\", 10);\n                setValue(\"recurrence_end_date\", \"\");\n                setValue(\"recurrence_days_of_week\", []);\n              }\n            }}\n            className=\"w-5 h-5 rounded-md border-slate-300 dark:border-slate-600\"\n          />\n          <Label htmlFor=\"is_recurring\" className=\"text-base font-medium text-slate-900 dark:text-slate-100 cursor-pointer\">\n            Make this a recurring appointment\n          </Label>\n        </div>\n\n        {isRecurring && (\n          <div className=\"space-y-3 pl-4 border-l-2 border-purple-200 dark:border-purple-800 bg-purple-50/20 dark:bg-purple-950/10 rounded-r-lg p-4\">\n            {/* Pattern and Interval - Compact Grid */}\n            <div className=\"grid grid-cols-3 gap-3\">\n              <div className=\"col-span-2\">\n                <Label htmlFor=\"recurrence_pattern\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n                  Pattern <span className=\"text-red-500\">*</span>\n                </Label>\n                <Select\n                  value={recurrencePattern}\n                  onValueChange={(value) => {\n                    setValue(\"recurrence_pattern\", value as any);\n                    setValue(\"recurrence_days_of_week\", []);\n                    setValue(\"recurrence_day_of_month\", undefined);\n                    setValue(\"recurrence_week_of_month\", undefined);\n                    setValue(\"recurrence_month\", undefined);\n                  }}\n                >\n                  <SelectTrigger className=\"h-9 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"daily\">Daily</SelectItem>\n                    <SelectItem value=\"weekly\">Weekly</SelectItem>\n                    <SelectItem value=\"monthly\">Monthly</SelectItem>\n                    <SelectItem value=\"yearly\">Yearly</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label htmlFor=\"recurrence_interval\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n                  Every\n                </Label>\n                <div className=\"flex gap-1\">\n                  <Input\n                    type=\"number\"\n                    min=\"1\"\n                    value={watch(\"recurrence_interval\") || 1}\n                    onChange={(e) => setValue(\"recurrence_interval\", parseInt(e.target.value) || 1)}\n                    className=\"h-9 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm flex-1\"\n                  />\n                  <div className=\"flex items-center text-xs text-slate-600 dark:text-slate-400 px-2\">\n                    {recurrencePattern === \"daily\" && \"day(s)\"}\n                    {recurrencePattern === \"weekly\" && \"week(s)\"}\n                    {recurrencePattern === \"monthly\" && \"month(s)\"}\n                    {recurrencePattern === \"yearly\" && \"year(s)\"}\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* Weekly: Days of Week */}\n            {recurrencePattern === \"weekly\" && (\n              <div>\n                <Label className=\"text-xs font-medium text-slate-600 dark:text-slate-400 mb-2 block\">\n                  Days\n                </Label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {[\n                    { value: 1, label: \"Mo\" },\n                    { value: 2, label: \"Tu\" },\n                    { value: 3, label: \"We\" },\n                    { value: 4, label: \"Th\" },\n                    { value: 5, label: \"Fr\" },\n                    { value: 6, label: \"Sa\" },\n                    { value: 0, label: \"Su\" },\n                  ].map((day) => (\n                    <button\n                      key={day.value}\n                      type=\"button\"\n                      onClick={() => {\n                        const current = recurrenceDaysOfWeek || [];\n                        if (recurrenceDaysOfWeek.includes(day.value)) {\n                          setValue(\n                            \"recurrence_days_of_week\",\n                            current.filter((d) => d !== day.value)\n                          );\n                        } else {\n                          setValue(\"recurrence_days_of_week\", [...current, day.value]);\n                        }\n                      }}\n                      className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${\n                        recurrenceDaysOfWeek.includes(day.value)\n                          ? \"bg-blue-600 text-white shadow-sm\"\n                          : \"bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-blue-400\"\n                      }`}\n                    >\n                      {day.label}\n                    </button>\n                  ))}\n                </div>\n              </div>\n            )}\n\n\n            {/* Monthly: Day of Month */}\n            {recurrencePattern === \"monthly\" && (\n              <div>\n                <Label htmlFor=\"recurrence_day_of_month\">Day of Month</Label>\n                <Input\n                  type=\"number\"\n                  min=\"1\"\n                  max=\"31\"\n                  placeholder=\"e.g., 15\"\n                  value={watch(\"recurrence_day_of_month\") || \"\"}\n                  onChange={(e) =>\n                    setValue(\"recurrence_day_of_month\", parseInt(e.target.value) || undefined)\n                  }\n                />\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  Leave empty to use the same day as start date\n                </p>\n              </div>\n            )}\n\n            {/* Yearly: Month */}\n            {recurrencePattern === \"yearly\" && (\n              <div>\n                <Label htmlFor=\"recurrence_month\">Month</Label>\n                <Select\n                  value={watch(\"recurrence_month\")?.toString() || \"\"}\n                  onValueChange={(value) => setValue(\"recurrence_month\", parseInt(value) || undefined)}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select month\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {[\n                      { value: 1, label: \"January\" },\n                      { value: 2, label: \"February\" },\n                      { value: 3, label: \"March\" },\n                      { value: 4, label: \"April\" },\n                      { value: 5, label: \"May\" },\n                      { value: 6, label: \"June\" },\n                      { value: 7, label: \"July\" },\n                      { value: 8, label: \"August\" },\n                      { value: 9, label: \"September\" },\n                      { value: 10, label: \"October\" },\n                      { value: 11, label: \"November\" },\n                      { value: 12, label: \"December\" },\n                    ].map((month) => (\n                      <SelectItem key={month.value} value={month.value.toString()}>\n                        {month.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            )}\n\n            {/* End Condition - Compact */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <div className=\"flex items-center gap-2 p-2 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700\">\n                <input\n                  type=\"radio\"\n                  id=\"end_type_occurrences\"\n                  name=\"recurrence_end_type\"\n                  value=\"occurrences\"\n                  checked={recurrenceEndType === \"occurrences\"}\n                  onChange={() => setValue(\"recurrence_end_type\", \"occurrences\")}\n                  className=\"w-4 h-4 text-blue-600\"\n                />\n                <Label htmlFor=\"end_type_occurrences\" className=\"cursor-pointer flex items-center gap-2 text-sm flex-1\">\n                  <span>After</span>\n                  <Input\n                    type=\"number\"\n                    min=\"1\"\n                    max=\"1000\"\n                    className=\"h-7 w-16 rounded border-slate-300 dark:border-slate-600 text-xs\"\n                    value={watch(\"recurrence_occurrences\") || 10}\n                    onChange={(e) =>\n                      setValue(\"recurrence_occurrences\", parseInt(e.target.value) || 10)\n                    }\n                    disabled={recurrenceEndType !== \"occurrences\"}\n                  />\n                </Label>\n              </div>\n              <div className=\"flex items-center gap-2 p-2 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700\">\n                <input\n                  type=\"radio\"\n                  id=\"end_type_date\"\n                  name=\"recurrence_end_type\"\n                  value=\"date\"\n                  checked={recurrenceEndType === \"date\"}\n                  onChange={() => setValue(\"recurrence_end_type\", \"date\")}\n                  className=\"w-4 h-4 text-blue-600\"\n                />\n                <Label htmlFor=\"end_type_date\" className=\"cursor-pointer flex items-center gap-2 text-sm flex-1\">\n                  <span>On</span>\n                  <Input\n                    type=\"date\"\n                    className=\"h-7 flex-1 rounded border-slate-300 dark:border-slate-600 text-xs\"\n                    value={watch(\"recurrence_end_date\") || \"\"}\n                    onChange={(e) => setValue(\"recurrence_end_date\", e.target.value)}\n                    disabled={recurrenceEndType !== \"date\"}\n                    min={appointmentDate}\n                  />\n                </Label>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Notes Section - Compact */}\n      <div className=\"space-y-3 pt-4 border-t border-slate-200 dark:border-slate-700\">\n        <div>\n          <Label htmlFor=\"mini_notes\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Brief Notes\n          </Label>\n          <Textarea\n            {...register(\"mini_notes\")}\n            placeholder=\"Brief notes...\"\n            rows={2}\n            className=\"rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 resize-none text-sm\"\n          />\n        </div>\n        <div>\n          <Label htmlFor=\"full_notes\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Detailed Notes\n          </Label>\n          <Textarea\n            {...register(\"full_notes\")}\n            placeholder=\"Detailed notes...\"\n            rows={3}\n            className=\"rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 resize-none text-sm\"\n          />\n        </div>\n        <div>\n          <Label htmlFor=\"pickup_instructions\" className=\"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n            Pickup Instructions\n          </Label>\n          <Textarea\n            {...register(\"pickup_instructions\")}\n            placeholder=\"Special instructions...\"\n            rows={2}\n            className=\"rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 resize-none text-sm\"\n          />\n        </div>\n      </div>\n    </form>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentFiltersTop.tsx",
      "content": "import React, { useMemo, useState } from \"react\";\nimport { Filter, X, ChevronDown, ChevronUp, Calendar } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { CustomMultiSelect, type MultiSelectOption } from \"./CustomMultiSelect\";\nimport type { AppointmentFilterState } from \"./types\";\nimport { APPOINTMENT_STATUSES } from \"./types\";\nimport { Clock, CheckCircle, XCircle } from \"lucide-react\";\nimport type { Staff } from \"../types\";\nimport { useGetList } from \"ra-core\";\nimport { useAppointmentTypes } from \"./useAppointmentTypes\";\n\ntype AppointmentFiltersTopProps = {\n  filters: AppointmentFilterState;\n  onFiltersChange: (filters: AppointmentFilterState) => void;\n  onApply: () => void;\n};\n\nconst StatusIconMap: Record<string, React.ReactNode> = {\n  scheduled: <Clock className=\"w-3 h-3\" />,\n  completed: <CheckCircle className=\"w-3 h-3\" />,\n  cancelled: <XCircle className=\"w-3 h-3\" />,\n};\n\nexport const AppointmentFiltersTop: React.FC<AppointmentFiltersTopProps> = ({\n  filters,\n  onFiltersChange,\n  onApply,\n}) => {\n  const [isExpanded, setIsExpanded] = useState(false);\n  \n  const { data: staffData } = useGetList<Staff>(\"staff\", {\n    pagination: { page: 1, perPage: 1000 },\n  }, {\n    retry: false,\n    enabled: true,\n    onError: (error) => {\n      console.warn(\"Failed to load staff for filters:\", error);\n    },\n  });\n\n  const appointmentTypes = useAppointmentTypes();\n\n  const activeFilterCount = useMemo(() => {\n    let count = 0;\n    if (filters.staffIds.length > 0) count++;\n    if (filters.appointmentTypes.length > 0) count++;\n    if (filters.statuses.length > 0) count++;\n    if (filters.dateFrom || filters.dateTo) count++;\n    return count;\n  }, [filters]);\n\n  const staffOptions: MultiSelectOption[] = useMemo(() => {\n    if (!staffData) return [];\n    return staffData.map((staff) => ({\n      value: staff.id.toString(),\n      label: `${staff.first_name} ${staff.last_name} (${staff.staff_type})`,\n      color: \"#6b7280\",\n    }));\n  }, [staffData]);\n\n  const appointmentTypeOptions: MultiSelectOption[] = useMemo(() => {\n    return appointmentTypes.map((type) => ({\n      value: type.value,\n      label: type.label,\n      color: type.color,\n      serviceId: type.serviceId,\n    }));\n  }, [appointmentTypes]);\n\n  const statusOptions: MultiSelectOption[] = useMemo(() => {\n    return APPOINTMENT_STATUSES.map((status) => ({\n      value: status.value,\n      label: status.label,\n      color: status.color,\n      icon: StatusIconMap[status.value],\n    }));\n  }, []);\n\n  const handleClear = () => {\n    onFiltersChange({\n      staffIds: [],\n      appointmentTypes: [],\n      statuses: [],\n      dateFrom: null,\n      dateTo: null,\n    });\n  };\n\n  return (\n    <div className=\"bg-transparent\">\n      {/* Collapsed Header - Single Row */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setIsExpanded(!isExpanded)}\n            className=\"h-8 px-2\"\n          >\n            <Filter className=\"w-4 h-4 mr-1\" />\n            Filters\n            {activeFilterCount > 0 && (\n              <Badge variant=\"secondary\" className=\"ml-1 h-5 px-1.5 text-xs\">\n                {activeFilterCount}\n              </Badge>\n            )}\n            {isExpanded ? (\n              <ChevronUp className=\"w-4 h-4 ml-1\" />\n            ) : (\n              <ChevronDown className=\"w-4 h-4 ml-1\" />\n            )}\n          </Button>\n          \n          {/* Active filters summary when collapsed */}\n          {!isExpanded && activeFilterCount > 0 && (\n            <div className=\"flex items-center gap-1 flex-wrap\">\n              {filters.staffIds.length > 0 && (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  {filters.staffIds.length} staff\n                </Badge>\n              )}\n              {filters.appointmentTypes.length > 0 && (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  {filters.appointmentTypes.length} types\n                </Badge>\n              )}\n              {filters.statuses.length > 0 && (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  {filters.statuses.length} statuses\n                </Badge>\n              )}\n              {(filters.dateFrom || filters.dateTo) && (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  Date range\n                </Badge>\n              )}\n            </div>\n          )}\n        </div>\n        \n        {!isExpanded && activeFilterCount > 0 && (\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={handleClear}\n            className=\"h-8 px-2 text-xs\"\n          >\n            <X className=\"w-3 h-3 mr-1\" />\n            Clear\n          </Button>\n        )}\n      </div>\n\n      {/* Expanded Content */}\n      {isExpanded && (\n        <div className=\"border-t border-slate-200 dark:border-slate-700 p-4 space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            {/* Staff Filter */}\n            <div>\n              <label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n                Staff\n              </label>\n              <CustomMultiSelect\n                options={staffOptions}\n                selectedValues={filters.staffIds}\n                onChange={(values) =>\n                  onFiltersChange({ ...filters, staffIds: values })\n                }\n                placeholder=\"Select staff\"\n              />\n            </div>\n\n            {/* Appointment Type Filter */}\n            <div>\n              <label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n                Appointment Type\n              </label>\n              <CustomMultiSelect\n                options={appointmentTypeOptions}\n                selectedValues={filters.appointmentTypes}\n                onChange={(values) =>\n                  onFiltersChange({ ...filters, appointmentTypes: values })\n                }\n                placeholder=\"Select types\"\n              />\n            </div>\n\n            {/* Status Filter */}\n            <div>\n              <label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n                Status\n              </label>\n              <CustomMultiSelect\n                options={statusOptions}\n                selectedValues={filters.statuses}\n                onChange={(values) =>\n                  onFiltersChange({ ...filters, statuses: values })\n                }\n                placeholder=\"Select statuses\"\n              />\n            </div>\n\n            {/* Date Range */}\n            <div>\n              <label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n                Date Range\n              </label>\n              <div className=\"space-y-1.5\">\n                <div className=\"relative\">\n                  <Calendar className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none\" />\n                  <Input\n                    type=\"date\"\n                    value={filters.dateFrom || \"\"}\n                    onChange={(e) =>\n                      onFiltersChange({ ...filters, dateFrom: e.target.value || null })\n                    }\n                    className=\"w-full pl-8 pr-2 py-1.5 text-xs border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100\"\n                    placeholder=\"From date\"\n                  />\n                </div>\n                <div className=\"relative\">\n                  <Calendar className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none\" />\n                  <Input\n                    type=\"date\"\n                    value={filters.dateTo || \"\"}\n                    onChange={(e) =>\n                      onFiltersChange({ ...filters, dateTo: e.target.value || null })\n                    }\n                    className=\"w-full pl-8 pr-2 py-1.5 text-xs border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100\"\n                    placeholder=\"To date\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Action Buttons */}\n          <div className=\"flex items-center justify-between pt-2 border-t border-slate-200 dark:border-slate-700\">\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={handleClear}\n              className=\"text-xs\"\n            >\n              <X className=\"w-3 h-3 mr-1\" />\n              Clear All\n            </Button>\n            <div className=\"flex items-center gap-2\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setIsExpanded(false)}\n                className=\"text-xs\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"button\"\n                size=\"sm\"\n                onClick={() => {\n                  onApply();\n                  setIsExpanded(false);\n                }}\n                className=\"text-xs\"\n              >\n                Apply Filters\n              </Button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentFilters.tsx",
      "content": "import React, { useMemo } from \"react\";\nimport { Filter, X, Calendar } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { CustomMultiSelect, type MultiSelectOption } from \"./CustomMultiSelect\";\nimport type { AppointmentFilterState } from \"./types\";\nimport { APPOINTMENT_STATUSES } from \"./types\";\nimport { Clock, CheckCircle, XCircle } from \"lucide-react\";\nimport type { Staff } from \"../types\";\nimport { useGetList } from \"ra-core\";\nimport { useAppointmentTypes } from \"./useAppointmentTypes\";\n\ntype AppointmentFiltersProps = {\n  filters: AppointmentFilterState;\n  onFiltersChange: (filters: AppointmentFilterState) => void;\n  onApply: () => void;\n};\n\nconst StatusIconMap: Record<string, React.ReactNode> = {\n  scheduled: <Clock className=\"w-3 h-3\" />,\n  completed: <CheckCircle className=\"w-3 h-3\" />,\n  cancelled: <XCircle className=\"w-3 h-3\" />,\n};\n\n// Sidebar filter component - always visible, not collapsible\nexport const AppointmentFiltersSidebar: React.FC<AppointmentFiltersProps> = ({\n  filters,\n  onFiltersChange,\n  onApply,\n}) => {\n  const { data: staffData } = useGetList<Staff>(\"staff\", {\n    pagination: { page: 1, perPage: 1000 },\n  }, {\n    retry: false,\n    enabled: true,\n    onError: (error) => {\n      console.warn(\"Failed to load staff for filters:\", error);\n    },\n  });\n\n  const appointmentTypes = useAppointmentTypes();\n\n  const activeFilterCount = useMemo(() => {\n    let count = 0;\n    if (filters.staffIds.length > 0) count++;\n    if (filters.appointmentTypes.length > 0) count++;\n    if (filters.statuses.length > 0) count++;\n    if (filters.dateFrom || filters.dateTo) count++;\n    return count;\n  }, [filters]);\n\n  const staffOptions: MultiSelectOption[] = useMemo(() => {\n    if (!staffData) return [];\n    return staffData.map((staff) => ({\n      value: staff.id.toString(),\n      label: `${staff.first_name} ${staff.last_name} (${staff.staff_type})`,\n      color: \"#6b7280\",\n    }));\n  }, [staffData]);\n\n  const appointmentTypeOptions: MultiSelectOption[] = useMemo(() => {\n    return appointmentTypes.map((type) => ({\n      value: type.value,\n      label: type.label,\n      color: type.color,\n      serviceId: type.serviceId,\n    }));\n  }, [appointmentTypes]);\n\n  const statusOptions: MultiSelectOption[] = useMemo(() => {\n    return APPOINTMENT_STATUSES.map((status) => ({\n      value: status.value,\n      label: status.label,\n      color: status.color,\n      icon: StatusIconMap[status.value],\n    }));\n  }, []);\n\n  const handleClear = () => {\n    onFiltersChange({\n      staffIds: [],\n      appointmentTypes: [],\n      statuses: [],\n      dateFrom: null,\n      dateTo: null,\n    });\n  };\n\n  return (\n    <Card className=\"bg-white dark:bg-slate-800/50 backdrop-blur-sm rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 h-full flex flex-col\">\n      <CardHeader className=\"px-3 py-3 border-b border-slate-200 dark:border-slate-700 flex-shrink-0\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-1.5\">\n            <Filter className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n            <span className=\"text-sm font-semibold text-slate-900 dark:text-slate-100\">Filters</span>\n            {activeFilterCount > 0 && (\n              <Badge className=\"bg-blue-600 text-white text-xs font-medium px-1.5 py-0.5 rounded-full\">\n                {activeFilterCount}\n              </Badge>\n            )}\n          </div>\n          {activeFilterCount > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={handleClear}\n              className=\"h-6 w-6 p-0 hover:bg-slate-100 dark:hover:bg-slate-700\"\n            >\n              <X className=\"w-3 h-3\" />\n            </Button>\n          )}\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"p-3 flex-1 overflow-y-auto\">\n        <div className=\"space-y-3\">\n          {/* Staff Member Filter */}\n          <div>\n            <label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n              Staff Member\n            </label>\n            <CustomMultiSelect\n              options={staffOptions}\n              selected={filters.staffIds}\n              onChange={(selected) =>\n                onFiltersChange({ ...filters, staffIds: selected })\n              }\n              placeholder=\"Select staff...\"\n            />\n          </div>\n\n          {/* Appointment Type Filter */}\n          <div>\n            <label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n              Appointment Type\n            </label>\n            <CustomMultiSelect\n              options={appointmentTypeOptions}\n              selected={filters.appointmentTypes}\n              onChange={(selected) =>\n                onFiltersChange({ ...filters, appointmentTypes: selected })\n              }\n              placeholder=\"Select type...\"\n            />\n          </div>\n\n          {/* Status Filter */}\n          <div>\n            <label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n              Status\n            </label>\n            <CustomMultiSelect\n              options={statusOptions}\n              selected={filters.statuses}\n              onChange={(selected) =>\n                onFiltersChange({ ...filters, statuses: selected })\n              }\n              placeholder=\"Select status...\"\n            />\n          </div>\n\n          {/* Date Range Filters */}\n          <div>\n            <label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5 block\">\n              Date Range\n            </label>\n            <div className=\"space-y-1.5\">\n              <div className=\"relative\">\n                <Calendar className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none\" />\n                <Input\n                  type=\"date\"\n                  value={filters.dateFrom || \"\"}\n                  onChange={(e) =>\n                    onFiltersChange({ ...filters, dateFrom: e.target.value || null })\n                  }\n                  className=\"w-full pl-8 pr-2 py-1.5 text-xs border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n                  placeholder=\"From date\"\n                />\n              </div>\n              <div className=\"relative\">\n                <Calendar className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none\" />\n                <Input\n                  type=\"date\"\n                  value={filters.dateTo || \"\"}\n                  onChange={(e) =>\n                    onFiltersChange({ ...filters, dateTo: e.target.value || null })\n                  }\n                  className=\"w-full pl-8 pr-2 py-1.5 text-xs border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n                  placeholder=\"To date\"\n                />\n              </div>\n            </div>\n          </div>\n        </div>\n      </CardContent>\n\n      {/* Apply Button - Fixed at bottom */}\n      <div className=\"px-3 py-3 border-t border-slate-200 dark:border-slate-700 flex-shrink-0\">\n        <Button\n          onClick={onApply}\n          className=\"w-full px-3 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-medium\"\n        >\n          Apply Filters\n        </Button>\n      </div>\n    </Card>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentEditDialog.tsx",
      "content": "import React, { useState } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport type { Appointment } from \"../types\";\n\ntype AppointmentEditDialogProps = {\n  open: boolean;\n  onClose: () => void;\n  appointment: Appointment | null;\n  onConfirm: (updateFutureOnly: boolean) => void;\n  isSubmitting?: boolean;\n};\n\nexport const AppointmentEditDialog: React.FC<AppointmentEditDialogProps> = ({\n  open,\n  onClose,\n  appointment,\n  onConfirm,\n  isSubmitting = false,\n}) => {\n  const [editOption, setEditOption] = useState<\"this\" | \"future\">(\"this\");\n\n  if (!appointment) {\n    return null;\n  }\n\n  const isRecurring = appointment.is_recurring || !!appointment.recurrence_id;\n\n  const handleConfirm = () => {\n    // editOption \"this\" means edit only this appointment (updateFutureOnly = false)\n    // editOption \"future\" means edit this and all future (updateFutureOnly = true)\n    onConfirm(editOption === \"future\");\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle>Edit Recurring Appointment</DialogTitle>\n          <DialogDescription>\n            This appointment is part of a recurring series. What would you like to edit?\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"py-4\">\n          {isRecurring ? (\n            <div className=\"space-y-4\">\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                Changes will be applied to the selected appointments. The date will remain unchanged - only time, type, staff, and other details will be updated.\n              </p>\n              <RadioGroup value={editOption} onValueChange={(value) => setEditOption(value as \"this\" | \"future\")}>\n                <div className=\"flex items-center space-x-2\">\n                  <RadioGroupItem value=\"this\" id=\"edit-this\" />\n                  <Label htmlFor=\"edit-this\" className=\"cursor-pointer\">\n                    Edit this appointment only\n                  </Label>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <RadioGroupItem value=\"future\" id=\"edit-future\" />\n                  <Label htmlFor=\"edit-future\" className=\"cursor-pointer\">\n                    Edit this appointment and all future appointments in this series\n                  </Label>\n                </div>\n              </RadioGroup>\n            </div>\n          ) : (\n            <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n              This appointment will be updated with your changes.\n            </p>\n          )}\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose} disabled={isSubmitting}>\n            Cancel\n          </Button>\n          <Button\n            onClick={handleConfirm}\n            disabled={isSubmitting}\n          >\n            {isSubmitting ? \"Saving...\" : \"Continue\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentDetailsDrawer.tsx",
      "content": "import React, { useState } from \"react\";\nimport { X, User, Calendar, Clock, Stethoscope, Car, FileText, MapPin, Phone, ExternalLink, Printer, Copy, Edit, Trash2, CreditCard, DollarSign } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport type { Appointment, PaymentPackage, Service, PaymentTransaction } from \"../types\";\nimport { APPOINTMENT_STATUSES } from \"./types\";\nimport { useAppointmentTypes } from \"./useAppointmentTypes\";\nimport { useGetList, useRefresh } from \"ra-core\";\nimport type { Contact, Staff } from \"../types\";\nimport { formatCrmDate, formatCrmTime } from \"../misc/timezone\";\nimport { Link } from \"react-router\";\nimport { usePackageUsage } from \"@/hooks/usePackageUsage\";\nimport { PaymentCreateDialog } from \"../payments/PaymentCreateDialog\";\n\ntype AppointmentDetailsDrawerProps = {\n  open: boolean;\n  onClose: () => void;\n  appointment: Appointment | null;\n  onEdit: (appointment: Appointment) => void;\n  onDelete: (appointment: Appointment) => void;\n};\n\nexport const AppointmentDetailsDrawer: React.FC<AppointmentDetailsDrawerProps> = ({\n  open,\n  onClose,\n  appointment,\n  onEdit,\n  onDelete,\n}) => {\n  // All hooks must be called before any early returns\n  const { data: patients } = useGetList<Contact>(\"clients\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n  const { data: staff } = useGetList<Staff>(\"staff\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n  const appointmentTypes = useAppointmentTypes();\n  \n  const refresh = useRefresh();\n  \n  // Fetch payment package if linked\n  const { data: paymentPackages } = useGetList<PaymentPackage>(\"payment_packages\", {\n    pagination: { page: 1, perPage: 1 },\n    filter: appointment?.payment_package_id ? { id: appointment.payment_package_id } : {},\n  }, { enabled: !!appointment?.payment_package_id });\n  \n  const paymentPackage = paymentPackages?.[0];\n  \n  // Fetch standalone payments linked to this appointment\n  const { data: standalonePayments } = useGetList<PaymentTransaction>(\"payment_transactions\", {\n    pagination: { page: 1, perPage: 100 },\n    sort: { field: \"date_paid\", order: \"DESC\" },\n    filter: appointment?.id ? { appointment_id: appointment.id, \"payment_package_id@is\": null } : { id: -1 }, // Only standalone payments\n  }, { enabled: !!appointment?.id });\n  \n  // Fetch service for payment package\n  const { data: services } = useGetList<Service>(\"services\", {\n    pagination: { page: 1, perPage: 1000 },\n  });\n  \n  // Get package usage if package exists\n  const { sessionsUsed, hoursUsed } = usePackageUsage(paymentPackage?.id);\n  \n  // State for payment creation dialog\n  const [isPaymentDialogOpen, setIsPaymentDialogOpen] = useState(false);\n  \n  // Calculate total standalone payments\n  const totalStandaloneAmount = standalonePayments?.reduce((sum, payment) => sum + (payment.amount_received || 0), 0) || 0;\n\n  // Get all assigned staff from staff_ids array\n  const assignedStaff = React.useMemo(() => {\n    if (!staff || !appointment?.staff_ids || appointment.staff_ids.length === 0) return [];\n    return appointment.staff_ids\n      .map((staffId) => staff.find((s) => s.id === staffId))\n      .filter((s): s is Staff => s !== undefined);\n  }, [staff, appointment?.staff_ids]);\n  \n  // Find selected appointment types - use selected_service_ids from custom_fields if available\n  // Otherwise fall back to showing the first service that matches the appointment_type\n  const appointmentTypesList = React.useMemo(() => {\n    if (!appointment?.appointment_type) return [];\n    \n    // First, check if we have selected service IDs stored in custom_fields\n    const selectedServiceIds = appointment?.custom_fields?.selected_service_ids;\n    if (Array.isArray(selectedServiceIds) && selectedServiceIds.length > 0) {\n      // Show only the selected services\n      return appointmentTypes.filter((t) => {\n        const serviceType = t as any;\n        return selectedServiceIds.includes(serviceType.serviceId);\n      });\n    }\n    \n    // Fallback: The database stores the mapped appointment_type (e.g., \"doctor_on_call\")\n    // Find the first service that maps to this appointment_type (for backward compatibility)\n    // Only show one service to avoid showing multiple services that map to the same appointment_type\n    const matchingType = appointmentTypes.find((t) => t.appointmentType === appointment.appointment_type);\n    return matchingType ? [matchingType] : [];\n  }, [appointmentTypes, appointment?.appointment_type, appointment?.custom_fields]);\n  \n  // For backward compatibility, also try to find by direct value match\n  const appointmentType = React.useMemo(() => {\n    if (!appointment?.appointment_type) return undefined;\n    // First try to find by appointment_type directly (for old data)\n    let found = appointmentTypes.find((t) => t.appointmentType === appointment.appointment_type);\n    if (!found) {\n      // Try to find by value (for new service ID format)\n      found = appointmentTypes.find((t) => t.value === appointment.appointment_type);\n    }\n    // If still not found and appointment_type looks like a service ID, try to match\n    if (!found && typeof appointment.appointment_type === \"string\" && appointment.appointment_type.startsWith(\"service_\")) {\n      const serviceId = appointment.appointment_type.replace(\"service_\", \"\");\n      found = appointmentTypes.find((t) => t.serviceId?.toString() === serviceId);\n    }\n    return found || appointmentTypesList[0]; // Fallback to first matching type\n  }, [appointmentTypes, appointment?.appointment_type, appointmentTypesList]);\n\n  // Early return after all hooks\n  if (!appointment) return null;\n\n  const patient = patients?.find((p) => p.id === appointment.patient_id);\n  const primaryStaff = staff?.find((s) => s.id === appointment.primary_staff_id);\n  const driver = staff?.find((s) => s.id === appointment.driver_id);\n  const status = APPOINTMENT_STATUSES.find((s) => s.value === appointment.status);\n\n  // Parse times using the timezone utility to ensure correct Dubai timezone display\n  const startTimeDate = appointment.start_time ? new Date(appointment.start_time) : null;\n  const endTimeDate = appointment.end_time ? new Date(appointment.end_time) : null;\n  const startTimeStr = startTimeDate ? formatCrmTime(startTimeDate) : \"\";\n  const endTimeStr = endTimeDate ? formatCrmTime(endTimeDate) : \"\";\n\n  const handlePrint = () => {\n    window.open(`/print/appointment/${appointment.id}`, \"_blank\");\n  };\n\n  const handleCopy = () => {\n    // TODO: Implement copy functionality\n    console.log(\"Copy appointment:\", appointment.id);\n  };\n\n  return (\n    <>\n      {/* Backdrop */}\n      {open && (\n        <div\n          className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-40 transition-opacity\"\n          onClick={onClose}\n        />\n      )}\n\n      {/* Drawer */}\n      <div\n        className={`fixed right-0 top-0 h-full w-full max-w-2xl bg-white dark:bg-slate-900 shadow-2xl z-50 transition-transform duration-200 ease-in-out ${\n          open ? \"translate-x-0\" : \"translate-x-full\"\n        }`}\n      >\n        {/* Header */}\n        <div className=\"bg-gray-50 dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h2 className=\"text-2xl font-bold text-gray-900 dark:text-slate-100\">Appointment Details</h2>\n              {appointmentTypesList.length > 0 ? (\n                <div className=\"flex flex-wrap gap-2 mt-1\">\n                  {appointmentTypesList.map((type) => (\n                    <Badge\n                      key={type.value}\n                      style={{\n                        backgroundColor: type.color + \"20\",\n                        color: type.color,\n                      }}\n                      className=\"text-xs dark:opacity-90\"\n                    >\n                      {type.label}\n                    </Badge>\n                  ))}\n                </div>\n              ) : appointmentType ? (\n                <p className=\"text-gray-600 dark:text-slate-400 mt-1\">{appointmentType.label}</p>\n              ) : null}\n            </div>\n            <Button variant=\"ghost\" size=\"sm\" onClick={onClose}>\n              <X className=\"w-5 h-5\" />\n            </Button>\n          </div>\n        </div>\n\n        {/* Content */}\n        <div className=\"overflow-y-auto h-[calc(100%-200px)] p-6 space-y-6\">\n          {/* Patient Information */}\n          <div className=\"bg-gray-50 dark:bg-slate-800 rounded-lg p-4\">\n            <div className=\"flex items-center gap-2 mb-3\">\n              <User className=\"w-5 h-5 text-gray-600 dark:text-slate-400\" />\n              <h3 className=\"text-lg font-semibold text-gray-900 dark:text-slate-100\">Patient Information</h3>\n            </div>\n            {patient && (\n              <div className=\"space-y-2\">\n                <p className=\"font-medium text-gray-900 dark:text-slate-100\">{patient.first_name} {patient.last_name}</p>\n                {patient.phone_jsonb && patient.phone_jsonb.length > 0 && (\n                  <div className=\"flex items-center gap-2 text-sm text-gray-600 dark:text-slate-400\">\n                    <Phone className=\"w-4 h-4\" />\n                    <span>{patient.phone_jsonb[0].number}</span>\n                  </div>\n                )}\n                {(patient.building_street || patient.area) && (\n                  <div className=\"flex items-center gap-2 text-sm text-gray-600 dark:text-slate-400\">\n                    <MapPin className=\"w-4 h-4\" />\n                    <span>\n                      {[patient.building_street, patient.area, patient.city]\n                        .filter(Boolean)\n                        .join(\", \")}\n                    </span>\n                  </div>\n                )}\n                {patient.google_maps_link && (\n                  <a\n                    href={patient.google_maps_link}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"flex items-center gap-2 text-sm text-blue-600 dark:text-blue-400 hover:underline\"\n                  >\n                    <ExternalLink className=\"w-4 h-4\" />\n                    Open in Google Maps\n                  </a>\n                )}\n              </div>\n            )}\n          </div>\n\n          {/* Appointment Details */}\n          <div className=\"bg-gray-50 dark:bg-slate-800 rounded-lg p-4\">\n            <div className=\"flex items-center gap-2 mb-3\">\n              <Calendar className=\"w-5 h-5 text-gray-600 dark:text-slate-400\" />\n              <h3 className=\"text-lg font-semibold text-gray-900 dark:text-slate-100\">Appointment Details</h3>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <p className=\"text-sm text-gray-600 dark:text-slate-400\">Date</p>\n                <p className=\"font-medium text-gray-900 dark:text-slate-100\">{formatCrmDate(appointment.appointment_date)}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-gray-600 dark:text-slate-400\">Time</p>\n                <div className=\"flex items-center gap-2\">\n                  <Clock className=\"w-4 h-4 text-gray-600 dark:text-slate-400\" />\n                  <p className=\"font-medium text-gray-900 dark:text-slate-100\">\n                    {startTimeStr && endTimeStr ? `${startTimeStr} - ${endTimeStr}` : \"N/A\"}\n                  </p>\n                </div>\n              </div>\n              <div>\n                <p className=\"text-sm text-gray-600 dark:text-slate-400\">Duration</p>\n                <p className=\"font-medium text-gray-900 dark:text-slate-100\">{appointment.duration_minutes} minutes</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-gray-600 dark:text-slate-400\">Status</p>\n                {status && (\n                  <Badge\n                    className={`${\n                      status.value === \"scheduled\"\n                        ? \"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300\"\n                        : status.value === \"cancelled\"\n                        ? \"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300\"\n                        : status.value === \"completed\"\n                        ? \"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300\"\n                        : \"\"\n                    }`}\n                  >\n                    {status.label}\n                  </Badge>\n                )}\n              </div>\n              <div>\n                <p className=\"text-sm text-gray-600 dark:text-slate-400\">Type</p>\n                {appointmentTypesList.length > 0 ? (\n                  <div className=\"flex flex-wrap gap-2 mt-1\">\n                    {appointmentTypesList.map((type) => (\n                      <Badge\n                        key={type.value}\n                        style={{\n                          backgroundColor: type.color + \"20\",\n                          color: type.color,\n                        }}\n                        className=\"dark:opacity-90\"\n                      >\n                        {type.label}\n                      </Badge>\n                    ))}\n                  </div>\n                ) : appointmentType ? (\n                  <Badge\n                    style={{\n                      backgroundColor: appointmentType.color + \"20\",\n                      color: appointmentType.color,\n                    }}\n                    className=\"dark:opacity-90\"\n                  >\n                    {appointmentType.label}\n                  </Badge>\n                ) : (\n                  <span className=\"text-sm text-gray-500 dark:text-slate-500\">N/A</span>\n                )}\n              </div>\n            </div>\n          </div>\n\n          {/* Staff Details */}\n          <div className=\"bg-gray-50 dark:bg-slate-800 rounded-lg p-4\">\n            <div className=\"flex items-center gap-2 mb-3\">\n              <Stethoscope className=\"w-5 h-5 text-gray-600 dark:text-slate-400\" />\n              <h3 className=\"text-lg font-semibold text-gray-900 dark:text-slate-100\">Staff Details</h3>\n            </div>\n            <div className=\"space-y-2\">\n              {primaryStaff && (\n                <div className=\"p-3 bg-white dark:bg-slate-700 rounded-lg border border-gray-200 dark:border-slate-600\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <p className=\"font-medium text-gray-900 dark:text-slate-100\">{primaryStaff.first_name} {primaryStaff.last_name}</p>\n                    <Badge className=\"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300\">Primary</Badge>\n                  </div>\n                  <p className=\"text-sm text-gray-600 dark:text-slate-400\">{primaryStaff.staff_type} {primaryStaff.specialization && `- ${primaryStaff.specialization}`}</p>\n                  <div className=\"flex items-center gap-2 mt-2 text-sm text-gray-600 dark:text-slate-400\">\n                    <Phone className=\"w-4 h-4\" />\n                    <span>{primaryStaff.phone}</span>\n                  </div>\n                </div>\n              )}\n              {assignedStaff.length > 0 && (\n                <>\n                  {assignedStaff.map((assignedStaffMember) => {\n                    // Skip if this staff member is already shown as primary or driver\n                    if (assignedStaffMember.id === appointment.primary_staff_id || assignedStaffMember.id === appointment.driver_id) {\n                      return null;\n                    }\n                    return (\n                      <div key={assignedStaffMember.id} className=\"p-3 bg-white dark:bg-slate-700 rounded-lg border border-gray-200 dark:border-slate-600\">\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <p className=\"font-medium text-gray-900 dark:text-slate-100\">{assignedStaffMember.first_name} {assignedStaffMember.last_name}</p>\n                          <Badge className=\"bg-gray-100 dark:bg-slate-600 text-gray-700 dark:text-slate-300\">Staff</Badge>\n                        </div>\n                        <p className=\"text-sm text-gray-600 dark:text-slate-400\">{assignedStaffMember.staff_type} {assignedStaffMember.specialization && `- ${assignedStaffMember.specialization}`}</p>\n                        <div className=\"flex items-center gap-2 mt-2 text-sm text-gray-600 dark:text-slate-400\">\n                          <Phone className=\"w-4 h-4\" />\n                          <span>{assignedStaffMember.phone}</span>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </>\n              )}\n              {driver && (\n                <div className=\"p-3 bg-white dark:bg-slate-700 rounded-lg border border-gray-200 dark:border-slate-600\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <p className=\"font-medium text-gray-900 dark:text-slate-100\">{driver.first_name} {driver.last_name}</p>\n                    <Badge className=\"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 flex items-center gap-1\">\n                      <Car className=\"w-3 h-3\" />\n                      Driver\n                    </Badge>\n                  </div>\n                  <p className=\"text-sm text-gray-600 dark:text-slate-400\">{driver.staff_type}</p>\n                  <div className=\"flex items-center gap-2 mt-2 text-sm text-gray-600 dark:text-slate-400\">\n                    <Phone className=\"w-4 h-4\" />\n                    <span>{driver.phone}</span>\n                  </div>\n                </div>\n              )}\n              {!primaryStaff && assignedStaff.length === 0 && !driver && (\n                <p className=\"text-sm text-gray-500 dark:text-slate-500 italic\">No staff assigned</p>\n              )}\n            </div>\n          </div>\n\n          {/* Transportation */}\n          <div className=\"bg-gray-50 dark:bg-slate-800 rounded-lg p-4\">\n            <div className=\"flex items-center gap-2 mb-3\">\n              <Car className=\"w-5 h-5 text-gray-600 dark:text-slate-400\" />\n              <h3 className=\"text-lg font-semibold text-gray-900 dark:text-slate-100\">Transportation</h3>\n            </div>\n            {driver ? (\n              <p className=\"text-sm text-gray-900 dark:text-slate-100\">{driver.first_name} {driver.last_name} - {driver.phone}</p>\n            ) : (\n              <p className=\"text-sm text-gray-600 dark:text-slate-400\">Self Transport</p>\n            )}\n          </div>\n\n          {/* Payment Package */}\n          {paymentPackage && (\n            <div className=\"bg-gray-50 dark:bg-slate-800 rounded-lg p-4\">\n              <div className=\"flex items-center gap-2 mb-3\">\n                <CreditCard className=\"w-5 h-5 text-gray-600 dark:text-slate-400\" />\n                <h3 className=\"text-lg font-semibold text-gray-900 dark:text-slate-100\">Payment Package</h3>\n              </div>\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    {services && paymentPackage.service_id && (\n                      <p className=\"font-medium text-gray-900 dark:text-slate-100\">\n                        {services.find((s) => s.id === paymentPackage.service_id)?.name || \"Service\"} Package #{paymentPackage.id}\n                      </p>\n                    )}\n                    {!paymentPackage.service_id && (\n                      <p className=\"font-medium text-gray-900 dark:text-slate-100\">Package #{paymentPackage.id}</p>\n                    )}\n                  </div>\n                  <Badge\n                    className={\n                      paymentPackage.status === \"active\"\n                        ? \"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300\"\n                        : paymentPackage.status === \"completed\"\n                        ? \"bg-gray-100 dark:bg-slate-600 text-gray-700 dark:text-slate-300\"\n                        : \"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300\"\n                    }\n                  >\n                    {paymentPackage.status}\n                  </Badge>\n                </div>\n                <div className=\"text-sm text-gray-600 dark:text-slate-400 space-y-1\">\n                  {paymentPackage.package_type === \"session-based\" && paymentPackage.total_sessions && (\n                    <p>\n                      Usage: {sessionsUsed || 0} / {paymentPackage.total_sessions} sessions\n                      {paymentPackage.total_sessions > 0 && (\n                        <span className=\"ml-2\">\n                          ({Math.round(((sessionsUsed || 0) / paymentPackage.total_sessions) * 100)}% used)\n                        </span>\n                      )}\n                    </p>\n                  )}\n                  {paymentPackage.package_type === \"time-based\" && paymentPackage.total_hours && (\n                    <p>\n                      Usage: {hoursUsed || 0} / {paymentPackage.total_hours} hours\n                      {paymentPackage.total_hours > 0 && (\n                        <span className=\"ml-2\">\n                          ({Math.round(((hoursUsed || 0) / paymentPackage.total_hours) * 100)}% used)\n                        </span>\n                      )}\n                    </p>\n                  )}\n                  {paymentPackage.renewal_date && (\n                    <p>Renewal Date: {formatCrmDate(paymentPackage.renewal_date)}</p>\n                  )}\n                </div>\n                <div className=\"flex items-center gap-3 mt-3\">\n                  <Button\n                    onClick={() => setIsPaymentDialogOpen(true)}\n                    className=\"bg-green-600 text-white hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-600\"\n                    size=\"sm\"\n                  >\n                    <DollarSign className=\"w-4 h-4 mr-2\" />\n                    Create Payment\n                  </Button>\n                  <Link\n                    to={`/payment_packages/${paymentPackage.id}/show`}\n                    className=\"inline-flex items-center gap-2 text-sm text-blue-600 dark:text-blue-400 hover:underline\"\n                  >\n                    <ExternalLink className=\"w-4 h-4\" />\n                    View Package Details\n                  </Link>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Payment Section (when no package linked or showing standalone payments) */}\n          {!paymentPackage && (\n            <div className=\"bg-gray-50 dark:bg-slate-800 rounded-lg p-4 border-2 border-dashed border-gray-300 dark:border-slate-600\">\n              <div className=\"flex items-center gap-2 mb-3\">\n                <CreditCard className=\"w-5 h-5 text-gray-600 dark:text-slate-400\" />\n                <h3 className=\"text-lg font-semibold text-gray-900 dark:text-slate-100\">Payment</h3>\n              </div>\n              \n              {/* Show standalone payments if any exist */}\n              {standalonePayments && standalonePayments.length > 0 ? (\n                <div className=\"space-y-3 mb-3\">\n                  <div className=\"bg-white dark:bg-slate-700 rounded-lg p-3 border border-gray-200 dark:border-slate-600\">\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <p className=\"font-medium text-gray-900 dark:text-slate-100\">Standalone Payments</p>\n                      <Badge className=\"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300\">\n                        {standalonePayments.length} payment{standalonePayments.length !== 1 ? 's' : ''}\n                      </Badge>\n                    </div>\n                    <div className=\"space-y-2\">\n                      {standalonePayments.map((payment) => (\n                        <div key={payment.id} className=\"flex items-center justify-between text-sm\">\n                          <div>\n                            <p className=\"text-gray-900 dark:text-slate-100\">\n                              {formatCrmDate(payment.date_paid)} - {payment.payment_method}\n                            </p>\n                            {payment.invoice_number && (\n                              <p className=\"text-xs text-gray-500 dark:text-slate-400\">\n                                Invoice: {payment.invoice_number}\n                              </p>\n                            )}\n                          </div>\n                          <p className=\"font-medium text-gray-900 dark:text-slate-100\">\n                            AED {payment.amount_received.toLocaleString()}\n                          </p>\n                        </div>\n                      ))}\n                      <div className=\"pt-2 border-t border-gray-200 dark:border-slate-600\">\n                        <div className=\"flex items-center justify-between\">\n                          <p className=\"font-semibold text-gray-900 dark:text-slate-100\">Total Paid</p>\n                          <p className=\"font-semibold text-gray-900 dark:text-slate-100\">\n                            AED {totalStandaloneAmount.toLocaleString()}\n                          </p>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              ) : (\n                <p className=\"text-sm text-gray-600 dark:text-slate-400 mb-3\">\n                  No payment package linked to this appointment. Create a payment by selecting a package or leave it empty for a standalone payment.\n                </p>\n              )}\n              \n              <Button\n                onClick={() => {\n                  setIsPaymentDialogOpen(true);\n                }}\n                variant=\"outline\"\n                size=\"sm\"\n              >\n                <DollarSign className=\"w-4 h-4 mr-2\" />\n                Create Payment\n              </Button>\n            </div>\n          )}\n\n          {/* Notes and Instructions */}\n          <div className=\"bg-gray-50 dark:bg-slate-800 rounded-lg p-4\">\n            <div className=\"flex items-center gap-2 mb-3\">\n              <FileText className=\"w-5 h-5 text-gray-600 dark:text-slate-400\" />\n              <h3 className=\"text-lg font-semibold text-gray-900 dark:text-slate-100\">Notes and Instructions</h3>\n            </div>\n            <div className=\"space-y-3\">\n              {appointment.mini_notes && (\n                <div>\n                  <p className=\"text-sm font-medium text-gray-700 dark:text-slate-300 mb-1\">Brief Notes</p>\n                  <p className=\"text-sm text-gray-600 dark:text-slate-400\">{appointment.mini_notes}</p>\n                </div>\n              )}\n              {appointment.full_notes && (\n                <div>\n                  <p className=\"text-sm font-medium text-gray-700 dark:text-slate-300 mb-1\">Detailed Notes</p>\n                  <p className=\"text-sm text-gray-600 dark:text-slate-400\">{appointment.full_notes}</p>\n                </div>\n              )}\n              {appointment.pickup_instructions && (\n                <div className=\"border border-orange-200 dark:border-orange-800 rounded-lg p-3 bg-orange-50 dark:bg-orange-900/20\">\n                  <p className=\"text-sm font-medium text-orange-700 dark:text-orange-300 mb-1\">Pickup Instructions</p>\n                  <p className=\"text-sm text-orange-700 dark:text-orange-300\">{appointment.pickup_instructions}</p>\n                </div>\n              )}\n              {appointment.notes && (\n                <div>\n                  <p className=\"text-sm font-medium text-gray-700 dark:text-slate-300 mb-1\">General Notes</p>\n                  <p className=\"text-sm text-gray-600 dark:text-slate-400\">{appointment.notes}</p>\n                </div>\n              )}\n            </div>\n          </div>\n\n        </div>\n\n        {/* Footer */}\n        <div className=\"bg-gray-50 dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 p-6\">\n          <div className=\"flex items-center justify-end gap-3\">\n            <Button variant=\"outline\" onClick={handlePrint}>\n              <Printer className=\"w-4 h-4 mr-2\" />\n              Print\n            </Button>\n            <Button variant=\"outline\" onClick={handleCopy}>\n              <Copy className=\"w-4 h-4 mr-2\" />\n              Copy\n            </Button>\n            <Button\n              onClick={() => onEdit(appointment)}\n              className=\"bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600\"\n            >\n              <Edit className=\"w-4 h-4 mr-2\" />\n              Edit\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => onDelete(appointment)}\n            >\n              <Trash2 className=\"w-4 h-4 mr-2\" />\n              Delete\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Payment Creation Dialog */}\n      <PaymentCreateDialog\n        open={isPaymentDialogOpen}\n        onOpenChange={(open) => {\n          setIsPaymentDialogOpen(open);\n          if (!open) {\n            // Refresh data when dialog closes (payment might have been created)\n            refresh();\n          }\n        }}\n        defaultPackageId={appointment.payment_package_id}\n        defaultAppointmentId={appointment.id}\n      />\n    </>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentDeleteDialog.tsx",
      "content": "import React, { useState } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport type { Appointment } from \"../types\";\n\ntype AppointmentDeleteDialogProps = {\n  open: boolean;\n  onClose: () => void;\n  appointment: Appointment | null;\n  onConfirm: (deleteFutureOnly: boolean) => void;\n  isDeleting?: boolean;\n};\n\nexport const AppointmentDeleteDialog: React.FC<AppointmentDeleteDialogProps> = ({\n  open,\n  onClose,\n  appointment,\n  onConfirm,\n  isDeleting = false,\n}) => {\n  const [deleteOption, setDeleteOption] = useState<\"this\" | \"future\">(\"this\");\n\n  if (!appointment) {\n    return null;\n  }\n\n  const isRecurring = appointment.is_recurring || !!appointment.recurrence_id;\n  const isParent = appointment.recurrence_sequence === 0;\n  const isChild = appointment.recurrence_sequence !== undefined && appointment.recurrence_sequence > 0;\n\n  const handleConfirm = () => {\n    // deleteOption \"this\" means delete only this appointment (deleteFutureOnly = false)\n    // deleteOption \"future\" means delete this and all future (deleteFutureOnly = true)\n    onConfirm(deleteOption === \"future\");\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle>Delete Appointment</DialogTitle>\n          <DialogDescription>\n            Are you sure you want to delete this appointment?\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"py-4\">\n          {isRecurring ? (\n            <div className=\"space-y-4\">\n              <p className=\"text-sm text-gray-600\">\n                This appointment is part of a recurring series. What would you like to delete?\n              </p>\n              <RadioGroup value={deleteOption} onValueChange={(value) => setDeleteOption(value as \"this\" | \"future\")}>\n                <div className=\"flex items-center space-x-2\">\n                  <RadioGroupItem value=\"this\" id=\"delete-this\" />\n                  <Label htmlFor=\"delete-this\" className=\"cursor-pointer\">\n                    Delete this appointment only\n                  </Label>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <RadioGroupItem value=\"future\" id=\"delete-future\" />\n                  <Label htmlFor=\"delete-future\" className=\"cursor-pointer\">\n                    Delete this appointment and all future appointments in this series\n                  </Label>\n                </div>\n              </RadioGroup>\n            </div>\n          ) : (\n            <p className=\"text-sm text-gray-600\">\n              This will permanently delete the appointment. This action cannot be undone.\n            </p>\n          )}\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose} disabled={isDeleting}>\n            Cancel\n          </Button>\n          <Button\n            variant=\"destructive\"\n            onClick={handleConfirm}\n            disabled={isDeleting}\n          >\n            {isDeleting ? \"Deleting...\" : \"Delete\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentContextMenu.tsx",
      "content": "import React, { useEffect, useRef } from \"react\";\nimport { X, Edit, Printer, Copy, Trash2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { format, parseISO } from \"date-fns\";\nimport type { Appointment } from \"../types\";\nimport { APPOINTMENT_STATUSES } from \"./types\";\nimport { useAppointmentTypes } from \"./useAppointmentTypes\";\nimport { formatCrmDate } from \"../misc/timezone\";\n\ntype AppointmentContextMenuProps = {\n  appointment: Appointment;\n  x: number;\n  y: number;\n  onClose: () => void;\n  onEdit: (appointment: Appointment) => void;\n  onDelete: (appointment: Appointment) => void;\n};\n\nexport const AppointmentContextMenu: React.FC<AppointmentContextMenuProps> = ({\n  appointment,\n  x,\n  y,\n  onClose,\n  onEdit,\n  onDelete,\n}) => {\n  const menuRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\n        onClose();\n      }\n    };\n\n    const handleEscape = (event: KeyboardEvent) => {\n      if (event.key === \"Escape\") {\n        onClose();\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    document.addEventListener(\"keydown\", handleEscape);\n\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n      document.removeEventListener(\"keydown\", handleEscape);\n    };\n  }, [onClose]);\n\n  // Adjust position if menu would go off-screen\n  const [adjustedX, adjustedY] = React.useMemo(() => {\n    if (!menuRef.current) return [x, y];\n    const rect = menuRef.current.getBoundingClientRect();\n    const windowWidth = window.innerWidth;\n    const windowHeight = window.innerHeight;\n\n    let newX = x;\n    let newY = y;\n\n    if (x + rect.width > windowWidth) {\n      newX = windowWidth - rect.width - 10;\n    }\n    if (y + rect.height > windowHeight) {\n      newY = windowHeight - rect.height - 10;\n    }\n\n    return [newX, newY];\n  }, [x, y]);\n\n  const appointmentTypes = useAppointmentTypes();\n  const appointmentType = appointmentTypes.find((t) => t.value === appointment.appointment_type);\n  const status = APPOINTMENT_STATUSES.find((s) => s.value === appointment.status);\n\n  const startTime = parseISO(appointment.appointment_date + \"T\" + appointment.start_time.split(\"T\")[1]);\n\n  const handlePrint = () => {\n    window.open(`/print/appointment/${appointment.id}`, \"_blank\");\n    onClose();\n  };\n\n  const handleCopy = () => {\n    // TODO: Implement copy functionality\n    console.log(\"Copy appointment:\", appointment.id);\n    onClose();\n  };\n\n  return (\n    <div\n      ref={menuRef}\n      className=\"fixed z-50 bg-[--card] border border-[--border] rounded-lg shadow-lg py-2 min-w-[200px]\"\n      style={{\n        left: `${adjustedX}px`,\n        top: `${adjustedY}px`,\n      }}\n    >\n      {/* Header */}\n      <div className=\"px-3 py-2 border-b border-[--border] mb-2 relative\">\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"absolute top-1 right-1 h-6 w-6 p-0\"\n          onClick={onClose}\n        >\n          <X className=\"w-3 h-3\" />\n        </Button>\n        <div>\n          <p className=\"text-sm font-medium\">{appointmentType?.label || \"Appointment\"}</p>\n          <p className=\"text-xs text-[--muted-foreground]\">\n            {formatCrmDate(appointment.appointment_date)} at{\" \"}\n            {format(startTime, \"HH:mm\")}\n          </p>\n          {status && (\n            <p\n              className=\"text-xs mt-1\"\n              style={{ color: status.color }}\n            >\n              {status.label}\n            </p>\n          )}\n        </div>\n      </div>\n\n      {/* Actions */}\n      <div className=\"py-1\">\n        <button\n          type=\"button\"\n          className=\"w-full flex items-center px-3 py-2 text-sm hover:bg-[--accent] text-left\"\n          onClick={() => {\n            onEdit(appointment);\n            onClose();\n          }}\n        >\n          <Edit className=\"w-4 h-4 mr-2\" />\n          Edit Appointment\n        </button>\n        <button\n          type=\"button\"\n          className=\"w-full flex items-center px-3 py-2 text-sm hover:bg-[--accent] text-left\"\n          onClick={handlePrint}\n        >\n          <Printer className=\"w-4 h-4 mr-2\" />\n          Print Appointment\n        </button>\n        <button\n          type=\"button\"\n          className=\"w-full flex items-center px-3 py-2 text-sm hover:bg-[--accent] text-left\"\n          onClick={handleCopy}\n        >\n          <Copy className=\"w-4 h-4 mr-2\" />\n          Copy Appointment\n        </button>\n        {appointment.status !== \"cancelled\" && (\n          <button\n            type=\"button\"\n            className=\"w-full flex items-center px-3 py-2 text-sm hover:bg-[--accent] text-left\"\n            onClick={() => {\n              // TODO: Implement cancel functionality\n              onClose();\n            }}\n          >\n            <X className=\"w-4 h-4 mr-2\" />\n            Cancel Appointment\n          </button>\n        )}\n        <button\n          type=\"button\"\n          className=\"w-full flex items-center px-3 py-2 text-sm hover:bg-red-50 text-red-600 text-left\"\n          onClick={() => {\n            onDelete(appointment);\n            onClose();\n          }}\n        >\n          <Trash2 className=\"w-4 h-4 mr-2\" />\n          Delete Appointment\n        </button>\n      </div>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentCluster.tsx",
      "content": "// Placeholder for cluster component\n// For full clustering implementation, consider using:\n// - react-leaflet-cluster or\n// - supercluster with custom marker grouping\n// This is a placeholder that can be enhanced later\n\nimport React from \"react\";\n\nexport const AppointmentCluster: React.FC = () => {\n  // Clustering will be implemented in a future update\n  // For now, individual markers are displayed\n  return null;\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/appointments/AppointmentCalendar.tsx",
      "content": "import React, { useRef, useMemo, useCallback } from \"react\";\nimport FullCalendar from \"@fullcalendar/react\";\nimport dayGridPlugin from \"@fullcalendar/daygrid\";\nimport timeGridPlugin from \"@fullcalendar/timegrid\";\nimport interactionPlugin from \"@fullcalendar/interaction\";\nimport listPlugin from \"@fullcalendar/list\";\nimport type { EventInput, DateSelectArg, EventClickArg, EventDropArg, EventResizeArg } from \"@fullcalendar/core\";\n// Note: FullCalendar CSS should be imported in your main CSS file or via a CDN\n// For FullCalendar v6+: import \"@fullcalendar/core/vdom.css\" and plugin CSS files\n// For FullCalendar v5: import \"@fullcalendar/core/main.css\" and plugin CSS files\nimport { Button } from \"@/components/ui/button\";\nimport { format, startOfToday, parseISO } from \"date-fns\";\nimport type { Appointment } from \"../types\";\nimport { useAppointmentTypes } from \"./useAppointmentTypes\";\nimport { getCrmTimeZone, getCrmTimeZoneOffsetMinutes, formatCrmDateShort, formatCrmTime, crmDateTimeStringToDate, crmDateTimeStringToISO, crmToday } from \"../misc/timezone\";\n\n// Helper function to convert FullCalendar date to CRM timezone-aware date\n// When FullCalendar has timeZone set to the configured CRM timezone, it displays times in that timezone.\n// The Date objects returned from selection represent the selected time in UTC.\n// We need to interpret the UTC time components as if they represent the time in the CRM timezone,\n// then create a Date object that actually represents that time in the CRM timezone.\n/**\n * Converts a FullCalendar Date to a Date representing the selected time in CRM timezone.\n * \n * CRITICAL TIMEZONE CONVERSION FLOW:\n * 1. FullCalendar with timeZone set returns Date objects where UTC components represent\n *    what the user selected (e.g., selecting 00:00 returns Date with getUTCHours() = 0)\n * 2. We extract these UTC components (they represent the selected CRM timezone time)\n * 3. We create a datetime string \"YYYY-MM-DDTHH:MM\" representing that time in CRM timezone\n * 4. crmDateTimeStringToDate() converts it using buildUtcFromZoned() which:\n *    - Creates a UTC timestamp for that time\n *    - SUBTRACTS the timezone offset\n *    - Returns a Date that, when formatted in CRM timezone, shows the selected time\n * \n * Example: User selects 00:00 in calendar\n * - FullCalendar returns: Date with UTC hour=0, minute=0\n * - We create: \"2025-12-26T00:00\"\n * - buildUtcFromZoned creates: Date.UTC(2025,11,26,0,0,0) - 4 hours = 2025-12-25T20:00:00Z\n * - extractCrmTime() formats this Date in CRM timezone  correctly shows \"00:00\"\n * \n * DO NOT modify this function without understanding the full timezone conversion chain.\n */\nfunction convertFullCalendarDateToCrmDate(fcDate: Date): Date {\n  // Get UTC time components (these represent the selected time in CRM timezone display)\n  const year = fcDate.getUTCFullYear();\n  const month = fcDate.getUTCMonth() + 1;\n  const day = fcDate.getUTCDate();\n  const hour = fcDate.getUTCHours();\n  const minute = fcDate.getUTCMinutes();\n  const second = fcDate.getUTCSeconds();\n  \n  // Create a datetime string representing this time in CRM timezone\n  const dateTimeString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}T${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;\n  \n  // Use the timezone utility to create a Date object representing this time in CRM timezone\n  // This internally uses buildUtcFromZoned() which correctly handles the offset\n  const crmDate = crmDateTimeStringToDate(dateTimeString);\n  \n  // Fallback: If conversion fails, create the date manually using the same logic\n  if (!crmDate) {\n    const offsetMs = getCrmTimeZoneOffsetMinutes() * 60 * 1000;\n    // CRITICAL: Subtract offset (same as buildUtcFromZoned does)\n    return new Date(Date.UTC(\n      year,\n      month - 1,\n      day,\n      hour,\n      minute,\n      second,\n      0\n    ) - offsetMs);\n  }\n  \n  return crmDate;\n}\n\n/**\n * Converts a CRM timezone Date to a Date that FullCalendar can understand.\n * FullCalendar with timeZone set expects Date objects where UTC components\n * represent the time in the specified timezone.\n * \n * Example: To show Dec 29 00:00 in CRM timezone, we need a Date where:\n * - getUTCFullYear() = 2025\n * - getUTCMonth() = 11 (December, 0-indexed)\n * - getUTCDate() = 29\n * - getUTCHours() = 0\n * \n * This is the reverse of convertFullCalendarDateToCrmDate().\n */\nfunction convertCrmDateToFullCalendarDate(crmDate: Date): Date {\n  // Get the date parts as they appear in CRM timezone\n  const formatter = new Intl.DateTimeFormat(\"en-CA\", {\n    timeZone: getCrmTimeZone(),\n    year: \"numeric\",\n    month: \"2-digit\",\n    day: \"2-digit\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: false,\n  });\n  \n  const parts = formatter.formatToParts(crmDate);\n  const year = parseInt(parts.find(p => p.type === \"year\")?.value || \"0\", 10);\n  const month = parseInt(parts.find(p => p.type === \"month\")?.value || \"0\", 10);\n  const day = parseInt(parts.find(p => p.type === \"day\")?.value || \"0\", 10);\n  const hour = parseInt(parts.find(p => p.type === \"hour\")?.value || \"0\", 10);\n  const minute = parseInt(parts.find(p => p.type === \"minute\")?.value || \"0\", 10);\n  const second = parseInt(parts.find(p => p.type === \"second\")?.value || \"0\", 10);\n  \n  // Create a Date where UTC components represent this time in CRM timezone\n  // FullCalendar will interpret these UTC components as CRM timezone time\n  return new Date(Date.UTC(year, month - 1, day, hour, minute, second));\n}\n\nimport { useGetList, useUpdate, useNotify, useDataProvider } from \"ra-core\";\nimport type { Staff, Contact } from \"../types\";\n\ntype AppointmentCalendarProps = {\n  appointments: Appointment[];\n  loading: boolean;\n  onAppointmentClick: (appointment: Appointment) => void;\n  onAppointmentRightClick: (appointment: Appointment, event: React.MouseEvent) => void;\n  onAppointmentUpdate: () => void;\n  onDateSelect?: (start: Date, end: Date) => void;\n  currentDate?: Date;\n  view?: \"month\" | \"week\" | \"day\" | \"list\";\n  onDateChange?: (date: Date) => void;\n};\n\nexport const AppointmentCalendar: React.FC<AppointmentCalendarProps> = ({\n  appointments,\n  loading,\n  onAppointmentClick,\n  onAppointmentRightClick,\n  onAppointmentUpdate,\n  onDateSelect,\n  currentDate: propCurrentDate,\n  view: propView = \"month\",\n  onDateChange,\n}) => {\n  const calendarRef = useRef<FullCalendar>(null);\n  const [currentView, setCurrentView] = React.useState(\"dayGridMonth\");\n  const [internalCurrentDate, setInternalCurrentDate] = React.useState(new Date());\n  \n  // Use prop if provided, otherwise use internal state\n  const currentDate = propCurrentDate || internalCurrentDate;\n  const view = propView || \"month\";\n  \n  // Map view prop to FullCalendar view type\n  const fullCalendarView = React.useMemo(() => {\n    switch (view) {\n      case \"month\": return \"dayGridMonth\";\n      case \"week\": return \"timeGridWeek\";\n      case \"day\": return \"timeGridDay\";\n      case \"list\": return \"listWeek\";\n      default: return \"dayGridMonth\";\n    }\n  }, [view]);\n  const [visibleDateRange, setVisibleDateRange] = React.useState<{ start: Date; end: Date }>(() => {\n    // Default to current month if calendar not ready\n    const now = new Date();\n    const start = new Date(now.getFullYear(), now.getMonth(), 1);\n    const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n    end.setHours(23, 59, 59, 999);\n    return { start, end };\n  });\n  const [update] = useUpdate();\n  const notify = useNotify();\n\n  // Fetch appointment types from services\n  const appointmentTypes = useAppointmentTypes();\n\n  // Fetch staff and patients for display - don't block if they fail\n  // Use try-catch pattern to prevent errors from breaking the app\n  const { data: staffData } = useGetList<Staff>(\"staff\", {\n    pagination: { page: 1, perPage: 1000 },\n  }, {\n    retry: false,\n    enabled: true,\n    onError: (error) => {\n      console.warn(\"Failed to load staff:\", error);\n      // Don't throw - just log\n    },\n  });\n  const { data: patientsData } = useGetList<Contact>(\"clients\", {\n    pagination: { page: 1, perPage: 1000 },\n  }, {\n    retry: false,\n    enabled: true,\n    onError: (error) => {\n      console.warn(\"Failed to load patients:\", error);\n      // Don't throw - just log\n    },\n  });\n\n  // Track if we're programmatically navigating to avoid conflicts\n  const isNavigatingRef = React.useRef(false);\n  \n  // Handle datesSet callback to update visible date range\n  const handleDatesSet = useCallback((dateInfo: { start: Date; end: Date; startStr: string; endStr: string; timeZone: string; view: { type: string } }) => {\n    // Convert FullCalendar dates back to CRM dates\n    const crmStart = convertFullCalendarDateToCrmDate(dateInfo.start);\n    const crmEnd = convertFullCalendarDateToCrmDate(dateInfo.end);\n    \n    setVisibleDateRange({\n      start: crmStart,\n      end: crmEnd,\n    });\n    setCurrentView(dateInfo.view.type);\n    \n    // Only update the date if:\n    // 1. We're not in the middle of a programmatic navigation\n    // 2. We don't have a currentDate prop (parent is controlling the date)\n    //    OR the visible month matches the current date's month (to avoid resetting)\n    if (!isNavigatingRef.current) {\n      if (propCurrentDate) {\n        // Parent is controlling the date via prop - don't call onDateChange\n        // The parent's useEffect will handle navigation based on currentDate changes\n        // Only update internal state if we're using internal state\n        if (!onDateChange) {\n          setInternalCurrentDate(crmStart);\n        }\n      } else {\n        // No prop provided, we're managing date internally\n        if (onDateChange) {\n          onDateChange(crmStart);\n        } else {\n          setInternalCurrentDate(crmStart);\n        }\n      }\n    }\n    \n    // Reset the navigation flag after a short delay\n    setTimeout(() => {\n      isNavigatingRef.current = false;\n    }, 150);\n  }, [onDateChange, propCurrentDate]);\n  \n  // Update calendar when view or date changes\n  // Use queueMicrotask to defer FullCalendar API calls and avoid flushSync warnings\n  React.useEffect(() => {\n    let cancelled = false;\n    \n    const updateCalendar = () => {\n      if (cancelled) return;\n      \n      const calendarApi = calendarRef.current?.getApi();\n      if (calendarApi) {\n        // Compare dates by day (ignore time) to avoid unnecessary updates\n        // Convert FullCalendar date to CRM date for comparison\n        const calendarDate = convertFullCalendarDateToCrmDate(calendarApi.getDate());\n        const calendarDateStr = format(calendarDate, \"yyyy-MM-dd\");\n        const currentDateStr = format(currentDate, \"yyyy-MM-dd\");\n        \n        // Update view if it changed - defer to next tick to avoid flushSync\n        if (calendarApi.view.type !== fullCalendarView) {\n          queueMicrotask(() => {\n            if (!cancelled) {\n              calendarApi.changeView(fullCalendarView);\n            }\n          });\n        }\n        \n        // Update date if it changed - compare appropriately based on view type\n        // For month view, compare by month/year; for other views, compare by day\n        let shouldNavigate = false;\n        if (currentDate) {\n          if (fullCalendarView === \"dayGridMonth\") {\n            // For month view, compare by month and year\n            // Use multiple comparison methods to ensure we catch all cases (past and future months)\n            const currentMonth = format(currentDate, \"yyyy-MM\");\n            \n            // Method 1: Compare with calendar's current date month\n            const calendarMonth = format(calendarDate, \"yyyy-MM\");\n            let monthDiffers = calendarMonth !== currentMonth;\n            \n            // Method 2: Compare with visible range start month (more reliable for current view)\n            const view = calendarApi.view;\n            if (view && view.currentStart) {\n              const visibleStart = convertFullCalendarDateToCrmDate(view.currentStart);\n              const visibleStartMonth = format(visibleStart, \"yyyy-MM\");\n              monthDiffers = monthDiffers || (visibleStartMonth !== currentMonth);\n            }\n            \n            // Navigate if either comparison shows the month is different\n            shouldNavigate = monthDiffers;\n          } else {\n            // For week/day/list views, compare by day\n            shouldNavigate = calendarDateStr !== currentDateStr;\n          }\n        }\n        \n        if (shouldNavigate) {\n          // Set flag to indicate we're programmatically navigating\n          isNavigatingRef.current = true;\n          \n          // Use setTimeout to ensure calendar is ready, with a fallback retry\n          const navigateToDate = () => {\n            if (cancelled) return;\n            const api = calendarRef.current?.getApi();\n            if (api) {\n              const fcDate = convertCrmDateToFullCalendarDate(currentDate);\n              // Force navigation to the selected date\n              // Use gotoDate which works for both past and future dates\n              try {\n                api.gotoDate(fcDate);\n                // Verify navigation succeeded by checking if we need to retry\n                setTimeout(() => {\n                  if (!cancelled) {\n                    const verifyApi = calendarRef.current?.getApi();\n                    if (verifyApi) {\n                      const verifyView = verifyApi.view;\n                      if (verifyView && verifyView.currentStart) {\n                        const verifyStart = convertFullCalendarDateToCrmDate(verifyView.currentStart);\n                        const verifyMonth = format(verifyStart, \"yyyy-MM\");\n                        const targetMonth = format(currentDate, \"yyyy-MM\");\n                        // If navigation didn't work, try again\n                        if (verifyMonth !== targetMonth) {\n                          verifyApi.gotoDate(fcDate);\n                        }\n                      }\n                    }\n                  }\n                }, 100);\n              } catch (error) {\n                console.warn(\"Error navigating calendar:\", error);\n                // Retry on error\n                setTimeout(navigateToDate, 50);\n              }\n            } else {\n              // Retry after a short delay if calendar not ready\n              setTimeout(navigateToDate, 50);\n            }\n          };\n          // Use a small delay to ensure the calendar is fully ready\n          setTimeout(navigateToDate, 10);\n        }\n      } else {\n        // Calendar not ready yet, retry after a short delay\n        setTimeout(updateCalendar, 50);\n      }\n    };\n    \n    queueMicrotask(updateCalendar);\n    \n    return () => {\n      cancelled = true;\n    };\n  }, [fullCalendarView, currentDate]);\n\n  // Helper function to create an event from an appointment\n  // Must be defined BEFORE events useMemo that uses it\n  const createEventFromAppointment = useCallback((\n    appointment: Appointment,\n    staff: Staff[],\n    patients: Contact[],\n    allAppointments: Appointment[]\n  ): EventInput | null => {\n    // Get color from selected service - use selected_service_ids from custom_fields if available\n    // This ensures we use the exact service color set in Services Management\n    let typeColor = \"#a855f7\"; // Default purple\n    let appointmentType: any = undefined; // Declare at function scope to use later\n    \n    // First, check if we have selected service IDs stored in custom_fields\n    const selectedServiceIds = appointment?.custom_fields?.selected_service_ids;\n    if (Array.isArray(selectedServiceIds) && selectedServiceIds.length > 0) {\n      // Use the first selected service's color\n      const firstServiceId = selectedServiceIds[0];\n      const selectedServiceType = appointmentTypes.find((t) => {\n        const serviceType = t as any;\n        // Compare as numbers to handle string/number mismatch\n        return serviceType.serviceId?.toString() === firstServiceId?.toString() ||\n               serviceType.serviceId === firstServiceId ||\n               serviceType.serviceId === Number(firstServiceId);\n      });\n      if (selectedServiceType) {\n        // Always set appointmentType if found, even if no color\n        appointmentType = selectedServiceType;\n        if (selectedServiceType.color) {\n          typeColor = selectedServiceType.color;\n        }\n      } else {\n        console.warn(\"Service type not found for selected service ID in createEvent:\", {\n          appointmentId: appointment.id,\n          selectedServiceIds,\n          firstServiceId,\n          availableServiceIds: appointmentTypes.map(t => ({ \n            serviceId: (t as any).serviceId, \n            label: t.label,\n            color: t.color \n          }))\n        });\n        // Fallback: Find appointment type by appointment_type field\n        appointmentType = appointmentTypes.find(\n          (type) => {\n            // Direct match\n            if (type.value === appointment.appointment_type) {\n              return true;\n            }\n            // Check if it's a service-based type with matching appointmentType\n            const serviceType = type as any;\n            if (serviceType.appointmentType === appointment.appointment_type) {\n              return true;\n            }\n            return false;\n          }\n        );\n        // Get color from found type\n        if (appointmentType?.color && appointmentType.color !== \"#6b7280\") {\n          typeColor = appointmentType.color;\n        }\n      }\n    } else {\n      // Fallback: Find appointment type by appointment_type field\n      appointmentType = appointmentTypes.find(\n        (type) => {\n          // Direct match\n          if (type.value === appointment.appointment_type) {\n            return true;\n          }\n          // Check if it's a service-based type with matching appointmentType\n          const serviceType = type as any;\n          if (serviceType.appointmentType === appointment.appointment_type) {\n            return true;\n          }\n          return false;\n        }\n      );\n      \n      // Get color from found type\n      if (appointmentType?.color && appointmentType.color !== \"#6b7280\") {\n        typeColor = appointmentType.color;\n      }\n    }\n    \n    // Status colors - used for background\n    // Make status check case-insensitive and handle variations\n    const statusLower = (appointment.status || \"\").toLowerCase().trim();\n    const STATUS_COLORS: Record<string, string> = {\n      scheduled: \"#3b82f6\", // Blue\n      completed: \"#10b981\", // Green\n      cancelled: \"#ef4444\", // Red\n      cancel: \"#ef4444\", // Alternative spelling\n      complete: \"#10b981\", // Alternative spelling\n    };\n    // Force explicit status color mapping - COMPLETED MUST BE GREEN\n    let statusColor = \"#3b82f6\"; // Default to blue (scheduled)\n    if (statusLower === \"completed\") {\n      statusColor = \"#10b981\"; // GREEN for completed - FORCE IT\n    } else if (statusLower === \"cancelled\" || statusLower === \"cancel\") {\n      statusColor = \"#ef4444\"; // RED for cancelled\n    } else if (statusLower === \"scheduled\") {\n      statusColor = \"#3b82f6\"; // BLUE for scheduled\n    } else {\n      // Fallback to mapped colors\n      statusColor = STATUS_COLORS[statusLower] || \"#3b82f6\";\n    }\n\n    // Get patient name\n    const patient = patients.find((p) => p.id === appointment.patient_id);\n    const patientName = patient\n      ? `${patient.first_name} ${patient.last_name}`.trim()\n      : \"Unknown Patient\";\n\n    // Get staff info\n    const primaryStaff = staff.find((s) => s.id === appointment.primary_staff_id);\n    const staffName = primaryStaff\n      ? `${primaryStaff.first_name} ${primaryStaff.last_name}`.trim()\n      : \"\";\n    const staffType = primaryStaff?.staff_type || \"\";\n\n    // Build event title\n    const serviceAbbrev = appointmentType?.label.substring(0, 3).toUpperCase() || \"APT\";\n    const driverInfo = appointment.driver_id ? \"Driver\" : \"Self\";\n    const title = `${patientName} - ${serviceAbbrev} ${staffName} ${driverInfo}`;\n\n    // Parse dates - start_time and end_time are ISO datetime strings (timestamp with time zone)\n    // appointment_date is YYYY-MM-DD (date type)\n    let start: Date;\n    let end: Date;\n    \n    try {\n      // Parse start_time and end_time as ISO datetime strings\n      if (appointment.start_time && appointment.end_time) {\n        // Ensure we're working with strings, not Date objects\n        const startTimeStr = typeof appointment.start_time === 'string' \n          ? appointment.start_time \n          : appointment.start_time instanceof Date\n          ? appointment.start_time.toISOString()\n          : String(appointment.start_time);\n        \n        const endTimeStr = typeof appointment.end_time === 'string'\n          ? appointment.end_time\n          : appointment.end_time instanceof Date\n          ? appointment.end_time.toISOString()\n          : String(appointment.end_time);\n        \n        start = new Date(startTimeStr);\n        end = new Date(endTimeStr);\n      } else if (appointment.appointment_date) {\n        // Fallback: use appointment_date with default times if start/end not available\n        const appointmentDate = appointment.appointment_date;\n        start = new Date(`${appointmentDate}T00:00:00`);\n        end = new Date(`${appointmentDate}T01:00:00`);\n      } else {\n        console.warn(\"No date/time data for appointment:\", appointment.id);\n        return null;\n      }\n\n      // Validate dates - ensure they are Date objects\n      if (!(start instanceof Date) || !(end instanceof Date)) {\n        console.warn(\"Invalid date objects for appointment:\", appointment.id, {\n          start,\n          end,\n          start_time: appointment.start_time,\n          end_time: appointment.end_time,\n        });\n        return null;\n      }\n\n      // Validate dates are not invalid\n      if (isNaN(start.getTime()) || isNaN(end.getTime())) {\n        console.warn(\"Invalid date for appointment:\", appointment.id, {\n          start_time: appointment.start_time,\n          end_time: appointment.end_time,\n          appointment_date: appointment.appointment_date,\n        });\n        return null;\n      }\n    } catch (error) {\n      console.error(\"Error parsing appointment dates:\", appointment.id, error);\n      return null;\n    }\n\n    // Filter out null events\n    if (!start || !end || !(start instanceof Date) || !(end instanceof Date)) {\n      return null;\n    }\n\n    // The dates are stored in UTC and represent the configured CRM timezone.\n    // Example: 2025-12-24T11:00:00.000Z stored in DB = 15:00 in CRM timezone on Dec 24 (for UTC+4).\n    // \n    // Since FullCalendar's timeZone conversion isn't working as expected,\n    // we manually adjust the dates by adding the timezone offset.\n    // This way, the UTC time matches the CRM timezone time we want to display.\n    // \n    // Stored: 11:00 UTC (represents 15:00 in configured timezone)\n    // Adjusted: 15:00 UTC (will display as 15:00 when timeZone is set, or as-is if not)\n    const CRM_OFFSET_MS = getCrmTimeZoneOffsetMinutes() * 60 * 1000; // Dynamic offset in milliseconds\n    const adjustedStart = new Date(start.getTime() + CRM_OFFSET_MS);\n    const adjustedEnd = new Date(end.getTime() + CRM_OFFSET_MS);\n    \n    return {\n      id: appointment.id.toString(),\n      title,\n      start: adjustedStart.toISOString(),\n      end: adjustedEnd.toISOString(),\n      backgroundColor: statusColor, // Background color based on status\n      borderColor: \"transparent\", // No border\n      borderWidth: 0,\n      textColor: \"#ffffff\",\n      // Improve month view display\n      display: 'block',\n      // Add data attribute for CSS targeting\n      classNames: [`appointment-status-${statusLower}`],\n      extendedProps: {\n        appointment,\n        statusColor,\n        typeColor,\n        appointmentStatus: appointment.status, // Store original status\n      },\n    };\n  }, [appointmentTypes]);\n\n  // Convert appointments to FullCalendar events\n  const events = useMemo<EventInput[]>(() => {\n    if (!appointments || appointments.length === 0) return [];\n    // Don't require staffData and patientsData - we can show appointments without them\n    const staff = staffData || [];\n    const patients = patientsData || [];\n\n    const allEvents: EventInput[] = [];\n    \n    // Process all appointments\n    appointments.forEach((appointment) => {\n      const event = createEventFromAppointment(appointment, staff, patients, appointments);\n      if (event) {\n        allEvents.push(event);\n      }\n    });\n\n    return allEvents;\n  }, [appointments, staffData, patientsData, visibleDateRange, createEventFromAppointment, appointmentTypes]);\n\n  const handleEventClick = useCallback(\n    (clickInfo: EventClickArg) => {\n      const appointment = clickInfo.event.extendedProps.appointment as Appointment;\n      onAppointmentClick(appointment);\n    },\n    [onAppointmentClick]\n  );\n\n  const handleEventRightClick = useCallback(\n    (event: React.MouseEvent, appointment: Appointment) => {\n      onAppointmentRightClick(appointment, event);\n    },\n    [onAppointmentRightClick]\n  );\n\n  const handleDateSelect = useCallback(\n    (selectInfo: DateSelectArg) => {\n      if (onDateSelect && selectInfo.start) {\n        const viewType = selectInfo.view.type;\n        \n        // For month view, default to 8am with 60 minutes duration\n        if (viewType === \"dayGridMonth\") {\n          // Get the selected date components from FullCalendar\n          const year = selectInfo.start.getUTCFullYear();\n          const month = selectInfo.start.getUTCMonth() + 1;\n          const day = selectInfo.start.getUTCDate();\n          \n          // Create datetime strings for 8:00 AM and 9:00 AM in CRM timezone\n          const startDateTimeString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}T08:00`;\n          const endDateTimeString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}T09:00`;\n          \n          // Convert to Date objects in CRM timezone\n          const startDate = crmDateTimeStringToDate(startDateTimeString);\n          const endDate = crmDateTimeStringToDate(endDateTimeString);\n          \n          if (startDate && endDate) {\n            onDateSelect(startDate, endDate);\n          }\n        } else {\n          // For week/day views, use the selected time range\n          if (selectInfo.end) {\n            const adjustedStart = convertFullCalendarDateToCrmDate(selectInfo.start);\n            const adjustedEnd = convertFullCalendarDateToCrmDate(selectInfo.end);\n            onDateSelect(adjustedStart, adjustedEnd);\n          }\n        }\n      }\n      // Unselect the date range in the calendar\n      selectInfo.view.calendar.unselect();\n    },\n    [onDateSelect]\n  );\n\n  const handleEventDrop = useCallback(\n    async (dropInfo: EventDropArg) => {\n      const appointment = dropInfo.event.extendedProps.appointment as Appointment;\n      const newStart = dropInfo.event.start;\n      const newEnd = dropInfo.event.end;\n\n      if (!newStart) return;\n\n      try {\n        // FullCalendar returns dates that have been adjusted for display (+4 hours).\n        // We need to convert them back to represent the actual CRM timezone time.\n        // Since we added the timezone offset for display, we subtract it to get the original UTC time\n        // that represents the CRM timezone time the user selected.\n        const CRM_OFFSET_MS = getCrmTimeZoneOffsetMinutes() * 60 * 1000; // Dynamic offset in milliseconds\n        const displayStart = new Date(newStart.getTime() - CRM_OFFSET_MS);\n        const displayEnd = newEnd \n          ? new Date(newEnd.getTime() - CRM_OFFSET_MS)\n          : new Date(displayStart.getTime() + appointment.duration_minutes * 60 * 1000);\n\n        // Extract the time components as they appear in CRM timezone\n        const startParts = new Intl.DateTimeFormat('en-CA', {\n          timeZone: getCrmTimeZone(),\n          year: 'numeric',\n          month: '2-digit',\n          day: '2-digit',\n          hour: '2-digit',\n          minute: '2-digit',\n          second: '2-digit',\n          hour12: false,\n        }).formatToParts(displayStart).reduce((acc, part) => {\n          if (part.type !== 'literal') {\n            acc[part.type] = Number(part.value);\n          }\n          return acc;\n        }, {} as Record<string, number>);\n\n        const endParts = new Intl.DateTimeFormat('en-CA', {\n          timeZone: getCrmTimeZone(),\n          year: 'numeric',\n          month: '2-digit',\n          day: '2-digit',\n          hour: '2-digit',\n          minute: '2-digit',\n          second: '2-digit',\n          hour12: false,\n        }).formatToParts(displayEnd).reduce((acc, part) => {\n          if (part.type !== 'literal') {\n            acc[part.type] = Number(part.value);\n          }\n          return acc;\n        }, {} as Record<string, number>);\n\n        // Create datetime strings in the format expected by crmDateTimeStringToISO\n        const startDateTime = `${startParts.year}-${String(startParts.month).padStart(2, '0')}-${String(startParts.day).padStart(2, '0')}T${String(startParts.hour).padStart(2, '0')}:${String(startParts.minute).padStart(2, '0')}`;\n        const endDateTime = `${endParts.year}-${String(endParts.month).padStart(2, '0')}-${String(endParts.day).padStart(2, '0')}T${String(endParts.hour).padStart(2, '0')}:${String(endParts.minute).padStart(2, '0')}`;\n\n        // Convert to ISO strings for database storage\n        const startDateTimeISO = crmDateTimeStringToISO(startDateTime);\n        const endDateTimeISO = crmDateTimeStringToISO(endDateTime);\n\n        if (!startDateTimeISO || !endDateTimeISO) {\n          throw new Error(\"Invalid date/time format\");\n        }\n\n        // Calculate duration\n        const durationMs = displayEnd.getTime() - displayStart.getTime();\n        const durationMinutes = Math.max(Math.round(durationMs / (60 * 1000)), 15);\n\n        // Update the appointment\n        await update(\n          \"appointments\",\n          {\n            id: appointment.id,\n            data: {\n              appointment_date: startDateTimeISO.split(\"T\")[0], // Store date part only\n              start_time: startDateTimeISO,\n              end_time: endDateTimeISO,\n              duration_minutes: durationMinutes,\n            },\n            previousData: appointment,\n          },\n          {\n            onSuccess: () => {\n              notify(\"Appointment moved successfully\", { type: \"success\" });\n              onAppointmentUpdate();\n            },\n            onError: (error: any) => {\n              console.error(\"Error updating appointment:\", error);\n              notify(\"Failed to update appointment\", { type: \"error\" });\n              // Revert the visual change by refreshing\n              onAppointmentUpdate();\n            },\n          }\n        );\n      } catch (error) {\n        console.error(\"Error in handleEventDrop:\", error);\n        notify(\"Failed to update appointment\", { type: \"error\" });\n        // Revert the visual change by refreshing\n        onAppointmentUpdate();\n      }\n    },\n    [onAppointmentUpdate, update, notify]\n  );\n\n  const handleEventResize = useCallback(\n    async (resizeInfo: EventResizeArg) => {\n      const appointment = resizeInfo.event.extendedProps.appointment as Appointment;\n      const newStart = resizeInfo.event.start;\n      const newEnd = resizeInfo.event.end;\n\n      if (!newStart || !newEnd) return;\n\n      try {\n        // FullCalendar returns dates that have been adjusted for display (with timezone offset).\n        // We need to convert them back to represent the actual CRM timezone time.\n        const CRM_OFFSET_MS = getCrmTimeZoneOffsetMinutes() * 60 * 1000; // Dynamic offset in milliseconds\n        const displayStart = new Date(newStart.getTime() - CRM_OFFSET_MS);\n        const displayEnd = new Date(newEnd.getTime() - CRM_OFFSET_MS);\n\n        // Extract the time components as they appear in CRM timezone\n        const startParts = new Intl.DateTimeFormat('en-CA', {\n          timeZone: getCrmTimeZone(),\n          year: 'numeric',\n          month: '2-digit',\n          day: '2-digit',\n          hour: '2-digit',\n          minute: '2-digit',\n          second: '2-digit',\n          hour12: false,\n        }).formatToParts(displayStart).reduce((acc, part) => {\n          if (part.type !== 'literal') {\n            acc[part.type] = Number(part.value);\n          }\n          return acc;\n        }, {} as Record<string, number>);\n\n        const endParts = new Intl.DateTimeFormat('en-CA', {\n          timeZone: getCrmTimeZone(),\n          year: 'numeric',\n          month: '2-digit',\n          day: '2-digit',\n          hour: '2-digit',\n          minute: '2-digit',\n          second: '2-digit',\n          hour12: false,\n        }).formatToParts(displayEnd).reduce((acc, part) => {\n          if (part.type !== 'literal') {\n            acc[part.type] = Number(part.value);\n          }\n          return acc;\n        }, {} as Record<string, number>);\n\n        // Create datetime strings in the format expected by crmDateTimeStringToISO\n        const startDateTime = `${startParts.year}-${String(startParts.month).padStart(2, '0')}-${String(startParts.day).padStart(2, '0')}T${String(startParts.hour).padStart(2, '0')}:${String(startParts.minute).padStart(2, '0')}`;\n        const endDateTime = `${endParts.year}-${String(endParts.month).padStart(2, '0')}-${String(endParts.day).padStart(2, '0')}T${String(endParts.hour).padStart(2, '0')}:${String(endParts.minute).padStart(2, '0')}`;\n\n        // Convert to ISO strings for database storage\n        const startDateTimeISO = crmDateTimeStringToISO(startDateTime);\n        const endDateTimeISO = crmDateTimeStringToISO(endDateTime);\n\n        if (!startDateTimeISO || !endDateTimeISO) {\n          throw new Error(\"Invalid date/time format\");\n        }\n\n        // Calculate duration\n        const durationMinutes = Math.max(Math.round((displayEnd.getTime() - displayStart.getTime()) / (60 * 1000)), 15);\n\n        // Update the appointment\n        await update(\n          \"appointments\",\n          {\n            id: appointment.id,\n            data: {\n              appointment_date: startDateTimeISO.split(\"T\")[0], // Store date part only\n              start_time: startDateTimeISO,\n              end_time: endDateTimeISO,\n              duration_minutes: durationMinutes,\n            },\n            previousData: appointment,\n          },\n          {\n            onSuccess: () => {\n              notify(\"Appointment resized successfully\", { type: \"success\" });\n              onAppointmentUpdate();\n            },\n            onError: (error: any) => {\n              console.error(\"Error updating appointment:\", error);\n              notify(\"Failed to update appointment\", { type: \"error\" });\n              // Revert the visual change by refreshing\n              onAppointmentUpdate();\n            },\n          }\n        );\n      } catch (error) {\n        console.error(\"Error in handleEventResize:\", error);\n        notify(\"Failed to update appointment\", { type: \"error\" });\n        // Revert the visual change by refreshing\n        onAppointmentUpdate();\n      }\n    },\n    [onAppointmentUpdate, update, notify]\n  );\n\n  const handlePrev = useCallback(() => {\n    const calendarApi = calendarRef.current?.getApi();\n    if (calendarApi) {\n      calendarApi.prev();\n      const newDate = calendarApi.getDate();\n      if (onDateChange) {\n        onDateChange(newDate);\n      } else {\n        setInternalCurrentDate(newDate);\n      }\n    }\n  }, [onDateChange]);\n\n  const handleNext = useCallback(() => {\n    const calendarApi = calendarRef.current?.getApi();\n    if (calendarApi) {\n      calendarApi.next();\n      const newDate = calendarApi.getDate();\n      if (onDateChange) {\n        onDateChange(newDate);\n      } else {\n        setInternalCurrentDate(newDate);\n      }\n    }\n  }, [onDateChange]);\n\n  const handleToday = useCallback(() => {\n    // Get today's date at midnight in CRM timezone\n    const today = crmToday();\n    \n    // Convert to FullCalendar format (UTC components represent CRM timezone time)\n    const fcDate = convertCrmDateToFullCalendarDate(today);\n    \n    // Use queueMicrotask to defer the calendar API call and avoid flushSync warnings\n    queueMicrotask(() => {\n      const calendarApi = calendarRef.current?.getApi();\n      if (calendarApi) {\n        // Explicitly navigate to today's date\n        calendarApi.gotoDate(fcDate);\n        \n        // Update the date state after navigation (use the CRM date, not FC date)\n        if (onDateChange) {\n          onDateChange(today);\n        } else {\n          setInternalCurrentDate(today);\n        }\n      }\n    });\n  }, [onDateChange]);\n\n  const handleViewChange = useCallback((view: string) => {\n    const calendarApi = calendarRef.current?.getApi();\n    if (calendarApi) {\n      calendarApi.changeView(view);\n      setCurrentView(view);\n    }\n  }, []);\n\n  const getHeaderTitle = () => {\n    const calendarApi = calendarRef.current?.getApi();\n    if (!calendarApi) return \"\";\n\n    const view = calendarApi.view;\n    const viewType = view.type;\n\n    if (viewType === \"dayGridMonth\") {\n      return format(view.currentStart, \"MMMM yyyy\");\n    } else if (viewType === \"timeGridWeek\" || viewType === \"dayGridWeek\") {\n      const start = view.currentStart;\n      const end = view.currentEnd;\n      const startMonth = format(start, \"MMM\");\n      const endMonth = format(end, \"MMM\");\n      const year = format(start, \"yyyy\");\n      if (startMonth === endMonth) {\n        return `${format(start, \"EEE\")} - ${format(end, \"EEE\")} ${year}`;\n      }\n      return `${format(start, \"EEE MMM\")} - ${format(end, \"EEE MMM\")} ${year}`;\n    } else if (viewType === \"timeGridDay\") {\n      return format(view.currentStart, \"EEEE, MMMM d, yyyy\");\n    }\n    return \"\";\n  };\n\n  return (\n    <>\n      {/* Add styles for better month view event readability */}\n      <style>{`\n        /* Ensure calendar views have consistent height - 25% larger and fill space */\n        .fc {\n          height: 100% !important;\n          min-height: 750px !important;\n        }\n        .fc-view-harness {\n          height: 100% !important;\n          min-height: 750px !important;\n        }\n        .fc-dayGridMonth-view,\n        .fc-timeGridWeek-view,\n        .fc-timeGridDay-view {\n          height: 100% !important;\n          min-height: 750px !important;\n        }\n        /* Dark grey background for days from other months */\n        .fc-day-other {\n          background-color: #e5e7eb !important; /* Light grey-200 in light mode */\n        }\n        .fc-day-other .fc-daygrid-day-number {\n          color: #9ca3af !important; /* Grey-400 */\n          opacity: 0.7 !important;\n        }\n        .fc-day-other .fc-event {\n          opacity: 0.6 !important;\n        }\n        /* Dark mode support for other month days - use a much darker, more contrasting color */\n        .dark .fc-day-other {\n          background-color: #0a0e14 !important; /* Very dark, almost black - much darker than current month */\n        }\n        .dark .fc-day-other .fc-daygrid-day-frame {\n          background-color: #0a0e14 !important;\n          border: 1px solid #1f2937 !important; /* Subtle border for extra distinction */\n        }\n        .dark .fc-day-other .fc-daygrid-day-number {\n          color: #4b5563 !important; /* Darker grey-600 for better contrast */\n          opacity: 0.6 !important;\n        }\n        .dark .fc-day-other .fc-event {\n          opacity: 0.4 !important; /* More muted events */\n        }\n        /* Ensure the day cell itself has the dark background */\n        .dark .fc-day-other.fc-daygrid-day {\n          background-color: #0a0e14 !important;\n        }\n        /* Also target the table cell */\n        .dark .fc-day-other td {\n          background-color: #0a0e14 !important;\n        }\n        /* Orange highlight for today */\n        .fc-day-today {\n          background-color: rgba(249, 115, 22, 0.1) !important;\n        }\n        .fc-day-today .fc-daygrid-day-number {\n          color: #f97316 !important;\n          font-weight: 600 !important;\n        }\n        .fc-col-header-cell.fc-day-today {\n          background-color: rgba(249, 115, 22, 0.1) !important;\n        }\n        .fc-timegrid-col.fc-day-today {\n          background-color: rgba(249, 115, 22, 0.05) !important;\n        }\n        /* Orange appointment badges for today - keep type color but add orange accent */\n        .fc-day-today .fc-event {\n          box-shadow: 0 0 0 2px #f97316 !important;\n        }\n        /* Ensure events have proper background colors */\n        .fc-daygrid-event,\n        .fc-list-event,\n        .fc-timegrid-event {\n          min-height: 24px !important;\n          border-radius: 4px !important;\n          padding: 2px 4px !important;\n          opacity: 1 !important;\n          transition: background-color 0.2s ease, border-color 0.2s ease !important;\n        }\n        /* Ensure background colors are applied and visible - no borders */\n        /* DO NOT override backgroundColor - let FullCalendar use the backgroundColor property from events */\n        .fc-event {\n          border: none !important;\n          border-radius: 4px !important;\n        }\n        /* Force background color based on status class */\n        .fc-event.appointment-status-completed {\n          background-color: #10b981 !important;\n        }\n        .fc-event.appointment-status-cancelled,\n        .fc-event.appointment-status-cancel {\n          background-color: #ef4444 !important;\n        }\n        .fc-event.appointment-status-scheduled {\n          background-color: #3b82f6 !important;\n        }\n        /* Hover effect - darken the base color instead of turning blue */\n        .fc-event.appointment-status-completed:hover,\n        .fc-event.appointment-status-completed.fc-event-selected {\n          background-color: #059669 !important; /* Dark green */\n          border-color: #059669 !important;\n        }\n        .fc-event.appointment-status-cancelled:hover,\n        .fc-event.appointment-status-cancelled.fc-event-selected,\n        .fc-event.appointment-status-cancel:hover,\n        .fc-event.appointment-status-cancel.fc-event-selected {\n          background-color: #dc2626 !important; /* Dark red */\n          border-color: #dc2626 !important;\n        }\n        .fc-event.appointment-status-scheduled:hover,\n        .fc-event.appointment-status-scheduled.fc-event-selected {\n          background-color: #2563eb !important; /* Dark blue */\n          border-color: #2563eb !important;\n        }\n        /* Generic hover for events without status class - darken using filter */\n        .fc-event:hover:not(.appointment-status-completed):not(.appointment-status-cancelled):not(.appointment-status-cancel):not(.appointment-status-scheduled),\n        .fc-event.fc-event-selected:not(.appointment-status-completed):not(.appointment-status-cancelled):not(.appointment-status-cancel):not(.appointment-status-scheduled) {\n          filter: brightness(0.85) !important;\n        }\n        /* List view title cell hover - match the event color */\n        .fc-list-event.appointment-status-completed:hover .fc-list-event-title,\n        .fc-list-event.appointment-status-completed.fc-event-selected .fc-list-event-title {\n          background-color: #059669 !important; /* Dark green */\n        }\n        .fc-list-event.appointment-status-cancelled:hover .fc-list-event-title,\n        .fc-list-event.appointment-status-cancelled.fc-event-selected .fc-list-event-title,\n        .fc-list-event.appointment-status-cancel:hover .fc-list-event-title,\n        .fc-list-event.appointment-status-cancel.fc-event-selected .fc-list-event-title {\n          background-color: #dc2626 !important; /* Dark red */\n        }\n        .fc-list-event.appointment-status-scheduled:hover .fc-list-event-title,\n        .fc-list-event.appointment-status-scheduled.fc-event-selected .fc-list-event-title {\n          background-color: #2563eb !important; /* Dark blue */\n        }\n        .fc-daygrid-event .fc-event-title,\n        .fc-list-event .fc-event-title,\n        .fc-timegrid-event .fc-event-title {\n          font-weight: 600 !important;\n          font-size: 11px !important;\n          line-height: 1.3 !important;\n          color: #ffffff !important;\n        }\n        .fc-daygrid-dot-event {\n          padding: 2px 4px !important;\n        }\n        .fc-daygrid-dot-event .fc-event-title {\n          font-weight: 600 !important;\n          font-size: 11px !important;\n          color: #ffffff !important;\n        }\n        /* List view specific styling */\n        .fc-list-event {\n          background-color: var(--fc-event-bg-color) !important;\n          transition: background-color 0.2s ease !important;\n        }\n        .fc-list-event-title {\n          color: #ffffff !important;\n          transition: background-color 0.2s ease !important;\n        }\n        /* List view time column styling - always blue with white text */\n        .fc-list-event-time {\n          background-color: #3b82f6 !important;\n          color: #ffffff !important;\n          font-weight: 600 !important;\n          padding: 8px 12px !important;\n          border-radius: 4px 0 0 4px !important;\n        }\n        /* List view graphic cell - no hover effect */\n        .fc-list-event-graphic {\n          background-color: transparent !important;\n        }\n        /* When row is hovered, darken based on status */\n        .fc-list-event.appointment-status-completed:hover,\n        .fc-list-event.appointment-status-completed.fc-event-selected {\n          background-color: #059669 !important; /* Dark green */\n        }\n        .fc-list-event.appointment-status-cancelled:hover,\n        .fc-list-event.appointment-status-cancelled.fc-event-selected,\n        .fc-list-event.appointment-status-cancel:hover,\n        .fc-list-event.appointment-status-cancel.fc-event-selected {\n          background-color: #dc2626 !important; /* Dark red */\n        }\n        .fc-list-event.appointment-status-scheduled:hover,\n        .fc-list-event.appointment-status-scheduled.fc-event-selected {\n          background-color: #2563eb !important; /* Dark blue */\n        }\n        /* Generic hover for list events without status class */\n        .fc-list-event:hover:not(.appointment-status-completed):not(.appointment-status-cancelled):not(.appointment-status-cancel):not(.appointment-status-scheduled),\n        .fc-list-event.fc-event-selected:not(.appointment-status-completed):not(.appointment-status-cancelled):not(.appointment-status-cancel):not(.appointment-status-scheduled) {\n          filter: brightness(0.85) !important;\n        }\n        /* Time column darkens to match status on hover */\n        .fc-list-event.appointment-status-completed:hover .fc-list-event-time,\n        .fc-list-event.appointment-status-completed.fc-event-selected .fc-list-event-time {\n          background-color: #059669 !important; /* Dark green */\n          color: #ffffff !important;\n        }\n        .fc-list-event.appointment-status-cancelled:hover .fc-list-event-time,\n        .fc-list-event.appointment-status-cancelled.fc-event-selected .fc-list-event-time,\n        .fc-list-event.appointment-status-cancel:hover .fc-list-event-time,\n        .fc-list-event.appointment-status-cancel.fc-event-selected .fc-list-event-time {\n          background-color: #dc2626 !important; /* Dark red */\n          color: #ffffff !important;\n        }\n        .fc-list-event.appointment-status-scheduled:hover .fc-list-event-time,\n        .fc-list-event.appointment-status-scheduled.fc-event-selected .fc-list-event-time {\n          background-color: #2563eb !important; /* Dark blue */\n          color: #ffffff !important;\n        }\n      `}</style>\n      <div className=\"bg-white dark:bg-slate-800 flex flex-col overflow-hidden h-full min-h-0 w-full\">\n\n      {/* FullCalendar */}\n      <div \n        className=\"overflow-y-auto flex-1 min-h-[750px]\"\n        style={{ \n          flex: \"1 1 auto\"\n        }}\n      >\n        {typeof window !== \"undefined\" && (\n          <FullCalendar\n            ref={calendarRef}\n            plugins={[dayGridPlugin, timeGridPlugin, interactionPlugin, listPlugin]}\n          initialView={fullCalendarView}\n          initialDate={convertCrmDateToFullCalendarDate(currentDate)}\n          timeZone={getCrmTimeZone()}\n          firstDay={1}\n          slotDuration=\"00:15:00\"\n          slotLabelInterval=\"01:00:00\"\n          slotMinTime=\"00:00:00\"\n          slotMaxTime=\"24:00:00\"\n          nowIndicator={true}\n          editable={true}\n          selectable={true}\n          selectMirror={true}\n          events={events}\n          eventClick={handleEventClick}\n          select={handleDateSelect}\n          eventDrop={handleEventDrop}\n          eventResize={handleEventResize}\n          datesSet={handleDatesSet}\n          height=\"100%\"\n          headerToolbar={false}\n          locale=\"en-GB\"\n          fixedWeekCount={false}\n          showNonCurrentDates={true}\n          dayHeaderFormat={(arg: any) => {\n            try {\n              // Get view type from calendar API if available, otherwise use state\n              const calendarApi = calendarRef.current?.getApi();\n              const viewType = calendarApi?.view?.type || currentView;\n              \n              // Extract date from arg - FullCalendar v6 date/start are objects with marker property\n              let date: Date | null = null;\n              \n              // Try arg.date.marker (most reliable)\n              if (arg?.date?.marker) {\n                date = new Date(arg.date.marker);\n              } else if (arg?.start?.marker) {\n                date = new Date(arg.start.marker);\n              } else if (arg?.date instanceof Date) {\n                date = arg.date;\n              } else if (arg?.start instanceof Date) {\n                date = arg.start;\n              } else if (typeof arg?.date === \"string\") {\n                date = new Date(arg.date);\n              } else if (typeof arg?.start === \"string\") {\n                date = new Date(arg.start);\n              } else if (arg?.marker) {\n                date = new Date(arg.marker);\n              }\n              \n              if (date && !isNaN(date.getTime())) {\n                // For month view column headers, show day name (Mon, Tue, Wed, etc.)\n                if (viewType === \"dayGridMonth\") {\n                  return format(date, \"EEE\");\n                }\n                // For week/day views, show weekday and date like \"Thu 25 Dec\"\n                if (viewType === \"timeGridWeek\" || viewType === \"timeGridDay\" || viewType === \"dayGridWeek\") {\n                  const weekday = format(date, \"EEE\");\n                  const day = date.getDate();\n                  const month = format(date, \"MMM\");\n                  return `${weekday} ${day} ${month}`;\n                }\n                // For list view, show full format like \"Thursday 25th December\"\n                if (viewType === \"listWeek\" || viewType === \"listDay\" || viewType === \"listMonth\") {\n                  const weekday = format(date, \"EEEE\");\n                  const day = date.getDate();\n                  const suffix = day === 1 || day === 21 || day === 31 ? \"st\" :\n                                day === 2 || day === 22 ? \"nd\" :\n                                day === 3 || day === 23 ? \"rd\" : \"th\";\n                  const month = format(date, \"MMMM\");\n                  return `${weekday} ${day}${suffix} ${month}`;\n                }\n                // Fallback for other views\n                const weekday = format(date, \"EEE\");\n                const day = date.getDate();\n                const month = format(date, \"MMM\");\n                return `${weekday} ${day} ${month}`;\n              }\n              \n              // Debug: log what we're getting\n              console.log(\"dayHeaderFormat - no valid date:\", { \n                arg, \n                dateObj: arg?.date, \n                startObj: arg?.start,\n                viewType, \n                currentView \n              });\n              \n              // Let FullCalendar use default\n              return undefined as any;\n            } catch (error) {\n              console.error(\"dayHeaderFormat error:\", error, arg);\n              // Silently fail and let FullCalendar use default\n              return undefined as any;\n            }\n          }}\n          slotLabelFormat={{\n            hour: \"2-digit\",\n            minute: \"2-digit\",\n            hour12: false,\n          }}\n          eventContent={(eventInfo) => {\n            const appointment = eventInfo.event.extendedProps.appointment as Appointment;\n            const view = eventInfo.view;\n            const isMonthView = view.type === 'dayGridMonth';\n            \n            // First, check if we have selected service IDs stored in custom_fields\n            // Declare once at the top to use in both month and week/day/list views\n            const selectedServiceIds = appointment?.custom_fields?.selected_service_ids;\n            \n            // Get typeColor from selected service - use selected_service_ids from custom_fields if available\n            // This ensures we use the exact service color set in Services Management\n            let typeColor = \"#a855f7\"; // Default purple\n            if (Array.isArray(selectedServiceIds) && selectedServiceIds.length > 0) {\n              // Use the first selected service's color\n              const firstServiceId = selectedServiceIds[0];\n              const selectedServiceType = appointmentTypes.find((t) => {\n                const serviceType = t as any;\n                // Compare as numbers to handle string/number mismatch\n                return serviceType.serviceId?.toString() === firstServiceId?.toString() ||\n                       serviceType.serviceId === firstServiceId ||\n                       serviceType.serviceId === Number(firstServiceId);\n              });\n              if (selectedServiceType?.color) {\n                typeColor = selectedServiceType.color;\n              } else {\n                console.warn(\"Service type not found for selected service ID:\", {\n                  appointmentId: appointment.id,\n                  selectedServiceIds,\n                  firstServiceId,\n                  availableServiceIds: appointmentTypes.map(t => ({ \n                    serviceId: (t as any).serviceId, \n                    label: t.label,\n                    color: t.color \n                  }))\n                });\n              }\n            } else {\n              // Fallback: Match by appointment_type to find the service\n              const appointmentType = appointmentTypes.find(\n                (type) => {\n                  // Services are stored with value=\"service_${id}\" and appointmentType=\"doctor_on_call\" etc.\n                  const serviceType = type as any;\n                  if (serviceType.appointmentType === appointment.appointment_type) {\n                    return true;\n                  }\n                  // Also check direct value match (for backwards compatibility)\n                  if (type.value === appointment.appointment_type) {\n                    return true;\n                  }\n                  return false;\n                }\n              );\n              \n              // Use color from service database (set in Services Management)\n              if (appointmentType?.color && appointmentType.color !== \"#6b7280\" && appointmentType.color !== \"\") {\n                typeColor = appointmentType.color;\n              }\n            }\n            \n            // For month view, show a more compact but readable format\n            if (isMonthView) {\n              // Use the original appointment start_time directly to avoid double timezone conversion\n              // The event's start date has been adjusted for FullCalendar display, but we want\n              // the actual appointment time as stored in the database\n              const startDate = appointment.start_time \n                ? (typeof appointment.start_time === 'string' \n                    ? new Date(appointment.start_time) \n                    : appointment.start_time instanceof Date\n                    ? appointment.start_time\n                    : new Date(appointment.start_time))\n                : null;\n              const timeStr = startDate ? formatCrmTime(startDate) : '';\n              \n              // Get patient name (first part of title, limit length for readability)\n              const titleParts = eventInfo.event.title.split(' - ');\n              let patientName = titleParts[0] || eventInfo.event.title;\n              // Truncate if too long\n              if (patientName.length > 20) {\n                patientName = patientName.substring(0, 17) + '...';\n              }\n              \n              return (\n                <div\n                  onContextMenu={(e) => {\n                    e.preventDefault();\n                    handleEventRightClick(e, appointment);\n                  }}\n                  className=\"px-0 py-1 w-full h-full\"\n                  style={{\n                    minHeight: '24px',\n                    display: 'flex',\n                    alignItems: 'stretch',\n                  }}\n                >\n                  {/* Left colored section for appointment type - wider and more visible */}\n                  <div\n                    style={{\n                      width: '8px',\n                      backgroundColor: typeColor,\n                      flexShrink: 0,\n                      borderRadius: '4px 0 0 4px',\n                      opacity: 1,\n                    }}\n                  />\n                  {/* Content section */}\n                  <div\n                    className=\"px-2 flex items-center gap-1.5 flex-1\"\n                    style={{\n                      color: '#ffffff',\n                      fontSize: '11px',\n                      fontWeight: '600',\n                      lineHeight: '1.3',\n                      textShadow: '0 1px 3px rgba(0,0,0,0.8), 0 0 2px rgba(0,0,0,0.5)',\n                      whiteSpace: 'nowrap',\n                      overflow: 'hidden',\n                    }}\n                  >\n                    {timeStr && <span className=\"font-bold flex-shrink-0\">{timeStr}</span>}\n                    <span className=\"truncate\">{patientName}</span>\n                  </div>\n                </div>\n              );\n            }\n            \n            // For week/day/list views, show full details with type color indicator\n            // Get typeColor from selected service - use selected_service_ids from custom_fields if available\n            let typeColorForView = \"#a855f7\"; // Default purple\n            \n            // Reuse selectedServiceIds already declared at the top of the function\n            if (Array.isArray(selectedServiceIds) && selectedServiceIds.length > 0) {\n              // Use the first selected service's color\n              const firstServiceId = selectedServiceIds[0];\n              const selectedServiceType = appointmentTypes.find((t) => {\n                const serviceType = t as any;\n                // Compare as numbers to handle string/number mismatch\n                return serviceType.serviceId?.toString() === firstServiceId?.toString() ||\n                       serviceType.serviceId === firstServiceId ||\n                       serviceType.serviceId === Number(firstServiceId);\n              });\n              if (selectedServiceType?.color) {\n                typeColorForView = selectedServiceType.color;\n              }\n            } else {\n              // Fallback: Use color from extendedProps or find by appointment_type\n              typeColorForView = eventInfo.event.extendedProps.typeColor;\n              if (!typeColorForView || typeColorForView === \"#6b7280\" || typeColorForView === \"\") {\n                const appointmentType = appointmentTypes.find(\n                  (type) => {\n                    if (type.value === appointment.appointment_type) return true;\n                    const serviceType = type as any;\n                    if (type.value?.startsWith(\"service_\") && serviceType.appointmentType === appointment.appointment_type) {\n                      return true;\n                    }\n                    return false;\n                  }\n                );\n                // Use color from service database field\n                typeColorForView = appointmentType?.color || \"#a855f7\";\n              }\n            }\n            \n            return (\n              <div\n                onContextMenu={(e) => {\n                  e.preventDefault();\n                  handleEventRightClick(e, appointment);\n                }}\n                className=\"px-0 py-1 w-full h-full\"\n                style={{\n                  display: 'flex',\n                  alignItems: 'stretch',\n                }}\n              >\n                {/* Left colored section for appointment type - wider and more visible */}\n                <div\n                  style={{\n                    width: '8px',\n                    backgroundColor: typeColorForView,\n                    flexShrink: 0,\n                    borderRadius: '4px 0 0 4px',\n                    opacity: 1,\n                  }}\n                />\n                {/* Content section */}\n                <div\n                  className=\"px-2 flex items-center flex-1\"\n                  style={{\n                    color: '#ffffff',\n                    fontSize: '11px',\n                    fontWeight: '600',\n                    textShadow: '0 1px 2px rgba(0,0,0,0.5)',\n                  }}\n                >\n                  {eventInfo.event.title}\n                </div>\n              </div>\n            );\n          }}\n          />\n        )}\n      </div>\n      </div>\n    </>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogTaskDeleted.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityTaskDeleted } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogTaskDeletedProps = {\n  activity: ActivityTaskDeleted;\n};\n\nexport function ActivityLogTaskDeleted({\n  activity,\n}: ActivityLogTaskDeletedProps) {\n  const context = useActivityLogContext();\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-red-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;deleted a task\n              {activity.task_type && activity.task_type !== \"None\" && (\n                <>&nbsp;({activity.task_type})</>\n              )}\n              {activity.contact_id && (\n                <>\n                  &nbsp;for&nbsp;\n                  <ReferenceField\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={activity}\n                  >\n                    <span>contact</span>\n                  </ReferenceField>\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n      {activity.task_text && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground line-through opacity-75\">\n          {activity.task_text.length > 100\n            ? `${activity.task_text.substring(0, 100)}...`\n            : activity.task_text}\n        </div>\n      )}\n    </div>\n  );\n}\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogTaskCreated.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport { TASK_COMPLETED } from \"../consts\";\nimport type { ActivityTaskCreated, ActivityTaskCompleted } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogTaskProps = {\n  activity: ActivityTaskCreated | ActivityTaskCompleted;\n};\n\nexport function ActivityLogTaskCreated({\n  activity,\n}: ActivityLogTaskProps) {\n  const context = useActivityLogContext();\n  const { task } = activity;\n  const isCompleted = activity.type === TASK_COMPLETED;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-purple-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;{isCompleted ? \"completed\" : \"created\"} task\n              {(() => {\n                const taskType = task.type?.trim();\n                // Only show type if it's a valid non-empty string and not \"none\" or \"null\"\n                if (taskType && \n                    taskType.toLowerCase() !== \"none\" && \n                    taskType.toLowerCase() !== \"null\" &&\n                    taskType !== \"\") {\n                  return ` (${taskType})`;\n                }\n                return \"\";\n              })()} for&nbsp;\n              <ReferenceField\n                source=\"contact_id\"\n                reference=\"contacts\"\n                record={task}\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n      {task.text && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground\">\n          {task.text}\n        </div>\n      )}\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogQuoteDeleted.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityQuoteDeleted } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogQuoteDeletedProps = {\n  activity: ActivityQuoteDeleted;\n};\n\nexport function ActivityLogQuoteDeleted({\n  activity,\n}: ActivityLogQuoteDeletedProps) {\n  const context = useActivityLogContext();\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-red-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;deleted a quote\n              {activity.contact_id && (\n                <>\n                  &nbsp;for&nbsp;\n                  <ReferenceField\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={activity}\n                  >\n                    <span>contact</span>\n                  </ReferenceField>\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n      {(activity.quote_description || activity.quote_amount) && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground line-through opacity-75\">\n          {activity.quote_description && (\n            <span>\n              {activity.quote_description.length > 100\n                ? `${activity.quote_description.substring(0, 100)}...`\n                : activity.quote_description}\n            </span>\n          )}\n          {activity.quote_amount && (\n            <span className=\"ml-2 font-semibold\">\n              {new Intl.NumberFormat(\"en-AE\", {\n                style: \"currency\",\n                currency: \"AED\",\n              }).format(Number(activity.quote_amount))}\n            </span>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogQuoteCreated.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport { QUOTE_UPDATED } from \"../consts\";\nimport type { ActivityQuoteCreated, ActivityQuoteUpdated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogQuoteProps = {\n  activity: ActivityQuoteCreated | ActivityQuoteUpdated;\n};\n\nexport function ActivityLogQuoteCreated({\n  activity,\n}: ActivityLogQuoteProps) {\n  const context = useActivityLogContext();\n  const { quote } = activity;\n  const isUpdated = activity.type === QUOTE_UPDATED;\n  \n  // Format currency properly\n  const formattedAmount = quote.amount\n    ? new Intl.NumberFormat(\"en-US\", {\n        style: \"currency\",\n        currency: \"AED\",\n        minimumFractionDigits: 2,\n      }).format(Number(quote.amount))\n    : null;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-green-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;{isUpdated ? \"updated a\" : \"created a\"}&nbsp;\n              {quote.service_id ? (\n                <>\n                  <ReferenceField\n                    source=\"service_id\"\n                    reference=\"services\"\n                    record={quote}\n                  >\n                    <TextField source=\"name\" />\n                  </ReferenceField>\n                  &nbsp;Quote\n                </>\n              ) : (\n                \"Quote\"\n              )}\n              &nbsp;for&nbsp;\n              <ReferenceField\n                source=\"contact_id\"\n                reference=\"contacts\"\n                record={quote}\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n              {formattedAmount && (\n                <>\n                  &nbsp;-&nbsp;{formattedAmount}\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} mode=\"local\" />\n        </span>\n      </div>\n      {quote.description && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground line-clamp-3 overflow-hidden\">\n          {quote.description}\n        </div>\n      )}\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogNoteDeleted.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityNoteDeleted } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogNoteDeletedProps = {\n  activity: ActivityNoteDeleted;\n};\n\nexport function ActivityLogNoteDeleted({\n  activity,\n}: ActivityLogNoteDeletedProps) {\n  const context = useActivityLogContext();\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-red-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;deleted a note\n              {activity.contact_id && (\n                <>\n                  &nbsp;for&nbsp;\n                  <ReferenceField\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={activity}\n                  >\n                    <span>contact</span>\n                  </ReferenceField>\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n      {activity.note_text && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground line-through opacity-75\">\n          {activity.note_text.length > 100\n            ? `${activity.note_text.substring(0, 100)}...`\n            : activity.note_text}\n        </div>\n      )}\n    </div>\n  );\n}\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogNote.tsx",
      "content": "import { Fragment, type ReactNode } from \"react\";\n\ntype ActivityLogContactNoteCreatedProps = {\n  header: ReactNode;\n  text: string;\n};\n\nexport function ActivityLogNote({\n  header,\n  text,\n}: ActivityLogContactNoteCreatedProps) {\n  if (!text) {\n    return null;\n  }\n  const paragraphs = text.split(\"\\n\");\n\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-col space-y-2 w-full\">\n        <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n          <div className=\"w-5 h-5 bg-blue-200 rounded-full flex-shrink-0\" />\n          <div className=\"flex flex-row items-center flex-grow min-w-0 justify-between\">\n            {header}\n          </div>\n        </div>\n        <div className=\"ml-6 mt-1\">\n          <div className=\"text-sm text-muted-foreground line-clamp-3 overflow-hidden\">\n            {paragraphs.map((paragraph: string, index: number) => (\n              <Fragment key={index}>\n                {paragraph}\n                {index < paragraphs.length - 1 && <br />}\n              </Fragment>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogIterator.tsx",
      "content": "import { Fragment, useState } from \"react\";\n\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  COMPANY_CREATED,\n  CONTACT_CREATED,\n  CONTACT_NOTE_CREATED,\n  DEAL_CREATED,\n  DEAL_NOTE_CREATED,\n  QUOTE_CREATED,\n  QUOTE_UPDATED,\n  TASK_CREATED,\n  TASK_COMPLETED,\n  DEAL_STATUS_CHANGED,\n  DEAL_ARCHIVED,\n  DEAL_UNARCHIVED,\n  NOTE_DELETED,\n  QUOTE_DELETED,\n  TASK_DELETED,\n  APPOINTMENT_CREATED,\n  APPOINTMENT_DELETED,\n} from \"../consts\";\nimport type { Activity } from \"../types\";\nimport { ActivityLogDealCreated } from \"./ActivityLogDealCreated\";\nimport { ActivityLogCompanyCreated } from \"./ActivityLogCompanyCreated\";\nimport { ActivityLogContactCreated } from \"./ActivityLogContactCreated\";\nimport { ActivityLogContactNoteCreated } from \"./ActivityLogContactNoteCreated\";\nimport { ActivityLogDealNoteCreated } from \"./ActivityLogDealNoteCreated\";\nimport { ActivityLogQuoteCreated } from \"./ActivityLogQuoteCreated\";\nimport { ActivityLogTaskCreated } from \"./ActivityLogTaskCreated\";\nimport { ActivityLogDealStatusChanged } from \"./ActivityLogDealStatusChanged\";\nimport { ActivityLogDealArchived } from \"./ActivityLogDealArchived\";\nimport { ActivityLogDealUnarchived } from \"./ActivityLogDealUnarchived\";\nimport { ActivityLogNoteDeleted } from \"./ActivityLogNoteDeleted\";\nimport { ActivityLogQuoteDeleted } from \"./ActivityLogQuoteDeleted\";\nimport { ActivityLogTaskDeleted } from \"./ActivityLogTaskDeleted\";\nimport { ActivityLogAppointmentCreated } from \"./ActivityLogAppointmentCreated\";\nimport { ActivityLogAppointmentDeleted } from \"./ActivityLogAppointmentDeleted\";\n\ntype ActivityLogIteratorProps = {\n  activities: Activity[];\n  pageSize: number;\n};\n\nexport function ActivityLogIterator({\n  activities,\n  pageSize,\n}: ActivityLogIteratorProps) {\n  const [activitiesDisplayed, setActivityDisplayed] = useState(pageSize);\n\n  return (\n    <div className=\"space-y-4\">\n      {activities.slice(0, activitiesDisplayed).map((activity) => (\n        <Fragment key={activity.id}>\n          <ActivityItem activity={activity} />\n          <Separator />\n        </Fragment>\n      ))}\n\n      {activitiesDisplayed < activities.length && (\n        <a\n          href=\"#\"\n          onClick={(e) => {\n            e.preventDefault();\n            setActivityDisplayed(\n              (activitiesDisplayed) => activitiesDisplayed + pageSize,\n            );\n          }}\n          className=\"flex w-full justify-center text-sm underline hover:no-underline\"\n        >\n          Load more activity\n        </a>\n      )}\n    </div>\n  );\n}\n\nfunction ActivityItem({ activity }: { activity: Activity }) {\n  if (activity.type === COMPANY_CREATED) {\n    return <ActivityLogCompanyCreated activity={activity} />;\n  }\n\n  if (activity.type === CONTACT_CREATED) {\n    return <ActivityLogContactCreated activity={activity} />;\n  }\n\n  if (activity.type === CONTACT_NOTE_CREATED) {\n    return <ActivityLogContactNoteCreated activity={activity} />;\n  }\n\n  if (activity.type === DEAL_NOTE_CREATED) {\n    return <ActivityLogDealNoteCreated activity={activity} />;\n  }\n\n  if (activity.type === DEAL_CREATED) {\n    return <ActivityLogDealCreated activity={activity} />;\n  }\n\n  if (activity.type === QUOTE_CREATED || activity.type === QUOTE_UPDATED) {\n    return <ActivityLogQuoteCreated activity={activity} />;\n  }\n\n  if (activity.type === TASK_CREATED || activity.type === TASK_COMPLETED) {\n    return <ActivityLogTaskCreated activity={activity} />;\n  }\n\n  if (activity.type === DEAL_STATUS_CHANGED) {\n    return <ActivityLogDealStatusChanged activity={activity} />;\n  }\n\n  if (activity.type === DEAL_ARCHIVED) {\n    return <ActivityLogDealArchived activity={activity} />;\n  }\n\n  if (activity.type === DEAL_UNARCHIVED) {\n    return <ActivityLogDealUnarchived activity={activity} />;\n  }\n\n  if (activity.type === NOTE_DELETED) {\n    return <ActivityLogNoteDeleted activity={activity} />;\n  }\n\n  if (activity.type === QUOTE_DELETED) {\n    return <ActivityLogQuoteDeleted activity={activity} />;\n  }\n\n  if (activity.type === TASK_DELETED) {\n    return <ActivityLogTaskDeleted activity={activity} />;\n  }\n\n  if (activity.type === APPOINTMENT_CREATED) {\n    return <ActivityLogAppointmentCreated activity={activity} />;\n  }\n\n  if (activity.type === APPOINTMENT_DELETED) {\n    return <ActivityLogAppointmentDeleted activity={activity} />;\n  }\n\n  return null;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealUnarchived.tsx",
      "content": "import { Link } from \"react-router\";\nimport type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityDealUnarchived } from \"../types\";\n\ntype ActivityLogDealUnarchivedProps = {\n  activity: RaRecord & ActivityDealUnarchived;\n};\n\nexport function ActivityLogDealUnarchived({\n  activity,\n}: ActivityLogDealUnarchivedProps) {\n  const { deal } = activity;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row gap-2 items-center w-full justify-between\">\n        <div className=\"flex flex-row gap-2 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-green-400 rounded-full flex-shrink-0\" />\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;unarchived&nbsp;\n            {deal.lead_id ? (\n              <ReferenceField\n                source=\"lead_id\"\n                reference=\"contacts\"\n                record={deal}\n                link=\"show\"\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            ) : (\n              <Link to={`/lead-journey/${deal.id}/show`}>\n                {deal.first_name || deal.last_name\n                  ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                  : deal.name || \"New Lead\"}\n              </Link>\n            )}\n          </span>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealStatusChanged.tsx",
      "content": "import { Link } from \"react-router\";\nimport type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { findDealLabel } from \"../deals/deal\";\nimport type { ActivityDealStatusChanged } from \"../types\";\n\ntype ActivityLogDealStatusChangedProps = {\n  activity: RaRecord & ActivityDealStatusChanged;\n};\n\nexport function ActivityLogDealStatusChanged({\n  activity,\n}: ActivityLogDealStatusChangedProps) {\n  const { leadStages } = useConfigurationContext();\n  const { deal } = activity;\n  \n  // Use new_stage from activity if available, otherwise fall back to deal.stage\n  const newStage = activity.new_stage ?? deal.stage;\n  const oldStage = activity.old_stage;\n  \n  const newStageLabel = findDealLabel(leadStages, newStage) || newStage;\n  const oldStageLabel = oldStage ? (findDealLabel(leadStages, oldStage) || oldStage) : null;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row gap-2 items-center w-full justify-between\">\n        <div className=\"flex flex-row gap-2 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-amber-200 rounded-full flex-shrink-0\" />\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;moved&nbsp;\n            {deal.lead_id ? (\n              <ReferenceField\n                source=\"lead_id\"\n                reference=\"contacts\"\n                record={deal}\n                link=\"show\"\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            ) : (\n              <Link to={`/lead-journey/${deal.id}/show`}>\n                {deal.first_name || deal.last_name\n                  ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                  : deal.name || \"New Lead\"}\n              </Link>\n            )}\n            {oldStageLabel ? (\n              <>\n                &nbsp;from&nbsp;\n                <span className=\"font-medium\">{oldStageLabel}</span>\n                &nbsp;to&nbsp;\n              </>\n            ) : (\n              <> &nbsp;to&nbsp; </>\n            )}\n            <span className=\"font-medium\">{newStageLabel}</span>\n          </span>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealNoteCreated.tsx",
      "content": "import type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityDealNoteCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogNote } from \"./ActivityLogNote\";\n\ntype ActivityLogDealNoteCreatedProps = {\n  activity: RaRecord & ActivityDealNoteCreated;\n};\n\nexport function ActivityLogDealNoteCreated({\n  activity,\n}: ActivityLogDealNoteCreatedProps) {\n  const context = useActivityLogContext();\n  const { dealNote } = activity;\n  return (\n    <ActivityLogNote\n      header={\n        <>\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n                link={false}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;added a note about lead&nbsp;\n              <ReferenceField\n                source=\"deal_id\"\n                reference=\"lead-journey\"\n                record={dealNote}\n                link=\"show\"\n              />\n              {context !== \"company\" && (\n                <>\n                  {\" at \"}\n                  <ReferenceField\n                    source=\"deal_id\"\n                    reference=\"deals\"\n                    record={dealNote}\n                    link={false}\n                  >\n                    <ReferenceField\n                      source=\"company_id\"\n                      reference=\"companies\"\n                      link=\"show\"\n                    />\n                  </ReferenceField>{\" \"}\n                </>\n              )}\n            </span>\n          </div>\n          <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n            <RelativeDate date={activity.date} />\n          </span>\n        </>\n      }\n      text={dealNote.text}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealCreated.tsx",
      "content": "import { Link } from \"react-router\";\nimport type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityDealCreated } from \"../types\";\n\ntype ActivityLogDealCreatedProps = {\n  activity: RaRecord & ActivityDealCreated;\n};\n\nexport function ActivityLogDealCreated({\n  activity,\n}: ActivityLogDealCreatedProps) {\n  const { deal } = activity;\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full\">\n        <div className=\"w-5 h-5 bg-orange-200 rounded-full\" />\n        <div className=\"text-sm text-muted-foreground flex-grow\">\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;added lead&nbsp;\n            <Link to={`/lead-journey/${deal.id}/show`}>\n              {deal.first_name || deal.last_name\n                ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                : deal.name || \"New Lead\"}\n            </Link>\n            {deal.lead_id && (\n              <>\n                &nbsp;for&nbsp;\n                <ReferenceField\n                  source=\"lead_id\"\n                  reference=\"contacts\"\n                  record={deal}\n                  link=\"show\"\n                >\n                  <TextField source=\"first_name\" />\n                  &nbsp;\n                  <TextField source=\"last_name\" />\n                </ReferenceField>\n              </>\n            )}\n            &nbsp;\n            <span className=\"text-xs\">\n              <RelativeDate date={activity.date} />\n            </span>\n          </span>\n        </div>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealArchived.tsx",
      "content": "import { Link } from \"react-router\";\nimport type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityDealArchived } from \"../types\";\n\ntype ActivityLogDealArchivedProps = {\n  activity: RaRecord & ActivityDealArchived;\n};\n\nexport function ActivityLogDealArchived({\n  activity,\n}: ActivityLogDealArchivedProps) {\n  const { deal } = activity;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row gap-2 items-center w-full justify-between\">\n        <div className=\"flex flex-row gap-2 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-gray-400 rounded-full flex-shrink-0\" />\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;archived&nbsp;\n            {deal.lead_id ? (\n              <ReferenceField\n                source=\"lead_id\"\n                reference=\"contacts\"\n                record={deal}\n                link=\"show\"\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            ) : (\n              <Link to={`/lead-journey/${deal.id}/show`}>\n                {deal.first_name || deal.last_name\n                  ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                  : deal.name || \"New Lead\"}\n              </Link>\n            )}\n          </span>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogContext.tsx",
      "content": "import { createContext, useContext } from \"react\";\n\nexport type activityLogContextValue = \"company\" | \"contact\" | \"deal\" | \"all\";\n\nexport const ActivityLogContext = createContext<activityLogContextValue>(\"all\");\n\nexport const useActivityLogContext = () => {\n  const context = useContext(ActivityLogContext);\n\n  return context;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogContactNoteCreated.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityContactNoteCreated, Contact } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogNote } from \"./ActivityLogNote\";\n\ntype ActivityLogContactNoteCreatedProps = {\n  activity: ActivityContactNoteCreated;\n};\n\nexport function ActivityLogContactNoteCreated({\n  activity,\n}: ActivityLogContactNoteCreatedProps) {\n  const context = useActivityLogContext();\n  const { contactNote } = activity;\n  return (\n    <ActivityLogNote\n      header={\n        <>\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              <ReferenceField\n                source=\"contact_id\"\n                reference=\"contacts\"\n                record={activity.contactNote}\n              >\n            &nbsp;added a note about{\" \"}\n            <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            </span>\n          </div>\n          <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n            <RelativeDate date={activity.date} />\n          </span>\n        </>\n      }\n      text={contactNote.text}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogContactCreated.tsx",
      "content": "import { Link } from \"react-router\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityContactCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogContactCreatedProps = {\n  activity: ActivityContactCreated;\n};\n\nexport function ActivityLogContactCreated({\n  activity,\n}: ActivityLogContactCreatedProps) {\n  const context = useActivityLogContext();\n  const { contact } = activity;\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row gap-2 items-center w-full justify-between\">\n        <div className=\"flex flex-row gap-2 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-teal-200 rounded-full flex-shrink-0\" />\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField source=\"sales_id\" reference=\"sales\" record={activity}>\n              <SaleName />\n            </ReferenceField>\n            &nbsp;added&nbsp;\n            <Link to={`/contacts/${contact.id}/show`}>\n              {`${contact.first_name ?? \"\"} ${contact.last_name ?? \"\"}`.trim() || \"New Lead\"}\n            </Link>\n          </span>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogCompanyCreated.tsx",
      "content": "import { Link } from \"react-router\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityCompanyCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogCompanyCreatedProps = {\n  activity: ActivityCompanyCreated;\n};\n\nexport function ActivityLogCompanyCreated({\n  activity,\n}: ActivityLogCompanyCreatedProps) {\n  const context = useActivityLogContext();\n  const { company } = activity;\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-indigo-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n            </span>\n            &nbsp;added company &nbsp;\n            <Link to={`/companies/${company.id}/show`}>{company.name}</Link>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogAppointmentDeleted.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityAppointmentDeleted } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\nimport { formatCrmDate } from \"../misc/timezone\";\n\ntype ActivityLogAppointmentDeletedProps = {\n  activity: ActivityAppointmentDeleted;\n};\n\nexport function ActivityLogAppointmentDeleted({\n  activity,\n}: ActivityLogAppointmentDeletedProps) {\n  const context = useActivityLogContext();\n  \n  const appointmentTypeLabels: Record<string, string> = {\n    doctor_on_call: \"Doctor on Call\",\n    lab_test: \"Lab Test\",\n    teleconsultation: \"Teleconsultation\",\n    physiotherapy: \"Physiotherapy\",\n    caregiver: \"Caregiver\",\n    iv_therapy: \"IV Therapy\",\n  };\n  \n  const appointmentTypeLabel = activity.appointment_type\n    ? appointmentTypeLabels[activity.appointment_type] || activity.appointment_type\n    : \"appointment\";\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-red-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;deleted {appointmentTypeLabel}\n              {activity.contact_id && (\n                <>\n                  &nbsp;for&nbsp;\n                  <ReferenceField\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={activity}\n                  >\n                    <span>contact</span>\n                  </ReferenceField>\n                </>\n              )}\n              {activity.appointment_date && (\n                <>\n                  &nbsp;scheduled for&nbsp;\n                  {formatCrmDate(activity.appointment_date)}\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogAppointmentCreated.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityAppointmentCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\nimport { formatCrmDate, formatCrmTime } from \"../misc/timezone\";\n\ntype ActivityLogAppointmentCreatedProps = {\n  activity: ActivityAppointmentCreated;\n};\n\nexport function ActivityLogAppointmentCreated({\n  activity,\n}: ActivityLogAppointmentCreatedProps) {\n  const context = useActivityLogContext();\n  const { appointment } = activity;\n  \n  const appointmentTypeLabels: Record<string, string> = {\n    doctor_on_call: \"Doctor on Call\",\n    lab_test: \"Lab Test\",\n    teleconsultation: \"Teleconsultation\",\n    physiotherapy: \"Physiotherapy\",\n    caregiver: \"Caregiver\",\n    iv_therapy: \"IV Therapy\",\n  };\n  \n  const appointmentTypeLabel = appointment?.appointment_type\n    ? appointmentTypeLabels[appointment.appointment_type] || appointment.appointment_type\n    : activity.appointment_type || \"Appointment\";\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-blue-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;created {appointmentTypeLabel.toLowerCase()} appointment\n              {activity.contact_id && (\n                <>\n                  &nbsp;for&nbsp;\n                  <ReferenceField\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={activity}\n                  >\n                    <TextField source=\"first_name\" />\n                    &nbsp;\n                    <TextField source=\"last_name\" />\n                  </ReferenceField>\n                </>\n              )}\n              {appointment?.start_time && (\n                <>\n                  &nbsp;on&nbsp;\n                  {formatCrmDate(appointment.start_time)}&nbsp;at&nbsp;\n                  {formatCrmTime(appointment.start_time)}\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n      {appointment?.mini_notes && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground\">\n          {appointment.mini_notes}\n        </div>\n      )}\n    </div>\n  );\n}\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLog.tsx",
      "content": "import { Alert } from \"@/components/ui/alert\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { type Identifier, useDataProvider } from \"ra-core\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport { ActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogIterator } from \"./ActivityLogIterator\";\n\ntype ActivityLogProps = {\n  companyId?: Identifier;\n  contactId?: Identifier;\n  pageSize?: number;\n  context?: \"company\" | \"contact\" | \"deal\" | \"all\";\n};\n\nexport function ActivityLog({\n  companyId,\n  contactId,\n  pageSize = 20,\n  context = \"all\",\n}: ActivityLogProps) {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const { data, isPending, error } = useQuery({\n    queryKey: [\"activityLog\", companyId, contactId],\n    queryFn: () => dataProvider.getActivityLog(companyId, contactId),\n  });\n\n  if (isPending) {\n    return (\n      <div className=\"mt-1\">\n        {Array.from({ length: 5 }).map((_, index) => (\n          <div className=\"space-y-2 mt-1\" key={index}>\n            <div className=\"flex flex-row space-x-2 items-center\">\n              <Skeleton className=\"w-5 h-5 rounded-full\" />\n              <Skeleton className=\"w-full h-4\" />\n            </div>\n            <Skeleton className=\"w-full h-12\" />\n            <Separator />\n          </div>\n        ))}\n      </div>\n    );\n  }\n\n  if (error) {\n    return <Alert>Failed to load activity log</Alert>;\n  }\n\n  return (\n    <ActivityLogContext.Provider value={context}>\n      <ActivityLogIterator activities={data} pageSize={pageSize} />\n    </ActivityLogContext.Provider>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/set-password-page.tsx",
      "content": "import { useState } from \"react\";\nimport type { ValidateForm } from \"ra-core\";\nimport { Form, required, useNotify, useTranslate } from \"ra-core\";\nimport { useSetPassword, useSupabaseAccessToken } from \"ra-supabase-core\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { Button } from \"@/components/ui/button\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Layout } from \"@/components/supabase/layout\";\n\ninterface FormData {\n  password: string;\n  confirmPassword: string;\n}\n\nexport const SetPasswordPage = () => {\n  const [loading, setLoading] = useState(false);\n\n  const access_token = useSupabaseAccessToken();\n  const refresh_token = useSupabaseAccessToken({\n    parameterName: \"refresh_token\",\n  });\n\n  const notify = useNotify();\n  const translate = useTranslate();\n  const [, { mutateAsync: setPassword }] = useSetPassword();\n\n  const validate = (values: FormData) => {\n    if (values.password !== values.confirmPassword) {\n      return {\n        password: \"ra-supabase.validation.password_mismatch\",\n        confirmPassword: \"ra-supabase.validation.password_mismatch\",\n      };\n    }\n    return {};\n  };\n\n  if (!access_token || !refresh_token) {\n    if (process.env.NODE_ENV === \"development\") {\n      console.error(\"Missing access_token or refresh_token for set password\");\n    }\n    return (\n      <Layout>\n        <p>{translate(\"ra-supabase.auth.missing_tokens\")}</p>\n      </Layout>\n    );\n  }\n\n  const submit = async (values: FormData) => {\n    try {\n      setLoading(true);\n      await setPassword({\n        access_token,\n        refresh_token,\n        password: values.password,\n      });\n    } catch (error: any) {\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"ra.auth.sign_in_error\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <Layout>\n      <div className=\"flex flex-col space-y-2 text-center\">\n        <h1 className=\"text-2xl font-semibold tracking-tight\">\n          {translate(\"ra-supabase.set_password.new_password\", {\n            _: \"Choose your password\",\n          })}\n        </h1>\n      </div>\n      <Form<FormData>\n        className=\"space-y-8\"\n        onSubmit={submit as SubmitHandler<FieldValues>}\n        validate={validate as ValidateForm}\n      >\n        <TextInput\n          label={translate(\"ra.auth.password\", {\n            _: \"Password\",\n          })}\n          autoComplete=\"new-password\"\n          source=\"password\"\n          type=\"password\"\n          validate={required()}\n        />\n        <TextInput\n          label={translate(\"ra.auth.confirm_password\", {\n            _: \"Confirm password\",\n          })}\n          source=\"confirmPassword\"\n          type=\"password\"\n          validate={required()}\n        />\n        <Button type=\"submit\" className=\"cursor-pointer\" disabled={loading}>\n          {translate(\"ra.action.save\")}\n        </Button>\n      </Form>\n    </Layout>\n  );\n};\n\nSetPasswordPage.path = \"set-password\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/layout.tsx",
      "content": "import * as React from \"react\";\nimport { Notification } from \"@/components/admin/notification\";\nimport { useConfigurationContext } from \"@/components/atomic-crm/root/ConfigurationContext\";\n\nexport const Layout = ({ children }: React.PropsWithChildren) => {\n  const { darkModeLogo, title } = useConfigurationContext();\n\n  return (\n    <div className=\"min-h-screen flex\">\n      <div className=\"container relative grid flex-col items-center justify-center sm:max-w-none lg:grid-cols-2 lg:px-0\">\n        <div className=\"relative hidden h-full flex-col bg-muted p-10 text-white dark:border-r lg:flex\">\n          <div className=\"absolute inset-0 bg-zinc-900\" />\n          <div className=\"relative z-20 flex items-center text-lg font-medium\">\n            <img className=\"h-6 mr-2\" src={darkModeLogo} alt={title} />\n            {title}\n          </div>\n        </div>\n        <div className=\"lg:p-8\">\n          <div className=\"mx-auto flex w-full flex-col justify-center space-y-6 sm:w-[350px]\">\n            {children}\n          </div>\n        </div>\n      </div>\n      <Notification />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/forgot-password-page.tsx",
      "content": "import { useState } from \"react\";\nimport { useResetPassword } from \"ra-supabase-core\";\nimport { Form, required, useNotify, useTranslate } from \"ra-core\";\nimport { Layout } from \"@/components/supabase/layout\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface FormData {\n  email: string;\n}\n\nexport const ForgotPasswordPage = () => {\n  const [loading, setLoading] = useState(false);\n\n  const notify = useNotify();\n  const translate = useTranslate();\n  const [, { mutateAsync: resetPassword }] = useResetPassword();\n\n  const submit = async (values: FormData) => {\n    try {\n      setLoading(true);\n      await resetPassword({\n        email: values.email,\n      });\n    } catch (error: any) {\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"ra.auth.sign_in_error\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <Layout>\n      <div className=\"flex flex-col space-y-2 text-center\">\n        <h1 className=\"text-2xl font-semibold tracking-tight\">\n          {translate(\"ra-supabase.reset_password.forgot_password\", {\n            _: \"Forgot password?\",\n          })}\n        </h1>\n        <p>\n          {translate(\"ra-supabase.reset_password.forgot_password_details\", {\n            _: \"Enter your email to receive a reset password link.\",\n          })}\n        </p>\n      </div>\n      <Form<FormData>\n        className=\"space-y-8\"\n        onSubmit={submit as SubmitHandler<FieldValues>}\n      >\n        <TextInput\n          source=\"email\"\n          label={translate(\"ra.auth.email\", {\n            _: \"Email\",\n          })}\n          autoComplete=\"email\"\n          validate={required()}\n        />\n        <Button type=\"submit\" className=\"cursor-pointer\" disabled={loading}>\n          {translate(\"ra.action.reset_password\", {\n            _: \"Reset password\",\n          })}\n        </Button>\n      </Form>\n    </Layout>\n  );\n};\n\nForgotPasswordPage.path = \"forgot-password\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/hooks/user-menu-context.tsx",
      "content": "import { createContext, useContext } from \"react\";\n\n/**\n * @deprecated Use UserMenuContextValue from `ra-core` once available.\n */\nexport type UserMenuContextValue = {\n  /**\n   * Closes the user menu\n   * @see UserMenu\n   */\n  onClose: () => void;\n};\n\n/**\n * @deprecated Use UserMenuContext from `ra-core` once available.\n */\nexport const UserMenuContext = createContext<UserMenuContextValue | undefined>(\n  undefined,\n);\n\n/**\n * @deprecated Use useUserMenu from `ra-core` once available.\n */\nexport const useUserMenu = () => useContext(UserMenuContext);\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/useTimezone.ts",
      "content": "import { useState, useEffect, useCallback } from \"react\";\n\nconst TIMEZONE_STORAGE_KEY = \"crm_timezone\";\nconst DEFAULT_TIMEZONE = \"Asia/Dubai\"; // GMT+4\n\n/**\n * Gets the timezone offset label (e.g., \"UTC+4\", \"UTC-5\")\n */\nfunction getTimezoneOffsetLabel(timezone: string): string {\n  try {\n    const now = new Date();\n    const formatter = new Intl.DateTimeFormat(\"en\", {\n      timeZone: timezone,\n      timeZoneName: \"shortOffset\",\n    });\n    const parts = formatter.formatToParts(now);\n    const offsetPart = parts.find((part) => part.type === \"timeZoneName\");\n    \n    if (offsetPart) {\n      // Format: \"GMT+4\" -> \"UTC+4\", \"GMT-5\" -> \"UTC-5\", etc.\n      return offsetPart.value.replace(/GMT/g, \"UTC\");\n    }\n    \n    // Fallback: calculate offset using a more reliable method\n    const utcTime = now.getTime();\n    const utcDate = new Date(utcTime);\n    \n    // Get the time in the target timezone as if it were UTC\n    const tzFormatter = new Intl.DateTimeFormat(\"en\", {\n      timeZone: timezone,\n      year: \"numeric\",\n      month: \"2-digit\",\n      day: \"2-digit\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n      second: \"2-digit\",\n      hour12: false,\n    });\n    \n    const tzParts = tzFormatter.formatToParts(utcDate);\n    const tzYear = parseInt(tzParts.find(p => p.type === \"year\")?.value || \"0\", 10);\n    const tzMonth = parseInt(tzParts.find(p => p.type === \"month\")?.value || \"0\", 10) - 1;\n    const tzDay = parseInt(tzParts.find(p => p.type === \"day\")?.value || \"0\", 10);\n    const tzHour = parseInt(tzParts.find(p => p.type === \"hour\")?.value || \"0\", 10);\n    const tzMinute = parseInt(tzParts.find(p => p.type === \"minute\")?.value || \"0\", 10);\n    const tzSecond = parseInt(tzParts.find(p => p.type === \"second\")?.value || \"0\", 10);\n    \n    // Create a date object representing the timezone time as if it were UTC\n    const tzAsUtc = new Date(Date.UTC(tzYear, tzMonth, tzDay, tzHour, tzMinute, tzSecond));\n    \n    // Calculate offset\n    const offsetMs = utcTime - tzAsUtc.getTime();\n    const offsetMinutes = Math.round(offsetMs / (1000 * 60));\n    const offsetHours = Math.floor(Math.abs(offsetMinutes) / 60);\n    const offsetMins = Math.abs(offsetMinutes) % 60;\n    const sign = offsetMinutes >= 0 ? \"+\" : \"-\";\n    \n    if (offsetMins === 0) {\n      return `UTC${sign}${offsetHours}`;\n    }\n    return `UTC${sign}${offsetHours}:${String(offsetMins).padStart(2, \"0\")}`;\n  } catch (error) {\n    console.warn(\"Error calculating timezone offset:\", error);\n    return \"UTC+4\"; // Default fallback\n  }\n}\n\n/**\n * Gets a human-readable timezone name\n */\nfunction getTimezoneDisplayName(timezone: string): string {\n  try {\n    const now = new Date();\n    const formatter = new Intl.DateTimeFormat(\"en\", {\n      timeZone: timezone,\n      timeZoneName: \"long\",\n    });\n    const parts = formatter.formatToParts(now);\n    const tzName = parts.find((part) => part.type === \"timeZoneName\");\n    return tzName?.value || timezone;\n  } catch (error) {\n    return timezone;\n  }\n}\n\n/**\n * Hook for managing CRM timezone configuration\n * \n * @returns Object with timezone, setTimezone function, offset label, and display name\n * \n * @example\n * ```tsx\n * const { timezone, setTimezone, offsetLabel, displayName } = useTimezone();\n * \n * // Change timezone\n * setTimezone(\"America/New_York\");\n * ```\n */\nexport function useTimezone() {\n  const [timezone, setTimezoneState] = useState<string>(() => {\n    if (typeof window === \"undefined\") {\n      return DEFAULT_TIMEZONE;\n    }\n    const stored = localStorage.getItem(TIMEZONE_STORAGE_KEY);\n    return stored || DEFAULT_TIMEZONE;\n  });\n\n  // Update localStorage when timezone changes\n  useEffect(() => {\n    if (typeof window !== \"undefined\") {\n      localStorage.setItem(TIMEZONE_STORAGE_KEY, timezone);\n    }\n  }, [timezone]);\n\n  const setTimezone = useCallback((newTimezone: string) => {\n    setTimezoneState(newTimezone);\n    // Trigger a custom event so other parts of the app can react\n    if (typeof window !== \"undefined\") {\n      window.dispatchEvent(new CustomEvent(\"timezone-changed\", { detail: { timezone: newTimezone } }));\n    }\n  }, []);\n\n  const offsetLabel = getTimezoneOffsetLabel(timezone);\n  const displayName = getTimezoneDisplayName(timezone);\n\n  return {\n    timezone,\n    setTimezone,\n    offsetLabel,\n    displayName,\n  };\n}\n\n/**\n * Gets the current CRM timezone (for use outside React components)\n * \n * @returns The current timezone string\n */\nexport function getCrmTimeZone(): string {\n  if (typeof window === \"undefined\") {\n    return DEFAULT_TIMEZONE;\n  }\n  try {\n    const stored = localStorage.getItem(TIMEZONE_STORAGE_KEY);\n    const result = stored || DEFAULT_TIMEZONE;\n    return result;\n  } catch (error) {\n    return DEFAULT_TIMEZONE;\n  }\n}\n\n/**\n * Gets the timezone offset in minutes from UTC.\n * \n * IMPORTANT: This function returns a POSITIVE value for timezones AHEAD of UTC.\n * Examples:\n * - UTC+4 (Asia/Dubai) returns +240 minutes\n * - UTC-5 (EST) returns -300 minutes\n * \n * The sign is critical for buildUtcFromZoned() which SUBTRACTS this offset.\n * DO NOT change the calculation formula without understanding the impact on all\n * timezone conversion functions.\n * \n * @returns Offset in minutes (positive = ahead of UTC, negative = behind UTC)\n */\nexport function getCrmTimeZoneOffsetMinutes(): number {\n  const timezone = getCrmTimeZone();\n  try {\n    const now = new Date();\n    const utcTime = now.getTime();\n    \n    // Get the time components in the target timezone\n    const tzFormatter = new Intl.DateTimeFormat(\"en\", {\n      timeZone: timezone,\n      year: \"numeric\",\n      month: \"2-digit\",\n      day: \"2-digit\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n      second: \"2-digit\",\n      hour12: false,\n    });\n    \n    const tzParts = tzFormatter.formatToParts(now);\n    const tzYear = parseInt(tzParts.find(p => p.type === \"year\")?.value || \"0\", 10);\n    const tzMonth = parseInt(tzParts.find(p => p.type === \"month\")?.value || \"0\", 10) - 1;\n    const tzDay = parseInt(tzParts.find(p => p.type === \"day\")?.value || \"0\", 10);\n    const tzHour = parseInt(tzParts.find(p => p.type === \"hour\")?.value || \"0\", 10);\n    const tzMinute = parseInt(tzParts.find(p => p.type === \"minute\")?.value || \"0\", 10);\n    const tzSecond = parseInt(tzParts.find(p => p.type === \"second\")?.value || \"0\", 10);\n    \n    // Create a date object representing the timezone time as if it were UTC\n    const tzAsUtc = new Date(Date.UTC(tzYear, tzMonth, tzDay, tzHour, tzMinute, tzSecond));\n    \n    // CRITICAL: Calculate offset correctly\n    // Formula: tzAsUtc.getTime() - utcTime\n    // \n    // Example for UTC+4 (Asia/Dubai):\n    // - When UTC is 12:00, CRM timezone shows 16:00\n    // - tzAsUtc = Date representing 16:00 as if it were UTC\n    // - utcTime = actual UTC time (12:00)\n    // - offsetMs = 16:00 - 12:00 = +4 hours = +240 minutes \n    // \n    // This positive value is then SUBTRACTED in buildUtcFromZoned() to convert\n    // CRM timezone time to UTC. DO NOT change this formula!\n    const offsetMs = tzAsUtc.getTime() - utcTime;\n    const offsetMinutes = Math.round(offsetMs / (1000 * 60));\n    \n    // Validation: offset should be reasonable (between -12 and +14 hours)\n    if (Math.abs(offsetMinutes) > 14 * 60) {\n      console.warn(`Unusual timezone offset calculated: ${offsetMinutes} minutes. Using default UTC+4.`);\n      return 4 * 60; // Fallback to UTC+4\n    }\n    return offsetMinutes;\n  } catch (error) {\n    console.warn(\"Error calculating timezone offset:\", error);\n    return 4 * 60; // Default to UTC+4\n  }\n}\n\n/**\n * Gets the timezone offset label (e.g., \"UTC+4\")\n */\nexport function getCrmTimeZoneOffsetLabel(): string {\n  return getTimezoneOffsetLabel(getCrmTimeZone());\n}\n\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/usePaymentSettings.tsx",
      "content": "import { useGetList, useUpdate, useNotify } from \"ra-core\";\nimport { useCallback } from \"react\";\n\nexport interface PaymentSetting {\n  id: number;\n  payment_method: \"POS\" | \"Tabby\" | \"Payment Link\" | \"Ziina\" | \"Cash\";\n  fee_percentage: number | null;\n  fixed_fee_amount: number | null;\n  vat_percentage: number;\n  is_active: boolean;\n}\n\nexport interface UpdatePaymentSettingsParams {\n  fee_percentage?: number | null;\n  fixed_fee_amount?: number | null;\n  vat_percentage?: number;\n  is_active?: boolean;\n}\n\n/**\n * Hook for managing payment settings (bank charge defaults)\n * \n * @returns Object with payment settings data, loading state, and update function\n * \n * @example\n * ```tsx\n * const { data, isLoading, updateSettings } = usePaymentSettings();\n * \n * // Update a payment setting\n * await updateSettings('POS', {\n *   fee_percentage: 1.9,\n *   fixed_fee_amount: null,\n *   vat_percentage: 5\n * });\n * ```\n */\nexport function usePaymentSettings() {\n  const notify = useNotify();\n  const { data, isLoading, refetch } = useGetList<PaymentSetting>(\n    \"payment_settings\",\n    {\n      pagination: { page: 1, perPage: 100 },\n      sort: { field: \"payment_method\", order: \"ASC\" },\n    }\n  );\n\n  const [update] = useUpdate<PaymentSetting>();\n\n  const updateSettings = useCallback(\n    async (\n      paymentMethod: PaymentSetting[\"payment_method\"],\n      updates: UpdatePaymentSettingsParams\n    ): Promise<void> => {\n      const setting = data?.find((s) => s.payment_method === paymentMethod);\n      if (!setting) {\n        throw new Error(`Payment setting for ${paymentMethod} not found`);\n      }\n\n      try {\n        await update(\n          \"payment_settings\",\n          {\n            id: setting.id,\n            data: updates,\n            previousData: setting,\n          },\n          {\n            mutationMode: \"pessimistic\",\n          }\n        );\n        await refetch();\n      } catch (error) {\n        throw error;\n      }\n    },\n    [data, update, refetch]\n  );\n\n  const updateAllSettings = useCallback(\n    async (\n      updates: Record<PaymentSetting[\"payment_method\"], UpdatePaymentSettingsParams>\n    ): Promise<void> => {\n      if (!data) {\n        throw new Error(\"Payment settings not loaded\");\n      }\n\n      try {\n        const updatePromises = Object.entries(updates).map(async ([method, updateData]) => {\n          const setting = data.find((s) => s.payment_method === method as PaymentSetting[\"payment_method\"]);\n          if (!setting) return;\n\n          await update(\n            \"payment_settings\",\n            {\n              id: setting.id,\n              data: updateData,\n              previousData: setting,\n            },\n            {\n              mutationMode: \"pessimistic\",\n            }\n          );\n        });\n\n        await Promise.all(updatePromises);\n        await refetch();\n        notify(\"Payment settings updated successfully\", { type: \"success\" });\n      } catch (error) {\n        notify(\"Failed to update payment settings\", { type: \"error\" });\n        throw error;\n      }\n    },\n    [data, update, refetch, notify]\n  );\n\n  return {\n    data,\n    isLoading,\n    updateSettings,\n    updateAllSettings,\n    refetch,\n  };\n}\n\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/usePackageUsage.tsx",
      "content": "import { useQuery } from \"@tanstack/react-query\";\nimport { useDataProvider } from \"ra-core\";\nimport type { Identifier } from \"ra-core\";\n\ntype PackageUsageResult = {\n  sessionsUsed: number;\n  hoursUsed: number;\n};\n\nexport const usePackageUsage = (packageId: Identifier | undefined) => {\n  const dataProvider = useDataProvider();\n\n  const { data, isLoading, error, refetch } = useQuery<PackageUsageResult>({\n    queryKey: [\"packageUsage\", packageId],\n    queryFn: async () => {\n      if (!packageId) {\n        return { sessionsUsed: 0, hoursUsed: 0 };\n      }\n      return await (dataProvider as any).calculatePackageUsage(packageId);\n    },\n    enabled: !!packageId,\n    staleTime: 30000, // Cache for 30 seconds\n  });\n\n  return {\n    sessionsUsed: data?.sessionsUsed ?? 0,\n    hoursUsed: data?.hoursUsed ?? 0,\n    isLoading,\n    error,\n    refetch,\n  };\n};\n\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/useOfficeLocation.ts",
      "content": "import { useGetList, useUpdate, useNotify, useGetOne } from \"ra-core\";\nimport { useCallback, useMemo, useEffect } from \"react\";\n\nexport interface OfficeLocation {\n  latitude: number;\n  longitude: number;\n  address: string;\n}\n\nexport interface GeneralSetting {\n  id: number;\n  setting_key: string;\n  setting_value: any;\n  description?: string;\n}\n\nconst DEFAULT_OFFICE_LOCATION: OfficeLocation = {\n  latitude: 25.2048,\n  longitude: 55.2708,\n  address: \"Office, Dubai, UAE\",\n};\n\n/**\n * Hook for managing office location configuration from database\n * \n * @returns Object with office location, loading state, and update function\n * \n * @example\n * ```tsx\n * const { officeLocation, isLoading, updateOfficeLocation } = useOfficeLocation();\n * \n * // Update office location\n * await updateOfficeLocation({\n *   latitude: 25.2048,\n *   longitude: 55.2708,\n *   address: \"My Office, Dubai\"\n * });\n * ```\n */\nexport function useOfficeLocation() {\n  const notify = useNotify();\n  \n  // Fetch office location setting from database\n  const { data: settings, isLoading, refetch } = useGetList<GeneralSetting>(\n    \"general_settings\",\n    {\n      pagination: { page: 1, perPage: 100 },\n      filter: { setting_key: \"office_location\" },\n    }\n  );\n\n  const [update] = useUpdate<GeneralSetting>();\n\n  // Extract office location from settings\n  const officeLocation = useMemo<OfficeLocation>(() => {\n    const setting = settings?.[0];\n    if (setting?.setting_value) {\n      const value = setting.setting_value;\n      // Validate coordinates\n      if (\n        typeof value.latitude === \"number\" &&\n        typeof value.longitude === \"number\" &&\n        value.latitude >= -90 &&\n        value.latitude <= 90 &&\n        value.longitude >= -180 &&\n        value.longitude <= 180\n      ) {\n        return {\n          latitude: value.latitude,\n          longitude: value.longitude,\n          address: value.address || \"Office\",\n        };\n      }\n    }\n    return DEFAULT_OFFICE_LOCATION;\n  }, [settings]);\n\n  // Sync to localStorage whenever office location changes (for non-React code that reads from localStorage)\n  useEffect(() => {\n    if (officeLocation && typeof window !== \"undefined\") {\n      try {\n        localStorage.setItem(\"crm_office_location\", JSON.stringify(officeLocation));\n      } catch (error) {\n        // Ignore localStorage errors (e.g., quota exceeded)\n        console.warn(\"Failed to sync office location to localStorage:\", error);\n      }\n    }\n  }, [officeLocation]);\n\n  const updateOfficeLocation = useCallback(\n    async (newLocation: OfficeLocation): Promise<void> => {\n      // Validate coordinates\n      if (\n        typeof newLocation.latitude !== \"number\" ||\n        typeof newLocation.longitude !== \"number\" ||\n        isNaN(newLocation.latitude) ||\n        isNaN(newLocation.longitude) ||\n        newLocation.latitude < -90 ||\n        newLocation.latitude > 90 ||\n        newLocation.longitude < -180 ||\n        newLocation.longitude > 180\n      ) {\n        throw new Error(\"Invalid coordinates. Latitude must be between -90 and 90, longitude between -180 and 180.\");\n      }\n\n      const setting = settings?.[0];\n      if (!setting) {\n        throw new Error(\"Office location setting not found in database\");\n      }\n\n      try {\n        await update(\n          \"general_settings\",\n          {\n            id: setting.id,\n            data: {\n              setting_value: {\n                latitude: newLocation.latitude,\n                longitude: newLocation.longitude,\n                address: newLocation.address,\n              },\n            },\n            previousData: setting,\n          },\n          {\n            mutationMode: \"pessimistic\",\n          }\n        );\n        await refetch();\n        notify(\"Office location updated successfully\", { type: \"success\" });\n        // Trigger a custom event so other parts of the app can react\n        if (typeof window !== \"undefined\") {\n          window.dispatchEvent(\n            new CustomEvent(\"office-location-changed\", { detail: { officeLocation: newLocation } })\n          );\n        }\n      } catch (error) {\n        notify(\"Failed to update office location\", { type: \"error\" });\n        throw error;\n      }\n    },\n    [settings, update, refetch, notify]\n  );\n\n  return {\n    officeLocation,\n    isLoading,\n    updateOfficeLocation,\n    refetch,\n  };\n}\n\n/**\n * Gets the current office location (for use outside React components)\n * This is a synchronous function that reads from localStorage as fallback\n * For React components, use useOfficeLocation hook instead\n * \n * @returns The current office location\n */\nexport function getOfficeLocationFromStorage(): OfficeLocation {\n  // This is a fallback - in practice, components should use useOfficeLocation hook\n  // But for non-React code, we can check localStorage as fallback\n  if (typeof window === \"undefined\") {\n    return DEFAULT_OFFICE_LOCATION;\n  }\n  try {\n    const stored = localStorage.getItem(\"crm_office_location\");\n    if (stored) {\n      const parsed = JSON.parse(stored);\n      if (\n        typeof parsed.latitude === \"number\" &&\n        typeof parsed.longitude === \"number\" &&\n        parsed.latitude >= -90 &&\n        parsed.latitude <= 90 &&\n        parsed.longitude >= -180 &&\n        parsed.longitude <= 180\n      ) {\n        return parsed;\n      }\n    }\n  } catch (error) {\n    // Ignore errors\n  }\n  return DEFAULT_OFFICE_LOCATION;\n}\n\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/useBulkExport.tsx",
      "content": "import type { Exporter } from \"ra-core\";\nimport {\n  fetchRelatedRecords,\n  useDataProvider,\n  useListContext,\n  useNotify,\n  useResourceContext,\n} from \"ra-core\";\nimport { useCallback, useMemo } from \"react\";\n\n/**\n * This fill will be backported to 'ra-core' in the future.\n *\n * @deprecated Import from 'ra-core' instead.\n */\nexport function useBulkExport<\n  ResourceInformationsType extends Partial<{ resource: string }>,\n>(props: UseBulkExportProps<ResourceInformationsType>) {\n  const { exporter: customExporter, meta } = props;\n\n  const resource = useResourceContext(props);\n  const { exporter: exporterFromContext, selectedIds } = useListContext();\n  const exporter = customExporter || exporterFromContext;\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n\n  const bulkExport = useCallback(() => {\n    if (exporter && resource) {\n      dataProvider\n        .getMany(resource, { ids: selectedIds, meta })\n        .then(({ data }) =>\n          exporter(\n            data,\n            fetchRelatedRecords(dataProvider),\n            dataProvider,\n            resource,\n          ),\n        )\n        .catch((error) => {\n          console.error(error);\n          notify(\"ra.notification.http_error\", {\n            type: \"error\",\n          });\n        });\n    }\n  }, [dataProvider, exporter, notify, resource, selectedIds, meta]);\n\n  return useMemo(() => {\n    return {\n      bulkExport,\n    };\n  }, [bulkExport]);\n}\n\nexport type ResourceInformation = Partial<{ resource: string }>;\n\nexport type UseBulkExportProps<T extends ResourceInformation> = T & {\n  exporter?: Exporter;\n\n  meta?: any;\n};\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/simple-form-iterator-context.tsx",
      "content": "import { createContext, useContext } from \"react\";\n\n/**\n * A React context that provides access to a SimpleFormIterator data (the total number of items) and mutators (add, reorder and remove).\n * Useful to create custom array input iterators.\n * @deprecated Use SimpleFormIteratorContext from `ra-core` once available.\n * @see {SimpleFormIterator}\n * @see {ArrayInput}\n */\nexport const SimpleFormIteratorContext = createContext<\n  SimpleFormIteratorContextValue | undefined\n>(undefined);\n\n/**\n * @deprecated Use SimpleFormIteratorContextValue from `ra-core` once available.\n */\nexport type SimpleFormIteratorContextValue = {\n  add: (item?: any) => void;\n  remove: (index: number) => void;\n  reOrder: (index: number, newIndex: number) => void;\n  source: string;\n  total: number;\n};\n\n/**\n * @deprecated Use useSimpleFormIterator from `ra-core` once available.\n */\nexport const useSimpleFormIterator = () => {\n  const context = useContext(SimpleFormIteratorContext);\n  if (!context) {\n    throw new Error(\n      \"useSimpleFormIterator must be used inside a SimpleFormIterator\",\n    );\n  }\n  return context;\n};\n\n/**\n * A React context that provides access to a SimpleFormIterator item meta (its index and the total number of items) and mutators (reorder and remove this remove).\n * Useful to create custom array input iterators.\n * @deprecated Use SimpleFormIteratorItemContext from `ra-core` once available.\n * @see {SimpleFormIterator}\n * @see {ArrayInput}\n */\nexport const SimpleFormIteratorItemContext = createContext<\n  SimpleFormIteratorItemContextValue | undefined\n>(undefined);\n\n/**\n * @deprecated Use SimpleFormIteratorItemContextValue from `ra-core` once available.\n */\nexport type SimpleFormIteratorItemContextValue = {\n  index: number;\n  total: number;\n  remove: () => void;\n  reOrder: (newIndex: number) => void;\n};\n\n/**\n * @deprecated Use useSimpleFormIteratorItem from `ra-core` once available.\n */\nexport const useSimpleFormIteratorItem = () => {\n  const context = useContext(SimpleFormIteratorItemContext);\n  if (!context) {\n    throw new Error(\n      \"useSimpleFormIteratorItem must be used inside a SimpleFormIteratorItem\",\n    );\n  }\n  return context;\n};\n",
      "type": "registry:hook"
    }
  ],
  "type": "registry:block"
}