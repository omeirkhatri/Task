{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "atomic-crm",
  "title": "Atomic CRM",
  "description": "A fully fledged CRM application built with Shadcn Admin Kit",
  "dependencies": [
    "@hello-pangea/dnd@^18.0.1",
    "@nivo/bar@^0.99.0",
    "faker@^5.5.3",
    "jsonexport@^3.2.0",
    "papaparse@^5.5.3",
    "ra-supabase-core@^3.5.1",
    "ra-supabase-language-english@^3.5.0",
    "zod@^4.0.5"
  ],
  "registryDependencies": [
    "progress",
    "tabs",
    "https://marmelab.com/shadcn-admin-kit/r/admin.json"
  ],
  "files": [
    {
      "path": "src/components/atomic-crm/types.ts",
      "content": "import type { Identifier, RaRecord } from \"ra-core\";\nimport type { ComponentType } from \"react\";\n\nimport type {\n  COMPANY_CREATED,\n  CONTACT_CREATED,\n  CONTACT_NOTE_CREATED,\n  DEAL_CREATED,\n  DEAL_NOTE_CREATED,\n  QUOTE_CREATED,\n  QUOTE_UPDATED,\n  TASK_CREATED,\n  TASK_COMPLETED,\n  DEAL_STATUS_CHANGED,\n  DEAL_ARCHIVED,\n  DEAL_UNARCHIVED,\n  NOTE_DELETED,\n  QUOTE_DELETED,\n  TASK_DELETED,\n} from \"./consts\";\n\nexport type SignUpData = {\n  email: string;\n  password: string;\n  first_name: string;\n  last_name: string;\n};\n\nexport type SalesFormData = {\n  avatar: string;\n  email: string;\n  password?: string;\n  first_name: string;\n  last_name: string;\n  administrator: boolean;\n  disabled: boolean;\n};\n\nexport type Sale = {\n  first_name: string;\n  last_name: string;\n  administrator: boolean;\n  avatar?: RAFile;\n  disabled?: boolean;\n  user_id: string;\n\n  /**\n   * This is a copy of the user's email, to make it easier to handle by react admin\n   * DO NOT UPDATE this field directly, it should be updated by the backend\n   */\n  email: string;\n\n  /**\n   * This is used by the fake rest provider to store the password\n   * DO NOT USE this field in your code besides the fake rest provider\n   * @deprecated\n   */\n  password?: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type Service = {\n  name: string;\n  created_at: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type Company = {\n  name: string;\n  logo: RAFile;\n  sector: string;\n  size: 1 | 10 | 50 | 250 | 500;\n  linkedin_url: string;\n  website: string;\n  phone_number: string;\n  address: string;\n  zipcode: string;\n  city: string;\n  stateAbbr: string;\n  sales_id: Identifier;\n  created_at: string;\n  description: string;\n  revenue: string;\n  tax_identifier: string;\n  country: string;\n  context_links?: string[];\n  nb_contacts?: number;\n  nb_deals?: number;\n  // B2C fields for clients\n  services?: Identifier[];\n  nb_tasks?: number;\n} & Pick<RaRecord, \"id\">;\n\nexport type EmailAndType = {\n  email: string;\n  type: \"Work\" | \"Home\" | \"Other\";\n};\n\nexport type PhoneNumberAndType = {\n  number: string;\n  type: \"Work\" | \"Home\" | \"Other\";\n};\n\nexport type Contact = {\n  first_name: string;\n  last_name: string;\n  title: string;\n  company_id: Identifier;\n  email_jsonb: EmailAndType[];\n  avatar?: Partial<RAFile>;\n  linkedin_url?: string | null;\n  first_seen: string;\n  last_seen: string;\n  has_newsletter: boolean;\n  tags: Identifier[];\n  gender: string;\n  sales_id: Identifier;\n  status: string;\n  background: string;\n  phone_jsonb: PhoneNumberAndType[];\n  nb_tasks?: number;\n  company_name?: string;\n  // B2C fields for leads\n  flat_villa_number?: string;\n  building_street?: string;\n  area?: string;\n  google_maps_link?: string;\n  phone_has_whatsapp?: boolean;\n  services_interested?: Identifier[];\n  description?: string;\n} & Pick<RaRecord, \"id\">;\n\n// Type alias for clarity - Lead is a Contact in B2C context\nexport type Lead = Contact;\n\n// Type alias for clarity - Client is a Company in B2C context\nexport type Client = Company;\n\nexport type ContactNote = {\n  contact_id: Identifier;\n  text: string;\n  date: string;\n  sales_id: Identifier;\n  status: string;\n  attachments?: AttachmentNote[];\n  tagged_user_ids?: Identifier[];\n} & Pick<RaRecord, \"id\">;\n\nexport type Deal = {\n  name?: string; // Deprecated: use first_name and last_name instead\n  first_name?: string;\n  last_name?: string;\n  company_id: Identifier;\n  contact_ids: Identifier[];\n  category: string;\n  stage: string;\n  description: string;\n  amount: number;\n  created_at: string;\n  updated_at: string;\n  archived_at?: string;\n  expected_closing_date: string;\n  sales_id: Identifier;\n  index: number;\n  // B2C field for lead status\n  lead_id?: Identifier;\n} & Pick<RaRecord, \"id\">;\n\n// Type alias for clarity - LeadStatus is a Deal in B2C context\nexport type LeadStatus = Deal;\n\nexport type DealNote = {\n  deal_id: Identifier;\n  text: string;\n  date: string;\n  sales_id: Identifier;\n  attachments?: AttachmentNote[];\n  tagged_user_ids?: Identifier[];\n\n  // This is defined for compatibility with `ContactNote`\n  status?: undefined;\n} & Pick<RaRecord, \"id\">;\n\nexport type Tag = {\n  name: string;\n  color: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type Task = {\n  contact_id: Identifier;\n  type: string;\n  text: string;\n  due_date: string;\n  done_date?: string | null;\n  sales_id?: Identifier;\n  created_at?: string;\n  tagged_user_ids?: Identifier[];\n} & Pick<RaRecord, \"id\">;\n\nexport type Quote = {\n  contact_id: Identifier;\n  service_id?: Identifier;\n  description?: string;\n  amount: number;\n  status: \"Draft\" | \"Sent\" | \"Accepted\" | \"Rejected\";\n  created_at: string;\n  updated_at: string;\n  sales_id?: Identifier;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityCompanyCreated = {\n  type: typeof COMPANY_CREATED;\n  company_id: Identifier;\n  company: Company;\n  sales_id: Identifier;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityContactCreated = {\n  type: typeof CONTACT_CREATED;\n  company_id: Identifier;\n  sales_id?: Identifier;\n  contact: Contact;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityContactNoteCreated = {\n  type: typeof CONTACT_NOTE_CREATED;\n  sales_id?: Identifier;\n  contactNote: ContactNote;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityDealCreated = {\n  type: typeof DEAL_CREATED;\n  company_id: Identifier;\n  sales_id?: Identifier;\n  deal: Deal;\n  date: string;\n};\n\nexport type ActivityDealNoteCreated = {\n  type: typeof DEAL_NOTE_CREATED;\n  sales_id?: Identifier;\n  dealNote: DealNote;\n  date: string;\n};\n\nexport type ActivityQuoteCreated = {\n  type: typeof QUOTE_CREATED;\n  sales_id?: Identifier;\n  quote: Quote;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityQuoteUpdated = {\n  type: typeof QUOTE_UPDATED;\n  sales_id?: Identifier;\n  quote: Quote;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityTaskCreated = {\n  type: typeof TASK_CREATED;\n  sales_id?: Identifier;\n  task: Task;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityTaskCompleted = {\n  type: typeof TASK_COMPLETED;\n  sales_id?: Identifier;\n  task: Task;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityDealStatusChanged = {\n  type: typeof DEAL_STATUS_CHANGED;\n  company_id?: Identifier;\n  sales_id?: Identifier;\n  deal: Deal;\n  date: string;\n  old_stage?: string | null;\n  new_stage?: string | null;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityDealArchived = {\n  type: typeof DEAL_ARCHIVED;\n  company_id?: Identifier;\n  sales_id?: Identifier;\n  deal: Deal;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityDealUnarchived = {\n  type: typeof DEAL_UNARCHIVED;\n  company_id?: Identifier;\n  sales_id?: Identifier;\n  deal: Deal;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityNoteDeleted = {\n  type: typeof NOTE_DELETED;\n  sales_id?: Identifier;\n  contact_id?: Identifier;\n  deal_id?: Identifier;\n  note_text?: string;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityQuoteDeleted = {\n  type: typeof QUOTE_DELETED;\n  sales_id?: Identifier;\n  contact_id?: Identifier;\n  quote_amount?: number;\n  quote_description?: string;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type ActivityTaskDeleted = {\n  type: typeof TASK_DELETED;\n  sales_id?: Identifier;\n  contact_id?: Identifier;\n  task_text?: string;\n  task_type?: string;\n  date: string;\n} & Pick<RaRecord, \"id\">;\n\nexport type Activity = RaRecord &\n  (\n    | ActivityCompanyCreated\n    | ActivityContactCreated\n    | ActivityContactNoteCreated\n    | ActivityDealCreated\n    | ActivityDealNoteCreated\n    | ActivityQuoteCreated\n    | ActivityQuoteUpdated\n    | ActivityTaskCreated\n    | ActivityTaskCompleted\n    | ActivityDealStatusChanged\n    | ActivityDealArchived\n    | ActivityDealUnarchived\n    | ActivityNoteDeleted\n    | ActivityQuoteDeleted\n    | ActivityTaskDeleted\n  );\n\nexport interface RAFile {\n  src: string;\n  title: string;\n  path?: string;\n  rawFile: File;\n  type?: string;\n}\n\nexport type AttachmentNote = RAFile;\nexport interface DealStage {\n  value: string;\n  label: string;\n}\n\nexport interface NoteStatus {\n  value: string;\n  label: string;\n  color: string;\n}\n\nexport interface ContactGender {\n  value: string;\n  label: string;\n  icon: ComponentType<{ className?: string }>;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/consts.ts",
      "content": "export const COMPANY_CREATED = \"company.created\" as const;\nexport const CONTACT_CREATED = \"contact.created\" as const;\nexport const CONTACT_NOTE_CREATED = \"contactNote.created\" as const;\nexport const DEAL_CREATED = \"deal.created\" as const;\nexport const DEAL_NOTE_CREATED = \"dealNote.created\" as const;\nexport const QUOTE_CREATED = \"quote.created\" as const;\nexport const QUOTE_UPDATED = \"quote.updated\" as const;\nexport const TASK_CREATED = \"task.created\" as const;\nexport const TASK_COMPLETED = \"task.completed\" as const;\nexport const DEAL_STATUS_CHANGED = \"deal.statusChanged\" as const;\nexport const DEAL_ARCHIVED = \"deal.archived\" as const;\nexport const DEAL_UNARCHIVED = \"deal.unarchived\" as const;\nexport const NOTE_DELETED = \"note.deleted\" as const;\nexport const QUOTE_DELETED = \"quote.deleted\" as const;\nexport const TASK_DELETED = \"task.deleted\" as const;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TasksPage.tsx",
      "content": "import { CheckSquare, CheckCircle2, Search } from \"lucide-react\";\nimport {\n  ListContextProvider,\n  ResourceContextProvider,\n  useGetIdentity,\n  useGetList,\n  useList,\n} from \"ra-core\";\nimport { useState, useMemo, useEffect } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\nimport { AddTask } from \"./AddTask\";\nimport { TasksIterator } from \"./TasksIterator\";\nimport {\n  crmAddDays,\n  crmEndOfDay,\n  crmEndOfWeek,\n  crmStartOfDay,\n} from \"../misc/timezone\";\nimport type { Task } from \"../types\";\n\nconst startOfTodayDate = crmStartOfDay();\nconst endOfTodayDate = crmEndOfDay();\nconst endOfTomorrowDate = crmEndOfDay(crmAddDays(new Date(), 1));\nconst endOfWeekDate = crmEndOfWeek();\n\nconst startOfTodayDateISO = (startOfTodayDate ?? new Date()).toISOString();\nconst endOfTodayDateISO = (endOfTodayDate ?? new Date()).toISOString();\nconst endOfTomorrowDateISO = (endOfTomorrowDate ?? new Date()).toISOString();\nconst endOfWeekDateISO = (endOfWeekDate ?? new Date()).toISOString();\n\nconst taskFilters = {\n  overdue: {\n    \"due_date@lt\": startOfTodayDateISO,\n    \"done_date@is\": null,\n  },\n  today: {\n    \"due_date@gte\": startOfTodayDateISO,\n    \"due_date@lte\": endOfTodayDateISO,\n    \"done_date@is\": null,\n  },\n  tomorrow: {\n    \"due_date@gt\": endOfTodayDateISO,\n    \"due_date@lte\": endOfTomorrowDateISO,\n    \"done_date@is\": null,\n  },\n  thisWeek: {\n    \"due_date@gt\": endOfTomorrowDateISO,\n    \"due_date@lte\": endOfWeekDateISO,\n    \"done_date@is\": null,\n  },\n  later: {\n    \"due_date@gt\": endOfWeekDateISO,\n    \"done_date@is\": null,\n  },\n  completed: {\n    \"done_date@not.is\": null,\n  },\n};\n\ntype TaskColumnProps = {\n  title: string;\n  filter: any;\n  showMyTasksOnly: boolean;\n  currentUserId?: number;\n  sortBy?: \"due_date\" | \"done_date\";\n  sortOrder?: \"ASC\" | \"DESC\";\n  searchQuery?: string;\n};\n\nconst TaskColumn = ({\n  title,\n  filter,\n  showMyTasksOnly,\n  currentUserId,\n  sortBy = \"due_date\",\n  sortOrder = \"ASC\",\n  searchQuery,\n}: TaskColumnProps) => {\n  const baseFilter = useMemo(() => {\n    let finalFilter = { ...filter };\n    \n    if (showMyTasksOnly && currentUserId) {\n      // Filter by tagged_user_ids using @cs (contains) operator\n      finalFilter[\"tagged_user_ids@cs\"] = `{${currentUserId}}`;\n    }\n    \n    // Add search filter if provided\n    if (searchQuery && searchQuery.trim()) {\n      finalFilter[\"text@ilike\"] = `%${searchQuery.trim()}%`;\n    }\n    \n    return finalFilter;\n  }, [filter, showMyTasksOnly, currentUserId, searchQuery]);\n\n  const {\n    data: tasks,\n    total,\n    isPending,\n  } = useGetList<Task>(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: sortBy, order: sortOrder },\n      filter: baseFilter,\n    },\n    { enabled: !showMyTasksOnly || !!currentUserId },\n  );\n\n  // Sort tasks based on column type\n  const sortedTasks = useMemo(() => {\n    if (!tasks) return [];\n    \n    // For completed column, sort by done_date descending (most recent first)\n    if (sortBy === \"done_date\") {\n      return tasks.sort((a, b) => {\n        const dateA = new Date(a.done_date || 0).getTime();\n        const dateB = new Date(b.done_date || 0).getTime();\n        return dateB - dateA; // Descending order\n      });\n    }\n    \n    // For other columns: only show incomplete tasks, sorted by due_date\n    return tasks\n      .filter(task => !task.done_date)\n      .sort((a, b) => {\n        const dateA = new Date(a.due_date || 0).getTime();\n        const dateB = new Date(b.due_date || 0).getTime();\n        return dateA - dateB;\n      });\n  }, [tasks, sortBy]);\n\n  const listContext = useList({\n    data: sortedTasks,\n    isPending,\n    resource: \"tasks\",\n    perPage: 1000,\n  });\n\n  return (\n    <div className=\"flex flex-col h-full\">\n      <Card className=\"flex flex-col h-full border-border/50 shadow-sm\">\n        <CardHeader className=\"pb-2.5 px-4 pt-3 border-b border-border/50\">\n          <CardTitle className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n            <span>{title}</span>\n            {total !== undefined && total > 0 && (\n              <span className=\"text-xs font-medium text-foreground bg-muted px-1.5 py-0.5 rounded\">\n                {total}\n              </span>\n            )}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex-1 overflow-y-auto min-h-0 p-2 space-y-2\">\n          <ResourceContextProvider value=\"tasks\">\n            <ListContextProvider value={listContext}>\n              {isPending ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <p className=\"text-sm text-muted-foreground\">Loading...</p>\n                </div>\n              ) : (\n                <TasksIterator showContact showAll showTimestamp={false} />\n              )}\n            </ListContextProvider>\n          </ResourceContextProvider>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nconst CompletedTasksDialog = ({\n  open,\n  onClose,\n  showMyTasksOnly,\n  currentUserId,\n  searchQuery: initialSearchQuery,\n}: {\n  open: boolean;\n  onClose: () => void;\n  showMyTasksOnly: boolean;\n  currentUserId?: number;\n  searchQuery?: string;\n}) => {\n  const [searchQuery, setSearchQuery] = useState(initialSearchQuery || \"\");\n\n  // Sync search query when dialog opens or parent search changes\n  useEffect(() => {\n    if (open && initialSearchQuery !== undefined) {\n      setSearchQuery(initialSearchQuery);\n    }\n  }, [open, initialSearchQuery]);\n\n  const baseFilter = useMemo(() => {\n    let finalFilter = { ...taskFilters.completed };\n    \n    if (showMyTasksOnly && currentUserId) {\n      finalFilter[\"tagged_user_ids@cs\"] = `{${currentUserId}}`;\n    }\n    \n    if (searchQuery && searchQuery.trim()) {\n      finalFilter[\"text@ilike\"] = `%${searchQuery.trim()}%`;\n    }\n    \n    return finalFilter;\n  }, [showMyTasksOnly, currentUserId, searchQuery]);\n\n  const {\n    data: tasks,\n    total,\n    isPending,\n  } = useGetList<Task>(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"done_date\", order: \"DESC\" },\n      filter: baseFilter,\n    },\n    { enabled: open },\n  );\n\n  const sortedTasks = useMemo(() => {\n    if (!tasks) return [];\n    return tasks.sort((a, b) => {\n      const dateA = new Date(a.done_date || 0).getTime();\n      const dateB = new Date(b.done_date || 0).getTime();\n      return dateB - dateA;\n    });\n  }, [tasks]);\n\n  const listContext = useList({\n    data: sortedTasks,\n    isPending,\n    resource: \"tasks\",\n    perPage: 1000,\n  });\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"lg:max-w-4xl max-h-[90vh] overflow-hidden flex flex-col\">\n        <DialogHeader>\n          <DialogTitle>Completed Tasks</DialogTitle>\n          <DialogDescription className=\"sr-only\">\n            View all completed tasks\n          </DialogDescription>\n        </DialogHeader>\n        {/* Search Bar */}\n        <div className=\"flex-shrink-0 pb-4\">\n          <div className=\"flex flex-grow relative\">\n            <input\n              type=\"text\"\n              placeholder=\"Search completed tasks...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8\"\n            />\n            <Search className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none\" />\n          </div>\n        </div>\n        <div className=\"flex-1 overflow-y-auto min-h-0\">\n          <ResourceContextProvider value=\"tasks\">\n            <ListContextProvider value={listContext}>\n              {isPending ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <p className=\"text-sm text-muted-foreground\">Loading...</p>\n                </div>\n              ) : sortedTasks && sortedTasks.length > 0 ? (\n                <TasksIterator showContact showAll showTimestamp={true} />\n              ) : (\n                <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n                  <CheckCircle2 className=\"w-12 h-12 text-muted-foreground mb-4 opacity-50\" />\n                  <p className=\"text-sm text-muted-foreground\">No completed tasks</p>\n                </div>\n              )}\n            </ListContextProvider>\n          </ResourceContextProvider>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport const TasksPage = () => {\n  const { identity } = useGetIdentity();\n  const [showMyTasksOnly, setShowMyTasksOnly] = useState(false);\n  const [completedDialogOpen, setCompletedDialogOpen] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  return (\n    <div className=\"flex flex-col w-full lg:h-[calc(100vh-8rem)] h-auto -mx-4 -mt-4 p-6 gap-4 bg-background\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-shrink-0 pb-2\">\n        {/* Search Bar (moved into header) */}\n        <div className=\"flex-shrink-0 w-full max-w-md\">\n          <div className=\"flex flex-grow relative\">\n            <input\n              type=\"text\"\n              placeholder=\"Search tasks...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8\"\n            />\n            <Search className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none\" />\n          </div>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <div className=\"flex items-center gap-2\">\n            <Switch\n              id=\"my-tasks-only\"\n              checked={showMyTasksOnly}\n              onCheckedChange={setShowMyTasksOnly}\n            />\n            <Label\n              htmlFor=\"my-tasks-only\"\n              className=\"text-sm font-medium cursor-pointer text-muted-foreground\"\n            >\n              My Tasks Only\n            </Label>\n          </div>\n          <Button\n            variant=\"outline\"\n            onClick={() => setCompletedDialogOpen(true)}\n            className=\"flex items-center gap-2\"\n            size=\"sm\"\n          >\n            <CheckCircle2 className=\"h-4 w-4\" />\n            Completed Tasks\n          </Button>\n          <AddTask display=\"icon\" selectContact />\n        </div>\n      </div>\n\n      {/* Task Columns */}\n      <div className=\"flex-1 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 min-h-0 overflow-hidden max-md:overflow-y-auto max-md:h-auto\">\n        <TaskColumn\n          title=\"Overdue\"\n          filter={taskFilters.overdue}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n        <TaskColumn\n          title=\"Today\"\n          filter={taskFilters.today}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n        <TaskColumn\n          title=\"Tomorrow\"\n          filter={taskFilters.tomorrow}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n        <TaskColumn\n          title=\"This Week\"\n          filter={taskFilters.thisWeek}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n        <TaskColumn\n          title=\"Later\"\n          filter={taskFilters.later}\n          showMyTasksOnly={showMyTasksOnly}\n          currentUserId={identity?.id}\n          searchQuery={searchQuery}\n        />\n      </div>\n\n      <CompletedTasksDialog\n        open={completedDialogOpen}\n        onClose={() => setCompletedDialogOpen(false)}\n        showMyTasksOnly={showMyTasksOnly}\n        currentUserId={identity?.id}\n        searchQuery={searchQuery}\n      />\n    </div>\n  );\n};\n\nTasksPage.path = \"/tasks\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TasksIterator.tsx",
      "content": "import { useListContext } from \"ra-core\";\nimport { CheckSquare } from \"lucide-react\";\n\nimport { Task } from \"./Task\";\n\nexport const TasksIterator = ({\n  showContact,\n  className,\n  showAll,\n  showTimestamp = true,\n}: {\n  showContact?: boolean;\n  className?: string;\n  showAll?: boolean;\n  showTimestamp?: boolean;\n}) => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error) return null;\n\n  // If showAll is true, show all tasks (including completed ones)\n  // Otherwise, filter out completed tasks completely\n  const tasks = showAll \n    ? data\n    : data.filter((task) => !task.done_date);\n\n  if (!tasks || tasks.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n        <CheckSquare className=\"w-12 h-12 text-muted-foreground mb-4 opacity-50\" />\n        <p className=\"text-sm text-muted-foreground\">No tasks yet</p>\n        <p className=\"text-xs text-muted-foreground mt-1\">Create your first task to get started</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className={`space-y-2 ${className || \"\"}`}>\n      {tasks.map((task) => (\n        <Task task={task} showContact={showContact} showTimestamp={showTimestamp} key={task.id} />\n      ))}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/TaskEdit.tsx",
      "content": "import { EditBase, Form, required, useNotify, type Identifier } from \"ra-core\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { ReferenceArrayInput } from \"@/components/admin/reference-array-input\";\nimport { AutocompleteArrayInput } from \"@/components/admin/autocomplete-array-input\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Sale } from \"../types\";\n\nexport const TaskEdit = ({\n  open,\n  close,\n  taskId,\n}: {\n  taskId: Identifier;\n  open: boolean;\n  close: () => void;\n}) => {\n  const { taskTypes } = useConfigurationContext();\n  const notify = useNotify();\n  return (\n    <Dialog open={open} onOpenChange={close}>\n      {taskId && (\n        <EditBase\n          id={taskId}\n          resource=\"tasks\"\n          className=\"mt-0\"\n          mutationOptions={{\n            onSuccess: () => {\n              close();\n              notify(\"Task updated\", {\n                type: \"info\",\n                undoable: true,\n              });\n            },\n          }}\n          redirect={false}\n        >\n          <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n            <Form className=\"flex flex-col gap-4\">\n              <DialogHeader>\n                <DialogTitle>Edit task</DialogTitle>\n                <DialogDescription className=\"sr-only\">\n                  Edit task details including description, due date, type, and tagged users.\n                </DialogDescription>\n              </DialogHeader>\n              <TextInput\n                autoFocus\n                source=\"text\"\n                label=\"Description\"\n                validate={required()}\n                multiline\n                helperText={false}\n              />\n              <div className=\"grid grid-cols-2 gap-4\">\n                <DateInput\n                  source=\"due_date\"\n                  helperText={false}\n                  validate={required()}\n                />\n                <SelectInput\n                  source=\"type\"\n                  choices={taskTypes.map((type) => ({\n                    id: type,\n                    name: type,\n                  }))}\n                  helperText={false}\n                  validate={required()}\n                />\n              </div>\n              <ReferenceArrayInput\n                source=\"tagged_user_ids\"\n                reference=\"sales\"\n                filter={{ \"disabled@neq\": true }}\n                sort={{ field: \"last_name\", order: \"ASC\" }}\n              >\n                <AutocompleteArrayInput\n                  label=\"Tag users\"\n                  helperText={false}\n                  optionText={(choice: Sale) => `${choice.first_name} ${choice.last_name}`}\n                  placeholder=\"Search users to tag...\"\n                />\n              </ReferenceArrayInput>\n              <DialogFooter className=\"w-full sm:justify-between gap-4\">\n                <DeleteButton\n                  mutationOptions={{\n                    onSuccess: () => {\n                      close();\n                      notify(\"Task deleted\", {\n                        type: \"info\",\n                        undoable: true,\n                      });\n                    },\n                  }}\n                  redirect={false}\n                />\n                <SaveButton label=\"Save\" />\n              </DialogFooter>\n            </Form>\n          </DialogContent>\n        </EditBase>\n      )}\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/Task.tsx",
      "content": "import { useQueryClient } from \"@tanstack/react-query\";\nimport { MoreVertical } from \"lucide-react\";\nimport {\n  RecordContextProvider,\n  useDeleteWithUndoController,\n  useNotify,\n  useRecordContext,\n  useUpdate,\n} from \"ra-core\";\nimport { useEffect, useState } from \"react\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ReferenceArrayField } from \"@/components/admin/reference-array-field\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { cn } from \"@/lib/utils\";\n\nimport type { Contact, Sale, Task as TData } from \"../types\";\nimport { crmAddDays } from \"../misc/timezone\";\nimport { TaskEdit } from \"./TaskEdit\";\n\n// Component to display user initials\nconst UserInitials = () => {\n  const record = useRecordContext<Sale>();\n  if (!record) return null;\n  const initials = `${record.first_name?.charAt(0) || \"\"}${record.last_name?.charAt(0) || \"\"}`.toUpperCase();\n  return (\n    <div\n      className=\"w-6 h-6 rounded-full bg-muted flex items-center justify-center text-[10px] font-medium text-muted-foreground border border-border\"\n      title={`${record.first_name} ${record.last_name}`}\n    >\n      {initials}\n    </div>\n  );\n};\n\nexport const Task = ({\n  task,\n  showContact,\n  showTimestamp = true,\n}: {\n  task: TData;\n  showContact?: boolean;\n  showTimestamp?: boolean;\n}) => {\n  // showTimestamp is kept for compatibility with callers; timestamp is currently not displayed.\n  void showTimestamp;\n\n  const notify = useNotify();\n  const queryClient = useQueryClient();\n\n  const [openEdit, setOpenEdit] = useState(false);\n\n  const handleCloseEdit = () => {\n    setOpenEdit(false);\n  };\n\n  const [update, { isPending: isUpdatePending, isSuccess, variables }] = useUpdate();\n\n  const { handleDelete } = useDeleteWithUndoController({\n    resource: \"tasks\",\n    record: task,\n    redirect: false,\n    mutationOptions: {\n      onSuccess() {\n        notify(\"Task deleted successfully\", { undoable: true });\n      },\n    },\n  });\n\n  const handleEdit = () => {\n    setOpenEdit(true);\n  };\n\n  const handleCheck = () => () => {\n    update(\"tasks\", {\n      id: task.id,\n      data: {\n        done_date: task.done_date ? null : new Date().toISOString(),\n      },\n      previousData: task,\n    });\n  };\n\n  useEffect(() => {\n    // Invalidate queries when task completion status changes\n    if (isSuccess && variables?.data?.done_date !== undefined) {\n      queryClient.invalidateQueries({ queryKey: [\"tasks\", \"getList\"] });\n    }\n  }, [queryClient, isSuccess, variables]);\n\n  const labelId = `checkbox-list-label-${task.id}`;\n  const isCompleted = !!task.done_date;\n  const dueDate = task.due_date ? new Date(task.due_date) : null;\n  const isOverdue = dueDate && !isCompleted && dueDate < new Date();\n\n  return (\n    <>\n      <Card\n        id={`task-${task.id}`}\n        className={cn(\n          \"group border border-border/50 bg-card hover:border-border hover:shadow-sm transition-all duration-200\",\n          isCompleted && \"opacity-60\",\n        )}\n      >\n        <CardContent className=\"p-2 flex items-start gap-2\">\n          <Checkbox\n            id={labelId}\n            checked={isCompleted}\n            onCheckedChange={handleCheck()}\n            disabled={isUpdatePending}\n            className=\"mt-1 h-4 w-4 border-2 flex-shrink-0\"\n          />\n\n          <div className=\"flex flex-col flex-1 min-w-0 gap-1\">\n            <div className=\"flex items-start justify-between gap-2\">\n              {/* Description */}\n              <p\n                className={cn(\n                  \"text-sm font-medium leading-snug break-words min-w-0\",\n                  isCompleted\n                    ? \"line-through text-muted-foreground\"\n                    : \"text-foreground\",\n                )}\n              >\n                {task.text || \"No description\"}\n              </p>\n\n              {/* Right Side: Initials + Actions */}\n              <div className=\"flex items-start gap-1 flex-shrink-0\">\n                {task.tagged_user_ids && task.tagged_user_ids.length > 0 && (\n                  <RecordContextProvider value={task}>\n                    <ReferenceArrayField\n                      source=\"tagged_user_ids\"\n                      reference=\"sales\"\n                    >\n                      <SingleFieldList className=\"flex items-center gap-1\">\n                        <UserInitials />\n                      </SingleFieldList>\n                    </ReferenceArrayField>\n                  </RecordContextProvider>\n                )}\n\n                <div className=\"opacity-0 group-hover:opacity-100 transition-opacity\">\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"h-6 w-6 p-0 cursor-pointer hover:bg-muted\"\n                        aria-label=\"task actions\"\n                      >\n                        <MoreVertical className=\"h-3.5 w-3.5\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      {isCompleted ? (\n                        <DropdownMenuItem\n                          className=\"cursor-pointer\"\n                          onClick={() => {\n                            update(\"tasks\", {\n                              id: task.id,\n                              data: { done_date: null },\n                              previousData: task,\n                            });\n                            notify(\"Task added back to tasks board\", {\n                              type: \"success\",\n                            });\n                          }}\n                        >\n                          Add back to tasks\n                        </DropdownMenuItem>\n                      ) : (\n                        <>\n                          <DropdownMenuItem\n                            className=\"cursor-pointer\"\n                            onClick={() => {\n                              const tomorrow = crmAddDays(new Date(), 1)?.toISOString();\n                              update(\"tasks\", {\n                                id: task.id,\n                                data: { due_date: tomorrow || new Date().toISOString() },\n                                previousData: task,\n                              });\n                            }}\n                          >\n                            Postpone to tomorrow\n                          </DropdownMenuItem>\n                          <DropdownMenuItem\n                            className=\"cursor-pointer\"\n                            onClick={() => {\n                              const nextWeek = crmAddDays(new Date(), 7)?.toISOString();\n                              update(\"tasks\", {\n                                id: task.id,\n                                data: { due_date: nextWeek || new Date().toISOString() },\n                                previousData: task,\n                              });\n                            }}\n                          >\n                            Postpone to next week\n                          </DropdownMenuItem>\n                        </>\n                      )}\n                      <DropdownMenuItem className=\"cursor-pointer\" onClick={handleEdit}>\n                        Edit\n                      </DropdownMenuItem>\n                      <DropdownMenuItem\n                        className=\"cursor-pointer text-destructive\"\n                        onClick={handleDelete}\n                      >\n                        Delete\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n              </div>\n            </div>\n\n            {/* Footer Metadata */}\n            <div className=\"flex items-center gap-2 text-xs min-w-0\">\n              {dueDate && (\n                <div\n                  className={cn(\n                    \"flex items-center gap-1.5 whitespace-nowrap flex-shrink-0\",\n                    isOverdue && !isCompleted\n                      ? \"text-destructive font-medium\"\n                      : \"text-muted-foreground\",\n                  )}\n                >\n                  {isOverdue && !isCompleted && (\n                    <span className=\"w-1.5 h-1.5 rounded-full bg-destructive flex-shrink-0\" />\n                  )}\n                  <DateField source=\"due_date\" record={task} />\n                </div>\n              )}\n\n              {dueDate && showContact && (\n                <span className=\"text-muted-foreground/30 flex-shrink-0\">â€¢</span>\n              )}\n\n              {showContact && (\n                <div className=\"min-w-0 truncate\">\n                  <ReferenceField<TData, Contact>\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={task}\n                    link=\"show\"\n                    className=\"text-muted-foreground hover:underline truncate block\"\n                    render={({ referenceRecord }) => {\n                      if (!referenceRecord) return null;\n                      const fullName =\n                        `${referenceRecord?.first_name ?? \"\"} ${referenceRecord?.last_name ?? \"\"}`.trim() ||\n                        \"New Lead\";\n                      return (\n                        <span className=\"truncate block\" title={fullName}>\n                          {fullName}\n                        </span>\n                      );\n                    }}\n                  />\n                </div>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* This part is for editing the Task directly via a Dialog */}\n      {openEdit && (\n        <TaskEdit taskId={task.id} open={openEdit} close={handleCloseEdit} />\n      )}\n    </>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tasks/AddTask.tsx",
      "content": "import { Plus } from \"lucide-react\";\nimport {\n  CreateBase,\n  Form,\n  RecordRepresentation,\n  required,\n  useDataProvider,\n  useGetIdentity,\n  useNotify,\n  useRecordContext,\n  useUpdate,\n} from \"ra-core\";\nimport { useState } from \"react\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { useFormContext } from \"react-hook-form\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { ReferenceArrayInput } from \"@/components/admin/reference-array-input\";\nimport { AutocompleteArrayInput } from \"@/components/admin/autocomplete-array-input\";\nimport { DateInput } from \"@/components/admin/date-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport {\n  FormControl,\n  FormError,\n  FormField,\n  FormLabel,\n} from \"@/components/admin/form\";\nimport { FieldTitle, useInput, useResourceContext } from \"ra-core\";\nimport { InputHelperText } from \"@/components/admin/input-helper-text\";\n\nimport { contactOptionText } from \"../misc/ContactOption\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport {\n  crmDateInputString,\n  crmDateYmdInputString,\n  crmDateStringToISO,\n  crmStartOfDay,\n} from \"../misc/timezone\";\nimport { SmartTextInput } from \"../misc/SmartTextInput\";\nimport type { Sale } from \"../types\";\n\nexport const AddTask = ({\n  selectContact,\n  display = \"chip\",\n}: {\n  selectContact?: boolean;\n  display?: \"chip\" | \"icon\";\n}) => {\n  const { identity } = useGetIdentity();\n  const dataProvider = useDataProvider();\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const { taskTypes } = useConfigurationContext();\n  const contact = useRecordContext();\n  const [open, setOpen] = useState(false);\n  const queryClient = useQueryClient();\n  const handleOpen = () => {\n    setOpen(true);\n  };\n\n  const handleSuccess = async (data: any) => {\n    setOpen(false);\n    const contact = await dataProvider.getOne(\"contacts\", {\n      id: data.contact_id,\n    });\n    if (!contact.data) return;\n\n    await update(\"contacts\", {\n      id: contact.data.id,\n      data: { last_seen: new Date().toISOString() },\n      previousData: contact.data,\n    });\n\n    // Refresh activity log so the new task shows immediately (any scope)\n    queryClient.invalidateQueries({\n      predicate: ({ queryKey }) =>\n        Array.isArray(queryKey) && queryKey[0] === \"activityLog\",\n    });\n    notify(\"Task added\");\n  };\n\n  if (!identity) return null;\n\n  return (\n    <>\n      {display === \"icon\" ? (\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                size=\"sm\"\n                variant=\"ghost\"\n                className=\"p-2 cursor-pointer\"\n                onClick={handleOpen}\n              >\n                <Plus className=\"w-4 h-4\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>Create task</TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      ) : (\n        <div className=\"my-2\">\n          <Button\n            variant=\"outline\"\n            className=\"h-6 cursor-pointer\"\n            onClick={handleOpen}\n            size=\"sm\"\n          >\n            <Plus className=\"w-4 h-4\" />\n            Add task\n          </Button>\n        </div>\n      )}\n\n      <CreateBase\n        resource=\"tasks\"\n        record={{\n          type: \"None\",\n          contact_id: contact?.id,\n          // Keep due_date in form state as YYYY-MM-DD (matches <input type=\"date\">)\n          due_date: crmDateYmdInputString() || new Date().toISOString().slice(0, 10),\n          sales_id: identity.id,\n          // Explicitly omit tagged_user_ids from initial record to avoid schema cache issues\n        }}\n        transform={(data) => {\n          const rawText = String(data.text ?? \"\").trim();\n          const textWithoutDateHints = rawText\n            // relative phrases\n            .replace(/\\b(day\\s+after\\s+tomorrow|day\\s+after\\s+tmrw)\\b/gi, \"\")\n            .replace(/\\b(next\\s+week|next\\s+month)\\b/gi, \"\")\n            .replace(/\\b(in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)\\b/gi, \"\")\n            .replace(/\\b(today|tomorrow)\\b/gi, \"\")\n            // date literals\n            .replace(/\\b\\d{4}-\\d{2}-\\d{2}\\b/g, \"\")\n            .replace(/\\b\\d{1,2}\\/\\d{1,2}(?:\\/\\d{2,4})?\\b/g, \"\")\n            // cleanup whitespace/punctuation\n            .replace(/\\s{2,}/g, \" \")\n            .replace(/^[\\s,.;:-]+|[\\s,.;:-]+$/g, \"\")\n            .trim();\n          const cleanedText =\n            textWithoutDateHints.length > 0 ? textWithoutDateHints : rawText;\n\n          const dueDateIso =\n            crmDateStringToISO(data.due_date) ||\n            crmStartOfDay()?.toISOString() ||\n            data.due_date;\n          \n          // Build result object excluding problematic fields\n          const result: any = {\n            type: data.type,\n            contact_id: data.contact_id,\n            text: cleanedText,\n            due_date: dueDateIso,\n            sales_id: data.sales_id,\n          };\n          \n          // Only include tagged_user_ids if it's a valid non-empty array\n          // This avoids schema cache issues if the column doesn't exist in Supabase's cache yet\n          if (Array.isArray(data.tagged_user_ids) && data.tagged_user_ids.length > 0) {\n            result.tagged_user_ids = data.tagged_user_ids;\n          }\n          \n          // Explicitly do NOT include created_at or any other fields that might cause issues\n          return result;\n        }}\n        mutationOptions={{ onSuccess: handleSuccess }}\n      >\n        <Dialog open={open} onOpenChange={() => setOpen(false)}>\n          <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n            <Form className=\"flex flex-col gap-4\">\n              <DialogHeader>\n                <DialogTitle>\n                  {!selectContact\n                    ? \"Create a new task for \"\n                    : \"Create a new task\"}\n                  {!selectContact && contact && \n                   (() => {\n                     const firstName = contact.first_name?.trim();\n                     const lastName = contact.last_name?.trim();\n                     const validFirstName = firstName && firstName !== \"null\" && firstName !== \"\";\n                     const validLastName = lastName && lastName !== \"null\" && lastName !== \"\";\n                     \n                     if (validFirstName || validLastName) {\n                       const nameParts = [validFirstName ? firstName : null, validLastName ? lastName : null]\n                         .filter(Boolean)\n                         .join(\" \");\n                       return nameParts || \"this contact\";\n                     }\n                     return \"this contact\";\n                   })()}\n                </DialogTitle>\n                <DialogDescription>\n                  Add a new task with a description, due date, type, and optionally tag users.\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"flex flex-col gap-4\">\n                <TaskDescriptionInput />\n                {selectContact && (\n                  <ReferenceInput\n                    source=\"contact_id\"\n                    reference=\"contacts_summary\"\n                  >\n                    <AutocompleteInput\n                      label=\"Contact\"\n                      optionText={contactOptionText}\n                      helperText={false}\n                      validate={required()}\n                    />\n                  </ReferenceInput>\n                )}\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <DateInput\n                    source=\"due_date\"\n                    helperText={false}\n                    validate={required()}\n                  />\n                  <SelectInput\n                    source=\"type\"\n                    validate={required()}\n                    choices={taskTypes.map((type) => ({\n                      id: type,\n                      name: type,\n                    }))}\n                    helperText={false}\n                  />\n                </div>\n                <ReferenceArrayInput\n                  source=\"tagged_user_ids\"\n                  reference=\"sales\"\n                  filter={{ \"disabled@neq\": true }}\n                  sort={{ field: \"last_name\", order: \"ASC\" }}\n                >\n                  <AutocompleteArrayInput\n                    label=\"Tag users\"\n                    helperText={false}\n                    optionText={(choice: Sale) => `${choice.first_name} ${choice.last_name}`}\n                    placeholder=\"Search users to tag...\"\n                  />\n                </ReferenceArrayInput>\n              </div>\n              <DialogFooter className=\"w-full justify-end\">\n                <SaveButton />\n              </DialogFooter>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </CreateBase>\n    </>\n  );\n};\n\n// Component that wraps SmartTextInput with form integration\nconst TaskDescriptionInput = () => {\n  const resource = useResourceContext();\n  const { id, field, isRequired } = useInput({\n    source: \"text\",\n    validate: required(),\n  });\n  const { setValue } = useFormContext();\n\n  const handleDateDetected = (date: string) => {\n    // Update the due_date field when a date is detected\n    try {\n      const dateObj = new Date(date);\n      if (!isNaN(dateObj.getTime())) {\n        const dateStr = crmDateYmdInputString(dateObj);\n        if (dateStr) {\n          setValue(\"due_date\", dateStr, { shouldDirty: true, shouldValidate: false });\n        }\n      }\n    } catch (error) {\n      console.error(\"Error parsing date:\", error);\n    }\n  };\n\n  const handleUsersTagged = (userIds: number[]) => {\n    // Update the tagged_user_ids field when users are tagged\n    setValue(\"tagged_user_ids\", userIds.length > 0 ? userIds : undefined, { shouldDirty: true });\n  };\n\n  return (\n    <FormField id={id} className=\"m-0\" name={field.name}>\n      <FormLabel>\n        <FieldTitle\n          label=\"Description\"\n          source=\"text\"\n          resource={resource}\n          isRequired={isRequired}\n        />\n      </FormLabel>\n      <FormControl>\n        <SmartTextInput\n          value={field.value || \"\"}\n          onChange={field.onChange}\n          onBlur={field.onBlur}\n          multiline\n          placeholder=\"Type a task description. Try typing a date like 'tomorrow' or tag someone with @\"\n          className=\"m-0\"\n          onDateDetected={handleDateDetected}\n          onUsersTagged={handleUsersTagged}\n          autoFocus\n        />\n      </FormControl>\n      <InputHelperText helperText={false} />\n      <FormError />\n    </FormField>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/colors.ts",
      "content": "export const colors = [\n  \"#eddcd2\",\n  \"#fff1e6\",\n  \"#fde2e4\",\n  \"#fad2e1\",\n  \"#c5dedd\",\n  \"#dbe7e4\",\n  \"#f0efeb\",\n  \"#d6e2e9\",\n  \"#bcd4e6\",\n  \"#99c1de\",\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagEditModal.tsx",
      "content": "import { useUpdate } from \"ra-core\";\n\nimport type { Tag } from \"../types\";\nimport { TagDialog } from \"./TagDialog\";\n\ntype TagEditModalProps = {\n  tag: Tag;\n  open: boolean;\n  onClose(): void;\n  onSuccess?(tag: Tag): Promise<void>;\n};\n\nexport function TagEditModal({\n  tag,\n  open,\n  onClose,\n  onSuccess,\n}: TagEditModalProps) {\n  const [update] = useUpdate<Tag>();\n\n  const handleEditTag = async (data: Pick<Tag, \"name\" | \"color\">) => {\n    await update(\n      \"tags\",\n      { id: tag.id, data, previousData: tag },\n      {\n        onSuccess: async (tag) => {\n          await onSuccess?.(tag);\n        },\n      },\n    );\n  };\n\n  return (\n    <TagDialog\n      open={open}\n      title=\"Edit tag\"\n      onClose={onClose}\n      onSubmit={handleEditTag}\n      tag={tag}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagDialog.tsx",
      "content": "import { SaveIcon } from \"lucide-react\";\nimport { useEffect, useState, type ChangeEvent, type FormEvent } from \"react\";\nimport { Button, buttonVariants } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { cn } from \"@/lib/utils\";\n\nimport type { Tag } from \"../types\";\nimport { colors } from \"./colors\";\nimport { RoundButton } from \"./RoundButton\";\n\ntype TagDialogProps = {\n  open: boolean;\n  tag?: Pick<Tag, \"name\" | \"color\">;\n  title: string;\n  onSubmit(tag: Pick<Tag, \"name\" | \"color\">): Promise<void>;\n  onClose(): void;\n};\n\nexport function TagDialog({\n  open,\n  tag,\n  title,\n  onClose,\n  onSubmit,\n}: TagDialogProps) {\n  const [newTagName, setNewTagName] = useState(\"\");\n  const [newTagColor, setNewTagColor] = useState(colors[0]);\n  const [disabled, setDisabled] = useState(false);\n\n  const handleNewTagNameChange = (event: ChangeEvent<HTMLInputElement>) => {\n    setNewTagName(event.target.value);\n  };\n\n  const handleClose = () => {\n    setDisabled(false);\n    onClose();\n  };\n\n  const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n\n    await onSubmit({ name: newTagName, color: newTagColor });\n\n    setDisabled(true);\n    setNewTagName(\"\");\n    setNewTagColor(colors[0]);\n\n    handleClose();\n  };\n\n  useEffect(() => {\n    setNewTagName(tag?.name ?? \"\");\n    setNewTagColor(tag?.color ?? colors[0]);\n  }, [tag]);\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"sm:max-w-lg\">\n        <form onSubmit={handleSubmit}>\n          <DialogHeader>\n            <DialogTitle>{title}</DialogTitle>\n            <DialogDescription className=\"sr-only\">\n              {tag ? \"Edit tag name and color\" : \"Create a new tag with name and color\"}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"tag-name\">Tag name</Label>\n              <Input\n                id=\"tag-name\"\n                autoFocus\n                value={newTagName}\n                onChange={handleNewTagNameChange}\n                placeholder=\"Enter tag name\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Color</Label>\n              <div className=\"flex flex-wrap\">\n                {colors.map((color) => (\n                  <RoundButton\n                    key={color}\n                    color={color}\n                    selected={color === newTagColor}\n                    handleClick={() => {\n                      setNewTagColor(color);\n                    }}\n                  />\n                ))}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"flex justify-end pt-4\">\n            <Button\n              variant=\"outline\"\n              disabled={disabled}\n              className={cn(\n                buttonVariants({ variant: \"outline\" }),\n                \"text-primary\",\n                disabled ? \"opacity-50 cursor-not-allowed\" : \"cursor-pointer\",\n              )}\n            >\n              <SaveIcon />\n              Save\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagCreateModal.tsx",
      "content": "import { useCreate } from \"ra-core\";\n\nimport type { Tag } from \"../types\";\nimport { TagDialog } from \"./TagDialog\";\n\ntype TagCreateModalProps = {\n  open: boolean;\n  onClose(): void;\n  onSuccess?(tag: Tag): Promise<void>;\n};\n\nexport function TagCreateModal({\n  open,\n  onClose,\n  onSuccess,\n}: TagCreateModalProps) {\n  const [create] = useCreate<Tag>();\n\n  const handleCreateTag = async (data: Pick<Tag, \"name\" | \"color\">) => {\n    await create(\n      \"tags\",\n      { data },\n      {\n        onSuccess: async (tag) => {\n          await onSuccess?.(tag);\n        },\n      },\n    );\n  };\n\n  return (\n    <TagDialog\n      open={open}\n      title=\"Create a new tag\"\n      onClose={onClose}\n      onSubmit={handleCreateTag}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/TagChip.tsx",
      "content": "import { X } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport type { Tag } from \"../types\";\nimport { TagEditModal } from \"./TagEditModal\";\n\ntype TagChipProps = {\n  tag: Tag;\n\n  onUnlink: () => Promise<void>;\n};\n\nexport function TagChip({ tag, onUnlink }: TagChipProps) {\n  const [open, setOpen] = useState(false);\n\n  const handleClose = () => {\n    setOpen(false);\n  };\n\n  const handleClick = () => {\n    setOpen(true);\n  };\n\n  return (\n    <>\n      <div\n        className=\"text-black inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md cursor-pointer hover:opacity-80 transition-opacity\"\n        style={{ backgroundColor: tag.color }}\n        onClick={handleClick}\n      >\n        {tag.name}\n        <button\n          onClick={(e) => {\n            e.stopPropagation();\n            onUnlink();\n          }}\n          className=\"transition-colors p-0 ml-1 cursor-pointer\"\n        >\n          <X className=\"w-3 h-3\" />\n        </button>\n      </div>\n      <TagEditModal tag={tag} open={open} onClose={handleClose} />\n    </>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/tags/RoundButton.tsx",
      "content": "export const RoundButton = ({ color, handleClick, selected }: any) => (\n  <button\n    type=\"button\"\n    className={`w-8 h-8 rounded-full inline-block m-1 transition-all ${\n      selected ? \"ring-2 ring-gray-500 ring-offset-1\" : \"\"\n    }`}\n    style={{ backgroundColor: color }}\n    onClick={handleClick}\n  />\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/SimpleListLoading.tsx",
      "content": "import { useTimeout } from \"ra-core\";\nimport type { ReactNode } from \"react\";\n\nimport { ListPlaceholder } from \"./ListPlaceholder.tsx\";\n\nexport const SimpleListLoading = (props: SimpleListLoadingProps) => {\n  const {\n    className,\n    hasLeftAvatarOrIcon,\n    hasRightAvatarOrIcon,\n    hasSecondaryText,\n    hasTertiaryText,\n    nbFakeLines = 5,\n    ...rest\n  } = props;\n\n  const oneSecondHasPassed = useTimeout(1000);\n\n  return oneSecondHasPassed ? (\n    <ul className={className} {...rest}>\n      {times(nbFakeLines, (key) => (\n        <li key={key} className=\"flex items-center space-x-3 p-3\">\n          {hasLeftAvatarOrIcon && (\n            <div className=\"w-10 h-10 bg-gray-300 rounded-full flex-shrink-0\">\n              &nbsp;\n            </div>\n          )}\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"mb-1\">\n              <ListPlaceholder className=\"w-1/3 inline-block mb-1\" />\n              {hasTertiaryText && (\n                <span className=\"float-right opacity-55 min-w-[10vw]\">\n                  <ListPlaceholder />\n                </span>\n              )}\n            </div>\n            {hasSecondaryText && <ListPlaceholder className=\"w-1/4\" />}\n          </div>\n          {hasRightAvatarOrIcon && (\n            <div className=\"w-10 h-10 bg-gray-300 rounded-full flex-shrink-0\">\n              &nbsp;\n            </div>\n          )}\n        </li>\n      ))}\n    </ul>\n  ) : null;\n};\n\nconst times = (nbChildren: number, fn: (key: number) => ReactNode) =>\n  Array.from({ length: nbChildren }, (_, key) => fn(key));\n\nexport interface SimpleListLoadingProps {\n  className?: string;\n  hasLeftAvatarOrIcon?: boolean;\n  hasRightAvatarOrIcon?: boolean;\n  hasSecondaryText?: boolean;\n  hasTertiaryText?: boolean;\n  nbFakeLines?: number;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/SimpleListItem.tsx",
      "content": "import {\n  useEvent,\n  useGetPathForRecord,\n  useGetPathForRecordCallback,\n  useRecordContext,\n  useResourceContext,\n  type Identifier,\n  type LinkToType,\n  type RaRecord,\n} from \"ra-core\";\nimport type { CSSProperties, ReactElement, ReactNode } from \"react\";\nimport { Link, useNavigate } from \"react-router\";\n\nexport const SimpleListItem = <RecordType extends RaRecord = any>(\n  props: SimpleListItemProps<RecordType>,\n) => {\n  const { children, linkType, rowClick, style } = props;\n  const resource = useResourceContext(props);\n  const record = useRecordContext<RecordType>(props);\n  const navigate = useNavigate();\n  // If we don't have a function to get the path, we can compute the path immediately and set the href\n  // on the Link correctly without onClick (better for accessibility)\n  const isFunctionLink =\n    typeof linkType === \"function\" || typeof rowClick === \"function\";\n  const pathForRecord = useGetPathForRecord({\n    link: isFunctionLink ? false : (linkType ?? rowClick),\n    resource,\n  });\n  const getPathForRecord = useGetPathForRecordCallback();\n  const handleClick = useEvent(async () => {\n    // No need to handle non function linkType or rowClick\n    if (!isFunctionLink) return;\n    if (!record) return;\n\n    const link: LinkToType =\n      typeof linkType === \"function\"\n        ? linkType(record, record.id)\n        : typeof rowClick === \"function\"\n          ? (record, resource) => rowClick(record.id, resource, record)\n          : false;\n\n    const path = await getPathForRecord({\n      record,\n      resource,\n      link,\n    });\n    if (path === false || path == null) {\n      return;\n    }\n    navigate(path);\n  });\n\n  if (!record) return null;\n\n  if (isFunctionLink) {\n    return (\n      <li className=\"w-full\">\n        <button\n          onClick={handleClick}\n          style={style}\n          className=\"w-full text-left hover:bg-muted focus: bg-muted focus:outline-none\"\n        >\n          {children}\n        </button>\n      </li>\n    );\n  }\n\n  if (pathForRecord) {\n    return (\n      <li className=\"w-full\">\n        <Link\n          to={pathForRecord}\n          style={style}\n          className=\"block w-full hover:bg-muted focus:bg-muted focus:outline-none\"\n        >\n          {children}\n        </Link>\n      </li>\n    );\n  }\n\n  return <li className=\"w-full\">{children}</li>;\n};\n\nexport type FunctionToElement<RecordType extends RaRecord = any> = (\n  record: RecordType,\n  id: Identifier,\n) => ReactNode;\n\nexport type FunctionLinkType = (record: RaRecord, id: Identifier) => string;\n\nexport interface SimpleListBaseProps<RecordType extends RaRecord = any> {\n  leftAvatar?: FunctionToElement<RecordType>;\n  leftIcon?: FunctionToElement<RecordType>;\n  primaryText?: FunctionToElement<RecordType> | ReactElement | string;\n  /**\n   * @deprecated use rowClick instead\n   */\n  linkType?: string | FunctionLinkType | false;\n\n  /**\n   * The action to trigger when the user clicks on a row.\n   *\n   * @see https://marmelab.com/shadcn-admin-kit/docs/datatable/\n   * @example\n   * import { List, DataTable } from 'shadcn-admin-kit';\n   *\n   * export const PostList = () => (\n   *     <List>\n   *         <DataTable rowClick=\"edit\">\n   *             ...\n   *         </DataTable>                    </ListItem>\n\n   *     </List>\n   * );\n   */\n  rowClick?: string | RowClickFunction | false;\n  rightAvatar?: FunctionToElement<RecordType>;\n  rightIcon?: FunctionToElement<RecordType>;\n  secondaryText?: FunctionToElement<RecordType> | ReactElement | string;\n  tertiaryText?: FunctionToElement<RecordType> | ReactElement | string;\n}\n\nexport interface SimpleListItemProps<RecordType extends RaRecord = any>\n  extends SimpleListBaseProps<RecordType> {\n  rowIndex: number;\n  className?: string;\n  style?: CSSProperties;\n  children?: ReactNode;\n  resource?: string;\n}\n\nexport type RowClickFunction<RecordType extends RaRecord = RaRecord> = (\n  id: Identifier,\n  resource: string,\n  record: RecordType,\n) => string | false | Promise<string | false>;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/SimpleList.tsx",
      "content": "import {\n  ListIterator,\n  type RaRecord,\n  sanitizeListRestProps,\n  useGetRecordRepresentation,\n  useListContextWithProps,\n  useRecordContext,\n  useResourceContext,\n  useTranslate,\n} from \"ra-core\";\nimport { isValidElement, type ReactElement } from \"react\";\n\nimport { ListNoResults } from \"./ListNoResults.tsx\";\nimport type { FunctionToElement } from \"./SimpleListItem.tsx\";\nimport {\n  type SimpleListBaseProps,\n  SimpleListItem,\n  type SimpleListItemProps,\n} from \"./SimpleListItem.tsx\";\nimport { SimpleListLoading } from \"./SimpleListLoading.tsx\";\n\n/**\n * The <SimpleList> component renders a list of records\n * It is usually used as a child of shadcn-admin-kit's <List> and <ReferenceManyField> components.\n *\n * Also widely used on Mobile.\n *\n * Props:\n * - primaryText: function returning a React element (or some text) based on the record\n * - secondaryText: same\n * - tertiaryText: same\n * - leftAvatar: function returning a React element based on the record\n * - leftIcon: same\n * - rightAvatar: same\n * - rightIcon: same\n * - linkType: deprecated - 'edit' or 'show', or a function returning 'edit' or 'show' based on the record\n * - rowClick: The action to trigger when the user clicks on a row.\n * - rowStyle: function returning a style object based on (record, index)\n * - rowSx: function returning a sx object based on (record, index)\n *\n * @example // Display all posts as a List\n * const postRowSx = (record, index) => ({\n *     backgroundColor: record.views >= 500 ? '#efe' : 'white',\n * });\n * export const PostList = () => (\n *     <List>\n *         <SimpleList\n *             primaryText={record => record.title}\n *             secondaryText={record => `${record.views} views`}\n *             tertiaryText={record =>\n *                 new Date(record.published_at).toLocaleDateString()\n *             }\n *             rowSx={postRowSx}\n *          />\n *     </List>\n * );\n */\nexport const SimpleList = <RecordType extends RaRecord = any>(\n  props: SimpleListProps<RecordType>,\n) => {\n  const {\n    className,\n    empty = DefaultEmpty,\n    leftAvatar,\n    leftIcon,\n    linkType,\n    rowClick,\n    primaryText,\n    rightAvatar,\n    rightIcon,\n    secondaryText,\n    tertiaryText,\n    resource,\n    ...rest\n  } = props;\n  const { data, isPending, total } = useListContextWithProps<RecordType>(props);\n\n  if (isPending === true) {\n    return (\n      <SimpleListLoading\n        className={className}\n        hasLeftAvatarOrIcon={!!leftIcon || !!leftAvatar}\n        hasRightAvatarOrIcon={!!rightIcon || !!rightAvatar}\n        hasSecondaryText={!!secondaryText}\n        hasTertiaryText={!!tertiaryText}\n      />\n    );\n  }\n\n  if (data == null || data.length === 0 || total === 0) {\n    if (empty) {\n      return empty;\n    }\n\n    return null;\n  }\n\n  return (\n    <ul className={className} {...sanitizeListRestProps(rest)}>\n      <ListIterator<RecordType>\n        data={data}\n        total={total}\n        render={(record, rowIndex) => (\n          <SimpleListItem\n            key={record.id}\n            rowIndex={rowIndex}\n            linkType={linkType}\n            rowClick={rowClick}\n            resource={resource}\n          >\n            <SimpleListItemContent\n              leftAvatar={leftAvatar}\n              leftIcon={leftIcon}\n              primaryText={primaryText}\n              rightAvatar={rightAvatar}\n              rightIcon={rightIcon}\n              secondaryText={secondaryText}\n              tertiaryText={tertiaryText}\n              rowIndex={rowIndex}\n            />\n          </SimpleListItem>\n        )}\n      />\n    </ul>\n  );\n};\n\nexport interface SimpleListProps<RecordType extends RaRecord = any>\n  extends SimpleListBaseProps<RecordType> {\n  className?: string;\n  empty?: ReactElement;\n  // can be injected when using the component without context\n  resource?: string;\n  data?: RecordType[];\n  isLoading?: boolean;\n  isPending?: boolean;\n  isLoaded?: boolean;\n  total?: number;\n}\n\nconst SimpleListItemContent = <RecordType extends RaRecord = any>(\n  props: SimpleListItemProps<RecordType>,\n) => {\n  const {\n    leftAvatar,\n    leftIcon,\n    primaryText,\n    rightAvatar,\n    rightIcon,\n    secondaryText,\n    tertiaryText,\n  } = props;\n  const resource = useResourceContext(props);\n  const record = useRecordContext<RecordType>(props);\n  const getRecordRepresentation = useGetRecordRepresentation(resource);\n  const translate = useTranslate();\n\n  const renderAvatar = (\n    record: RecordType,\n    avatarCallback: FunctionToElement<RecordType>,\n  ) => {\n    const avatarValue = avatarCallback(record, record.id);\n    if (\n      typeof avatarValue === \"string\" &&\n      (avatarValue.startsWith(\"http\") || avatarValue.startsWith(\"data:\"))\n    ) {\n      return (\n        <img\n          src={avatarValue}\n          alt=\"\"\n          className=\"w-10 h-10 rounded-full object-cover\"\n        />\n      );\n    } else {\n      return (\n        <div className=\"w-10 h-10 rounded-full flex items-center justify-center text-sm\">\n          {avatarValue}\n        </div>\n      );\n    }\n  };\n\n  if (!record) return null;\n\n  return (\n    <div className=\"flex items-center space-x-3 p-3\">\n      {leftIcon && (\n        <div className=\"flex-shrink-0\">{leftIcon(record, record.id)}</div>\n      )}\n      {leftAvatar && (\n        <div className=\"flex-shrink-0\">{renderAvatar(record, leftAvatar)}</div>\n      )}\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"text-sm font-medium truncate\">\n            {primaryText\n              ? typeof primaryText === \"string\"\n                ? translate(primaryText, {\n                    ...record,\n                    _: primaryText,\n                  })\n                : isValidElement(primaryText)\n                  ? primaryText\n                  : primaryText(record, record.id)\n              : getRecordRepresentation(record)}\n          </div>\n\n          {!!tertiaryText && (\n            <div className=\"text-xs text-muted-foreground ml-2\">\n              {typeof tertiaryText === \"string\"\n                ? translate(tertiaryText, {\n                    ...record,\n                    _: tertiaryText,\n                  })\n                : isValidElement(tertiaryText)\n                  ? tertiaryText\n                  : tertiaryText(record, record.id)}\n            </div>\n          )}\n        </div>\n\n        {!!secondaryText && (\n          <div className=\"text-sm text-muted-foreground truncate\">\n            {typeof secondaryText === \"string\"\n              ? translate(secondaryText, {\n                  ...record,\n                  _: secondaryText,\n                })\n              : isValidElement(secondaryText)\n                ? secondaryText\n                : secondaryText(record, record.id)}\n          </div>\n        )}\n      </div>\n      {(rightAvatar || rightIcon) && (\n        <div className=\"flex-shrink-0 flex items-center space-x-2\">\n          {rightAvatar && renderAvatar(record, rightAvatar)}\n          {rightIcon && rightIcon(record, record.id)}\n        </div>\n      )}\n    </div>\n  );\n};\n\nconst DefaultEmpty = <ListNoResults />;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/ListPlaceholder.tsx",
      "content": "import { cn } from \"@/lib/utils\";\n\ninterface ListPlaceholderProps {\n  className?: string;\n}\n\nexport const ListPlaceholder = ({ className }: ListPlaceholderProps) => {\n  return <span className={cn(\"bg-gray-300 flex\", className)}>&nbsp;</span>;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/simple-list/ListNoResults.tsx",
      "content": "import {\n  useGetResourceLabel,\n  useListContextWithProps,\n  useResourceContext,\n  useTranslate,\n} from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\n\nexport const ListNoResults = (props: ListNoResultsProps) => {\n  const translate = useTranslate();\n  const resource = useResourceContext(props);\n  const { filterValues, setFilters } = useListContextWithProps(props);\n  const getResourceLabel = useGetResourceLabel();\n  if (!resource) {\n    throw new Error(\"<ListNoResults> must be used inside a <List> component\");\n  }\n  return (\n    <div className=\"p-6\">\n      <p className=\"text-sm text-muted-foreground\">\n        {filterValues && setFilters && Object.keys(filterValues).length > 0 ? (\n          <>\n            {translate(\"ra.navigation.no_filtered_results\", {\n              resource,\n              name: getResourceLabel(resource, 0),\n              _: \"No results found with the current filters.\",\n            })}{\" \"}\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setFilters({}, [])}\n            >\n              {translate(\"ra.navigation.clear_filters\", {\n                _: \"Clear filters\",\n              })}\n            </Button>\n          </>\n        ) : (\n          translate(\"ra.navigation.no_results\", {\n            resource,\n            name: getResourceLabel(resource, 0),\n            _: \"No results found.\",\n          })\n        )}\n      </p>\n    </div>\n  );\n};\n\nexport interface ListNoResultsProps {\n  resource?: string;\n  filterValues?: any;\n  setFilters?: (filters: any, filterTypes?: string[]) => void;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/settings/SettingsPage.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport { CircleX, Copy, Pencil, Save, Plus, Trash2, Edit } from \"lucide-react\";\nimport {\n  Form,\n  useDataProvider,\n  useGetIdentity,\n  useGetOne,\n  useNotify,\n  useRecordContext,\n  useGetList,\n  useCreate,\n  useUpdate,\n  useDelete,\n  type Identifier,\n} from \"ra-core\";\nimport { useState } from \"react\";\nimport * as React from \"react\";\nimport { useFormState } from \"react-hook-form\";\nimport { useNavigate } from \"react-router\";\nimport { RecordField } from \"@/components/admin/record-field\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Confirm } from \"@/components/admin/confirm\";\n\nimport ImageEditorField from \"../misc/ImageEditorField\";\nimport type { CrmDataProvider } from \"../providers/types\";\nimport type { Sale, SalesFormData, Tag, Service } from \"../types\";\nimport { TagCreateModal } from \"../tags/TagCreateModal\";\nimport { TagEditModal } from \"../tags/TagEditModal\";\nimport { TagChip } from \"../tags/TagChip\";\nimport { colors } from \"../tags/colors\";\nimport { RoundButton } from \"../tags/RoundButton\";\n\nexport const SettingsPage = () => {\n  const [isEditMode, setEditMode] = useState(false);\n  const { identity, refetch: refetchIdentity } = useGetIdentity();\n  const { data, refetch: refetchUser } = useGetOne(\"sales\", {\n    id: identity?.id,\n  });\n  const notify = useNotify();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n\n  const { mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      if (!identity) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.salesUpdate(identity.id, data);\n    },\n    onSuccess: () => {\n      refetchIdentity();\n      refetchUser();\n      setEditMode(false);\n      notify(\"Your profile has been updated\");\n    },\n    onError: (_) => {\n      notify(\"An error occurred. Please try again\", {\n        type: \"error\",\n      });\n    },\n  });\n\n  if (!identity) return null;\n\n  const handleOnSubmit = async (values: any) => {\n    mutate(values);\n  };\n\n  const isAdministrator = data?.administrator === true;\n\n  return (\n    <div className=\"max-w-6xl mx-auto mt-8 px-4\">\n      <Tabs defaultValue=\"profile\" className=\"w-full\">\n        <TabsList className={isAdministrator ? \"grid w-full grid-cols-4\" : \"grid w-full grid-cols-3\"}>\n          <TabsTrigger value=\"profile\">My Info</TabsTrigger>\n          <TabsTrigger value=\"tags\">Tags</TabsTrigger>\n          <TabsTrigger value=\"services\">Services</TabsTrigger>\n          {isAdministrator && (\n            <TabsTrigger value=\"users\">Users</TabsTrigger>\n          )}\n        </TabsList>\n\n        <TabsContent value=\"profile\" className=\"mt-6\">\n          <Form onSubmit={handleOnSubmit} record={data}>\n            <SettingsForm isEditMode={isEditMode} setEditMode={setEditMode} />\n          </Form>\n        </TabsContent>\n\n        <TabsContent value=\"tags\" className=\"mt-6\">\n          <TagsManagementSection />\n        </TabsContent>\n\n        <TabsContent value=\"services\" className=\"mt-6\">\n          <ServicesManagementSection />\n        </TabsContent>\n\n        {isAdministrator && (\n          <TabsContent value=\"users\" className=\"mt-6\">\n            <UsersManagementSection />\n          </TabsContent>\n        )}\n      </Tabs>\n    </div>\n  );\n};\n\nconst SettingsForm = ({\n  isEditMode,\n  setEditMode,\n}: {\n  isEditMode: boolean;\n  setEditMode: (value: boolean) => void;\n}) => {\n  const notify = useNotify();\n  const record = useRecordContext<Sale>();\n  const { identity, refetch } = useGetIdentity();\n  const { isDirty } = useFormState();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n\n  const { mutate: updatePassword } = useMutation({\n    mutationKey: [\"updatePassword\"],\n    mutationFn: async () => {\n      if (!identity) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.updatePassword(identity.id);\n    },\n    onSuccess: () => {\n      notify(\"A reset password email has been sent to your email address\");\n    },\n    onError: (e) => {\n      notify(`${e}`, {\n        type: \"error\",\n      });\n    },\n  });\n\n  const { mutate: mutateSale } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      if (!record) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.salesUpdate(record.id, data);\n    },\n    onSuccess: () => {\n      refetch();\n      notify(\"Your profile has been updated\");\n    },\n    onError: () => {\n      notify(\"An error occurred. Please try again.\");\n    },\n  });\n  if (!identity) return null;\n\n  const handleClickOpenPasswordChange = () => {\n    updatePassword();\n  };\n\n  const handleAvatarUpdate = async (values: any) => {\n    mutateSale(values);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardContent>\n          <div className=\"mb-4 flex flex-row justify-between\">\n            <h2 className=\"text-xl font-semibold text-muted-foreground\">\n              My info\n            </h2>\n          </div>\n\n          <div className=\"space-y-4 mb-4\">\n            <ImageEditorField\n              source=\"avatar\"\n              type=\"avatar\"\n              onSave={handleAvatarUpdate}\n              linkPosition=\"right\"\n            />\n            <TextRender source=\"first_name\" isEditMode={isEditMode} />\n            <TextRender source=\"last_name\" isEditMode={isEditMode} />\n            <TextRender source=\"email\" isEditMode={isEditMode} />\n          </div>\n\n          <div className=\"flex flex-row justify-end gap-2\">\n            {!isEditMode && (\n              <>\n                <Button\n                  variant=\"outline\"\n                  type=\"button\"\n                  onClick={handleClickOpenPasswordChange}\n                >\n                  Change password\n                </Button>\n              </>\n            )}\n\n            <Button\n              type=\"button\"\n              variant={isEditMode ? \"ghost\" : \"outline\"}\n              onClick={() => setEditMode(!isEditMode)}\n              className=\"flex items-center\"\n            >\n              {isEditMode ? <CircleX /> : <Pencil />}\n              {isEditMode ? \"Cancel\" : \"Edit\"}\n            </Button>\n\n            {isEditMode && (\n              <Button type=\"submit\" disabled={!isDirty} variant=\"outline\">\n                <Save />\n                Save\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n      {import.meta.env.VITE_INBOUND_EMAIL && (\n        <Card>\n          <CardContent>\n            <div className=\"space-y-4 justify-between\">\n              <h2 className=\"text-xl font-semibold text-muted-foreground\">\n                Inbound email\n              </h2>\n              <p className=\"text-sm text-muted-foreground\">\n                You can start sending emails to your server's inbound email\n                address, e.g. by adding it to the\n                <b> Cc: </b> field. BestDOC CRM will process the emails and add\n                notes to the corresponding contacts.\n              </p>\n              <CopyPaste />\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n};\n\nconst TextRender = ({\n  source,\n  isEditMode,\n}: {\n  source: string;\n  isEditMode: boolean;\n}) => {\n  if (isEditMode) {\n    return <TextInput source={source} helperText={false} />;\n  }\n  return (\n    <div className=\"m-2\">\n      <RecordField source={source} />\n    </div>\n  );\n};\n\nconst CopyPaste = () => {\n  const [copied, setCopied] = useState(false);\n  const handleCopy = () => {\n    setCopied(true);\n    navigator.clipboard.writeText(import.meta.env.VITE_INBOUND_EMAIL);\n    setTimeout(() => {\n      setCopied(false);\n    }, 1500);\n  };\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Button\n            type=\"button\"\n            onClick={handleCopy}\n            variant=\"ghost\"\n            className=\"normal-case justify-between w-full\"\n          >\n            <span className=\"overflow-hidden text-ellipsis\">\n              {import.meta.env.VITE_INBOUND_EMAIL}\n            </span>\n            <Copy className=\"h-4 w-4 ml-2\" />\n          </Button>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p>{copied ? \"Copied!\" : \"Copy\"}</p>\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  );\n};\n\n// Tags Management Section\nconst TagsManagementSection = () => {\n  const notify = useNotify();\n  const { data: tags, isLoading, refetch } = useGetList<Tag>(\"tags\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const [create] = useCreate<Tag>();\n  const [update] = useUpdate<Tag>();\n  const [deleteTag] = useDelete();\n  const [createModalOpen, setCreateModalOpen] = useState(false);\n  const [editModalOpen, setEditModalOpen] = useState(false);\n  const [selectedTag, setSelectedTag] = useState<Tag | null>(null);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [tagToDelete, setTagToDelete] = useState<Tag | null>(null);\n\n  const handleCreateSuccess = async () => {\n    setCreateModalOpen(false);\n    refetch();\n    notify(\"Tag created successfully\");\n  };\n\n  const handleEditClick = (tag: Tag) => {\n    setSelectedTag(tag);\n    setEditModalOpen(true);\n  };\n\n  const handleEditSuccess = async () => {\n    setEditModalOpen(false);\n    setSelectedTag(null);\n    refetch();\n    notify(\"Tag updated successfully\");\n  };\n\n  const handleDeleteClick = (tag: Tag) => {\n    setTagToDelete(tag);\n    setDeleteDialogOpen(true);\n  };\n\n  const handleDeleteConfirm = async (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (tagToDelete) {\n      await deleteTag(\"tags\", { id: tagToDelete.id });\n      setDeleteDialogOpen(false);\n      setTagToDelete(null);\n      refetch();\n      notify(\"Tag deleted successfully\");\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex justify-between items-center\">\n          <CardTitle>Tags Management</CardTitle>\n          <Button onClick={() => setCreateModalOpen(true)}>\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add Tag\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n        ) : tags && tags.length > 0 ? (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Name</TableHead>\n                <TableHead>Color</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {tags.map((tag) => (\n                <TableRow key={tag.id}>\n                  <TableCell>{tag.name}</TableCell>\n                  <TableCell>\n                    <TagChip tag={tag} />\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleEditClick(tag)}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleDeleteClick(tag)}\n                      >\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            No tags found. Create your first tag!\n          </div>\n        )}\n\n        <TagCreateModal\n          open={createModalOpen}\n          onClose={() => setCreateModalOpen(false)}\n          onSuccess={handleCreateSuccess}\n        />\n\n        {selectedTag && (\n          <TagEditModal\n            tag={selectedTag}\n            open={editModalOpen}\n            onClose={() => {\n              setEditModalOpen(false);\n              setSelectedTag(null);\n            }}\n            onSuccess={handleEditSuccess}\n          />\n        )}\n\n        <Confirm\n          isOpen={deleteDialogOpen}\n          loading={false}\n          title=\"Delete Tag\"\n          content={`Are you sure you want to delete the tag \"${tagToDelete?.name}\"? This action cannot be undone.`}\n          confirm=\"Delete\"\n          cancel=\"Cancel\"\n          confirmColor=\"warning\"\n          onClose={() => setDeleteDialogOpen(false)}\n          onConfirm={handleDeleteConfirm}\n        />\n      </CardContent>\n    </Card>\n  );\n};\n\n// Services Management Section\nconst ServicesManagementSection = () => {\n  const notify = useNotify();\n  const { data: services, isLoading, refetch } = useGetList<Service>(\"services\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const [create] = useCreate<Service>();\n  const [update] = useUpdate<Service>();\n  const [deleteService] = useDelete();\n  const [createDialogOpen, setCreateDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedService, setSelectedService] = useState<Service | null>(null);\n  const [serviceToDelete, setServiceToDelete] = useState<Service | null>(null);\n  const [serviceName, setServiceName] = useState(\"\");\n\n  const handleCreate = async () => {\n    if (!serviceName.trim()) {\n      notify(\"Service name is required\", { type: \"error\" });\n      return;\n    }\n    await create(\"services\", { data: { name: serviceName.trim() } });\n    setServiceName(\"\");\n    setCreateDialogOpen(false);\n    refetch();\n    notify(\"Service created successfully\");\n  };\n\n  const handleEditClick = (service: Service) => {\n    setSelectedService(service);\n    setServiceName(service.name);\n    setEditDialogOpen(true);\n  };\n\n  const handleUpdate = async () => {\n    if (!serviceName.trim() || !selectedService) {\n      notify(\"Service name is required\", { type: \"error\" });\n      return;\n    }\n    await update(\"services\", {\n      id: selectedService.id,\n      data: { name: serviceName.trim() },\n      previousData: selectedService,\n    });\n    setServiceName(\"\");\n    setSelectedService(null);\n    setEditDialogOpen(false);\n    refetch();\n    notify(\"Service updated successfully\");\n  };\n\n  const handleDeleteClick = (service: Service) => {\n    setServiceToDelete(service);\n    setDeleteDialogOpen(true);\n  };\n\n  const handleDeleteConfirm = async (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (serviceToDelete) {\n      await deleteService(\"services\", { id: serviceToDelete.id });\n      setDeleteDialogOpen(false);\n      setServiceToDelete(null);\n      refetch();\n      notify(\"Service deleted successfully\");\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex justify-between items-center\">\n          <CardTitle>Services Management</CardTitle>\n          <Button onClick={() => setCreateDialogOpen(true)}>\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add Service\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n        ) : services && services.length > 0 ? (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Name</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {services.map((service) => (\n                <TableRow key={service.id}>\n                  <TableCell>{service.name}</TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleEditClick(service)}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleDeleteClick(service)}\n                      >\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            No services found. Create your first service!\n          </div>\n        )}\n\n        {/* Create Service Dialog */}\n        <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Create Service</DialogTitle>\n              <DialogDescription>\n                Add a new service to the system.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"service-name\">Service Name</Label>\n                <Input\n                  id=\"service-name\"\n                  value={serviceName}\n                  onChange={(e) => setServiceName(e.target.value)}\n                  placeholder=\"Enter service name\"\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\") {\n                      e.preventDefault();\n                      handleCreate();\n                    }\n                  }}\n                />\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button variant=\"outline\" onClick={() => setCreateDialogOpen(false)}>\n                Cancel\n              </Button>\n              <Button onClick={handleCreate}>\n                <Save className=\"h-4 w-4 mr-2\" />\n                Create\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Edit Service Dialog */}\n        <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Edit Service</DialogTitle>\n              <DialogDescription>\n                Update the service name.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-service-name\">Service Name</Label>\n                <Input\n                  id=\"edit-service-name\"\n                  value={serviceName}\n                  onChange={(e) => setServiceName(e.target.value)}\n                  placeholder=\"Enter service name\"\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\") {\n                      e.preventDefault();\n                      handleUpdate();\n                    }\n                  }}\n                />\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setEditDialogOpen(false);\n                  setSelectedService(null);\n                  setServiceName(\"\");\n                }}\n              >\n                Cancel\n              </Button>\n              <Button onClick={handleUpdate}>\n                <Save className=\"h-4 w-4 mr-2\" />\n                Update\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Delete Service Dialog */}\n        <Confirm\n          isOpen={deleteDialogOpen}\n          loading={false}\n          title=\"Delete Service\"\n          content={`Are you sure you want to delete the service \"${serviceToDelete?.name}\"? This action cannot be undone.`}\n          confirm=\"Delete\"\n          cancel=\"Cancel\"\n          confirmColor=\"warning\"\n          onClose={() => setDeleteDialogOpen(false)}\n          onConfirm={handleDeleteConfirm}\n        />\n      </CardContent>\n    </Card>\n  );\n};\n\n// Users Management Section\nconst UsersManagementSection = () => {\n  const notify = useNotify();\n  const navigate = useNavigate();\n  const { identity } = useGetIdentity();\n  const { data: users, isLoading, refetch } = useGetList<Sale>(\"sales\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"first_name\", order: \"ASC\" },\n  });\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [userToDelete, setUserToDelete] = useState<Sale | null>(null);\n  const [deleteUser] = useDelete();\n\n  const handleDeleteClick = (user: Sale) => {\n    setUserToDelete(user);\n    setDeleteDialogOpen(true);\n  };\n\n  const handleDeleteConfirm = async (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (userToDelete) {\n      await deleteUser(\"sales\", { id: userToDelete.id });\n      setDeleteDialogOpen(false);\n      setUserToDelete(null);\n      refetch();\n      notify(\"User deleted successfully\");\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex justify-between items-center\">\n          <CardTitle>Users Management</CardTitle>\n          <Button onClick={() => navigate(\"/sales/create\")}>\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add User\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n        ) : users && users.length > 0 ? (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Name</TableHead>\n                <TableHead>Email</TableHead>\n                <TableHead>Role</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {users.map((user) => (\n                <TableRow key={user.id}>\n                  <TableCell>\n                    {user.first_name} {user.last_name}\n                  </TableCell>\n                  <TableCell>{user.email}</TableCell>\n                  <TableCell>\n                    {user.administrator ? (\n                      <Badge variant=\"secondary\">Administrator</Badge>\n                    ) : (\n                      <Badge variant=\"outline\">User</Badge>\n                    )}\n                  </TableCell>\n                  <TableCell>\n                    {user.disabled ? (\n                      <Badge variant=\"destructive\">Disabled</Badge>\n                    ) : (\n                      <Badge variant=\"default\">Active</Badge>\n                    )}\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => navigate(`/sales/${user.id}`)}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                      {user.id !== identity?.id && (\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => handleDeleteClick(user)}\n                        >\n                          <Trash2 className=\"h-4 w-4 text-destructive\" />\n                        </Button>\n                      )}\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            No users found. Create your first user!\n          </div>\n        )}\n\n        <Confirm\n          isOpen={deleteDialogOpen}\n          loading={false}\n          title=\"Delete User\"\n          content={`Are you sure you want to delete the user \"${userToDelete?.first_name} ${userToDelete?.last_name}\"? This action cannot be undone.`}\n          confirm=\"Delete\"\n          cancel=\"Cancel\"\n          confirmColor=\"warning\"\n          onClose={() => setDeleteDialogOpen(false)}\n          onConfirm={handleDeleteConfirm}\n        />\n      </CardContent>\n    </Card>\n  );\n};\n\nSettingsPage.path = \"/settings\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/index.ts",
      "content": "import type { Service } from \"../types\";\nimport { ServiceCreate } from \"./ServiceCreate\";\nimport { ServiceEdit } from \"./ServiceEdit\";\nimport { ServiceList } from \"./ServiceList\";\n\nexport default {\n  list: ServiceList,\n  create: ServiceCreate,\n  edit: ServiceEdit,\n  recordRepresentation: (record: Service) => record.name,\n};\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/ServiceList.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\nimport { DataTable } from \"@/components/admin/data-table\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\n\nconst filters = [<SearchInput key=\"service-search\" source=\"q\" alwaysOn />];\n\nconst ServiceListActions = () => (\n  <TopToolbar>\n    <ExportButton />\n    <CreateButton label=\"New service\" />\n  </TopToolbar>\n);\n\nexport const ServiceList = () => {\n  return (\n    <List filters={filters} actions={<ServiceListActions />}>\n      <DataTable>\n        <DataTable.Col source=\"name\" label=\"Service\" />\n        <DataTable.Col\n          source=\"created_at\"\n          label=\"Created\"\n          field={DateField}\n          headerClassName=\"text-right\"\n          cellClassName=\"text-right\"\n        />\n      </DataTable>\n    </List>\n  );\n};\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/ServiceInputs.tsx",
      "content": "import { required } from \"ra-core\";\nimport { TextInput } from \"@/components/admin/text-input\";\n\nexport const ServiceInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <TextInput\n        source=\"name\"\n        label=\"Service name\"\n        validate={required()}\n        helperText={false}\n      />\n    </div>\n  );\n};\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/ServiceEdit.tsx",
      "content": "import { EditBase, Form } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport { ServiceInputs } from \"./ServiceInputs\";\n\nexport const ServiceEdit = () => {\n  return (\n    <EditBase redirect=\"list\">\n      <div className=\"max-w-lg w-full mx-auto mt-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Edit service</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Form className=\"flex flex-col gap-4\">\n              <ServiceInputs />\n              <FormToolbar>\n                <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n                  <DeleteButton redirect=\"list\" />\n                  <div className=\"flex flex-row gap-2 justify-end\">\n                    <CancelButton />\n                    <SaveButton />\n                  </div>\n                </div>\n              </FormToolbar>\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </EditBase>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/services/ServiceCreate.tsx",
      "content": "import { CreateBase, Form } from \"ra-core\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport { ServiceInputs } from \"./ServiceInputs\";\n\nexport const ServiceCreate = () => {\n  return (\n    <CreateBase redirect=\"list\">\n      <div className=\"max-w-lg w-full mx-auto mt-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Create service</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Form className=\"flex flex-col gap-4\">\n              <ServiceInputs />\n              <FormToolbar />\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </CreateBase>\n  );\n};\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/index.ts",
      "content": "import type { Sale } from \"../types\";\nimport { SalesCreate } from \"./SalesCreate\";\nimport { SalesEdit } from \"./SalesEdit\";\nimport { SalesList } from \"./SalesList\";\n\nexport default {\n  list: SalesList,\n  create: SalesCreate,\n  edit: SalesEdit,\n  recordRepresentation: (record: Sale) =>\n    `${record.first_name} ${record.last_name}`,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesList.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { DataTable } from \"@/components/admin/data-table\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\n\nimport { TopToolbar } from \"../layout/TopToolbar\";\n\nconst SalesListActions = () => (\n  <TopToolbar>\n    <ExportButton />\n    <CreateButton label=\"New user\" />\n  </TopToolbar>\n);\n\nconst filters = [<SearchInput source=\"q\" alwaysOn />];\n\nconst OptionsField = (_props: { label?: string | boolean }) => {\n  const record = useRecordContext();\n  if (!record) return null;\n  return (\n    <div className=\"flex flex-row gap-1\">\n      {record.administrator && (\n        <Badge\n          variant=\"outline\"\n          className=\"border-blue-300 dark:border-blue-700\"\n        >\n          Admin\n        </Badge>\n      )}\n      {record.disabled && (\n        <Badge\n          variant=\"outline\"\n          className=\"border-orange-300 dark:border-orange-700\"\n        >\n          Disabled\n        </Badge>\n      )}\n    </div>\n  );\n};\n\nexport function SalesList() {\n  return (\n    <List\n      filters={filters}\n      actions={<SalesListActions />}\n      sort={{ field: \"first_name\", order: \"ASC\" }}\n    >\n      <DataTable>\n        <DataTable.Col source=\"first_name\" />\n        <DataTable.Col source=\"last_name\" />\n        <DataTable.Col source=\"email\" />\n        <DataTable.Col label={false}>\n          <OptionsField />\n        </DataTable.Col>\n      </DataTable>\n    </List>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesInputs.tsx",
      "content": "import { email, required, useGetIdentity, useRecordContext } from \"ra-core\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\n\nimport type { Sale } from \"../types\";\n\nexport function SalesInputs({ showPassword = false }: { showPassword?: boolean }) {\n  const { identity } = useGetIdentity();\n  const record = useRecordContext<Sale>();\n  return (\n    <div className=\"space-y-4 w-full\">\n      <TextInput source=\"first_name\" validate={required()} helperText={false} />\n      <TextInput source=\"last_name\" validate={required()} helperText={false} />\n      <TextInput\n        source=\"email\"\n        validate={[required(), email()]}\n        helperText={false}\n      />\n      {showPassword && (\n        <TextInput\n          source=\"password\"\n          type=\"password\"\n          helperText=\"Optional. If blank, the user will receive an email to set their password.\"\n        />\n      )}\n      <BooleanInput\n        source=\"administrator\"\n        readOnly={record?.id === identity?.id}\n        helperText={false}\n      />\n      <BooleanInput\n        source=\"disabled\"\n        readOnly={record?.id === identity?.id}\n        helperText={false}\n      />\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesEdit.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport {\n  useDataProvider,\n  useEditController,\n  useNotify,\n  useRecordContext,\n  useRedirect,\n} from \"ra-core\";\nimport type { SubmitHandler } from \"react-hook-form\";\nimport { SimpleForm } from \"@/components/admin/simple-form\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport type { Sale, SalesFormData } from \"../types\";\nimport { SalesInputs } from \"./SalesInputs\";\n\nfunction EditToolbar() {\n  return (\n    <div className=\"flex justify-end gap-4\">\n      <CancelButton />\n      <SaveButton />\n    </div>\n  );\n}\n\nexport function SalesEdit() {\n  const { record } = useEditController();\n\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n\n  const { mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      if (!record) {\n        throw new Error(\"Record not found\");\n      }\n      return dataProvider.salesUpdate(record.id, data);\n    },\n    onSuccess: () => {\n      redirect(\"/sales\");\n      notify(\"User updated successfully\");\n    },\n    onError: () => {\n      notify(\"An error occurred. Please try again.\");\n    },\n  });\n\n  const onSubmit: SubmitHandler<SalesFormData> = async (data) => {\n    mutate(data);\n  };\n\n  return (\n    <div className=\"max-w-lg w-full mx-auto mt-8\">\n      <Card>\n        <CardContent>\n          <SimpleForm\n            toolbar={<EditToolbar />}\n            onSubmit={onSubmit as SubmitHandler<any>}\n            record={record}\n          >\n            <SaleEditTitle />\n            <SalesInputs />\n          </SimpleForm>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nconst SaleEditTitle = () => {\n  const record = useRecordContext<Sale>();\n  if (!record) return null;\n  return (\n    <h2 className=\"text-lg font-semibold mb-4\">\n      Edit {record?.first_name} {record?.last_name}\n    </h2>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SalesCreate.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport { useDataProvider, useNotify, useRedirect } from \"ra-core\";\nimport type { SubmitHandler } from \"react-hook-form\";\nimport { SimpleForm } from \"@/components/admin/simple-form\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport type { SalesFormData } from \"../types\";\nimport { SalesInputs } from \"./SalesInputs\";\n\nexport function SalesCreate() {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n\n  const { mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SalesFormData) => {\n      return dataProvider.salesCreate(data);\n    },\n    onSuccess: (_data, variables) => {\n      const passwordProvided =\n        typeof variables?.password === \"string\" &&\n        variables.password.trim().length > 0;\n      notify(\n        passwordProvided\n          ? \"User created. Password was set.\"\n          : \"User created. They will soon receive an email to set their password.\",\n      );\n      redirect(\"/sales\");\n    },\n    onError: () => {\n      notify(\"An error occurred while creating the user.\", {\n        type: \"error\",\n      });\n    },\n  });\n  const onSubmit: SubmitHandler<SalesFormData> = async (data) => {\n    mutate(data);\n  };\n\n  return (\n    <div className=\"max-w-lg w-full mx-auto mt-8\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Create a new user</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <SimpleForm onSubmit={onSubmit as SubmitHandler<any>}>\n            <SalesInputs showPassword />\n          </SimpleForm>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/sales/SaleName.tsx",
      "content": "import { useGetIdentity, useRecordContext } from \"ra-core\";\n\nimport type { Sale } from \"../types\";\n\nexport const SaleName = ({ sale }: { sale?: Sale }) => {\n  const { identity, isPending } = useGetIdentity();\n  const saleFromContext = useRecordContext<Sale>();\n  const finalSale = sale || saleFromContext;\n  if (isPending || !finalSale) return null;\n  return finalSale.id === identity?.id\n    ? \"You\"\n    : `${finalSale.first_name} ${finalSale.last_name}`;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/i18nProvider.tsx",
      "content": "import { mergeTranslations } from \"ra-core\";\nimport polyglotI18nProvider from \"ra-i18n-polyglot\";\nimport englishMessages from \"ra-language-english\";\nimport { raSupabaseEnglishMessages } from \"ra-supabase-language-english\";\n\nconst raSupabaseEnglishMessagesOverride = {\n  \"ra-supabase\": {\n    auth: {\n      password_reset: \"Check your emails for a Reset Password message.\",\n    },\n  },\n};\n\nexport const i18nProvider = polyglotI18nProvider(\n  () => {\n    return mergeTranslations(\n      englishMessages,\n      raSupabaseEnglishMessages,\n      raSupabaseEnglishMessagesOverride,\n    );\n  },\n  \"en\",\n  [{ locale: \"en\", name: \"English\" }],\n  { allowMissing: true },\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/defaultConfiguration.ts",
      "content": "import { Mars, NonBinary, Venus } from \"lucide-react\";\n\nexport const defaultDarkModeLogo = \"./logos/logo_bestdoc_crm_dark.svg\";\nexport const defaultLightModeLogo = \"./logos/logo_bestdoc_crm_light.svg\";\n\nexport const defaultTitle = \"BestDOC Tasks\";\n\nexport const defaultCompanySectors = [\n  \"Communication Services\",\n  \"Consumer Discretionary\",\n  \"Consumer Staples\",\n  \"Energy\",\n  \"Financials\",\n  \"Health Care\",\n  \"Industrials\",\n  \"Information Technology\",\n  \"Materials\",\n  \"Real Estate\",\n  \"Utilities\",\n];\n\nexport const defaultDealStages = [\n  { value: \"opportunity\", label: \"Opportunity\" },\n  { value: \"proposal-sent\", label: \"Proposal Sent\" },\n  { value: \"in-negociation\", label: \"In Negotiation\" },\n  { value: \"won\", label: \"Won\" },\n  { value: \"lost\", label: \"Lost\" },\n  { value: \"delayed\", label: \"Delayed\" },\n];\n\nexport const defaultDealPipelineStatuses = [\"won\"];\n\nexport const defaultDealCategories = [\n  \"Other\",\n  \"Copywriting\",\n  \"Print project\",\n  \"UI Design\",\n  \"Website design\",\n];\n\nexport const defaultNoteStatuses = [\n  { value: \"cold\", label: \"Cold\", color: \"#7dbde8\" },\n  { value: \"warm\", label: \"Warm\", color: \"#e8cb7d\" },\n  { value: \"hot\", label: \"Hot\", color: \"#e88b7d\" },\n  { value: \"in-contract\", label: \"In Contract\", color: \"#a4e87d\" },\n];\n\nexport const defaultTaskTypes = [\n  \"None\",\n  \"Email\",\n  \"Demo\",\n  \"Lunch\",\n  \"Meeting\",\n  \"Follow-up\",\n  \"Thank you\",\n  \"Ship\",\n  \"Call\",\n];\n\nexport const defaultContactGender = [\n  { value: \"male\", label: \"Male\", icon: Mars },\n  { value: \"female\", label: \"Female\", icon: Venus },\n  { value: \"nonbinary\", label: \"Non-binary\", icon: NonBinary },\n];\n\nexport const defaultServices = [\n  \"Doctor on Call\",\n  \"Teleconsultation\",\n  \"Physiotherapy\",\n  \"Nurse on Call\",\n  \"Blood Test\",\n  \"IV Therapy\",\n  \"Nanny\",\n  \"Elderly Care\",\n];\n\nexport const defaultLeadStages = [\n  { value: \"new\", label: \"New\" },\n  { value: \"contacted\", label: \"Contacted\" },\n  { value: \"quoted\", label: \"Quoted\" },\n  { value: \"qualified\", label: \"Qualified\" },\n  { value: \"not-qualified\", label: \"Not Qualified\" },\n  { value: \"converted\", label: \"Converted\" },\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/ConfigurationContext.tsx",
      "content": "import { createContext, useContext, type ReactNode } from \"react\";\n\nimport type { ContactGender, DealStage, NoteStatus } from \"../types\";\nimport {\n  defaultCompanySectors,\n  defaultContactGender,\n  defaultDarkModeLogo,\n  defaultDealCategories,\n  defaultDealPipelineStatuses,\n  defaultDealStages,\n  defaultLightModeLogo,\n  defaultNoteStatuses,\n  defaultTaskTypes,\n  defaultTitle,\n  defaultServices,\n  defaultLeadStages,\n} from \"./defaultConfiguration\";\n\n// Define types for the context value\nexport interface ConfigurationContextValue {\n  companySectors: string[];\n  dealCategories: string[];\n  dealPipelineStatuses: string[];\n  dealStages: DealStage[];\n  leadStages: DealStage[];\n  noteStatuses: NoteStatus[];\n  taskTypes: string[];\n  title: string;\n  darkModeLogo: string;\n  lightModeLogo: string;\n  contactGender: ContactGender[];\n  services: string[];\n}\n\nexport interface ConfigurationProviderProps extends ConfigurationContextValue {\n  children: ReactNode;\n}\n\n// Create context with default value\nexport const ConfigurationContext = createContext<ConfigurationContextValue>({\n  companySectors: defaultCompanySectors,\n  dealCategories: defaultDealCategories,\n  dealPipelineStatuses: defaultDealPipelineStatuses,\n  dealStages: defaultDealStages,\n  leadStages: defaultLeadStages,\n  noteStatuses: defaultNoteStatuses,\n  taskTypes: defaultTaskTypes,\n  title: defaultTitle,\n  darkModeLogo: defaultDarkModeLogo,\n  lightModeLogo: defaultLightModeLogo,\n  contactGender: defaultContactGender,\n  services: defaultServices,\n});\n\nexport const ConfigurationProvider = ({\n  children,\n  companySectors,\n  dealCategories,\n  dealPipelineStatuses,\n  dealStages,\n  leadStages,\n  darkModeLogo,\n  lightModeLogo,\n  noteStatuses,\n  taskTypes,\n  title,\n  contactGender,\n  services,\n}: ConfigurationProviderProps) => (\n  <ConfigurationContext.Provider\n    value={{\n      companySectors,\n      dealCategories,\n      dealPipelineStatuses,\n      dealStages,\n      leadStages,\n      darkModeLogo,\n      lightModeLogo,\n      noteStatuses,\n      title,\n      taskTypes,\n      contactGender,\n      services,\n    }}\n  >\n    {children}\n  </ConfigurationContext.Provider>\n);\n\nexport const useConfigurationContext = () => useContext(ConfigurationContext);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/root/CRM.tsx",
      "content": "import {\n  CustomRoutes,\n  localStorageStore,\n  Resource,\n  type AuthProvider,\n  type DataProvider,\n} from \"ra-core\";\nimport { useEffect } from \"react\";\nimport { Route } from \"react-router\";\nimport { Admin } from \"@/components/admin/admin\";\nimport { ForgotPasswordPage } from \"@/components/supabase/forgot-password-page\";\nimport { SetPasswordPage } from \"@/components/supabase/set-password-page\";\n\nimport contacts from \"../contacts\";\nimport clients from \"../clients\";\nimport { Dashboard } from \"../dashboard/Dashboard\";\nimport deals from \"../deals\";\nimport { Layout } from \"../layout/Layout\";\nimport { SignupPage } from \"../login/SignupPage\";\nimport {\n  authProvider as defaultAuthProvider,\n  dataProvider as defaultDataProvider,\n} from \"../providers/supabase\";\nimport sales from \"../sales\";\nimport servicesResource from \"../services\";\nimport { NotesPage } from \"../notes/NotesPage\";\nimport { SettingsPage } from \"../settings/SettingsPage\";\nimport { TasksPage } from \"../tasks/TasksPage\";\nimport type { ConfigurationContextValue } from \"./ConfigurationContext\";\nimport { ConfigurationProvider } from \"./ConfigurationContext\";\nimport {\n  defaultCompanySectors,\n  defaultContactGender,\n  defaultDarkModeLogo,\n  defaultDealCategories,\n  defaultDealPipelineStatuses,\n  defaultDealStages,\n  defaultLightModeLogo,\n  defaultNoteStatuses,\n  defaultTaskTypes,\n  defaultTitle,\n  defaultServices,\n  defaultLeadStages,\n} from \"./defaultConfiguration\";\nimport { i18nProvider } from \"./i18nProvider\";\nimport { StartPage } from \"../login/StartPage.tsx\";\n\nexport type CRMProps = {\n  dataProvider?: DataProvider;\n  authProvider?: AuthProvider;\n  disableTelemetry?: boolean;\n} & Partial<ConfigurationContextValue>;\n\n/**\n * CRM Component\n *\n * This component sets up and renders the main CRM application using `ra-core`. It provides\n * default configurations and themes but allows for customization through props. The component\n * wraps the application with a `ConfigurationProvider` to provide configuration values via context.\n *\n * @param {Array<ContactGender>} contactGender - The gender options for contacts used in the application.\n * @param {string[]} companySectors - The list of company sectors used in the application.\n * @param {RaThemeOptions} darkTheme - The theme to use when the application is in dark mode.\n * @param {string[]} dealCategories - The categories of deals used in the application.\n * @param {string[]} dealPipelineStatuses - The statuses of deals in the pipeline used in the application.\n * @param {DealStage[]} dealStages - The stages of deals used in the application.\n * @param {RaThemeOptions} lightTheme - The theme to use when the application is in light mode.\n * @param {string} logo - The logo used in the CRM application.\n * @param {NoteStatus[]} noteStatuses - The statuses of notes used in the application.\n * @param {string[]} taskTypes - The types of tasks used in the application.\n * @param {string} title - The title of the CRM application.\n *\n * @returns {JSX.Element} The rendered CRM application.\n *\n * @example\n * // Basic usage of the CRM component\n * import { CRM } from '@/components/atomic-crm/dashboard/CRM';\n *\n * const App = () => (\n *     <CRM\n *         logo=\"/path/to/logo.png\"\n *         title=\"My Custom CRM\"\n *         lightTheme={{\n *             ...defaultTheme,\n *             palette: {\n *                 primary: { main: '#0000ff' },\n *             },\n *         }}\n *     />\n * );\n *\n * export default App;\n */\nexport const CRM = ({\n  contactGender = defaultContactGender,\n  companySectors = defaultCompanySectors,\n  dealCategories = defaultDealCategories,\n  dealPipelineStatuses = defaultDealPipelineStatuses,\n  dealStages = defaultDealStages,\n  leadStages = defaultLeadStages,\n  darkModeLogo = defaultDarkModeLogo,\n  lightModeLogo = defaultLightModeLogo,\n  noteStatuses = defaultNoteStatuses,\n  taskTypes = defaultTaskTypes,\n  title = defaultTitle,\n  services = defaultServices,\n  dataProvider = defaultDataProvider,\n  authProvider = defaultAuthProvider,\n  disableTelemetry,\n  ...rest\n}: CRMProps) => {\n  useEffect(() => {\n    if (\n      disableTelemetry ||\n      process.env.NODE_ENV !== \"production\" ||\n      typeof window === \"undefined\" ||\n      typeof window.location === \"undefined\" ||\n      typeof Image === \"undefined\"\n    ) {\n      return;\n    }\n    const img = new Image();\n    img.src = `https://atomic-crm-telemetry.marmelab.com/atomic-crm-telemetry?domain=${window.location.hostname}`;\n  }, [disableTelemetry]);\n\n  return (\n    <ConfigurationProvider\n      contactGender={contactGender}\n      companySectors={companySectors}\n      dealCategories={dealCategories}\n      dealPipelineStatuses={dealPipelineStatuses}\n      dealStages={dealStages}\n      leadStages={leadStages}\n      darkModeLogo={darkModeLogo}\n      lightModeLogo={lightModeLogo}\n      noteStatuses={noteStatuses}\n      taskTypes={taskTypes}\n      title={title}\n      services={services}\n    >\n      <Admin\n        dataProvider={dataProvider}\n        authProvider={authProvider}\n        store={localStorageStore(undefined, \"CRM\")}\n        layout={Layout}\n        loginPage={StartPage}\n        i18nProvider={i18nProvider}\n        dashboard={Dashboard}\n        requireAuth\n        disableTelemetry\n        {...rest}\n      >\n        <CustomRoutes noLayout>\n          <Route path={SignupPage.path} element={<SignupPage />} />\n          <Route path={SetPasswordPage.path} element={<SetPasswordPage />} />\n          <Route\n            path={ForgotPasswordPage.path}\n            element={<ForgotPasswordPage />}\n          />\n        </CustomRoutes>\n\n        <CustomRoutes>\n          <Route path={SettingsPage.path} element={<SettingsPage />} />\n          <Route path={TasksPage.path} element={<TasksPage />} />\n          <Route path={NotesPage.path} element={<NotesPage />} />\n        </CustomRoutes>\n        <Resource name=\"lead-journey\" options={{ label: \"Lead Journey\" }} {...deals} />\n        <Resource name=\"contacts\" options={{ label: \"Leads\" }} {...contacts} />\n        <Resource name=\"clients\" options={{ label: \"Clients\" }} {...clients} />\n        <Resource name=\"contactNotes\" />\n        <Resource name=\"dealNotes\" />\n        <Resource name=\"tasks\" />\n        <Resource name=\"quotes\" />\n        <Resource name=\"sales\" {...sales} />\n        <Resource name=\"services\" {...servicesResource} />\n        <Resource name=\"tags\" />\n      </Admin>\n    </ConfigurationProvider>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/index.ts",
      "content": "export { AddQuote } from \"./AddQuote\";\nexport { QuoteItem } from \"./QuoteItem\";\nexport { QuotesIterator } from \"./QuotesIterator\";\nexport { QuoteEdit } from \"./QuoteEdit\";\n\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/QuotesIterator.tsx",
      "content": "import { useListContext } from \"ra-core\";\nimport { FileText } from \"lucide-react\";\n\nimport { QuoteItem } from \"./QuoteItem\";\n\nexport const QuotesIterator = () => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error) return null;\n\n  if (!data || data.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n        <FileText className=\"w-12 h-12 text-muted-foreground mb-4 opacity-50\" />\n        <p className=\"text-sm text-muted-foreground\">No quotes yet</p>\n        <p className=\"text-xs text-muted-foreground mt-1\">Create your first quote to get started</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-2\">\n      {data.map((quote) => (\n        <QuoteItem quote={quote} key={quote.id} />\n      ))}\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/QuoteItem.tsx",
      "content": "import { MoreVertical, Edit, Trash2, FileText } from \"lucide-react\";\nimport { useDeleteWithUndoController, useNotify } from \"ra-core\";\nimport { useState } from \"react\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { NumberField } from \"@/components/admin/number-field\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardHeader } from \"@/components/ui/card\";\n\nimport type { Quote } from \"../types\";\nimport { QuoteEdit } from \"./QuoteEdit\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\n\nconst statusColors = {\n  Draft: \"secondary\",\n  Sent: \"default\",\n  Accepted: \"default\",\n  Rejected: \"destructive\",\n} as const;\n\nexport const QuoteItem = ({ quote }: { quote: Quote }) => {\n  const notify = useNotify();\n  const [openEdit, setOpenEdit] = useState(false);\n\n  const { handleDelete } = useDeleteWithUndoController({\n    resource: \"quotes\",\n    record: quote,\n    redirect: false,\n    mutationOptions: {\n      onSuccess() {\n        notify(\"Quote deleted successfully\", { undoable: true });\n      },\n    },\n  });\n\n  const handleEdit = () => {\n    setOpenEdit(true);\n  };\n\n  const handleCloseEdit = () => {\n    setOpenEdit(false);\n  };\n\n  return (\n    <>\n      <Card className=\"hover:shadow-md transition-shadow py-3\">\n        <CardHeader className=\"pb-2 px-4 pt-0\">\n          <div className=\"flex items-start justify-between gap-3\">\n            <div className=\"flex items-start gap-2.5 flex-1 min-w-0\">\n              <div className=\"flex items-center justify-center w-8 h-8 rounded-md bg-primary/10 text-primary flex-shrink-0\">\n                <FileText className=\"w-4 h-4\" />\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-2 flex-wrap mb-1\">\n                  <ReferenceField\n                    source=\"service_id\"\n                    reference=\"services\"\n                    record={quote}\n                    link={false}\n                  >\n                    <TextField source=\"name\" className=\"font-semibold text-sm\" />\n                  </ReferenceField>\n                  <Badge variant={statusColors[quote.status] as any} className=\"text-xs\">\n                    {quote.status}\n                  </Badge>\n                </div>\n                {quote.description && (\n                  <div className=\"text-xs text-muted-foreground line-clamp-2 mb-1.5\">\n                    {quote.description}\n                  </div>\n                )}\n                <div className=\"text-base font-semibold text-primary\">\n                  <NumberField\n                    source=\"amount\"\n                    record={quote}\n                    options={{\n                      style: \"currency\",\n                      currency: \"AED\",\n                      minimumFractionDigits: 2,\n                    }}\n                  />\n                </div>\n              </div>\n            </div>\n            <span className=\"text-xs text-muted-foreground whitespace-nowrap mt-1\">\n              <RelativeDate\n                date={\n                  (quote as any).created_at ??\n                  quote.updated_at ??\n                  quote.date ??\n                  quote.sent_at ??\n                  quote.updated_at\n                }\n                mode=\"local\"\n              />\n            </span>\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-7 w-7 p-0 cursor-pointer\"\n                >\n                  <MoreVertical className=\"h-3.5 w-3.5\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem onClick={handleEdit} className=\"cursor-pointer\">\n                  <Edit className=\"mr-2 h-4 w-4\" />\n                  Edit\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={handleDelete}\n                  className=\"cursor-pointer text-destructive\"\n                >\n                  <Trash2 className=\"mr-2 h-4 w-4\" />\n                  Delete\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </CardHeader>\n      </Card>\n      {openEdit && (\n        <QuoteEdit quote={quote} open={openEdit} onClose={handleCloseEdit} />\n      )}\n    </>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/QuoteEdit.tsx",
      "content": "import {\n  EditBase,\n  Form,\n  useNotify,\n  useUpdate,\n} from \"ra-core\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { NumberInput } from \"@/components/admin/number-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { required } from \"ra-core\";\n\nimport type { Quote } from \"../types\";\n\nconst quoteStatuses = [\n  { id: \"Draft\", name: \"Draft\" },\n  { id: \"Sent\", name: \"Sent\" },\n  { id: \"Accepted\", name: \"Accepted\" },\n  { id: \"Rejected\", name: \"Rejected\" },\n];\n\nexport const QuoteEdit = ({\n  quote,\n  open,\n  onClose,\n}: {\n  quote: Quote;\n  open: boolean;\n  onClose: () => void;\n}) => {\n  const notify = useNotify();\n\n  const handleSuccess = () => {\n    notify(\"Quote updated\");\n    onClose();\n  };\n\n  return (\n    <EditBase\n      resource=\"quotes\"\n      id={quote.id}\n      mutationOptions={{ onSuccess: handleSuccess }}\n    >\n      <Dialog open={open} onOpenChange={(open) => !open && onClose()}>\n        <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n          <Form className=\"flex flex-col gap-4\">\n            <DialogHeader>\n              <DialogTitle>Edit Quote</DialogTitle>\n              <DialogDescription className=\"sr-only\">\n                Edit quote details including service type, status, description, and amount.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"flex flex-col gap-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <ReferenceInput\n                  source=\"service_id\"\n                  reference=\"services\"\n                >\n                  <AutocompleteInput\n                    label=\"Service Type\"\n                    optionText=\"name\"\n                    helperText={false}\n                    validate={required()}\n                  />\n                </ReferenceInput>\n                <SelectInput\n                  source=\"status\"\n                  choices={quoteStatuses}\n                  helperText={false}\n                />\n              </div>\n              <TextInput\n                source=\"description\"\n                label=\"Description\"\n                multiline\n                rows={4}\n                helperText={false}\n                placeholder=\"Describe the service details...\"\n              />\n              <NumberInput\n                source=\"amount\"\n                label=\"Amount\"\n                helperText={false}\n                validate={required()}\n              />\n            </div>\n            <DialogFooter className=\"w-full justify-end\">\n              <Button variant=\"outline\" onClick={onClose} type=\"button\">\n                Cancel\n              </Button>\n              <SaveButton label=\"Update Quote\" />\n            </DialogFooter>\n          </Form>\n        </DialogContent>\n      </Dialog>\n    </EditBase>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/quotes/AddQuote.tsx",
      "content": "import { Plus } from \"lucide-react\";\nimport {\n  CreateBase,\n  Form,\n  useGetIdentity,\n  useNotify,\n  useRecordContext,\n  useUpdate,\n  useRefresh,\n} from \"ra-core\";\nimport { useState } from \"react\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { NumberInput } from \"@/components/admin/number-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { required } from \"ra-core\";\n\nimport type { Quote } from \"../types\";\n\nconst quoteStatuses = [\n  { id: \"Draft\", name: \"Draft\" },\n  { id: \"Sent\", name: \"Sent\" },\n  { id: \"Accepted\", name: \"Accepted\" },\n  { id: \"Rejected\", name: \"Rejected\" },\n];\n\nexport const AddQuote = () => {\n  const { identity } = useGetIdentity();\n  const contact = useRecordContext();\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n  const [open, setOpen] = useState(false);\n\n  const handleOpen = () => {\n    setOpen(true);\n  };\n\n  const handleSuccess = async (data: Quote) => {\n    setOpen(false);\n    if (contact?.id) {\n      await update(\"contacts\", {\n        id: contact.id,\n        data: { last_seen: new Date().toISOString() },\n        previousData: contact,\n      });\n    }\n    notify(\"Quote added\");\n    refresh();\n  };\n\n  if (!identity || !contact) return null;\n\n  return (\n    <>\n      <div className=\"my-2\">\n        <Button\n          variant=\"outline\"\n          className=\"h-6 cursor-pointer\"\n          onClick={handleOpen}\n          size=\"sm\"\n        >\n          <Plus className=\"w-4 h-4\" />\n          Add quote\n        </Button>\n      </div>\n\n      <CreateBase\n        resource=\"quotes\"\n        record={{\n          contact_id: contact.id,\n          amount: 0,\n          status: \"Draft\",\n          sales_id: identity.id,\n        }}\n        mutationOptions={{ onSuccess: handleSuccess }}\n      >\n        <Dialog open={open} onOpenChange={(open) => !open && setOpen(false)}>\n          <DialogContent className=\"lg:max-w-xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n            <Form className=\"flex flex-col gap-4\">\n              <DialogHeader>\n                <DialogTitle>Create New Quote</DialogTitle>\n                <DialogDescription className=\"sr-only\">\n                  Create a new quote with service type, status, description, and amount.\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"flex flex-col gap-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <ReferenceInput\n                    source=\"service_id\"\n                    reference=\"services\"\n                  >\n                    <AutocompleteInput\n                      label=\"Service Type\"\n                      optionText=\"name\"\n                      helperText={false}\n                      validate={required()}\n                    />\n                  </ReferenceInput>\n                  <SelectInput\n                    source=\"status\"\n                    choices={quoteStatuses}\n                    helperText={false}\n                    defaultValue=\"Draft\"\n                  />\n                </div>\n                <TextInput\n                  source=\"description\"\n                  label=\"Description\"\n                  multiline\n                  rows={4}\n                  helperText={false}\n                  placeholder=\"Describe the service details...\"\n                />\n                <NumberInput\n                  source=\"amount\"\n                  label=\"Amount\"\n                  helperText={false}\n                  defaultValue={0}\n                  validate={required()}\n                />\n              </div>\n              <DialogFooter className=\"w-full justify-end\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setOpen(false)}\n                  type=\"button\"\n                >\n                  Cancel\n                </Button>\n                <SaveButton label=\"Create Quote\" />\n              </DialogFooter>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </CreateBase>\n    </>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/types.ts",
      "content": "export type { CrmDataProvider } from \"./supabase/dataProvider\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/supabase.ts",
      "content": "import { createClient } from \"@supabase/supabase-js\";\n\nexport const supabase = createClient(\n  import.meta.env.VITE_SUPABASE_URL,\n  import.meta.env.VITE_SUPABASE_ANON_KEY,\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/index.ts",
      "content": "export { authProvider } from \"./authProvider\";\nexport { dataProvider } from \"./dataProvider\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/dataProvider.ts",
      "content": "import { supabaseDataProvider } from \"ra-supabase-core\";\nimport {\n  withLifecycleCallbacks,\n  type CreateParams,\n  type DataProvider,\n  type GetListParams,\n  type Identifier,\n  type UpdateParams,\n} from \"ra-core\";\n\nimport type {\n  Contact,\n  ContactNote,\n  Deal,\n  DealNote,\n  RAFile,\n  Sale,\n  SalesFormData,\n  SignUpData,\n} from \"../../types\";\nimport { getActivityLog } from \"../commons/activity\";\nimport { getCompanyAvatar } from \"../commons/getCompanyAvatar\";\nimport { getContactAvatar } from \"../commons/getContactAvatar\";\nimport { mergeContacts } from \"../commons/mergeContacts\";\nimport { getIsInitialized } from \"./authProvider\";\nimport { supabase } from \"./supabase\";\n\nif (import.meta.env.VITE_SUPABASE_URL === undefined) {\n  throw new Error(\"Please set the VITE_SUPABASE_URL environment variable\");\n}\nif (import.meta.env.VITE_SUPABASE_ANON_KEY === undefined) {\n  throw new Error(\"Please set the VITE_SUPABASE_ANON_KEY environment variable\");\n}\n\nconst baseDataProvider = supabaseDataProvider({\n  instanceUrl: import.meta.env.VITE_SUPABASE_URL,\n  apiKey: import.meta.env.VITE_SUPABASE_ANON_KEY,\n  supabaseClient: supabase,\n  sortOrder: \"asc,desc.nullslast\" as any,\n});\n\nconst processCompanyLogo = async (params: any) => {\n  let logo = params.data.logo;\n\n  if (typeof logo !== \"object\" || logo === null || !logo.src) {\n    logo = await getCompanyAvatar(params.data);\n  } else if (logo.rawFile instanceof File) {\n    await uploadToBucket(logo);\n  }\n\n  return {\n    ...params,\n    data: {\n      ...params.data,\n      logo,\n    },\n  };\n};\n\nasync function processContactAvatar(\n  params: UpdateParams<Contact>,\n): Promise<UpdateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact>,\n): Promise<CreateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact> | UpdateParams<Contact>,\n): Promise<CreateParams<Contact> | UpdateParams<Contact>> {\n  const { data } = params;\n  if (data.avatar?.src || !data.email_jsonb || !data.email_jsonb.length) {\n    return params;\n  }\n  const avatarUrl = await getContactAvatar(data);\n\n  // Clone the data and modify the clone\n  const newData = { ...data, avatar: { src: avatarUrl || undefined } };\n\n  return { ...params, data: newData };\n}\n\n// Helper function to map resource names for data provider\nconst mapResourceName = (resource: string): string => {\n  if (resource === \"lead-journey\") {\n    return \"deals\";\n  }\n  if (resource === \"contactNotes\" || resource === \"contact_notes\") {\n    return \"contactNotes\";\n  }\n  if (resource === \"dealNotes\" || resource === \"deal_notes\") {\n    return \"dealNotes\";\n  }\n  if (resource === \"companies\") {\n    return \"companies_summary\";\n  }\n  if (resource === \"contacts\" || resource === \"clients\") {\n    return \"contacts_summary\";\n  }\n  return resource;\n};\n\ntype RangeFilter = {\n  field: string;\n  gte?: string;\n  lte?: string;\n};\n\nfunction parseInList(value?: string): string[] {\n  if (!value) return [];\n  return value\n    .replace(/[()]/g, \"\")\n    .split(\",\")\n    .map((item) => item.trim())\n    .filter(Boolean);\n}\n\nfunction mergeIdInFilters(\n  existing: string | Identifier[] | undefined,\n  ids: Iterable<Identifier>,\n): string {\n  const existingIds: Identifier[] = Array.isArray(existing)\n    ? existing\n    : typeof existing === \"string\"\n      ? (parseInList(existing)\n          .map((item) => Number(item))\n          .filter((id) => !Number.isNaN(id)) as Identifier[])\n      : [];\n  const combined = new Set<Identifier>(existingIds);\n  for (const id of ids) {\n    combined.add(id);\n  }\n  if (combined.size === 0) return \"(-1)\";\n  return `(${Array.from(combined).join(\",\")})`;\n}\n\nasync function collectIdsForRanges(\n  resource: string,\n  ranges: RangeFilter[],\n  baseFilter: Record<string, unknown>,\n): Promise<Set<Identifier>> {\n  const ids = new Set<Identifier>();\n  for (const range of ranges) {\n    const filterForRange: Record<string, unknown> = { ...baseFilter };\n    if (range.gte) {\n      filterForRange[`${range.field}@gte`] = range.gte;\n    }\n    if (range.lte) {\n      filterForRange[`${range.field}@lte`] = range.lte;\n    }\n\n    const { data } = await baseDataProvider.getList(resource, {\n      pagination: { page: 1, perPage: 10000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: filterForRange,\n    });\n\n    data?.forEach((record: any) => {\n      if (record?.id !== undefined && record?.id !== null) {\n        ids.add(record.id as Identifier);\n      }\n    });\n  }\n  return ids;\n}\n\nconst dataProviderWithCustomMethods = {\n  ...baseDataProvider,\n  async getList(resource: string, params: GetListParams) {\n    const mappedResource = mapResourceName(resource);\n    const lastSeenRanges =\n      params.filter && Array.isArray((params.filter as any).last_seen_ranges)\n        ? ((params.filter as any).last_seen_ranges as RangeFilter[])\n        : [];\n    if (params.filter && \"last_seen_ranges\" in params.filter) {\n      delete (params.filter as any).last_seen_ranges;\n    }\n    \n    // Clean up invalid @or filters that might cause parsing errors\n    if (params.filter && params.filter[\"@or\"] && typeof params.filter[\"@or\"] === \"object\") {\n      const orFilter = params.filter[\"@or\"];\n      // Check if @or has invalid keys (like services_interested.cs_5.{5} or malformed syntax)\n      const hasInvalidKeys = Object.keys(orFilter).some(key => \n        key.includes(\".\") && (key.includes(\"cs_\") || key.match(/\\.\\d+\\./) || key.includes(\"services_interested.cs\"))\n      );\n      \n      if (hasInvalidKeys) {\n        // Remove invalid @or filter entirely\n        delete params.filter[\"@or\"];\n        // If @or was the only filter, ensure we don't have an empty filter object causing issues\n        if (Object.keys(params.filter).length === 0) {\n          params.filter = undefined;\n        }\n      }\n    }\n    \n    // Handle lead_stage filter for contacts resource - filter contacts by their deal stage (single or multi)\n    if (\n      (resource === \"contacts\" || resource === \"clients\") &&\n      params.filter &&\n      (\"lead_stage\" in params.filter || \"lead_stage@in\" in params.filter)\n    ) {\n      const stageValues: string[] = [];\n      if (\"lead_stage\" in params.filter) {\n        stageValues.push(params.filter.lead_stage as string);\n        delete params.filter.lead_stage;\n      }\n      if (\"lead_stage@in\" in params.filter) {\n        stageValues.push(\n          ...parseInList(params.filter[\"lead_stage@in\"] as string),\n        );\n        delete params.filter[\"lead_stage@in\"];\n      }\n\n      if (stageValues.length > 0) {\n        const dealsFilter =\n          stageValues.length === 1\n            ? { stage: stageValues[0] }\n            : { \"stage@in\": `(${stageValues.join(\",\")})` };\n\n        const { data: dealsWithStage } = await baseDataProvider.getList(\n          \"deals\",\n          {\n            pagination: { page: 1, perPage: 10000 },\n            sort: { field: \"id\", order: \"ASC\" },\n            filter: dealsFilter,\n          },\n        );\n\n        const contactIds = Array.from(\n          new Set(\n            dealsWithStage\n              ?.flatMap((deal: Deal) => {\n                if (deal.lead_id != null) return [deal.lead_id];\n                if (Array.isArray((deal as any).contact_ids)) {\n                  return (deal as any).contact_ids.filter(\n                    (id: Identifier | undefined) =>\n                      id !== undefined && id !== null,\n                  );\n                }\n                return [];\n              })\n              .filter(\n                (id: Identifier | undefined): id is Identifier =>\n                  id !== undefined && id !== null,\n              ),\n          ),\n        );\n\n        if (contactIds.length > 0) {\n          params.filter[\"id@in\"] = mergeIdInFilters(\n            params.filter[\"id@in\"],\n            contactIds,\n          );\n        } else {\n          params.filter[\"id@in\"] = \"(-1)\";\n        }\n      }\n    }\n    \n    // Handle client filters (active/archived) based on converted deals\n    if (resource === \"clients\" && params.filter) {\n      const hasArchivedDeals =\n        \"hasArchivedDeals\" in params.filter\n          ? params.filter.hasArchivedDeals\n          : undefined;\n      const hasIsClient = \"isClient\" in params.filter;\n\n      // Clean up handled filters\n      if (hasIsClient) {\n        delete params.filter.isClient;\n      }\n      if (\"hasArchivedDeals\" in params.filter) {\n        delete params.filter.hasArchivedDeals;\n      }\n\n      // Only run when explicitly filtering clients or archive state\n      if (hasIsClient || typeof hasArchivedDeals === \"boolean\") {\n        const dealFilter: any = { stage: \"converted\" };\n\n        // Default client view and explicit \"unarchived\" both limit to active deals\n        if (hasArchivedDeals === true) {\n          dealFilter[\"archived_at@not.is\"] = null;\n        } else {\n          dealFilter[\"archived_at@is\"] = null;\n        }\n\n        const { data: convertedDeals } = await baseDataProvider.getList(\"deals\", {\n          pagination: { page: 1, perPage: 10000 },\n          sort: { field: \"id\", order: \"ASC\" },\n          filter: dealFilter,\n        });\n\n        if (!convertedDeals || convertedDeals.length === 0) {\n          params.filter[\"id@in\"] = \"(-1)\";\n        } else {\n          // Extract unique lead_ids (contact IDs) from converted deals, falling back to legacy contact_ids array\n          const clientContactIds = Array.from(\n            new Set(\n              convertedDeals\n                .flatMap((deal: Deal) => {\n                  if (deal.lead_id != null) return [deal.lead_id];\n                  if (Array.isArray((deal as any).contact_ids)) {\n                    return (deal as any).contact_ids.filter(\n                      (id: Identifier | undefined) =>\n                        id !== undefined && id !== null,\n                    );\n                  }\n                  return [];\n                })\n                .filter((id: Identifier | undefined): id is Identifier => id !== undefined && id !== null),\n            ),\n          );\n\n          if (clientContactIds.length > 0) {\n            params.filter[\"id@in\"] = `(${clientContactIds.join(\",\")})`;\n          } else {\n            params.filter[\"id@in\"] = \"(-1)\";\n          }\n        }\n      }\n    }\n    \n    // Handle services_interested filters for contacts - only when a services filter is explicitly selected by the user\n    // CRITICAL: By default, show ALL leads (with and without services_interested)\n    if ((resource === \"contacts\" || resource === \"contacts_summary\") && params.filter) {\n      const isEmptySetString = (val: unknown) =>\n        typeof val !== \"string\" ||\n        val.trim() === \"\" ||\n        val.replace(/[{}\\s,]/g, \"\") === \"\";\n\n      // Remove null/undefined/empty-string filters to avoid accidental filtering\n      Object.entries(params.filter).forEach(([key, value]) => {\n        if (value === null || value === undefined || (typeof value === \"string\" && value.trim() === \"\")) {\n          delete params.filter![key];\n        }\n      });\n      if (params.filter[\"@or\"] && typeof params.filter[\"@or\"] === \"object\") {\n        const cleanedOr = Object.fromEntries(\n          Object.entries(params.filter[\"@or\"]).filter(([, value]) => {\n            if (value === null || value === undefined) return false;\n            if (typeof value === \"string\" && value.trim() === \"\") return false;\n            return true;\n          }),\n        );\n        if (Object.keys(cleanedOr).length === 0) {\n          delete params.filter[\"@or\"];\n        } else {\n          params.filter[\"@or\"] = cleanedOr;\n        }\n      }\n\n      // Clean up empty/invalid services filters (both @cs and @ov) so they don't accidentally filter out leads\n      const serviceKeys = [\"services_interested@cs\", \"services_interested@ov\"];\n      serviceKeys.forEach((key) => {\n        if (key in params.filter && isEmptySetString(params.filter[key])) {\n          delete params.filter[key];\n        }\n      });\n\n      if (params.filter[\"@or\"] && typeof params.filter[\"@or\"] === \"object\") {\n        const cleanedOr = Object.fromEntries(\n          Object.entries(params.filter[\"@or\"]).filter(([key, value]) => {\n            if (\n              !key.startsWith(\"services_interested@cs\") &&\n              !key.startsWith(\"services_interested@ov\")\n            )\n              return true;\n            return !isEmptySetString(value);\n          }),\n        );\n        if (Object.keys(cleanedOr).length === 0) {\n          delete params.filter[\"@or\"];\n        } else {\n          params.filter[\"@or\"] = cleanedOr;\n        }\n      }\n\n      // Check if there's actually a services_interested filter\n      const hasServicesFilter = !!(\n        (params.filter[\"services_interested@cs\"] &&\n          !isEmptySetString(params.filter[\"services_interested@cs\"])) ||\n        (params.filter[\"services_interested@ov\"] &&\n          !isEmptySetString(params.filter[\"services_interested@ov\"])) ||\n        (params.filter[\"@or\"] &&\n          typeof params.filter[\"@or\"] === \"object\" &&\n          Object.keys(params.filter[\"@or\"]).some(\n            (key) =>\n              (key.startsWith(\"services_interested@cs\") ||\n                key.startsWith(\"services_interested@ov\")) &&\n              !isEmptySetString((params.filter as any)[\"@or\"][key]),\n          ))\n      );\n      \n      // Only process services filter logic if there's actually a services filter\n      // If no services filter is present, skip this entire block - this ensures ALL contacts are shown\n      // including those without any services_interested (NULL or empty array)\n      if (hasServicesFilter) {\n        // Check if there are multiple services_interested@cs filters in @or\n        if (params.filter[\"@or\"] && typeof params.filter[\"@or\"] === \"object\") {\n          const orFilter = params.filter[\"@or\"];\n          const serviceFilters: string[] = [];\n          \n          // Extract all services_interested@cs filters from @or\n          Object.entries(orFilter).forEach(([key, value]) => {\n            if (key === \"services_interested@cs\" || key.startsWith(\"services_interested@cs\")) {\n              if (typeof value === \"string\") {\n                serviceFilters.push(value);\n              }\n            }\n          });\n          \n          // If we found multiple service filters, handle them\n          if (serviceFilters.length > 0) {\n            // Remove the @or filter temporarily\n            const cleanedOr = Object.fromEntries(\n              Object.entries(orFilter).filter(\n                ([key]) => !key.startsWith(\"services_interested@cs\")\n              )\n            );\n            \n            if (Object.keys(cleanedOr).length === 0) {\n              delete params.filter[\"@or\"];\n            } else {\n              params.filter[\"@or\"] = cleanedOr;\n            }\n            \n            // Fetch contacts for each service and combine results\n            const allContactIds = new Set<Identifier>();\n            \n            for (const serviceFilter of serviceFilters) {\n              const serviceIdMatch = serviceFilter?.match(/\\{(\\d+)\\}/);\n              if (serviceIdMatch) {\n                const { data: contacts } = await baseDataProvider.getList(\"contacts_summary\", {\n                  pagination: { page: 1, perPage: 1000 },\n                  sort: { field: \"id\", order: \"ASC\" },\n                  filter: { \"services_interested@cs\": serviceFilter },\n                });\n                \n                contacts?.forEach((c: any) => allContactIds.add(c.id));\n              }\n            }\n            \n            // Apply id@in filter with all matching contact IDs\n            if (allContactIds.size > 0) {\n              const contactIdsArray = Array.from(allContactIds);\n              // If there's already an id@in filter, intersect them\n              if (params.filter[\"id@in\"]) {\n                const existingIds = params.filter[\"id@in\"]\n                  .replace(/[()]/g, \"\")\n                  .split(\",\")\n                  .map((id: string) => parseInt(id.trim()))\n                  .filter((id: number) => !isNaN(id));\n                \n                const intersection = existingIds.filter((id: number) => contactIdsArray.includes(id));\n                \n                if (intersection.length > 0) {\n                  params.filter[\"id@in\"] = `(${intersection.join(\",\")})`;\n                } else {\n                  params.filter[\"id@in\"] = \"(-1)\";\n                }\n              } else {\n                params.filter[\"id@in\"] = `(${contactIdsArray.join(\",\")})`;\n              }\n            } else {\n              // No contacts match, return empty result\n              params.filter[\"id@in\"] = \"(-1)\";\n            }\n          }\n        }\n        \n        // Also handle single services_interested@cs filter (not in @or)\n        if (params.filter[\"services_interested@cs\"] && !params.filter[\"@or\"]) {\n          const servicesFilter = params.filter[\"services_interested@cs\"];\n          delete params.filter[\"services_interested@cs\"];\n          \n          const serviceIdMatch = servicesFilter?.match(/\\{(\\d+)\\}/);\n          if (serviceIdMatch) {\n            // Fetch contacts that have this service\n            const { data: contacts } = await baseDataProvider.getList(\"contacts_summary\", {\n              pagination: { page: 1, perPage: 1000 },\n              sort: { field: \"id\", order: \"ASC\" },\n              filter: { \"services_interested@cs\": servicesFilter },\n            });\n            \n            const contactIds = contacts?.map((c: any) => c.id) || [];\n            \n            if (contactIds.length > 0) {\n              // If there's already an id@in filter, intersect them\n              if (params.filter[\"id@in\"]) {\n                const existingIds = params.filter[\"id@in\"]\n                  .replace(/[()]/g, \"\")\n                  .split(\",\")\n                  .map((id: string) => parseInt(id.trim()))\n                  .filter((id: number) => !isNaN(id));\n                \n                const intersection = existingIds.filter((id: number) => contactIds.includes(id));\n                \n                if (intersection.length > 0) {\n                  params.filter[\"id@in\"] = `(${intersection.join(\",\")})`;\n                } else {\n                  params.filter[\"id@in\"] = \"(-1)\";\n                }\n              } else {\n                params.filter[\"id@in\"] = `(${contactIds.join(\",\")})`;\n              }\n            } else {\n              params.filter[\"id@in\"] = \"(-1)\";\n            }\n          }\n        }\n      }\n    }\n    \n    // Handle services_interested filter for lead-journey (deals) - filter through lead_id relationship\n    if (resource === \"lead-journey\" && params.filter && \"services_interested@cs\" in params.filter) {\n      const servicesFilter = params.filter[\"services_interested@cs\"];\n      delete params.filter[\"services_interested@cs\"];\n      \n      // Extract service ID from filter (format: {serviceId})\n      const serviceIdMatch = servicesFilter?.match(/\\{(\\d+)\\}/);\n      if (serviceIdMatch) {\n        // First, fetch contacts that have this service\n        const { data: contacts } = await baseDataProvider.getList(\"contacts_summary\", {\n          pagination: { page: 1, perPage: 1000 },\n          sort: { field: \"id\", order: \"ASC\" },\n          filter: { \"services_interested@cs\": servicesFilter },\n        });\n        \n        // Extract contact IDs and format as string for @in filter: \"(1,2,3)\"\n        const contactIds = contacts?.map((c: any) => c.id) || [];\n        \n        // Filter deals by lead_id in those contact IDs, and fallback to legacy contact_ids array\n        if (contactIds.length > 0) {\n          // Primary filter using lead_id\n          params.filter[\"lead_id@in\"] = `(${contactIds.join(\",\")})`;\n          // Legacy fallback: ensure we also match deals where the contact is stored in contact_ids\n          params.filter[\"@or\"] = {\n            \"lead_id@in\": params.filter[\"lead_id@in\"],\n            \"contact_ids@cs\": `{${contactIds.join(\",\")}}`,\n          };\n        } else {\n          // No contacts match, return empty result by using a non-existent ID\n          params.filter[\"lead_id@in\"] = \"(-1)\";\n        }\n      }\n    }\n    \n    // Ensure params.filter is always an object (not undefined) for the base provider\n    // Empty filter objects are fine - they won't filter anything\n    if (!params.filter) {\n      params.filter = {};\n    }\n\n    // Apply multi-range last_seen filters (union of matching IDs) after all other filters are in place\n    if (\n      lastSeenRanges.length > 0 &&\n      (mappedResource === \"contacts_summary\" ||\n        resource === \"contacts\" ||\n        resource === \"clients\")\n    ) {\n      const ids = await collectIdsForRanges(\n        mappedResource,\n        lastSeenRanges,\n        params.filter,\n      );\n      params.filter[\"id@in\"] =\n        ids.size > 0\n          ? mergeIdInFilters(params.filter[\"id@in\"], ids)\n          : \"(-1)\";\n    }\n    \n    return baseDataProvider.getList(mappedResource, params);\n  },\n  async getOne(resource: string, params: any) {\n    const mappedResource = mapResourceName(resource);\n    return baseDataProvider.getOne(mappedResource, params);\n  },\n  async create(resource: string, params: any) {\n    // For creates, use the base table instead of the view\n    let mappedResource = mapResourceName(resource);\n    if (mappedResource === \"contacts_summary\") {\n      mappedResource = \"contacts\";\n    }\n    if (mappedResource === \"companies_summary\") {\n      mappedResource = \"companies\";\n    }\n    \n    // Clean up tagged_user_ids for tasks to avoid schema cache issues\n    if (mappedResource === \"tasks\" && params.data) {\n      const cleanedData = { ...params.data };\n      // Only include tagged_user_ids if it's a valid non-empty array\n      // Otherwise, completely remove it to avoid Supabase schema cache errors\n      if (!Array.isArray(cleanedData.tagged_user_ids) || cleanedData.tagged_user_ids.length === 0) {\n        delete cleanedData.tagged_user_ids;\n      }\n      return baseDataProvider.create(mappedResource, { ...params, data: cleanedData });\n    }\n    \n    return baseDataProvider.create(mappedResource, params);\n  },\n  async update(resource: string, params: any) {\n    // For updates, use the base table instead of the view\n    // Views cannot be updated, so we need to update the actual table\n    let mappedResource = mapResourceName(resource);\n    if (mappedResource === \"contacts_summary\") {\n      mappedResource = \"contacts\";\n    }\n    if (mappedResource === \"companies_summary\") {\n      mappedResource = \"companies\";\n    }\n    \n    // Check if this is a deal/lead-journey update\n    if ((mappedResource === \"deals\" || resource === \"lead-journey\") && params.data) {\n      // Fetch the previous data to compare changes\n      const { data: previousDeal } = await supabase\n        .from(\"deals\")\n        .select(\"stage, sales_id, company_id, lead_id, contact_ids, archived_at\")\n        .eq(\"id\", params.id)\n        .maybeSingle();\n      \n      if (previousDeal) {\n        // Check if stage is changing\n        if (\"stage\" in params.data && previousDeal.stage !== params.data.stage) {\n          try {\n            const activityData: any = {\n              type: \"deal.statusChanged\",\n              deal_id: params.id,\n              sales_id: previousDeal.sales_id || params.data.sales_id || null,\n              date: new Date().toISOString(),\n            };\n            \n            // Try to include new columns (will fail gracefully if migration hasn't run)\n            const activityDataWithNewColumns = {\n              ...activityData,\n              company_id: previousDeal.company_id || params.data.company_id || null,\n              old_stage: previousDeal.stage || null,\n              new_stage: params.data.stage || null,\n            };\n            \n            const { error: insertError } = await supabase\n              .from(\"activity_log\")\n              .insert(activityDataWithNewColumns);\n            \n            // If insert failed (likely because columns don't exist), try without new columns\n            if (insertError) {\n              const { error: fallbackError } = await supabase\n                .from(\"activity_log\")\n                .insert(activityData);\n              \n              if (fallbackError) {\n                console.warn(\"Failed to log status change to activity_log. Please run migration 20250208000000_add_status_change_tracking.sql:\", fallbackError);\n              }\n            }\n          } catch (error) {\n            console.warn(\"Error logging status change:\", error);\n          }\n        }\n        \n        // Check if archived_at is changing (archive/unarchive)\n        if (\"archived_at\" in params.data) {\n          const wasArchived = previousDeal.archived_at != null;\n          const willBeArchived = params.data.archived_at != null;\n          \n          // Only log if the archive status is actually changing\n          if (wasArchived !== willBeArchived) {\n            try {\n              const activityData: any = {\n                type: willBeArchived ? \"deal.archived\" : \"deal.unarchived\",\n                deal_id: params.id,\n                sales_id: previousDeal.sales_id || params.data.sales_id || null,\n                date: new Date().toISOString(),\n              };\n              \n              // Try to include company_id if migration has been run\n              const activityDataWithCompany = {\n                ...activityData,\n                company_id: previousDeal.company_id || params.data.company_id || null,\n              };\n              \n              const { error: insertError } = await supabase\n                .from(\"activity_log\")\n                .insert(activityDataWithCompany);\n              \n              if (insertError) {\n                // Try without company_id if it fails\n                const { error: fallbackError } = await supabase\n                  .from(\"activity_log\")\n                  .insert(activityData);\n                \n                if (fallbackError) {\n                  console.warn(\"Failed to log archive/unarchive to activity_log:\", fallbackError);\n                }\n              }\n            } catch (error) {\n              console.warn(\"Error logging archive/unarchive:\", error);\n            }\n          }\n        }\n      }\n    }\n    \n    return baseDataProvider.update(mappedResource, params);\n  },\n  async delete(resource: string, params: any) {\n    // For deletes, use the base table instead of the view\n    let mappedResource = mapResourceName(resource);\n    if (mappedResource === \"contacts_summary\") {\n      mappedResource = \"contacts\";\n    }\n    if (mappedResource === \"companies_summary\") {\n      mappedResource = \"companies\";\n    }\n    \n    // Try to fetch the record first (using maybeSingle to avoid 406 if not found)\n    // If fetch fails, we'll still try to delete\n    let record: any = null;\n    const { data: fetchedRecord } = await supabase\n      .from(mappedResource)\n      .select(\"*\")\n      .eq(\"id\", params.id)\n      .maybeSingle();\n    \n    record = fetchedRecord;\n\n    // If a contact is deleted, also archive any related Lead Journey items (deals)\n    // so they stop showing as cards after the FK sets lead_id to NULL.\n    if (mappedResource === \"contacts\" && params?.id != null) {\n      const contactId = params.id;\n      const now = new Date().toISOString();\n      try {\n        // Primary relation (new schema): deals.lead_id\n        await supabase\n          .from(\"deals\")\n          .update({ archived_at: now, updated_at: now })\n          .eq(\"lead_id\", contactId);\n\n        // Legacy relation (older schema): deals.contact_ids array\n        // Best-effort: if column doesn't exist or update is blocked, we ignore.\n        await supabase\n          .from(\"deals\")\n          .update({ archived_at: now, updated_at: now })\n          // PostgREST array contains operator\n          .contains(\"contact_ids\", [contactId] as any);\n      } catch {\n        // Best effort only; deletion should still proceed.\n      }\n    }\n    \n    // Create deletion activity before deleting\n    if (record) {\n      const activityData: any = {\n        date: new Date().toISOString(),\n        sales_id: record.sales_id || null,\n      };\n\n      if (mappedResource === \"contactNotes\" || mappedResource === \"dealNotes\") {\n        // Note deletion\n        activityData.type = \"note.deleted\";\n        activityData.note_text = record.text || null;\n        if (mappedResource === \"contactNotes\") {\n          activityData.contact_id = record.contact_id || null;\n        } else if (mappedResource === \"dealNotes\") {\n          activityData.deal_id = record.deal_id || null;\n          // For deal notes, try to get contact_id from the deal if possible\n          // This is a best-effort approach - if deal is already deleted, contact_id won't be available\n          if (record.deal_id) {\n            const { data: deal } = await supabase\n              .from(\"deals\")\n              .select(\"lead_id, contact_ids\")\n              .eq(\"id\", record.deal_id)\n              .maybeSingle();\n            if (deal) {\n              activityData.contact_id = deal.lead_id || (Array.isArray(deal.contact_ids) ? deal.contact_ids[0] : null);\n            }\n          }\n        }\n      } else if (mappedResource === \"quotes\") {\n        // Quote deletion\n        activityData.type = \"quote.deleted\";\n        activityData.contact_id = record.contact_id || null;\n        activityData.quote_amount = record.amount || null;\n        activityData.quote_description = record.description || null;\n      } else if (mappedResource === \"tasks\") {\n        // Task deletion\n        activityData.type = \"task.deleted\";\n        activityData.contact_id = record.contact_id || null;\n        activityData.task_text = record.text || null;\n        activityData.task_type = record.type || null;\n      }\n\n      // Only create activity log entry if it's a note, quote, or task\n      if (activityData.type) {\n        await supabase.from(\"activity_log\").insert(activityData);\n      }\n    }\n    \n    // Use Supabase client directly to perform the delete\n    // This avoids the 406 error from the REST API\n    const { error: deleteError } = await supabase\n      .from(mappedResource)\n      .delete()\n      .eq(\"id\", params.id);\n    \n    if (deleteError) {\n      throw deleteError;\n    }\n    \n    // Return the deleted record in the format expected by react-admin\n    // If we couldn't fetch it, return at least the ID\n    return { data: record || { id: params.id } };\n  },\n  async getMany(resource: string, params: any) {\n    const mappedResource = mapResourceName(resource);\n    return baseDataProvider.getMany(mappedResource, params);\n  },\n  async getManyReference(resource: string, params: any) {\n    const mappedResource = mapResourceName(resource);\n    return baseDataProvider.getManyReference(mappedResource, params);\n  },\n\n  async signUp({ email, password, first_name, last_name }: SignUpData) {\n    const response = await supabase.auth.signUp({\n      email,\n      password,\n      options: {\n        data: {\n          first_name,\n          last_name,\n        },\n      },\n    });\n\n    if (!response.data?.user || response.error) {\n      console.error(\"signUp.error\", response.error);\n      throw new Error(\"Failed to create account\");\n    }\n\n    // Update the is initialized cache\n    getIsInitialized._is_initialized_cache = true;\n\n    return {\n      id: response.data.user.id,\n      email,\n      password,\n    };\n  },\n  async salesCreate(body: SalesFormData) {\n    const { data, error } = await supabase.functions.invoke<Sale>(\"users\", {\n      method: \"POST\",\n      body,\n    });\n\n    if (!data || error) {\n      console.error(\"salesCreate.error\", error);\n      throw new Error(\"Failed to create account manager\");\n    }\n\n    return data;\n  },\n  async salesUpdate(\n    id: Identifier,\n    data: Partial<Omit<SalesFormData, \"password\">>,\n  ) {\n    const { email, first_name, last_name, administrator, avatar, disabled } =\n      data;\n\n    const { data: sale, error } = await supabase.functions.invoke<Sale>(\n      \"users\",\n      {\n        method: \"PATCH\",\n        body: {\n          sales_id: id,\n          email,\n          first_name,\n          last_name,\n          administrator,\n          disabled,\n          avatar,\n        },\n      },\n    );\n\n    if (!sale || error) {\n      console.error(\"salesCreate.error\", error);\n      throw new Error(\"Failed to update account manager\");\n    }\n\n    return data;\n  },\n  async updatePassword(id: Identifier) {\n    const { data: passwordUpdated, error } =\n      await supabase.functions.invoke<boolean>(\"updatePassword\", {\n        method: \"PATCH\",\n        body: {\n          sales_id: id,\n        },\n      });\n\n    if (!passwordUpdated || error) {\n      console.error(\"passwordUpdate.error\", error);\n      throw new Error(\"Failed to update password\");\n    }\n\n    return passwordUpdated;\n  },\n  async unarchiveDeal(deal: Deal) {\n    // Log unarchive action before processing\n    try {\n      const activityData: any = {\n        type: \"deal.unarchived\",\n        deal_id: deal.id,\n        sales_id: deal.sales_id || null,\n        date: new Date().toISOString(),\n      };\n      \n      // Try to include company_id if migration has been run\n      const activityDataWithCompany = {\n        ...activityData,\n        company_id: deal.company_id || null,\n      };\n      \n      const { error: insertError } = await supabase\n        .from(\"activity_log\")\n        .insert(activityDataWithCompany);\n      \n      if (insertError) {\n        // Try without company_id if it fails\n        const { error: fallbackError } = await supabase\n          .from(\"activity_log\")\n          .insert(activityData);\n        \n        if (fallbackError) {\n          console.warn(\"Failed to log unarchive to activity_log:\", fallbackError);\n        }\n      }\n    } catch (error) {\n      console.warn(\"Error logging unarchive:\", error);\n    }\n    \n    // get all deals where stage is the same as the deal to unarchive\n    const { data: deals } = await baseDataProvider.getList<Deal>(\"deals\", {\n      filter: { stage: deal.stage },\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"index\", order: \"ASC\" },\n    });\n\n    // set index for each deal starting from 1, if the deal to unarchive is found, set its index to the last one\n    const updatedDeals = deals.map((d, index) => ({\n      ...d,\n      index: d.id === deal.id ? 0 : index + 1,\n      archived_at: d.id === deal.id ? null : d.archived_at,\n    }));\n\n    return await Promise.all(\n      updatedDeals.map((updatedDeal) =>\n        baseDataProvider.update(\"deals\", {\n          id: updatedDeal.id,\n          data: updatedDeal,\n          previousData: deals.find((d) => d.id === updatedDeal.id),\n        }),\n      ),\n    );\n  },\n  async getActivityLog(companyId?: Identifier, contactId?: Identifier) {\n    return getActivityLog(baseDataProvider, companyId, undefined, contactId);\n  },\n  async isInitialized() {\n    return getIsInitialized();\n  },\n  async mergeContacts(sourceId: Identifier, targetId: Identifier) {\n    // FIXME this should be done in a lambda function using a transaction instead\n    return mergeContacts(sourceId, targetId, baseDataProvider);\n  },\n} satisfies DataProvider;\n\nexport type CrmDataProvider = typeof dataProviderWithCustomMethods;\n\nexport const dataProvider = withLifecycleCallbacks(\n  dataProviderWithCustomMethods,\n  [\n    {\n      resource: \"contactNotes\",\n      beforeSave: async (data: ContactNote, _, __) => {\n        return data;\n      },\n    },\n    {\n      resource: \"dealNotes\",\n      beforeSave: async (data: DealNote, _, __) => {\n        return data;\n      },\n    },\n    {\n      resource: \"sales\",\n      beforeSave: async (data: Sale, _, __) => {\n        if (data.avatar) {\n          await uploadToBucket(data.avatar);\n        }\n        return data;\n      },\n    },\n    {\n      resource: \"contacts\",\n      beforeCreate: async (params) => {\n        return processContactAvatar(params);\n      },\n      beforeUpdate: async (params) => {\n        return processContactAvatar(params);\n      },\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"first_name\",\n          \"last_name\",\n          \"company_name\",\n          \"title\",\n          \"email\",\n          \"phone\",\n          \"background\",\n        ])(params);\n      },\n    },\n    {\n      resource: \"companies\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"name\",\n          \"phone_number\",\n          \"website\",\n          \"zipcode\",\n          \"city\",\n          \"stateAbbr\",\n        ])(params);\n      },\n      beforeCreate: async (params) => {\n        const createParams = await processCompanyLogo(params);\n\n        return {\n          ...createParams,\n          data: {\n            ...createParams.data,\n            created_at: new Date().toISOString(),\n          },\n        };\n      },\n      beforeUpdate: async (params) => {\n        return await processCompanyLogo(params);\n      },\n    },\n    {\n      resource: \"contacts_summary\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"first_name\",\n          \"last_name\",\n          \"email\",\n          \"phone\",\n          \"background\",\n          \"area\",\n          \"city\",\n          \"flat_villa_number\",\n          \"building_street\",\n        ])(params);\n      },\n    },\n    {\n      resource: \"lead-journey\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\"name\", \"type\", \"description\"])(params);\n      },\n    },\n    {\n      resource: \"sales\",\n      beforeGetList: async (params) => {\n        return applyFullTextSearch([\n          \"first_name\",\n          \"last_name\",\n          \"email\",\n        ], { useFtsSuffix: false })(params);\n      },\n    },\n  ],\n);\n\nconst applyFullTextSearch = (\n  columns: string[],\n  options: { useFtsSuffix?: boolean } = { useFtsSuffix: true }\n) => (params: GetListParams) => {\n  if (!params.filter?.q) {\n    return params;\n  }\n  const { q, ...filter } = params.filter;\n  const { useFtsSuffix = true } = options;\n  return {\n    ...params,\n    filter: {\n      ...filter,\n      \"@or\": columns.reduce((acc, column) => {\n        if (column === \"email\") {\n          const emailColumn = useFtsSuffix ? \"email_fts\" : \"email\";\n          return {\n            ...acc,\n            [`${emailColumn}@ilike`]: q,\n          };\n        }\n        if (column === \"phone\") {\n          const phoneColumn = useFtsSuffix ? \"phone_fts\" : \"phone\";\n          return {\n            ...acc,\n            [`${phoneColumn}@ilike`]: q,\n          };\n        }\n        return {\n          ...acc,\n          [`${column}@ilike`]: q,\n        };\n      }, {}),\n    },\n  };\n};\n\nconst uploadToBucket = async (fi: RAFile) => {\n  if (!fi.src.startsWith(\"blob:\") && !fi.src.startsWith(\"data:\")) {\n    // Sign URL check if path exists in the bucket\n    if (fi.path) {\n      const { error } = await supabase.storage\n        .from(\"attachments\")\n        .createSignedUrl(fi.path, 60);\n\n      if (!error) {\n        return;\n      }\n    }\n  }\n\n  const dataContent = fi.src\n    ? await fetch(fi.src).then((res) => res.blob())\n    : fi.rawFile;\n\n  const file = fi.rawFile;\n  const fileExt = file.name.split(\".\").pop();\n  const fileName = `${Math.random()}.${fileExt}`;\n  const filePath = `${fileName}`;\n  const { error: uploadError } = await supabase.storage\n    .from(\"attachments\")\n    .upload(filePath, dataContent);\n\n  if (uploadError) {\n    console.error(\"uploadError\", uploadError);\n    throw new Error(\"Failed to upload attachment\");\n  }\n\n  const { data } = supabase.storage.from(\"attachments\").getPublicUrl(filePath);\n\n  fi.path = filePath;\n  fi.src = data.publicUrl;\n\n  // save MIME type\n  const mimeType = file.type;\n  fi.type = mimeType;\n\n  return fi;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/supabase/authProvider.ts",
      "content": "/* eslint-disable no-var */\n/* eslint-disable @typescript-eslint/no-namespace */\nimport type { AuthProvider } from \"ra-core\";\nimport { supabaseAuthProvider } from \"ra-supabase-core\";\n\nimport { canAccess } from \"../commons/canAccess\";\nimport { supabase } from \"./supabase\";\n\nconst baseAuthProvider = supabaseAuthProvider(supabase, {\n  getIdentity: async () => {\n    const sale = await getSaleFromCache();\n\n    if (sale == null) {\n      throw new Error();\n    }\n\n    return {\n      id: sale.id,\n      fullName: `${sale.first_name} ${sale.last_name}`,\n      avatar: sale.avatar?.src,\n    };\n  },\n});\n\nexport async function getIsInitialized() {\n  if (getIsInitialized._is_initialized_cache == null) {\n    const { data } = await supabase.from(\"init_state\").select(\"is_initialized\");\n\n    getIsInitialized._is_initialized_cache = data?.at(0)?.is_initialized > 0;\n  }\n\n  return getIsInitialized._is_initialized_cache;\n}\n\nexport namespace getIsInitialized {\n  export var _is_initialized_cache: boolean | null = null;\n}\n\nexport const authProvider: AuthProvider = {\n  ...baseAuthProvider,\n  login: async (params) => {\n    const result = await baseAuthProvider.login(params);\n    // clear cached sale\n    cachedSale = undefined;\n    return result;\n  },\n  checkAuth: async (params) => {\n    // Users are on the set-password page, nothing to do\n    if (\n      window.location.pathname === \"/set-password\" ||\n      window.location.hash.includes(\"#/set-password\")\n    ) {\n      return;\n    }\n    // Users are on the forgot-password page, nothing to do\n    if (\n      window.location.pathname === \"/forgot-password\" ||\n      window.location.hash.includes(\"#/forgot-password\")\n    ) {\n      return;\n    }\n    // Users are on the sign-up page, nothing to do\n    if (\n      window.location.pathname === \"/sign-up\" ||\n      window.location.hash.includes(\"#/sign-up\")\n    ) {\n      return;\n    }\n\n    const isInitialized = await getIsInitialized();\n\n    if (!isInitialized) {\n      await supabase.auth.signOut();\n      throw {\n        redirectTo: \"/sign-up\",\n        message: false,\n      };\n    }\n\n    return baseAuthProvider.checkAuth(params);\n  },\n  canAccess: async (params) => {\n    const isInitialized = await getIsInitialized();\n    if (!isInitialized) return false;\n\n    // Get the current user\n    const sale = await getSaleFromCache();\n    if (sale == null) return false;\n\n    // Compute access rights from the sale role\n    const role = sale.administrator ? \"admin\" : \"user\";\n    return canAccess(role, params);\n  },\n};\n\nlet cachedSale: any;\nconst getSaleFromCache = async () => {\n  if (cachedSale != null) return cachedSale;\n\n  const { data: dataSession, error: errorSession } =\n    await supabase.auth.getSession();\n\n  // Shouldn't happen after login but just in case\n  if (dataSession?.session?.user == null || errorSession) {\n    return undefined;\n  }\n\n  const { data: dataSale, error: errorSale } = await supabase\n    .from(\"sales\")\n    .select(\"id, first_name, last_name, avatar, administrator\")\n    .match({ user_id: dataSession?.session?.user.id })\n    .single();\n\n  // Shouldn't happen either as all users are sales but just in case\n  if (dataSale == null || errorSale) {\n    return undefined;\n  }\n\n  cachedSale = dataSale;\n  return dataSale;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/index.ts",
      "content": "export { authProvider } from \"./authProvider\";\nexport { dataProvider } from \"./dataProvider\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataProvider.ts",
      "content": "import {\n  withLifecycleCallbacks,\n  type CreateParams,\n  type DataProvider,\n  type Identifier,\n  type ResourceCallbacks,\n  type UpdateParams,\n} from \"ra-core\";\nimport fakeRestDataProvider from \"ra-data-fakerest\";\n\nimport type {\n  Company,\n  Contact,\n  Deal,\n  Sale,\n  SalesFormData,\n  SignUpData,\n  Task,\n} from \"../../types\";\nimport { getActivityLog } from \"../commons/activity\";\nimport { getCompanyAvatar } from \"../commons/getCompanyAvatar\";\nimport { getContactAvatar } from \"../commons/getContactAvatar\";\nimport { mergeContacts } from \"../commons/mergeContacts\";\nimport type { CrmDataProvider } from \"../types\";\nimport { authProvider, USER_STORAGE_KEY } from \"./authProvider\";\nimport generateData from \"./dataGenerator\";\nimport { withSupabaseFilterAdapter } from \"./internal/supabaseAdapter\";\n\nconst baseDataProvider = fakeRestDataProvider(generateData(), true, 300);\n\nconst TASK_MARKED_AS_DONE = \"TASK_MARKED_AS_DONE\";\nconst TASK_MARKED_AS_UNDONE = \"TASK_MARKED_AS_UNDONE\";\nconst TASK_DONE_NOT_CHANGED = \"TASK_DONE_NOT_CHANGED\";\nlet taskUpdateType = TASK_DONE_NOT_CHANGED;\n\nconst processCompanyLogo = async (params: any) => {\n  let logo = params.data.logo;\n\n  if (typeof logo !== \"object\" || logo === null || !logo.src) {\n    logo = await getCompanyAvatar(params.data);\n  } else if (logo.rawFile instanceof File) {\n    const base64Logo = await convertFileToBase64(logo);\n    logo = { src: base64Logo, title: logo.title };\n  }\n\n  return {\n    ...params,\n    data: {\n      ...params.data,\n      logo,\n    },\n  };\n};\n\nasync function processContactAvatar(\n  params: UpdateParams<Contact>,\n): Promise<UpdateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact>,\n): Promise<CreateParams<Contact>>;\n\nasync function processContactAvatar(\n  params: CreateParams<Contact> | UpdateParams<Contact>,\n): Promise<CreateParams<Contact> | UpdateParams<Contact>> {\n  const { data } = params;\n  if (data.avatar?.src || !data.email_jsonb || !data.email_jsonb.length) {\n    return params;\n  }\n  const avatarUrl = await getContactAvatar(data);\n\n  // Clone the data and modify the clone\n  const newData = { ...data, avatar: { src: avatarUrl || undefined } };\n\n  return { ...params, data: newData };\n}\n\nasync function fetchAndUpdateCompanyData(\n  params: UpdateParams<Contact>,\n  dataProvider: DataProvider,\n): Promise<UpdateParams<Contact>>;\n\nasync function fetchAndUpdateCompanyData(\n  params: CreateParams<Contact>,\n  dataProvider: DataProvider,\n): Promise<CreateParams<Contact>>;\n\nasync function fetchAndUpdateCompanyData(\n  params: CreateParams<Contact> | UpdateParams<Contact>,\n  dataProvider: DataProvider,\n): Promise<CreateParams<Contact> | UpdateParams<Contact>> {\n  const { data } = params;\n  const newData = { ...data };\n\n  if (!newData.company_id) {\n    return params;\n  }\n\n  const { data: company } = await dataProvider.getOne(\"companies\", {\n    id: newData.company_id,\n  });\n\n  if (!company) {\n    return params;\n  }\n\n  newData.company_name = company.name;\n  return { ...params, data: newData };\n}\n\nconst dataProviderWithCustomMethod: CrmDataProvider = {\n  ...baseDataProvider,\n  unarchiveDeal: async (deal: Deal) => {\n    // get all deals where stage is the same as the deal to unarchive\n    const { data: deals } = await baseDataProvider.getList<Deal>(\"deals\", {\n      filter: { stage: deal.stage },\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"index\", order: \"ASC\" },\n    });\n\n    // set index for each deal starting from 1, if the deal to unarchive is found, set its index to the last one\n    const updatedDeals = deals.map((d, index) => ({\n      ...d,\n      index: d.id === deal.id ? 0 : index + 1,\n      archived_at: d.id === deal.id ? null : d.archived_at,\n    }));\n\n    return await Promise.all(\n      updatedDeals.map((updatedDeal) =>\n        dataProvider.update(\"deals\", {\n          id: updatedDeal.id,\n          data: updatedDeal,\n          previousData: deals.find((d) => d.id === updatedDeal.id),\n        }),\n      ),\n    );\n  },\n  // We simulate a remote endpoint that is in charge of returning activity log\n  getActivityLog: async (companyId?: Identifier, contactId?: Identifier) => {\n    return getActivityLog(dataProvider, companyId, undefined, contactId);\n  },\n  signUp: async ({\n    email,\n    password,\n    first_name,\n    last_name,\n  }: SignUpData): Promise<{ id: string; email: string; password: string }> => {\n    const user = await baseDataProvider.create(\"sales\", {\n      data: {\n        email,\n        first_name,\n        last_name,\n      },\n    });\n\n    return {\n      ...user.data,\n      password,\n    };\n  },\n  salesCreate: async ({ ...data }: SalesFormData): Promise<Sale> => {\n    const user = await dataProvider.create(\"sales\", {\n      data: {\n        ...data,\n        password: \"new_password\",\n      },\n    });\n\n    return {\n      ...user.data,\n    };\n  },\n  salesUpdate: async (\n    id: Identifier,\n    data: Partial<Omit<SalesFormData, \"password\">>,\n  ): Promise<Partial<Omit<SalesFormData, \"password\">>> => {\n    const { data: previousData } = await dataProvider.getOne<Sale>(\"sales\", {\n      id,\n    });\n\n    if (!previousData) {\n      throw new Error(\"User not found\");\n    }\n\n    const { data: sale } = await dataProvider.update(\"sales\", {\n      id,\n      data,\n      previousData,\n    });\n    return sale;\n  },\n  isInitialized: async (): Promise<boolean> => {\n    const sales = await dataProvider.getList<Sale>(\"sales\", {\n      filter: {},\n      pagination: { page: 1, perPage: 1 },\n      sort: { field: \"id\", order: \"ASC\" },\n    });\n    if (sales.data.length === 0) {\n      return false;\n    }\n    return true;\n  },\n  updatePassword: async (id: Identifier): Promise<true> => {\n    const currentUser = await authProvider.getIdentity?.();\n    if (!currentUser) {\n      throw new Error(\"User not found\");\n    }\n    const { data: previousData } = await dataProvider.getOne<Sale>(\"sales\", {\n      id: currentUser.id,\n    });\n\n    if (!previousData) {\n      throw new Error(\"User not found\");\n    }\n\n    await dataProvider.update(\"sales\", {\n      id,\n      data: {\n        password: \"demo_newPassword\",\n      },\n      previousData,\n    });\n\n    return true;\n  },\n  mergeContacts: async (sourceId: Identifier, targetId: Identifier) => {\n    return mergeContacts(sourceId, targetId, baseDataProvider);\n  },\n};\n\nasync function updateCompany(\n  companyId: Identifier,\n  updateFn: (company: Company) => Partial<Company>,\n) {\n  const { data: company } = await dataProvider.getOne<Company>(\"companies\", {\n    id: companyId,\n  });\n\n  return await dataProvider.update(\"companies\", {\n    id: companyId,\n    data: {\n      ...updateFn(company),\n    },\n    previousData: company,\n  });\n}\n\nexport const dataProvider = withLifecycleCallbacks(\n  withSupabaseFilterAdapter(dataProviderWithCustomMethod),\n  [\n    {\n      resource: \"sales\",\n      beforeCreate: async (params) => {\n        const { data } = params;\n        // If administrator role is not set, we simply set it to false\n        if (data.administrator == null) {\n          data.administrator = false;\n        }\n        return params;\n      },\n      afterSave: async (data) => {\n        // Since the current user is stored in localStorage in fakerest authProvider\n        // we need to update it to keep information up to date in the UI\n        const currentUser = await authProvider.getIdentity?.();\n        if (currentUser?.id === data.id) {\n          localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(data));\n        }\n        return data;\n      },\n      beforeDelete: async (params) => {\n        if (params.meta?.identity?.id == null) {\n          throw new Error(\"Identity MUST be set in meta\");\n        }\n\n        const newSaleId = params.meta.identity.id as Identifier;\n\n        const [companies, contacts, contactNotes, deals] = await Promise.all([\n          dataProvider.getList(\"companies\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n          dataProvider.getList(\"contacts\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n          dataProvider.getList(\"contactNotes\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n          dataProvider.getList(\"deals\", {\n            filter: { sales_id: params.id },\n            pagination: {\n              page: 1,\n              perPage: 10_000,\n            },\n            sort: { field: \"id\", order: \"ASC\" },\n          }),\n        ]);\n\n        await Promise.all([\n          dataProvider.updateMany(\"companies\", {\n            ids: companies.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n          dataProvider.updateMany(\"contacts\", {\n            ids: contacts.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n          dataProvider.updateMany(\"contactNotes\", {\n            ids: contactNotes.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n          dataProvider.updateMany(\"deals\", {\n            ids: deals.data.map((company) => company.id),\n            data: {\n              sales_id: newSaleId,\n            },\n          }),\n        ]);\n\n        return params;\n      },\n    } satisfies ResourceCallbacks<Sale>,\n    {\n      resource: \"contacts\",\n      beforeCreate: async (params, dataProvider) => {\n        const newParams = await processContactAvatar(params);\n        return fetchAndUpdateCompanyData(newParams, dataProvider);\n      },\n      afterCreate: async (result) => {\n        if (result.data.company_id != null) {\n          await updateCompany(result.data.company_id, (company) => ({\n            nb_contacts: (company.nb_contacts ?? 0) + 1,\n          }));\n        }\n\n        return result;\n      },\n      beforeUpdate: async (params) => {\n        const newParams = await processContactAvatar(params);\n        return fetchAndUpdateCompanyData(newParams, dataProvider);\n      },\n      afterDelete: async (result) => {\n        if (result.data.company_id != null) {\n          await updateCompany(result.data.company_id, (company) => ({\n            nb_contacts: (company.nb_contacts ?? 1) - 1,\n          }));\n        }\n\n        return result;\n      },\n    } satisfies ResourceCallbacks<Contact>,\n    {\n      resource: \"tasks\",\n      afterCreate: async (result, dataProvider) => {\n        // update the task count in the related contact\n        const { contact_id } = result.data;\n        const { data: contact } = await dataProvider.getOne(\"contacts\", {\n          id: contact_id,\n        });\n        await dataProvider.update(\"contacts\", {\n          id: contact_id,\n          data: {\n            nb_tasks: (contact.nb_tasks ?? 0) + 1,\n          },\n          previousData: contact,\n        });\n        return result;\n      },\n      beforeUpdate: async (params) => {\n        const { data, previousData } = params;\n        if (previousData.done_date !== data.done_date) {\n          taskUpdateType = data.done_date\n            ? TASK_MARKED_AS_DONE\n            : TASK_MARKED_AS_UNDONE;\n        } else {\n          taskUpdateType = TASK_DONE_NOT_CHANGED;\n        }\n        return params;\n      },\n      afterUpdate: async (result, dataProvider) => {\n        // update the contact: if the task is done, decrement the nb tasks, otherwise increment it\n        const { contact_id } = result.data;\n        const { data: contact } = await dataProvider.getOne(\"contacts\", {\n          id: contact_id,\n        });\n        if (taskUpdateType !== TASK_DONE_NOT_CHANGED) {\n          await dataProvider.update(\"contacts\", {\n            id: contact_id,\n            data: {\n              nb_tasks:\n                taskUpdateType === TASK_MARKED_AS_DONE\n                  ? (contact.nb_tasks ?? 0) - 1\n                  : (contact.nb_tasks ?? 0) + 1,\n            },\n            previousData: contact,\n          });\n        }\n        return result;\n      },\n      afterDelete: async (result, dataProvider) => {\n        // update the task count in the related contact\n        const { contact_id } = result.data;\n        const { data: contact } = await dataProvider.getOne(\"contacts\", {\n          id: contact_id,\n        });\n        await dataProvider.update(\"contacts\", {\n          id: contact_id,\n          data: {\n            nb_tasks: (contact.nb_tasks ?? 0) - 1,\n          },\n          previousData: contact,\n        });\n        return result;\n      },\n    } satisfies ResourceCallbacks<Task>,\n    {\n      resource: \"companies\",\n      beforeCreate: async (params) => {\n        const createParams = await processCompanyLogo(params);\n\n        return {\n          ...createParams,\n          data: {\n            ...createParams.data,\n            created_at: new Date().toISOString(),\n          },\n        };\n      },\n      beforeUpdate: async (params) => {\n        return await processCompanyLogo(params);\n      },\n      afterUpdate: async (result, dataProvider) => {\n        // get all contacts of the company and for each contact, update the company_name\n        const { id, name } = result.data;\n        const { data: contacts } = await dataProvider.getList(\"contacts\", {\n          filter: { company_id: id },\n          pagination: { page: 1, perPage: 1000 },\n          sort: { field: \"id\", order: \"ASC\" },\n        });\n\n        const contactIds = contacts.map((contact) => contact.id);\n        await dataProvider.updateMany(\"contacts\", {\n          ids: contactIds,\n          data: { company_name: name },\n        });\n        return result;\n      },\n    } satisfies ResourceCallbacks<Company>,\n    {\n      resource: \"deals\",\n      beforeCreate: async (params) => {\n        return {\n          ...params,\n          data: {\n            ...params.data,\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString(),\n          },\n        };\n      },\n      afterCreate: async (result) => {\n        await updateCompany(result.data.company_id, (company) => ({\n          nb_deals: (company.nb_deals ?? 0) + 1,\n        }));\n\n        return result;\n      },\n      beforeUpdate: async (params) => {\n        return {\n          ...params,\n          data: {\n            ...params.data,\n            updated_at: new Date().toISOString(),\n          },\n        };\n      },\n      afterDelete: async (result) => {\n        await updateCompany(result.data.company_id, (company) => ({\n          nb_deals: (company.nb_deals ?? 1) - 1,\n        }));\n\n        return result;\n      },\n    } satisfies ResourceCallbacks<Deal>,\n  ],\n);\n\n/**\n * Convert a `File` object returned by the upload input into a base 64 string.\n * That's not the most optimized way to store images in production, but it's\n * enough to illustrate the idea of dataprovider decoration.\n */\nconst convertFileToBase64 = (file: { rawFile: Blob }) =>\n  new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(reader.result);\n    reader.onerror = reject;\n    reader.readAsDataURL(file.rawFile);\n  });\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/authProvider.ts",
      "content": "import type { AuthProvider } from \"ra-core\";\n\nimport type { Sale } from \"../../types\";\nimport { canAccess } from \"../commons/canAccess\";\nimport { dataProvider } from \"./dataProvider\";\n\nexport const DEFAULT_USER = {\n  id: 0,\n  first_name: \"Jane\",\n  last_name: \"Doe\",\n  email: \"janedoe@atomic.dev\",\n  password: \"demo\",\n  administrator: true,\n  avatar: {\n    src: \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4gKgSUNDX1BST0ZJTEUAAQEAAAKQbGNtcwQwAABtbnRyUkdCIFhZWiAH3wAIABMAEgAWADFhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtkZXNjAAABCAAAADhjcHJ0AAABQAAAAE53dHB0AAABkAAAABRjaGFkAAABpAAAACxyWFlaAAAB0AAAABRiWFlaAAAB5AAAABRnWFlaAAAB+AAAABRyVFJDAAACDAAAACBnVFJDAAACLAAAACBiVFJDAAACTAAAACBjaHJtAAACbAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAABwAAAAcAHMAUgBHAEIAIABiAHUAaQBsAHQALQBpAG4AAG1sdWMAAAAAAAAAAQAAAAxlblVTAAAAMgAAABwATgBvACAAYwBvAHAAeQByAGkAZwBoAHQALAAgAHUAcwBlACAAZgByAGUAZQBsAHkAAAAAWFlaIAAAAAAAAPbWAAEAAAAA0y1zZjMyAAAAAAABDEoAAAXj///zKgAAB5sAAP2H///7ov///aMAAAPYAADAlFhZWiAAAAAAAABvlAAAOO4AAAOQWFlaIAAAAAAAACSdAAAPgwAAtr5YWVogAAAAAAAAYqUAALeQAAAY3nBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltwYXJhAAAAAAADAAAAAmZmAADypwAADVkAABPQAAAKW2Nocm0AAAAAAAMAAAAAo9cAAFR7AABMzQAAmZoAACZmAAAPXP/bAEMACAYGBwYFCAcHBwkJCAoMFA0MCwsMGRITDxQdGh8eHRocHCAkLicgIiwjHBwoNyksMDE0NDQfJzk9ODI8LjM0Mv/bAEMBCQkJDAsMGA0NGDIhHCEyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMv/AABEIAIAAgAMBIgACEQEDEQH/xAAcAAABBAMBAAAAAAAAAAAAAAABAAUGBwIDBAj/xAA2EAABAwMBBgMHAwQDAQAAAAABAAIDBAUREgYTITFBUSJxgRQyYZGxwdEHQqEkUmLhFRYjkv/EABoBAAIDAQEAAAAAAAAAAAAAAAIDAAEEBQb/xAAkEQACAgIDAAEEAwAAAAAAAAAAAQIRAyEEEjETBSJRcTJBYf/aAAwDAQACEQMRAD8AuIIoIogAooIqygorB72xsc97g1rRkk9FFrlfnVD3Rwu0Qj5uQyko+hRi5eEjlr6aEkOlBI6N4rSbpCG6j4R0zzPoFEIpZpn+Ahv+TuJ9E9Qtipodc0haD15ud5BI+Vsb8aXoq/a6GgJ1UsrgBknTj6rgp/1JtEkgjnbNTk9Xxkt/+m5Cbrvbam9sc2XeU9G0jTFry6Q9M/hddk/T6kpId7UwNmqJCOBOGxjoD3KLvIroiX0VxprhCJaeVr2njlpyutR+k2dlttQZ4KwMZpwIGjwD5lbI785leaSppZWHmJG+JpHfKYppgOLQ9pIAhwBHIpIwBJFJBQhgiEAiFRYQkgmzaCuNDaZHsOJHeBvmVG6VkSt0Me0l93spoqY5Y0+N3Qn8JgjdrcA3xOPU9f8AS485Jy4c8ucep/CzirNBIh4D9zz1WGU7dmyMElRIIXspeBw+fGeJ4N8/wtsEstTUtHFzz1Pb7BNVHvJQA0EAnOo83fH/AGpBR7qniw14yfekz9+qFMNxHiljYwjhqc3kTxPxwnaIZA+6ZoJWDGhjnZ68gnaEvewftHw4BOixTVGc2GsOdI4c3KFXmSuq75Rw0kQ3EWZKieQaQG8g0D4n7KauaGgiNu8eeJJPBN89JLUN8btWg5HDAL++OwUZSMbTWxV9vZNFqxyIcMEELuTdTBtNUbiP3A0D5BOC0QdozzVMWUksoIwTBFBIKEMlFdtJSIKaMHHEuKlKg+3Ly6rgizhugl3wHVLyv7WMxK5Ih8k2+IAJEecNGeLvj5LvoossDsZHl9E2x6ZZNTvDGPp2WFde45P6WlqI4tPAZIGT6rAb0vwSiOox4RgA+84nn6ruiuAhLdA1n+5x5Kt6SsrYagtqqkyuJ8Jxj+FLpIql9qM0b9GW8Ceioaoa2TigrXStDsMb8SOKeYtUgGpxLe5+wVQ2eouftIabs52T7ugHPqrOtNNX7gb+r3zSPE1zNJPljknQaehGSFDo6piax5Em7iZ78h+gXJV1OId7lzIgzIYOePyue4QvxGGs8OsAN6D/ACPfH1QinirgZmODoi4Mb5BFYlqjfSsc58kjxgkN4dua61wWWqFbb2VGCDM4uAPMN6LsJ4p+LwRlM8pZWGUU0UBFYhFUWFV/t0S67xR8muhGT8MqwFDNvKJz4IqxgyWjQ49uyXl3EbidSKxrp31VWaKnJaxoySO6aX7INZG9swlcHuD3OyMkjlxKdLWA2uqJH/3NH8KRVNWz2XJ7LCm1tHSUIyWyL0NvdC6CnBeQHjRqOSB2VwVdnd/1YwRt/wDQx8Pkq4sX9XdoXubpZrGCeo7q7i3eW0OjbqLW8B3RRjdkm+tJHn6usdbV1JY6rnpmBww5jT4QPLn6q09jLdcKBsRgv0lZSFgaaaoYXBuBza4kuB7g5HwCa6y50tRWvi3ZjeHYc1wwQVMdm42NaC3lhXBu6JkikuzHS4QuNuqCPf3biPPCqj9OdonubHa6txLyXkPJ65JH1x6K27tKYrXVPAyRE/A7nBVE7OUEtJtDSs0k6JwHO8zghMemZ6bjZcdqjZT0jo2DAY4tC68rVBHuosY4klx81sWnGqiYcjuRkllAIhGCBFBFUWFc9dSR11FLTyDLXtI8l0BJUXZRt4tNRZ7hPFI3Trw5p6HHBcEk0jgwO93l6q3tsrJ/y1oL4WZqYTqZ8R1H0VRVEDKqikgkaQRkdiCsOWHWR0+Pk7RFRzVNHXQmNwc1pHAHBVq2m+19QIzTgMhaMFsjclx+ap2wW6gn3dNXvqIpA7G+DstcB9CrVtVqsVDa4Zpa2eUmPIDS4knIzgD4FUou9Dvtqpe/oZ9qrfUR1Elw3ZDy7UeGAVKtibgKi3skzwPDj0KiV7ornc6xk8EtdTW+QhraSZ+S49SW8cAeamWzlsFupBG39ztXkotSKl/CmO21N3pbLs7U3GtL/Z4tOsMGScuAwB6qK7JUrbs1t6ex+5kOuESBoceJ4uDeGfJP+1NpO0NLSWyRgNE6cS1Rzza3iGjzOPknKCnipadkEEbY4o2hrWtGAAFojj7O2YJ5eq6oyKCywlhaTIBEJJKEMQigEVRYUViioQJAIIPVVrtzYW0FY2507cQVLtMoH7X9/X6hWVlcl0pKWvtlRTVuPZ3sOs5xpxx1A9COaDJDtGhuKbhKyjW2uT2newSuZq544g+in2ytGYpGzTPMj28WgNAwofRV0cFU6F7w5oOGudw1DoVPbRdKCBrdU0eojg1pyT6BYbr+zsd5dKRIvZN6/ey4yPhyXRTx+PDeXfssaZz6wBzssj6N6nzTiyJrAABgI1vaMrdaZp06SQTniktkvv5WtbIO4o5+RVJgwkikjAAkigVCGsJZWuSaOGMySvaxg5uccAJiqtqqeNxbSxOmP9x8I/KCU4x9DjCUvESIJuvG0Fp2fp2zXWvhpWPzo3h4uxzwBxKi1XtTcJGnS5sDe7Bx+ZVD7WX+p2gvs1TNM+VkZ3cOp2fCD9+amOayPReTG4LZaF2/XVjKmRlotTZIG5DZal5Bce+kch5lcLNqL5erSJrhXPd7SNRiYA2No6AAKocHGOqs21NJs1K3HERgfwg5T6xSQzixTk2zAtEziCn6wwbmoa4DHHoE1tgO9BA9FJLfTua0ODeK5sjpw0WFaagua0Ek+akAcC3KiNnbI0AkKTsfiLJTsb0IyrZue3U3yULuW39stV+fbKlkmmMAPmZ4sPPTCeNoL9HZbPUVbiCWN8I7novPE9TLVVktTM4ukkLnuJ6kldPg4fkk2/DncyfSKr09C2zaizXZzI6SvidM/lE7wv8AkU7rznsdUvG1Nvbk5FWz6r0O2XuPkj5EYYpJJ+isPfIm6NqCQcDySSk0/A2mvStrpepLtWu0kimYcRt+5+K1sZlqa6LmMp13ga1cuUnJ2zrQioqkM21VULfs7VzA4foLWeZ4fdUnjAHmrI/Uiv8A6OmpQffeXkfAD8lVyBlkY75K6XDhWO/yc7ly++vwGMZljGM5I+qvWlpab2eMNiDQGjgAqNb4J2EftwR6cV6Et0Daihp5WjwyRtcPUIebGkhnCabZjTWykmOHsHDkU7U9BHF7ucLXFTljuSc4W8srnUb26OmmeI2Dgt7qzIw44C1BgwmLaq7w2a0S1Dj4sYYM8S7oEyKb0hcmvWRD9S9pI6qaCz0rsiM7ydw79B6c/kq/Mni7cM/RYmd9XUyVEpJe4l7s9StD3nWT105+y9NxsXw4lE8/nyfLkch32Lk07X21zjw3+r5L0HHUa25yvPWxzc7YW9nYk/wVdrKgsAHRcn6lKpx/R0+BG4N/6P8AFL4hxTg2IvZkc1HqSoy8EqUUUgfGFjxt3o0ZUq2f/9k=\",\n  },\n} as const;\n\nexport const USER_STORAGE_KEY = \"user\";\n\nlocalStorage.setItem(USER_STORAGE_KEY, JSON.stringify({ ...DEFAULT_USER }));\n\nasync function getUser(email: string) {\n  const sales = await dataProvider.getList(\"sales\", {\n    pagination: { page: 1, perPage: 200 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  if (!sales.data.length) {\n    return { ...DEFAULT_USER };\n  }\n\n  const user = sales.data.find((sale) => sale.email === email);\n  if (!user || user.disabled) {\n    return { ...DEFAULT_USER };\n  }\n  return user;\n}\n\nexport const authProvider: AuthProvider = {\n  login: async ({ email }) => {\n    const user = await getUser(email);\n    localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(user));\n    return Promise.resolve();\n  },\n  logout: () => {\n    localStorage.removeItem(USER_STORAGE_KEY);\n    return Promise.resolve();\n  },\n  checkError: () => Promise.resolve(),\n  checkAuth: () =>\n    localStorage.getItem(USER_STORAGE_KEY)\n      ? Promise.resolve()\n      : Promise.reject(),\n  canAccess: async ({ signal: _signal, ...params }) => {\n    // Get the current user\n    const userItem = localStorage.getItem(USER_STORAGE_KEY);\n    const localUser = userItem ? (JSON.parse(userItem) as Sale) : null;\n    if (!localUser) return false;\n\n    // Compute access rights from the sale role\n    const role = localUser.administrator ? \"admin\" : \"user\";\n    return canAccess(role, params);\n  },\n  getIdentity: () => {\n    const userItem = localStorage.getItem(USER_STORAGE_KEY);\n    const user = userItem ? (JSON.parse(userItem) as Sale) : null;\n    return Promise.resolve({\n      id: user?.id ?? 0,\n      fullName: user ? `${user.first_name} ${user.last_name}` : \"Jane Doe\",\n      avatar: user?.avatar?.src,\n    });\n  },\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformOrFilter.ts",
      "content": "import isObject from \"lodash/isObject\";\n\n// @or filter is an equivaluent of fakerest `q=`\nexport function transformOrFilter(values: any) {\n  if (!isObject(values) || Array.isArray(values)) {\n    throw new Error(\n      \"Invalid '@or' filter, expected an object as first element\",\n    );\n  }\n\n  const queries = Object.values(values);\n  if (queries.length === 0) {\n    throw new Error(\"Invalid '@or' filter, object is empty\");\n  }\n\n  return queries[0];\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformOrFilter.spec.ts",
      "content": "import { transformOrFilter } from \"./transformOrFilter\";\n\nit(\"should throw an error if the value is not an object\", () => {\n  expect(() => transformOrFilter([])).toThrow(\n    \"Invalid '@or' filter, expected an object\",\n  );\n});\n\nit(\"should throw an error if the object is empty\", () => {\n  expect(() => transformOrFilter({})).toThrow(\n    \"Invalid '@or' filter, object is empty\",\n  );\n});\n\nit(\"should return the query value\", () => {\n  expect(transformOrFilter({ \"last_name@ilike\": \"one\" })).toEqual(\"one\");\n  expect(\n    transformOrFilter({\n      \"last_name@ilike\": \"one\",\n      \"first_name@ilike\": \"one\",\n    }),\n  ).toEqual(\"one\");\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformInFilter.ts",
      "content": "import { LIST_REGEX_BASE, parseList } from \"./listParser\";\n\nexport const IN_FILTER_REGEX = new RegExp(`^\\\\(${LIST_REGEX_BASE}\\\\)$`);\n\nexport function transformInFilter(value: any) {\n  if (value === \"()\") {\n    return [];\n  }\n\n  if (typeof value !== \"string\" || !value.match(IN_FILTER_REGEX)) {\n    throw new Error(\n      `Invalid '@in' filter value, expected a string matching '${IN_FILTER_REGEX.source}', got: ${value}`,\n    );\n  }\n\n  return parseList(value.slice(1, -1));\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformInFilter.spec.ts",
      "content": "import { IN_FILTER_REGEX, transformInFilter } from \"./transformInFilter\";\n\nit(\"should throw an error if the filter is not a string\", () => {\n  expect(() => transformInFilter(1)).toThrow(\n    `Invalid '@in' filter value, expected a string matching '${IN_FILTER_REGEX.source}', got: 1`,\n  );\n});\n\nit(\"should throw an error if the filter does not match pattern\", () => {\n  expect(() => transformInFilter(\"1,2\")).toThrow(\n    `Invalid '@in' filter value, expected a string matching '${IN_FILTER_REGEX.source}', got: 1,2`,\n  );\n});\n\nit(\"should support empty arrays\", () => {\n  expect(transformInFilter(\"()\")).toEqual([]);\n});\n\nit(\"should return an array of numbers\", () => {\n  expect(transformInFilter(\"(1)\")).toEqual([1]);\n  expect(transformInFilter(\"(1,2,3)\")).toEqual([1, 2, 3]);\n});\n\nit(\"should return an array of strings\", () => {\n  expect(transformInFilter(\"(a)\")).toEqual([\"a\"]);\n  expect(transformInFilter(\"(a,B,c-d)\")).toEqual([\"a\", \"B\", \"c-d\"]);\n});\n\nit(\"should return an array of quoted strings\", () => {\n  expect(transformInFilter('(\"a\")')).toEqual([\"a\"]);\n  expect(transformInFilter('(\"a\",\"B, c\")')).toEqual([\"a\", \"B, c\"]);\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformFilter.ts",
      "content": "import { transformContainsFilter } from \"./transformContainsFilter\";\nimport { transformInFilter } from \"./transformInFilter\";\nimport { transformOrFilter } from \"./transformOrFilter\";\n\nexport function transformFilter(filter: Record<string, any>) {\n  if (!filter) {\n    return undefined;\n  }\n  const transformedFilters: Record<string, any> = {};\n  for (const [key, value] of Object.entries(filter)) {\n    if (\n      key.endsWith(\"@eq\") ||\n      key.endsWith(\"@neq\") ||\n      key.endsWith(\"@lt\") ||\n      key.endsWith(\"@lte\") ||\n      key.endsWith(\"@gt\") ||\n      key.endsWith(\"@gte\")\n    ) {\n      const lastIndexOfAt = key.lastIndexOf(\"@\");\n      transformedFilters[\n        `${key.substring(0, lastIndexOfAt)}_${key.substring(lastIndexOfAt + 1)}`\n      ] = value;\n      continue;\n    }\n\n    if (key.endsWith(\"@is\")) {\n      transformedFilters[`${key.slice(0, -3)}_eq`] = value;\n      continue;\n    }\n\n    if (key.endsWith(\"@not.is\")) {\n      transformedFilters[`${key.slice(0, -7)}_neq`] = value;\n      continue;\n    }\n\n    if (key.endsWith(\"@in\")) {\n      transformedFilters[`${key.slice(0, -3)}_eq_any`] =\n        transformInFilter(value);\n      continue;\n    }\n\n    if (key.endsWith(\"@cs\")) {\n      transformedFilters[`${key.slice(0, -3)}`] =\n        transformContainsFilter(value);\n      continue;\n    }\n\n    // Search query\n    if (key.endsWith(\"@or\")) {\n      transformedFilters[\"q\"] = transformOrFilter(value);\n      continue;\n    }\n\n    transformedFilters[key] = value;\n  }\n  return transformedFilters;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformContainsFilter.ts",
      "content": "import { LIST_REGEX_BASE, parseList } from \"./listParser\";\n\nexport const CONTAINS_FILTER_REGEX = new RegExp(`^\\\\{${LIST_REGEX_BASE}\\\\}$`);\n\nexport function transformContainsFilter(value: any) {\n  if (value === \"{}\") {\n    return [];\n  }\n\n  if (typeof value !== \"string\" || !value.match(CONTAINS_FILTER_REGEX)) {\n    throw new Error(\n      `Invalid '@cs' filter value, expected a string matching '${CONTAINS_FILTER_REGEX.source}', got: ${value}`,\n    );\n  }\n\n  return parseList(value.slice(1, -1));\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/transformContainsFilter.spec.ts",
      "content": "import {\n  CONTAINS_FILTER_REGEX,\n  transformContainsFilter,\n} from \"./transformContainsFilter\";\n\nit(\"should throw an error if the filter is not a string\", () => {\n  expect(() => transformContainsFilter(1)).toThrow(\n    `Invalid '@cs' filter value, expected a string matching '${CONTAINS_FILTER_REGEX.source}', got: 1`,\n  );\n});\n\nit(\"should throw an error if the filter does not match pattern\", () => {\n  expect(() => transformContainsFilter(\"1,2\")).toThrow(\n    `Invalid '@cs' filter value, expected a string matching '${CONTAINS_FILTER_REGEX.source}', got: 1,2`,\n  );\n});\n\nit(\"should support empty arrays\", () => {\n  expect(transformContainsFilter(\"{}\")).toEqual([]);\n});\n\nit(\"should return an array of numbers\", () => {\n  expect(transformContainsFilter(\"{1}\")).toEqual([1]);\n  expect(transformContainsFilter(\"{1,2,3}\")).toEqual([1, 2, 3]);\n});\n\nit(\"should return an array of strings\", () => {\n  expect(transformContainsFilter(\"{a}\")).toEqual([\"a\"]);\n  expect(transformContainsFilter(\"{a,B,c-d}\")).toEqual([\"a\", \"B\", \"c-d\"]);\n});\n\nit(\"should return an array of quoted strings\", () => {\n  expect(transformContainsFilter('{\"a\"}')).toEqual([\"a\"]);\n  expect(transformContainsFilter('{\"a\",\"B, c\"}')).toEqual([\"a\", \"B, c\"]);\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/supabaseAdapter.ts",
      "content": "import type { DataProvider } from \"ra-core\";\nimport { transformFilter } from \"./transformFilter\";\n\nfunction removeSummarySuffix(resource: string) {\n  return resource.endsWith(\"_summary\")\n    ? resource.replace(\"_summary\", \"\")\n    : resource;\n}\n\nexport function withSupabaseFilterAdapter<T extends DataProvider>(\n  dataProvider: T,\n): T {\n  return {\n    ...dataProvider,\n    getOne(resource, params) {\n      return dataProvider.getOne(removeSummarySuffix(resource), params);\n    },\n    getList(resource, params) {\n      return dataProvider.getList(removeSummarySuffix(resource), {\n        ...params,\n        filter: transformFilter(params.filter),\n      });\n    },\n    getMany(resource, params) {\n      return dataProvider.getMany(removeSummarySuffix(resource), params);\n    },\n    getManyReference(resource, params) {\n      return dataProvider.getManyReference(removeSummarySuffix(resource), {\n        ...params,\n        filter: transformFilter(params.filter),\n      });\n    },\n    create(resource, params) {\n      return dataProvider.create(removeSummarySuffix(resource), params);\n    },\n    delete(resource, params) {\n      return dataProvider.delete(removeSummarySuffix(resource), params);\n    },\n    deleteMany(resource, params) {\n      return dataProvider.deleteMany(removeSummarySuffix(resource), params);\n    },\n    update(resource, params) {\n      return dataProvider.update(removeSummarySuffix(resource), params);\n    },\n    updateMany(resource, params) {\n      return dataProvider.updateMany(removeSummarySuffix(resource), params);\n    },\n  };\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/supabaseAdapter.spec.ts",
      "content": "import type { DataProvider } from \"ra-core\";\nimport { withSupabaseFilterAdapter } from \"./supabaseAdapter\";\n\ndescribe(\"getList\", () => {\n  it(\"should transform '@eq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@eq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_eq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@neq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@neq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_neq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@eq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@eq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_eq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@neq'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@neq\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_neq\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@is'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"id@is\": null } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id_eq: null },\n    });\n  });\n\n  it(\"should transform '@not.is'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"id@not.is\": null } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id_neq: null },\n    });\n  });\n\n  it(\"should transform '@lt'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@lt\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_lt\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@lte'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@lte\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_lte\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@gt'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@gt\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_gt\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@gte'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"a@id@gte\": \"1\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { \"a@id_gte\": \"1\" },\n    });\n  });\n\n  it(\"should transform '@in'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"id@in\": \"(1,2,a)\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id_eq_any: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@cs'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", { filter: { \"tags@cs\": \"{1,2,a}\" } }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { tags: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@or'\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getListAdapter(\"resource\", {\n        filter: { \"@or\": { last_name: \"one\" } },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { q: \"one\" },\n    });\n  });\n\n  it(\"should not transform a filter without operator\", () => {\n    const getList = vi.fn();\n    const mockDataProvider = {\n      getList,\n    } as unknown as DataProvider;\n\n    getList.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getList: getListAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(getListAdapter(\"resource\", { filter: { id: 1 } })).resolves.toEqual([\n      { id: 1 },\n    ]);\n\n    expect(getList).toHaveBeenCalledWith(\"resource\", {\n      filter: { id: 1 },\n    });\n  });\n});\n\ndescribe(\"getManyReference\", () => {\n  it(\"should transform @eq\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@eq\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_eq\": \"2\" },\n    });\n  });\n\n  it(\"should transform @neq\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@neq\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_neq\": \"2\" },\n    });\n  });\n\n  it(\"should transform @is\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"id@is\": null },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id_eq: null },\n    });\n  });\n\n  it(\"should transform @not.is\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"id@not.is\": null },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id_neq: null },\n    });\n  });\n\n  it(\"should transform @lt\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@lt\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_lt\": \"2\" },\n    });\n  });\n\n  it(\"should transform @lte\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@lte\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_lte\": \"2\" },\n    });\n  });\n\n  it(\"should transform @gt\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@gt\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_gt\": \"2\" },\n    });\n  });\n\n  it(\"should transform @gte\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"a@id@gte\": \"2\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { \"a@id_gte\": \"2\" },\n    });\n  });\n\n  it(\"should transform '@in'\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"id@in\": \"(1,2,a)\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id_eq_any: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@cs'\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"tags@cs\": \"{1,2,a}\" },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { tags: [1, 2, \"a\"] },\n    });\n  });\n\n  it(\"should transform '@or'\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { \"@or\": { last_name: \"one\" } },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { q: \"one\" },\n    });\n  });\n\n  it(\"should not transform a filter without operator\", () => {\n    const getManyReference = vi.fn();\n    const mockDataProvider = {\n      getManyReference,\n    } as unknown as DataProvider;\n\n    getManyReference.mockResolvedValueOnce([{ id: 1 }]);\n\n    const { getManyReference: getManyReferenceAdapter } =\n      withSupabaseFilterAdapter(mockDataProvider);\n\n    expect(\n      getManyReferenceAdapter(\"resource\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: { id: 2 },\n      }),\n    ).resolves.toEqual([{ id: 1 }]);\n\n    expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n      id: 1,\n      target: \"target\",\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: { id: 2 },\n    });\n  });\n});\n\nit(\"should remove summary suffix\", () => {\n  const getOne = vi.fn();\n  const getList = vi.fn();\n  const getMany = vi.fn();\n  const getManyReference = vi.fn();\n  const create = vi.fn();\n  const del = vi.fn();\n  const deleteMany = vi.fn();\n  const update = vi.fn();\n  const updateMany = vi.fn();\n\n  const dataProvider: DataProvider = withSupabaseFilterAdapter({\n    getOne,\n    getList,\n    getMany,\n    getManyReference,\n    create,\n    delete: del,\n    deleteMany,\n    update,\n    updateMany,\n  });\n\n  expect(\n    Promise.all([\n      dataProvider.getOne(\"resource_summary\", { id: 1 }),\n      dataProvider.getList(\"resource_summary\", {\n        pagination: { page: 1, perPage: 10 },\n      }),\n      dataProvider.getMany(\"resource_summary\", { ids: [1] }),\n      dataProvider.getManyReference(\"resource_summary\", {\n        id: 1,\n        target: \"target\",\n        pagination: { page: 1, perPage: 10 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: {},\n      }),\n      dataProvider.create(\"resource_summary\", { data: {} }),\n      dataProvider.delete(\"resource_summary\", { id: 1 }),\n      dataProvider.deleteMany(\"resource_summary\", { ids: [1] }),\n      dataProvider.update(\"resource_summary\", {\n        id: 1,\n        data: {},\n        previousData: {},\n      }),\n      dataProvider.updateMany(\"resource_summary\", { ids: [1], data: {} }),\n    ]),\n  ).resolves.toHaveLength(9);\n\n  expect(getOne).toHaveBeenCalledWith(\"resource\", { id: 1 });\n  expect(getList).toHaveBeenCalledWith(\"resource\", {\n    pagination: { page: 1, perPage: 10 },\n    filter: undefined,\n  });\n  expect(getMany).toHaveBeenCalledWith(\"resource\", { ids: [1] });\n  expect(getManyReference).toHaveBeenCalledWith(\"resource\", {\n    id: 1,\n    target: \"target\",\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"id\", order: \"ASC\" },\n    filter: {},\n  });\n  expect(create).toHaveBeenCalledWith(\"resource\", { data: {} });\n  expect(del).toHaveBeenCalledWith(\"resource\", { id: 1 });\n  expect(deleteMany).toHaveBeenCalledWith(\"resource\", { ids: [1] });\n  expect(update).toHaveBeenCalledWith(\"resource\", {\n    id: 1,\n    data: {},\n    previousData: {},\n  });\n  expect(updateMany).toHaveBeenCalledWith(\"resource\", { ids: [1], data: {} });\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/internal/listParser.ts",
      "content": "export const UNQUOTED_ALLOWED_CHARS = \"[A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿0-9-]+\";\nexport const QUOTED_ALLOWED_CHARS = \"[A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿0-9, -]+\";\nexport const LIST_REGEX_BASE = `(${UNQUOTED_ALLOWED_CHARS}|\"${QUOTED_ALLOWED_CHARS}\")(,(${UNQUOTED_ALLOWED_CHARS}|\"${QUOTED_ALLOWED_CHARS}\"))*`;\n\n/**\n * List represents a list of values, quoted or not.\n *\n * e.g. 1\n * e.g 1,2\n * e.g \"a\",\"b\"\n * e.g \"a\",b\n */\nexport function parseList(list: string) {\n  const parsedItems = [];\n\n  let currentItem = \"\";\n  let currentQuoted = false;\n  for (const char of list) {\n    if (char === \",\") {\n      if (currentQuoted) {\n        currentItem += char;\n        continue;\n      }\n\n      parsedItems.push(currentItem);\n      currentItem = \"\";\n      continue;\n    }\n\n    if (char === '\"') {\n      currentQuoted = !currentQuoted;\n      continue;\n    }\n\n    currentItem += char;\n  }\n  if (currentItem) {\n    parsedItems.push(currentItem);\n  }\n\n  return parsedItems.map((v: string) => {\n    const parsedFloat = Number.parseFloat(v);\n    if (!Number.isNaN(parsedFloat)) {\n      return parsedFloat;\n    }\n    return v;\n  });\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/utils.ts",
      "content": "import faker from \"faker/locale/en\";\n\nexport const weightedArrayElement = (values: any[], weights: any) =>\n  faker.random.arrayElement(\n    values.reduce(\n      (acc, value, index) => acc.concat(new Array(weights[index]).fill(value)),\n      [],\n    ),\n  );\n\nexport const weightedBoolean = (likelyhood: number) =>\n  faker.datatype.number(99) < likelyhood;\n\nexport const randomDate = (minDate?: Date, maxDate?: Date) => {\n  const minTs =\n    minDate instanceof Date\n      ? minDate.getTime()\n      : Date.now() - 5 * 365 * 24 * 60 * 60 * 1000; // 5 years\n  const maxTs = maxDate instanceof Date ? maxDate.getTime() : Date.now();\n  const range = maxTs - minTs;\n  const randomRange = faker.datatype.number({ max: range });\n  // move it more towards today to account for traffic increase\n  const ts = Math.sqrt(randomRange / range) * range;\n  return new Date(minTs + ts);\n};\n\nexport const randomFloat = (min: number, max: number) =>\n  parseFloat(faker.datatype.number({ min, max, precision: 0.01 }).toFixed(2));\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/types.ts",
      "content": "import type {\n  Company,\n  Contact,\n  ContactNote,\n  Deal,\n  DealNote,\n  Sale,\n  Tag,\n  Task,\n} from \"../../../types\";\n\nexport interface Db {\n  companies: Required<Company>[];\n  contacts: Required<Contact>[];\n  contactNotes: ContactNote[];\n  deals: Deal[];\n  dealNotes: DealNote[];\n  sales: Sale[];\n  tags: Tag[];\n  tasks: Task[];\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/tasks.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport { defaultTaskTypes } from \"../../../root/defaultConfiguration\";\nimport type { Task } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\ntype TaskType = (typeof defaultTaskTypes)[number];\n\nexport const type: TaskType[] = [\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Email\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Call\",\n  \"Demo\",\n  \"Lunch\",\n  \"Meeting\",\n  \"Follow-up\",\n  \"Follow-up\",\n  \"Thank you\",\n  \"Ship\",\n  \"None\",\n];\n\nexport const generateTasks = (db: Db) => {\n  return Array.from(Array(400).keys()).map<Task>((id) => {\n    const contact = random.arrayElement(db.contacts);\n    contact.nb_tasks++;\n    return {\n      id,\n      contact_id: contact.id,\n      type: random.arrayElement(defaultTaskTypes),\n      text: lorem.sentence(),\n      due_date: randomDate(\n        datatype.boolean() ? new Date() : new Date(contact.first_seen),\n        new Date(Date.now() + 100 * 24 * 60 * 60 * 1000),\n      ).toISOString(),\n      done_date: undefined,\n      sales_id: 0,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/tags.ts",
      "content": "import type { Db } from \"./types\";\n\nconst tags = [\n  { id: 0, name: \"football-fan\", color: \"#eddcd2\" },\n  { id: 1, name: \"holiday-card\", color: \"#fff1e6\" },\n  { id: 2, name: \"influencer\", color: \"#fde2e4\" },\n  { id: 3, name: \"manager\", color: \"#fad2e1\" },\n  { id: 4, name: \"musician\", color: \"#c5dedd\" },\n  { id: 5, name: \"vip\", color: \"#dbe7e4\" },\n];\n\nexport const generateTags = (_: Db) => {\n  return [...tags];\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/sales.ts",
      "content": "import { internet, name } from \"faker/locale/en_US\";\n\nimport type { RAFile, Sale } from \"../../../types\";\nimport type { Db } from \"./types\";\n\nexport const generateSales = (_: Db): Sale[] => {\n  const randomSales = Array.from(Array(5).keys()).map((id) => {\n    const first_name = name.firstName();\n    const last_name = name.lastName();\n    const email = internet.email(first_name, last_name);\n\n    return {\n      id: id + 1,\n      user_id: `${id + 1}`,\n      first_name,\n      last_name,\n      email,\n      password: \"demo\",\n      administrator: false,\n    };\n  });\n  return [\n    {\n      id: 0,\n      user_id: \"0\",\n      first_name: \"Jane\",\n      last_name: \"Doe\",\n      email: \"janedoe@atomic.dev\",\n      password: \"demo\",\n      administrator: true,\n      avatar: {\n        src: \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4gKgSUNDX1BST0ZJTEUAAQEAAAKQbGNtcwQwAABtbnRyUkdCIFhZWiAH3wAIABMAEgAWADFhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtkZXNjAAABCAAAADhjcHJ0AAABQAAAAE53dHB0AAABkAAAABRjaGFkAAABpAAAACxyWFlaAAAB0AAAABRiWFlaAAAB5AAAABRnWFlaAAAB+AAAABRyVFJDAAACDAAAACBnVFJDAAACLAAAACBiVFJDAAACTAAAACBjaHJtAAACbAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAABwAAAAcAHMAUgBHAEIAIABiAHUAaQBsAHQALQBpAG4AAG1sdWMAAAAAAAAAAQAAAAxlblVTAAAAMgAAABwATgBvACAAYwBvAHAAeQByAGkAZwBoAHQALAAgAHUAcwBlACAAZgByAGUAZQBsAHkAAAAAWFlaIAAAAAAAAPbWAAEAAAAA0y1zZjMyAAAAAAABDEoAAAXj///zKgAAB5sAAP2H///7ov///aMAAAPYAADAlFhZWiAAAAAAAABvlAAAOO4AAAOQWFlaIAAAAAAAACSdAAAPgwAAtr5YWVogAAAAAAAAYqUAALeQAAAY3nBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltwYXJhAAAAAAADAAAAAmZmAADypwAADVkAABPQAAAKW2Nocm0AAAAAAAMAAAAAo9cAAFR7AABMzQAAmZoAACZmAAAPXP/bAEMACAYGBwYFCAcHBwkJCAoMFA0MCwsMGRITDxQdGh8eHRocHCAkLicgIiwjHBwoNyksMDE0NDQfJzk9ODI8LjM0Mv/bAEMBCQkJDAsMGA0NGDIhHCEyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMv/AABEIAIAAgAMBIgACEQEDEQH/xAAcAAABBAMBAAAAAAAAAAAAAAABAAUGBwIDBAj/xAA2EAABAwMBBgMHAwQDAQAAAAABAAIDBAUREgYTITFBUSJxgRQyYZGxwdEHQqEkUmLhFRYjkv/EABoBAAIDAQEAAAAAAAAAAAAAAAIDAAEEBQb/xAAkEQACAgIDAAEEAwAAAAAAAAAAAQIRAyEEEjETBSJRcTJBYf/aAAwDAQACEQMRAD8AuIIoIogAooIqygorB72xsc97g1rRkk9FFrlfnVD3Rwu0Qj5uQyko+hRi5eEjlr6aEkOlBI6N4rSbpCG6j4R0zzPoFEIpZpn+Ahv+TuJ9E9Qtipodc0haD15ud5BI+Vsb8aXoq/a6GgJ1UsrgBknTj6rgp/1JtEkgjnbNTk9Xxkt/+m5Cbrvbam9sc2XeU9G0jTFry6Q9M/hddk/T6kpId7UwNmqJCOBOGxjoD3KLvIroiX0VxprhCJaeVr2njlpyutR+k2dlttQZ4KwMZpwIGjwD5lbI785leaSppZWHmJG+JpHfKYppgOLQ9pIAhwBHIpIwBJFJBQhgiEAiFRYQkgmzaCuNDaZHsOJHeBvmVG6VkSt0Me0l93spoqY5Y0+N3Qn8JgjdrcA3xOPU9f8AS485Jy4c8ucep/CzirNBIh4D9zz1WGU7dmyMElRIIXspeBw+fGeJ4N8/wtsEstTUtHFzz1Pb7BNVHvJQA0EAnOo83fH/AGpBR7qniw14yfekz9+qFMNxHiljYwjhqc3kTxPxwnaIZA+6ZoJWDGhjnZ68gnaEvewftHw4BOixTVGc2GsOdI4c3KFXmSuq75Rw0kQ3EWZKieQaQG8g0D4n7KauaGgiNu8eeJJPBN89JLUN8btWg5HDAL++OwUZSMbTWxV9vZNFqxyIcMEELuTdTBtNUbiP3A0D5BOC0QdozzVMWUksoIwTBFBIKEMlFdtJSIKaMHHEuKlKg+3Ly6rgizhugl3wHVLyv7WMxK5Ih8k2+IAJEecNGeLvj5LvoossDsZHl9E2x6ZZNTvDGPp2WFde45P6WlqI4tPAZIGT6rAb0vwSiOox4RgA+84nn6ruiuAhLdA1n+5x5Kt6SsrYagtqqkyuJ8Jxj+FLpIql9qM0b9GW8Ceioaoa2TigrXStDsMb8SOKeYtUgGpxLe5+wVQ2eouftIabs52T7ugHPqrOtNNX7gb+r3zSPE1zNJPljknQaehGSFDo6piax5Em7iZ78h+gXJV1OId7lzIgzIYOePyue4QvxGGs8OsAN6D/ACPfH1QinirgZmODoi4Mb5BFYlqjfSsc58kjxgkN4dua61wWWqFbb2VGCDM4uAPMN6LsJ4p+LwRlM8pZWGUU0UBFYhFUWFV/t0S67xR8muhGT8MqwFDNvKJz4IqxgyWjQ49uyXl3EbidSKxrp31VWaKnJaxoySO6aX7INZG9swlcHuD3OyMkjlxKdLWA2uqJH/3NH8KRVNWz2XJ7LCm1tHSUIyWyL0NvdC6CnBeQHjRqOSB2VwVdnd/1YwRt/wDQx8Pkq4sX9XdoXubpZrGCeo7q7i3eW0OjbqLW8B3RRjdkm+tJHn6usdbV1JY6rnpmBww5jT4QPLn6q09jLdcKBsRgv0lZSFgaaaoYXBuBza4kuB7g5HwCa6y50tRWvi3ZjeHYc1wwQVMdm42NaC3lhXBu6JkikuzHS4QuNuqCPf3biPPCqj9OdonubHa6txLyXkPJ65JH1x6K27tKYrXVPAyRE/A7nBVE7OUEtJtDSs0k6JwHO8zghMemZ6bjZcdqjZT0jo2DAY4tC68rVBHuosY4klx81sWnGqiYcjuRkllAIhGCBFBFUWFc9dSR11FLTyDLXtI8l0BJUXZRt4tNRZ7hPFI3Trw5p6HHBcEk0jgwO93l6q3tsrJ/y1oL4WZqYTqZ8R1H0VRVEDKqikgkaQRkdiCsOWHWR0+Pk7RFRzVNHXQmNwc1pHAHBVq2m+19QIzTgMhaMFsjclx+ap2wW6gn3dNXvqIpA7G+DstcB9CrVtVqsVDa4Zpa2eUmPIDS4knIzgD4FUou9Dvtqpe/oZ9qrfUR1Elw3ZDy7UeGAVKtibgKi3skzwPDj0KiV7ornc6xk8EtdTW+QhraSZ+S49SW8cAeamWzlsFupBG39ztXkotSKl/CmO21N3pbLs7U3GtL/Z4tOsMGScuAwB6qK7JUrbs1t6ex+5kOuESBoceJ4uDeGfJP+1NpO0NLSWyRgNE6cS1Rzza3iGjzOPknKCnipadkEEbY4o2hrWtGAAFojj7O2YJ5eq6oyKCywlhaTIBEJJKEMQigEVRYUViioQJAIIPVVrtzYW0FY2507cQVLtMoH7X9/X6hWVlcl0pKWvtlRTVuPZ3sOs5xpxx1A9COaDJDtGhuKbhKyjW2uT2newSuZq544g+in2ytGYpGzTPMj28WgNAwofRV0cFU6F7w5oOGudw1DoVPbRdKCBrdU0eojg1pyT6BYbr+zsd5dKRIvZN6/ey4yPhyXRTx+PDeXfssaZz6wBzssj6N6nzTiyJrAABgI1vaMrdaZp06SQTniktkvv5WtbIO4o5+RVJgwkikjAAkigVCGsJZWuSaOGMySvaxg5uccAJiqtqqeNxbSxOmP9x8I/KCU4x9DjCUvESIJuvG0Fp2fp2zXWvhpWPzo3h4uxzwBxKi1XtTcJGnS5sDe7Bx+ZVD7WX+p2gvs1TNM+VkZ3cOp2fCD9+amOayPReTG4LZaF2/XVjKmRlotTZIG5DZal5Bce+kch5lcLNqL5erSJrhXPd7SNRiYA2No6AAKocHGOqs21NJs1K3HERgfwg5T6xSQzixTk2zAtEziCn6wwbmoa4DHHoE1tgO9BA9FJLfTua0ODeK5sjpw0WFaagua0Ek+akAcC3KiNnbI0AkKTsfiLJTsb0IyrZue3U3yULuW39stV+fbKlkmmMAPmZ4sPPTCeNoL9HZbPUVbiCWN8I7novPE9TLVVktTM4ukkLnuJ6kldPg4fkk2/DncyfSKr09C2zaizXZzI6SvidM/lE7wv8AkU7rznsdUvG1Nvbk5FWz6r0O2XuPkj5EYYpJJ+isPfIm6NqCQcDySSk0/A2mvStrpepLtWu0kimYcRt+5+K1sZlqa6LmMp13ga1cuUnJ2zrQioqkM21VULfs7VzA4foLWeZ4fdUnjAHmrI/Uiv8A6OmpQffeXkfAD8lVyBlkY75K6XDhWO/yc7ly++vwGMZljGM5I+qvWlpab2eMNiDQGjgAqNb4J2EftwR6cV6Et0Daihp5WjwyRtcPUIebGkhnCabZjTWykmOHsHDkU7U9BHF7ucLXFTljuSc4W8srnUb26OmmeI2Dgt7qzIw44C1BgwmLaq7w2a0S1Dj4sYYM8S7oEyKb0hcmvWRD9S9pI6qaCz0rsiM7ydw79B6c/kq/Mni7cM/RYmd9XUyVEpJe4l7s9StD3nWT105+y9NxsXw4lE8/nyfLkch32Lk07X21zjw3+r5L0HHUa25yvPWxzc7YW9nYk/wVdrKgsAHRcn6lKpx/R0+BG4N/6P8AFL4hxTg2IvZkc1HqSoy8EqUUUgfGFjxt3o0ZUq2f/9k=\",\n      } as RAFile,\n    },\n    ...randomSales,\n  ];\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/index.ts",
      "content": "import { generateCompanies } from \"./companies\";\nimport { generateContactNotes } from \"./contactNotes\";\nimport { generateContacts } from \"./contacts\";\nimport { generateDealNotes } from \"./dealNotes\";\nimport { generateDeals } from \"./deals\";\nimport { finalize } from \"./finalize\";\nimport { generateSales } from \"./sales\";\nimport { generateTags } from \"./tags\";\nimport { generateTasks } from \"./tasks\";\nimport type { Db } from \"./types\";\n\nexport default (): Db => {\n  const db = {} as Db;\n  db.sales = generateSales(db);\n  db.tags = generateTags(db);\n  db.companies = generateCompanies(db);\n  db.contacts = generateContacts(db);\n  db.contactNotes = generateContactNotes(db);\n  db.deals = generateDeals(db);\n  db.dealNotes = generateDealNotes(db);\n  db.tasks = generateTasks(db);\n  finalize(db);\n\n  return db;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/finalize.ts",
      "content": "import type { Db } from \"./types\";\n\nexport const finalize = (db: Db) => {\n  // set contact status according to the latest note\n  db.contactNotes\n    .sort((a, b) => new Date(a.date).valueOf() - new Date(b.date).valueOf())\n    .forEach((note) => {\n      db.contacts[note.contact_id as number].status = note.status;\n    });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/deals.ts",
      "content": "import { add } from \"date-fns\";\nimport { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport {\n  defaultDealCategories,\n  defaultDealStages,\n} from \"../../../root/defaultConfiguration\";\nimport type { Deal } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateDeals = (db: Db): Deal[] => {\n  const deals = Array.from(Array(50).keys()).map((id) => {\n    const company = random.arrayElement(db.companies);\n    company.nb_deals++;\n    const contacts = random.arrayElements(\n      db.contacts.filter((contact) => contact.company_id === company.id),\n      datatype.number({ min: 1, max: 3 }),\n    );\n    const lowercaseName = lorem.words();\n    const created_at = randomDate(new Date(company.created_at)).toISOString();\n\n    const expected_closing_date = randomDate(\n      new Date(created_at),\n      add(new Date(created_at), { months: 6 }),\n    ).toISOString();\n\n    return {\n      id,\n      name: lowercaseName[0].toUpperCase() + lowercaseName.slice(1),\n      company_id: company.id,\n      contact_ids: contacts.map((contact) => contact.id),\n      category: random.arrayElement(defaultDealCategories),\n      stage: random.arrayElement(defaultDealStages).value,\n      description: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      amount: datatype.number(1000) * 100,\n      created_at,\n      updated_at: randomDate(new Date(created_at)).toISOString(),\n      expected_closing_date,\n      sales_id: company.sales_id,\n      index: 0,\n    };\n  });\n  // compute index based on stage\n  defaultDealStages.forEach((stage) => {\n    deals\n      .filter((deal) => deal.stage === stage.value)\n      .forEach((deal, index) => {\n        deals[deal.id].index = index;\n      });\n  });\n  return deals;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/dealNotes.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateDealNotes = (db: Db) => {\n  return Array.from(Array(300).keys()).map((id) => {\n    const deal = random.arrayElement(db.deals);\n    return {\n      id,\n      deal_id: deal.id,\n      text: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      date: randomDate(\n        new Date(db.deals[deal.id as number].created_at),\n      ).toISOString(),\n      sales_id: deal.sales_id,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/contacts.ts",
      "content": "import {\n  company as fakerCompany,\n  internet,\n  lorem,\n  name,\n  phone,\n  random,\n} from \"faker/locale/en_US\";\n\nimport {\n  defaultContactGender,\n  defaultNoteStatuses,\n} from \"../../../root/defaultConfiguration\";\nimport type { Company, Contact } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate, weightedBoolean } from \"./utils\";\n\nconst maxContacts = {\n  1: 1,\n  10: 4,\n  50: 12,\n  250: 25,\n  500: 50,\n};\n\nconst getRandomContactDetailsType = () =>\n  random.arrayElement([\"Work\", \"Home\", \"Other\"]) as \"Work\" | \"Home\" | \"Other\";\n\nexport const generateContacts = (db: Db, size = 500): Required<Contact>[] => {\n  const nbAvailblePictures = 223;\n  let numberOfContacts = 0;\n\n  return Array.from(Array(size).keys()).map((id) => {\n    const has_avatar =\n      weightedBoolean(25) && numberOfContacts < nbAvailblePictures;\n    const gender = random.arrayElement(defaultContactGender).value;\n    const first_name = name.firstName(gender as any);\n    const last_name = name.lastName();\n    const email_jsonb = [\n      {\n        email: internet.email(first_name, last_name),\n        type: getRandomContactDetailsType(),\n      },\n    ];\n    const phone_jsonb = [\n      {\n        number: phone.phoneNumber(),\n        type: getRandomContactDetailsType(),\n      },\n      {\n        number: phone.phoneNumber(),\n        type: getRandomContactDetailsType(),\n      },\n    ];\n    const avatar = {\n      src: has_avatar\n        ? \"https://marmelab.com/posters/avatar-\" +\n          (223 - numberOfContacts) +\n          \".jpeg\"\n        : undefined,\n    };\n    const title = fakerCompany.bsAdjective();\n\n    if (has_avatar) {\n      numberOfContacts++;\n    }\n\n    // choose company with people left to know\n    let company: Required<Company>;\n    do {\n      company = random.arrayElement(db.companies);\n    } while (company.nb_contacts >= maxContacts[company.size]);\n    company.nb_contacts++;\n\n    const first_seen = randomDate(new Date(company.created_at)).toISOString();\n    const last_seen = first_seen;\n\n    return {\n      id,\n      first_name,\n      last_name,\n      gender,\n      title: title.charAt(0).toUpperCase() + title.substr(1),\n      company_id: company.id,\n      company_name: company.name,\n      email_jsonb,\n      phone_jsonb,\n      background: lorem.sentence(),\n      acquisition: random.arrayElement([\"inbound\", \"outbound\"]),\n      avatar,\n      first_seen: first_seen,\n      last_seen: last_seen,\n      has_newsletter: weightedBoolean(30),\n      status: random.arrayElement(defaultNoteStatuses).value,\n      tags: random\n        .arrayElements(db.tags, random.arrayElement([0, 0, 0, 1, 1, 2]))\n        .map((tag) => tag.id), // finalize\n      sales_id: company.sales_id,\n      nb_tasks: 0,\n      linkedin_url: null,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/contactNotes.ts",
      "content": "import { datatype, lorem, random } from \"faker/locale/en_US\";\n\nimport { defaultNoteStatuses } from \"../../../root/defaultConfiguration\";\nimport type { ContactNote } from \"../../../types\";\nimport type { Db } from \"./types\";\nimport { randomDate } from \"./utils\";\n\nexport const generateContactNotes = (db: Db): ContactNote[] => {\n  return Array.from(Array(1200).keys()).map((id) => {\n    const contact = random.arrayElement(db.contacts);\n    const date = randomDate(new Date(contact.first_seen));\n    contact.last_seen =\n      date > new Date(contact.last_seen)\n        ? date.toISOString()\n        : contact.last_seen;\n    return {\n      id,\n      contact_id: contact.id,\n      text: lorem.paragraphs(datatype.number({ min: 1, max: 4 })),\n      date: date.toISOString(),\n      sales_id: contact.sales_id,\n      status: random.arrayElement(defaultNoteStatuses).value,\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/fakerest/dataGenerator/companies.ts",
      "content": "import {\n  address,\n  company,\n  datatype,\n  internet,\n  lorem,\n  phone,\n  random,\n} from \"faker/locale/en_US\";\n\nimport { randomDate } from \"./utils\";\nimport { defaultCompanySectors } from \"../../../root/defaultConfiguration\";\nimport type { Company, RAFile } from \"../../../types\";\nimport type { Db } from \"./types\";\n\nconst sizes = [1, 10, 50, 250, 500];\n\nconst regex = /\\W+/;\n\nexport const generateCompanies = (db: Db, size = 55): Required<Company>[] => {\n  return Array.from(Array(size).keys()).map((id) => {\n    const name = company.companyName();\n    return {\n      id,\n      name: name,\n      logo: {\n        title: lorem.text(1),\n        src: `./logos/${id}.png`,\n      } as RAFile,\n      sector: random.arrayElement(defaultCompanySectors),\n      size: random.arrayElement(sizes) as 1 | 10 | 50 | 250 | 500,\n      linkedin_url: `https://www.linkedin.com/company/${name\n        .toLowerCase()\n        .replace(regex, \"_\")}`,\n      website: internet.url(),\n      phone_number: phone.phoneNumber(),\n      address: address.streetAddress(),\n      zipcode: address.zipCode(),\n      city: address.city(),\n      stateAbbr: address.stateAbbr(),\n      nb_contacts: 0,\n      nb_deals: 0,\n      // at least 1/3rd of companies for Jane Doe\n      sales_id: datatype.number(2) === 0 ? 0 : random.arrayElement(db.sales).id,\n      created_at: randomDate().toISOString(),\n      description: lorem.paragraph(),\n      revenue: random.arrayElement([\"Ø¯.Ø¥1M\", \"Ø¯.Ø¥10M\", \"Ø¯.Ø¥100M\", \"Ø¯.Ø¥1B\"]),\n      tax_identifier: random.alphaNumeric(10),\n      country: random.arrayElement([\"USA\", \"France\", \"UK\"]),\n      context_links: [],\n    };\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/mergeContacts.ts",
      "content": "import type { Identifier, DataProvider } from \"ra-core\";\n\nimport type { Contact, Task, Deal, ContactNote } from \"../../types\";\n\n/**\n * Merge one contact (loser) into another contact (winner).\n *\n * This function copies properties from the loser to the winner contact,\n * transfers all associated data (tasks, notes, deals) from the loser to the winner,\n * and deletes the loser contact.\n */\nexport const mergeContacts = async (\n  loserId: Identifier,\n  winnerId: Identifier,\n  dataProvider: DataProvider,\n) => {\n  // Fetch both contacts using dataProvider to get fresh data\n  const { data: winnerContact } = await dataProvider.getOne<Contact>(\n    \"contacts\",\n    { id: winnerId },\n  );\n  const { data: loserContact } = await dataProvider.getOne<Contact>(\n    \"contacts\",\n    { id: loserId },\n  );\n\n  if (!winnerContact || !loserContact) {\n    throw new Error(\"Could not fetch contacts\");\n  }\n\n  // 1. Reassign all tasks from loser to winner\n  const { data: loserTasks } = await dataProvider.getManyReference<Task>(\n    \"tasks\",\n    {\n      target: \"contact_id\",\n      id: loserId,\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: {},\n    },\n  );\n\n  const taskUpdates =\n    loserTasks?.map((task) =>\n      dataProvider.update(\"tasks\", {\n        id: task.id,\n        data: { contact_id: winnerId },\n        previousData: task,\n      }),\n    ) || [];\n\n  // 2. Reassign all notes from loser to winner\n  const { data: loserNotes } = await dataProvider.getManyReference<ContactNote>(\n    \"contactNotes\",\n    {\n      target: \"contact_id\",\n      id: loserId,\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"id\", order: \"ASC\" },\n      filter: {},\n    },\n  );\n\n  const noteUpdates =\n    loserNotes?.map((note) =>\n      dataProvider.update<ContactNote>(\"contactNotes\", {\n        id: note.id,\n        data: { contact_id: winnerId },\n        previousData: note,\n      }),\n    ) || [];\n\n  // 3. Change contact in deals - replace loser ID with winner ID in contact_ids array\n  const { data: loserDeals } = await dataProvider.getList<Deal>(\"deals\", {\n    filter: { \"contact_ids@cs\": `{${loserId}}` },\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"id\", order: \"ASC\" },\n  });\n\n  const dealUpdates =\n    loserDeals?.map((deal) => {\n      const newContactIds = deal.contact_ids\n        .filter((id) => id !== loserId)\n        .concat(winnerId)\n        .filter(\n          (id: Identifier, index: number, self: Identifier[]) =>\n            self.indexOf(id) === index,\n        ); // Remove duplicates\n\n      return dataProvider.update<Deal>(\"deals\", {\n        id: deal.id,\n        data: { contact_ids: newContactIds },\n        previousData: deal,\n      });\n    }) || [];\n\n  // 4. Update winner contact with loser data\n  const mergedEmails = mergeObjectArraysUnique(\n    winnerContact.email_jsonb || [],\n    loserContact.email_jsonb || [],\n    (email) => email.email,\n  );\n\n  const mergedPhones = mergeObjectArraysUnique(\n    winnerContact.phone_jsonb || [],\n    loserContact.phone_jsonb || [],\n    (phone) => phone.number,\n  );\n\n  const winnerUpdate = dataProvider.update<Contact>(\"contacts\", {\n    id: winnerId,\n    data: {\n      avatar:\n        winnerContact.avatar && winnerContact.avatar.src\n          ? winnerContact.avatar\n          : loserContact.avatar,\n      gender: winnerContact.gender ?? loserContact.gender,\n      first_name: winnerContact.first_name ?? loserContact.first_name,\n      last_name: winnerContact.last_name ?? loserContact.last_name,\n      title: winnerContact.title ?? loserContact.title,\n      company_id: winnerContact.company_id ?? loserContact.company_id,\n      email_jsonb: mergedEmails,\n      phone_jsonb: mergedPhones,\n      linkedin_url: winnerContact.linkedin_url || loserContact.linkedin_url,\n      background: winnerContact.background ?? loserContact.background,\n      has_newsletter:\n        winnerContact.has_newsletter ?? loserContact.has_newsletter,\n      first_seen: winnerContact.first_seen ?? loserContact.first_seen,\n      last_seen:\n        winnerContact.last_seen > loserContact.last_seen\n          ? winnerContact.last_seen\n          : loserContact.last_seen,\n      sales_id: winnerContact.sales_id ?? loserContact.sales_id,\n      tags: mergeArraysUnique(\n        winnerContact.tags || [],\n        loserContact.tags || [],\n      ),\n    },\n    previousData: winnerContact,\n  });\n\n  // Execute all updates\n  await Promise.all([\n    ...taskUpdates,\n    ...noteUpdates,\n    ...dealUpdates,\n    winnerUpdate,\n  ]);\n\n  // 5. Delete the loser contact\n  await dataProvider.delete<Contact>(\"contacts\", {\n    id: loserId,\n    previousData: loserContact,\n  });\n};\n\n// Helper functions to merge arrays and remove duplicates\n\n// For primitive arrays like tags\nconst mergeArraysUnique = <T>(arr1: T[], arr2: T[]): T[] => [\n  ...new Set([...arr1, ...arr2]),\n];\n\n// For object arrays like emails and phones\nfunction mergeObjectArraysUnique<T>(\n  arr1: T[],\n  arr2: T[],\n  getKey: (item: T) => string,\n): T[] {\n  const map = new Map<string, T>();\n\n  arr1.forEach((item) => {\n    const key = getKey(item);\n    if (key) map.set(key, item);\n  });\n\n  arr2.forEach((item) => {\n    const key = getKey(item);\n    if (key && !map.has(key)) {\n      map.set(key, item);\n    }\n  });\n\n  return Array.from(map.values());\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getContactAvatar.ts",
      "content": "import { fetchWithTimeout } from \"../../misc/fetchWithTimeout\";\nimport { DOMAINS_NOT_SUPPORTING_FAVICON } from \"../../misc/unsupportedDomains.const\";\nimport type { Contact } from \"../../types\";\n\nexport async function hash(string: string) {\n  const utf8 = new TextEncoder().encode(string);\n  const hashBuffer = await crypto.subtle.digest(\"SHA-256\", utf8);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  const hashHex = hashArray\n    .map((bytes) => bytes.toString(16).padStart(2, \"0\"))\n    .join(\"\");\n  return hashHex;\n}\n\n// Helper function to get the Gravatar URL\nasync function getGravatarUrl(email: string): Promise<string> {\n  const hashEmail = await hash(email);\n  return `https://www.gravatar.com/avatar/${hashEmail}?d=404`;\n}\n\n// Helper function to get the favicon URL\nasync function getFaviconUrl(domain: string): Promise<string | null> {\n  if (DOMAINS_NOT_SUPPORTING_FAVICON.includes(domain)) {\n    return null;\n  }\n\n  try {\n    const faviconUrl = `https://${domain}/favicon.ico`;\n    const response = await fetchWithTimeout(faviconUrl);\n    if (response.ok) {\n      return faviconUrl;\n    }\n  } catch {\n    return null;\n  }\n  return null;\n}\n\n// Main function to get the avatar URL\nexport async function getContactAvatar(\n  record: Partial<Contact>,\n): Promise<string | null> {\n  if (!record.email_jsonb || !record.email_jsonb.length) {\n    return null;\n  }\n\n  for (const { email } of record.email_jsonb) {\n    // Step 1: Try to get Gravatar image\n    const gravatarUrl = await getGravatarUrl(email);\n    try {\n      const gravatarResponse = await fetch(gravatarUrl);\n      if (gravatarResponse.ok) {\n        return gravatarUrl;\n      }\n    } catch {\n      // Gravatar not found\n    }\n\n    // Step 2: Try to get favicon from email domain\n    const domain = email.split(\"@\")[1];\n    const faviconUrl = await getFaviconUrl(domain);\n    if (faviconUrl) {\n      return faviconUrl;\n    }\n\n    // TODO: Step 3: Try to get image from LinkedIn.\n  }\n\n  return null;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getContactAvatar.spec.ts",
      "content": "import { webcrypto } from \"node:crypto\";\n\nimport type { Contact, EmailAndType } from \"../../types\";\nimport { getContactAvatar, hash } from \"./getContactAvatar\";\n\nObject.defineProperty(globalThis, \"crypto\", {\n  value: webcrypto,\n});\n\nit(\"should return gravatar URL for anthony@marmelab.com\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"anthony@marmelab.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  const hashedEmail = await hash(email[0].email);\n  expect(avatarUrl).toBe(\n    `https://www.gravatar.com/avatar/${hashedEmail}?d=404`,\n  );\n});\n\nit(\"should return favicon URL if gravatar does not exist\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"no-gravatar@gravatar.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBe(\"https://gravatar.com/favicon.ico\");\n});\n\nit(\"should not return favicon URL if not domain not allowed\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"no-gravatar@gmail.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return null if no email is provided\", async () => {\n  const record: Partial<Contact> = {};\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return null if an empty array is provided\", async () => {\n  const email: EmailAndType[] = [];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return null if email has no gravatar or validate domain\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"anthony@fake-domain-marmelab.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n\nit(\"should return gravatar URL for 2nd email if 1st email has no gravatar nor valid domain\", async () => {\n  const email: EmailAndType[] = [\n    { email: \"anthony@fake-domain-marmelab.com\", type: \"Work\" },\n    { email: \"anthony@marmelab.com\", type: \"Work\" },\n  ];\n  const record: Partial<Contact> = { email_jsonb: email };\n\n  const avatarUrl = await getContactAvatar(record);\n  const hashedEmail = await hash(email[1].email);\n  expect(avatarUrl).toBe(\n    `https://www.gravatar.com/avatar/${hashedEmail}?d=404`,\n  );\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getCompanyAvatar.ts",
      "content": "import type { Company } from \"../../types\";\n\n// Main function to get the avatar URL\nexport async function getCompanyAvatar(record: Partial<Company>): Promise<{\n  src: string;\n  title: string;\n} | null> {\n  // TODO: Step 1: Try to get image from LinkedIn.\n\n  // Step 2: Fallback to the favicon from website domain\n  if (!record.website) {\n    return null;\n  }\n  const websiteUrlWithoutScheme = record.website\n    .replace(/^https?:\\/\\//, \"\")\n    .replace(/\\/$/, \"\");\n  return {\n    src: `https://favicon.show/${websiteUrlWithoutScheme}`,\n    title: \"Company favicon\",\n  };\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/getCompanyAvatar.spec.ts",
      "content": "import type { Company } from \"../../types\";\nimport { getCompanyAvatar } from \"./getCompanyAvatar\";\n\nit(\"should return favicon URL if website url exist\", async () => {\n  const website = \"https://example.com\";\n  const record: Partial<Company> = { website };\n\n  const avatarUrl = await getCompanyAvatar(record);\n  expect(avatarUrl).toStrictEqual({\n    src: \"https://favicon.show/example.com\",\n    title: \"Company favicon\",\n  });\n});\n\nit(\"should return null if no website is provided\", async () => {\n  const record: Partial<Company> = {};\n\n  const avatarUrl = await getCompanyAvatar(record);\n  expect(avatarUrl).toBeNull();\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/canAccess.ts",
      "content": "// FIXME: This should be exported from the ra-core package\ntype CanAccessParams<\n  RecordType extends Record<string, any> = Record<string, any>,\n> = {\n  action: string;\n  resource: string;\n  record?: RecordType;\n};\n\nexport const canAccess = <\n  RecordType extends Record<string, any> = Record<string, any>,\n>(\n  role: string,\n  params: CanAccessParams<RecordType>,\n) => {\n  if (role === \"admin\") {\n    return true;\n  }\n\n  // Non admins can't access the sales resource\n  if (params.resource === \"sales\") {\n    return false;\n  }\n\n  return true;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/providers/commons/activity.ts",
      "content": "import type { DataProvider, Identifier } from \"ra-core\";\n\nimport {\n  COMPANY_CREATED,\n  CONTACT_CREATED,\n  CONTACT_NOTE_CREATED,\n  DEAL_CREATED,\n  DEAL_NOTE_CREATED,\n  QUOTE_CREATED,\n  QUOTE_UPDATED,\n  TASK_CREATED,\n  TASK_COMPLETED,\n  DEAL_STATUS_CHANGED,\n  DEAL_ARCHIVED,\n  DEAL_UNARCHIVED,\n  NOTE_DELETED,\n  QUOTE_DELETED,\n  TASK_DELETED,\n} from \"../../consts\";\nimport type {\n  Activity,\n  Company,\n  Contact,\n  ContactNote,\n  Deal,\n  DealNote,\n  Quote,\n  Task,\n} from \"../../types\";\n\n// FIXME: Requires 5 large queries to get the latest activities.\n// Replace with a server-side view or a custom API endpoint.\nexport async function getActivityLog(\n  dataProvider: DataProvider,\n  companyId?: Identifier,\n  salesId?: Identifier,\n  contactId?: Identifier,\n) {\n  const companyFilter = {} as any;\n  if (companyId) {\n    companyFilter.id = companyId;\n  } else if (salesId) {\n    companyFilter[\"sales_id@in\"] = `(${salesId})`;\n  }\n\n  const filter = {} as any;\n  if (companyId) {\n    filter.company_id = companyId;\n  } else if (salesId) {\n    filter[\"sales_id@in\"] = `(${salesId})`;\n  } else if (contactId) {\n    filter.id = contactId;\n  }\n\n  const [newCompanies, newContactsAndNotes, newDealsAndNotes, newQuotes, newTasks, statusChanges, archiveChanges, deletions] =\n    await Promise.all([\n      getNewCompanies(dataProvider, companyFilter),\n      getNewContactsAndNotes(dataProvider, filter),\n      getNewDealsAndNotes(dataProvider, filter),\n      getQuotes(dataProvider, filter),\n      getTasks(dataProvider, filter),\n      getStatusChanges(dataProvider, filter),\n      getArchiveChanges(dataProvider, filter),\n      getDeletions(dataProvider, filter),\n    ]);\n  return (\n    [...newCompanies, ...newContactsAndNotes, ...newDealsAndNotes, ...newQuotes, ...newTasks, ...statusChanges, ...archiveChanges, ...deletions]\n      // sort by date desc\n      .sort((a, b) => {\n        const tsA = a.date ? new Date(a.date).getTime() : 0;\n        const tsB = b.date ? new Date(b.date).getTime() : 0;\n        return tsB - tsA;\n      })\n      // limit to 250 activities\n      .slice(0, 250)\n  );\n}\n\nconst getNewCompanies = async (\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> => {\n  const { data: companies } = await dataProvider.getList<Company>(\"companies\", {\n    filter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n  });\n  return companies.map((company) => ({\n    id: `company.${company.id}.created`,\n    type: COMPANY_CREATED,\n    company_id: company.id,\n    company,\n    sales_id: company.sales_id,\n    date: company.created_at,\n  }));\n};\n\nasync function getNewContactsAndNotes(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n    filter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"first_seen\", order: \"DESC\" },\n  });\n\n  const recentContactNotesFilter = {} as any;\n  if (filter.sales_id) {\n    recentContactNotesFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // No company_id field in contactNote, filtering by related contacts instead.\n    // This filter is only valid if a company has less than 250 contact.\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    recentContactNotesFilter[\"contact_id@in\"] = `(${contactIds})`;\n  }\n  if (filter.id) {\n    // Filter by specific contact ID\n    recentContactNotesFilter.contact_id = filter.id;\n  }\n\n  const { data: contactNotes } = await dataProvider.getList<ContactNote>(\n    \"contactNotes\",\n    {\n      filter: recentContactNotesFilter,\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    },\n  );\n\n  const newContacts = contacts.map((contact) => ({\n    id: `contact.${contact.id}.created`,\n    type: CONTACT_CREATED,\n    company_id: contact.company_id,\n    sales_id: contact.sales_id,\n    contact,\n    date: contact.first_seen,\n  }));\n\n  const newContactNotes = contactNotes.map((contactNote) => ({\n    id: `contactNote.${contactNote.id}.created`,\n    type: CONTACT_NOTE_CREATED,\n    sales_id: contactNote.sales_id,\n    contactNote,\n    date: contactNote.date,\n  }));\n\n  return [...newContacts, ...newContactNotes];\n}\n\nasync function getNewDealsAndNotes(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  // For contact filtering, we need to filter deals by lead_id\n  const dealsFilter = {} as any;\n  if (filter.id) {\n    // Filter deals by lead_id (contact_id) when filtering by contact\n    dealsFilter[\"@or\"] = {\n      lead_id: filter.id,\n      \"contact_ids@cs\": `{${filter.id}}`,\n    };\n  } else {\n    Object.assign(dealsFilter, filter);\n  }\n\n  // Use \"deals\" table directly (lead-journey is just a UI-facing resource name)\n  const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n    filter: dealsFilter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n  });\n\n  const recentDealNotesFilter = {} as any;\n  if (filter.sales_id) {\n    recentDealNotesFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // No company_id field in dealNote, filtering by related deals instead.\n    // This filter is only valid if a deal has less than 250 notes.\n    const dealIds = deals.map((deal) => deal.id).join(\",\");\n    recentDealNotesFilter[\"deal_id@in\"] = `(${dealIds})`;\n  }\n  if (filter.id) {\n    // Filter deal notes by deals associated with this contact\n    const dealIds = deals.map((deal) => deal.id).join(\",\");\n    if (dealIds) {\n      recentDealNotesFilter[\"deal_id@in\"] = `(${dealIds})`;\n    } else {\n      // No deals for this contact, so no deal notes\n      // Don't return DEAL_CREATED activities - they're duplicates of CONTACT_CREATED\n      return [];\n    }\n  }\n\n  const { data: dealNotes } = await dataProvider.getList<DealNote>(\n    \"dealNotes\",\n    {\n      filter: recentDealNotesFilter,\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    },\n  );\n\n  // Filter out DEAL_CREATED activities - they're duplicates of CONTACT_CREATED\n  // Only return deal notes, not deal creation activities\n  const newDealNotes = dealNotes.map((dealNote) => ({\n    id: `dealNote.${dealNote.id}.created`,\n    type: DEAL_NOTE_CREATED,\n    sales_id: dealNote.sales_id,\n    dealNote,\n    date: dealNote.date,\n  }));\n\n  return [...newDealNotes];\n}\n\nasync function getQuotes(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const quotesFilter = {} as any;\n  if (filter.sales_id) {\n    quotesFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // Filter by contacts in the company\n    const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n      filter: { company_id: filter.company_id },\n      pagination: { page: 1, perPage: 250 },\n    });\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    if (contactIds) {\n      quotesFilter[\"contact_id@in\"] = `(${contactIds})`;\n    } else {\n      return [];\n    }\n  }\n  if (filter.id) {\n    // Filter by specific contact ID\n    quotesFilter.contact_id = filter.id;\n  }\n\n  const { data: quotes } = await dataProvider.getList<Quote>(\"quotes\", {\n    filter: quotesFilter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"updated_at\", order: \"DESC\" },\n  });\n\n  return quotes.map((quote) => {\n    // Use updated_at if it's different from created_at (quote was updated)\n    const isUpdated = quote.updated_at && quote.updated_at !== quote.created_at;\n    return {\n      id: isUpdated\n        ? `quote.${quote.id}.updated`\n        : `quote.${quote.id}.created`,\n      type: isUpdated ? QUOTE_UPDATED : QUOTE_CREATED,\n      sales_id: quote.sales_id,\n      quote,\n      date: isUpdated ? quote.updated_at : quote.created_at,\n    };\n  });\n}\n\nasync function getTasks(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const tasksFilter = {} as any;\n  if (filter.sales_id) {\n    tasksFilter.sales_id = filter.sales_id;\n  }\n  if (filter.company_id) {\n    // Filter by contacts in the company\n    const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n      filter: { company_id: filter.company_id },\n      pagination: { page: 1, perPage: 250 },\n    });\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    if (contactIds) {\n      tasksFilter[\"contact_id@in\"] = `(${contactIds})`;\n    } else {\n      return [];\n    }\n  }\n  if (filter.id) {\n    // Filter by specific contact ID\n    tasksFilter.contact_id = filter.id;\n  }\n\n  const { data: tasks } = await dataProvider.getList<Task>(\"tasks\", {\n    filter: tasksFilter,\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"due_date\", order: \"DESC\" },\n  });\n\n  const activities: Activity[] = [];\n\n  tasks.forEach((task) => {\n    // Task completed activity\n    if (task.done_date) {\n      const completionDate = task.done_date || task.due_date || task.created_at;\n      if (completionDate) {\n        activities.push({\n          id: `task.${task.id}.completed`,\n          type: TASK_COMPLETED,\n          sales_id: task.sales_id,\n          task,\n          date: completionDate,\n        });\n      }\n    }\n    // Task created activity - always include; prefer created_at then due_date (never use current time)\n    const creationDate = task.created_at || task.due_date;\n    if (creationDate) {\n      activities.push({\n        id: `task.${task.id}.created`,\n        type: TASK_CREATED,\n        sales_id: task.sales_id,\n        task,\n        date: creationDate,\n      });\n    }\n  });\n\n  return activities;\n}\n\nasync function getStatusChanges(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const statusChangeFilter = {} as any;\n  \n  if (filter.sales_id) {\n    statusChangeFilter.sales_id = filter.sales_id;\n  }\n  \n  // Build deal filter to find relevant deals\n  const dealsFilter: any = {};\n  if (filter.company_id) {\n    dealsFilter.company_id = filter.company_id;\n  }\n  if (filter.id) {\n    // When filtering by contact, we need to find deals associated with that contact\n    dealsFilter[\"@or\"] = {\n      lead_id: filter.id,\n      \"contact_ids@cs\": `{${filter.id}}`,\n    };\n  }\n  \n  // If we have deal filters, fetch deals first to get deal IDs\n  let dealIds: Identifier[] = [];\n  if (Object.keys(dealsFilter).length > 0) {\n    const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n      filter: dealsFilter,\n      pagination: { page: 1, perPage: 250 },\n    });\n    \n    dealIds = deals.map((deal) => deal.id);\n    if (dealIds.length > 0) {\n      statusChangeFilter[\"deal_id@in\"] = `(${dealIds.join(\",\")})`;\n    } else {\n      // No deals found, return empty array\n      return [];\n    }\n  }\n  \n  // Also filter by company_id if provided (for activity_log entries that have it)\n  if (filter.company_id) {\n    statusChangeFilter.company_id = filter.company_id;\n  }\n\n  // Read status changes from activity_log table\n  let statusChanges: any[] = [];\n  try {\n    const result = await dataProvider.getList<any>(\"activity_log\", {\n      filter: {\n        ...statusChangeFilter,\n        type: \"deal.statusChanged\",\n      },\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    });\n    statusChanges = result?.data || [];\n  } catch (error) {\n    // If activity_log table doesn't exist or query fails, return empty array\n    // This can happen if the migration hasn't been run yet\n    console.warn(\"Failed to fetch status changes from activity_log:\", error);\n    return [];\n  }\n\n  // If no status changes found, return empty array\n  // Note: This is expected if no status changes have been logged yet\n  if (!statusChanges || statusChanges.length === 0) {\n    return [];\n  }\n\n  // Fetch the current deal data for each status change\n  const uniqueDealIds = [...new Set(statusChanges.map((sc: any) => sc.deal_id).filter(Boolean))];\n  \n  let dealsMap = new Map<Identifier, Deal>();\n  if (uniqueDealIds.length > 0) {\n    const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n      filter: {\n        \"id@in\": `(${uniqueDealIds.join(\",\")})`,\n      },\n      pagination: { page: 1, perPage: 250 },\n    });\n    deals?.forEach((deal) => {\n      dealsMap.set(deal.id, deal);\n    });\n  }\n\n  return statusChanges.map((statusChange: any) => {\n    const deal = dealsMap.get(statusChange.deal_id);\n    if (!deal) {\n      // Deal might have been deleted, skip this status change\n      return null;\n    }\n    \n    return {\n      id: `deal.${statusChange.deal_id}.statusChanged.${statusChange.id}`,\n      type: DEAL_STATUS_CHANGED,\n      company_id: statusChange.company_id || deal.company_id,\n      sales_id: statusChange.sales_id || deal.sales_id,\n      deal: {\n        ...deal,\n        // Use the new_stage from the activity log, or fall back to current deal stage\n        stage: statusChange.new_stage || deal.stage,\n      },\n      old_stage: statusChange.old_stage,\n      new_stage: statusChange.new_stage,\n      date: statusChange.date || new Date().toISOString(),\n    };\n  }).filter((activity): activity is Activity => activity !== null);\n}\n\nasync function getArchiveChanges(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const archiveFilter = {} as any;\n  \n  if (filter.sales_id) {\n    archiveFilter.sales_id = filter.sales_id;\n  }\n  \n  // Build deal filter to find relevant deals\n  const dealsFilter: any = {};\n  if (filter.company_id) {\n    dealsFilter.company_id = filter.company_id;\n  }\n  if (filter.id) {\n    // When filtering by contact, we need to find deals associated with that contact\n    dealsFilter[\"@or\"] = {\n      lead_id: filter.id,\n      \"contact_ids@cs\": `{${filter.id}}`,\n    };\n  }\n  \n  // If we have deal filters, fetch deals first to get deal IDs\n  let dealIds: Identifier[] = [];\n  if (Object.keys(dealsFilter).length > 0) {\n    const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n      filter: dealsFilter,\n      pagination: { page: 1, perPage: 250 },\n    });\n    \n    dealIds = deals.map((deal) => deal.id);\n    if (dealIds.length > 0) {\n      archiveFilter[\"deal_id@in\"] = `(${dealIds.join(\",\")})`;\n    } else {\n      // No deals found, return empty array\n      return [];\n    }\n  }\n  \n  // Also filter by company_id if provided\n  if (filter.company_id) {\n    archiveFilter.company_id = filter.company_id;\n  }\n\n  // Read archive changes from activity_log table\n  let archiveChanges: any[] = [];\n  try {\n    const result = await dataProvider.getList<any>(\"activity_log\", {\n      filter: {\n        ...archiveFilter,\n        \"type@in\": \"(deal.archived,deal.unarchived)\",\n      },\n      pagination: { page: 1, perPage: 250 },\n      sort: { field: \"date\", order: \"DESC\" },\n    });\n    archiveChanges = result?.data || [];\n  } catch (error) {\n    console.warn(\"Failed to fetch archive changes from activity_log:\", error);\n    return [];\n  }\n\n  // If no archive changes found, return empty array\n  if (!archiveChanges || archiveChanges.length === 0) {\n    return [];\n  }\n\n  // Fetch the current deal data for each archive change\n  const uniqueDealIds = [...new Set(archiveChanges.map((ac: any) => ac.deal_id).filter(Boolean))];\n  \n  let dealsMap = new Map<Identifier, Deal>();\n  if (uniqueDealIds.length > 0) {\n    const { data: deals } = await dataProvider.getList<Deal>(\"deals\", {\n      filter: {\n        \"id@in\": `(${uniqueDealIds.join(\",\")})`,\n      },\n      pagination: { page: 1, perPage: 250 },\n    });\n    deals?.forEach((deal) => {\n      dealsMap.set(deal.id, deal);\n    });\n  }\n\n  return archiveChanges.map((archiveChange: any) => {\n    const deal = dealsMap.get(archiveChange.deal_id);\n    if (!deal) {\n      // Deal might have been deleted, skip this archive change\n      return null;\n    }\n    \n    const activityType = archiveChange.type === \"deal.archived\" ? DEAL_ARCHIVED : DEAL_UNARCHIVED;\n    \n    return {\n      id: `deal.${archiveChange.deal_id}.${archiveChange.type}.${archiveChange.id}`,\n      type: activityType,\n      company_id: archiveChange.company_id || deal.company_id,\n      sales_id: archiveChange.sales_id || deal.sales_id,\n      deal,\n      date: archiveChange.date || new Date().toISOString(),\n    };\n  }).filter((activity): activity is Activity => activity !== null);\n}\n\nasync function getDeletions(\n  dataProvider: DataProvider,\n  filter: any,\n): Promise<Activity[]> {\n  const deletionFilter = {} as any;\n  if (filter.sales_id) {\n    deletionFilter.sales_id = filter.sales_id;\n  }\n  if (filter.id) {\n    // Filter by specific contact ID\n    deletionFilter.contact_id = filter.id;\n  }\n  if (filter.company_id) {\n    // For company filter, we need to get contact IDs first\n    const { data: contacts } = await dataProvider.getList<Contact>(\"contacts\", {\n      filter: { company_id: filter.company_id },\n      pagination: { page: 1, perPage: 250 },\n    });\n    const contactIds = contacts.map((contact) => contact.id).join(\",\");\n    if (contactIds) {\n      deletionFilter[\"contact_id@in\"] = `(${contactIds})`;\n    } else {\n      return [];\n    }\n  }\n\n  const { data: deletions } = await dataProvider.getList<any>(\"activity_log\", {\n    filter: {\n      ...deletionFilter,\n      \"type@in\": \"(note.deleted,quote.deleted,task.deleted)\",\n    },\n    pagination: { page: 1, perPage: 250 },\n    sort: { field: \"date\", order: \"DESC\" },\n  });\n\n  return deletions.map((deletion) => {\n    const baseActivity = {\n      id: `deletion.${deletion.id}`,\n      sales_id: deletion.sales_id,\n      date: deletion.date,\n    };\n\n    if (deletion.type === \"note.deleted\") {\n      return {\n        ...baseActivity,\n        type: NOTE_DELETED,\n        contact_id: deletion.contact_id,\n        deal_id: deletion.deal_id,\n        note_text: deletion.note_text,\n      };\n    } else if (deletion.type === \"quote.deleted\") {\n      return {\n        ...baseActivity,\n        type: QUOTE_DELETED,\n        contact_id: deletion.contact_id,\n        quote_amount: deletion.quote_amount,\n        quote_description: deletion.quote_description,\n      };\n    } else if (deletion.type === \"task.deleted\") {\n      return {\n        ...baseActivity,\n        type: TASK_DELETED,\n        contact_id: deletion.contact_id,\n        task_text: deletion.task_text,\n        task_type: deletion.task_type,\n      };\n    }\n    return null;\n  }).filter((activity): activity is Activity => activity !== null);\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/utils.ts",
      "content": "import {\n  crmDateTimeInputString,\n  crmDateTimeStringToISO,\n} from \"../misc/timezone\";\n\nexport const getCurrentDate = () => crmDateTimeInputString();\n\nexport const formatNoteDate = (dateString: string) =>\n  crmDateTimeStringToISO(dateString) ?? dateString;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/index.ts",
      "content": "export * from \"./NoteCreate\";\nexport * from \"./NotesIterator\";\nexport * from \"./StatusSelector\";\nexport * from \"./UnifiedNotesIterator\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/UnifiedNotesIterator.tsx",
      "content": "import {\n  useGetList,\n  ResourceContextProvider,\n  useRecordContext,\n} from \"ra-core\";\nimport { useMemo } from \"react\";\n\nimport type { ContactNote, DealNote } from \"../types\";\nimport { Note } from \"./Note\";\nimport { UnifiedNoteCreate } from \"./UnifiedNoteCreate\";\n\nexport const UnifiedNotesIterator = ({\n  reference,\n  showStatus,\n  contactId,\n  dealId,\n  dealIds,\n  leadId,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  showStatus?: boolean;\n  contactId?: string | number;\n  dealId?: string | number;\n  dealIds?: (string | number)[]; // Support multiple deal IDs\n  leadId?: string | number;\n}) => {\n  // Fetch contact notes if we have a contactId or leadId\n  const contactNotesId = contactId || leadId;\n  // Support both camelCase and snake_case table names (legacy vs new)\n  const {\n    data: contactNotesCamel,\n    isPending: contactNotesPendingCamel,\n    error: contactNotesErrorCamel,\n    refetch: refetchContactNotesCamel,\n  } = useGetList<ContactNote>(\n    \"contactNotes\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: contactNotesId ? { contact_id: contactNotesId } : {},\n    },\n    {\n      enabled: !!contactNotesId,\n      retry: false,\n    },\n  );\n  const {\n    data: contactNotesSnake,\n    isPending: contactNotesPendingSnake,\n    error: contactNotesErrorSnake,\n    refetch: refetchContactNotesSnake,\n  } = useGetList<ContactNote>(\n    \"contact_notes\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: contactNotesId ? { contact_id: contactNotesId } : {},\n    },\n    {\n      enabled: !!contactNotesId,\n      retry: false,\n    },\n  );\n\n  // Use dealIds array if provided, otherwise fall back to single dealId\n  const dealIdsToFetch = dealIds && dealIds.length > 0 ? dealIds : (dealId ? [dealId] : []);\n  \n  // Fetch deal notes for all deals\n  const {\n    data: dealNotesCamel,\n    isPending: dealNotesPendingCamel,\n    error: dealNotesErrorCamel,\n    refetch: refetchDealNotesCamel,\n  } = useGetList<DealNote>(\n    \"dealNotes\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter:\n        dealIdsToFetch.length > 0\n          ? { \"deal_id@in\": `(${dealIdsToFetch.join(\",\")})` }\n          : { deal_id: -1 }, // Use -1 to return empty if no deals\n    },\n    {\n      enabled: dealIdsToFetch.length > 0,\n      retry: false,\n    },\n  );\n  const {\n    data: dealNotesSnake,\n    isPending: dealNotesPendingSnake,\n    error: dealNotesErrorSnake,\n    refetch: refetchDealNotesSnake,\n  } = useGetList<DealNote>(\n    \"deal_notes\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter:\n        dealIdsToFetch.length > 0\n          ? { \"deal_id@in\": `(${dealIdsToFetch.join(\",\")})` }\n          : { deal_id: -1 },\n    },\n    {\n      enabled: dealIdsToFetch.length > 0,\n      retry: false,\n    },\n  );\n\n  const contactNotes =\n    (contactNotesCamel && contactNotesCamel.length > 0\n      ? contactNotesCamel\n      : contactNotesSnake) || [];\n  const dealNotes =\n    (dealNotesCamel && dealNotesCamel.length > 0 ? dealNotesCamel : dealNotesSnake) ||\n    [];\n\n  // Only pending if both variants are pending; this prevents one failing call\n  // from keeping the loader spinning forever.\n  const contactNotesPending = contactNotesPendingCamel && contactNotesPendingSnake;\n  const dealNotesPending = dealNotesPendingCamel && dealNotesPendingSnake;\n\n  const contactNotesErrorState =\n    contactNotesErrorCamel || contactNotesErrorSnake || null;\n  const dealNotesErrorState = dealNotesErrorCamel || dealNotesErrorSnake || null;\n\n  // Merge and sort all notes by date\n  const allNotes = useMemo(() => {\n    const notes: Array<ContactNote | DealNote & { _noteType: \"contact\" | \"deal\" }> =\n      [];\n\n    if (contactNotes) {\n      contactNotes.forEach((note) => {\n        notes.push({ ...note, _noteType: \"contact\" } as any);\n      });\n    }\n\n    if (dealNotes) {\n      dealNotes.forEach((note) => {\n        notes.push({ ...note, _noteType: \"deal\" } as any);\n      });\n    }\n\n    // Sort by date descending\n    return notes.sort(\n      (a, b) =>\n        new Date(b.date).valueOf() - new Date(a.date).valueOf(),\n    );\n  }, [contactNotes, dealNotes]);\n\n  const hasNotes = allNotes.length > 0;\n  // Show an error banner only if both variants fail; otherwise show what we have\n  const hasError = contactNotesErrorState && dealNotesErrorState;\n\n  // Get the record from context (set by parent ShowBase)\n  const record = useRecordContext();\n\n  const handleRefetch = () => {\n    if (contactNotesId) {\n      refetchContactNotesCamel();\n      refetchContactNotesSnake();\n    }\n    if (dealIdsToFetch.length > 0) {\n      refetchDealNotesCamel();\n      refetchDealNotesSnake();\n    }\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      <UnifiedNoteCreate \n        reference={reference} \n        showStatus={showStatus}\n        onSuccess={handleRefetch}\n        contactId={contactNotesId}\n        dealId={dealIdsToFetch.length > 0 ? dealIdsToFetch[0] : dealId}\n      />\n      {hasError && (\n        <div className=\"text-sm text-destructive\">\n          Unable to load notes. You can still add a new note above.\n        </div>\n      )}\n      {hasNotes ? (\n        <div className=\"space-y-2\">\n          {allNotes.map((note, index) => {\n            const noteType = (note as any)._noteType || (reference === \"contacts\" ? \"contact\" : \"deal\");\n            const resource = noteType === \"contact\" ? \"contactNotes\" : \"dealNotes\";\n            \n            return (\n              <ResourceContextProvider key={`${resource}-${note.id}`} value={resource}>\n                <Note\n                  note={note}\n                  isLast={index === allNotes.length - 1}\n                  showStatus={showStatus}\n                />\n              </ResourceContextProvider>\n            );\n          })}\n        </div>\n      ) : (\n        <div className=\"text-sm text-muted-foreground\">No notes yet.</div>\n      )}\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/UnifiedNoteCreate.tsx",
      "content": "import {\n  CreateBase,\n  Form,\n  useGetIdentity,\n  useNotify,\n  useRecordContext,\n  useUpdate,\n  type Identifier,\n  type RaRecord,\n} from \"ra-core\";\nimport { useFormContext } from \"react-hook-form\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { cn } from \"@/lib/utils\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { NoteInputs } from \"./NoteInputs\";\n\nconst foreignKeyMapping = {\n  contacts: \"contact_id\",\n  \"lead-journey\": \"deal_id\",\n};\n\nexport const UnifiedNoteCreate = ({\n  reference,\n  showStatus,\n  className,\n  onSuccess: onSuccessCallback,\n  contactId,\n  dealId,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  showStatus?: boolean;\n  className?: string;\n  onSuccess?: () => void;\n  contactId?: string | number;\n  dealId?: string | number;\n}) => {\n  const record = useRecordContext();\n  const { identity } = useGetIdentity();\n\n  if (!record) return null;\n\n  // Determine which resource to use for creating notes\n  const noteResource = reference === \"contacts\" ? \"contactNotes\" : \"dealNotes\";\n  const recordId = reference === \"contacts\" ? (contactId || record.id) : (dealId || record.id);\n\n  return (\n    <Card className=\"bg-muted/30 py-3\">\n      <CardContent className=\"pt-0 px-4 pb-0\">\n        <CreateBase resource={noteResource} redirect={false}>\n          <Form>\n            <div className={className}>\n              <NoteInputs showStatus={showStatus} />\n              <UnifiedNoteCreateButton \n                reference={reference} \n                record={record}\n                recordId={recordId}\n                onSuccess={onSuccessCallback}\n              />\n            </div>\n          </Form>\n        </CreateBase>\n      </CardContent>\n    </Card>\n  );\n};\n\nconst UnifiedNoteCreateButton = ({\n  reference,\n  record,\n  recordId,\n  onSuccess: onSuccessCallback,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  record: RaRecord<Identifier>;\n  recordId?: string | number;\n  onSuccess?: () => void;\n}) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const { identity } = useGetIdentity();\n  const { reset } = useFormContext();\n\n  if (!record) return null;\n\n  const resetValues: {\n    text: null;\n    attachments: null;\n    tagged_user_ids?: undefined;\n  } = {\n    text: null,\n    attachments: null,\n    tagged_user_ids: undefined,\n  };\n\n  const handleSuccess = async (data: any) => {\n    reset(resetValues, { keepValues: false });\n    // Update contact last_seen first\n    await update(reference, {\n      id: (record && record.id) as unknown as Identifier,\n      data: { last_seen: new Date().toISOString() },\n      previousData: record,\n    });\n    notify(\"Note added\");\n    // Call the refetch callback after update completes to ensure data is synced\n    if (onSuccessCallback) {\n      onSuccessCallback();\n    }\n  };\n\n  return (\n    <div className=\"flex justify-end\">\n      <SaveButton\n        type=\"button\"\n        label=\"Add this note\"\n        transform={(data) => {\n          const { tagged_user_ids, ...restData } = data;\n          const result: any = {\n            ...restData,\n            [foreignKeyMapping[reference]]: recordId || record.id,\n            sales_id: identity?.id,\n            // Always save notes with current time\n            date: new Date().toISOString(),\n          };\n          // Only include tagged_user_ids if it's a non-empty array\n          // This avoids schema cache issues if the column doesn't exist yet\n          if (Array.isArray(tagged_user_ids) && tagged_user_ids.length > 0) {\n            result.tagged_user_ids = tagged_user_ids;\n          }\n          return result;\n        }}\n        mutationOptions={{\n          onSuccess: handleSuccess,\n        }}\n      >\n        Add this note\n      </SaveButton>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/StatusSelector.tsx",
      "content": "import {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\nimport { Status } from \"../misc/Status\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const StatusSelector = ({ status, setStatus }: any) => {\n  const { noteStatuses } = useConfigurationContext();\n\n  const currentStatus = noteStatuses.find((s) => s.value === status);\n\n  return (\n    <Select value={status} onValueChange={setStatus}>\n      <SelectTrigger className=\"w-32\">\n        <SelectValue>\n          {currentStatus && (\n            <div className=\"flex items-center gap-2\">\n              {currentStatus.label} <Status status={currentStatus.value} />\n            </div>\n          )}\n        </SelectValue>\n      </SelectTrigger>\n      <SelectContent>\n        {noteStatuses.map((statusOption) => (\n          <SelectItem key={statusOption.value} value={statusOption.value}>\n            <div className=\"flex items-center gap-2\">\n              {statusOption.label} <Status status={statusOption.value} />\n            </div>\n          </SelectItem>\n        ))}\n      </SelectContent>\n    </Select>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NotesPage.tsx",
      "content": "import { FileText, Search } from \"lucide-react\";\nimport {\n  ResourceContextProvider,\n  useGetIdentity,\n  useGetList,\n  WithRecord,\n} from \"ra-core\";\nimport { useEffect, useMemo, useState } from \"react\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\n\nimport type { ContactNote, Deal, DealNote, Contact } from \"../types\";\nimport { Note } from \"./Note\";\n\ntype NotesTab = \"all\" | \"mentions\" | \"authored\";\n\ntype UnifiedNote =\n  | (ContactNote & { _noteType: \"contact\" })\n  | (DealNote & { _noteType: \"deal\" });\n\nexport const NotesPage = () => {\n  const { identity } = useGetIdentity();\n\n  const [tab, setTab] = useState<NotesTab>(\"all\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const [perPage, setPerPage] = useState(50);\n\n  // When the user changes the scope (tab/search), reset pagination.\n  useEffect(() => {\n    setPerPage(50);\n  }, [tab, searchQuery]);\n\n  const baseFilter = useMemo(() => {\n    const filter: Record<string, unknown> = {};\n\n    if (tab === \"mentions\") {\n      if (Number.isInteger(identity?.id)) {\n        filter[\"tagged_user_ids@cs\"] = `{${identity!.id}}`;\n      } else {\n        // No identity yet; force empty result until we know who the user is.\n        filter[\"id@in\"] = \"(-1)\";\n      }\n    }\n\n    if (tab === \"authored\") {\n      if (Number.isInteger(identity?.id)) {\n        filter.sales_id = identity!.id;\n      } else {\n        filter[\"id@in\"] = \"(-1)\";\n      }\n    }\n\n    if (searchQuery.trim()) {\n      filter[\"text@ilike\"] = `%${searchQuery.trim()}%`;\n    }\n\n    return filter;\n  }, [tab, identity?.id, searchQuery]);\n\n  const listEnabled = tab === \"all\" || Number.isInteger(identity?.id);\n\n  const {\n    data: contactNotes,\n    total: contactNotesTotal,\n    isPending: contactNotesPending,\n    error: contactNotesError,\n  } = useGetList<ContactNote>(\n    \"contactNotes\",\n    {\n      pagination: { page: 1, perPage },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: baseFilter,\n    },\n    { enabled: listEnabled, retry: false },\n  );\n\n  const {\n    data: dealNotes,\n    total: dealNotesTotal,\n    isPending: dealNotesPending,\n    error: dealNotesError,\n  } = useGetList<DealNote>(\n    \"dealNotes\",\n    {\n      pagination: { page: 1, perPage },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: baseFilter,\n    },\n    { enabled: listEnabled, retry: false },\n  );\n\n  const mergedNotes = useMemo(() => {\n    const notes: UnifiedNote[] = [];\n    (contactNotes ?? []).forEach((n) => notes.push({ ...n, _noteType: \"contact\" }));\n    (dealNotes ?? []).forEach((n) => notes.push({ ...n, _noteType: \"deal\" }));\n\n    notes.sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());\n    return notes;\n  }, [contactNotes, dealNotes]);\n\n  const isPending = contactNotesPending && dealNotesPending;\n  const hasError = !!contactNotesError && !!dealNotesError;\n\n  const combinedTotal = (contactNotesTotal ?? 0) + (dealNotesTotal ?? 0);\n  const canLoadMore = combinedTotal > 0 && mergedNotes.length < combinedTotal;\n\n  return (\n    <div className=\"flex flex-col w-full lg:h-[calc(100vh-8rem)] h-auto -mx-4 -mt-4 p-6 gap-4 bg-background\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-shrink-0 pb-2\">\n        <div className=\"flex items-center gap-3\">\n          <FileText className=\"text-muted-foreground w-6 h-6\" />\n          <h1 className=\"text-2xl font-semibold text-foreground\">Notes</h1>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <Tabs value={tab} onValueChange={(v) => setTab(v as NotesTab)}>\n          <TabsList>\n            <TabsTrigger value=\"all\">All</TabsTrigger>\n            <TabsTrigger value=\"mentions\">Mentions</TabsTrigger>\n            <TabsTrigger value=\"authored\">Authored</TabsTrigger>\n          </TabsList>\n        </Tabs>\n\n        <div className=\"flex-shrink-0 w-full sm:max-w-md\">\n          <div className=\"flex flex-grow relative\">\n            <input\n              type=\"text\"\n              placeholder=\"Search notes...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8\"\n            />\n            <Search className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none\" />\n          </div>\n        </div>\n      </div>\n\n      {/* Feed */}\n      <Card className=\"border-border/50 shadow-sm\">\n        <CardHeader className=\"pb-2.5 px-4 pt-3 border-b border-border/50\">\n          <CardTitle className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\n            {tab === \"all\" ? \"All notes\" : tab === \"mentions\" ? \"Mentions\" : \"Authored\"}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"p-4\">\n          {hasError ? (\n            <div className=\"text-sm text-destructive\">\n              Unable to load notes right now.\n            </div>\n          ) : isPending ? (\n            <div className=\"text-sm text-muted-foreground\">Loading notesâ€¦</div>\n          ) : mergedNotes.length > 0 ? (\n            <div className=\"space-y-4\">\n              {mergedNotes.map((note, index) => {\n                const resource = note._noteType === \"contact\" ? \"contactNotes\" : \"dealNotes\";\n\n                const context =\n                  note._noteType === \"contact\" ? (\n                    <ReferenceField\n                      record={note}\n                      source=\"contact_id\"\n                      reference=\"contacts\"\n                      link=\"show\"\n                    >\n                      <WithRecord\n                        render={(contact: Contact) => (\n                          <span className=\"font-medium text-foreground\">\n                            {`${contact.first_name ?? \"\"} ${contact.last_name ?? \"\"}`.trim() ||\n                              `Lead #${contact.id}`}\n                          </span>\n                        )}\n                      />\n                    </ReferenceField>\n                  ) : (\n                    <ReferenceField\n                      record={note}\n                      source=\"deal_id\"\n                      reference=\"lead-journey\"\n                      link=\"show\"\n                    >\n                      <WithRecord\n                        render={(deal: Deal) => (\n                          <span className=\"font-medium text-foreground\">\n                            {deal.name ||\n                              `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim() ||\n                              `Deal #${deal.id}`}\n                          </span>\n                        )}\n                      />\n                    </ReferenceField>\n                  );\n\n                return (\n                  <div key={`${resource}-${note.id}`} className=\"space-y-2\">\n                    <ResourceContextProvider value={resource}>\n                      <Note\n                        note={note}\n                        isLast={index === mergedNotes.length - 1}\n                        context={context}\n                      />\n                    </ResourceContextProvider>\n                  </div>\n                );\n              })}\n\n              {canLoadMore && (\n                <div className=\"flex justify-center pt-2\">\n                  <button\n                    type=\"button\"\n                    className=\"text-sm text-muted-foreground hover:text-foreground underline underline-offset-4\"\n                    onClick={() => setPerPage((p) => p + 50)}\n                  >\n                    Load more\n                  </button>\n                </div>\n              )}\n            </div>\n          ) : (\n            <div className=\"text-sm text-muted-foreground\">No notes yet.</div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nNotesPage.path = \"/notes\";\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NotesIterator.tsx",
      "content": "import { useListContext } from \"ra-core\";\n\nimport { Note } from \"./Note\";\nimport { NoteCreate } from \"./NoteCreate\";\n\nexport const NotesIterator = ({\n  reference,\n  showStatus,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  showStatus?: boolean;\n}) => {\n  const { data, error, isPending } = useListContext();\n  return (\n    <div className=\"space-y-3\">\n      <NoteCreate reference={reference} showStatus={showStatus} />\n      {error ? (\n        <div className=\"text-sm text-destructive\">\n          Unable to load notes. You can still add a new note above.\n        </div>\n      ) : isPending ? (\n        <div className=\"text-sm text-muted-foreground\">Loading notesâ€¦</div>\n      ) : data && data.length > 0 ? (\n        <div className=\"space-y-2\">\n          {data.map((note, index) => (\n            <Note\n              note={note}\n              isLast={index === data.length - 1}\n              key={index}\n              showStatus={showStatus}\n            />\n          ))}\n        </div>\n      ) : (\n        <div className=\"text-sm text-muted-foreground\">No notes yet.</div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NoteInputs.tsx",
      "content": "import { Fragment, useRef, useState } from \"react\";\nimport { useFormContext } from \"react-hook-form\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport { useInput, useNotify } from \"ra-core\";\nimport {\n  FormControl,\n  FormError,\n  FormField,\n} from \"@/components/admin/form\";\nimport { InputHelperText } from \"@/components/admin/input-helper-text\";\nimport { Paperclip, X } from \"lucide-react\";\n\nimport { SmartTextInput } from \"../misc/SmartTextInput\";\nimport type { AttachmentNote } from \"../types\";\nimport { supabase } from \"../providers/supabase/supabase\";\n\nexport const NoteInputs = ({ showStatus }: { showStatus?: boolean }) => {\n  // showStatus is intentionally ignored â€” user requested removing Status UI.\n  void showStatus;\n\n  const notify = useNotify();\n  const { setValue, watch } = useFormContext();\n  const { id, field } = useInput({ source: \"text\" });\n  const fileInputRef = useRef<HTMLInputElement | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n\n  const attachments = (watch(\"attachments\") as AttachmentNote[] | undefined) ?? [];\n\n  const handleUsersTagged = (userIds: number[]) => {\n    // Update the tagged_user_ids field when users are tagged\n    setValue(\"tagged_user_ids\", userIds.length > 0 ? userIds : undefined, { shouldDirty: true });\n  };\n\n  const uploadAttachment = async (file: File): Promise<AttachmentNote> => {\n    const ext = file.name.split(\".\").pop() || \"png\";\n    const base =\n      (globalThis.crypto as any)?.randomUUID?.() ??\n      `${Date.now()}-${Math.random().toString(16).slice(2)}`;\n    const path = `${base}.${ext}`;\n\n    const { error: uploadError } = await supabase.storage\n      .from(\"attachments\")\n      .upload(path, file, {\n        contentType: file.type || undefined,\n        upsert: false,\n      });\n\n    if (uploadError) throw uploadError;\n\n    const { data } = supabase.storage.from(\"attachments\").getPublicUrl(path);\n    return {\n      src: data.publicUrl,\n      title: file.name || `image.${ext}`,\n      path,\n      type: file.type || undefined,\n      // rawFile is only for client-side; we don't persist it\n      rawFile: file,\n    };\n  };\n\n  const addFiles = async (files: File[]) => {\n    const imageFiles = files.filter((f) => f.type?.startsWith(\"image/\"));\n    if (imageFiles.length === 0) return;\n\n    setIsUploading(true);\n    try {\n      const uploaded = await Promise.all(imageFiles.map(uploadAttachment));\n      const next = [...attachments, ...uploaded].map(({ rawFile: _raw, ...rest }) => rest as any);\n      // store without rawFile (DB column is jsonb[])\n      setValue(\"attachments\", next, { shouldDirty: true });\n      notify(`${uploaded.length} image${uploaded.length === 1 ? \"\" : \"s\"} attached`, {\n        type: \"success\",\n      });\n    } catch (e: any) {\n      console.error(\"NoteInputs: upload failed\", e);\n      notify(\"Failed to upload image\", { type: \"error\" });\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const handlePaste = async (e: React.ClipboardEvent) => {\n    const items = e.clipboardData?.items;\n    if (!items) return;\n    const imageItems = Array.from(items).filter((it) => it.type?.startsWith(\"image/\"));\n    if (imageItems.length === 0) return;\n\n    e.preventDefault();\n    const files = imageItems\n      .map((it) => it.getAsFile())\n      .filter((f): f is File => !!f)\n      .map((f) => (f.name ? f : new File([f], `pasted-image-${Date.now()}.png`, { type: f.type })));\n\n    await addFiles(files);\n  };\n\n  const handleDrop = async (e: React.DragEvent) => {\n    const files = Array.from(e.dataTransfer?.files ?? []);\n    if (files.length === 0) return;\n    const hasImages = files.some((f) => f.type?.startsWith(\"image/\"));\n    if (!hasImages) return;\n    e.preventDefault();\n    e.stopPropagation();\n    await addFiles(files);\n  };\n\n  const removeAttachmentAt = (index: number) => {\n    const next = attachments.filter((_, i) => i !== index);\n    setValue(\"attachments\", next.length ? next : undefined, { shouldDirty: true });\n  };\n\n  return (\n    <Fragment>\n      <FormField id={id} className=\"m-0\" name={field.name}>\n        <FormControl>\n          <SmartTextInput\n            value={field.value || \"\"}\n            onChange={field.onChange}\n            onBlur={field.onBlur}\n            multiline\n            placeholder=\"Add a note. Try tagging someone with @username\"\n            rows={6}\n            onUsersTagged={handleUsersTagged}\n            onPaste={handlePaste as any}\n            onDrop={handleDrop as any}\n            onDragOver={(e: React.DragEvent) => {\n              // allow dropping images\n              if (Array.from(e.dataTransfer?.items ?? []).some((it) => it.type?.startsWith(\"image/\"))) {\n                e.preventDefault();\n              }\n            }}\n          />\n        </FormControl>\n        <InputHelperText helperText={false} />\n        <FormError />\n      </FormField>\n\n      <div className=\"mt-2 flex items-center justify-between gap-2\">\n        <div className=\"flex items-center gap-2\">\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\"image/*\"\n            multiple\n            className=\"hidden\"\n            onChange={async (e) => {\n              const files = Array.from(e.target.files ?? []);\n              // reset so selecting the same file twice works\n              e.currentTarget.value = \"\";\n              await addFiles(files);\n            }}\n          />\n          <Button\n            type=\"button\"\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"gap-2\"\n            disabled={isUploading}\n            onClick={() => fileInputRef.current?.click()}\n            title=\"Attach images (you can also paste or drag & drop)\"\n          >\n            <Paperclip className=\"h-4 w-4\" />\n            {isUploading ? \"Uploading...\" : \"Attach images\"}\n          </Button>\n          <span className=\"text-xs text-muted-foreground\">\n            Tip: paste an image from clipboard or drag & drop into the note.\n          </span>\n        </div>\n      </div>\n\n      {attachments.length > 0 && (\n        <div className=\"mt-3\">\n          <div className=\"text-xs text-muted-foreground mb-2\">Attachments</div>\n          <div className=\"grid grid-cols-4 gap-3\">\n            {attachments.map((att, index) => (\n              <div key={`${att.src}-${index}`} className=\"relative border rounded-md overflow-hidden\">\n                <img\n                  src={att.src}\n                  alt={att.title}\n                  className=\"w-full h-20 object-cover cursor-pointer\"\n                  onClick={() => window.open(att.src, \"_blank\")}\n                />\n                <button\n                  type=\"button\"\n                  className={cn(\n                    \"absolute top-1 right-1 rounded-full bg-background/80 border p-1\",\n                    \"hover:bg-background\",\n                  )}\n                  onClick={() => removeAttachmentAt(index)}\n                  title=\"Remove\"\n                >\n                  <X className=\"h-3 w-3\" />\n                </button>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </Fragment>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NoteCreate.tsx",
      "content": "import {\n  CreateBase,\n  Form,\n  useGetIdentity,\n  useListContext,\n  useNotify,\n  useRecordContext,\n  useResourceContext,\n  useUpdate,\n  type Identifier,\n  type RaRecord,\n} from \"ra-core\";\nimport { useFormContext } from \"react-hook-form\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { cn } from \"@/lib/utils\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { NoteInputs } from \"./NoteInputs\";\n\nconst foreignKeyMapping = {\n  contacts: \"contact_id\",\n  \"lead-journey\": \"deal_id\",\n};\n\nexport const NoteCreate = ({\n  reference,\n  showStatus,\n  className,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  showStatus?: boolean;\n  className?: string;\n}) => {\n  const resource = useResourceContext();\n  const record = useRecordContext();\n  const { identity } = useGetIdentity();\n\n  if (!record) return null;\n\n  return (\n    <Card className=\"bg-muted/30 py-3\">\n      <CardContent className=\"pt-0 px-4 pb-0\">\n        <CreateBase resource={resource} redirect={false}>\n          <Form>\n            <div className={className}>\n              <NoteInputs showStatus={showStatus} />\n              <NoteCreateButton reference={reference} record={record} />\n            </div>\n          </Form>\n        </CreateBase>\n      </CardContent>\n    </Card>\n  );\n};\n\nconst NoteCreateButton = ({\n  reference,\n  record,\n}: {\n  reference: \"contacts\" | \"lead-journey\";\n  record: RaRecord<Identifier>;\n}) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const { identity } = useGetIdentity();\n  const { reset } = useFormContext();\n  const { refetch } = useListContext();\n\n  if (!record) return null;\n\n  const resetValues: {\n    text: null;\n    attachments: null;\n    tagged_user_ids?: undefined;\n  } = {\n    text: null,\n    attachments: null,\n    tagged_user_ids: undefined,\n  };\n\n  const handleSuccess = (data: any) => {\n    reset(resetValues, { keepValues: false });\n    refetch();\n    update(reference, {\n      id: (record && record.id) as unknown as Identifier,\n      data: { last_seen: new Date().toISOString() },\n      previousData: record,\n    });\n    notify(\"Note added\");\n  };\n\n  return (\n    <div className=\"flex justify-end\">\n      <SaveButton\n        type=\"button\"\n        label=\"Add this note\"\n        transform={(data) => {\n          const { tagged_user_ids, ...restData } = data;\n          const result: any = {\n            ...restData,\n            [foreignKeyMapping[reference]]: record.id,\n            sales_id: identity?.id,\n            // Always save notes with current time\n            date: new Date().toISOString(),\n          };\n          // Only include tagged_user_ids if it's a non-empty array\n          // This avoids schema cache issues if the column doesn't exist yet\n          if (Array.isArray(tagged_user_ids) && tagged_user_ids.length > 0) {\n            result.tagged_user_ids = tagged_user_ids;\n          }\n          return result;\n        }}\n        mutationOptions={{\n          onSuccess: handleSuccess,\n        }}\n      >\n        Add this note\n      </SaveButton>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/NoteAttachments.tsx",
      "content": "import { Paperclip } from \"lucide-react\";\n\nimport type { AttachmentNote, ContactNote, DealNote } from \"../types\";\n\nexport const NoteAttachments = ({ note }: { note: ContactNote | DealNote }) => {\n  if (!note.attachments || note.attachments.length === 0) {\n    return null;\n  }\n\n  const imageAttachments = note.attachments.filter(\n    (attachment: AttachmentNote) => isImageMimeType(attachment.type),\n  );\n  const otherAttachments = note.attachments.filter(\n    (attachment: AttachmentNote) => !isImageMimeType(attachment.type),\n  );\n\n  return (\n    <div className=\"flex flex-col\">\n      {imageAttachments.length > 0 && (\n        <div className=\"grid grid-cols-4 gap-8\">\n          {imageAttachments.map((attachment: AttachmentNote, index: number) => (\n            <div key={index}>\n              <img\n                src={attachment.src}\n                alt={attachment.title}\n                className=\"w-[200px] h-[100px] object-cover cursor-pointer object-left border border-border\"\n                onClick={() => window.open(attachment.src, \"_blank\")}\n              />\n            </div>\n          ))}\n        </div>\n      )}\n      {otherAttachments.length > 0 &&\n        otherAttachments.map((attachment: AttachmentNote, index: number) => (\n          <div key={index} className=\"flex items-center gap-2\">\n            <Paperclip className=\"w-4 h-4\" />\n            <a\n              href={attachment.src}\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"underline hover:no-underline\"\n            >\n              {attachment.title}\n            </a>\n          </div>\n        ))}\n    </div>\n  );\n};\n\nconst isImageMimeType = (mimeType?: string): boolean => {\n  if (!mimeType) {\n    return false;\n  }\n  return mimeType.startsWith(\"image/\");\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/notes/Note.tsx",
      "content": "import { CircleX, Edit, Save, Trash2 } from \"lucide-react\";\nimport {\n  Form,\n  useDelete,\n  useNotify,\n  useResourceContext,\n  useUpdate,\n  WithRecord,\n} from \"ra-core\";\nimport { useState, type ReactNode } from \"react\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\n\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { Status } from \"../misc/Status\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ContactNote, DealNote } from \"../types\";\nimport { NoteInputs } from \"./NoteInputs\";\n\nexport const Note = ({\n  showStatus,\n  note,\n  context,\n}: {\n  showStatus?: boolean;\n  note: DealNote | ContactNote;\n  isLast: boolean;\n  context?: ReactNode;\n}) => {\n  const [isHover, setHover] = useState(false);\n  const [isEditing, setEditing] = useState(false);\n  const resource = useResourceContext();\n  const notify = useNotify();\n\n  const [update, { isPending }] = useUpdate();\n\n  const [deleteNote] = useDelete(\n    resource,\n    { id: note.id, previousData: note },\n    {\n      mutationMode: \"undoable\",\n      onSuccess: () => {\n        notify(\"Note deleted\", { type: \"info\", undoable: true });\n      },\n    },\n  );\n\n  const handleDelete = () => {\n    deleteNote();\n  };\n\n  const handleEnterEditMode = () => {\n    setEditing(!isEditing);\n  };\n\n  const handleCancelEdit = () => {\n    setEditing(false);\n    setHover(false);\n  };\n\n  const handleNoteUpdate: SubmitHandler<FieldValues> = (values) => {\n    update(\n      resource,\n      { id: note.id, data: values, previousData: note },\n      {\n        onSuccess: () => {\n          setEditing(false);\n          setHover(false);\n        },\n      },\n    );\n  };\n\n  return (\n    <Card\n      id={`note-${note.id}`}\n      className=\"hover:shadow-md transition-shadow py-3 gap-2\"\n      onMouseEnter={() => setHover(true)}\n      onMouseLeave={() => setHover(false)}\n    >\n      <CardHeader className=\"pb-2 px-4 pt-0\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <div className=\"flex items-start gap-2 flex-1 min-w-0\">\n            <div className=\"flex-1 min-w-0\">\n              {/* Keep header on a single line; truncate if it overflows */}\n              <div className=\"flex items-center gap-2 min-w-0 whitespace-nowrap overflow-hidden\">\n                <span className=\"text-sm font-medium flex-shrink-0\">\n                  <ReferenceField\n                    record={note}\n                    resource={resource}\n                    source=\"sales_id\"\n                    reference=\"sales\"\n                    link={false}\n                  >\n                    <WithRecord render={(record) => <SaleName sale={record} />} />\n                  </ReferenceField>\n                </span>\n                <span className=\"text-sm text-muted-foreground truncate min-w-0 overflow-hidden text-ellipsis\">\n                  added a note\n                  {context ? (\n                    <>\n                      {\" \"}\n                      on <span className=\"inline whitespace-nowrap\">{context}</span>\n                    </>\n                  ) : null}\n                </span>\n                {showStatus && note.status && (\n                  <Status className=\"ml-1 flex-shrink-0\" status={note.status} />\n                )}\n              </div>\n            </div>\n          </div>\n          <div className={`flex items-center gap-1 ${isHover ? \"opacity-100\" : \"opacity-0\"} transition-opacity`}>\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleEnterEditMode}\n                    className=\"h-7 w-7 p-0 cursor-pointer\"\n                  >\n                    <Edit className=\"w-3.5 h-3.5\" />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Edit note</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleDelete}\n                    className=\"h-7 w-7 p-0 cursor-pointer text-destructive hover:text-destructive\"\n                  >\n                    <Trash2 className=\"w-3.5 h-3.5\" />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Delete note</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent className=\"pt-0 px-4 pb-0\">\n        {isEditing ? (\n          <Form onSubmit={handleNoteUpdate} record={note}>\n            <NoteInputs showStatus={showStatus} />\n            <div className=\"flex justify-end gap-2 mt-3\">\n              <Button\n                variant=\"outline\"\n                onClick={handleCancelEdit}\n                type=\"button\"\n                size=\"sm\"\n                className=\"cursor-pointer\"\n              >\n                <CircleX className=\"w-4 h-4 mr-2\" />\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={isPending}\n                size=\"sm\"\n                className=\"cursor-pointer\"\n              >\n                <Save className=\"w-4 h-4 mr-2\" />\n                Save\n              </Button>\n            </div>\n          </Form>\n        ) : (\n          <div className=\"flex items-start justify-between gap-3\">\n            <div className=\"flex-1 [&_p:empty]:min-h-[0.75em]\">\n              {note.text?.split(\"\\n\").map((paragraph: string, index: number) => (\n                <p className=\"text-sm leading-5 m-0 mb-1.5 last:mb-0\" key={index}>\n                  {paragraph}\n                </p>\n              ))}\n            </div>\n            <span className=\"text-xs text-muted-foreground whitespace-nowrap mt-0.5\">\n              <RelativeDate date={note.date} />\n            </span>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/usePapaParse.tsx",
      "content": "import * as Papa from \"papaparse\";\nimport { useCallback, useMemo, useRef, useState } from \"react\";\n\nexport type ImportError = {\n  row: number;\n  message: string;\n  data?: unknown;\n};\n\ntype Import =\n  | {\n      state: \"idle\";\n    }\n  | {\n      state: \"parsing\";\n    }\n  | {\n      state: \"running\" | \"complete\";\n\n      rowCount: number;\n      importCount: number;\n      errorCount: number;\n      errors: ImportError[];\n\n      // The remaining time in milliseconds\n      remainingTime: number | null;\n    }\n  | {\n      state: \"error\";\n\n      error: Error;\n    };\n\ntype usePapaParseProps<T> = {\n  // The import batch size\n  batchSize?: number;\n\n  // processBatch returns the number of imported items\n  // It can throw errors or return an array of errors for individual rows\n  processBatch(batch: T[], startRowIndex: number): Promise<ImportError[]>;\n};\n\nexport function usePapaParse<T>({\n  batchSize = 10,\n  processBatch,\n}: usePapaParseProps<T>) {\n  const importIdRef = useRef<number>(0);\n\n  const [importer, setImporter] = useState<Import>({\n    state: \"idle\",\n  });\n\n  const reset = useCallback(() => {\n    setImporter({\n      state: \"idle\",\n    });\n    importIdRef.current += 1;\n  }, []);\n\n  const parseCsv = useCallback(\n    (file: File) => {\n      setImporter({\n        state: \"parsing\",\n      });\n\n      const importId = importIdRef.current;\n      Papa.parse<T>(file, {\n        header: true,\n        skipEmptyLines: true,\n        async complete(results) {\n          if (importIdRef.current !== importId) {\n            return;\n          }\n\n          const csvErrors: ImportError[] = results.errors.map((err) => ({\n            row: (err.row ?? 0) + 1, // Convert to 1-based row number\n            message: err.message || \"CSV parsing error\",\n            data: err,\n          }));\n\n          setImporter({\n            state: \"running\",\n            rowCount: results.data.length,\n            errorCount: csvErrors.length,\n            importCount: 0,\n            remainingTime: null,\n            errors: csvErrors,\n          });\n\n          let totalTime = 0;\n          const importErrors: ImportError[] = [...csvErrors];\n          \n          for (let i = 0; i < results.data.length; i += batchSize) {\n            if (importIdRef.current !== importId) {\n              return;\n            }\n\n            const batch = results.data.slice(i, i + batchSize);\n            const startRowIndex = i + 1; // 1-based row number\n            try {\n              const start = Date.now();\n              const batchErrors = await processBatch(batch, startRowIndex);\n              totalTime += Date.now() - start;\n\n              // Add batch errors to the list\n              if (batchErrors && batchErrors.length > 0) {\n                importErrors.push(...batchErrors);\n              }\n\n              const meanTime = totalTime / (i + batch.length);\n              const successfulCount = batch.length - (batchErrors?.length || 0);\n              setImporter((previous) => {\n                if (previous.state === \"running\") {\n                  const importCount = previous.importCount + successfulCount;\n                  return {\n                    ...previous,\n                    importCount,\n                    errorCount: importErrors.length,\n                    errors: importErrors,\n                    remainingTime:\n                      meanTime * (results.data.length - importCount),\n                  };\n                }\n                return previous;\n              });\n            } catch (error) {\n              console.error(\"Failed to import batch\", error);\n              // If processBatch throws, mark all rows in batch as errors\n              const batchErrors: ImportError[] = batch.map((_, idx) => ({\n                row: startRowIndex + idx,\n                message: error instanceof Error ? error.message : String(error),\n                data: batch[idx],\n              }));\n              importErrors.push(...batchErrors);\n              \n              setImporter((previous) =>\n                previous.state === \"running\"\n                  ? {\n                      ...previous,\n                      errorCount: importErrors.length,\n                      errors: importErrors,\n                    }\n                  : previous,\n              );\n            }\n          }\n\n          setImporter((previous) =>\n            previous.state === \"running\"\n              ? {\n                  ...previous,\n                  state: \"complete\",\n                  remainingTime: null,\n                  errors: importErrors,\n                }\n              : previous,\n          );\n        },\n        error(error) {\n          console.error(error);\n          setImporter({\n            state: \"error\",\n            error,\n          });\n        },\n        dynamicTyping: true,\n      });\n    },\n    [batchSize, processBatch],\n  );\n\n  return useMemo(\n    () => ({\n      importer,\n      parseCsv,\n      reset,\n    }),\n    [importer, parseCsv, reset],\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/useAppBarHeight.ts",
      "content": "import { useIsMobile } from \"@/hooks/use-mobile\";\n\nconst DENSE_NAVBAR_HEIGHT = 48;\nconst DENSE_NAVBAR_HEIGHT_MOBILE = 64;\n\nexport default function useAppBarHeight(): number {\n  const isMobile = useIsMobile();\n  return isMobile ? DENSE_NAVBAR_HEIGHT_MOBILE : DENSE_NAVBAR_HEIGHT;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/unsupportedDomains.const.ts",
      "content": "// If you want to add more domains to the list, you can do so by adding them to the DOMAINS_NOT_SUPPORTING_FAVICON array.\nexport const DOMAINS_NOT_SUPPORTING_FAVICON = [\n  \"gmail.com\",\n  \"yahoo.com\",\n  \"hotmail.com\",\n  \"aol.com\",\n  \"hotmail.co.uk\",\n  \"hotmail.fr\",\n  \"msn.com\",\n  \"yahoo.fr\",\n  \"wanadoo.fr\",\n  \"orange.fr\",\n  \"comcast.net\",\n  \"yahoo.co.uk\",\n  \"yahoo.com.br\",\n  \"yahoo.co.in\",\n  \"live.com\",\n  \"rediffmail.com\",\n  \"free.fr\",\n  \"gmx.de\",\n  \"web.de\",\n  \"yandex.ru\",\n  \"ymail.com\",\n  \"libero.it\",\n  \"outlook.com\",\n  \"uol.com.br\",\n  \"bol.com.br\",\n  \"mail.ru\",\n  \"cox.net\",\n  \"hotmail.it\",\n  \"sbcglobal.net\",\n  \"sfr.fr\",\n  \"live.fr\",\n  \"verizon.net\",\n  \"live.co.uk\",\n  \"googlemail.com\",\n  \"yahoo.es\",\n  \"ig.com.br\",\n  \"live.nl\",\n  \"bigpond.com\",\n  \"terra.com.br\",\n  \"yahoo.it\",\n  \"neuf.fr\",\n  \"yahoo.de\",\n  \"alice.it\",\n  \"rocketmail.com\",\n  \"att.net\",\n  \"laposte.net\",\n  \"facebook.com\",\n  \"bellsouth.net\",\n  \"yahoo.in\",\n  \"hotmail.es\",\n  \"charter.net\",\n  \"yahoo.ca\",\n  \"yahoo.com.au\",\n  \"rambler.ru\",\n  \"hotmail.de\",\n  \"tiscali.it\",\n  \"shaw.ca\",\n  \"yahoo.co.jp\",\n  \"sky.com\",\n  \"earthlink.net\",\n  \"optonline.net\",\n  \"freenet.de\",\n  \"t-online.de\",\n  \"aliceadsl.fr\",\n  \"virgilio.it\",\n  \"home.nl\",\n  \"qq.com\",\n  \"telenet.be\",\n  \"me.com\",\n  \"yahoo.com.ar\",\n  \"tiscali.co.uk\",\n  \"yahoo.com.mx\",\n  \"voila.fr\",\n  \"gmx.net\",\n  \"mail.com\",\n  \"planet.nl\",\n  \"tin.it\",\n  \"live.it\",\n  \"ntlworld.com\",\n  \"arcor.de\",\n  \"yahoo.co.id\",\n  \"frontiernet.net\",\n  \"hetnet.nl\",\n  \"live.com.au\",\n  \"yahoo.com.sg\",\n  \"zonnet.nl\",\n  \"club-internet.fr\",\n  \"juno.com\",\n  \"optusnet.com.au\",\n  \"blueyonder.co.uk\",\n  \"bluewin.ch\",\n  \"skynet.be\",\n  \"sympatico.ca\",\n  \"windstream.net\",\n  \"mac.com\",\n  \"centurytel.net\",\n  \"chello.nl\",\n  \"live.ca\",\n  \"aim.com\",\n  \"bigpond.net.au\",\n  \"online.de\",\n  \"apple.com\",\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/timezone.ts",
      "content": "export type DateInput = Date | string | number | null | undefined;\n\nconst CRM_TIME_ZONE_OFFSET_MINUTES = 4 * 60;\nconst CRM_TIME_ZONE_OFFSET_MS = CRM_TIME_ZONE_OFFSET_MINUTES * 60 * 1000;\n\nexport const CRM_TIME_ZONE = \"Asia/Dubai\";\nexport const CRM_TIME_ZONE_LABEL = \"UTC+4\";\n\nconst dateTimeFormatter = new Intl.DateTimeFormat(\"en-GB\", {\n  timeZone: CRM_TIME_ZONE,\n  year: \"numeric\",\n  month: \"2-digit\",\n  day: \"2-digit\",\n  hour: \"2-digit\",\n  minute: \"2-digit\",\n  hour12: false,\n});\n\nconst dateFormatter = new Intl.DateTimeFormat(\"en-GB\", {\n  timeZone: CRM_TIME_ZONE,\n  year: \"numeric\",\n  month: \"2-digit\",\n  day: \"2-digit\",\n});\n\n// \"en-CA\" yields ISO-like date strings (YYYY-MM-DD)\nconst ymdDateFormatter = new Intl.DateTimeFormat(\"en-CA\", {\n  timeZone: CRM_TIME_ZONE,\n  year: \"numeric\",\n  month: \"2-digit\",\n  day: \"2-digit\",\n});\n\nconst timeFormatter = new Intl.DateTimeFormat(\"en-GB\", {\n  timeZone: CRM_TIME_ZONE,\n  hour: \"2-digit\",\n  minute: \"2-digit\",\n  hour12: false,\n});\n\nconst partsFormatter = new Intl.DateTimeFormat(\"en-CA\", {\n  timeZone: CRM_TIME_ZONE,\n  year: \"numeric\",\n  month: \"2-digit\",\n  day: \"2-digit\",\n  hour: \"2-digit\",\n  minute: \"2-digit\",\n  second: \"2-digit\",\n  hour12: false,\n});\n\nconst DAY_IN_MS = 24 * 60 * 60 * 1000;\nconst pad = (value: number) => value.toString().padStart(2, \"0\");\n\nfunction parseDate(value: DateInput): Date | undefined {\n  if (value instanceof Date) {\n    return value;\n  }\n  if (typeof value === \"string\" || typeof value === \"number\") {\n    const parsed = new Date(value);\n    if (!Number.isNaN(parsed.getTime())) {\n      return parsed;\n    }\n  }\n  return undefined;\n}\n\nfunction getZonedParts(value: DateInput) {\n  const date = parseDate(value);\n  if (!date) return undefined;\n  const parts = partsFormatter.formatToParts(date).reduce<Record<string, number>>(\n    (acc, part) => {\n      if (part.type !== \"literal\") {\n        acc[part.type] = Number(part.value);\n      }\n      return acc;\n    },\n    {},\n  );\n\n  return {\n    year: parts.year,\n    month: parts.month,\n    day: parts.day,\n    hour: parts.hour ?? 0,\n    minute: parts.minute ?? 0,\n    second: parts.second ?? 0,\n    millisecond: 0,\n  };\n}\n\nfunction buildUtcFromZoned(parts: {\n  year?: number;\n  month?: number;\n  day?: number;\n  hour?: number;\n  minute?: number;\n  second?: number;\n  millisecond?: number;\n}) {\n  if (\n    parts.year === undefined ||\n    parts.month === undefined ||\n    parts.day === undefined\n  ) {\n    return undefined;\n  }\n\n  return new Date(\n    Date.UTC(\n      parts.year,\n      parts.month - 1,\n      parts.day,\n      parts.hour ?? 0,\n      parts.minute ?? 0,\n      parts.second ?? 0,\n      parts.millisecond ?? 0,\n    ) - CRM_TIME_ZONE_OFFSET_MS,\n  );\n}\n\nexport function formatCrmDateTime(value: DateInput) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return dateTimeFormatter.format(date);\n}\n\nexport function formatCrmDate(value: DateInput) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return dateFormatter.format(date);\n}\n\nexport function formatCrmTime(value: DateInput) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return timeFormatter.format(date);\n}\n\nexport function crmDateInputString(value: DateInput = new Date()) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return dateFormatter.format(date);\n}\n\n/**\n * Returns a date string in YYYY-MM-DD format, using the CRM timezone.\n * This is ideal for `<input type=\"date\">` values and react-hook-form state.\n */\nexport function crmDateYmdInputString(value: DateInput = new Date()) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  return ymdDateFormatter.format(date);\n}\n\nexport function crmDateStringToDate(value: string | null | undefined) {\n  if (!value) return undefined;\n  const [year, month, day] = value.split(\"-\").map((v) => Number(v));\n  if (!year || !month || !day) return undefined;\n  return buildUtcFromZoned({ year, month, day, hour: 0, minute: 0, second: 0 });\n}\n\nexport function crmDateStringToISO(value: string | null | undefined) {\n  const date = crmDateStringToDate(value);\n  return date?.toISOString();\n}\n\nexport function crmStartOfDay(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n  return buildUtcFromZoned({ ...parts, hour: 0, minute: 0, second: 0 });\n}\n\nexport function crmEndOfDay(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n  return buildUtcFromZoned({\n    ...parts,\n    hour: 23,\n    minute: 59,\n    second: 59,\n    millisecond: 999,\n  });\n}\n\nexport function crmAddDays(value: DateInput, days: number) {\n  const start = crmStartOfDay(value);\n  if (!start) return undefined;\n  return new Date(start.getTime() + days * DAY_IN_MS);\n}\n\nexport function crmStartOfWeek(value: DateInput = new Date(), weekStartsOn = 0) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n\n  const midpoint = buildUtcFromZoned({ ...parts, hour: 12, minute: 0, second: 0 });\n  if (!midpoint) return undefined;\n\n  const tzDay = midpoint.getUTCDay();\n  const diff = (tzDay - weekStartsOn + 7) % 7;\n  return crmAddDays(midpoint, -diff);\n}\n\nexport function crmEndOfWeek(value: DateInput = new Date(), weekStartsOn = 0) {\n  const start = crmStartOfWeek(value, weekStartsOn);\n  if (!start) return undefined;\n  return new Date(start.getTime() + 7 * DAY_IN_MS - 1);\n}\n\nexport function crmStartOfMonth(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n  return buildUtcFromZoned({\n    year: parts.year,\n    month: parts.month,\n    day: 1,\n    hour: 0,\n    minute: 0,\n    second: 0,\n  });\n}\n\nexport function crmEndOfYesterday(value: DateInput = new Date()) {\n  const yesterday = crmAddDays(value, -1);\n  if (!yesterday) return undefined;\n  return crmEndOfDay(yesterday);\n}\n\nexport function crmDayOfWeek(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return undefined;\n  const midday = buildUtcFromZoned({ ...parts, hour: 12, minute: 0, second: 0 });\n  return midday?.getUTCDay();\n}\n\nexport function crmDateTimeInputString(value: DateInput = new Date()) {\n  const parts = getZonedParts(value);\n  if (!parts) return \"\";\n  return `${parts.year}-${pad(parts.month)}-${pad(parts.day)}T${pad(parts.hour)}:${pad(parts.minute)}`;\n}\n\nexport function crmDateTimeStringToDate(value: string | null | undefined) {\n  if (!value) return undefined;\n  const [datePart, timePart] = value.split(\"T\");\n  if (!datePart || !timePart) return undefined;\n  const [year, month, day] = datePart.split(\"-\").map((v) => Number(v));\n  const [hour, minute] = timePart.split(\":\").map((v) => Number(v));\n  if (!year || !month || !day || Number.isNaN(hour) || Number.isNaN(minute)) {\n    return undefined;\n  }\n  return buildUtcFromZoned({\n    year,\n    month,\n    day,\n    hour,\n    minute,\n    second: 0,\n    millisecond: 0,\n  });\n}\n\nexport function crmDateTimeStringToISO(value: string | null | undefined) {\n  const date = crmDateTimeStringToDate(value);\n  return date?.toISOString();\n}\n\n/**\n * Formats a date as relative time (e.g., \"2 days ago\") for recent dates,\n * or as DD/MM/YYYY for older dates (more than 7 days ago).\n */\nexport function formatRelativeOrDate(value: DateInput, baseDate: Date = new Date()) {\n  const date = parseDate(value);\n  if (!date) return \"\";\n  \n  const diffMs = baseDate.getTime() - date.getTime();\n  const diffDays = Math.floor(diffMs / DAY_IN_MS);\n  \n  // For dates within the last 7 days, use relative format\n  if (diffDays >= 0 && diffDays <= 7) {\n    if (diffDays === 0) return \"today\";\n    if (diffDays === 1) return \"yesterday\";\n    return `${diffDays} days ago`;\n  }\n  \n  // For older dates, use DD/MM/YYYY format\n  return formatCrmDate(date);\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/textParsing.ts",
      "content": "import { crmDateStringToISO, crmDateTimeStringToISO, crmStartOfDay } from \"./timezone\";\n\n/**\n * Parses natural language date/time expressions from text\n * Returns the parsed date string in ISO format or null\n * \n * Examples:\n * - \"tomorrow\" -> tomorrow's date\n * - \"next week\" -> date 7 days from now\n * - \"in 3 days\" -> date 3 days from now\n * - \"today at 3pm\" -> today at 3pm\n * - \"tomorrow at 2:30\" -> tomorrow at 2:30pm\n * - \"next Monday\" -> next Monday\n * - \"Dec 25\" -> December 25 of current year\n * - \"12/25\" -> December 25 of current year\n * - \"2024-12-25\" -> December 25, 2024\n * - \"3pm\" -> today at 3pm\n * - \"14:30\" -> today at 2:30pm\n */\nexport function parseDateFromText(text: string): string | null {\n  if (!text || typeof text !== \"string\") return null;\n\n  const now = new Date();\n  const today = crmStartOfDay(now);\n  if (!today) return null;\n\n  const lowerText = text.toLowerCase().trim();\n\n  // Relative dates\n  if (lowerText === \"today\" || lowerText === \"now\") {\n    return today.toISOString();\n  }\n\n  if (lowerText === \"tomorrow\") {\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    return tomorrow.toISOString();\n  }\n\n  if (lowerText === \"day after tomorrow\" || lowerText === \"day after tmrw\") {\n    const dayAfterTomorrow = new Date(today);\n    dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);\n    return dayAfterTomorrow.toISOString();\n  }\n\n  if (lowerText === \"next week\") {\n    const nextWeek = new Date(today);\n    nextWeek.setDate(nextWeek.getDate() + 7);\n    return nextWeek.toISOString();\n  }\n\n  if (lowerText === \"next month\") {\n    const nextMonth = new Date(today);\n    nextMonth.setMonth(nextMonth.getMonth() + 1);\n    return nextMonth.toISOString();\n  }\n\n  // \"in X days\"\n  const inDaysMatch = lowerText.match(/in\\s+(\\d+)\\s+days?/);\n  if (inDaysMatch) {\n    const days = parseInt(inDaysMatch[1], 10);\n    const futureDate = new Date(today);\n    futureDate.setDate(futureDate.getDate() + days);\n    return futureDate.toISOString();\n  }\n\n  // \"X days from now\"\n  const daysFromNowMatch = lowerText.match(/(\\d+)\\s+days?\\s+from\\s+now/);\n  if (daysFromNowMatch) {\n    const days = parseInt(daysFromNowMatch[1], 10);\n    const futureDate = new Date(today);\n    futureDate.setDate(futureDate.getDate() + days);\n    return futureDate.toISOString();\n  }\n\n  // Time patterns: \"3pm\", \"3:30pm\", \"15:30\", \"14:30\"\n  const timePatterns = [\n    /(\\d{1,2}):?(\\d{2})?\\s*(am|pm)?/i,\n    /(\\d{1,2})\\s*(am|pm)/i,\n  ];\n\n  for (const pattern of timePatterns) {\n    const match = lowerText.match(pattern);\n    if (match) {\n      let hours = parseInt(match[1], 10);\n      const minutes = match[2] ? parseInt(match[2], 10) : 0;\n      const ampm = match[3]?.toLowerCase();\n\n      if (ampm === \"pm\" && hours !== 12) {\n        hours += 12;\n      } else if (ampm === \"am\" && hours === 12) {\n        hours = 0;\n      }\n\n      const dateWithTime = new Date(today);\n      dateWithTime.setHours(hours, minutes, 0, 0);\n      return dateWithTime.toISOString();\n    }\n  }\n\n  // \"today at 3pm\" or \"tomorrow at 2:30\"\n  const todayAtMatch = lowerText.match(/today\\s+at\\s+(\\d{1,2}):?(\\d{2})?\\s*(am|pm)?/i);\n  if (todayAtMatch) {\n    let hours = parseInt(todayAtMatch[1], 10);\n    const minutes = todayAtMatch[2] ? parseInt(todayAtMatch[2], 10) : 0;\n    const ampm = todayAtMatch[3]?.toLowerCase();\n\n    if (ampm === \"pm\" && hours !== 12) {\n      hours += 12;\n    } else if (ampm === \"am\" && hours === 12) {\n      hours = 0;\n    }\n\n    const dateWithTime = new Date(today);\n    dateWithTime.setHours(hours, minutes, 0, 0);\n    return dateWithTime.toISOString();\n  }\n\n  const tomorrowAtMatch = lowerText.match(/tomorrow\\s+at\\s+(\\d{1,2}):?(\\d{2})?\\s*(am|pm)?/i);\n  if (tomorrowAtMatch) {\n    let hours = parseInt(tomorrowAtMatch[1], 10);\n    const minutes = tomorrowAtMatch[2] ? parseInt(tomorrowAtMatch[2], 10) : 0;\n    const ampm = tomorrowAtMatch[3]?.toLowerCase();\n\n    if (ampm === \"pm\" && hours !== 12) {\n      hours += 12;\n    } else if (ampm === \"am\" && hours === 12) {\n      hours = 0;\n    }\n\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    tomorrow.setHours(hours, minutes, 0, 0);\n    return tomorrow.toISOString();\n  }\n\n  // Date formats: \"12/25\", \"12/25/2024\", \"Dec 25\", \"December 25\"\n  const dateFormats = [\n    /(\\d{1,2})\\/(\\d{1,2})(?:\\/(\\d{4}))?/,\n    /(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\\s+(\\d{1,2})(?:\\s+(\\d{4}))?/i,\n  ];\n\n  for (const pattern of dateFormats) {\n    const match = lowerText.match(pattern);\n    if (match) {\n      let month: number, day: number, year: number;\n\n      if (pattern === dateFormats[0]) {\n        // MM/DD or MM/DD/YYYY\n        month = parseInt(match[1], 10);\n        day = parseInt(match[2], 10);\n        year = match[3] ? parseInt(match[3], 10) : now.getFullYear();\n      } else {\n        // \"Dec 25\" or \"December 25\"\n        const monthNames = [\n          \"jan\", \"feb\", \"mar\", \"apr\", \"may\", \"jun\",\n          \"jul\", \"aug\", \"sep\", \"oct\", \"nov\", \"dec\",\n        ];\n        month = monthNames.indexOf(match[1].toLowerCase().substring(0, 3)) + 1;\n        day = parseInt(match[2], 10);\n        year = match[3] ? parseInt(match[3], 10) : now.getFullYear();\n      }\n\n      if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {\n        const parsedDate = new Date(year, month - 1, day);\n        if (parsedDate.getFullYear() === year && parsedDate.getMonth() === month - 1 && parsedDate.getDate() === day) {\n          return crmStartOfDay(parsedDate)?.toISOString() || null;\n        }\n      }\n    }\n  }\n\n  // ISO date format: \"2024-12-25\"\n  const isoDateMatch = lowerText.match(/(\\d{4}-\\d{2}-\\d{2})/);\n  if (isoDateMatch) {\n    const isoDate = crmDateStringToISO(isoDateMatch[1]);\n    if (isoDate) return isoDate;\n  }\n\n  // ISO datetime format: \"2024-12-25T15:30\"\n  const isoDateTimeMatch = lowerText.match(/(\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2})/);\n  if (isoDateTimeMatch) {\n    const isoDateTime = crmDateTimeStringToISO(isoDateTimeMatch[1]);\n    if (isoDateTime) return isoDateTime;\n  }\n\n  return null;\n}\n\n/**\n * Extracts @mentions from text\n * Returns an array of user IDs that were mentioned\n */\nexport function extractMentions(text: string): string[] {\n  if (!text || typeof text !== \"string\") return [];\n\n  // Match @username patterns\n  // Format: @username or @user name (first name and optionally last name)\n  // Stop at the next space or end of string to prevent matching text after the mention\n  const mentionRegex = /@(\\w+(?:\\s+\\w+)?)(?=\\s|$)/g;\n  const mentions: string[] = [];\n  let match;\n\n  while ((match = mentionRegex.exec(text)) !== null) {\n    const mentionText = match[1].trim();\n    if (mentionText && !mentions.includes(mentionText)) {\n      mentions.push(mentionText);\n    }\n  }\n\n  return mentions;\n}\n\n/**\n * Finds the position of the current @mention being typed\n * Returns the start position and the query text after @\n */\nexport function findCurrentMention(text: string, cursorPosition: number): { start: number; query: string } | null {\n  if (!text || cursorPosition < 0) return null;\n\n  // Find the @ symbol before the cursor\n  let start = cursorPosition - 1;\n  while (start >= 0 && text[start] !== \"@\" && text[start] !== \" \" && text[start] !== \"\\n\") {\n    start--;\n  }\n\n  if (start < 0 || text[start] !== \"@\") {\n    return null;\n  }\n\n  // Find the end of the mention (whitespace or end of string)\n  let end = start + 1;\n  while (end < text.length && text[end] !== \" \" && text[end] !== \"\\n\" && text[end] !== \"@\") {\n    end++;\n  }\n\n  const query = text.substring(start + 1, end).trim();\n  return { start, query };\n}\n\n/**\n * Finds date patterns in text that should be auto-extracted\n * Returns the matched text and parsed date, or null if no match\n * These patterns will be removed from text and used to set due_date\n */\nexport function findAutoExtractDatePattern(text: string): { matchedText: string; date: string } | null {\n  if (!text || typeof text !== \"string\") return null;\n\n  const trimmedText = text.trim();\n  const lowerText = trimmedText.toLowerCase();\n  \n  // Patterns that should be auto-extracted (removed from description)\n  // These are checked in order of specificity (longer patterns first)\n  const autoExtractPatterns = [\n    /^(day\\s+after\\s+tomorrow|day\\s+after\\s+tmrw)$/i,\n    /^(next\\s+week|next\\s+month)$/i,\n    /^(in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)$/i,\n    /^(today|tomorrow)$/i,\n  ];\n\n  for (const pattern of autoExtractPatterns) {\n    const match = trimmedText.match(pattern);\n    if (match) {\n      const matchedText = match[0];\n      const parsedDate = parseDateFromText(matchedText);\n      if (parsedDate) {\n        return {\n          matchedText: matchedText,\n          date: parsedDate,\n        };\n      }\n    }\n  }\n\n  return null;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/isLinkedInUrl.ts",
      "content": "const LINKEDIN_URL_REGEX = /^http(?:s)?:\\/\\/(?:www\\.)?linkedin.com\\//;\n\nexport const isLinkedinUrl = (url: string) => {\n  if (!url) return;\n  try {\n    // Parse the URL to ensure it is valid\n    const parsedUrl = new URL(url);\n    if (!parsedUrl.href.match(LINKEDIN_URL_REGEX)) {\n      return \"URL must be from linkedin.com\";\n    }\n  } catch {\n    // If URL parsing fails, return false\n    return \"Must be a valid URL\";\n  }\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/fetchWithTimeout.ts",
      "content": "type FetchParams = Parameters<typeof fetch>;\n\nexport async function fetchWithTimeout(\n  resource: string,\n  options: FetchParams[1] & { timeout?: number } = {},\n) {\n  const { timeout = 2000 } = options;\n\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort(), timeout);\n\n  const response = await fetch(resource, {\n    ...options,\n    signal: controller.signal,\n  });\n  clearTimeout(id);\n\n  return response;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/Status.tsx",
      "content": "import { cn } from \"@/lib/utils\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const Status = ({\n  status,\n  className,\n}: {\n  status: string;\n  className?: string;\n}) => {\n  const { noteStatuses } = useConfigurationContext();\n  if (!status || !noteStatuses) return null;\n  const statusObject = noteStatuses.find((s: any) => s.value === status);\n\n  if (!statusObject) return null;\n  return (\n    <div className={cn(\"group relative inline-block mr-2\", className)}>\n      <span\n        className=\"inline-block w-2.5 h-2.5 rounded-full\"\n        style={{ backgroundColor: statusObject.color }}\n      />\n      <div className=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-gray-800 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10\">\n        {statusObject.label}\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/SmartTextInput.tsx",
      "content": "import * as React from \"react\";\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { useGetList } from \"ra-core\";\nimport { Calendar, User } from \"lucide-react\";\n\nimport { cn } from \"@/lib/utils\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\n\nimport {\n  extractMentions,\n  findCurrentMention,\n  parseDateFromText,\n} from \"./textParsing\";\nimport { crmDateInputString } from \"./timezone\";\nimport type { Sale } from \"../types\";\n\nexport type SmartTextInputProps = {\n  value: string;\n  onChange: (value: string) => void;\n  multiline?: boolean;\n  placeholder?: string;\n  className?: string;\n  inputClassName?: string;\n  rows?: number;\n  onDateDetected?: (date: string) => void;\n  onUsersTagged?: (userIds: number[]) => void;\n} & React.ComponentProps<\"textarea\"> &\n  React.ComponentProps<\"input\">;\n\n/**\n * SmartTextInput\n * - @mention autocomplete (tagging)\n * - date detection + optional â€œinsert dateâ€ suggestion\n *\n * IMPORTANT: This component intentionally uses a plain, controlled input/textarea\n * (no overlay rendering / no caret hacks) to keep cursor behavior stable.\n */\nexport const SmartTextInput = React.forwardRef<\n  HTMLTextAreaElement | HTMLInputElement,\n  SmartTextInputProps\n>((props, ref) => {\n  const {\n    value = \"\",\n    onChange,\n    multiline = false,\n    placeholder,\n    className,\n    inputClassName,\n    rows,\n    onDateDetected,\n    onUsersTagged,\n    ...rest\n  } = props;\n\n  const [cursorPosition, setCursorPosition] = useState(0);\n  const [showSuggestions, setShowSuggestions] = useState(false);\n  const [suggestionType, setSuggestionType] = useState<\"date\" | \"mention\" | null>(null);\n  const [suggestionQuery, setSuggestionQuery] = useState(\"\");\n  const [selectedIndex, setSelectedIndex] = useState(0);\n\n  const inputRef = useRef<HTMLTextAreaElement | HTMLInputElement | null>(null);\n\n  const setRefs = useCallback(\n    (node: HTMLTextAreaElement | HTMLInputElement | null) => {\n      inputRef.current = node;\n      if (typeof ref === \"function\") {\n        ref(node);\n      } else if (ref) {\n        (ref as React.MutableRefObject<\n          HTMLTextAreaElement | HTMLInputElement | null\n        >).current = node;\n      }\n    },\n    [ref],\n  );\n\n  // Users list for mention autocomplete\n  const { data: salesData, isLoading: isLoadingSales, error: salesError } =\n    useGetList<Sale>(\"sales\", {\n      pagination: { page: 1, perPage: 100 },\n      sort: { field: \"last_name\", order: \"ASC\" },\n    });\n\n  const sales = useMemo(() => {\n    const all = salesData || [];\n    return all.filter((s) => !s.disabled);\n  }, [salesData]);\n\n  const filteredSales = useMemo(() => {\n    if (suggestionType !== \"mention\") return [];\n    const q = suggestionQuery.trim().toLowerCase();\n    if (!q) return sales;\n    return sales.filter((sale) => {\n      const full = `${sale.first_name || \"\"} ${sale.last_name || \"\"}`.trim();\n      return (\n        sale.first_name?.toLowerCase().includes(q) ||\n        sale.last_name?.toLowerCase().includes(q) ||\n        full.toLowerCase().includes(q) ||\n        sale.email?.toLowerCase().includes(q)\n      );\n    });\n  }, [sales, suggestionQuery, suggestionType]);\n\n  useEffect(() => {\n    if (suggestionType === \"mention\" && filteredSales.length > 0) {\n      setSelectedIndex((prev) => Math.min(prev, filteredSales.length - 1));\n    }\n  }, [filteredSales.length, suggestionType]);\n\n  const updateCursorFromElement = useCallback(() => {\n    const el = inputRef.current;\n    if (!el) return;\n    const pos = (el as HTMLTextAreaElement | HTMLInputElement).selectionStart ?? 0;\n    setCursorPosition(pos);\n  }, []);\n\n  const findMostRecentDatePattern = useCallback(\n    (text: string, cursorPos: number): { matchedText: string; date: string } | null => {\n      if (!text || !text.trim()) return null;\n\n      const datePatterns = [\n        {\n          pattern: /\\b(day\\s+after\\s+tomorrow|day\\s+after\\s+tmrw)\\b/gi,\n          parse: (match: string) => parseDateFromText(match),\n        },\n        {\n          pattern: /\\b(next\\s+week|next\\s+month)\\b/gi,\n          parse: (match: string) => parseDateFromText(match),\n        },\n        {\n          pattern: /\\b(in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)\\b/gi,\n          parse: (match: string) => parseDateFromText(match),\n        },\n        {\n          pattern: /\\b(today|tomorrow)\\b/gi,\n          parse: (match: string) => parseDateFromText(match),\n        },\n      ];\n\n      const textBeforeCursor = text.substring(0, cursorPos);\n\n      let closest: { matchedText: string; date: string; endPos: number } | null =\n        null;\n\n      for (const { pattern, parse } of datePatterns) {\n        const matches = Array.from(textBeforeCursor.matchAll(pattern));\n        for (const match of matches) {\n          const start = match.index!;\n          const end = start + match[0].length;\n          const matchedText = match[0];\n\n          const charAfter = textBeforeCursor[end];\n          const isAtWordBoundary = !charAfter || /[\\s\\n.,!?;:]/.test(charAfter);\n          if (!isAtWordBoundary) continue;\n\n          const parsedDate = parse(matchedText);\n          if (!parsedDate) continue;\n\n          if (!closest || end > closest.endPos) {\n            closest = { matchedText, date: parsedDate, endPos: end };\n          }\n        }\n      }\n\n      return closest ? { matchedText: closest.matchedText, date: closest.date } : null;\n    },\n    [],\n  );\n\n  // Debounced date detection (doesn't change the text, only notifies)\n  useEffect(() => {\n    if (!onDateDetected) return;\n    if (!value || !value.trim()) return;\n\n    const timeout = setTimeout(() => {\n      const datePattern = findMostRecentDatePattern(value, cursorPosition);\n      if (datePattern) onDateDetected(datePattern.date);\n    }, 120);\n\n    return () => clearTimeout(timeout);\n  }, [cursorPosition, findMostRecentDatePattern, onDateDetected, value]);\n\n  // Suggestions: mentions or date\n  useEffect(() => {\n    if (!value) {\n      setShowSuggestions(false);\n      setSuggestionType(null);\n      setSelectedIndex(0);\n      return;\n    }\n\n    // Mention suggestion\n    const mentionInfo = findCurrentMention(value, cursorPosition);\n    if (mentionInfo) {\n      setSuggestionType(\"mention\");\n      setSuggestionQuery(mentionInfo.query);\n      setShowSuggestions(true);\n      setSelectedIndex(0);\n      return;\n    }\n\n    // Date suggestion near cursor\n    const textBeforeCursor = value.substring(\n      Math.max(0, cursorPosition - 30),\n      cursorPosition,\n    );\n    const trimmedText = textBeforeCursor.trim();\n\n    const datePatterns = [\n      /(today|tomorrow|day\\s+after\\s+tomorrow|day\\s+after\\s+tmrw|next\\s+week|next\\s+month|in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)$/i,\n      /(today|tomorrow)\\s+at\\s+\\d{1,2}:?(\\d{2})?\\s*(am|pm)?$/i,\n      /\\d{1,2}\\/\\d{1,2}(\\/\\d{4})?$/,\n      /\\d{4}-\\d{2}-\\d{2}$/,\n      /(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\\s+\\d{1,2}(\\s+\\d{4})?$/i,\n      /\\d{1,2}:?\\d{2}?\\s*(am|pm)?$/i,\n    ];\n\n    const hasDatePattern = datePatterns.some((p) => p.test(trimmedText));\n    if (hasDatePattern) {\n      const parsed = parseDateFromText(trimmedText);\n      if (parsed) {\n        setSuggestionType(\"date\");\n        setSuggestionQuery(trimmedText);\n        setShowSuggestions(true);\n        setSelectedIndex(0);\n        return;\n      }\n    }\n\n    setShowSuggestions(false);\n    setSuggestionType(null);\n    setSelectedIndex(0);\n  }, [cursorPosition, value]);\n\n  const emitTaggedUsers = useCallback(\n    (text: string) => {\n      if (!onUsersTagged) return;\n      const taggedUsers = extractMentions(text)\n        .map((mention) => {\n          const matchedSale = sales.find(\n            (s) =>\n              `${s.first_name} ${s.last_name}`.toLowerCase() ===\n                mention.toLowerCase() ||\n              s.first_name?.toLowerCase() === mention.toLowerCase() ||\n              s.last_name?.toLowerCase() === mention.toLowerCase(),\n          );\n          return matchedSale?.id;\n        })\n        .filter((id): id is number => id !== undefined);\n\n      onUsersTagged(taggedUsers);\n    },\n    [onUsersTagged, sales],\n  );\n\n  const handleInputChange = useCallback(\n    (e: React.ChangeEvent<HTMLTextAreaElement | HTMLInputElement>) => {\n      const next = e.target.value;\n      const nextCursor = e.target.selectionStart ?? 0;\n\n      setCursorPosition(nextCursor);\n      onChange(next);\n      emitTaggedUsers(next);\n\n      // If the parent re-renders and selection is lost, we restore it next frame.\n      // This is minimal and only uses the browserâ€™s current cursor position.\n      requestAnimationFrame(() => {\n        const el = inputRef.current;\n        if (!el) return;\n        if (document.activeElement !== el) return;\n        try {\n          (el as HTMLTextAreaElement | HTMLInputElement).setSelectionRange(\n            nextCursor,\n            nextCursor,\n          );\n        } catch {\n          // ignore\n        }\n      });\n    },\n    [emitTaggedUsers, onChange],\n  );\n\n  const insertMention = useCallback(\n    (sale: Sale) => {\n      const mentionInfo = findCurrentMention(value, cursorPosition);\n      if (!mentionInfo) return;\n\n      const mentionText = `@${sale.first_name} ${sale.last_name}`;\n      const before = value.substring(0, mentionInfo.start);\n      const after = value.substring(cursorPosition);\n      const next = `${before}${mentionText} ${after}`;\n      const nextCursor = before.length + mentionText.length + 1;\n\n      onChange(next);\n      emitTaggedUsers(next);\n      setShowSuggestions(false);\n      setSelectedIndex(0);\n      setCursorPosition(nextCursor);\n\n      requestAnimationFrame(() => {\n        const el = inputRef.current;\n        if (!el) return;\n        (el as HTMLTextAreaElement | HTMLInputElement).focus();\n        try {\n          (el as HTMLTextAreaElement | HTMLInputElement).setSelectionRange(\n            nextCursor,\n            nextCursor,\n          );\n        } catch {\n          // ignore\n        }\n      });\n    },\n    [cursorPosition, emitTaggedUsers, onChange, value],\n  );\n\n  const insertDateSuggestion = useCallback(() => {\n    if (!suggestionQuery) return;\n\n    const parsedDate = parseDateFromText(suggestionQuery);\n    if (!parsedDate) return;\n\n    const dateStr = crmDateInputString(new Date(parsedDate));\n\n    const textBeforeCursor = value.substring(\n      Math.max(0, cursorPosition - 30),\n      cursorPosition,\n    );\n    const trimmedBefore = textBeforeCursor.trim();\n\n    const datePatterns = [\n      /^(today|tomorrow|next\\s+week|in\\s+\\d+\\s+days?|\\d+\\s+days?\\s+from\\s+now)$/i,\n      /^(today|tomorrow)\\s+at\\s+\\d{1,2}:?(\\d{2})?\\s*(am|pm)?$/i,\n      /^\\d{1,2}\\/\\d{1,2}(\\/\\d{4})?$/,\n      /^\\d{4}-\\d{2}-\\d{2}$/,\n      /^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\\s+\\d{1,2}(\\s+\\d{4})?$/i,\n      /^\\d{1,2}:?\\d{2}?\\s*(am|pm)?$/i,\n    ];\n\n    // Replace either the full trimmed chunk (if it matches) or the last word\n    const matchesPattern = datePatterns.some((p) => p.test(trimmedBefore));\n\n    let replaceStart = cursorPosition;\n    if (matchesPattern && trimmedBefore.length > 0) {\n      replaceStart = Math.max(0, cursorPosition - trimmedBefore.length);\n    } else {\n      const words = trimmedBefore.split(/\\s+/);\n      const lastWord = words[words.length - 1] || \"\";\n      replaceStart = Math.max(0, cursorPosition - lastWord.length);\n    }\n\n    const before = value.substring(0, replaceStart);\n    const after = value.substring(cursorPosition);\n    const next = `${before}${dateStr} ${after}`;\n    const nextCursor = before.length + dateStr.length + 1;\n\n    onChange(next);\n    setShowSuggestions(false);\n    setCursorPosition(nextCursor);\n    onDateDetected?.(parsedDate);\n\n    requestAnimationFrame(() => {\n      const el = inputRef.current;\n      if (!el) return;\n      (el as HTMLTextAreaElement | HTMLInputElement).focus();\n      try {\n        (el as HTMLTextAreaElement | HTMLInputElement).setSelectionRange(\n          nextCursor,\n          nextCursor,\n        );\n      } catch {\n        // ignore\n      }\n    });\n  }, [cursorPosition, onChange, onDateDetected, suggestionQuery, value]);\n\n  const handleKeyDown = useCallback(\n    (e: React.KeyboardEvent<HTMLTextAreaElement | HTMLInputElement>) => {\n      if (!showSuggestions) return;\n\n      if (suggestionType === \"mention\") {\n        if (e.key === \"ArrowDown\") {\n          e.preventDefault();\n          setSelectedIndex((prev) =>\n            Math.min(prev + 1, Math.max(0, filteredSales.length - 1)),\n          );\n          return;\n        }\n\n        if (e.key === \"ArrowUp\") {\n          e.preventDefault();\n          setSelectedIndex((prev) => Math.max(prev - 1, 0));\n          return;\n        }\n\n        if (e.key === \"Enter\") {\n          e.preventDefault();\n          const sale = filteredSales[selectedIndex];\n          if (sale) insertMention(sale);\n          return;\n        }\n\n        if (e.key === \"Escape\") {\n          e.preventDefault();\n          setShowSuggestions(false);\n          setSelectedIndex(0);\n          return;\n        }\n      }\n\n      if (suggestionType === \"date\" && e.key === \"Enter\") {\n        e.preventDefault();\n        insertDateSuggestion();\n      }\n    },\n    [\n      filteredSales,\n      insertDateSuggestion,\n      insertMention,\n      selectedIndex,\n      showSuggestions,\n      suggestionType,\n    ],\n  );\n\n  const handleSelect = useCallback(() => {\n    updateCursorFromElement();\n  }, [updateCursorFromElement]);\n\n  const handleBlur = useCallback(\n    (e: React.FocusEvent<HTMLTextAreaElement | HTMLInputElement>) => {\n      // One last date detect on blur\n      if (onDateDetected && value) {\n        const pos = e.target.selectionStart ?? value.length;\n        const datePattern = findMostRecentDatePattern(value, pos);\n        if (datePattern) onDateDetected(datePattern.date);\n      }\n\n      if (rest.onBlur) {\n        rest.onBlur(e as any);\n      }\n    },\n    [findMostRecentDatePattern, onDateDetected, rest, value],\n  );\n\n  const InputComponent = multiline ? Textarea : Input;\n\n  return (\n    <div className={cn(\"relative\", className)}>\n      <InputComponent\n        {...(rest as any)}\n        ref={setRefs as any}\n        value={value}\n        onChange={handleInputChange}\n        onKeyDown={handleKeyDown}\n        onSelect={handleSelect as any}\n        onKeyUp={handleSelect as any}\n        onClick={handleSelect as any}\n        onBlur={handleBlur as any}\n        placeholder={placeholder}\n        className={cn(inputClassName, multiline && \"px-3 py-2\")}\n        rows={multiline ? rows : undefined}\n      />\n\n      {showSuggestions && (\n        <div className=\"absolute top-full z-20 w-full mt-1 rounded-md border bg-popover text-popover-foreground shadow-md\">\n          {suggestionType === \"mention\" && (\n            <Command>\n              <CommandList>\n                {isLoadingSales ? (\n                  <CommandEmpty>Loading users...</CommandEmpty>\n                ) : filteredSales.length > 0 ? (\n                  <CommandGroup>\n                    {filteredSales.map((sale, index) => (\n                      <CommandItem\n                        key={sale.id}\n                        onSelect={() => insertMention(sale)}\n                        data-selected={index === selectedIndex}\n                        className={cn(\n                          \"cursor-pointer\",\n                          index === selectedIndex &&\n                            \"bg-accent text-accent-foreground\",\n                        )}\n                      >\n                        <User className=\"mr-2 h-4 w-4\" />\n                        <span>\n                          {sale.first_name} {sale.last_name}\n                        </span>\n                        {sale.email && (\n                          <span className=\"ml-2 text-xs text-muted-foreground\">\n                            {sale.email}\n                          </span>\n                        )}\n                      </CommandItem>\n                    ))}\n                  </CommandGroup>\n                ) : sales.length === 0 ? (\n                  <CommandEmpty>\n                    {salesError ? \"Error loading users\" : \"No users available\"}\n                  </CommandEmpty>\n                ) : (\n                  <CommandEmpty>\n                    No users found matching &quot;{suggestionQuery}&quot;\n                  </CommandEmpty>\n                )}\n              </CommandList>\n            </Command>\n          )}\n\n          {suggestionType === \"date\" && (\n            <Command>\n              <CommandList>\n                <CommandGroup>\n                  <CommandItem onSelect={insertDateSuggestion} className=\"cursor-pointer\">\n                    <Calendar className=\"mr-2 h-4 w-4\" />\n                    <span>\n                      Add date:{\" \"}\n                      {crmDateInputString(\n                        new Date(parseDateFromText(suggestionQuery) || new Date()),\n                      )}\n                    </span>\n                  </CommandItem>\n                </CommandGroup>\n              </CommandList>\n            </Command>\n          )}\n        </div>\n      )}\n    </div>\n  );\n});\n\nSmartTextInput.displayName = \"SmartTextInput\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/RelativeDate.tsx",
      "content": "import { CRM_TIME_ZONE_LABEL, formatCrmDateTime } from \"./timezone\";\n\ntype Mode = \"utc+4\" | \"local\";\n\n// Always render using the enforced CRM timezone (UTC+4).\n// The `mode` prop is kept for backward compatibility but ignored.\nexport function RelativeDate({\n  date,\n}: {\n  date: string;\n  mode?: Mode;\n}) {\n  const formatted = formatCrmDateTime(date);\n  if (!formatted) return null;\n  return <span title={CRM_TIME_ZONE_LABEL}>{formatted}</span>;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/ImageEditorField.tsx",
      "content": "import { useFieldValue } from \"ra-core\";\nimport { createRef, useCallback, useState } from \"react\";\nimport type { ReactCropperElement } from \"react-cropper\";\nimport { Cropper } from \"react-cropper\";\nimport { useDropzone } from \"react-dropzone\";\nimport { useFormContext } from \"react-hook-form\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\nimport \"cropperjs/dist/cropper.css\";\n\nconst ImageEditorField = (props: ImageEditorFieldProps) => {\n  const { getValues } = useFormContext();\n  const source = getValues(props.source);\n  const imageUrl = source?.src;\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n\n  const { type = \"image\", emptyText, linkPosition = \"none\" } = props;\n\n  const commonProps = {\n    src: imageUrl,\n    onClick: () => setIsDialogOpen(true),\n    style: { cursor: \"pointer\" },\n    className: `${props.className || \"\"}`,\n  };\n\n  const width = props.width || (type === \"avatar\" ? 50 : 200);\n  const height = props.height || (type === \"avatar\" ? 50 : 200);\n\n  return (\n    <>\n      <div\n        className={`flex ${\n          linkPosition === \"right\" ? \"flex-row\" : \"flex-col\"\n        } items-center ${\n          linkPosition === \"right\" ? \"gap-2\" : \"gap-1\"\n        } rounded p-${props.backgroundImageColor ? \"4\" : \"0\"}`}\n        style={{\n          backgroundColor: props.backgroundImageColor || \"transparent\",\n        }}\n      >\n        {props.type === \"avatar\" ? (\n          <Avatar\n            {...commonProps}\n            className={`cursor-pointer`}\n            style={{ width, height }}\n          >\n            <AvatarImage src={imageUrl} />\n            <AvatarFallback>{emptyText}</AvatarFallback>\n          </Avatar>\n        ) : (\n          <img\n            {...commonProps}\n            className=\"cursor-pointer object-cover\"\n            style={{ width, height }}\n            alt=\"Editable content\"\n          />\n        )}\n        {linkPosition !== \"none\" && (\n          <button\n            type=\"button\"\n            onClick={() => setIsDialogOpen(true)}\n            className=\"text-xs underline hover:no-underline cursor-pointer text-center\"\n          >\n            Change\n          </button>\n        )}\n      </div>\n      <ImageEditorDialog\n        open={isDialogOpen}\n        onClose={() => setIsDialogOpen(false)}\n        {...props}\n      />\n    </>\n  );\n};\n\nconst ImageEditorDialog = (props: ImageEditorDialogProps) => {\n  const { setValue, handleSubmit } = useFormContext();\n  const cropperRef = createRef<ReactCropperElement>();\n  const initialValue = useFieldValue({ source: props.source });\n  const [file, setFile] = useState<File | undefined>();\n  const [imageSrc, setImageSrc] = useState<string | undefined>(\n    initialValue?.src,\n  );\n  const onDrop = useCallback((files: File[]) => {\n    const preview = URL.createObjectURL(files[0]);\n    setFile(files[0]);\n    setImageSrc(preview);\n  }, []);\n\n  const updateImage = () => {\n    const cropper = cropperRef.current?.cropper;\n    const croppedImage = cropper?.getCroppedCanvas().toDataURL();\n    if (croppedImage) {\n      setImageSrc(croppedImage);\n\n      const newFile = file ?? new File([], initialValue?.src);\n      setValue(\n        props.source,\n        {\n          src: croppedImage,\n          title: newFile.name,\n          rawFile: newFile,\n        },\n        { shouldDirty: true },\n      );\n      props.onClose();\n\n      if (props.onSave) {\n        handleSubmit(props.onSave)();\n      }\n    }\n  };\n\n  const deleteImage = () => {\n    setValue(props.source, null, { shouldDirty: true });\n    if (props.onSave) {\n      handleSubmit(props.onSave)();\n    }\n    setImageSrc(undefined);\n    props.onClose();\n  };\n\n  const { getRootProps, getInputProps } = useDropzone({\n    accept: { \"image/jpeg\": [\".jpeg\", \".png\"] },\n    onDrop,\n    maxFiles: 1,\n  });\n\n  return (\n    <Dialog open={props.open} onOpenChange={props.onClose}>\n      {props.type === \"avatar\" && (\n        <style>\n          {`\n                        .cropper-crop-box,\n                        .cropper-view-box {\n                            border-radius: 50%;\n                        }\n                    `}\n        </style>\n      )}\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Upload and resize image</DialogTitle>\n          <DialogDescription className=\"sr-only\">\n            Upload an image file and crop it to the desired size.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"flex flex-col gap-2 justify-center\">\n          <div\n            className=\"flex flex-row justify-center bg-gray-50 cursor-pointer p-4 border-2 border-dashed border-gray-300 rounded-lg hover:bg-gray-100 transition-colors\"\n            {...getRootProps()}\n          >\n            <input {...getInputProps()} />\n            <p className=\"text-gray-600\">\n              Drop a file to upload, or click to select it.\n            </p>\n          </div>\n\n          {imageSrc && (\n            <Cropper\n              ref={cropperRef}\n              src={imageSrc}\n              aspectRatio={1}\n              guides={false}\n              cropBoxResizable={false}\n            />\n          )}\n        </div>\n\n        <DialogFooter className=\"flex justify-between w-full\">\n          <Button type=\"button\" onClick={updateImage}>\n            Update Image\n          </Button>\n          <Button type=\"button\" variant=\"destructive\" onClick={deleteImage}>\n            Delete\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default ImageEditorField;\n\nexport interface ImageEditorFieldProps {\n  source: string;\n  width?: number;\n  height?: number;\n  type?: \"avatar\" | \"image\";\n  onSave?: any;\n  linkPosition?: \"right\" | \"bottom\" | \"none\";\n  backgroundImageColor?: string;\n  className?: string;\n  emptyText?: string;\n}\n\nexport interface ImageEditorDialogProps extends ImageEditorFieldProps {\n  open: boolean;\n  onClose: () => void;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/ContactOption.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\n\nimport type { Contact } from \"../types\";\n\n// eslint-disable-next-line react-refresh/only-export-components\nconst ContactOptionRender = () => {\n  const record: Contact | undefined = useRecordContext();\n  if (!record) return null;\n  return (\n    <div className=\"flex flex-row gap-4 items-center justify-start\">\n      <div className=\"flex flex-col items-start gap-1\">\n        <span>\n          {record.first_name} {record.last_name}\n        </span>\n        <span className=\"text-xs text-muted-foreground\">\n          {record.title}\n          {record.title && record.company_name && \" at \"}\n          {record.company_name}\n        </span>\n      </div>\n    </div>\n  );\n};\nexport const contactOptionText = <ContactOptionRender />;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/misc/AsideSection.tsx",
      "content": "import type { ReactNode } from \"react\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { cn } from \"@/lib/utils\";\n\nexport type AsideSectionProps = {\n  title: string;\n  children?: ReactNode;\n  noGap?: boolean;\n};\n\nexport function AsideSection({ title, children, noGap }: AsideSectionProps) {\n  return (\n    <div className=\"mb-6 text-sm\">\n      <h3 className=\"font-medium pb-1\">{title}</h3>\n      <Separator />\n      <div className={cn(\"pt-2 flex flex-col\", { \"gap-1\": !noGap })}>\n        {children}\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/login/StartPage.tsx",
      "content": "import { useQuery } from \"@tanstack/react-query\";\nimport { useDataProvider } from \"ra-core\";\nimport { Navigate } from \"react-router-dom\";\nimport { LoginPage } from \"@/components/admin/login-page\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport { LoginSkeleton } from \"./LoginSkeleton\";\n\nexport const StartPage = () => {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const {\n    data: isInitialized,\n    error,\n    isPending,\n  } = useQuery({\n    queryKey: [\"init\"],\n    queryFn: async () => {\n      return dataProvider.isInitialized();\n    },\n  });\n\n  if (isPending) return <LoginSkeleton />;\n  if (error) return <LoginPage />;\n  if (isInitialized) return <LoginPage />;\n\n  return <Navigate to=\"/sign-up\" />;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/login/SignupPage.tsx",
      "content": "import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Loader2 } from \"lucide-react\";\nimport { useDataProvider, useLogin, useNotify } from \"ra-core\";\nimport { useForm, type SubmitHandler } from \"react-hook-form\";\nimport { Navigate } from \"react-router\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { SignUpData } from \"../types\";\nimport { LoginSkeleton } from \"./LoginSkeleton\";\n\nexport const SignupPage = () => {\n  const queryClient = useQueryClient();\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const { darkModeLogo: logo, title } = useConfigurationContext();\n  const { data: isInitialized, isPending } = useQuery({\n    queryKey: [\"init\"],\n    queryFn: async () => {\n      return dataProvider.isInitialized();\n    },\n  });\n\n  const { isPending: isSignUpPending, mutate } = useMutation({\n    mutationKey: [\"signup\"],\n    mutationFn: async (data: SignUpData) => {\n      return dataProvider.signUp(data);\n    },\n    onSuccess: (data) => {\n      login({\n        email: data.email,\n        password: data.password,\n        redirectTo: \"/contacts\",\n      }).then(() => {\n        notify(\"Initial user successfully created\");\n        // FIXME: We should probably provide a hook for that in the ra-core package\n        queryClient.invalidateQueries({\n          queryKey: [\"auth\", \"canAccess\"],\n        });\n      });\n    },\n    onError: () => {\n      notify(\"An error occurred. Please try again.\");\n    },\n  });\n\n  const login = useLogin();\n  const notify = useNotify();\n\n  const {\n    register,\n    handleSubmit,\n    formState: { isValid },\n  } = useForm<SignUpData>({\n    mode: \"onChange\",\n  });\n\n  if (isPending) {\n    return <LoginSkeleton />;\n  }\n\n  // For the moment, we only allow one user to sign up. Other users must be created by the administrator.\n  if (isInitialized) {\n    return <Navigate to=\"/login\" />;\n  }\n\n  const onSubmit: SubmitHandler<SignUpData> = async (data) => {\n    mutate(data);\n  };\n\n  return (\n    <div className=\"h-screen p-8\">\n      <div className=\"flex items-center gap-4\">\n        <img\n          src={logo}\n          alt={title}\n          width={24}\n          className=\"filter brightness-0 invert\"\n        />\n        <h1 className=\"text-xl font-semibold\">{title}</h1>\n      </div>\n      <div className=\"h-full\">\n        <div className=\"max-w-sm mx-auto h-full flex flex-col justify-center gap-4\">\n          <h1 className=\"text-2xl font-bold mb-4\">Welcome to BestDOC CRM</h1>\n          <p className=\"text-base mb-4\">\n            Create the first user account to complete the setup.\n          </p>\n          <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"first_name\">First name</Label>\n              <Input\n                {...register(\"first_name\", { required: true })}\n                id=\"first_name\"\n                type=\"text\"\n                required\n              />\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"last_name\">Last name</Label>\n              <Input\n                {...register(\"last_name\", { required: true })}\n                id=\"last_name\"\n                type=\"text\"\n                required\n              />\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                {...register(\"email\", { required: true })}\n                id=\"email\"\n                type=\"email\"\n                required\n              />\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input\n                {...register(\"password\", { required: true })}\n                id=\"password\"\n                type=\"password\"\n                required\n              />\n            </div>\n            <div className=\"flex justify-between items-center mt-8\">\n              <Button\n                type=\"submit\"\n                disabled={!isValid || isSignUpPending}\n                className=\"w-full\"\n              >\n                {isSignUpPending ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n                    Creating...\n                  </>\n                ) : (\n                  \"Create account\"\n                )}\n              </Button>\n            </div>\n          </form>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nSignupPage.path = \"/sign-up\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/login/LoginSkeleton.tsx",
      "content": "import { Skeleton } from \"@/components/ui/skeleton\";\n\nexport const LoginSkeleton = () => {\n  return (\n    <div className=\"max-w-screen-xl mx-auto h-screen pt-8\">\n      <div className=\"h-full\">\n        <div className=\"max-w-sm mx-auto h-full flex flex-col justify-center gap-8\">\n          <Skeleton className=\"w-full h-[100px]\" />\n          <Skeleton className=\"w-4/5 h-[50px]\" />\n          <Skeleton className=\"w-full h-9\" />\n          <Skeleton className=\"w-full h-9\" />\n          <Skeleton className=\"w-full h-9\" />\n          <Skeleton className=\"w-2/5 h-9\" />\n        </div>\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/TopToolbar.tsx",
      "content": "import { cn } from \"@/lib/utils\";\nimport type { HTMLAttributes, ReactNode } from \"react\";\n\nexport interface TopToolbarProps extends HTMLAttributes<HTMLDivElement> {\n  children?: ReactNode;\n}\n\nexport const TopToolbar = (inProps: TopToolbarProps) => {\n  const { className, children, ...props } = inProps;\n\n  return (\n    <div\n      className={cn(\n        \"flex flex-auto items-end gap-2 whitespace-nowrap w-full\",\n        className,\n      )}\n      {...props}\n    >\n      {children}\n    </div>\n  );\n};\n\nexport default TopToolbar;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/NotificationsMenu.tsx",
      "content": "import { useMemo, useState, useEffect } from \"react\";\nimport { Link } from \"react-router\";\nimport { Bell, CheckSquare, FileText } from \"lucide-react\";\nimport { useGetIdentity, useGetList, useUpdate } from \"ra-core\";\nimport { useQueryClient } from \"@tanstack/react-query\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { cn } from \"@/lib/utils\";\n\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport type { ContactNote, DealNote, Task } from \"../types\";\n\ntype NotificationItem =\n  | {\n      kind: \"task\";\n      id: Task[\"id\"];\n      text: string;\n      date: string;\n      contactId: Task[\"contact_id\"];\n      done: boolean;\n      task: Task;\n      isNew: boolean;\n    }\n  | {\n      kind: \"contactNote\";\n      id: ContactNote[\"id\"];\n      text: string;\n      date: string;\n      contactId: ContactNote[\"contact_id\"];\n      isNew: boolean;\n    }\n  | {\n      kind: \"dealNote\";\n      id: DealNote[\"id\"];\n      text: string;\n      date: string;\n      dealId: DealNote[\"deal_id\"];\n      isNew: boolean;\n    };\n\nconst storageKey = (userId: number) => `crm.notifications.lastSeen.${userId}`;\n\nconst safeIso = (v: any) => {\n  if (!v) return null;\n  const d = new Date(v);\n  if (Number.isNaN(d.getTime())) return null;\n  return d.toISOString();\n};\n\nexport const NotificationsMenu = () => {\n  const queryClient = useQueryClient();\n  const { identity } = useGetIdentity();\n  const userId = Number.isInteger(identity?.id) ? (identity!.id as number) : null;\n\n  const [open, setOpen] = useState(false);\n  const [lastSeenIso, setLastSeenIso] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (!userId) return;\n    const stored = globalThis.localStorage?.getItem(storageKey(userId));\n    setLastSeenIso(stored || null);\n  }, [userId]);\n\n  const mentionsFilter = useMemo(() => {\n    if (!userId) return { \"id@in\": \"(-1)\" };\n    return { \"tagged_user_ids@cs\": `{${userId}}` };\n  }, [userId]);\n\n  const { data: tasks = [], isPending: isTasksPending } = useGetList<Task>(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 25 },\n      sort: { field: \"created_at\", order: \"DESC\" },\n      filter: mentionsFilter,\n    },\n    { enabled: !!userId },\n  );\n\n  const { data: contactNotes = [], isPending: isContactNotesPending } =\n    useGetList<ContactNote>(\n      \"contactNotes\",\n      {\n        pagination: { page: 1, perPage: 25 },\n        sort: { field: \"date\", order: \"DESC\" },\n        filter: mentionsFilter,\n      },\n      { enabled: !!userId },\n    );\n\n  const { data: dealNotes = [], isPending: isDealNotesPending } = useGetList<DealNote>(\n    \"dealNotes\",\n    {\n      pagination: { page: 1, perPage: 25 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: mentionsFilter,\n    },\n    { enabled: !!userId },\n  );\n\n  const lastSeenDate = useMemo(() => {\n    if (!lastSeenIso) return null;\n    const d = new Date(lastSeenIso);\n    return Number.isNaN(d.getTime()) ? null : d;\n  }, [lastSeenIso]);\n\n  const items: NotificationItem[] = useMemo(() => {\n    const since = lastSeenDate?.getTime() ?? null;\n\n    const mappedTasks: NotificationItem[] = tasks.map((t) => {\n      const date =\n        safeIso(t.created_at) ||\n        safeIso(t.due_date) ||\n        new Date().toISOString();\n      const isNew = since ? new Date(date).getTime() > since : false;\n      return {\n        kind: \"task\",\n        id: t.id,\n        text: t.text || \"Task\",\n        date,\n        contactId: t.contact_id,\n        done: !!t.done_date,\n        task: t,\n        isNew,\n      };\n    });\n\n    const mappedContactNotes: NotificationItem[] = contactNotes.map((n) => {\n      const date = safeIso(n.date) || new Date().toISOString();\n      const isNew = since ? new Date(date).getTime() > since : false;\n      return {\n        kind: \"contactNote\",\n        id: n.id,\n        text: n.text || \"Note\",\n        date,\n        contactId: n.contact_id,\n        isNew,\n      };\n    });\n\n    const mappedDealNotes: NotificationItem[] = dealNotes.map((n) => {\n      const date = safeIso(n.date) || new Date().toISOString();\n      const isNew = since ? new Date(date).getTime() > since : false;\n      return {\n        kind: \"dealNote\",\n        id: n.id,\n        text: n.text || \"Note\",\n        date,\n        dealId: n.deal_id,\n        isNew,\n      };\n    });\n\n    const merged = [...mappedTasks, ...mappedContactNotes, ...mappedDealNotes];\n    merged.sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());\n    return merged.slice(0, 40);\n  }, [contactNotes, dealNotes, lastSeenDate, tasks]);\n\n  const unreadCount = useMemo(\n    () => items.reduce((acc, it) => acc + (it.isNew ? 1 : 0), 0),\n    [items],\n  );\n\n  const [updateTask, { isPending: isUpdatingTask }] = useUpdate();\n\n  const markAllAsRead = () => {\n    if (!userId) return;\n    const now = new Date().toISOString();\n    globalThis.localStorage?.setItem(storageKey(userId), now);\n    setLastSeenIso(now);\n  };\n\n  const handleOpenChange = (nextOpen: boolean) => {\n    setOpen(nextOpen);\n    // When closing the menu, mark all currently visible notifications as â€œseenâ€.\n    if (!nextOpen && userId) {\n      const now = new Date().toISOString();\n      globalThis.localStorage?.setItem(storageKey(userId), now);\n      setLastSeenIso(now);\n    }\n  };\n\n  const isPending = isTasksPending || isContactNotesPending || isDealNotesPending;\n\n  return (\n    <DropdownMenu modal={false} open={open} onOpenChange={handleOpenChange}>\n      <DropdownMenuTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className=\"relative inline-flex\"\n          aria-label=\"Notifications\"\n        >\n          <Bell className=\"h-[1.2rem] w-[1.2rem]\" />\n          {unreadCount > 0 && (\n            <span className=\"absolute -top-0.5 -right-0.5 h-4 min-w-4 px-1 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-[10px] font-semibold\">\n              {unreadCount > 9 ? \"9+\" : unreadCount}\n            </span>\n          )}\n        </Button>\n      </DropdownMenuTrigger>\n\n      <DropdownMenuContent align=\"end\" className=\"w-[420px] p-0\">\n        <div className=\"px-3 py-2 flex items-center justify-between\">\n          <div className=\"text-sm font-medium\">Mentions</div>\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"h-7 px-2\"\n            onClick={markAllAsRead}\n            disabled={!userId}\n          >\n            Mark all read\n          </Button>\n        </div>\n        <DropdownMenuSeparator />\n\n        <div className=\"max-h-[70vh] overflow-auto\">\n          {!userId ? (\n            <div className=\"px-3 py-8 text-sm text-muted-foreground\">\n              Sign in to see notifications.\n            </div>\n          ) : isPending ? (\n            <div className=\"px-3 py-8 text-sm text-muted-foreground\">Loadingâ€¦</div>\n          ) : items.length === 0 ? (\n            <div className=\"px-3 py-8 text-sm text-muted-foreground\">\n              No mentions yet.\n            </div>\n          ) : (\n            <div className=\"py-1\">\n              {items.map((it) => {\n                const href =\n                  it.kind === \"task\"\n                    ? `/contacts/${it.contactId}/show?tab=tasks#task-${it.id}`\n                    : it.kind === \"contactNote\"\n                      ? `/contacts/${it.contactId}/show?tab=notes#note-${it.id}`\n                      : `/lead-journey/${it.dealId}/show?tab=notes#note-${it.id}`;\n\n                return (\n                  <div\n                    key={`${it.kind}-${it.id}`}\n                    className={cn(\n                      \"px-3 py-2 flex items-start gap-2 hover:bg-accent/60\",\n                      it.isNew && \"bg-accent/30\",\n                    )}\n                  >\n                    <div className=\"mt-0.5 flex-shrink-0\">\n                      {it.kind === \"task\" ? (\n                        <CheckSquare className=\"h-4 w-4 text-muted-foreground\" />\n                      ) : (\n                        <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                      )}\n                    </div>\n\n                    {it.kind === \"task\" ? (\n                      <Checkbox\n                        checked={it.done}\n                        disabled={isUpdatingTask}\n                        onCheckedChange={() => {\n                          updateTask(\"tasks\", {\n                            id: it.id,\n                            data: { done_date: it.done ? null : new Date().toISOString() },\n                            previousData: it.task,\n                          });\n                          // Keep the dropdown list in sync\n                          queryClient.invalidateQueries({ queryKey: [\"tasks\", \"getList\"] });\n                        }}\n                        className=\"mt-1 h-4 w-4\"\n                      />\n                    ) : (\n                      <span className=\"mt-1 h-4 w-4 flex-shrink-0\" />\n                    )}\n\n                    <div className=\"flex-1 min-w-0\">\n                      <Link\n                        to={href}\n                        className=\"block no-underline text-foreground\"\n                        onClick={() => setOpen(false)}\n                      >\n                        <div className=\"flex items-center justify-between gap-2\">\n                          <div className=\"text-xs text-muted-foreground\">\n                            {it.kind === \"task\" ? \"Task\" : \"Note\"}\n                            {it.isNew ? \" â€¢ New\" : \"\"}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground whitespace-nowrap\">\n                            <RelativeDate date={it.date} />\n                          </div>\n                        </div>\n                        <div className=\"text-sm leading-5 mt-0.5 line-clamp-2\">\n                          {it.text}\n                        </div>\n                      </Link>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </div>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n};\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/Layout.tsx",
      "content": "import { Suspense, type ReactNode } from \"react\";\nimport { ErrorBoundary } from \"react-error-boundary\";\nimport { Notification } from \"@/components/admin/notification\";\nimport { Error } from \"@/components/admin/error\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\nimport Header from \"./Header\";\n\nexport const Layout = ({ children }: { children: ReactNode }) => (\n  <>\n    <Header />\n    <main className=\"max-w-screen-xl mx-auto pt-4 px-4\" id=\"main-content\">\n      <ErrorBoundary FallbackComponent={Error}>\n        <Suspense fallback={<Skeleton className=\"h-12 w-12 rounded-full\" />}>\n          {children}\n        </Suspense>\n      </ErrorBoundary>\n    </main>\n    <Notification />\n  </>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/Header.tsx",
      "content": "import { DropdownMenuItem } from \"@/components/ui/dropdown-menu\";\nimport { Settings, User } from \"lucide-react\";\nimport { CanAccess } from \"ra-core\";\nimport { Link, matchPath, useLocation } from \"react-router\";\nimport { RefreshButton } from \"@/components/admin/refresh-button\";\nimport { ThemeModeToggle } from \"@/components/admin/theme-mode-toggle\";\nimport { UserMenu } from \"@/components/admin/user-menu\";\nimport { useUserMenu } from \"@/hooks/user-menu-context\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { NotificationsMenu } from \"./NotificationsMenu\";\n\nconst Header = () => {\n  const { darkModeLogo, lightModeLogo, title } = useConfigurationContext();\n  const location = useLocation();\n\n  let currentPath: string | boolean = \"/\";\n  if (matchPath(\"/\", location.pathname)) {\n    currentPath = \"/\";\n  } else if (matchPath(\"/contacts/*\", location.pathname)) {\n    currentPath = \"/contacts\";\n  } else if (matchPath(\"/clients/*\", location.pathname)) {\n    currentPath = \"/clients\";\n  } else if (matchPath(\"/lead-journey/*\", location.pathname)) {\n    currentPath = \"/lead-journey\";\n  } else if (matchPath(\"/tasks\", location.pathname)) {\n    currentPath = \"/tasks\";\n  } else if (matchPath(\"/notes\", location.pathname)) {\n    currentPath = \"/notes\";\n  } else {\n    currentPath = false;\n  }\n\n  return (\n    <nav className=\"flex-grow\">\n      <header className=\"bg-secondary\">\n        <div className=\"px-4\">\n          <div className=\"flex justify-between items-center flex-1\">\n            <Link\n              to=\"/\"\n              className=\"flex items-center gap-2 text-secondary-foreground no-underline\"\n            >\n              <img\n                className=\"[.light_&]:hidden h-6\"\n                src={darkModeLogo}\n                alt={title}\n              />\n              <img\n                className=\"[.dark_&]:hidden h-6\"\n                src={lightModeLogo}\n                alt={title}\n              />\n              <h1 className=\"text-xl font-semibold\">{title}</h1>\n            </Link>\n            <div>\n              <nav className=\"flex\">\n                <NavigationTab\n                  label=\"Dashboard\"\n                  to=\"/\"\n                  isActive={currentPath === \"/\"}\n                />\n                <NavigationTab\n                  label=\"Leads\"\n                  to=\"/contacts\"\n                  isActive={currentPath === \"/contacts\"}\n                />\n                <NavigationTab\n                  label=\"Clients\"\n                  to=\"/clients\"\n                  isActive={currentPath === \"/clients\"}\n                />\n                <NavigationTab\n                  label=\"Lead Journey\"\n                  to=\"/lead-journey\"\n                  isActive={currentPath === \"/lead-journey\"}\n                />\n                <NavigationTab\n                  label=\"Tasks\"\n                  to=\"/tasks\"\n                  isActive={currentPath === \"/tasks\"}\n                />\n                <NavigationTab\n                  label=\"Notes\"\n                  to=\"/notes\"\n                  isActive={currentPath === \"/notes\"}\n                />\n              </nav>\n            </div>\n            <div className=\"flex items-center\">\n              <ThemeModeToggle />\n              <NotificationsMenu />\n              <RefreshButton />\n              <UserMenu>\n                <ConfigurationMenu />\n                <CanAccess resource=\"sales\" action=\"list\">\n                  <UsersMenu />\n                </CanAccess>\n              </UserMenu>\n            </div>\n          </div>\n        </div>\n      </header>\n    </nav>\n  );\n};\n\nconst NavigationTab = ({\n  label,\n  to,\n  isActive,\n}: {\n  label: string;\n  to: string;\n  isActive: boolean;\n}) => (\n  <Link\n    to={to}\n    className={`px-6 py-3 text-sm font-medium transition-colors border-b-2 ${\n      isActive\n        ? \"text-secondary-foreground border-secondary-foreground\"\n        : \"text-secondary-foreground/70 border-transparent hover:text-secondary-foreground/80\"\n    }`}\n  >\n    {label}\n  </Link>\n);\n\nconst UsersMenu = () => {\n  const { onClose } = useUserMenu() ?? {};\n  return (\n    <DropdownMenuItem asChild onClick={onClose}>\n      <Link to=\"/settings\" className=\"flex items-center gap-2\">\n        <User /> Users and Settings\n      </Link>\n    </DropdownMenuItem>\n  );\n};\n\nconst ConfigurationMenu = () => {\n  const { onClose } = useUserMenu() ?? {};\n  return (\n    <DropdownMenuItem asChild onClick={onClose}>\n      <Link to=\"/settings\" className=\"flex items-center gap-2\">\n        <Settings />\n        My info\n      </Link>\n    </DropdownMenuItem>\n  );\n};\nexport default Header;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/layout/FormToolbar.tsx",
      "content": "import { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\n\nexport const FormToolbar = () => (\n  <div\n    role=\"toolbar\"\n    className=\"sticky flex pt-4 pb-4 md:pb-0 bottom-0 bg-linear-to-b from-transparent to-card to-10% flex-row justify-end gap-2\"\n  >\n    <CancelButton />\n    <SaveButton />\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/filters/filterUtils.ts",
      "content": "type Primitive = string | number;\n\nexport const parseInFilter = (value?: string): string[] => {\n  if (!value) return [];\n  return value\n    .replace(/[()]/g, \"\")\n    .split(\",\")\n    .map((item) => item.trim())\n    .filter(Boolean);\n};\n\nexport const buildInFilter = (values: Primitive[]): string | undefined => {\n  if (!values.length) return undefined;\n  return `(${values.join(\",\")})`;\n};\n\nexport const parseOverlapFilter = (value?: string): string[] => {\n  if (!value) return [];\n  return value\n    .replace(/[{}]/g, \"\")\n    .split(\",\")\n    .map((item) => item.trim())\n    .filter(Boolean);\n};\n\nexport const buildOverlapFilter = (\n  values: Primitive[],\n): string | undefined => {\n  if (!values.length) return undefined;\n  return `{${values.join(\",\")}}`;\n};\n\nexport const toggleValueInList = (\n  list: Primitive[],\n  value: Primitive,\n): Primitive[] => {\n  const asString = String(value);\n  const hasValue = list.some((item) => String(item) === asString);\n  return hasValue\n    ? list.filter((item) => String(item) !== asString)\n    : [...list, value];\n};\n\nexport type RangeFilter = {\n  field: string;\n  gte?: string;\n  lte?: string;\n};\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/filters/FilterOptionButton.tsx",
      "content": "import { CircleX } from \"lucide-react\";\nimport type { ReactNode } from \"react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\n\nexport const FilterOptionButton = ({\n  label,\n  selected,\n  onToggle,\n  className,\n}: {\n  label: ReactNode;\n  selected: boolean;\n  onToggle: () => void;\n  className?: string;\n}) => (\n  <Button\n    variant={selected ? \"secondary\" : \"ghost\"}\n    size=\"sm\"\n    onClick={onToggle}\n    className={cn(\n      \"cursor-pointer flex flex-row items-center justify-between gap-2 px-2.5 w-full\",\n      className,\n    )}\n  >\n    {label}\n    {selected && <CircleX className=\"h-4 w-4 opacity-50\" />}\n  </Button>\n);\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/filters/FilterCategory.tsx",
      "content": "import { Translate } from \"ra-core\";\nimport type { ReactNode } from \"react\";\n\nimport { Button } from \"@/components/ui/button\";\n\nexport const FilterCategory = ({\n  icon,\n  label,\n  children,\n  count,\n  onClear,\n}: {\n  icon: ReactNode;\n  label: string;\n  children?: ReactNode;\n  count?: number;\n  onClear?: () => void;\n}) => (\n  <div className=\"flex flex-col gap-2\">\n    <div className=\"flex flex-row items-center justify-between gap-2\">\n      <h3 className=\"flex flex-row items-center gap-2 font-bold text-sm\">\n        {icon}\n        <Translate i18nKey={label} />\n      </h3>\n      <div className=\"flex flex-row items-center gap-1\">\n        {count !== undefined && count > 0 ? (\n          <span className=\"text-xs text-muted-foreground\">{count}</span>\n        ) : null}\n        {onClear ? (\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"h-7 px-2 text-xs\"\n            onClick={onClear}\n            disabled={!count}\n          >\n            Clear\n          </Button>\n        ) : null}\n      </div>\n    </div>\n    <div className=\"flex flex-col items-start pl-4\">{children}</div>\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/stages.ts",
      "content": "import type { ConfigurationContextValue } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\n\nexport type DealsByStage = Record<Deal[\"stage\"], Deal[]>;\n\nexport const getDealsByStage = (\n  unorderedDeals: Deal[],\n  stages: ConfigurationContextValue[\"dealStages\"] | ConfigurationContextValue[\"leadStages\"],\n) => {\n  if (!stages || stages.length === 0) return {};\n\n  const initialColumns = stages.reduce(\n    (obj, stage) => ({ ...obj, [stage.value]: [] }),\n    {} as Record<Deal[\"stage\"], Deal[]>,\n  );\n\n  const dealsByStage: Record<Deal[\"stage\"], Deal[]> = unorderedDeals.reduce(\n    (acc, deal) => {\n      if (!acc[deal.stage]) {\n        acc[deal.stage] = [];\n      }\n      acc[deal.stage].push(deal);\n      return acc;\n    },\n    { ...initialColumns },\n  );\n\n  // order each column by index\n  stages.forEach((stage) => {\n    dealsByStage[stage.value] = (dealsByStage[stage.value] ?? []).sort(\n      (recordA: Deal, recordB: Deal) => recordA.index - recordB.index,\n    );\n  });\n  return dealsByStage;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/index.ts",
      "content": "import * as React from \"react\";\nconst DealList = React.lazy(() => import(\"./DealList\"));\n\nexport default {\n  list: DealList,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/dealUtils.ts",
      "content": "export function getRelativeTimeString(dateString: string): string {\n  const date = new Date(dateString);\n  date.setHours(0, 0, 0, 0);\n\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const diff = date.getTime() - today.getTime();\n  const unitDiff = Math.round(diff / (1000 * 60 * 60 * 24));\n\n  // Check if the date is more than one week old\n  if (Math.abs(unitDiff) > 7) {\n    return new Intl.DateTimeFormat(\"en-GB\", {\n      day: \"2-digit\",\n      month: \"2-digit\",\n      year: \"numeric\",\n    }).format(date);\n  }\n\n  // Intl.RelativeTimeFormat for dates within the last week\n  const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: \"auto\" });\n  return ucFirst(rtf.format(unitDiff, \"day\"));\n}\n\nfunction ucFirst(str: string): string {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/deal.ts",
      "content": "import type { DealStage } from \"../types\";\n\nexport const findDealLabel = (dealStages: DealStage[], dealValue: string) => {\n  return dealStages.find((dealStage) => dealStage.value === dealValue)?.label;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/createLeadJourneyDeal.ts",
      "content": "import type { DataProvider, Identifier } from \"ra-core\";\n\ntype MinimalContactLike = {\n  id: Identifier;\n  first_name?: string | null;\n  last_name?: string | null;\n  sales_id?: Identifier | null;\n  company_id?: Identifier | null;\n};\n\n/**\n * \"Lead Journey\" is backed by the `deals` table (resource name: \"lead-journey\").\n *\n * The schema has evolved over time:\n * - legacy: deals.contact_ids[] (array of contact IDs)\n * - current: deals.lead_id (single contact ID)\n * - optional newer: deals.first_name / deals.last_name (denormalized for display)\n *\n * This helper writes the correct record and gracefully falls back based on\n * which columns exist in the DB, so imports don't silently miss Lead Journey.\n */\nexport async function createLeadJourneyDealForContact(\n  dataProvider: DataProvider,\n  contact: MinimalContactLike,\n  fallbackSalesId?: Identifier,\n) {\n  const now = new Date().toISOString();\n  const name =\n    `${contact.first_name ?? \"\"} ${contact.last_name ?? \"\"}`.trim() || \"New Lead\";\n  const sales_id = (contact.sales_id ?? fallbackSalesId ?? null) as any;\n\n  const baseData: any = {\n    name,\n    stage: \"new\",\n    index: 0,\n    sales_id,\n    company_id: (contact.company_id ?? null) as any,\n    created_at: now,\n    updated_at: now,\n  };\n\n  // Attempt 1: newest schema (lead_id + first/last name columns)\n  try {\n    return await dataProvider.create(\"lead-journey\", {\n      data: {\n        ...baseData,\n        lead_id: contact.id,\n        first_name: contact.first_name ?? null,\n        last_name: contact.last_name ?? null,\n      },\n    });\n  } catch {\n    // ignore - fall through\n  }\n\n  // Attempt 2: schema with lead_id but without first/last name columns\n  try {\n    return await dataProvider.create(\"lead-journey\", {\n      data: {\n        ...baseData,\n        lead_id: contact.id,\n      },\n    });\n  } catch {\n    // ignore - fall through\n  }\n\n  // Attempt 3: legacy schema (contact_ids array, no lead_id column)\n  return await dataProvider.create(\"lead-journey\", {\n    data: {\n      ...baseData,\n      contact_ids: [contact.id],\n    },\n  });\n}\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/OnlyMineInput.tsx",
      "content": "import { useGetIdentity, useListFilterContext } from \"ra-core\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\n\nexport const OnlyMineInput = (_: { alwaysOn: boolean; source: string }) => {\n  const { filterValues, displayedFilters, setFilters } = useListFilterContext();\n  const { identity } = useGetIdentity();\n\n  const handleChange = () => {\n    const newFilterValues = { ...filterValues };\n    if (typeof filterValues.sales_id !== \"undefined\") {\n      delete newFilterValues.sales_id;\n    } else {\n      newFilterValues.sales_id = identity && identity?.id;\n    }\n    setFilters(newFilterValues, displayedFilters);\n  };\n  return (\n    <div className=\"mt-auto pb-2.25\">\n      <div className=\"flex items-center space-x-2\">\n        <Switch\n          id=\"only-mine\"\n          checked={typeof filterValues.sales_id !== \"undefined\"}\n          onCheckedChange={handleChange}\n        />\n        <Label htmlFor=\"only-mine\">Only leads I manage</Label>\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/LeadJourneyTopFilter.tsx",
      "content": "import { subMonths } from \"date-fns\";\nimport {\n  ChevronDown,\n  ChevronUp,\n  Clock,\n  Filter,\n  Stethoscope,\n  Users,\n  X,\n} from \"lucide-react\";\nimport { FilterLiveForm, useGetIdentity, useGetList, useListContext } from \"ra-core\";\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  crmEndOfYesterday,\n  crmStartOfMonth,\n  crmStartOfWeek,\n} from \"../misc/timezone\";\n\nexport const LeadJourneyTopFilter = ({ \n  isExpanded \n}: { \n  isExpanded: boolean;\n}) => {\n  const { identity } = useGetIdentity();\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  const { data: salesData } = useGetList(\"sales\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"first_name\", order: \"ASC\" },\n  });\n\n  const startOfWeek = crmStartOfWeek();\n  const startOfMonth = crmStartOfMonth();\n  const endOfYesterday = crmEndOfYesterday();\n\n  return (\n    <>\n      {/* Collapsible Filter Section */}\n      {isExpanded && (\n        <Card className=\"mb-4\">\n          <CardContent className=\"p-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n              {/* Last Activity */}\n              <div className=\"flex flex-col gap-2\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                  <Clock className=\"h-4 w-4\" />\n                  Last activity\n                </div>\n                <div className=\"flex flex-col gap-1\">\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"Today\"\n                    value={{\n                      \"updated_at@gte\": endOfYesterday?.toISOString(),\n                      \"updated_at@lte\": undefined,\n                    }}\n                  />\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"This week\"\n                    value={{\n                      \"updated_at@gte\": startOfWeek?.toISOString(),\n                      \"updated_at@lte\": undefined,\n                    }}\n                  />\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"Before this week\"\n                    value={{\n                      \"updated_at@gte\": undefined,\n                      \"updated_at@lte\": startOfWeek?.toISOString(),\n                    }}\n                  />\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"Before this month\"\n                    value={{\n                      \"updated_at@gte\": undefined,\n                      \"updated_at@lte\": startOfMonth?.toISOString(),\n                    }}\n                  />\n                  <ToggleFilterButton\n                    className=\"w-full justify-start\"\n                    label=\"Before last month\"\n                    value={{\n                      \"updated_at@gte\": undefined,\n                      \"updated_at@lte\": subMonths(\n                        startOfMonth ?? new Date(),\n                        1,\n                      ).toISOString(),\n                    }}\n                  />\n                </div>\n              </div>\n\n              {/* Services */}\n              <div className=\"flex flex-col gap-2\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                  <Stethoscope className=\"h-4 w-4\" />\n                  Services\n                </div>\n                <div className=\"flex flex-col gap-1\">\n                  {servicesData &&\n                    servicesData.map((service) => (\n                      <ToggleFilterButton\n                        key={service.id}\n                        className=\"w-full justify-start\"\n                        label={service.name}\n                        value={{ \"services_interested@cs\": `{${service.id}}` }}\n                      />\n                    ))}\n                </div>\n              </div>\n\n              {/* Account Manager */}\n              <div className=\"flex flex-col gap-2\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                  <Users className=\"h-4 w-4\" />\n                  Account Manager\n                </div>\n                <div className=\"flex flex-col gap-1\">\n                  {salesData &&\n                    salesData.map((sale) => (\n                      <ToggleFilterButton\n                        key={sale.id}\n                        className=\"w-full justify-start\"\n                        label={`${sale.first_name} ${sale.last_name}`}\n                        value={{ sales_id: sale.id }}\n                      />\n                    ))}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </>\n  );\n};\n\nexport const LeadJourneySearchAndFilter = ({ \n  onFilterToggle, \n  isFilterExpanded \n}: { \n  onFilterToggle: () => void;\n  isFilterExpanded: boolean;\n}) => {\n  const { filterValues, setFilters } = useListContext();\n\n  const hasActiveFilters = filterValues && Object.keys(filterValues).length > 0 && \n    Object.keys(filterValues).some(key => key !== \"archived_at@is\" && key !== \"q\");\n\n  const clearAllFilters = () => {\n    const baseFilter = { \"archived_at@is\": null };\n    setFilters(baseFilter, {});\n  };\n\n  return (\n    <div className=\"flex items-center gap-2 flex-1\">\n      <div className=\"flex-1 max-w-md\">\n        <FilterLiveForm>\n          <SearchInput \n            source=\"q\" \n            placeholder=\"Search name, company...\"\n          />\n        </FilterLiveForm>\n      </div>\n      {hasActiveFilters && (\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={clearAllFilters}\n          className=\"text-muted-foreground\"\n        >\n          <X className=\"h-4 w-4 mr-1\" />\n          Clear\n        </Button>\n      )}\n      <Button\n        variant=\"outline\"\n        size=\"sm\"\n        onClick={onFilterToggle}\n        className=\"flex items-center gap-2\"\n      >\n        <Filter className=\"h-4 w-4\" />\n        Filters\n        {isFilterExpanded ? (\n          <ChevronUp className=\"h-4 w-4\" />\n        ) : (\n          <ChevronDown className=\"h-4 w-4\" />\n        )}\n      </Button>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/LeadJourneyListFilter.tsx",
      "content": "import { subMonths } from \"date-fns\";\nimport {\n  CheckSquare,\n  Clock,\n  Stethoscope,\n  Tag,\n  TrendingUp,\n  Users,\n} from \"lucide-react\";\nimport { FilterLiveForm, useGetIdentity, useGetList } from \"ra-core\";\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { Status } from \"../misc/Status\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport {\n  crmEndOfYesterday,\n  crmStartOfMonth,\n  crmStartOfWeek,\n} from \"../misc/timezone\";\n\nexport const LeadJourneyListFilter = () => {\n  const { noteStatuses, leadStages } = useConfigurationContext();\n  const { identity } = useGetIdentity();\n  const { data } = useGetList(\"tags\", {\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const startOfWeek = crmStartOfWeek();\n  const startOfMonth = crmStartOfMonth();\n  const endOfYesterday = crmEndOfYesterday();\n\n  return (\n    <div className=\"w-52 min-w-52 order-first pt-0.75 flex flex-col gap-4\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" placeholder=\"Search name, company...\" />\n      </FilterLiveForm>\n\n      <FilterCategory label=\"Last activity\" icon={<Clock />}>\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Today\"\n          value={{\n            \"updated_at@gte\": endOfYesterday?.toISOString(),\n            \"updated_at@lte\": undefined,\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"This week\"\n          value={{\n            \"updated_at@gte\": startOfWeek?.toISOString(),\n            \"updated_at@lte\": undefined,\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Before this week\"\n          value={{\n            \"updated_at@gte\": undefined,\n            \"updated_at@lte\": startOfWeek?.toISOString(),\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Before this month\"\n          value={{\n            \"updated_at@gte\": undefined,\n            \"updated_at@lte\": startOfMonth?.toISOString(),\n          }}\n        />\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label=\"Before last month\"\n          value={{\n            \"updated_at@gte\": undefined,\n            \"updated_at@lte\": subMonths(\n              startOfMonth ?? new Date(),\n              1,\n            ).toISOString(),\n          }}\n        />\n      </FilterCategory>\n\n      <FilterCategory label=\"Stage\" icon={<TrendingUp />}>\n        {leadStages.map((stage) => (\n          <ToggleFilterButton\n            key={stage.value}\n            className=\"w-full justify-between\"\n            label={stage.label}\n            value={{ stage: stage.value }}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory icon={<Users />} label=\"Account Manager\">\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label={\"Me\"}\n          value={{ sales_id: identity?.id }}\n        />\n      </FilterCategory>\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealShow.tsx",
      "content": "import { useMutation } from \"@tanstack/react-query\";\nimport { Archive, ArchiveRestore, Phone, Mail, MapPin, Stethoscope } from \"lucide-react\";\nimport { useEffect } from \"react\";\nimport {\n  ShowBase,\n  useDataProvider,\n  useGetList,\n  useGetOne,\n  useNotify,\n  useRecordContext,\n  useRedirect,\n  useRefresh,\n  useUpdate,\n  RecordContextProvider,\n  useListContext,\n} from \"ra-core\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Link, useLocation } from \"react-router\";\nimport { subHours } from \"date-fns\";\n\nimport { NotesIterator } from \"../notes/NotesIterator\";\nimport { UnifiedNotesIterator } from \"../notes/UnifiedNotesIterator\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal, Contact, DealNote, ContactNote } from \"../types\";\nimport { TagsListEdit } from \"../contacts/TagsListEdit\";\nimport { ServicesListEdit } from \"../contacts/ServicesListEdit\";\nimport { QuotesIterator } from \"../quotes/QuotesIterator\";\nimport { AddQuote } from \"../quotes/AddQuote\";\nimport { TasksIterator } from \"../tasks/TasksIterator\";\nimport { AddTask } from \"../tasks/AddTask\";\nimport { findDealLabel } from \"./deal\";\n\nexport const DealShow = ({ open, id }: { open: boolean; id?: string }) => {\n  const redirect = useRedirect();\n  const handleClose = () => {\n    redirect(\"list\", \"lead-journey\");\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={(open) => !open && handleClose()}>\n      <DialogContent className=\"lg:max-w-4xl p-4 overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        {id ? (\n          <ShowBase id={id} resource=\"lead-journey\">\n            <DealShowContent />\n          </ShowBase>\n        ) : (\n          <>\n            <DialogTitle className=\"sr-only\">Deal Details</DialogTitle>\n            <DialogDescription className=\"sr-only\">View deal information</DialogDescription>\n          </>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nconst DealShowContent = () => {\n  const { leadStages } = useConfigurationContext();\n  const record = useRecordContext<Deal>();\n  const location = useLocation();\n  if (!record) return null;\n\n  // Fetch Contact data using lead_id\n  const { data: contact } = useGetOne<Contact>(\n    \"contacts\",\n    { id: record.lead_id },\n    { enabled: !!record.lead_id }\n  );\n\n  // Fetch services from database to match with services_interested IDs\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 100 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  // Fetch notes, quotes, and tasks for notification badges\n  const { data: dealNotes } = useGetList<DealNote>(\"dealNotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: { deal_id: record.id },\n  }, { enabled: !!record.id });\n\n  const { data: contactNotes } = useGetList<ContactNote>(\"contactNotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record.lead_id ? { contact_id: record.lead_id } : {},\n  }, { enabled: !!record.lead_id });\n\n  const { data: quotes } = useGetList(\"quotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record.lead_id ? { contact_id: record.lead_id } : {},\n  }, { enabled: !!record.lead_id });\n\n  const { data: tasks } = useGetList(\"tasks\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record.lead_id ? { contact_id: record.lead_id } : {},\n  }, { enabled: !!record.lead_id });\n\n  // Calculate notification counts for last 24 hours\n  const twentyFourHoursAgo = subHours(new Date(), 24);\n  \n  const newNotesCount = [\n    ...(dealNotes || []).filter(note => new Date(note.date) > twentyFourHoursAgo),\n    ...(contactNotes || []).filter(note => new Date(note.date) > twentyFourHoursAgo),\n  ].length;\n  \n  const newQuotesCount = (quotes || []).filter(quote => {\n    const createdAt = quote.created_at || quote.date;\n    return createdAt && new Date(createdAt) > twentyFourHoursAgo;\n  }).length;\n  \n  const newTasksCount = (tasks || []).filter(task => {\n    // Show tasks that are due within the next 24 hours or overdue\n    if (!task.due_date) return false;\n    const dueDate = new Date(task.due_date);\n    const now = new Date();\n    return dueDate <= now || (dueDate > now && dueDate <= new Date(now.getTime() + 24 * 60 * 60 * 1000));\n  }).length;\n\n  const displayName = contact \n    ? `${contact.first_name || \"\"} ${contact.last_name || \"\"}`.trim() || \"New Lead\"\n    : record.first_name || record.last_name\n    ? `${record.first_name ?? \"\"} ${record.last_name ?? \"\"}`.trim()\n    : record.name || \"New Lead\";\n\n  // Deep-link scrolling for #note-123 / #task-456 inside the dialog.\n  // We retry a few frames because the tab content may mount slightly later.\n  const defaultTab = (() => {\n    const tab = new URLSearchParams(location.search).get(\"tab\");\n    if (tab === \"notes\" || tab === \"quotes\" || tab === \"tasks\") return tab;\n    return \"notes\";\n  })();\n\n  useEffect(() => {\n    const hash = (location.hash || \"\").replace(/^#/, \"\");\n    if (!hash) return;\n\n    let tries = 0;\n    const tryScroll = () => {\n      tries += 1;\n      const el = document.getElementById(hash);\n      if (el) {\n        el.scrollIntoView({ block: \"center\", behavior: \"smooth\" });\n        return;\n      }\n      if (tries < 24) setTimeout(tryScroll, 150);\n    };\n\n    tryScroll();\n  }, [location.hash, defaultTab]);\n\n  return (\n    <>\n      <DialogTitle className=\"sr-only\">{displayName}</DialogTitle>\n      <DialogDescription className=\"sr-only\">Deal details and information</DialogDescription>\n      <div className=\"space-y-2\">\n        {record.archived_at ? <ArchivedTitle /> : null}\n        <div className=\"flex-1\">\n          <div className=\"flex justify-between items-start mb-8\">\n            <div className=\"flex items-center gap-4\">\n              <h2 className=\"text-2xl font-semibold\">{displayName}</h2>\n              <span className=\"text-sm font-medium text-muted-foreground\">\n                {record.stage === \"converted\" ? \"Client\" : findDealLabel(leadStages, record.stage)}\n              </span>\n            </div>\n            <div className={`flex gap-2 ${record.archived_at ? \"\" : \"pr-12\"}`}>\n              {record.archived_at ? (\n                <>\n                  <UnarchiveButton record={record} />\n                  <DeleteButton />\n                </>\n              ) : (\n                <>\n                  <ArchiveButton record={record} />\n                  <AddToClientsButton record={record} />\n                  {contact && (\n                    <Button asChild variant=\"outline\" size=\"sm\" className=\"h-9\">\n                      <Link to={`/contacts/${contact.id}/show`}>See Contact</Link>\n                    </Button>\n                  )}\n                </>\n              )}\n            </div>\n          </div>\n\n          {/* Lead Information Section - All in one row */}\n          {contact && (\n            <div className=\"m-4\">\n              <Separator className=\"mb-4\" />\n              <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n                {/* Phone Numbers */}\n                <div className=\"flex flex-col\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide flex items-center gap-2 mb-1\">\n                    <Phone className=\"h-4 w-4\" />\n                    Phone\n                  </span>\n                  {contact.phone_jsonb && contact.phone_jsonb.length > 0 ? (\n                    <div className=\"flex flex-col gap-1\">\n                      {contact.phone_jsonb.map((phone, index) => (\n                        <span key={index} className=\"text-sm\">\n                          {phone.number}\n                        </span>\n                      ))}\n                    </div>\n                  ) : (\n                    <span className=\"text-sm text-muted-foreground\">â€”</span>\n                  )}\n                </div>\n\n                {/* Services Interested */}\n                <div className=\"flex flex-col\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide flex items-center gap-2 mb-1\">\n                    <Stethoscope className=\"h-4 w-4\" />\n                    Services Interested\n                  </span>\n                  <RecordContextProvider value={contact}>\n                    <ServicesListEdit />\n                  </RecordContextProvider>\n                </div>\n\n                {/* Tags */}\n                <div className=\"flex flex-col\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide mb-1\">\n                    Tags\n                  </span>\n                  <RecordContextProvider value={contact}>\n                    <TagsListEdit />\n                  </RecordContextProvider>\n                </div>\n\n                {/* Stage */}\n                <div className=\"flex flex-col\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide mb-1\">\n                    Stage\n                  </span>\n                  <StageSelect deal={record} leadStages={leadStages} />\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Email and Address Section */}\n          {contact && (\n            <div className=\"m-4 space-y-4\">\n              <Separator />\n              \n              {/* Email Addresses */}\n              {contact.email_jsonb && contact.email_jsonb.length > 0 && (\n                <div className=\"flex flex-col gap-2\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide flex items-center gap-2\">\n                    <Mail className=\"h-4 w-4\" />\n                    Email\n                  </span>\n                  <div className=\"flex flex-col gap-1\">\n                    {contact.email_jsonb.map((email, index) => (\n                      <div key={index} className=\"flex items-center gap-2\">\n                        <a \n                          href={`mailto:${email.email}`}\n                          className=\"text-sm text-primary hover:underline\"\n                        >\n                          {email.email}\n                        </a>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {email.type}\n                        </Badge>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Address */}\n              {(contact.flat_villa_number || contact.building_street || contact.area) && (\n                <div className=\"flex flex-col gap-2\">\n                  <span className=\"text-xs text-muted-foreground tracking-wide flex items-center gap-2\">\n                    <MapPin className=\"h-4 w-4\" />\n                    Address\n                  </span>\n                  <div className=\"text-sm\">\n                    {contact.flat_villa_number && <span>{contact.flat_villa_number}, </span>}\n                    {contact.building_street && <span>{contact.building_street}, </span>}\n                    {contact.area && <span>{contact.area}</span>}\n                    {contact.google_maps_link && (\n                      <a\n                        href={contact.google_maps_link}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"ml-2 text-primary hover:underline\"\n                      >\n                        View on Map\n                      </a>\n                    )}\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* Tabs for Notes, Quotes, Tasks */}\n          <div className=\"m-4\">\n            <Separator className=\"mb-4\" />\n            <Tabs defaultValue={defaultTab}>\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"notes\" className=\"relative gap-2\">\n                  <span>Notes</span>\n                  {newNotesCount > 0 && (\n                    <span className=\"h-5 min-w-5 px-1.5 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-[10px] font-semibold\">\n                      {newNotesCount}\n                    </span>\n                  )}\n                </TabsTrigger>\n                <TabsTrigger value=\"quotes\" className=\"relative gap-2\">\n                  <span>Quotes</span>\n                  {newQuotesCount > 0 && (\n                    <span className=\"h-5 min-w-5 px-1.5 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-[10px] font-semibold\">\n                      {newQuotesCount}\n                    </span>\n                  )}\n                </TabsTrigger>\n                <TabsTrigger value=\"tasks\" className=\"relative gap-2\">\n                  <span>Tasks</span>\n                  {newTasksCount > 0 && (\n                    <span className=\"h-5 min-w-5 px-1.5 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-[10px] font-semibold\">\n                      {newTasksCount}\n                    </span>\n                  )}\n                </TabsTrigger>\n              </TabsList>\n              <TabsContent value=\"notes\" className=\"pt-4\">\n                <UnifiedNotesIterator\n                  reference=\"lead-journey\"\n                  dealId={record.id}\n                  // Prefer lead_id when present, fallback to the first legacy contact_ids entry\n                  contactId={\n                    record.lead_id ?? (Array.isArray(record.contact_ids) ? record.contact_ids[0] : undefined)\n                  }\n                  leadId={record.lead_id}\n                />\n              </TabsContent>\n              <TabsContent value=\"quotes\" className=\"pt-4\">\n                {record.lead_id && contact ? (\n                  <RecordContextProvider value={contact}>\n                    <ReferenceManyField\n                      target=\"contact_id\"\n                      reference=\"quotes\"\n                      sort={{ field: \"created_at\", order: \"DESC\" }}\n                    >\n                      <QuotesIterator />\n                    </ReferenceManyField>\n                  </RecordContextProvider>\n                ) : null}\n                {record.lead_id && contact && (\n                  <div className=\"mt-4\">\n                    <RecordContextProvider value={contact}>\n                      <AddQuote />\n                    </RecordContextProvider>\n                  </div>\n                )}\n              </TabsContent>\n              <TabsContent value=\"tasks\" className=\"pt-4\">\n                {record.lead_id && contact ? (\n                  <RecordContextProvider value={contact}>\n                    <ReferenceManyField\n                      target=\"contact_id\"\n                      reference=\"tasks\"\n                      sort={{ field: \"due_date\", order: \"ASC\" }}\n                    >\n                      <TasksIterator showAll />\n                    </ReferenceManyField>\n                  </RecordContextProvider>\n                ) : null}\n                {record.lead_id && contact && (\n                  <div className=\"mt-4\">\n                    <RecordContextProvider value={contact}>\n                      <AddTask />\n                    </RecordContextProvider>\n                  </div>\n                )}\n              </TabsContent>\n            </Tabs>\n          </div>\n        </div>\n      </div>\n    </>\n  );\n};\n\nconst ArchivedTitle = () => (\n  <div className=\"bg-orange-500 px-6 py-4\">\n    <h3 className=\"text-lg font-bold text-white\">Archived Deal</h3>\n  </div>\n);\n\nconst ArchiveButton = ({ record }: { record: Deal }) => {\n  const [update] = useUpdate();\n  const redirect = useRedirect();\n  const notify = useNotify();\n  const refresh = useRefresh();\n  const handleClick = () => {\n    update(\n      \"lead-journey\",\n      {\n        id: record.id,\n        data: { archived_at: new Date().toISOString() },\n        previousData: record,\n      },\n      {\n        onSuccess: () => {\n          redirect(\"list\", \"lead-journey\");\n          notify(\"Deal archived\", { type: \"info\", undoable: false });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error: deal not archived\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  return (\n    <Button\n      onClick={handleClick}\n      size=\"sm\"\n      variant=\"outline\"\n      className=\"flex items-center gap-2 h-9\"\n    >\n      <Archive className=\"w-4 h-4\" />\n      Archive\n    </Button>\n  );\n};\n\nconst UnarchiveButton = ({ record }: { record: Deal }) => {\n  const dataProvider = useDataProvider();\n  const redirect = useRedirect();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const { mutate } = useMutation({\n    mutationFn: () => dataProvider.unarchiveDeal(record),\n    onSuccess: () => {\n      redirect(\"list\", \"lead-journey\");\n      notify(\"Deal unarchived\", {\n        type: \"info\",\n        undoable: false,\n      });\n      refresh();\n    },\n    onError: () => {\n      notify(\"Error: deal not unarchived\", { type: \"error\" });\n    },\n  });\n\n  const handleClick = () => {\n    mutate();\n  };\n\n  return (\n    <Button\n      onClick={handleClick}\n      size=\"sm\"\n      variant=\"outline\"\n      className=\"flex items-center gap-2 h-9\"\n    >\n      <ArchiveRestore className=\"w-4 h-4\" />\n      Send back to the board\n    </Button>\n  );\n};\n\nconst AddToClientsButton = ({ record }: { record: Deal }) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n  const isClient = record.stage === \"converted\";\n\n  const handleClick = () => {\n    if (isClient) {\n      // Already a client, maybe show a message or navigate to client page\n      notify(\"This lead is already a client\", { type: \"info\", undoable: false });\n    } else {\n      // Convert to client by updating stage to \"converted\"\n      update(\n        \"lead-journey\",\n        {\n          id: record.id,\n          data: { stage: \"converted\" },\n          previousData: record,\n        },\n        {\n          onSuccess: () => {\n            notify(\"Lead converted to client\", { type: \"success\", undoable: false });\n            refresh();\n          },\n          onError: () => {\n            notify(\"Error: lead not converted to client\", { type: \"error\" });\n          },\n        },\n      );\n    }\n  };\n\n  return (\n    <Button\n      onClick={handleClick}\n      size=\"sm\"\n      variant={isClient ? \"default\" : \"outline\"}\n      className=\"flex items-center gap-2 h-9\"\n      disabled={isClient}\n    >\n      {isClient ? \"Client\" : \"Add to Clients\"}\n    </Button>\n  );\n};\n\nconst StageSelect = ({ deal, leadStages }: { deal: Deal; leadStages: any[] }) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const handleStageChange = (newStage: string) => {\n    if (newStage === deal.stage) return;\n    \n    update(\n      \"lead-journey\",\n      {\n        id: deal.id,\n        data: { stage: newStage },\n        previousData: deal,\n      },\n      {\n        onSuccess: () => {\n          notify(\"Deal stage updated\", { type: \"info\" });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error updating deal stage\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  return (\n    <Select value={deal.stage} onValueChange={handleStageChange}>\n      <SelectTrigger className=\"h-8 text-sm\">\n        <SelectValue>\n          {deal.stage === \"converted\" ? \"Client\" : findDealLabel(leadStages, deal.stage)}\n        </SelectValue>\n      </SelectTrigger>\n      <SelectContent>\n        {leadStages.map((stage) => (\n          <SelectItem key={stage.value} value={stage.value}>\n            {stage.label}\n          </SelectItem>\n        ))}\n      </SelectContent>\n    </Select>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealListContent.tsx",
      "content": "import { DragDropContext, type OnDragEndResponder } from \"@hello-pangea/dnd\";\nimport isEqual from \"lodash/isEqual\";\nimport { useDataProvider, useListContext, type DataProvider } from \"ra-core\";\nimport { useEffect, useState } from \"react\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\nimport { DealColumn } from \"./DealColumn\";\nimport type { DealsByStage } from \"./stages\";\nimport { getDealsByStage } from \"./stages\";\n\nexport const DealListContent = () => {\n  const { leadStages } = useConfigurationContext();\n  const { data: unorderedDeals, isPending, refetch } = useListContext<Deal>();\n  const dataProvider = useDataProvider();\n\n  const [dealsByStage, setDealsByStage] = useState<DealsByStage>(\n    getDealsByStage([], leadStages),\n  );\n\n  useEffect(() => {\n    if (unorderedDeals) {\n      const newDealsByStage = getDealsByStage(unorderedDeals, leadStages);\n      if (!isEqual(newDealsByStage, dealsByStage)) {\n        setDealsByStage(newDealsByStage);\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [unorderedDeals]);\n\n  if (isPending) return null;\n\n  const onDragEnd: OnDragEndResponder = (result) => {\n    const { destination, source } = result;\n\n    if (!destination) {\n      return;\n    }\n\n    if (\n      destination.droppableId === source.droppableId &&\n      destination.index === source.index\n    ) {\n      return;\n    }\n\n    const sourceStage = source.droppableId;\n    const destinationStage = destination.droppableId;\n    const sourceDeal = dealsByStage[sourceStage][source.index]!;\n    const destinationDeal = dealsByStage[destinationStage][\n      destination.index\n    ] ?? {\n      stage: destinationStage,\n      index: undefined, // undefined if dropped after the last item\n    };\n\n    // compute local state change synchronously\n    setDealsByStage(\n      updateDealStageLocal(\n        sourceDeal,\n        { stage: sourceStage, index: source.index },\n        { stage: destinationStage, index: destination.index },\n        dealsByStage,\n      ),\n    );\n\n    // persist the changes\n    updateDealStage(sourceDeal, destinationDeal, dataProvider).then(() => {\n      refetch();\n    });\n  };\n\n  return (\n    <DragDropContext onDragEnd={onDragEnd}>\n      <div \n        className=\"grid gap-4 h-[calc(100vh-14rem)] mt-4\" \n        style={{\n          gridTemplateColumns: `repeat(${leadStages.length}, minmax(0, 1fr))`\n        }}\n      >\n        {leadStages.map((stage) => (\n          <DealColumn\n            stage={stage.value}\n            deals={dealsByStage[stage.value]}\n            key={stage.value}\n          />\n        ))}\n      </div>\n    </DragDropContext>\n  );\n};\n\nconst updateDealStageLocal = (\n  sourceDeal: Deal,\n  source: { stage: string; index: number },\n  destination: {\n    stage: string;\n    index?: number; // undefined if dropped after the last item\n  },\n  dealsByStage: DealsByStage,\n) => {\n  if (source.stage === destination.stage) {\n    // moving deal inside the same column\n    const column = dealsByStage[source.stage];\n    column.splice(source.index, 1);\n    column.splice(destination.index ?? column.length + 1, 0, sourceDeal);\n    return {\n      ...dealsByStage,\n      [destination.stage]: column,\n    };\n  } else {\n    // moving deal across columns\n    const sourceColumn = dealsByStage[source.stage];\n    const destinationColumn = dealsByStage[destination.stage];\n    sourceColumn.splice(source.index, 1);\n    destinationColumn.splice(\n      destination.index ?? destinationColumn.length + 1,\n      0,\n      sourceDeal,\n    );\n    return {\n      ...dealsByStage,\n      [source.stage]: sourceColumn,\n      [destination.stage]: destinationColumn,\n    };\n  }\n};\n\nexport const updateDealStage = async (\n  source: Deal,\n  destination: {\n    stage: string;\n    index?: number; // undefined if dropped after the last item\n  },\n  dataProvider: DataProvider,\n) => {\n  if (source.stage === destination.stage) {\n    // moving deal inside the same column\n    // Fetch all the deals in this stage (because the list may be filtered, but we need to update even non-filtered deals)\n    const { data: columnDeals } = await dataProvider.getList(\"lead-journey\", {\n      sort: { field: \"index\", order: \"ASC\" },\n      // Keep this large so reordering works even with many deals in a stage\n      pagination: { page: 1, perPage: 5000 },\n      filter: { stage: source.stage },\n    });\n    const destinationIndex = destination.index ?? columnDeals.length + 1;\n\n    if (source.index > destinationIndex) {\n      // deal moved up, eg\n      // dest   src\n      //  <------\n      // [4, 7, 23, 5]\n      await Promise.all([\n        // for all deals between destinationIndex and source.index, increase the index\n        ...columnDeals\n          .filter(\n            (deal) =>\n              deal.index >= destinationIndex && deal.index < source.index,\n          )\n          .map((deal) =>\n            dataProvider.update(\"lead-journey\", {\n              id: deal.id,\n              data: { index: deal.index + 1 },\n              previousData: deal,\n            }),\n          ),\n        // for the deal that was moved, update its index\n        dataProvider.update(\"lead-journey\", {\n          id: source.id,\n          data: { index: destinationIndex },\n          previousData: source,\n        }),\n      ]);\n    } else {\n      // deal moved down, e.g\n      // src   dest\n      //  ------>\n      // [4, 7, 23, 5]\n      await Promise.all([\n        // for all deals between source.index and destinationIndex, decrease the index\n        ...columnDeals\n          .filter(\n            (deal) =>\n              deal.index <= destinationIndex && deal.index > source.index,\n          )\n          .map((deal) =>\n            dataProvider.update(\"lead-journey\", {\n              id: deal.id,\n              data: { index: deal.index - 1 },\n              previousData: deal,\n            }),\n          ),\n        // for the deal that was moved, update its index\n        dataProvider.update(\"lead-journey\", {\n          id: source.id,\n          data: { index: destinationIndex },\n          previousData: source,\n        }),\n      ]);\n    }\n  } else {\n    // moving deal across columns\n    // Fetch all the deals in both stages (because the list may be filtered, but we need to update even non-filtered deals)\n    const [{ data: sourceDeals }, { data: destinationDeals }] =\n      await Promise.all([\n        dataProvider.getList(\"lead-journey\", {\n          sort: { field: \"index\", order: \"ASC\" },\n          pagination: { page: 1, perPage: 5000 },\n          filter: { stage: source.stage },\n        }),\n        dataProvider.getList(\"lead-journey\", {\n          sort: { field: \"index\", order: \"ASC\" },\n          pagination: { page: 1, perPage: 5000 },\n          filter: { stage: destination.stage },\n        }),\n      ]);\n    const destinationIndex = destination.index ?? destinationDeals.length + 1;\n\n    await Promise.all([\n      // decrease index on the deals after the source index in the source columns\n      ...sourceDeals\n        .filter((deal) => deal.index > source.index)\n        .map((deal) =>\n          dataProvider.update(\"lead-journey\", {\n            id: deal.id,\n            data: { index: deal.index - 1 },\n            previousData: deal,\n          }),\n        ),\n      // increase index on the deals after the destination index in the destination columns\n      ...destinationDeals\n        .filter((deal) => deal.index >= destinationIndex)\n        .map((deal) =>\n          dataProvider.update(\"lead-journey\", {\n            id: deal.id,\n            data: { index: deal.index + 1 },\n            previousData: deal,\n          }),\n        ),\n      // change the dragged deal to take the destination index and column\n      dataProvider.update(\"lead-journey\", {\n        id: source.id,\n        data: {\n          index: destinationIndex,\n          stage: destination.stage,\n        },\n        previousData: source,\n      }),\n    ]);\n  }\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealList.tsx",
      "content": "import { useGetIdentity, useListContext } from \"ra-core\";\nimport { matchPath, useLocation } from \"react-router\";\nimport { useState } from \"react\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { List } from \"@/components/admin/list\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { Button } from \"@/components/ui/button\";\n\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { DealArchivedList } from \"./DealArchivedList\";\nimport { DealCreate } from \"./DealCreate\";\nimport { DealEdit } from \"./DealEdit\";\nimport { DealEmpty } from \"./DealEmpty\";\nimport { DealListContent } from \"./DealListContent\";\nimport { DealShow } from \"./DealShow\";\nimport { ContactCreateDialog } from \"./ContactCreateDialog\";\nimport {\n  LeadJourneySearchAndFilter,\n  LeadJourneyTopFilter,\n} from \"./LeadJourneyTopFilter\";\n\nconst DealList = () => {\n  const { identity } = useGetIdentity();\n  const [createLeadDialogOpen, setCreateLeadDialogOpen] = useState(false);\n  const [isFilterExpanded, setIsFilterExpanded] = useState(false);\n  const [showArchived, setShowArchived] = useState(false);\n\n  if (!identity) return null;\n\n  const dealFilters = [\n    <ReferenceInput source=\"lead_id\" reference=\"contacts\">\n      <AutocompleteInput\n        label={false}\n        placeholder=\"Lead\"\n        optionText={(choice: any) =>\n          `${choice.first_name} ${choice.last_name || \"\"}`\n        }\n      />\n    </ReferenceInput>,\n  ];\n\n  return (\n    <List\n      // Lead Journey is a kanban board; pagination can hide newly created/imported leads\n      // (e.g. new deals often start with low index values like 0).\n      // Use a large page size so the board reflects the full pipeline.\n      perPage={5000}\n      // If a contact is deleted, the FK sets deals.lead_id to NULL (ON DELETE SET NULL).\n      // We don't want orphaned deals to keep showing as Lead Journey cards.\n      filter={{ \"archived_at@is\": null, \"lead_id@not.is\": null }}\n      title={false}\n      // Lower index = higher priority/top of column (see DealListContent updateDealStage)\n      sort={{ field: \"index\", order: \"ASC\" }}\n      filters={dealFilters}\n      actions={\n        <DealActions\n          onNewLeadClick={() => setCreateLeadDialogOpen(true)}\n          isFilterExpanded={isFilterExpanded}\n          onFilterToggle={() => setIsFilterExpanded(!isFilterExpanded)}\n          onArchivedClick={() => setShowArchived(true)}\n        />\n      }\n      pagination={null}\n    >\n      <DealLayout\n        createLeadDialogOpen={createLeadDialogOpen}\n        setCreateLeadDialogOpen={setCreateLeadDialogOpen}\n        isFilterExpanded={isFilterExpanded}\n        showArchived={showArchived}\n        setShowArchived={setShowArchived}\n      />\n    </List>\n  );\n};\n\nconst DealLayout = ({\n  createLeadDialogOpen,\n  setCreateLeadDialogOpen,\n  isFilterExpanded,\n  showArchived,\n  setShowArchived,\n}: {\n  createLeadDialogOpen: boolean;\n  setCreateLeadDialogOpen: (open: boolean) => void;\n  isFilterExpanded: boolean;\n  showArchived: boolean;\n  setShowArchived: (open: boolean) => void;\n}) => {\n  const location = useLocation();\n  const matchCreate = matchPath(\"/lead-journey/create\", location.pathname);\n  const matchShow = matchPath(\"/lead-journey/:id/show\", location.pathname);\n  const matchEdit = matchPath(\"/lead-journey/:id\", location.pathname);\n\n  const { data, isPending, filterValues } = useListContext();\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  if (isPending) return null;\n  if (!data?.length && !hasFilters)\n    return (\n      <>\n        <DealEmpty>\n          <DealShow open={!!matchShow} id={matchShow?.params.id} />\n          <DealArchivedList open={showArchived} onOpenChange={setShowArchived} />\n        </DealEmpty>\n      </>\n    );\n\n  return (\n    <div className=\"w-full\">\n      <LeadJourneyTopFilter isExpanded={isFilterExpanded} />\n      <DealListContent />\n      <DealArchivedList open={showArchived} onOpenChange={setShowArchived} />\n      <DealCreate open={!!matchCreate} />\n      <DealEdit open={!!matchEdit && !matchCreate} id={matchEdit?.params.id} />\n      <DealShow open={!!matchShow} id={matchShow?.params.id} />\n      <ContactCreateDialog\n        open={createLeadDialogOpen}\n        onOpenChange={setCreateLeadDialogOpen}\n      />\n    </div>\n  );\n};\n\nconst DealActions = ({\n  onNewLeadClick,\n  isFilterExpanded,\n  onFilterToggle,\n  onArchivedClick,\n}: {\n  onNewLeadClick: () => void;\n  isFilterExpanded: boolean;\n  onFilterToggle: () => void;\n  onArchivedClick: () => void;\n}) => (\n  <TopToolbar className=\"flex items-center gap-4 w-full\">\n    <LeadJourneySearchAndFilter\n      isFilterExpanded={isFilterExpanded}\n      onFilterToggle={onFilterToggle}\n    />\n    <div className=\"ml-auto flex items-center gap-2\">\n      <Button variant=\"outline\" onClick={onArchivedClick}>\n        Archived\n      </Button>\n      <Button onClick={onNewLeadClick}>New Lead</Button>\n    </div>\n  </TopToolbar>\n);\n\nexport default DealList;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealInputs.tsx",
      "content": "import { required } from \"ra-core\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\n\nimport { contactOptionText } from \"../misc/ContactOption\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\nexport const DealInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-8\">\n      <DealInfoInputs />\n      <LeadReferenceInput />\n      <StageInput />\n    </div>\n  );\n};\n\nconst DealInfoInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4 flex-1\">\n      <div className=\"grid grid-cols-2 gap-4\">\n        <TextInput\n          source=\"first_name\"\n          label=\"First Name\"\n          helperText={false}\n        />\n        <TextInput\n          source=\"last_name\"\n          label=\"Last Name\"\n          helperText={false}\n        />\n      </div>\n    </div>\n  );\n};\n\nconst LeadReferenceInput = () => {\n  return (\n    <div className=\"flex flex-col gap-4 flex-1\">\n      <h3 className=\"text-base font-medium\">Linked to Lead</h3>\n      <ReferenceInput source=\"lead_id\" reference=\"contacts\">\n        <AutocompleteInput \n          label=\"Lead\"\n          optionText={contactOptionText}\n          validate={required()} \n        />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst StageInput = () => {\n  const { leadStages } = useConfigurationContext();\n  return (\n    <div className=\"flex flex-col gap-4 flex-1\">\n      <h3 className=\"text-base font-medium\">Stage</h3>\n      <SelectInput\n        source=\"stage\"\n        choices={leadStages.map((stage) => ({\n          id: stage.value,\n          name: stage.label,\n        }))}\n        defaultValue=\"new\"\n        helperText={false}\n        validate={required()}\n      />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealEmpty.tsx",
      "content": "import { useGetList } from \"ra-core\";\nimport { matchPath, useLocation, Link } from \"react-router\";\nimport type { ReactNode } from \"react\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { Progress } from \"@/components/ui/progress\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\nimport type { Contact } from \"../types\";\nimport { DealCreate } from \"./DealCreate\";\n\nexport const DealEmpty = ({ children }: { children?: ReactNode }) => {\n  const location = useLocation();\n  const matchCreate = matchPath(\"/lead-journey/create\", location.pathname);\n  const appbarHeight = useAppBarHeight();\n\n  // get Contact data\n  const { data: contacts, isPending: contactsLoading } = useGetList<Contact>(\n    \"contacts\",\n    {\n      pagination: { page: 1, perPage: 1 },\n    },\n  );\n\n  if (contactsLoading) return <Progress value={50} />;\n\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-12\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No lead statuses found\" />\n      {contacts && contacts.length > 0 ? (\n        <>\n          <div className=\"flex flex-col items-center gap-0\">\n            <h3 className=\"text-lg font-bold\">No lead statuses found</h3>\n            <p className=\"text-sm text-center text-muted-foreground mb-4\">\n              It seems your lead journey is empty.\n            </p>\n          </div>\n          <div className=\"flex space-x-8\">\n            <CreateButton label=\"Create Lead Status\" />\n          </div>\n          <DealCreate open={!!matchCreate} />\n          {children}\n        </>\n      ) : (\n        <div className=\"flex flex-col items-center gap-0\">\n          <h3 className=\"text-lg font-bold\">No lead statuses found</h3>\n          <p className=\"text-sm text-center text-muted-foreground mb-4\">\n            It seems your leads list is empty.\n            <br />\n            <Link to=\"/contacts/create\" className=\"hover:underline\">\n              Add your first lead\n            </Link>{\" \"}\n            before creating a lead status.\n          </p>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealEdit.tsx",
      "content": "import {\n  EditBase,\n  Form,\n  useNotify,\n  useRecordContext,\n  useRedirect,\n} from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\n\nimport { FormToolbar } from \"../layout/FormToolbar\";\nimport type { Deal } from \"../types\";\nimport { DealInputs } from \"./DealInputs\";\n\nexport const DealEdit = ({ open, id }: { open: boolean; id?: string }) => {\n  const redirect = useRedirect();\n  const notify = useNotify();\n\n  const handleClose = () => {\n    redirect(\"/lead-journey\", undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={() => handleClose()}>\n      <DialogContent className=\"lg:max-w-4xl p-4 overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        {id ? (\n          <EditBase\n            id={id}\n            mutationMode=\"pessimistic\"\n            mutationOptions={{\n              onSuccess: () => {\n                notify(\"Deal updated\");\n                redirect(`/lead-journey/${id}/show`, undefined, undefined, undefined, {\n                  _scrollToTop: false,\n                });\n              },\n            }}\n          >\n            <EditHeader />\n            <DialogDescription className=\"sr-only\">Edit deal information</DialogDescription>\n            <Form>\n              <DealInputs />\n              <FormToolbar />\n            </Form>\n          </EditBase>\n        ) : null}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nfunction EditHeader() {\n  const deal = useRecordContext<Deal>();\n  if (!deal) {\n    return null;\n  }\n\n  return (\n    <DialogTitle className=\"pb-0\">\n      <div className=\"flex justify-between items-start mb-8\">\n        <div className=\"flex items-center gap-4\">\n          <h2 className=\"text-2xl font-semibold\">\n            Edit {deal.first_name || deal.last_name\n              ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n              : deal.name || \"New Lead\"} deal\n          </h2>\n        </div>\n        <div className=\"flex gap-2 pr-12\">\n          <DeleteButton />\n          <Button asChild variant=\"outline\" className=\"h-9\">\n            <Link to={`/lead-journey/${deal.id}/show`}>Back to deal</Link>\n          </Button>\n        </div>\n      </div>\n    </DialogTitle>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealCreate.tsx",
      "content": "import { useQueryClient } from \"@tanstack/react-query\";\nimport {\n  Form,\n  useDataProvider,\n  useGetIdentity,\n  useListContext,\n  useRedirect,\n  type GetListResult,\n} from \"ra-core\";\nimport { Create } from \"@/components/admin/create\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Dialog, DialogContent, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\n\nimport type { Deal } from \"../types\";\nimport { DealInputs } from \"./DealInputs\";\n\nexport const DealCreate = ({ open }: { open: boolean }) => {\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const { data: allDeals } = useListContext<Deal>();\n\n  const handleClose = () => {\n    redirect(\"/lead-journey\");\n  };\n\n  const queryClient = useQueryClient();\n\n  const onSuccess = async (deal: Deal) => {\n    if (!allDeals) {\n      redirect(\"/lead-journey\");\n      return;\n    }\n    // increase the index of all deals in the same stage as the new deal\n    // first, get the list of deals in the same stage\n    const deals = allDeals.filter(\n      (d: Deal) => d.stage === deal.stage && d.id !== deal.id,\n    );\n    // update the actual deals in the database\n    await Promise.all(\n      deals.map(async (oldDeal) =>\n        dataProvider.update(\"lead-journey\", {\n          id: oldDeal.id,\n          data: { index: oldDeal.index + 1 },\n          previousData: oldDeal,\n        }),\n      ),\n    );\n    // refresh the list of deals in the cache as we used dataProvider.update(),\n    // which does not update the cache\n    const dealsById = deals.reduce(\n      (acc, d) => ({\n        ...acc,\n        [d.id]: { ...d, index: d.index + 1 },\n      }),\n      {} as { [key: string]: Deal },\n    );\n    const now = Date.now();\n    queryClient.setQueriesData<GetListResult | undefined>(\n      { queryKey: [\"lead-journey\", \"getList\"] },\n      (res) => {\n        if (!res) return res;\n        return {\n          ...res,\n          data: res.data.map((d: Deal) => dealsById[d.id] || d),\n        };\n      },\n      { updatedAt: now },\n    );\n    redirect(\"/lead-journey\");\n  };\n\n  const { identity } = useGetIdentity();\n\n  return (\n    <Dialog open={open} onOpenChange={() => handleClose()}>\n      <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        <DialogTitle className=\"sr-only\">Create New Deal</DialogTitle>\n        <DialogDescription className=\"sr-only\">Create a new deal in the lead journey</DialogDescription>\n        <Create resource=\"lead-journey\" mutationOptions={{ onSuccess }}>\n          <Form\n            defaultValues={{\n              sales_id: identity?.id,\n              contact_ids: [],\n              index: 0,\n            }}\n          >\n            <DealInputs />\n            <FormToolbar>\n              <SaveButton />\n            </FormToolbar>\n          </Form>\n        </Create>\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealColumn.tsx",
      "content": "import { Droppable } from \"@hello-pangea/dnd\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\nimport { findDealLabel } from \"./deal\";\nimport { DealCard } from \"./DealCard\";\n\nexport const DealColumn = ({\n  stage,\n  deals,\n}: {\n  stage: string;\n  deals: Deal[];\n}) => {\n  const leadCount = deals.length;\n  const { leadStages } = useConfigurationContext();\n  \n  return (\n    <div className=\"flex flex-col h-full min-w-0\">\n      <Card className=\"flex flex-col h-full gap-0 border-border/50 shadow-sm bg-card\">\n        <CardHeader className=\"flex-shrink-0 pb-2.5 px-4 pt-3 border-b border-border/50\">\n          <CardTitle className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n            <span className=\"truncate\">{findDealLabel(leadStages, stage)}</span>\n            {leadCount > 0 && (\n              <span className=\"text-xs font-medium text-foreground bg-muted px-1.5 py-0.5 rounded flex-shrink-0\">\n                {leadCount}\n              </span>\n            )}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex-1 overflow-y-auto min-h-0 p-2 bg-muted/20\">\n          <Droppable droppableId={stage}>\n            {(droppableProvided, snapshot) => (\n              <div\n                ref={droppableProvided.innerRef}\n                {...droppableProvided.droppableProps}\n                // Don't force height - let content determine height so scroll works\n                className={`flex flex-col gap-2 min-h-[150px] ${\n                  snapshot.isDraggingOver ? \"bg-muted/50 rounded-lg transition-colors\" : \"\"\n                }`}\n              >\n                {deals.map((deal, index) => (\n                  <DealCard key={deal.id} deal={deal} index={index} />\n                ))}\n                {droppableProvided.placeholder}\n              </div>\n            )}\n          </Droppable>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealCard.tsx",
      "content": "import { Draggable } from \"@hello-pangea/dnd\";\nimport { useGetOne, useRedirect, useDataProvider, useRefresh, useNotify } from \"ra-core\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  ContextMenu,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuTrigger,\n} from \"@/components/ui/context-menu\";\n\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal, Contact } from \"../types\";\nimport { updateDealStage } from \"./DealListContent\";\nimport { findDealLabel } from \"./deal\";\n\nexport const DealCard = ({ deal, index }: { deal: Deal; index: number }) => {\n  if (!deal) return null;\n\n  return (\n    <Draggable draggableId={String(deal.id)} index={index}>\n      {(provided, snapshot) => (\n        <DealCardContent provided={provided} snapshot={snapshot} deal={deal} />\n      )}\n    </Draggable>\n  );\n};\n\nexport const DealCardContent = ({\n  provided,\n  snapshot,\n  deal,\n}: {\n  provided?: any;\n  snapshot?: any;\n  deal: Deal;\n}) => {\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const refresh = useRefresh();\n  const notify = useNotify();\n  const { leadStages } = useConfigurationContext();\n  \n  // Fetch the lead (contact) associated with this deal\n  const { data: lead } = useGetOne<Contact>(\n    \"contacts\",\n    { id: deal.lead_id },\n    { enabled: !!deal.lead_id },\n  );\n\n  const handleClick = () => {\n    redirect(`/lead-journey/${deal.id}/show`, undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  const handleMoveTo = (stageValue: string) => {\n    updateDealStage(\n      deal,\n      { stage: stageValue, index: undefined },\n      dataProvider\n    )\n    .then(() => {\n        notify(\"Deal moved\", { type: \"success\" });\n        refresh();\n    })\n    .catch((error) => {\n        notify(`Error moving deal: ${error.message}`, { type: \"error\" });\n    });\n  };\n\n  const handleArchive = () => {\n    dataProvider.update(\"lead-journey\", {\n        id: deal.id,\n        data: { archived_at: new Date().toISOString() },\n        previousData: deal\n    })\n    .then(() => {\n        notify(\"Deal archived\", { type: \"success\" });\n        refresh();\n    })\n    .catch((error) => {\n        notify(`Error archiving deal: ${error.message}`, { type: \"error\" });\n    });\n  };\n\n  const handleEditContact = () => {\n     if (deal.lead_id) {\n         redirect(`/contacts/${deal.lead_id}`);\n     }\n  };\n\n  if (!lead && !deal.lead_id) {\n    // Fallback if no lead is associated\n    return (\n      <div\n        className=\"cursor-pointer\"\n        {...provided?.draggableProps}\n        {...provided?.dragHandleProps}\n        ref={provided?.innerRef}\n        onClick={handleClick}\n      >\n        <ContextMenu>\n          <ContextMenuTrigger>\n            <Card\n              className={`py-4 transition-all duration-200 ${\n                snapshot?.isDragging\n                  ? \"opacity-90 transform rotate-1 shadow-lg\"\n                  : \"shadow-sm hover:shadow-md\"\n              }`}\n            >\n              <CardContent className=\"px-4 flex\">\n                <div>\n                  <p className=\"text-sm font-medium mb-2\">\n                    {deal.first_name || deal.last_name\n                      ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                      : deal.name || \"New Lead\"}\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </ContextMenuTrigger>\n          <ContextMenuContent>\n            <ContextMenuSub>\n              <ContextMenuSubTrigger>Move to</ContextMenuSubTrigger>\n              <ContextMenuSubContent>\n                {leadStages\n                  .filter((stage) => stage.value !== deal.stage)\n                  .map((stage) => (\n                    <ContextMenuItem\n                      key={stage.value}\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        handleMoveTo(stage.value);\n                      }}\n                    >\n                      {stage.label}\n                    </ContextMenuItem>\n                  ))}\n              </ContextMenuSubContent>\n            </ContextMenuSub>\n            <ContextMenuItem onClick={(e) => {\n                e.stopPropagation();\n                handleArchive();\n            }}>\n              Archive\n            </ContextMenuItem>\n          </ContextMenuContent>\n        </ContextMenu>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      className=\"cursor-pointer\"\n      {...provided?.draggableProps}\n      {...provided?.dragHandleProps}\n      ref={provided?.innerRef}\n      onClick={handleClick}\n    >\n      <ContextMenu>\n        <ContextMenuTrigger>\n          <Card\n            className={`py-4 transition-all duration-200 ${\n              snapshot?.isDragging\n                ? \"opacity-90 transform rotate-1 shadow-lg\"\n                : \"shadow-sm hover:shadow-md\"\n            }`}\n          >\n            <CardContent className=\"px-4 flex\">\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-sm font-medium mb-1\">\n                  {lead\n                    ? `${lead.first_name ?? \"\"} ${lead.last_name ?? \"\"}`.trim() || \"New Lead\"\n                    : deal.first_name || deal.last_name\n                    ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                    : deal.name || \"New Lead\"}\n                </p>\n                {lead?.description && (\n                  <p className=\"text-xs text-muted-foreground line-clamp-2\">\n                    {lead.description}\n                  </p>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </ContextMenuTrigger>\n        <ContextMenuContent>\n          <ContextMenuSub>\n            <ContextMenuSubTrigger>Move to</ContextMenuSubTrigger>\n            <ContextMenuSubContent>\n              {leadStages\n                .filter((stage) => stage.value !== deal.stage)\n                .map((stage) => (\n                  <ContextMenuItem\n                    key={stage.value}\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      handleMoveTo(stage.value);\n                    }}\n                  >\n                    {stage.label}\n                  </ContextMenuItem>\n                ))}\n            </ContextMenuSubContent>\n          </ContextMenuSub>\n          <ContextMenuItem onClick={(e) => {\n              e.stopPropagation();\n              handleArchive();\n          }}>\n            Archive\n          </ContextMenuItem>\n          {deal.lead_id && (\n             <ContextMenuItem onClick={(e) => {\n                e.stopPropagation();\n                handleEditContact();\n             }}>\n                Edit Contact\n             </ContextMenuItem>\n          )}\n        </ContextMenuContent>\n      </ContextMenu>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/DealArchivedList.tsx",
      "content": "/* eslint-disable react-refresh/only-export-components */\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { useEffect, useState, useMemo } from \"react\";\nimport { useGetOne, useRedirect } from \"ra-core\";\nimport { Dialog, DialogContent, DialogDescription, DialogTitle } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Search } from \"lucide-react\";\n\nimport type { Deal, Contact } from \"../types\";\nimport { formatCrmDate } from \"../misc/timezone\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { findDealLabel } from \"./deal\";\n\ninterface DealArchivedListProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport const DealArchivedList = ({ open, onOpenChange }: DealArchivedListProps) => {\n  const { identity } = useGetIdentity();\n  const { leadStages } = useConfigurationContext();\n  const {\n    data: archivedLists,\n    total,\n    isPending,\n  } = useGetList(\"lead-journey\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"archived_at\", order: \"DESC\" },\n    filter: { \"archived_at@not.is\": null },\n  });\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  // Fetch all leads for search - must be called before any conditional returns\n  const { data: allLeads } = useGetList(\"contacts\", {\n    pagination: { page: 1, perPage: 10000 },\n    sort: { field: \"id\", order: \"ASC\" },\n  }, { enabled: !!archivedLists && archivedLists.length > 0 });\n\n  useEffect(() => {\n    if (!isPending && total === 0) {\n      onOpenChange(false);\n    }\n  }, [isPending, total, onOpenChange]);\n\n  useEffect(() => {\n    // We don't want to close the dialog just because the list updates\n  }, [archivedLists]);\n\n  // Create a map of lead_id to lead name for quick lookup - must be called before conditional return\n  const leadNameMap = useMemo(() => {\n    if (!allLeads) return new Map();\n    const map = new Map();\n    allLeads.forEach((lead: any) => {\n      const fullName = `${lead.first_name || \"\"} ${lead.last_name || \"\"}`.trim();\n      if (fullName) {\n        map.set(lead.id, fullName);\n      }\n    });\n    return map;\n  }, [allLeads]);\n\n  // Filter deals by search query - must be called before conditional return\n  const filteredDeals = useMemo(() => {\n    if (!archivedLists || !searchQuery.trim()) return archivedLists || [];\n    \n    const query = searchQuery.toLowerCase();\n    return archivedLists.filter((deal: Deal) => {\n      const dealFirstName = deal.first_name?.toLowerCase() || \"\";\n      const dealLastName = deal.last_name?.toLowerCase() || \"\";\n      const dealName = deal.name?.toLowerCase() || \"\";\n      const dealFullName = `${dealFirstName} ${dealLastName}`.trim().toLowerCase();\n      const leadName = deal.lead_id ? leadNameMap.get(deal.lead_id)?.toLowerCase() : \"\";\n      return dealFullName.includes(query) || dealName.includes(query) || leadName?.includes(query);\n    });\n  }, [archivedLists, searchQuery, leadNameMap]);\n\n  // Group filtered archived lists by date - must be called before conditional return\n  const archivedListsByDate: { [date: string]: Deal[] } = useMemo(() => {\n    if (!filteredDeals || filteredDeals.length === 0) return {};\n    return filteredDeals.reduce(\n      (acc, deal) => {\n        const date = new Date(deal.archived_at).toDateString();\n        if (!acc[date]) {\n          acc[date] = [];\n        }\n        acc[date].push(deal);\n        return acc;\n      },\n      {} as { [date: string]: Deal[] },\n    );\n  }, [filteredDeals]);\n\n  if (!identity || isPending || !total || !archivedLists) return null;\n\n  return (\n    <div className=\"w-full flex flex-row items-center justify-center\">\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n          <DialogTitle>Archived Lead Journey</DialogTitle>\n          <DialogDescription>\n            View and search through archived lead journeys\n          </DialogDescription>\n          <div className=\"flex flex-col gap-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4\" />\n              <Input\n                type=\"text\"\n                placeholder=\"Search archived leads...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n              />\n            </div>\n            {Object.keys(archivedListsByDate).length === 0 ? (\n              <div className=\"text-center text-muted-foreground py-8\">\n                No archived leads found\n              </div>\n            ) : (\n              <div className=\"flex flex-col gap-8\">\n                {Object.entries(archivedListsByDate).map(([date, deals]) => (\n                  <div key={date} className=\"flex flex-col gap-4\">\n                    <h4 className=\"font-bold\">{getRelativeTimeString(date)}</h4>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8\">\n                      {deals.map((deal: Deal) => (\n                        <div key={deal.id}>\n                          <ArchivedDealCard deal={deal} leadStages={leadStages} />\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n};\n\nexport function getRelativeTimeString(dateString: string): string {\n  const date = new Date(dateString);\n  date.setHours(0, 0, 0, 0);\n\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const diff = date.getTime() - today.getTime();\n  const unitDiff = Math.round(diff / (1000 * 60 * 60 * 24));\n\n  // Check if the date is more than one week old\n  if (Math.abs(unitDiff) > 7) {\n    return new Intl.DateTimeFormat(\"en-GB\", {\n      day: \"2-digit\",\n      month: \"2-digit\",\n      year: \"numeric\",\n    }).format(date);\n  }\n\n  // Intl.RelativeTimeFormat for dates within the last week\n  const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: \"auto\" });\n  return ucFirst(rtf.format(unitDiff, \"day\"));\n}\n\nfunction ucFirst(str: string): string {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nconst ArchivedDealCard = ({ deal, leadStages }: { deal: Deal; leadStages: any[] }) => {\n  const redirect = useRedirect();\n  const stageLabel = deal.stage === \"converted\" \n    ? \"Client\" \n    : findDealLabel(leadStages, deal.stage) || deal.stage;\n  \n  const archivedDate = deal.archived_at ? formatCrmDate(deal.archived_at) : null;\n  \n  // Fetch the lead (contact) associated with this deal\n  const { data: lead } = useGetOne<Contact>(\n    \"contacts\",\n    { id: deal.lead_id },\n    { enabled: !!deal.lead_id },\n  );\n\n  const handleClick = () => {\n    redirect(`/lead-journey/${deal.id}/show`, undefined, undefined, undefined, {\n      _scrollToTop: false,\n    });\n  };\n\n  return (\n    <div\n      className=\"cursor-pointer\"\n      onClick={handleClick}\n    >\n      <Card className=\"py-4 transition-all duration-200 shadow-sm hover:shadow-md\">\n        <CardContent className=\"px-4 flex\">\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-medium mb-1\">\n              {lead\n                ? `${lead.first_name} ${lead.last_name || \"\"}`.trim()\n                : deal.first_name || deal.last_name\n                ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                : deal.name || \"New Lead\"}\n            </p>\n            {lead?.description && (\n              <p className=\"text-xs text-muted-foreground line-clamp-2\">\n                {lead.description}\n              </p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/ContactList.tsx",
      "content": "import { useListContext } from \"ra-core\";\nimport { Link as RouterLink } from \"react-router\";\n\nexport const ContactList = () => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error) return <div className=\"h-8\" />;\n  return (\n    <div className=\"flex flex-row flex-wrap gap-4 mt-4\">\n      {data.map((contact) => (\n        <div className=\"flex flex-row gap-4 items-center\" key={contact.id}>\n          <div className=\"flex flex-col\">\n            <RouterLink\n              to={`/contacts/${contact.id}/show`}\n              className=\"text-sm hover:underline\"\n            >\n              {contact.first_name} {contact.last_name}\n            </RouterLink>\n            <span className=\"text-xs text-muted-foreground\">\n              {contact.title}\n              {contact.title && contact.company_name && \" at \"}\n              {contact.company_name}\n            </span>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/deals/ContactCreateDialog.tsx",
      "content": "import {\n  CreateBase,\n  Form,\n  useDataProvider,\n  useGetIdentity,\n  useRedirect,\n  useRefresh,\n} from \"ra-core\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\n\nimport type { Contact } from \"../types\";\nimport { LeadInputs } from \"../contacts/LeadInputs\";\nimport { createLeadJourneyDealForContact } from \"./createLeadJourneyDeal\";\n\nexport const ContactCreateDialog = ({ \n  open, \n  onOpenChange \n}: { \n  open: boolean;\n  onOpenChange?: (open: boolean) => void;\n}) => {\n  const { identity } = useGetIdentity();\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const refresh = useRefresh();\n\n  const handleClose = () => {\n    if (onOpenChange) {\n      onOpenChange(false);\n    } else {\n      redirect(\"/lead-journey\");\n    }\n  };\n\n  const handleSuccess = async (data: Contact) => {\n    try {\n      await createLeadJourneyDealForContact(dataProvider, data, identity?.id);\n\n      // Force refresh of the lead journey list\n      refresh();\n      \n      // Small delay to ensure the backend has processed the creation\n      setTimeout(() => {\n        refresh();\n        handleClose();\n      }, 100);\n    } catch (error) {\n      console.error(\"Error creating lead-journey entry:\", error);\n      // Still refresh and close even if lead-journey creation fails\n      refresh();\n      handleClose();\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={(open) => {\n      if (!open) {\n        handleClose();\n      } else if (onOpenChange) {\n        onOpenChange(open);\n      }\n    }}>\n      <DialogContent className=\"lg:max-w-4xl overflow-y-auto max-h-9/10 top-1/20 translate-y-0\">\n        <DialogTitle className=\"sr-only\">Create New Contact</DialogTitle>\n        <DialogDescription className=\"sr-only\">Create a new contact and lead</DialogDescription>\n        <CreateBase\n          resource=\"contacts\"\n          redirect={false}\n          transform={(data: Contact) => ({\n            ...data,\n            first_seen: new Date().toISOString(),\n            last_seen: new Date().toISOString(),\n            tags: [],\n            services_interested: data.services_interested || [],\n          })}\n          mutationOptions={{\n            onSuccess: handleSuccess,\n          }}\n        >\n          <Form\n            defaultValues={{\n              sales_id: identity?.id,\n              phone_has_whatsapp: false,\n              services_interested: [],\n            }}\n          >\n            <Card>\n              <CardContent>\n                <LeadInputs />\n                <FormToolbar>\n                  <SaveButton />\n                </FormToolbar>\n              </CardContent>\n            </Card>\n          </Form>\n        </CreateBase>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/Welcome.tsx",
      "content": "import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nexport const Welcome = () => (\n  <Card>\n    <CardHeader className=\"px-4\">\n      <CardTitle>Your CRM Starter Kit</CardTitle>\n    </CardHeader>\n    <CardContent className=\"px-4\">\n      <p className=\"text-sm mb-4\">\n        <b>BestDOC CRM</b> helps you manage leads, clients, tasks, and notes.\n      </p>\n      <p className=\"text-sm mb-4\">\n        This demo runs on a mock API, so you can explore and modify the data. It\n        resets on reload. The full version uses Supabase for the backend.\n      </p>\n      <p className=\"text-sm text-muted-foreground\">\n        Tip: connect Supabase to persist data across reloads.\n      </p>\n    </CardContent>\n  </Card>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/TasksListFilter.tsx",
      "content": "import {\n  ListContextProvider,\n  ResourceContextProvider,\n  useGetIdentity,\n  useGetList,\n  useList,\n} from \"ra-core\";\n\nimport { TasksIterator } from \"../tasks/TasksIterator\";\n\nexport const TasksListFilter = ({\n  title,\n  filter,\n}: {\n  title: string;\n  filter: any;\n}) => {\n  const { identity } = useGetIdentity();\n\n  const {\n    data: tasks,\n    total,\n    isPending,\n  } = useGetList(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 100 },\n      sort: { field: \"due_date\", order: \"ASC\" },\n      filter: {\n        ...filter,\n        sales_id: identity?.id,\n      },\n    },\n    { enabled: !!identity },\n  );\n\n  const listContext = useList({\n    data: tasks,\n    isPending,\n    resource: \"tasks\",\n    perPage: 5,\n  });\n\n  if (isPending || !tasks || !total) return null;\n\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium mb-2\">\n        {title}\n      </p>\n      <ResourceContextProvider value=\"tasks\">\n        <ListContextProvider value={listContext}>\n          <TasksIterator showContact />\n        </ListContextProvider>\n      </ResourceContextProvider>\n      {total > listContext.perPage && (\n        <div className=\"flex justify-center\">\n          <a\n            href=\"#\"\n            onClick={(e) => {\n              listContext.setPerPage(listContext.perPage + 10);\n              e.preventDefault();\n            }}\n            className=\"text-sm underline hover:no-underline\"\n          >\n            Load more\n          </a>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/TasksListEmpty.tsx",
      "content": "import { useGetIdentity, useGetList } from \"ra-core\";\n\nexport const TasksListEmpty = () => {\n  const { identity } = useGetIdentity();\n\n  const { total } = useGetList(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 1 },\n      filter: {\n        sales_id: identity?.id,\n      },\n    },\n    { enabled: !!identity },\n  );\n\n  if (total) return null;\n\n  return (\n    <p className=\"text-sm\">Tasks added to your contacts will appear here.</p>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/TasksList.tsx",
      "content": "import { CheckSquare } from \"lucide-react\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { AddTask } from \"../tasks/AddTask\";\nimport { TasksListEmpty } from \"./TasksListEmpty\";\nimport { TasksListFilter } from \"./TasksListFilter\";\nimport {\n  crmAddDays,\n  crmDayOfWeek,\n  crmEndOfDay,\n  crmEndOfWeek,\n  crmStartOfDay,\n} from \"../misc/timezone\";\n\nconst startOfTodayDate = crmStartOfDay();\nconst endOfTodayDate = crmEndOfDay();\nconst endOfTomorrowDate = crmEndOfDay(crmAddDays(new Date(), 1));\nconst endOfWeekDate = crmEndOfWeek();\n\nconst todayDayOfWeek = crmDayOfWeek();\nconst isBeforeFriday =\n  todayDayOfWeek !== undefined ? todayDayOfWeek < 5 : new Date().getUTCDay() < 5; // Friday is 5\nconst startOfTodayDateISO = (startOfTodayDate ?? new Date()).toISOString();\nconst endOfTodayDateISO = (endOfTodayDate ?? new Date()).toISOString();\nconst endOfTomorrowDateISO = (endOfTomorrowDate ?? new Date()).toISOString();\nconst endOfWeekDateISO = (endOfWeekDate ?? new Date()).toISOString();\n\nconst taskFilters = {\n  overdue: { \"done_date@is\": null, \"due_date@lt\": startOfTodayDateISO },\n  today: {\n    \"done_date@is\": null,\n    \"due_date@gte\": startOfTodayDateISO,\n    \"due_date@lte\": endOfTodayDateISO,\n  },\n  tomorrow: {\n    \"done_date@is\": null,\n    \"due_date@gt\": endOfTodayDateISO,\n    \"due_date@lt\": endOfTomorrowDateISO,\n  },\n  thisWeek: {\n    \"done_date@is\": null,\n    \"due_date@gte\": endOfTomorrowDateISO,\n    \"due_date@lte\": endOfWeekDateISO,\n  },\n  later: { \"done_date@is\": null, \"due_date@gt\": endOfWeekDateISO },\n};\n\nexport const TasksList = () => {\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <div className=\"flex items-center\">\n        <div className=\"mr-3 flex\">\n          <CheckSquare className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground flex-1\">\n          Upcoming Tasks\n        </h2>\n        <AddTask display=\"icon\" selectContact />\n      </div>\n      <Card className=\"p-4 mb-2\">\n        <div className=\"flex flex-col gap-4\">\n          <TasksListEmpty />\n          <TasksListFilter title=\"Overdue\" filter={taskFilters.overdue} />\n          <TasksListFilter title=\"Today\" filter={taskFilters.today} />\n          <TasksListFilter title=\"Tomorrow\" filter={taskFilters.tomorrow} />\n          {isBeforeFriday && (\n            <TasksListFilter title=\"This week\" filter={taskFilters.thisWeek} />\n          )}\n          <TasksListFilter title=\"Later\" filter={taskFilters.later} />\n        </div>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/RecentLeads.tsx",
      "content": "import { Plus, Users } from \"lucide-react\";\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\nimport { SimpleList } from \"../simple-list/SimpleList\";\nimport type { Contact } from \"../types\";\n\nimport { RelativeDate } from \"../misc/RelativeDate\";\n\nexport const RecentLeads = () => {\n  const { identity } = useGetIdentity();\n  const {\n    data: contactData,\n    total: contactTotal,\n    isPending: contactsLoading,\n  } = useGetList<Contact>(\n    \"contacts\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"last_seen\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <div className=\"flex items-center\">\n        <div className=\"mr-3 flex\">\n          <Users className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          Recent Leads\n        </h2>\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"ml-auto text-muted-foreground\"\n                asChild\n              >\n                <Link to=\"/contacts/create\">\n                  <Plus className=\"w-4 h-4 text-primary\" />\n                </Link>\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>Create contact</TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      </div>\n      <Card className=\"py-0\">\n        <SimpleList<Contact>\n          linkType=\"show\"\n          data={contactData}\n          total={contactTotal}\n          isPending={contactsLoading}\n          resource=\"contacts\"\n          className=\"[&>li:first-child>a]:rounded-t-xl [&>li:last-child>a]:rounded-b-xl\"\n          primaryText={(contact) =>\n            `${contact.first_name} ${contact.last_name || \"\"}`\n          }\n          secondaryText={(contact) => (\n            <>\n              {contact.title ? `${contact.title} at ` : \"\"}\n              {contact.company_name}\n            </>\n          )}\n          tertiaryText={(contact) => (\n            <RelativeDate date={contact.last_seen} />\n          )}\n          empty={\n            <div className=\"p-4\">\n              <p className=\"text-sm\">\n                No recent leads found.\n              </p>\n            </div>\n          }\n        />\n      </Card>\n    </div>\n  );\n};\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/LeadStatusChart.tsx",
      "content": "import { ResponsiveBar } from \"@nivo/bar\";\nimport { Users } from \"lucide-react\";\nimport { useGetList, useRedirect } from \"ra-core\";\nimport { memo, useMemo } from \"react\";\nimport { Card, CardHeader, CardTitle, CardContent, CardDescription } from \"@/components/ui/card\";\n\nimport type { Deal } from \"../types\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\n\n// Define a color map for stages to ensure consistency\nconst STAGE_COLORS: Record<string, string> = {\n  new: \"#3b82f6\",       // Blue 500\n  contacted: \"#6366f1\", // Indigo 500\n  quoted: \"#8b5cf6\",    // Violet 500\n  qualified: \"#06b6d4\", // Cyan 500\n  \"not-qualified\": \"#94a3b8\", // Slate 400\n  converted: \"#22c55e\", // Green 500\n};\n\nexport const LeadStatusChart = memo(() => {\n  const { leadStages } = useConfigurationContext();\n  const redirect = useRedirect();\n  \n  const { data, isPending } = useGetList<Deal>(\"lead-journey\", {\n    pagination: { perPage: 1000, page: 1 },\n    sort: {\n      field: \"created_at\",\n      order: \"ASC\",\n    },\n  });\n\n  const chartData = useMemo(() => {\n    if (!data || data.length === 0) return [];\n    \n    // Count leads by stage\n    const stageCounts = leadStages.reduce((acc, stage) => {\n      acc[stage.value] = 0;\n      return acc;\n    }, {} as Record<string, number>);\n\n    data.forEach((deal) => {\n      if (stageCounts.hasOwnProperty(deal.stage)) {\n        stageCounts[deal.stage] = (stageCounts[deal.stage] || 0) + 1;\n      }\n    });\n\n    // Convert to chart format\n    return leadStages.map((stage) => ({\n      id: stage.value,\n      stage: stage.label,\n      value: stageCounts[stage.value] || 0,\n      color: STAGE_COLORS[stage.value] || \"#cbd5e1\",\n    }));\n  }, [data, leadStages]);\n\n  const handleBarClick = (node: any) => {\n    // Navigate to the list view filtered by the clicked stage\n    const filter = JSON.stringify({ stage: node.data.id });\n    redirect(`/lead-journey?filter=${encodeURIComponent(filter)}`);\n  };\n\n  if (isPending) return null;\n  if (!chartData || chartData.length === 0) return null;\n\n  return (\n    <Card className=\"col-span-1 shadow-sm hover:shadow-md transition-shadow duration-200\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center space-x-2\">\n          <div className=\"p-2 bg-primary/10 rounded-full\">\n            <Users className=\"w-5 h-5 text-primary\" />\n          </div>\n          <div>\n            <CardTitle>Lead Journey Overview</CardTitle>\n            <CardDescription>\n              Distribution of leads across pipeline stages\n            </CardDescription>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"h-[400px] w-full\">\n          <ResponsiveBar\n            data={chartData}\n            keys={[\"value\"]}\n            indexBy=\"stage\"\n            margin={{ top: 20, right: 30, bottom: 60, left: 60 }}\n            padding={0.4}\n            valueScale={{ type: \"linear\" }}\n            indexScale={{ type: \"band\", round: true }}\n            colors={({ data }: any) => data.color}\n            borderRadius={6}\n            borderColor={{\n              from: \"color\",\n              modifiers: [[\"darker\", 1.6]],\n            }}\n            axisTop={null}\n            axisRight={null}\n            axisBottom={{\n              tickSize: 0,\n              tickPadding: 16,\n              tickRotation: -45,\n              legend: \"\",\n              legendPosition: \"middle\",\n              legendOffset: 32,\n            }}\n            axisLeft={{\n              tickSize: 0,\n              tickPadding: 16,\n              tickRotation: 0,\n              legend: \"\",\n              legendPosition: \"middle\",\n              legendOffset: -40,\n              tickValues: 5,\n            }}\n            enableLabel={true}\n            labelSkipWidth={12}\n            labelSkipHeight={12}\n            labelTextColor=\"#ffffff\"\n            role=\"application\"\n            ariaLabel=\"Lead Status Distribution Chart\"\n            barAriaLabel={(e) =>\n              `${e.id}: ${e.formattedValue} in stage: ${e.indexValue}`\n            }\n            onClick={handleBarClick}\n            cursor=\"pointer\"\n            theme={{\n              axis: {\n                ticks: {\n                  text: {\n                    fill: \"var(--muted-foreground)\",\n                    fontSize: 12,\n                    fontFamily: \"inherit\",\n                  },\n                },\n              },\n              grid: {\n                line: {\n                  stroke: \"var(--border)\",\n                  strokeWidth: 1,\n                  strokeDasharray: \"4 4\",\n                },\n              },\n              tooltip: {\n                container: {\n                  background: \"var(--popover)\",\n                  color: \"var(--popover-foreground)\",\n                  fontSize: 12,\n                  borderRadius: \"6px\",\n                  boxShadow: \"0 4px 6px -1px rgb(0 0 0 / 0.1)\",\n                  padding: \"8px 12px\",\n                  border: \"1px solid var(--border)\",\n                },\n              },\n            }}\n            tooltip={({ id, value, indexValue, color }) => (\n              <div className=\"flex flex-col gap-1\">\n                <div className=\"flex items-center gap-2\">\n                  <div\n                    className=\"w-3 h-3 rounded-full\"\n                    style={{ backgroundColor: color }}\n                  />\n                  <span className=\"font-semibold text-sm\">{indexValue}</span>\n                </div>\n                <div className=\"text-xs text-muted-foreground pl-5\">\n                  <span className=\"font-medium text-foreground\">{value}</span>{\" \"}\n                  leads\n                </div>\n              </div>\n            )}\n            animate={true}\n            motionConfig=\"gentle\"\n          />\n        </div>\n      </CardContent>\n    </Card>\n  );\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/LatestNotes.tsx",
      "content": "import { formatDistance } from \"date-fns\";\nimport { FileText, CheckSquare, ArrowRightLeft, Receipt } from \"lucide-react\";\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport type { Contact, ContactNote, Quote, Task, Deal } from \"../types\";\n\nexport const LatestNotes = () => {\n  const { identity } = useGetIdentity();\n  const { data: contactNotesData, isPending: contactNotesLoading } = useGetList(\n    \"contactNotes\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  const { data: dealNotesData, isPending: dealNotesLoading } = useGetList(\n    \"dealNotes\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"date\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  const { data: quotesData, isPending: quotesLoading } = useGetList<Quote>(\n    \"quotes\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"updated_at\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  const { data: tasksData, isPending: tasksLoading } = useGetList<Task>(\n    \"tasks\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"due_date\", order: \"DESC\" },\n      filter: identity?.id ? { sales_id: identity.id } : {},\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n  const { data: dealsData, isPending: dealsLoading } = useGetList<Deal>(\n    \"lead-journey\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"updated_at\", order: \"DESC\" },\n      filter: { sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n\n  if (\n    contactNotesLoading ||\n    dealNotesLoading ||\n    quotesLoading ||\n    tasksLoading ||\n    dealsLoading\n  ) {\n    return null;\n  }\n\n  // TypeScript guards\n  if (\n    !contactNotesData ||\n    !dealNotesData ||\n    !quotesData ||\n    !tasksData ||\n    !dealsData\n  ) {\n    return null;\n  }\n\n  // Combine all activities\n  const allActivities = ([] as any[])\n    .concat(\n      // Notes\n      contactNotesData.map((note) => ({\n        ...note,\n        type: \"contactNote\",\n        activityDate: note.date,\n      })),\n      dealNotesData.map((note) => ({\n        ...note,\n        type: \"dealNote\",\n        activityDate: note.date,\n      })),\n      // Quotes - use updated_at if available, otherwise created_at\n      quotesData.map((quote) => ({\n        ...quote,\n        type: \"quote\",\n        activityDate: quote.updated_at || quote.created_at,\n      })),\n      // Tasks - use done_date if completed, otherwise due_date for created tasks\n      tasksData.map((task) => ({\n        ...task,\n        type: task.done_date ? \"taskCompleted\" : \"taskCreated\",\n        activityDate: task.done_date || task.due_date,\n      })),\n      // Status changes - deals that were updated (stage changes)\n      dealsData\n        .filter((deal) => deal.updated_at && deal.updated_at !== deal.created_at)\n        .map((deal) => ({\n          ...deal,\n          type: \"statusChange\",\n          activityDate: deal.updated_at,\n        })),\n    )\n    .sort(\n      (a, b) =>\n        new Date(b.activityDate).valueOf() - new Date(a.activityDate).valueOf(),\n    )\n    .slice(0, 10);\n\n  return (\n    <div>\n      <div className=\"flex items-center mb-4\">\n        <div className=\"ml-8 mr-8 flex\">\n          <FileText className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          My Latest Activity\n        </h2>\n      </div>\n      <Card>\n        <CardContent>\n          {allActivities.map((activity) => (\n            <div\n              id={`${activity.type}_${activity.id}`}\n              key={`${activity.type}_${activity.id}`}\n              className=\"mb-8\"\n            >\n              <div className=\"text-sm text-muted-foreground\">\n                {activity.type === \"contactNote\" && (\n                  <>\n                    <FileText className=\"inline w-4 h-4 mr-1\" />\n                    Note on <Contact record={activity} />, added{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"dealNote\" && (\n                  <>\n                    <FileText className=\"inline w-4 h-4 mr-1\" />\n                    Note on <Deal record={activity} />, added{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"quote\" && (\n                  <>\n                    <Receipt className=\"inline w-4 h-4 mr-1\" />\n                    Quote for <Contact record={activity} />{\" \"}\n                    {activity.status && `(${activity.status})`}, updated{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"taskCompleted\" && (\n                  <>\n                    <CheckSquare className=\"inline w-4 h-4 mr-1\" />\n                    Task completed for <Contact record={activity} />, done{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"taskCreated\" && (\n                  <>\n                    <CheckSquare className=\"inline w-4 h-4 mr-1\" />\n                    Task created for <Contact record={activity} />, due{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n                {activity.type === \"statusChange\" && (\n                  <>\n                    <ArrowRightLeft className=\"inline w-4 h-4 mr-1\" />\n                    Status changed for <Deal record={activity} /> to{\" \"}\n                    <span className=\"font-medium\">{activity.stage}</span>,{\" \"}\n                    {formatDistance(activity.activityDate, new Date(), {\n                      addSuffix: true,\n                    })}\n                  </>\n                )}\n              </div>\n              <div>\n                {(activity.type === \"contactNote\" ||\n                  activity.type === \"dealNote\") && (\n                  <p className=\"text-sm line-clamp-3 overflow-hidden\">\n                    {activity.text}\n                  </p>\n                )}\n                {activity.type === \"quote\" && (\n                  <p className=\"text-sm line-clamp-3 overflow-hidden\">\n                    {activity.description || `Amount: Ø¯.Ø¥${activity.amount}`}\n                  </p>\n                )}\n                {(activity.type === \"taskCompleted\" ||\n                  activity.type === \"taskCreated\") && (\n                  <p className=\"text-sm line-clamp-3 overflow-hidden\">\n                    {activity.text}\n                  </p>\n                )}\n                {activity.type === \"statusChange\" && (\n                  <p className=\"text-sm line-clamp-3 overflow-hidden\">\n                    {activity.description || activity.name}\n                  </p>\n                )}\n              </div>\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nconst Deal = ({ record }: { record: any }) => (\n  <>\n    Deal{\" \"}\n    <ReferenceField\n      record={record}\n      source={record.deal_id ? \"deal_id\" : \"id\"}\n      reference=\"lead-journey\"\n      link=\"show\"\n    >\n      <TextField source=\"name\" />\n    </ReferenceField>\n  </>\n);\n\nconst Contact = ({ record }: { record: any }) => (\n  <>\n    Contact{\" \"}\n    <ReferenceField<ContactNote | Quote | Task, Contact>\n      record={record}\n      source=\"contact_id\"\n      reference=\"contacts\"\n      link=\"show\"\n    />\n  </>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DealsPipeline.tsx",
      "content": "import { DollarSign } from \"lucide-react\";\nimport { useGetIdentity, useGetList } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { SimpleList } from \"../simple-list/SimpleList\";\nimport { findDealLabel } from \"../deals/deal\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Deal } from \"../types\";\n\n/**\n * This component displays the deals pipeline for the current user.\n * It's currently not used in the application but can be added to the dashboard.\n */\nexport const DealsPipeline = () => {\n  const { identity } = useGetIdentity();\n  const { dealStages, dealPipelineStatuses } = useConfigurationContext();\n  const { data, total, isPending } = useGetList<Deal>(\n    \"lead-journey\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"last_seen\", order: \"DESC\" },\n      filter: { \"stage@neq\": \"lost\", sales_id: identity?.id },\n    },\n    { enabled: Number.isInteger(identity?.id) },\n  );\n\n  const getOrderedDeals = (data?: Deal[]): Deal[] | undefined => {\n    if (!data) {\n      return;\n    }\n    const deals: Deal[] = [];\n    dealStages\n      .filter((stage) => !dealPipelineStatuses.includes(stage.value))\n      .forEach((stage) =>\n        data\n          .filter((deal) => deal.stage === stage.value)\n          .forEach((deal) => deals.push(deal)),\n      );\n    return deals;\n  };\n\n  return (\n    <>\n      <div className=\"flex items-center mb-4\">\n        <div className=\"ml-8 mr-8 flex\">\n          <DollarSign className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <Link\n          className=\"text-xl font-semibold text-muted-foreground hover:underline\"\n          to=\"/lead-journey\"\n        >\n          Deals Pipeline\n        </Link>\n      </div>\n      <Card>\n        <SimpleList<Deal>\n          resource=\"lead-journey\"\n          linkType=\"show\"\n          data={getOrderedDeals(data)}\n          total={total}\n          isPending={isPending}\n          primaryText={(deal) => deal.name}\n          secondaryText={(deal) =>\n            `${deal.amount.toLocaleString(\"en-US\", {\n              notation: \"compact\",\n              style: \"currency\",\n              currency: \"AED\",\n              currencyDisplay: \"narrowSymbol\",\n              minimumSignificantDigits: 3,\n            })} , ${findDealLabel(dealStages, deal.stage)}`\n          }\n        />\n      </Card>\n    </>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DealsChart.tsx",
      "content": "import { ResponsiveBar } from \"@nivo/bar\";\nimport { format, startOfMonth } from \"date-fns\";\nimport { DollarSign } from \"lucide-react\";\nimport { useGetList } from \"ra-core\";\nimport { memo, useMemo } from \"react\";\n\nimport type { Deal } from \"../types\";\n\nconst multiplier = {\n  opportunity: 0.2,\n  \"proposal-sent\": 0.5,\n  \"in-negociation\": 0.8,\n  delayed: 0.3,\n};\n\nconst threeMonthsAgo = new Date(\n  new Date().setMonth(new Date().getMonth() - 6),\n).toISOString();\n\nconst DEFAULT_LOCALE = \"en-US\";\nconst CURRENCY = \"AED\";\n\nexport const DealsChart = memo(() => {\n  const acceptedLanguages = navigator\n    ? navigator.languages || [navigator.language]\n    : [DEFAULT_LOCALE];\n\n  const { data, isPending } = useGetList<Deal>(\"deals\", {\n    pagination: { perPage: 100, page: 1 },\n    sort: {\n      field: \"created_at\",\n      order: \"ASC\",\n    },\n    filter: {\n      \"created_at@gte\": threeMonthsAgo,\n    },\n  });\n  const months = useMemo(() => {\n    if (!data || data.length === 0) return [];\n    const dealsByMonth = data.reduce((acc, deal) => {\n      const month = startOfMonth(deal.created_at ?? new Date()).toISOString();\n      if (!acc[month]) {\n        acc[month] = [];\n      }\n      acc[month].push(deal);\n      return acc;\n    }, {} as any);\n\n    const amountByMonth = Object.keys(dealsByMonth).map((month) => {\n      return {\n        date: format(month, \"MMM\"),\n        won: dealsByMonth[month]\n          .filter((deal: Deal) => deal.stage === \"won\")\n          .reduce((acc: number, deal: Deal) => {\n            const amount = Number(deal.amount) || 0;\n            acc += amount;\n            return acc;\n          }, 0),\n        pending: dealsByMonth[month]\n          .filter((deal: Deal) => ![\"won\", \"lost\"].includes(deal.stage))\n          .reduce((acc: number, deal: Deal) => {\n            const amount = Number(deal.amount) || 0;\n            // @ts-expect-error - multiplier type issue\n            const multiplierValue = multiplier[deal.stage] || 0;\n            acc += amount * multiplierValue;\n            return acc;\n          }, 0),\n        lost: dealsByMonth[month]\n          .filter((deal: Deal) => deal.stage === \"lost\")\n          .reduce((acc: number, deal: Deal) => {\n            const amount = Number(deal.amount) || 0;\n            acc -= amount;\n            return acc;\n          }, 0),\n      };\n    });\n\n    return amountByMonth;\n  }, [data]);\n\n  if (isPending) return null; // FIXME return skeleton instead\n  if (!months || months.length === 0) return null;\n  \n  const range = months.reduce(\n    (acc, month) => {\n      const lost = Number(month.lost) || 0;\n      const won = Number(month.won) || 0;\n      const pending = Number(month.pending) || 0;\n      acc.min = Math.min(acc.min, lost);\n      acc.max = Math.max(acc.max, won + pending);\n      return acc;\n    },\n    { min: 0, max: 0 },\n  );\n  \n  // Ensure range values are valid numbers\n  const minValue = isNaN(range.min) ? 0 : range.min;\n  const maxValue = isNaN(range.max) ? 0 : range.max;\n  return (\n    <div className=\"flex flex-col\">\n      <div className=\"flex items-center mb-4\">\n        <div className=\"mr-3 flex\">\n          <DollarSign className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          Upcoming Deal Revenue\n        </h2>\n      </div>\n      <div className=\"h-[400px]\">\n        <ResponsiveBar\n          data={months}\n          indexBy=\"date\"\n          keys={[\"won\", \"pending\", \"lost\"]}\n          colors={[\"#61cdbb\", \"#97e3d5\", \"#e25c3b\"]}\n          margin={{ top: 30, right: 50, bottom: 30, left: 0 }}\n          padding={0.3}\n          valueScale={{\n            type: \"linear\",\n            min: minValue * 1.2,\n            max: Math.max(maxValue * 1.2, 1),\n          }}\n          indexScale={{ type: \"band\", round: true }}\n          enableGridX={true}\n          enableGridY={false}\n          enableLabel={false}\n          tooltip={({ value, indexValue }) => (\n            <div className=\"p-2 bg-secondary rounded shadow inline-flex items-center gap-1 text-secondary-foreground\">\n              <strong>{indexValue}: </strong>&nbsp;{value > 0 ? \"+\" : \"\"}\n              {value.toLocaleString(acceptedLanguages.at(0) ?? DEFAULT_LOCALE, {\n                style: \"currency\",\n                currency: CURRENCY,\n              })}\n            </div>\n          )}\n          axisTop={{\n            tickSize: 0,\n            tickPadding: 12,\n            style: {\n              ticks: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n              legend: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n            },\n          }}\n          axisBottom={{\n            legendPosition: \"middle\",\n            legendOffset: 50,\n            tickSize: 0,\n            tickPadding: 12,\n            style: {\n              ticks: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n              legend: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n            },\n          }}\n          axisLeft={null}\n          axisRight={{\n            format: (v: any) => `${Math.abs(v / 1000)}k`,\n            tickValues: 8,\n            style: {\n              ticks: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n              legend: {\n                text: {\n                  fill: \"var(--color-muted-foreground)\",\n                },\n              },\n            },\n          }}\n          markers={\n            [\n              {\n                axis: \"y\",\n                value: 0,\n                lineStyle: { strokeOpacity: 0 },\n                textStyle: { fill: \"#2ebca6\" },\n                legend: \"Won\",\n                legendPosition: \"top-left\",\n                legendOrientation: \"vertical\",\n              },\n              {\n                axis: \"y\",\n                value: 0,\n                lineStyle: {\n                  stroke: \"#f47560\",\n                  strokeWidth: 1,\n                },\n                textStyle: { fill: \"#e25c3b\" },\n                legend: \"Lost\",\n                legendPosition: \"bottom-left\",\n                legendOrientation: \"vertical\",\n              },\n            ] as any\n          }\n        />\n      </div>\n    </div>\n  );\n});\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DashboardStepper.tsx",
      "content": "import { CheckCircle, Circle } from \"lucide-react\";\nimport type { Identifier } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { ContactImportButton } from \"../contacts/ContactImportButton\";\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\n\nexport const DashboardStepper = ({\n  step,\n  contactId,\n}: {\n  step: number;\n  contactId?: Identifier;\n}) => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex justify-center items-center\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <Card className=\"w-full max-w-[600px]\">\n        <CardContent className=\"px-6\">\n          <div className=\"flex items-center justify-between mb-8\">\n            <h3 className=\"text-lg font-bold\">What's next?</h3>\n            <div className=\"w-[150px]\">\n              <Progress value={(step / 3) * 100} className=\"mb-2\" />\n              <div className=\"text-right text-sm\">{step}/3 done</div>\n            </div>\n          </div>\n          <div className=\"flex flex-col gap-12\">\n            <div className=\"flex gap-8 items-center\">\n              <CheckCircle className=\"text-green-600 w-5 h-5\" />\n              <h4 className=\"font-bold\">Install BestDOC CRM</h4>\n            </div>\n            <div className=\"flex gap-8 items-start\">\n              {step > 1 ? (\n                <CheckCircle className=\"text-green-600 w-5 h-5 mt-1\" />\n              ) : (\n                <Circle className=\"text-muted-foreground w-5 h-5 mt-1\" />\n              )}\n\n              <div className=\"flex flex-col gap-4\">\n                <h4 className=\"font-bold\">Add your first contact</h4>\n\n                <div className=\"flex gap-8\">\n                  <CreateButton label=\"New Contact\" resource=\"contacts\" />\n                  <ContactImportButton />\n                </div>\n              </div>\n            </div>\n            <div className=\"flex gap-8 items-start\">\n              <Circle className=\"text-muted-foreground w-5 h-5 mt-1\" />\n              <div className=\"flex flex-col gap-4\">\n                <h4 className=\"font-bold\">Add your first note</h4>\n                <p>Go to a contact page and add a note</p>\n                <Button asChild disabled={step < 2} className=\"w-[100px]\">\n                  <Link to={`/contacts/${contactId}/show`}>Add note</Link>\n                </Button>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/DashboardActivityLog.tsx",
      "content": "import { Clock } from \"lucide-react\";\nimport { Card } from \"@/components/ui/card\";\n\nimport { ActivityLog } from \"../activity/ActivityLog\";\n\nexport function DashboardActivityLog() {\n  return (\n    <div className=\"flex flex-col\">\n      <div className=\"flex items-center mb-2\">\n        <div className=\"mr-3 flex\">\n          <Clock className=\"text-muted-foreground w-6 h-6\" />\n        </div>\n        <h2 className=\"text-xl font-semibold text-muted-foreground\">\n          Latest Activity\n        </h2>\n      </div>\n      <Card className=\"mb-2 p-6\">\n        <ActivityLog pageSize={10} />\n      </Card>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/dashboard/Dashboard.tsx",
      "content": "import { useGetList } from \"ra-core\";\n\nimport type { Contact, ContactNote } from \"../types\";\nimport { DashboardActivityLog } from \"./DashboardActivityLog\";\nimport { DashboardStepper } from \"./DashboardStepper\";\nimport { RecentLeads } from \"./RecentLeads\";\nimport { LeadStatusChart } from \"./LeadStatusChart\";\nimport { TasksList } from \"./TasksList\";\nimport { Welcome } from \"./Welcome\";\n\nexport const Dashboard = () => {\n  const {\n    data: dataContact,\n    total: totalContact,\n    isPending: isPendingContact,\n  } = useGetList<Contact>(\"contacts\", {\n    pagination: { page: 1, perPage: 1 },\n  });\n\n  const { total: totalContactNotes, isPending: isPendingContactNotes } =\n    useGetList<ContactNote>(\"contactNotes\", {\n      pagination: { page: 1, perPage: 1 },\n    });\n\n  const { total: totalDeal, isPending: isPendingDeal } = useGetList<Contact>(\n    \"lead-journey\",\n    {\n      pagination: { page: 1, perPage: 1 },\n    },\n  );\n\n  const isPending = isPendingContact || isPendingContactNotes || isPendingDeal;\n\n  if (isPending) {\n    return null;\n  }\n\n  if (!totalContact) {\n    return <DashboardStepper step={1} />;\n  }\n\n  if (!totalContactNotes) {\n    return <DashboardStepper step={2} contactId={dataContact?.[0]?.id} />;\n  }\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-12 gap-6 mt-1\">\n      <div className=\"md:col-span-3\">\n        <div className=\"flex flex-col gap-4\">\n          {import.meta.env.VITE_IS_DEMO === \"true\" ? <Welcome /> : null}\n          <RecentLeads />\n        </div>\n      </div>\n      <div className=\"md:col-span-6\">\n        <div className=\"flex flex-col gap-6\">\n          {totalDeal ? <LeadStatusChart /> : null}\n          <DashboardActivityLog />\n        </div>\n      </div>\n\n      <div className=\"md:col-span-3\">\n        <TasksList />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/useContactImport.tsx",
      "content": "import { useDataProvider, useGetIdentity, type DataProvider } from \"ra-core\";\nimport { useCallback, useMemo } from \"react\";\n\nimport { createLeadJourneyDealForContact } from \"../deals/createLeadJourneyDeal\";\nimport type { Company, Tag } from \"../types\";\nimport type { ImportError } from \"../misc/usePapaParse\";\n\nexport type ContactImportSchema = {\n  // Auto-generated fields (ignored if present in CSV):\n  // id - auto-generated by database\n  // sales_id - always uses current user\n  // nb_tasks - auto-calculated\n  // sales - computed from sales_id\n  first_name: string;\n  last_name: string;\n  gender: string;\n  email_jsonb?: string;\n  phone_jsonb?: string;\n  flat_villa_number?: string;\n  building_street?: string;\n  area?: string;\n  google_maps_link?: string;\n  phone_has_whatsapp?: string;\n  services_interested?: string;\n  description?: string;\n  first_seen: string;\n  last_seen: string;\n  tags?: string;\n  // Legacy fields for backward compatibility\n  title?: string;\n  company?: string;\n  email_work?: string;\n  email_home?: string;\n  email_other?: string;\n  phone_work?: string;\n  phone_home?: string;\n  phone_other?: string;\n  background?: string;\n  avatar?: string;\n  has_newsletter?: string;\n  status?: string;\n  linkedin_url?: string;\n};\n\nexport function useContactImport() {\n  const today = new Date().toISOString();\n  const user = useGetIdentity();\n  const dataProvider = useDataProvider();\n\n  // company cache to avoid creating the same company multiple times and costly roundtrips\n  // Cache is dependent of dataProvider, so it's safe to use it as a dependency\n  const companiesCache = useMemo(\n    () => new Map<string, Company>(),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [dataProvider],\n  );\n  const getCompanies = useCallback(\n    async (names: string[]) =>\n      fetchRecordsWithCache<Company>(\n        \"companies\",\n        companiesCache,\n        names,\n        (name) => ({\n          name,\n          created_at: new Date().toISOString(),\n          sales_id: user?.identity?.id,\n        }),\n        dataProvider,\n      ),\n    [companiesCache, user?.identity?.id, dataProvider],\n  );\n\n  // Tags cache to avoid creating the same tag multiple times and costly roundtrips\n  // Cache is dependent of dataProvider, so it's safe to use it as a dependency\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const tagsCache = useMemo(() => new Map<string, Tag>(), [dataProvider]);\n  const getTags = useCallback(\n    async (names: string[]) =>\n      fetchRecordsWithCache<Tag>(\n        \"tags\",\n        tagsCache,\n        names,\n        (name) => ({\n          name,\n          color: \"#f9f9f9\",\n        }),\n        dataProvider,\n      ),\n    [tagsCache, dataProvider],\n  );\n\n  const processBatch = useCallback(\n    async (batch: ContactImportSchema[], startRowIndex: number): Promise<ImportError[]> => {\n      const errors: ImportError[] = [];\n      \n      const [companies, tags] = await Promise.all([\n        getCompanies(\n          batch\n            .map((contact) => contact.company?.trim())\n            .filter((name) => name),\n        ),\n        getTags(batch.flatMap((batch) => parseTags(batch.tags))),\n      ]);\n\n      const results = await Promise.allSettled(\n        batch.map(\n          async (row, batchIndex) => {\n            const rowNumber = startRowIndex + batchIndex;\n            const {\n              first_name,\n              last_name,\n              gender,\n              email_jsonb,\n              phone_jsonb,\n              flat_villa_number,\n              building_street,\n              area,\n              google_maps_link,\n              phone_has_whatsapp,\n              services_interested,\n              description,\n              first_seen,\n              last_seen,\n              tags: tagNames,\n              // Legacy fields for backward compatibility\n              title,\n              company: companyName,\n              email_work,\n              email_home,\n              email_other,\n              phone_work,\n              phone_home,\n              phone_other,\n              background,\n              has_newsletter,\n              status,\n              linkedin_url,\n            } = row;\n            \n            // Ignore id, sales_id, nb_tasks, and sales from CSV - these are auto-generated\n\n            // Parse email_jsonb if provided, otherwise fall back to legacy fields\n            let parsedEmailJsonb: Array<{ email: string; type: string }> = [];\n            if (email_jsonb) {\n              try {\n                parsedEmailJsonb = JSON.parse(email_jsonb);\n              } catch {\n                // If parsing fails, try legacy fields\n                parsedEmailJsonb = [\n                  { email: email_work, type: \"Work\" },\n                  { email: email_home, type: \"Home\" },\n                  { email: email_other, type: \"Other\" },\n                ].filter(({ email }) => email);\n              }\n            } else if (email_work || email_home || email_other) {\n              parsedEmailJsonb = [\n                { email: email_work, type: \"Work\" },\n                { email: email_home, type: \"Home\" },\n                { email: email_other, type: \"Other\" },\n              ].filter(({ email }) => email);\n            }\n\n            // Parse phone_jsonb if provided, otherwise fall back to legacy fields\n            let parsedPhoneJsonb: Array<{ number: string; type: string }> = [];\n            if (phone_jsonb) {\n              try {\n                parsedPhoneJsonb = JSON.parse(phone_jsonb);\n              } catch {\n                // If parsing fails, try legacy fields\n                parsedPhoneJsonb = [\n                  { number: phone_work, type: \"Work\" },\n                  { number: phone_home, type: \"Home\" },\n                  { number: phone_other, type: \"Other\" },\n                ].filter(({ number }) => number);\n              }\n            } else if (phone_work || phone_home || phone_other) {\n              parsedPhoneJsonb = [\n                { number: phone_work, type: \"Work\" },\n                { number: phone_home, type: \"Home\" },\n                { number: phone_other, type: \"Other\" },\n              ].filter(({ number }) => number);\n            }\n\n            // Parse services_interested (semicolon-separated)\n            // Convert to string first in case PapaParse converted it to a number\n            const parsedServicesInterested = services_interested\n              ? String(services_interested)\n                  .split(\";\")\n                  .map((s) => s.trim())\n                  .filter(Boolean)\n                  .map((s) => parseInt(s, 10))\n                  .filter((n) => !isNaN(n))\n              : [];\n\n            const company = companyName?.trim()\n              ? companies.get(companyName.trim())\n              : undefined;\n            const tagList = parseTags(tagNames || \"\")\n              .map((name) => tags.get(name))\n              .filter((tag): tag is Tag => !!tag);\n\n            // Always use current user's ID for sales_id (ignore any sales_id in CSV)\n            const finalSalesId = user?.identity?.id;\n\n            // Validate required fields\n            if (!first_name?.trim() && !last_name?.trim()) {\n              throw new Error(\"Either first_name or last_name is required\");\n            }\n\n            // Create the contact first\n            const contactResponse = await dataProvider.create(\"contacts\", {\n              data: {\n                first_name,\n                last_name,\n                gender,\n                title,\n                email_jsonb: parsedEmailJsonb,\n                phone_jsonb: parsedPhoneJsonb,\n                flat_villa_number,\n                building_street,\n                area,\n                google_maps_link,\n                phone_has_whatsapp: phone_has_whatsapp === \"TRUE\" || phone_has_whatsapp === \"true\",\n                services_interested: parsedServicesInterested,\n                description,\n                background,\n                first_seen: first_seen\n                  ? new Date(first_seen).toISOString()\n                  : today,\n                last_seen: last_seen\n                  ? new Date(last_seen).toISOString()\n                  : today,\n                has_newsletter,\n                status,\n                company_id: company?.id,\n                tags: tagList.map((tag) => tag.id),\n                sales_id: finalSalesId,\n                linkedin_url,\n              },\n            });\n\n            // Extract contact ID from response (handle both response.data and direct data)\n            const contact = ((contactResponse as any)?.data ?? contactResponse) as { id: number | string } | undefined;\n            const contactId = contact?.id;\n\n            // Create corresponding lead-journey entry if contact was created successfully\n            if (contactId) {\n              try {\n                await createLeadJourneyDealForContact(\n                  dataProvider,\n                  {\n                    id: contactId,\n                    first_name,\n                    last_name,\n                    sales_id: finalSalesId,\n                    company_id: company?.id ?? null,\n                  },\n                  finalSalesId,\n                );\n              } catch (error) {\n                // Log error but don't fail the import if lead-journey creation fails\n                console.error(\"Error creating lead-journey entry for imported contact:\", error);\n              }\n            }\n\n            return contactResponse;\n          },\n        ),\n      );\n      \n      // Process results and collect errors\n      results.forEach((result, index) => {\n        if (result.status === \"rejected\") {\n          const rowNumber = startRowIndex + index;\n          const errorMessage = result.reason?.message || result.reason || \"Unknown error\";\n          errors.push({\n            row: rowNumber,\n            message: String(errorMessage),\n            data: batch[index],\n          });\n        }\n      });\n      \n      return errors;\n    },\n    [dataProvider, getCompanies, getTags, user?.identity?.id, today],\n  );\n\n  return processBatch;\n}\n\nconst fetchRecordsWithCache = async function <T>(\n  resource: string,\n  cache: Map<string, T>,\n  names: string[],\n  getCreateData: (name: string) => Partial<T>,\n  dataProvider: DataProvider,\n) {\n  const trimmedNames = [...new Set(names.map((name) => name.trim()))];\n  const uncachedRecordNames = trimmedNames.filter((name) => !cache.has(name));\n\n  // check the backend for existing records\n  if (uncachedRecordNames.length > 0) {\n    const response = await dataProvider.getList(resource, {\n      filter: {\n        \"name@in\": `(${uncachedRecordNames\n          .map((name) => `\"${name}\"`)\n          .join(\",\")})`,\n      },\n      pagination: { page: 1, perPage: trimmedNames.length },\n      sort: { field: \"id\", order: \"ASC\" },\n    });\n    for (const record of response.data) {\n      cache.set(record.name.trim(), record);\n    }\n  }\n\n  // create missing records in parallel\n  await Promise.all(\n    uncachedRecordNames.map(async (name) => {\n      if (cache.has(name)) return;\n      const response = await dataProvider.create(resource, {\n        data: getCreateData(name),\n      });\n      cache.set(name, response.data);\n    }),\n  );\n\n  // now all records are in cache, return a map of all records\n  return trimmedNames.reduce((acc, name) => {\n    acc.set(name, cache.get(name) as T);\n    return acc;\n  }, new Map<string, T>());\n};\n\nconst parseTags = (tags: string) =>\n  tags\n    ? String(tags)\n        .split(\",\")\n        .map((tag: string) => tag.trim())\n        .filter((tag: string) => tag)\n    : [];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/index.tsx",
      "content": "import type { Contact } from \"../types\";\nimport { ContactCreate } from \"./ContactCreate\";\nimport { ContactEdit } from \"./ContactEdit\";\nimport { ContactList } from \"./ContactList\";\nimport { ContactShow } from \"./ContactShow\";\n\nexport default {\n  list: ContactList,\n  show: ContactShow,\n  edit: ContactEdit,\n  create: ContactCreate,\n  recordRepresentation: (record: Contact) =>\n    record?.first_name + \" \" + record?.last_name,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/exportToVCard.ts",
      "content": "import type { Contact, Company } from \"../types\";\n\n/**\n * Folds a long line according to vCard specification (max 75 chars per line)\n * Continuation lines start with a space\n */\nfunction foldLine(line: string): string {\n  const maxLength = 75;\n  if (line.length <= maxLength) return line;\n\n  const result: string[] = [];\n  let currentLine = line.substring(0, maxLength);\n  let remaining = line.substring(maxLength);\n\n  result.push(currentLine);\n\n  while (remaining.length > 0) {\n    // Continuation lines start with a space and can have 74 more chars\n    const chunkSize = maxLength - 1;\n    currentLine = \" \" + remaining.substring(0, chunkSize);\n    remaining = remaining.substring(chunkSize);\n    result.push(currentLine);\n  }\n\n  return result.join(\"\\r\\n\");\n}\n\n/**\n * Converts a contact and their company to vCard 3.0 format\n */\nexport function exportToVCard(\n  contact: Contact,\n  company?: Company,\n  photoData?: { base64: string; mimeType: string },\n): string {\n  const lines: string[] = [];\n\n  // vCard header\n  lines.push(\"BEGIN:VCARD\");\n  lines.push(\"VERSION:3.0\");\n\n  // Name (N: Family Name;Given Name;Additional Names;Honorific Prefixes;Honorific Suffixes)\n  lines.push(`N:${contact.last_name};${contact.first_name};;;`);\n\n  // Formatted name\n  lines.push(`FN:${contact.first_name} ${contact.last_name}`);\n\n  // Title/Job position\n  if (contact.title) {\n    lines.push(`TITLE:${contact.title}`);\n  }\n\n  // Organization\n  if (company?.name) {\n    lines.push(`ORG:${company.name}`);\n  }\n\n  // Emails\n  if (contact.email_jsonb && contact.email_jsonb.length > 0) {\n    contact.email_jsonb.forEach((emailObj) => {\n      const type = emailObj.type.toUpperCase();\n      lines.push(`EMAIL;TYPE=${type}:${emailObj.email}`);\n    });\n  }\n\n  // Phone numbers\n  if (contact.phone_jsonb && contact.phone_jsonb.length > 0) {\n    contact.phone_jsonb.forEach((phoneObj) => {\n      const type = phoneObj.type.toUpperCase();\n      lines.push(`TEL;TYPE=${type}:${phoneObj.number}`);\n    });\n  }\n\n  // LinkedIn URL\n  if (contact.linkedin_url) {\n    lines.push(`URL:${contact.linkedin_url}`);\n  }\n\n  // Background/Note\n  if (contact.background) {\n    // Escape newlines and special characters in notes\n    const escapedNote = contact.background\n      .replace(/\\\\/g, \"\\\\\\\\\")\n      .replace(/\\n/g, \"\\\\n\")\n      .replace(/,/g, \"\\\\,\")\n      .replace(/;/g, \"\\\\;\");\n    lines.push(`NOTE:${escapedNote}`);\n  }\n\n  // Photo/Avatar - vCard 3.0 format with base64 encoding\n  if (photoData) {\n    // Extract image type from MIME type (e.g., \"image/png\" -> \"PNG\")\n    const imageType = photoData.mimeType.split(\"/\")[1]?.toUpperCase() || \"PNG\";\n\n    // vCard 3.0 format: PHOTO;ENCODING=b;TYPE=PNG:\n    const photoLine = `PHOTO;ENCODING=b;TYPE=${imageType}:${photoData.base64}`;\n    lines.push(foldLine(photoLine));\n  }\n\n  // vCard footer\n  lines.push(\"END:VCARD\");\n\n  return lines.join(\"\\r\\n\");\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/TagsListEdit.tsx",
      "content": "import { Edit, Plus } from \"lucide-react\";\nimport {\n  useGetList,\n  useGetMany,\n  useRecordContext,\n  useUpdate,\n  type Identifier,\n} from \"ra-core\";\nimport { useCallback, useState } from \"react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nimport { TagChip } from \"../tags/TagChip\";\nimport { TagCreateModal } from \"../tags/TagCreateModal\";\nimport type { Contact, Tag } from \"../types\";\n\nexport const TagsListEdit = () => {\n  const record = useRecordContext<Contact>();\n  const [open, setOpen] = useState(false);\n\n  const { data: allTags, isPending: isPendingAllTags } = useGetList<Tag>(\n    \"tags\",\n    {\n      pagination: { page: 1, perPage: 10 },\n      sort: { field: \"name\", order: \"ASC\" },\n    },\n  );\n  const { data: tags, isPending: isPendingRecordTags } = useGetMany<Tag>(\n    \"tags\",\n    { ids: record?.tags },\n    { enabled: record && record.tags && record.tags.length > 0 },\n  );\n  const [update] = useUpdate<Contact>();\n\n  const unselectedTags =\n    allTags && record && allTags.filter((tag) => !record.tags.includes(tag.id));\n\n  const handleTagAdd = (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    const tags = [...record.tags, id];\n    update(\"contacts\", {\n      id: record.id,\n      data: { tags },\n      previousData: record,\n    });\n  };\n\n  const handleTagDelete = async (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    const tags = record.tags.filter((tagId) => tagId !== id);\n    await update(\"contacts\", {\n      id: record.id,\n      data: { tags },\n      previousData: record,\n    });\n  };\n\n  const openTagCreateDialog = () => {\n    setOpen(true);\n  };\n\n  const handleTagCreateClose = () => {\n    setOpen(false);\n  };\n\n  const handleTagCreated = useCallback(\n    async (tag: Tag) => {\n      if (!record) {\n        throw new Error(\"No contact record found\");\n      }\n\n      await update(\n        \"contacts\",\n        {\n          id: record.id,\n          data: { tags: [...record.tags, tag.id] },\n          previousData: record,\n        },\n        {\n          onSuccess: () => {\n            setOpen(false);\n          },\n        },\n      );\n    },\n    [update, record],\n  );\n\n  if (isPendingRecordTags || isPendingAllTags) return null;\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      {tags?.map((tag) => (\n        <div key={tag.id}>\n          <TagChip tag={tag} onUnlink={() => handleTagDelete(tag.id)} />\n        </div>\n      ))}\n\n      <div>\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button variant=\"outline\" size=\"sm\" className=\"h-6 cursor-pointer\">\n              <Plus className=\"h-3 w-3 mr-1\" />\n              Add tag\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent>\n            {unselectedTags?.map((tag) => (\n              <DropdownMenuItem\n                key={tag.id}\n                onClick={() => handleTagAdd(tag.id)}\n              >\n                <Badge\n                  variant=\"secondary\"\n                  className=\"text-xs font-normal text-black\"\n                  style={{\n                    backgroundColor: tag.color,\n                  }}\n                >\n                  {tag.name}\n                </Badge>\n              </DropdownMenuItem>\n            ))}\n            <DropdownMenuItem onClick={openTagCreateDialog}>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"w-full justify-start p-0 cursor-pointer\"\n              >\n                <Edit className=\"h-3 w-3 mr-2\" />\n                Create new tag\n              </Button>\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n      </div>\n\n      <TagCreateModal\n        open={open}\n        onClose={handleTagCreateClose}\n        onSuccess={handleTagCreated}\n      />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/TagsList.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\nimport { ReferenceArrayField } from \"@/components/admin/reference-array-field\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\n\nconst ColoredBadge = (props: any) => {\n  const record = useRecordContext();\n  if (!record) return null;\n  return (\n    <Badge\n      {...props}\n      style={{ backgroundColor: record.color, border: 0 }}\n      variant=\"outline\"\n      className={cn(\"text-black font-normal\", props.className)}\n    >\n      {record.name}\n    </Badge>\n  );\n};\n\nexport const TagsList = () => (\n  <ReferenceArrayField\n    className=\"inline-block\"\n    resource=\"contacts\"\n    source=\"tags\"\n    reference=\"tags\"\n  >\n    <SingleFieldList>\n      <ColoredBadge source=\"name\" />\n    </SingleFieldList>\n  </ReferenceArrayField>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ServicesListEdit.tsx",
      "content": "import { X, Plus } from \"lucide-react\";\nimport {\n  useGetList,\n  useGetMany,\n  useRecordContext,\n  useUpdate,\n  type Identifier,\n} from \"ra-core\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nimport type { Contact, Service } from \"../types\";\n\nexport const ServicesListEdit = () => {\n  const record = useRecordContext<Contact>();\n\n  const { data: allServices, isPending: isPendingAllServices } = useGetList<Service>(\n    \"services\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"name\", order: \"ASC\" },\n    },\n  );\n  const { data: services, isPending: isPendingRecordServices } = useGetMany<Service>(\n    \"services\",\n    { ids: record?.services_interested || [] },\n    { enabled: record && record.services_interested && record.services_interested.length > 0 },\n  );\n  const [update] = useUpdate<Contact>();\n\n  const unselectedServices =\n    allServices && record && record.services_interested\n      ? allServices.filter((service) => !record.services_interested.includes(service.id))\n      : allServices;\n\n  const handleServiceAdd = (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    const services_interested = [...(record.services_interested || []), id];\n    update(\"contacts\", {\n      id: record.id,\n      data: { services_interested },\n      previousData: record,\n    });\n  };\n\n  const handleServiceDelete = async (id: Identifier) => {\n    if (!record) {\n      throw new Error(\"No contact record found\");\n    }\n    // Prevent deletion if there's only 1 service remaining\n    const currentServicesCount = (record.services_interested || []).length;\n    if (currentServicesCount <= 1) {\n      return;\n    }\n    const services_interested = (record.services_interested || []).filter((serviceId) => serviceId !== id);\n    await update(\"contacts\", {\n      id: record.id,\n      data: { services_interested },\n      previousData: record,\n    });\n  };\n\n  if (isPendingRecordServices || isPendingAllServices) return null;\n\n  const servicesCount = record?.services_interested?.length || 0;\n  const canRemoveService = servicesCount > 1;\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      {services?.map((service) => (\n        <Badge\n          key={service.id}\n          variant=\"secondary\"\n          className=\"text-xs font-normal pr-1\"\n        >\n          {service.name}\n          {canRemoveService && (\n            <button\n              onClick={() => handleServiceDelete(service.id)}\n              className=\"ml-1 hover:bg-secondary-foreground/20 rounded-full p-0.5\"\n              aria-label={`Remove ${service.name}`}\n            >\n              <X className=\"h-3 w-3\" />\n            </button>\n          )}\n        </Badge>\n      ))}\n\n      {unselectedServices && unselectedServices.length > 0 && (\n        <div>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" size=\"sm\" className=\"h-6 cursor-pointer\">\n                <Plus className=\"h-3 w-3 mr-1\" />\n                Add service\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent>\n              {unselectedServices.map((service) => (\n                <DropdownMenuItem\n                  key={service.id}\n                  onClick={() => handleServiceAdd(service.id)}\n                >\n                  {service.name}\n                </DropdownMenuItem>\n              ))}\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      )}\n    </div>\n  );\n};\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/LeadInputs.tsx",
      "content": "import { email, required } from \"ra-core\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { ArrayInput } from \"@/components/admin/array-input\";\nimport { AutocompleteArrayInput } from \"@/components/admin/autocomplete-array-input\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { ReferenceArrayInput } from \"@/components/admin/reference-array-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { SimpleFormIterator } from \"@/components/admin/simple-form-iterator\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { RadioButtonGroupInput } from \"@/components/admin/radio-button-group-input\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Sale } from \"../types\";\n\nexport const LeadInputs = () => {\n  const isMobile = useIsMobile();\n\n  return (\n    <div className=\"flex flex-col gap-2 p-1\">\n      <div className={`flex gap-6 ${isMobile ? \"flex-col\" : \"flex-row\"}`}>\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <BasicInformation />\n          <AddressInformation />\n        </div>\n        <Separator\n          orientation={isMobile ? \"horizontal\" : \"vertical\"}\n          className=\"flex-shrink-0\"\n        />\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <ServicesSection />\n          <AccountManagerSection />\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst validateServices = (value: unknown) => {\n  if (Array.isArray(value) && value.length > 0) return undefined;\n  return \"At least one service is required\";\n};\n\nconst BasicInformation = () => {\n  const { contactGender } = useConfigurationContext();\n  // Filter to only show male and female options for the toggle\n  const genderOptions = contactGender.filter(g => g.value === \"male\" || g.value === \"female\");\n  \n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Basic Information</h6>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <TextInput\n          source=\"first_name\"\n          label=\"First Name\"\n          validate={required()}\n          helperText={false}\n        />\n        <TextInput\n          source=\"last_name\"\n          label=\"Last Name\"\n          helperText={false}\n        />\n      </div>\n\n      <RadioButtonGroupInput\n        source=\"gender\"\n        label=\"Gender\"\n        choices={genderOptions}\n        optionText=\"label\"\n        optionValue=\"value\"\n        helperText={false}\n        row\n        defaultValue={genderOptions[0]?.value}\n      />\n\n      <ArrayInput source=\"phone_jsonb\" label=\"Phone Number\" helperText={false}>\n        <SimpleFormIterator\n          inline\n          disableReordering\n          disableClear\n          className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n        >\n          <TextInput\n            source=\"number\"\n            className=\"w-full\"\n            helperText={false}\n            label={false}\n            placeholder=\"Phone number\"\n            validate={required()}\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n\n      <BooleanInput\n        source=\"phone_has_whatsapp\"\n        label=\"Phone number has WhatsApp\"\n        helperText={false}\n      />\n\n      <ArrayInput source=\"email_jsonb\" label=\"Email\" helperText={false}>\n        <SimpleFormIterator\n          inline\n          disableReordering\n          disableClear\n          className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n        >\n          <TextInput\n            source=\"email\"\n            className=\"w-full\"\n            helperText={false}\n            label={false}\n            placeholder=\"Email\"\n            validate={email()}\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n\n      <TextInput\n        source=\"description\"\n        label=\"Description\"\n        multiline\n        rows={4}\n        helperText={false}\n        placeholder=\"Add a description about this lead\"\n      />\n    </div>\n  );\n};\n\nconst AddressInformation = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Address Information</h6>\n\n      <TextInput\n        source=\"flat_villa_number\"\n        label=\"Flat/Villa Number\"\n        helperText={false}\n      />\n\n      <TextInput\n        source=\"building_street\"\n        label=\"Building/Street\"\n        helperText={false}\n      />\n\n      <TextInput source=\"area\" label=\"Area\" helperText={false} />\n\n      <TextInput\n        source=\"google_maps_link\"\n        label=\"Google Maps Link\"\n        helperText={false}\n      />\n    </div>\n  );\n};\n\nconst ServicesSection = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Services</h6>\n      <ReferenceArrayInput source=\"services_interested\" reference=\"services\">\n        <AutocompleteArrayInput\n          label=\"Services Interested In\"\n          optionText=\"name\"\n          helperText={false}\n          validate={validateServices}\n          minItems={1}\n        />\n      </ReferenceArrayInput>\n    </div>\n  );\n};\n\nconst AccountManagerSection = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Account Manager</h6>\n      <ReferenceInput\n        reference=\"sales\"\n        source=\"sales_id\"\n        sort={{ field: \"last_name\", order: \"ASC\" }}\n        filter={{ \"disabled@neq\": true }}\n      >\n        <SelectInput\n          helperText={false}\n          label=\"Account manager\"\n          optionText={saleOptionRenderer}\n          validate={required()}\n        />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst saleOptionRenderer = (choice: Sale) =>\n  `${choice.first_name} ${choice.last_name}`;\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ExportVCardButton.tsx",
      "content": "import { Download } from \"lucide-react\";\nimport { useGetOne, useRecordContext } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport type { Contact, Company } from \"../types\";\nimport { exportToVCard } from \"./exportToVCard\";\n\nexport const ExportVCardButton = () => {\n  const contact = useRecordContext<Contact>();\n\n  // Fetch the company data on mount\n  const { data: company } = useGetOne<Company>(\n    \"companies\",\n    { id: contact?.company_id },\n    { enabled: !!contact?.company_id },\n  );\n\n  const handleExport = async () => {\n    if (!contact) return;\n\n    // Fetch and convert avatar to base64 if it exists\n    let photoData: { base64: string; mimeType: string } | undefined = undefined;\n\n    if (contact.avatar?.src) {\n      try {\n        const response = await fetch(contact.avatar.src);\n        const blob = await response.blob();\n        const mimeType = blob.type || \"image/png\";\n\n        // Convert blob to base64\n        const base64 = await new Promise<string>((resolve, reject) => {\n          const reader = new FileReader();\n          reader.onloadend = () => {\n            const result = reader.result as string;\n            // Remove the data URL prefix (data:image/png;base64,)\n            const base64Data = result.split(\",\")[1];\n            resolve(base64Data);\n          };\n          reader.onerror = reject;\n          reader.readAsDataURL(blob);\n        });\n\n        photoData = { base64, mimeType };\n      } catch (error) {\n        console.error(\"Failed to fetch avatar image:\", error);\n        // Continue without the photo\n      }\n    }\n\n    // Generate vCard content\n    const vCardContent = exportToVCard(contact, company, photoData);\n\n    // Create blob and download\n    const blob = new Blob([vCardContent], {\n      type: \"text/vcard;charset=utf-8\",\n    });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement(\"a\");\n    link.href = url;\n    link.download = `${contact.first_name}_${contact.last_name}.vcf`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  };\n\n  if (!contact) return null;\n\n  return (\n    <Button\n      variant=\"outline\"\n      size=\"sm\"\n      onClick={handleExport}\n      className=\"h-6 cursor-pointer\"\n    >\n      <Download className=\"w-4 h-4\" />\n      Export to vCard\n    </Button>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactShow.tsx",
      "content": "import {\n  ShowBase,\n  useShowContext,\n  useGetList,\n  RecordContextProvider,\n  useRefresh,\n  useUpdate,\n  useNotify,\n} from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Edit, Save, CircleX } from \"lucide-react\";\nimport { useMemo, useState, useEffect } from \"react\";\nimport type { SubmitHandler, FieldValues } from \"react-hook-form\";\nimport { useForm, FormProvider } from \"react-hook-form\";\nimport { useLocation } from \"react-router\";\n\nimport type { Contact, Task, Quote, Deal } from \"../types\";\nimport { ContactAside } from \"./ContactAside\";\nimport { QuoteItem } from \"../quotes/QuoteItem\";\nimport { AddQuote } from \"../quotes/AddQuote\";\nimport { Task as TaskComponent } from \"../tasks/Task\";\nimport { AddTask } from \"../tasks/AddTask\";\nimport { UnifiedNotesIterator } from \"../notes/UnifiedNotesIterator\";\nimport { ActivityLog } from \"../activity/ActivityLog\";\nimport {\n  crmAddDays,\n  crmEndOfDay,\n  crmEndOfWeek,\n  crmStartOfDay,\n} from \"../misc/timezone\";\n\nexport const ContactShow = () => (\n  <ShowBase>\n    <ContactShowContent />\n  </ShowBase>\n);\n\nconst ContactShowContent = () => {\n  const { record, isPending } = useShowContext<Contact>();\n  const refresh = useRefresh();\n  const [isEditingDescription, setIsEditingDescription] = useState(false);\n  const [update, { isPending: isUpdating }] = useUpdate();\n  const notify = useNotify();\n  const location = useLocation();\n\n  // Fetch deals associated with this contact to get deal IDs for notes\n  // Fetch both archived and non-archived deals\n  const { data: deals } = useGetList<Deal>(\"lead-journey\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record?.id ? { lead_id: record.id } : {},\n    sort: { field: \"archived_at\", order: \"ASC\" }, // Non-archived first\n  }, { enabled: !!record?.id });\n  \n  // Separate archived and non-archived deals\n  const sortedDeals = useMemo(() => {\n    if (!deals) return [];\n    const active = deals.filter(d => !d.archived_at);\n    const archived = deals.filter(d => d.archived_at);\n    return [...active, ...archived];\n  }, [deals]);\n\n  // Get all deal IDs for fetching notes from all deals\n  const dealIds = useMemo(() => {\n    return deals?.map(deal => deal.id) || [];\n  }, [deals]);\n\n  const { data: quotes } = useGetList<Quote>(\"quotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n    filter: record?.id ? { contact_id: record.id } : {},\n  }, { enabled: !!record?.id });\n\n  const { data: tasks } = useGetList<Task>(\"tasks\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record?.id ? { contact_id: record.id } : {},\n  }, { enabled: !!record?.id });\n\n  const [showCompletedTasks, setShowCompletedTasks] = useState(false);\n\n  const groupedTasks = useMemo(() => {\n    const empty = {\n      overdue: [] as Task[],\n      today: [] as Task[],\n      tomorrow: [] as Task[],\n      thisWeek: [] as Task[],\n      later: [] as Task[],\n      completed: [] as Task[],\n    };\n    if (!tasks) return empty;\n\n    const startOfToday = crmStartOfDay() ?? new Date();\n    const endOfToday = crmEndOfDay() ?? new Date();\n    const endOfTomorrow = crmEndOfDay(crmAddDays(new Date(), 1)) ?? new Date();\n    const endOfWeek = crmEndOfWeek() ?? new Date();\n\n    for (const task of tasks) {\n      if (task.done_date) {\n        empty.completed.push(task);\n        continue;\n      }\n\n      const due = task.due_date ? new Date(task.due_date) : null;\n      if (!due || Number.isNaN(due.getTime())) {\n        empty.later.push(task);\n        continue;\n      }\n\n      if (due < startOfToday) empty.overdue.push(task);\n      else if (due <= endOfToday) empty.today.push(task);\n      else if (due <= endOfTomorrow) empty.tomorrow.push(task);\n      else if (due <= endOfWeek) empty.thisWeek.push(task);\n      else empty.later.push(task);\n    }\n\n    const byDueDateAsc = (a: Task, b: Task) =>\n      new Date(a.due_date || 0).getTime() - new Date(b.due_date || 0).getTime();\n\n    empty.overdue.sort(byDueDateAsc);\n    empty.today.sort(byDueDateAsc);\n    empty.tomorrow.sort(byDueDateAsc);\n    empty.thisWeek.sort(byDueDateAsc);\n    empty.later.sort(byDueDateAsc);\n\n    empty.completed.sort(\n      (a, b) => new Date(b.done_date || 0).getTime() - new Date(a.done_date || 0).getTime(),\n    );\n\n    return empty;\n  }, [tasks]);\n\n  const form = useForm<{ description: string }>({\n    defaultValues: {\n      description: record?.description || \"\",\n    },\n  });\n\n  // Reset form when record ID changes (different contact)\n  useEffect(() => {\n    if (record) {\n      form.reset({ description: record.description || \"\" });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [record?.id]);\n\n  // If we deep-link with a hash (#note-123 / #task-456), scroll to it once content renders.\n  useEffect(() => {\n    if (!record) return;\n    const hash = (location.hash || \"\").replace(/^#/, \"\");\n    if (!hash) return;\n\n    let tries = 0;\n    const tryScroll = () => {\n      tries += 1;\n      const el = document.getElementById(hash);\n      if (el) {\n        el.scrollIntoView({ block: \"center\", behavior: \"smooth\" });\n        return;\n      }\n      if (tries < 20) {\n        setTimeout(tryScroll, 150);\n      }\n    };\n    tryScroll();\n  }, [location.hash, record]);\n\n  const handleDescriptionUpdate: SubmitHandler<FieldValues> = (values) => {\n    if (!record) return;\n    update(\n      \"contacts\",\n      { id: record.id, data: { description: values.description || null }, previousData: record },\n      {\n        onSuccess: () => {\n          setIsEditingDescription(false);\n          refresh();\n          notify(\"Description updated\", { type: \"info\" });\n        },\n        onError: (error: any) => {\n          console.error(\"Error updating description:\", error);\n          notify(\n            error?.message?.includes(\"description\") \n              ? \"Description column not found. Please ensure migrations are applied.\"\n              : \"Failed to update description\",\n            { type: \"error\" }\n          );\n        },\n      },\n    );\n  };\n\n  const handleCancelEdit = () => {\n    if (record) {\n      form.reset({ description: record.description || \"\" });\n    }\n    setIsEditingDescription(false);\n  };\n\n  if (isPending || !record) return null;\n\n  const defaultTab = (() => {\n    const tab = new URLSearchParams(location.search).get(\"tab\");\n    if (tab === \"notes\" || tab === \"quotes\" || tab === \"tasks\" || tab === \"activity\") {\n      return tab;\n    }\n    return \"activity\";\n  })();\n\n  return (\n    <div className=\"mt-2 mb-2 flex gap-8\">\n      <div className=\"flex-1\">\n        <Card>\n          <CardContent>\n            <div className=\"flex\">\n              <div className=\"flex-1\">\n                <h5 className=\"text-xl font-semibold\">\n                  {record.first_name} {record.last_name}\n                </h5>\n                <div className=\"inline-flex text-sm text-muted-foreground\">\n                  {record.title}\n                  {record.title && record.company_id != null && \" at \"}\n                  {record.company_id != null && (\n                    <ReferenceField\n                      source=\"company_id\"\n                      reference=\"companies\"\n                      link=\"show\"\n                    >\n                      &nbsp;\n                      <TextField source=\"name\" />\n                    </ReferenceField>\n                  )}\n                </div>\n                <div className=\"mt-4\">\n                  {isEditingDescription ? (\n                    <FormProvider {...form}>\n                      <form onSubmit={form.handleSubmit(handleDescriptionUpdate)}>\n                        <div className=\"flex flex-col gap-2\">\n                          <Textarea\n                            {...form.register(\"description\")}\n                            placeholder=\"Add a description...\"\n                            rows={4}\n                            className=\"text-sm\"\n                          />\n                          <div className=\"flex justify-end gap-2\">\n                            <Button\n                              variant=\"outline\"\n                              onClick={handleCancelEdit}\n                              type=\"button\"\n                              size=\"sm\"\n                              className=\"cursor-pointer\"\n                            >\n                              <CircleX className=\"w-4 h-4 mr-2\" />\n                              Cancel\n                            </Button>\n                            <Button\n                              type=\"submit\"\n                              disabled={isUpdating}\n                              size=\"sm\"\n                              className=\"cursor-pointer\"\n                            >\n                              <Save className=\"w-4 h-4 mr-2\" />\n                              Save\n                            </Button>\n                          </div>\n                        </div>\n                      </form>\n                    </FormProvider>\n                  ) : (\n                    <div className=\"group relative\">\n                      {record.description ? (\n                        <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                          {record.description}\n                        </p>\n                      ) : (\n                        <p className=\"text-sm text-muted-foreground italic\">\n                          No description\n                        </p>\n                      )}\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => {\n                          form.reset({ description: record.description || \"\" });\n                          setIsEditingDescription(true);\n                        }}\n                        className=\"mt-2 h-7 cursor-pointer\"\n                      >\n                        <Edit className=\"w-3.5 h-3.5 mr-2\" />\n                        {record.description ? \"Edit description\" : \"Add description\"}\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n            \n            <Tabs defaultValue={defaultTab} className=\"mt-6\">\n              <TabsList className=\"w-full\">\n                <TabsTrigger value=\"activity\" className=\"flex-1\">Activity</TabsTrigger>\n                <TabsTrigger value=\"notes\" className=\"flex-1\">Notes</TabsTrigger>\n                <TabsTrigger value=\"quotes\" className=\"flex-1\">Quotes</TabsTrigger>\n                <TabsTrigger value=\"tasks\" className=\"flex-1\">Tasks</TabsTrigger>\n              </TabsList>\n              \n              <TabsContent value=\"activity\" className=\"pt-4\">\n                <Card className=\"mb-2 p-6\">\n                  <ActivityLog contactId={record.id} pageSize={10} context=\"contact\" />\n                </Card>\n              </TabsContent>\n              \n              <TabsContent value=\"notes\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <UnifiedNotesIterator\n                    reference=\"contacts\"\n                    showStatus\n                    contactId={record.id}\n                    leadId={record.id}\n                    dealIds={dealIds}\n                  />\n                </RecordContextProvider>\n              </TabsContent>\n              \n              <TabsContent value=\"quotes\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <AddQuote />\n                </RecordContextProvider>\n                {quotes && quotes.length > 0 && (\n                  <div className=\"mt-4 space-y-2\">\n                    {quotes.map((quote) => (\n                      <QuoteItem quote={quote} key={quote.id} />\n                    ))}\n                  </div>\n                )}\n              </TabsContent>\n              \n              <TabsContent value=\"tasks\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <AddTask />\n                </RecordContextProvider>\n                <div className=\"mt-4 space-y-6\">\n                  {tasks && tasks.length > 0 ? (\n                    <>\n                      {groupedTasks.overdue.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Overdue\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.overdue.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.today.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Today\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.today.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.tomorrow.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Tomorrow\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.tomorrow.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.thisWeek.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            This Week\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.thisWeek.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.later.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Later\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.later.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.completed.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            className=\"cursor-pointer\"\n                            onClick={() => setShowCompletedTasks((v) => !v)}\n                          >\n                            {showCompletedTasks ? \"Hide\" : \"Show\"} completed (\n                            {groupedTasks.completed.length})\n                          </Button>\n                          {showCompletedTasks && (\n                            <div className=\"space-y-2\">\n                              {groupedTasks.completed.map((task) => (\n                                <TaskComponent task={task} key={task.id} />\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </>\n                  ) : (\n                    <p className=\"text-sm text-muted-foreground\">No tasks yet</p>\n                  )}\n                </div>\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n      <ContactAside deals={sortedDeals} />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactMergeButton.tsx",
      "content": "import { useState, useEffect } from \"react\";\nimport { Merge, CircleX, AlertTriangle, ArrowDown } from \"lucide-react\";\nimport {\n  useDataProvider,\n  useRecordContext,\n  useGetList,\n  useGetManyReference,\n  required,\n  Form,\n  useNotify,\n  useRedirect,\n} from \"ra-core\";\nimport type { Identifier } from \"ra-core\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport type { Contact } from \"../types\";\nimport { contactOptionText } from \"../misc/ContactOption\";\n\nexport const ContactMergeButton = () => {\n  const [mergeDialogOpen, setMergeDialogOpen] = useState(false);\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        className=\"h-6 cursor-pointer\"\n        size=\"sm\"\n        onClick={() => setMergeDialogOpen(true)}\n      >\n        <Merge className=\"w-4 h-4\" />\n        Merge with another contact\n      </Button>\n      <ContactMergeDialog\n        open={mergeDialogOpen}\n        onClose={() => setMergeDialogOpen(false)}\n      />\n    </>\n  );\n};\n\ninterface ContactMergeDialogProps {\n  open: boolean;\n  onClose: () => void;\n}\n\nconst ContactMergeDialog = ({ open, onClose }: ContactMergeDialogProps) => {\n  const loserContact = useRecordContext<Contact>();\n  const notify = useNotify();\n  const redirect = useRedirect();\n  const dataProvider = useDataProvider();\n  const [winnerId, setWinnerId] = useState<Identifier | null>(null);\n  const [suggestedWinnerId, setSuggestedWinnerId] = useState<Identifier | null>(\n    null,\n  );\n  const [isMerging, setIsMerging] = useState(false);\n  const { mutateAsync } = useMutation({\n    mutationKey: [\"contacts\", \"merge\", { loserId: loserContact?.id, winnerId }],\n    mutationFn: async () => {\n      return dataProvider.mergeContacts(loserContact?.id, winnerId);\n    },\n  });\n\n  // Find potential contacts with matching first and last name\n  const { data: matchingContacts } = useGetList(\n    \"contacts\",\n    {\n      filter: {\n        first_name: loserContact?.first_name,\n        last_name: loserContact?.last_name,\n        \"id@neq\": `${loserContact?.id}`, // Exclude current contact\n      },\n      pagination: { page: 1, perPage: 10 },\n    },\n    { enabled: open && !!loserContact },\n  );\n\n  // Get counts of items to be merged\n  const canFetchCounts = open && !!loserContact && !!winnerId;\n  const { total: tasksCount } = useGetManyReference(\n    \"tasks\",\n    {\n      target: \"contact_id\",\n      id: loserContact?.id,\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  const { total: notesCount } = useGetManyReference(\n    \"contactNotes\",\n    {\n      target: \"contact_id\",\n      id: loserContact?.id,\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  const { total: dealsCount } = useGetList(\n    \"deals\",\n    {\n      filter: { \"contact_ids@cs\": `{${loserContact?.id}}` },\n      pagination: { page: 1, perPage: 1 },\n    },\n    { enabled: canFetchCounts },\n  );\n\n  useEffect(() => {\n    if (matchingContacts && matchingContacts.length > 0) {\n      const suggestedWinnerId = matchingContacts[0].id;\n      setSuggestedWinnerId(suggestedWinnerId);\n      setWinnerId(suggestedWinnerId);\n    }\n  }, [matchingContacts]);\n\n  const handleMerge = async () => {\n    if (!winnerId || !loserContact) {\n      notify(\"Please select a contact to merge with\", { type: \"warning\" });\n      return;\n    }\n\n    try {\n      setIsMerging(true);\n      await mutateAsync();\n      setIsMerging(false);\n      notify(\"Contacts merged successfully\", { type: \"success\" });\n      redirect(`/contacts/${winnerId}/show`);\n      onClose();\n    } catch (error) {\n      setIsMerging(false);\n      notify(\"Failed to merge contacts\", { type: \"error\" });\n      console.error(\"Merge failed:\", error);\n    }\n  };\n\n  if (!loserContact) return null;\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"md:min-w-lg max-w-2xl\">\n        <DialogHeader>\n          <DialogTitle>Merge Contact</DialogTitle>\n          <DialogDescription>\n            Merge this contact with another one.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"p-4 bg-primary/5 rounded-lg border border-primary/20\">\n            <p className=\"font-medium text-sm\">\n              Current Contact (will be deleted)\n            </p>\n            <div className=\"font-medium text-sm mt-4\">{contactOptionText}</div>\n\n            <div className=\"flex justify-center my-4\">\n              <ArrowDown className=\"h-5 w-5 text-muted-foreground\" />\n            </div>\n\n            <p className=\"font-medium text-sm mb-2\">\n              Target Contact (will be kept)\n            </p>\n            <Form>\n              <ReferenceInput\n                source=\"winner_id\"\n                reference=\"contacts\"\n                filter={{ \"id@neq\": loserContact.id }}\n              >\n                <AutocompleteInput\n                  label=\"\"\n                  optionText={contactOptionText}\n                  validate={required()}\n                  onChange={setWinnerId}\n                  defaultValue={suggestedWinnerId}\n                  helperText={false}\n                />\n              </ReferenceInput>\n            </Form>\n          </div>\n\n          {winnerId && (\n            <>\n              <div className=\"space-y-2\">\n                <p className=\"font-medium text-sm\">What will be merged:</p>\n                <ul className=\"text-sm text-muted-foreground space-y-1 ml-4\">\n                  {notesCount != null && notesCount > 0 && (\n                    <li>\n                      â€¢ {notesCount} note\n                      {notesCount !== 1 ? \"s\" : \"\"} will be reassigned\n                    </li>\n                  )}\n                  {tasksCount != null && tasksCount > 0 && (\n                    <li>\n                      â€¢ {tasksCount} task\n                      {tasksCount !== 1 ? \"s\" : \"\"} will be reassigned\n                    </li>\n                  )}\n                  {dealsCount != null && dealsCount > 0 && (\n                    <li>\n                      â€¢ {dealsCount} deal\n                      {dealsCount !== 1 ? \"s\" : \"\"} will be updated\n                    </li>\n                  )}\n                  {loserContact.email_jsonb?.length > 0 && (\n                    <li>\n                      â€¢ {loserContact.email_jsonb.length} email address\n                      {loserContact.email_jsonb.length !== 1 ? \"es\" : \"\"} will\n                      be added\n                    </li>\n                  )}\n                  {loserContact.phone_jsonb?.length > 0 && (\n                    <li>\n                      â€¢ {loserContact.phone_jsonb.length} phone number\n                      {loserContact.phone_jsonb.length !== 1 ? \"s\" : \"\"} will be\n                      added\n                    </li>\n                  )}\n                  {!notesCount &&\n                    !tasksCount &&\n                    !dealsCount &&\n                    !loserContact.email_jsonb?.length &&\n                    !loserContact.phone_jsonb?.length && (\n                      <li className=\"text-muted-foreground/60\">\n                        No additional data to merge\n                      </li>\n                    )}\n                </ul>\n              </div>\n              <Alert variant=\"destructive\">\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertTitle>Warning: Destructive Operation</AlertTitle>\n                <AlertDescription>\n                  All data will be transferred to the second contact. This\n                  action cannot be undone.\n                </AlertDescription>\n              </Alert>\n            </>\n          )}\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"ghost\" onClick={onClose} disabled={isMerging}>\n            <CircleX />\n            Cancel\n          </Button>\n          <Button onClick={handleMerge} disabled={!winnerId || isMerging}>\n            <Merge />\n            {isMerging ? \"Merging...\" : \"Merge Contacts\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactListFilter.tsx",
      "content": "import { subMonths } from \"date-fns\";\nimport isEqual from \"lodash/isEqual\";\nimport {\n  CheckSquare,\n  Clock,\n  Stethoscope,\n  Tag,\n  TrendingUp,\n  Users,\n} from \"lucide-react\";\nimport {\n  FilterLiveForm,\n  useGetIdentity,\n  useGetList,\n  useListContext,\n} from \"ra-core\";\n\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { FilterOptionButton } from \"../filters/FilterOptionButton\";\nimport {\n  buildInFilter,\n  buildOverlapFilter,\n  parseInFilter,\n  parseOverlapFilter,\n  RangeFilter,\n  toggleValueInList,\n} from \"../filters/filterUtils\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport {\n  crmEndOfYesterday,\n  crmStartOfMonth,\n  crmStartOfWeek,\n} from \"../misc/timezone\";\n\nexport const ContactListFilter = () => {\n  const { filterValues = {}, setFilters } = useListContext();\n  const { leadStages } = useConfigurationContext();\n  const { identity } = useGetIdentity();\n  const { data } = useGetList(\"tags\", {\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: salesData } = useGetList(\"sales\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"first_name\", order: \"ASC\" },\n  });\n\n  const startOfWeek = crmStartOfWeek();\n  const startOfMonth = crmStartOfMonth();\n  const endOfYesterday = crmEndOfYesterday();\n  const lastSeenRanges = Array.isArray(filterValues.last_seen_ranges)\n    ? (filterValues.last_seen_ranges as RangeFilter[])\n    : [];\n  const selectedLeadStages = parseInFilter(filterValues[\"lead_stage@in\"]);\n  const selectedServices = parseOverlapFilter(\n    filterValues[\"services_interested@ov\"],\n  );\n  const selectedTags = parseOverlapFilter(filterValues[\"tags@ov\"]);\n  const selectedManagers = parseInFilter(filterValues[\"sales_id@in\"]);\n  const hasPendingTasks =\n    typeof filterValues[\"nb_tasks@gt\"] !== \"undefined\" &&\n    filterValues[\"nb_tasks@gt\"] !== null;\n\n  const updateFilters = (changes: Record<string, unknown>) => {\n    const next = { ...filterValues, ...changes };\n    Object.entries(changes).forEach(([key, value]) => {\n      if (\n        value === undefined ||\n        value === null ||\n        (Array.isArray(value) && value.length === 0)\n      ) {\n        delete next[key];\n      }\n    });\n    setFilters(next);\n  };\n\n  const toggleLastSeenRange = (range: RangeFilter) => {\n    const isSelected = lastSeenRanges.some((item) => isEqual(item, range));\n    const nextRanges = isSelected\n      ? lastSeenRanges.filter((item) => !isEqual(item, range))\n      : [...lastSeenRanges, range];\n    updateFilters({\n      last_seen_ranges: nextRanges.length ? nextRanges : undefined,\n    });\n  };\n\n  const toggleLeadStage = (value: string) => {\n    const next = toggleValueInList(selectedLeadStages, value);\n    updateFilters({ \"lead_stage@in\": buildInFilter(next) });\n  };\n\n  const toggleService = (id: number) => {\n    const next = toggleValueInList(selectedServices, id);\n    updateFilters({ \"services_interested@ov\": buildOverlapFilter(next) });\n  };\n\n  const toggleTag = (id: number) => {\n    const next = toggleValueInList(selectedTags, id);\n    updateFilters({ \"tags@ov\": buildOverlapFilter(next) });\n  };\n\n  const toggleManager = (id: string | number | undefined) => {\n    if (typeof id === \"undefined\") return;\n    const next = toggleValueInList(selectedManagers, id);\n    updateFilters({ \"sales_id@in\": buildInFilter(next) });\n  };\n\n  const toggleTasks = () => {\n    if (hasPendingTasks) {\n      updateFilters({ \"nb_tasks@gt\": undefined });\n    } else {\n      updateFilters({ \"nb_tasks@gt\": 0 });\n    }\n  };\n\n  const clearLastSeen = () => updateFilters({ last_seen_ranges: undefined });\n  const clearStatuses = () => updateFilters({ \"lead_stage@in\": undefined });\n  const clearServices = () =>\n    updateFilters({ \"services_interested@ov\": undefined });\n  const clearTags = () => updateFilters({ \"tags@ov\": undefined });\n  const clearManagers = () => updateFilters({ \"sales_id@in\": undefined });\n\n  return (\n    <div className=\"w-52 min-w-52 order-first pt-0.75 flex flex-col gap-4\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" placeholder=\"Search name, company...\" />\n      </FilterLiveForm>\n\n      <FilterCategory\n        label=\"Last activity\"\n        icon={<Clock />}\n        count={lastSeenRanges.length}\n        onClear={clearLastSeen}\n      >\n        <FilterOptionButton\n          label=\"Today\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              gte: endOfYesterday?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              gte: endOfYesterday?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"This week\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              gte: startOfWeek?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              gte: startOfWeek?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before this week\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: startOfWeek?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: startOfWeek?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before this month\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: startOfMonth?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: startOfMonth?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before last month\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: subMonths(startOfMonth ?? new Date(), 1).toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: subMonths(startOfMonth ?? new Date(), 1).toISOString(),\n            })\n          }\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Status\"\n        icon={<TrendingUp />}\n        count={selectedLeadStages.length}\n        onClear={clearStatuses}\n      >\n        {leadStages.map((stage) => (\n          <FilterOptionButton\n            key={stage.value}\n            label={stage.label}\n            selected={selectedLeadStages.includes(stage.value)}\n            onToggle={() => toggleLeadStage(stage.value)}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Services interested in\"\n        icon={<Stethoscope />}\n        count={selectedServices.length}\n        onClear={clearServices}\n      >\n        {servicesData && servicesData.length > 0 ? (\n          servicesData.map((service) => (\n            <FilterOptionButton\n              key={service.id}\n              label={service.name}\n              selected={selectedServices.includes(String(service.id))}\n              onToggle={() => toggleService(service.id)}\n            />\n          ))\n        ) : (\n          <div className=\"text-xs text-muted-foreground\">\n            No services available\n          </div>\n        )}\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Tags\"\n        icon={<Tag />}\n        count={selectedTags.length}\n        onClear={clearTags}\n      >\n        {data &&\n          data.map((record) => (\n            <FilterOptionButton\n              key={record.id}\n              label={\n                <Badge\n                  variant=\"secondary\"\n                  className=\"text-black text-xs font-normal cursor-pointer\"\n                  style={{\n                    backgroundColor: record?.color,\n                  }}\n                >\n                  {record?.name}\n                </Badge>\n              }\n              selected={selectedTags.includes(String(record.id))}\n              onToggle={() => toggleTag(record.id)}\n            />\n          ))}\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<CheckSquare />}\n        label=\"Tasks\"\n        count={hasPendingTasks ? 1 : 0}\n        onClear={() => updateFilters({ \"nb_tasks@gt\": undefined })}\n      >\n        <FilterOptionButton\n          label={\"With pending tasks\"}\n          selected={hasPendingTasks}\n          onToggle={toggleTasks}\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<Users />}\n        label=\"Account Manager\"\n        count={selectedManagers.length}\n        onClear={clearManagers}\n      >\n        <FilterOptionButton\n          label={\"Me\"}\n          selected={selectedManagers.includes(String(identity?.id))}\n          onToggle={() => toggleManager(identity?.id)}\n        />\n        {salesData &&\n          salesData\n            .filter((manager) => manager.id !== identity?.id)\n            .map((manager) => (\n              <FilterOptionButton\n                key={manager.id}\n                label={`${manager.first_name} ${manager.last_name}`}\n                selected={selectedManagers.includes(String(manager.id))}\n                onToggle={() => toggleManager(manager.id)}\n              />\n            ))}\n      </FilterCategory>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactListContent.tsx",
      "content": "import { RecordContextProvider, useListContext, useGetList } from \"ra-core\";\nimport { type MouseEvent, useCallback, useMemo, useRef } from \"react\";\nimport { Link } from \"react-router\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport { Status } from \"../misc/Status\";\nimport type { Contact, Deal } from \"../types\";\nimport { TagsList } from \"./TagsList\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { formatRelativeOrDate } from \"../misc/timezone\";\n\n// Helper function to get badge color for lead stage\nconst getStageBadgeColor = (stage: string): string => {\n  switch (stage) {\n    case \"new\":\n      return \"bg-blue-500 hover:bg-blue-600\";\n    case \"contacted\":\n      return \"bg-yellow-500 hover:bg-yellow-600\";\n    case \"quoted\":\n      return \"bg-purple-500 hover:bg-purple-600\";\n    case \"qualified\":\n      return \"bg-green-500 hover:bg-green-600\";\n    case \"not-qualified\":\n      return \"bg-red-500 hover:bg-red-600\";\n    case \"converted\":\n      return \"bg-emerald-600 hover:bg-emerald-700\";\n    default:\n      return \"bg-gray-500 hover:bg-gray-600\";\n  }\n};\n\nexport const ContactListContent = () => {\n  const {\n    data: contacts,\n    error,\n    isPending,\n    onSelect,\n    onToggleItem,\n    selectedIds,\n  } = useListContext<Contact>();\n  const isSmall = useIsMobile();\n  const { leadStages } = useConfigurationContext();\n  const lastClickedIndexRef = useRef<number | null>(null);\n\n  // Fetch all deals to get contact stages and identify clients\n  const { data: allDeals } = useGetList<Deal>(\"lead-journey\", {\n    pagination: { page: 1, perPage: 10000 },\n    sort: { field: \"id\", order: \"ASC\" },\n    filter: { \"archived_at@is\": null, \"lead_id@not.is\": null },\n  }, { enabled: !isPending });\n\n  // Create a map of contact ID to deal stage\n  const contactStageMap = useMemo(() => {\n    if (!allDeals) return new Map<number | string, string>();\n    const map = new Map<number | string, string>();\n    allDeals.forEach((deal) => {\n      if (deal.lead_id) {\n        map.set(deal.lead_id, deal.stage);\n      }\n    });\n    return map;\n  }, [allDeals]);\n\n  // Create a Set of client contact IDs for quick lookup\n  const clientContactIds = useMemo(() => {\n    if (!allDeals) return new Set<number | string>();\n    return new Set(\n      allDeals\n        .filter((deal) => deal.stage === \"converted\")\n        .map((deal) => deal.lead_id)\n        .filter((id): id is number | string => id !== undefined && id !== null)\n    );\n  }, [allDeals]);\n\n  // StopPropagation does not work for some reason on Checkbox, this handler is a workaround\n  const handleLinkClick = useCallback(function handleLinkClick(\n    e: MouseEvent<HTMLAnchorElement>,\n  ) {\n    // Prevent navigation if clicking on checkbox or if shift key is pressed\n    if (\n      e.target instanceof HTMLButtonElement ||\n      (e.target as HTMLElement).closest('[data-slot=\"checkbox\"]') ||\n      e.shiftKey\n    ) {\n      e.preventDefault();\n    }\n  }, []);\n\n  const handleCheckboxClick = useCallback(\n    (contactId: number | string, index: number, event: MouseEvent) => {\n      event.stopPropagation();\n      event.preventDefault();\n      \n      if (event.shiftKey && lastClickedIndexRef.current !== null) {\n        // Shift-click: select range from last clicked to current\n        const start = Math.min(lastClickedIndexRef.current, index);\n        const end = Math.max(lastClickedIndexRef.current, index);\n        const rangeIds = contacts\n          .slice(start, end + 1)\n          .map((contact) => contact.id);\n        \n        // Click would toggle the current item, so apply the *toggled* state to the whole range.\n        // Use onSelect (set selected IDs in one shot) to avoid flaky toggling/batching issues.\n        const currentIsSelected = selectedIds.includes(contactId);\n        const targetIsSelected = !currentIsSelected;\n\n        if (onSelect) {\n          const rangeSet = new Set(rangeIds);\n          const selectedSet = new Set(selectedIds);\n          if (targetIsSelected) {\n            rangeIds.forEach((id) => selectedSet.add(id));\n          } else {\n            selectedIds.forEach((id) => {\n              if (rangeSet.has(id)) selectedSet.delete(id);\n            });\n          }\n          onSelect(Array.from(selectedSet));\n        } else {\n          // Fallback (should rarely happen): toggle items to match target state\n          rangeIds.forEach((id) => {\n            const isSelected = selectedIds.includes(id);\n            if (isSelected !== targetIsSelected) {\n              onToggleItem(id);\n            }\n          });\n        }\n      } else {\n        // Normal click: toggle single item\n        onToggleItem(contactId);\n      }\n      lastClickedIndexRef.current = index;\n    },\n    [contacts, onSelect, onToggleItem, selectedIds],\n  );\n\n  if (isPending) {\n    return <Skeleton className=\"w-full h-9\" />;\n  }\n\n  if (error) {\n    return null;\n  }\n  const now = Date.now();\n\n  return (\n    <div className=\"divide-y\">\n      {contacts.map((contact, index) => (\n        <RecordContextProvider key={contact.id} value={contact}>\n          <Link\n            to={`/contacts/${contact.id}/show`}\n            className=\"flex flex-row gap-4 items-center px-4 py-2 hover:bg-muted transition-colors first:rounded-t-xl last:rounded-b-xl\"\n            onClick={handleLinkClick}\n          >\n            <div \n              onClick={(e) => {\n                e.stopPropagation();\n                e.preventDefault();\n              }}\n            >\n              <Checkbox\n                className=\"cursor-pointer\"\n                checked={selectedIds.includes(contact.id)}\n                // Use mousedown to reliably capture shiftKey with Radix checkbox\n                onMouseDown={(e) => handleCheckboxClick(contact.id, index, e)}\n                // Prevent Radix default click toggling; selection is controlled by react-admin\n                onClick={(e) => {\n                  e.preventDefault();\n                  e.stopPropagation();\n                }}\n              />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"font-medium flex items-center gap-2\">\n                {`${contact.first_name ?? \"\"} ${contact.last_name ?? \"\"}`.trim() || \"New Lead\"}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">\n                {contact.title}\n                {contact.title && contact.company_id != null && \" at \"}\n                {contact.company_id != null && (\n                  <ReferenceField\n                    source=\"company_id\"\n                    reference=\"companies\"\n                    link={false}\n                  >\n                    <TextField source=\"name\" />\n                  </ReferenceField>\n                )}\n                {contact.nb_tasks\n                  ? ` - ${contact.nb_tasks} task${\n                      contact.nb_tasks > 1 ? \"s\" : \"\"\n                    }`\n                  : \"\"}\n                &nbsp;&nbsp;\n                <TagsList />\n              </div>\n            </div>\n            {contact.last_seen && (\n              <div className=\"text-right ml-4 flex items-center gap-2\">\n                {/* Lead Stage Badge */}\n                {(() => {\n                  const stage = contactStageMap.get(contact.id);\n                  if (stage) {\n                    const stageConfig = leadStages.find((s) => s.value === stage);\n                    const label = stage === \"converted\" ? \"Client\" : (stageConfig?.label || stage);\n                    return (\n                      <Badge\n                        variant=\"default\"\n                        className={`text-xs text-white ${getStageBadgeColor(stage)}`}\n                      >\n                        {label}\n                      </Badge>\n                    );\n                  }\n                  return null;\n                })()}\n                <div\n                  className=\"text-sm text-muted-foreground\"\n                  title={contact.last_seen}\n                >\n                  {!isSmall && \"last activity \"}\n                  {formatRelativeOrDate(contact.last_seen, new Date(now))}{\" \"}\n                  <Status status={contact.status} />\n                </div>\n              </div>\n            )}\n          </Link>\n        </RecordContextProvider>\n      ))}\n\n      {contacts.length === 0 && (\n        <div className=\"p-4\">\n          <div className=\"text-muted-foreground\">No contacts found</div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactList.tsx",
      "content": "import jsonExport from \"jsonexport/dist\";\nimport {\n  downloadCSV,\n  useDataProvider,\n  useGetIdentity,\n  useListContext,\n  useNotify,\n  useRefresh,\n  type Exporter,\n} from \"ra-core\";\nimport { BulkActionsToolbar } from \"@/components/admin/bulk-actions-toolbar\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SortButton } from \"@/components/admin/sort-button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Layers } from \"lucide-react\";\nimport * as React from \"react\";\n\nimport type { Company, Contact, Sale, Tag } from \"../types\";\nimport { ContactEmpty } from \"./ContactEmpty\";\nimport { ContactImportButton } from \"./ContactImportButton\";\nimport { ContactListContent } from \"./ContactListContent\";\nimport { ContactListFilter } from \"./ContactListFilter\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\n\nexport const ContactList = () => {\n  const { identity } = useGetIdentity();\n\n  if (!identity) return null;\n\n  return (\n    <List\n      title={false}\n      actions={<ContactListActions />}\n      perPage={25}\n      sort={{ field: \"last_seen\", order: \"DESC\" }}\n      exporter={exporter}\n    >\n      <ContactListLayout />\n    </List>\n  );\n};\n\nconst ContactListLayout = () => {\n  const { data, isPending, filterValues } = useListContext();\n  const { identity } = useGetIdentity();\n\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  if (!identity || isPending) return null;\n\n  if (!data?.length && !hasFilters) return <ContactEmpty />;\n\n  return (\n    <div className=\"flex flex-row gap-8\">\n      <ContactListFilter />\n      <div className=\"w-full flex flex-col gap-4\">\n        <Card className=\"py-0\">\n          <ContactListContent />\n        </Card>\n      </div>\n      <BulkActionsToolbar />\n    </div>\n  );\n};\n\nconst ContactListActions = () => {\n  const { filterValues = {}, setFilters } = useListContext<Contact>();\n  \n  // Parse current lead_stage filter\n  const parseLeadStages = (filter: string | undefined): string[] => {\n    if (!filter) return [];\n    return filter\n      .replace(/[()]/g, \"\")\n      .split(\",\")\n      .map((s) => s.trim())\n      .filter(Boolean);\n  };\n\n  const currentStages = parseLeadStages(filterValues[\"lead_stage@in\"] as string | undefined);\n  const hasConverted = currentStages.includes(\"converted\");\n  const allNonConvertedStages = [\"new\", \"contacted\", \"quoted\", \"qualified\", \"not-qualified\"];\n  \n  // Determine if clients should be shown based on current filter\n  const shouldShowClients = React.useMemo(() => {\n    if (currentStages.length === 0) return true; // No filter = show all\n    if (hasConverted) return true; // \"converted\" is included\n    // Check if filter only contains non-converted stages (clients hidden)\n    const onlyNonConverted = currentStages.length > 0 && \n      currentStages.every((s) => allNonConvertedStages.includes(s));\n    return !onlyNonConverted; // If only non-converted, clients are hidden\n  }, [currentStages, hasConverted, allNonConvertedStages]);\n\n  const handleToggleClients = (checked: boolean) => {\n    const updated = { ...filterValues };\n\n    if (checked) {\n      // Show clients: include \"converted\" or remove exclusion\n      if (currentStages.length === 0) {\n        // No filter, show all (including clients) - remove filter\n        delete updated[\"lead_stage@in\"];\n      } else if (hasConverted) {\n        // Already includes \"converted\", do nothing\n        return;\n      } else {\n        // Add \"converted\" to existing stages\n        const newStages = [...currentStages, \"converted\"];\n        updated[\"lead_stage@in\"] = `(${newStages.join(\",\")})`;\n      }\n    } else {\n      // Hide clients: exclude \"converted\" stage\n      const stagesWithoutConverted = currentStages.filter((s) => s !== \"converted\");\n      \n      if (stagesWithoutConverted.length > 0) {\n        // Keep other selected stages, exclude \"converted\"\n        updated[\"lead_stage@in\"] = `(${stagesWithoutConverted.join(\",\")})`;\n      } else {\n        // No other stages selected, show all non-converted stages\n        updated[\"lead_stage@in\"] = `(${allNonConvertedStages.join(\",\")})`;\n      }\n    }\n\n    setFilters(updated);\n  };\n\n  return (\n    <TopToolbar>\n      <SortButton fields={[\"first_name\", \"last_name\", \"last_seen\"]} />\n      <ContactImportButton />\n      <ExportButton exporter={exporter} />\n      <BulkLeadStageButton />\n      <div className=\"flex items-center gap-2 px-2\">\n        <Switch\n          id=\"show-clients\"\n          checked={shouldShowClients}\n          onCheckedChange={handleToggleClients}\n        />\n        <Label htmlFor=\"show-clients\" className=\"text-sm font-normal cursor-pointer\">\n          Show Clients\n        </Label>\n      </div>\n      <CreateButton />\n    </TopToolbar>\n  );\n};\n\nconst BulkLeadStageButton = () => {\n  const { selectedIds } = useListContext<Contact>();\n  const { leadStages } = useConfigurationContext();\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const [open, setOpen] = React.useState(false);\n  const [stage, setStage] = React.useState<string>(\"new\");\n  const [isSaving, setIsSaving] = React.useState(false);\n\n  const selectedCount = selectedIds?.length ?? 0;\n\n  const stageOptions = React.useMemo(() => {\n    // Ensure we only show the stages requested (and keep order stable)\n    const allowed = new Set([\n      \"new\",\n      \"contacted\",\n      \"quoted\",\n      \"qualified\",\n      \"not-qualified\",\n      \"converted\",\n    ]);\n    const fromConfig =\n      leadStages?.filter((s) => allowed.has(s.value)) ?? [];\n    if (fromConfig.length > 0) return fromConfig;\n    // Fallback (in case config is missing)\n    return [\n      { value: \"new\", label: \"New\" },\n      { value: \"contacted\", label: \"Contacted\" },\n      { value: \"quoted\", label: \"Quoted\" },\n      { value: \"qualified\", label: \"Qualified\" },\n      { value: \"not-qualified\", label: \"Not Qualified\" },\n      { value: \"converted\", label: \"Converted\" },\n    ];\n  }, [leadStages]);\n\n  const selectedStageLabel =\n    stageOptions.find((s) => s.value === stage)?.label ?? stage;\n\n  const handleOpen = (e: React.MouseEvent<HTMLButtonElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (!selectedCount) {\n      notify(\"Select at least one lead first\", { type: \"info\" });\n      return;\n    }\n    setOpen(true);\n  };\n\n  const handleConfirm = async (e: React.MouseEvent<HTMLButtonElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (!selectedCount) return;\n\n    setIsSaving(true);\n    try {\n      // Fetch deals for selected leads (contacts)\n      const { data: deals } = await dataProvider.getList(\"lead-journey\", {\n        pagination: { page: 1, perPage: 10000 },\n        sort: { field: \"id\", order: \"ASC\" },\n        filter: {\n          \"archived_at@is\": null,\n          \"lead_id@in\": `(${selectedIds.join(\",\")})`,\n        },\n      });\n\n      const dealsToUpdate = Array.isArray(deals) ? deals : [];\n\n      if (dealsToUpdate.length === 0) {\n        notify(\"No lead journey records found for selected leads\", {\n          type: \"info\",\n        });\n        setOpen(false);\n        return;\n      }\n\n      await Promise.all(\n        dealsToUpdate.map((deal: any) =>\n          dataProvider.update(\"lead-journey\", {\n            id: deal.id,\n            data: { stage },\n            previousData: deal,\n          }),\n        ),\n      );\n\n      notify(\n        `${selectedCount} lead${selectedCount === 1 ? \"\" : \"s\"} updated to ${selectedStageLabel}`,\n        { type: \"success\" },\n      );\n      setOpen(false);\n      refresh();\n    } catch (error: any) {\n      console.error(\"BulkLeadStageButton: update failed\", error);\n      notify(\"Failed to update lead stage\", { type: \"error\" });\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  return (\n    <>\n      <Button\n        type=\"button\"\n        variant=\"outline\"\n        className=\"flex items-center gap-2 h-9\"\n        onClick={handleOpen}\n        disabled={isSaving}\n        title={\n          selectedCount\n            ? `Change stage for ${selectedCount} selected lead${selectedCount === 1 ? \"\" : \"s\"}`\n            : \"Select leads to enable\"\n        }\n      >\n        <Layers className=\"h-4 w-4\" />\n        Bulk Stage\n      </Button>\n\n      <Dialog open={open} onOpenChange={(v) => !isSaving && setOpen(v)}>\n        <DialogContent\n          onPointerDownOutside={(e) => {\n            if (isSaving) e.preventDefault();\n          }}\n        >\n          <DialogHeader>\n            <DialogTitle>Bulk change lead stage</DialogTitle>\n            <DialogDescription>\n              Update the stage for {selectedCount} selected lead\n              {selectedCount === 1 ? \"\" : \"s\"}.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"flex flex-col gap-2\">\n            <div className=\"text-sm font-medium\">New stage</div>\n            <Select value={stage} onValueChange={setStage}>\n              <SelectTrigger className=\"w-full\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {stageOptions.map((opt) => (\n                  <SelectItem key={opt.value} value={opt.value}>\n                    {opt.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <DialogFooter>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setOpen(false)}\n              disabled={isSaving}\n            >\n              Cancel\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"default\"\n              onClick={handleConfirm}\n              disabled={isSaving || !selectedCount}\n            >\n              {isSaving ? \"Updating...\" : \"Update stage\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n};\n\nconst exporter: Exporter<Contact> = async (records, fetchRelatedRecords) => {\n  const companies = await fetchRelatedRecords<Company>(\n    records,\n    \"company_id\",\n    \"companies\",\n  );\n  const sales = await fetchRelatedRecords<Sale>(records, \"sales_id\", \"sales\");\n  const tags = await fetchRelatedRecords<Tag>(records, \"tags\", \"tags\");\n\n  const contacts = records.map((contact) => {\n    const exportedContact = {\n      id: contact.id,\n      first_name: contact.first_name || \"\",\n      last_name: contact.last_name || \"\",\n      gender: contact.gender || \"\",\n      email_jsonb: JSON.stringify(contact.email_jsonb || []),\n      phone_jsonb: JSON.stringify(contact.phone_jsonb || []),\n      flat_villa_number: contact.flat_villa_number || \"\",\n      building_street: contact.building_street || \"\",\n      area: contact.area || \"\",\n      google_maps_link: contact.google_maps_link || \"\",\n      phone_has_whatsapp: contact.phone_has_whatsapp ? \"TRUE\" : \"FALSE\",\n      services_interested: Array.isArray(contact.services_interested)\n        ? contact.services_interested.join(\";\")\n        : \"\",\n      description: contact.description || \"\",\n      first_seen: contact.first_seen || \"\",\n      last_seen: contact.last_seen || \"\",\n      tags: contact.tags.map((tagId) => tags[tagId]?.name || \"\").filter(Boolean).join(\", \") || \"\",\n      sales_id: contact.sales_id || \"\",\n      nb_tasks: contact.nb_tasks || 0,\n      sales: sales[contact.sales_id]\n        ? `${sales[contact.sales_id].first_name} ${sales[contact.sales_id].last_name}`\n        : \"\",\n    };\n    return exportedContact;\n  });\n  return jsonExport(contacts, {}, (_err: any, csv: string) => {\n    downloadCSV(csv, \"contacts\");\n  });\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactInputs.tsx",
      "content": "import { email, required } from \"ra-core\";\nimport type { FocusEvent, ClipboardEventHandler } from \"react\";\nimport { useFormContext } from \"react-hook-form\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { BooleanInput } from \"@/components/admin/boolean-input\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { RadioButtonGroupInput } from \"@/components/admin/radio-button-group-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { ArrayInput } from \"@/components/admin/array-input\";\nimport { SimpleFormIterator } from \"@/components/admin/simple-form-iterator\";\n\nimport { isLinkedinUrl } from \"../misc/isLinkedInUrl\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Sale } from \"../types\";\nimport { AutocompleteCompanyInput } from \"../companies/AutocompleteCompanyInput.tsx\";\n\nexport const ContactInputs = () => {\n  const isMobile = useIsMobile();\n\n  return (\n    <div className=\"flex flex-col gap-2 p-1\">\n      <div className={`flex gap-6 ${isMobile ? \"flex-col\" : \"flex-row\"}`}>\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <ContactIdentityInputs />\n          <ContactPositionInputs />\n        </div>\n        <Separator\n          orientation={isMobile ? \"horizontal\" : \"vertical\"}\n          className=\"flex-shrink-0\"\n        />\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <ContactPersonalInformationInputs />\n          <ContactMiscInputs />\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst ContactIdentityInputs = () => {\n  const { contactGender } = useConfigurationContext();\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Identity</h6>\n      <RadioButtonGroupInput\n        label={false}\n        row\n        source=\"gender\"\n        choices={contactGender}\n        helperText={false}\n        optionText=\"label\"\n        optionValue=\"value\"\n        defaultValue={contactGender[0].value}\n      />\n      <TextInput source=\"first_name\" validate={required()} helperText={false} />\n      <TextInput source=\"last_name\" validate={required()} helperText={false} />\n    </div>\n  );\n};\n\nconst ContactPositionInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Position</h6>\n      <TextInput source=\"title\" helperText={false} />\n      <ReferenceInput source=\"company_id\" reference=\"companies\" perPage={10}>\n        <AutocompleteCompanyInput />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst ContactPersonalInformationInputs = () => {\n  const { getValues, setValue } = useFormContext();\n\n  // set first and last name based on email\n  const handleEmailChange = (email: string) => {\n    const { first_name, last_name } = getValues();\n    if (first_name || last_name || !email) return;\n    const [first, last] = email.split(\"@\")[0].split(\".\");\n    setValue(\"first_name\", first.charAt(0).toUpperCase() + first.slice(1));\n    setValue(\n      \"last_name\",\n      last ? last.charAt(0).toUpperCase() + last.slice(1) : \"\",\n    );\n  };\n\n  const handleEmailPaste: ClipboardEventHandler<\n    HTMLTextAreaElement | HTMLInputElement\n  > = (e) => {\n    const email = e.clipboardData?.getData(\"text/plain\");\n    handleEmailChange(email);\n  };\n\n  const handleEmailBlur = (\n    e: FocusEvent<HTMLTextAreaElement | HTMLInputElement>,\n  ) => {\n    const email = e.target.value;\n    handleEmailChange(email);\n  };\n\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Personal info</h6>\n      <ArrayInput\n        source=\"email_jsonb\"\n        label=\"Email addresses\"\n        helperText={false}\n      >\n        <SimpleFormIterator\n          inline\n          disableReordering\n          disableClear\n          className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n        >\n          <TextInput\n            source=\"email\"\n            className=\"w-full\"\n            helperText={false}\n            label={false}\n            placeholder=\"Email\"\n            validate={email()}\n            onPaste={handleEmailPaste}\n            onBlur={handleEmailBlur}\n          />\n          <SelectInput\n            source=\"type\"\n            helperText={false}\n            label={false}\n            optionText=\"id\"\n            choices={personalInfoTypes}\n            defaultValue=\"Work\"\n            className=\"w-24 min-w-24\"\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n      <ArrayInput source=\"phone_jsonb\" label=\"Phone numbers\" helperText={false}>\n        <SimpleFormIterator\n          inline\n          disableReordering\n          disableClear\n          className=\"[&>ul>li]:border-b-0 [&>ul>li]:pb-0\"\n        >\n          <TextInput\n            source=\"number\"\n            className=\"w-full\"\n            helperText={false}\n            label={false}\n            placeholder=\"Phone number\"\n          />\n          <SelectInput\n            source=\"type\"\n            helperText={false}\n            label={false}\n            optionText=\"id\"\n            choices={personalInfoTypes}\n            defaultValue=\"Work\"\n            className=\"w-24 min-w-24\"\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n      <TextInput\n        source=\"linkedin_url\"\n        label=\"Linkedin URL\"\n        helperText={false}\n        validate={isLinkedinUrl}\n      />\n    </div>\n  );\n};\n\nconst personalInfoTypes = [{ id: \"Work\" }, { id: \"Home\" }, { id: \"Other\" }];\n\nconst ContactMiscInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Misc</h6>\n      <TextInput\n        source=\"background\"\n        label=\"Background info (bio, how you met, etc)\"\n        multiline\n        helperText={false}\n      />\n      <BooleanInput source=\"has_newsletter\" helperText={false} />\n      <ReferenceInput\n        reference=\"sales\"\n        source=\"sales_id\"\n        sort={{ field: \"last_name\", order: \"ASC\" }}\n        filter={{\n          \"disabled@neq\": true,\n        }}\n      >\n        <SelectInput\n          helperText={false}\n          label=\"Account manager\"\n          optionText={saleOptionRenderer}\n          validate={required()}\n        />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst saleOptionRenderer = (choice: Sale) =>\n  `${choice.first_name} ${choice.last_name}`;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactImportButton.tsx",
      "content": "import { useEffect, useState } from \"react\";\nimport type { MouseEvent } from \"react\";\nimport { Upload, Loader2, AlertCircle } from \"lucide-react\";\nimport { Form, useRefresh } from \"ra-core\";\nimport { Link } from \"react-router\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { FileInput } from \"@/components/admin/file-input\";\nimport { FileField } from \"@/components/admin/file-field\";\n\nimport { usePapaParse } from \"../misc/usePapaParse\";\nimport type { ContactImportSchema } from \"./useContactImport\";\nimport { useContactImport } from \"./useContactImport\";\nimport { formatImportError } from \"./formatImportError\";\nimport * as sampleCsv from \"./contacts_export.csv?raw\";\n\nexport const ContactImportButton = () => {\n  const [modalOpen, setModalOpen] = useState(false);\n\n  const handleOpenModal = () => {\n    setModalOpen(true);\n  };\n\n  const handleCloseModal = () => {\n    setModalOpen(false);\n  };\n\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        onClick={handleOpenModal}\n        className=\"flex items-center gap-2 cursor-pointer\"\n      >\n        <Upload /> Import\n      </Button>\n      <ContactImportDialog open={modalOpen} onClose={handleCloseModal} />\n    </>\n  );\n};\n\nconst SAMPLE_URL = `data:text/csv;name=crm_contacts_sample.csv;charset=utf-8,${encodeURIComponent(\n  sampleCsv.default,\n)}`;\n\ntype ContactImportModalProps = {\n  open: boolean;\n  onClose(): void;\n};\n\nexport function ContactImportDialog({\n  open,\n  onClose,\n}: ContactImportModalProps) {\n  const refresh = useRefresh();\n  const processBatch = useContactImport();\n  const { importer, parseCsv, reset } = usePapaParse<ContactImportSchema>({\n    batchSize: 10,\n    processBatch,\n  });\n\n  const [file, setFile] = useState<File | null>(null);\n\n  useEffect(() => {\n    if (importer.state === \"complete\") {\n      // Refresh to show imported contacts in lead journey\n      refresh();\n      // Additional refresh after a short delay to ensure backend has processed all lead-journey entries\n      setTimeout(() => {\n        refresh();\n      }, 500);\n    }\n  }, [importer.state, refresh]);\n\n  const handleFileChange = (file: File | null) => {\n    setFile(file);\n  };\n\n  const startImport = () => {\n    if (!file) return;\n    parseCsv(file);\n  };\n\n  const handleClose = () => {\n    reset();\n    onClose();\n  };\n\n  const handleReset = (e: MouseEvent<HTMLButtonElement>) => {\n    e.preventDefault();\n    reset();\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"max-w-2xl\">\n        <Form className=\"flex flex-col gap-4\">\n          <DialogHeader>\n            <DialogTitle>Import</DialogTitle>\n            <DialogDescription className=\"sr-only\">\n              Import contacts from a CSV file. Upload a file to begin the import process.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"flex flex-col space-y-2\">\n            {importer.state === \"running\" && (\n              <div className=\"flex flex-col gap-2\">\n                <Alert>\n                  <AlertDescription className=\"flex flex-row gap-4\">\n                    <Loader2 className=\"h-5 w-5 animate-spin\" />\n                    The import is running, please do not close this tab.\n                  </AlertDescription>\n                </Alert>\n\n                <div className=\"text-sm\">\n                  Imported{\" \"}\n                  <strong>\n                    {importer.importCount} / {importer.rowCount}\n                  </strong>{\" \"}\n                  contacts, with <strong>{importer.errorCount}</strong> errors.\n                  {importer.remainingTime !== null && (\n                    <>\n                      {\" \"}\n                      Estimated remaining time:{\" \"}\n                      <strong>\n                        {millisecondsToTime(importer.remainingTime)}\n                      </strong>\n                      .{\" \"}\n                      <button\n                        onClick={handleReset}\n                        className=\"text-red-600 underline hover:text-red-800\"\n                      >\n                        Stop import\n                      </button>\n                    </>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {importer.state === \"error\" && (\n              <Alert variant=\"destructive\">\n                <AlertCircle className=\"h-5 w-5\" />\n                <AlertDescription>\n                  Failed to import this file: {importer.error.message || \"Please make sure you provided a valid CSV file.\"}\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {(importer.state === \"complete\" || importer.state === \"running\") && importer.errorCount > 0 && (\n              <Alert variant=\"destructive\">\n                <AlertCircle className=\"h-5 w-5\" />\n                <AlertDescription className=\"flex flex-col gap-2\">\n                  <div>\n                    {importer.state === \"complete\" ? (\n                      <>Contacts import complete. Imported {importer.importCount} contacts, with <strong>{importer.errorCount} errors</strong>.</>\n                    ) : (\n                      <>Importing... {importer.errorCount} errors so far.</>\n                    )}\n                  </div>\n                  {importer.errors && importer.errors.length > 0 && (\n                    <Accordion type=\"single\" collapsible className=\"w-full\">\n                      <AccordionItem value=\"errors\" className=\"border-none\">\n                        <AccordionTrigger className=\"py-2 text-sm hover:no-underline\">\n                          View error details ({importer.errors.length})\n                        </AccordionTrigger>\n                        <AccordionContent>\n                          <div className=\"max-h-96 overflow-y-auto space-y-4 pr-2\">\n                            {importer.errors.map((error, index) => {\n                              const formatted = formatImportError(error);\n                              return (\n                                <div\n                                  key={index}\n                                  className=\"rounded-md border border-destructive/20 bg-destructive/5 p-4\"\n                                >\n                                  <div className=\"font-semibold text-base mb-1\">\n                                    Row {formatted.row}: {formatted.title}\n                                  </div>\n                                  <div className=\"text-sm text-muted-foreground mb-3\">\n                                    {formatted.message}\n                                  </div>\n                                  <div className=\"mt-3\">\n                                    <div className=\"text-xs font-medium mb-2 text-foreground\">\n                                      How to fix:\n                                    </div>\n                                    <ol className=\"list-decimal list-inside space-y-1.5 text-xs text-muted-foreground\">\n                                      {formatted.steps.map((step, stepIndex) => (\n                                        <li key={stepIndex} className=\"pl-1\">\n                                          {step}\n                                        </li>\n                                      ))}\n                                    </ol>\n                                  </div>\n                                </div>\n                              );\n                            })}\n                          </div>\n                        </AccordionContent>\n                      </AccordionItem>\n                    </Accordion>\n                  )}\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {importer.state === \"complete\" && importer.errorCount === 0 && (\n              <Alert>\n                <AlertDescription>\n                  Contacts import complete. Successfully imported {importer.importCount} contacts.\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {importer.state === \"idle\" && (\n              <>\n                <Alert>\n                  <AlertDescription className=\"flex flex-col gap-4\">\n                    Here is a sample CSV file you can use as a template\n                    <Button asChild variant=\"outline\" size=\"sm\">\n                      <Link\n                        to={SAMPLE_URL}\n                        download={\"crm_contacts_sample.csv\"}\n                      >\n                        Download CSV sample\n                      </Link>\n                    </Button>{\" \"}\n                  </AlertDescription>\n                </Alert>\n\n                <FileInput\n                  source=\"csv\"\n                  label=\"CSV File\"\n                  accept={{ \"text/csv\": [\".csv\"] }}\n                  onChange={handleFileChange}\n                >\n                  <FileField source=\"src\" title=\"title\" target=\"_blank\" />\n                </FileInput>\n              </>\n            )}\n          </div>\n        </Form>\n\n        <div className=\"flex justify-start pt-6\">\n          <FormToolbar>\n            {importer.state === \"idle\" ? (\n              <Button onClick={startImport} disabled={!file}>\n                Import\n              </Button>\n            ) : (\n              <Button\n                variant=\"outline\"\n                onClick={handleClose}\n                disabled={importer.state === \"running\"}\n              >\n                Close\n              </Button>\n            )}\n          </FormToolbar>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction millisecondsToTime(ms: number) {\n  const seconds = Math.floor((ms / 1000) % 60);\n  const minutes = Math.floor((ms / (60 * 1000)) % 60);\n\n  return `${minutes}m ${seconds}s`;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactEmpty.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\nimport { ContactImportButton } from \"./ContactImportButton\";\n\nexport const ContactEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-3\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No contacts found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h6 className=\"text-lg font-bold\">No contacts found</h6>\n        <p className=\"text-sm text-muted-foreground text-center mb-4\">\n          It seems your contact list is empty.\n        </p>\n      </div>\n      <div className=\"flex flex-row gap-2\">\n        <CreateButton label=\"New Contact\" />\n        <ContactImportButton />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactEdit.tsx",
      "content": "import { Card, CardContent } from \"@/components/ui/card\";\nimport { EditBase, Form, useEditContext } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport type { Contact } from \"../types\";\nimport { ContactAside } from \"./ContactAside\";\nimport { LeadInputs } from \"./LeadInputs\";\n\nexport const ContactEdit = () => (\n  <EditBase\n    redirect=\"show\"\n    transform={(data: Contact) => {\n      // Split full name back into first_name and last_name before saving\n      if (data.first_name) {\n        const parts = data.first_name.trim().split(/\\s+/);\n        data.first_name = parts[0] || \"\";\n        data.last_name = parts.slice(1).join(\" \") || \"\";\n      }\n      return data;\n    }}\n  >\n    <ContactEditContent />\n  </EditBase>\n);\n\nconst ContactEditContent = () => {\n  const { isPending, record } = useEditContext<Contact>();\n  if (isPending || !record) return null;\n  \n  // Combine first_name and last_name for the form's default value\n  const fullName = record.first_name && record.last_name\n    ? `${record.first_name} ${record.last_name}`.trim()\n    : record.first_name || \"\";\n  \n  return (\n    <div className=\"mt-2 flex justify-center\">\n      <div className=\"w-[90%] max-w-6xl flex gap-8\">\n        <div className=\"flex-1\">\n        <Form \n          className=\"flex flex-1 flex-col gap-4\"\n          defaultValues={{\n            ...record,\n            first_name: fullName,\n          }}\n        >\n        <Card>\n          <CardContent>\n              <LeadInputs />\n            <FormToolbar />\n          </CardContent>\n        </Card>\n      </Form>\n        </div>\n        <ContactAside link=\"show\" />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactCreate.tsx",
      "content": "import { CreateBase, Form, useDataProvider, useGetIdentity, useNotify, useRedirect, useRefresh } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport type { Contact } from \"../types\";\nimport { createLeadJourneyDealForContact } from \"../deals/createLeadJourneyDeal\";\nimport { LeadInputs } from \"./LeadInputs\";\n\nexport const ContactCreate = () => {\n  const { identity } = useGetIdentity();\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n  const redirect = useRedirect();\n  const refresh = useRefresh();\n\n  const handleSuccess = async (data: Contact) => {\n    if (!data?.id) {\n      console.error(\"ContactCreate: Missing contact ID\", data);\n      return;\n    }\n    try {\n      await createLeadJourneyDealForContact(dataProvider, data, identity?.id);\n      \n      // Force refresh to ensure the new lead appears in lists\n      refresh();\n      \n      // Small delay to ensure backend has processed\n      setTimeout(() => {\n        refresh();\n      }, 100);\n      \n      redirect(\"show\", \"contacts\", data.id);\n    } catch (error) {\n      notify(\"Lead created but could not add to journey\", { type: \"warning\" });\n      console.error(\"ContactCreate: lead-journey create failed\", error);\n      // Still redirect even if lead-journey creation fails\n      refresh();\n      redirect(\"show\", \"contacts\", data.id);\n    }\n  };\n  return (\n    <CreateBase\n      redirect={false}\n      transform={(data: Contact) => ({\n        ...data,\n        first_seen: new Date().toISOString(),\n        last_seen: new Date().toISOString(),\n        tags: [],\n        services_interested: data.services_interested || [],\n      })}\n      mutationOptions={{\n        onSuccess: async (response) => {\n          // Handle both response.data (react-admin structure) and direct data\n          const contact = ((response as any)?.data ?? response) as Contact | undefined;\n          if (!contact || !contact.id) {\n            console.warn(\"ContactCreate: Invalid response structure\", response);\n            return;\n          }\n          await handleSuccess(contact);\n        },\n      }}\n    >\n      <div className=\"mt-2 flex justify-center\">\n        <div className=\"w-[90%] max-w-6xl\">\n          <Form \n            defaultValues={{ \n              sales_id: identity?.id,\n              phone_has_whatsapp: false,\n              services_interested: [],\n            }}\n          >\n            <Card>\n              <CardContent>\n                <LeadInputs />\n                <FormToolbar />\n              </CardContent>\n            </Card>\n          </Form>\n        </div>\n      </div>\n    </CreateBase>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/ContactAside.tsx",
      "content": "import { Linkedin, Mail, Phone, MapPin, Archive, ArchiveRestore } from \"lucide-react\";\nimport { useRecordContext, WithRecord, useUpdate, useNotify, useRefresh } from \"ra-core\";\nimport type { ReactNode } from \"react\";\nimport { ArrayField } from \"@/components/admin/array-field\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { DeleteButton } from \"@/components/admin\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { EmailField } from \"@/components/admin/email-field\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\n\nimport { TagsListEdit } from \"./TagsListEdit\";\nimport { ServicesListEdit } from \"./ServicesListEdit\";\nimport { AsideSection } from \"../misc/AsideSection\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { Contact, Deal } from \"../types\";\nimport { ContactMergeButton } from \"./ContactMergeButton\";\nimport { ExportVCardButton } from \"./ExportVCardButton\";\nimport { findDealLabel } from \"../deals/deal\";\n\nexport const ContactAside = ({ link = \"edit\", deals = [] }: { link?: \"edit\" | \"show\"; deals?: Deal[] }) => {\n  const { contactGender, leadStages } = useConfigurationContext();\n  const record = useRecordContext<Contact>();\n\n  if (!record) return null;\n  \n  // Separate archived and non-archived deals\n  const activeDeals = deals.filter(d => !d.archived_at);\n  const archivedDeals = deals.filter(d => d.archived_at);\n  const sortedDeals = [...activeDeals, ...archivedDeals];\n\n  return (\n    <div className=\"hidden sm:block w-64 min-w-64 text-sm\">\n      <div className=\"mb-4 -ml-1 flex items-center gap-2\">\n        {link === \"edit\" ? (\n          <EditButton label=\"Edit Contact\" />\n        ) : (\n          <ShowButton label=\"Show Contact\" />\n        )}\n        {sortedDeals.length > 0 && (\n          <CondensedDealArchiveButton deal={sortedDeals[0]} />\n        )}\n      </div>\n\n      {sortedDeals.length > 0 && (\n        <AsideSection title=\"Status\" noGap>\n          {sortedDeals.map((deal) => (\n            <CondensedDealListItem key={deal.id} deal={deal} />\n          ))}\n        </AsideSection>\n      )}\n\n      <AsideSection title=\"Personal info\">\n        <ArrayField source=\"email_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Mail className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<EmailField source=\"email\" />}\n            />\n          </SingleFieldList>\n        </ArrayField>\n\n        {record.has_newsletter && (\n          <p className=\"pl-6 text-sm text-muted-foreground\">\n            Subscribed to newsletter\n          </p>\n        )}\n\n        {record.linkedin_url && (\n          <PersonalInfoRow\n            icon={<Linkedin className=\"w-4 h-4 text-muted-foreground\" />}\n            primary={\n              <a\n                className=\"underline hover:no-underline text-sm text-muted-foreground\"\n                href={record.linkedin_url}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                title={record.linkedin_url}\n              >\n                LinkedIn\n              </a>\n            }\n          />\n        )}\n        <ArrayField source=\"phone_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Phone className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<TextField source=\"number\" />}\n              showType\n            />\n          </SingleFieldList>\n        </ArrayField>\n        {contactGender\n          .map((genderOption) => {\n            if (record.gender === genderOption.value) {\n              return (\n                <PersonalInfoRow\n                  key={genderOption.value}\n                  primary={<span>{genderOption.label}</span>}\n                />\n              );\n            }\n            return null;\n          })\n          .filter(Boolean)}\n        \n        {/* Address as subcategory */}\n        <div className=\"mt-4 pt-4 border-t\">\n          <h4 className=\"text-xs font-medium text-muted-foreground mb-2\">Address</h4>\n          {record.flat_villa_number && (\n            <div className=\"text-sm text-muted-foreground\">\n              <TextField source=\"flat_villa_number\" record={record} />\n            </div>\n          )}\n          {record.building_street && (\n            <div className=\"text-sm text-muted-foreground\">\n              <TextField source=\"building_street\" record={record} />\n            </div>\n          )}\n          {record.area && (\n            <div className=\"text-sm text-muted-foreground\">\n              <TextField source=\"area\" record={record} />\n            </div>\n          )}\n          {record.google_maps_link && (\n            <div className=\"flex items-center gap-2\">\n              <MapPin className=\"w-4 h-4 text-muted-foreground\" />\n              <a\n                className=\"text-sm text-muted-foreground underline hover:no-underline\"\n                href={record.google_maps_link}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n              >\n                View on Maps\n              </a>\n            </div>\n          )}\n          {!record.flat_villa_number && !record.building_street && !record.area && !record.google_maps_link && (\n            <div className=\"text-sm text-muted-foreground\">No address information</div>\n          )}\n        </div>\n      </AsideSection>\n\n      <AsideSection title=\"Services interested in\">\n        <ServicesListEdit />\n      </AsideSection>\n\n      <AsideSection title=\"Tags\">\n        <TagsListEdit />\n      </AsideSection>\n\n      <AsideSection title=\"Background info\">\n        <WithRecord<Contact>\n          render={(record) =>\n            record?.background ? (\n              <TextField source=\"background\" record={record} className=\"pb-2\" />\n            ) : null\n          }\n        />\n        <div className=\"text-muted-foreground\">\n          <span className=\"text-sm\">Added on</span>{\" \"}\n          <DateField\n            source=\"first_seen\"\n            options={{ year: \"numeric\", month: \"long\", day: \"numeric\" }}\n          />\n        </div>\n\n        <div className=\"text-muted-foreground\">\n          <span className=\"text-sm\">Last activity on</span>{\" \"}\n          <DateField\n            source=\"last_seen\"\n            options={{ year: \"numeric\", month: \"long\", day: \"numeric\" }}\n          />\n        </div>\n\n        <div className=\"inline-flex text-muted-foreground\">\n          Followed by&nbsp;\n          <ReferenceField source=\"sales_id\" reference=\"sales\">\n            <SaleName />\n          </ReferenceField>\n        </div>\n      </AsideSection>\n\n      {link !== \"edit\" && (\n        <>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <ExportVCardButton />\n            <ContactMergeButton />\n          </div>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <DeleteButton\n              className=\"h-6 cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\"\n              size=\"sm\"\n            />\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nconst PersonalInfoRow = ({\n  icon,\n  primary,\n  showType,\n}: {\n  icon?: ReactNode;\n  primary: ReactNode;\n  showType?: boolean;\n}) => (\n  <div className=\"flex flex-row items-center gap-2 min-h-6\">\n    {icon && icon}\n    <div className=\"flex flex-wrap gap-x-2 gap-y-0\">\n      {primary}\n      {showType ? (\n        <WithRecord\n          render={(row) =>\n            row.type !== \"Other\" && (\n              <TextField source=\"type\" className=\"text-muted-foreground\" />\n            )\n          }\n        />\n      ) : null}\n    </div>\n  </div>\n);\n\nconst CondensedDealArchiveButton = ({ deal }: { deal: Deal }) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const isArchived = deal.archived_at != null;\n\n  const handleArchive = () => {\n    update(\n      \"lead-journey\",\n      {\n        id: deal.id,\n        data: { archived_at: new Date().toISOString() },\n        previousData: deal,\n      },\n      {\n        onSuccess: () => {\n          notify(\"Deal archived\", { type: \"info\" });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error archiving deal\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  const handleUnarchive = () => {\n    update(\n      \"lead-journey\",\n      {\n        id: deal.id,\n        data: { archived_at: null },\n        previousData: deal,\n      },\n      {\n        onSuccess: () => {\n          notify(\"Deal unarchived\", { type: \"info\" });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error unarchiving deal\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  return isArchived ? (\n    <Button\n      onClick={handleUnarchive}\n      variant=\"outline\"\n      title=\"Unarchive\"\n      className=\"h-9 px-4 py-2\"\n    >\n      <ArchiveRestore className=\"w-4 h-4\" />\n      <span className=\"ml-2\">Archived</span>\n    </Button>\n  ) : (\n    <Button\n      onClick={handleArchive}\n      variant=\"outline\"\n      title=\"Archive\"\n      className=\"h-9 px-4 py-2\"\n    >\n      <Archive className=\"w-4 h-4\" />\n      <span className=\"ml-2\">Archive</span>\n    </Button>\n  );\n};\n\nconst CondensedDealListItem = ({ deal }: { deal: Deal }) => {\n  const { leadStages } = useConfigurationContext();\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const isArchived = deal.archived_at != null;\n\n  const handleStageChange = (newStage: string) => {\n    if (newStage === deal.stage) return;\n    \n    update(\n      \"lead-journey\",\n      {\n        id: deal.id,\n        data: { stage: newStage },\n        previousData: deal,\n      },\n      {\n        onSuccess: () => {\n          notify(\"Deal stage updated\", { type: \"info\" });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error updating deal stage\", { type: \"error\" });\n        },\n      },\n    );\n  };\n\n  return (\n    <div className=\"flex items-center gap-2 py-1.5\">\n      {isArchived && (\n        <span className=\"text-xs px-1.5 py-0.5 bg-orange-100 text-orange-800 rounded flex-shrink-0\">\n          Archived\n        </span>\n      )}\n      <Select value={deal.stage} onValueChange={handleStageChange} className=\"flex-1\">\n        <SelectTrigger>\n          <SelectValue />\n        </SelectTrigger>\n        <SelectContent>\n          {leadStages.map((stage) => (\n            <SelectItem key={stage.value} value={stage.value}>\n              {stage.label}\n            </SelectItem>\n          ))}\n        </SelectContent>\n      </Select>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/contacts/Avatar.tsx",
      "content": "import {\n  AvatarFallback,\n  AvatarImage,\n  Avatar as ShadcnAvatar,\n} from \"@/components/ui/avatar\";\nimport { useRecordContext } from \"ra-core\";\n\nimport type { Contact } from \"../types\";\n\nexport const Avatar = (props: {\n  record?: Contact;\n  width?: 20 | 25 | 40;\n  height?: 20 | 25 | 40;\n  title?: string;\n}) => {\n  const record = useRecordContext<Contact>(props);\n  // If we come from company page, the record is defined (to pass the company as a prop),\n  // but neither of those fields are and this lead to an error when creating contact.\n  if (!record?.avatar && !record?.first_name && !record?.last_name) {\n    return null;\n  }\n\n  const size = props.width || props.height;\n  const sizeClass =\n    props.width === 20\n      ? `w-[20px] h-[20px]`\n      : props.width === 25\n        ? \"w-[25px] h-[25px]\"\n        : \"w-10 h-10\";\n\n  return (\n    <ShadcnAvatar className={sizeClass} title={props.title}>\n      <AvatarImage src={record.avatar?.src ?? undefined} />\n      <AvatarFallback className={size && size < 40 ? \"text-[10px]\" : \"text-sm\"}>\n        {record.first_name?.charAt(0).toUpperCase()}\n        {record.last_name?.charAt(0).toUpperCase()}\n      </AvatarFallback>\n    </ShadcnAvatar>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/sizes.ts",
      "content": "export const sizes = [\n  { id: 1, name: \"1 employee\" },\n  { id: 10, name: \"2-9 employees\" },\n  { id: 50, name: \"10-49 employees\" },\n  { id: 250, name: \"50-249 employees\" },\n  { id: 500, name: \"250 or more employees\" },\n];\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/index.ts",
      "content": "import { CompanyList } from \"./CompanyList\";\nimport { CompanyCreate } from \"./CompanyCreate\";\nimport { CompanyShow } from \"./CompanyShow\";\nimport { CompanyEdit } from \"./CompanyEdit\";\n\nexport default {\n  list: CompanyList,\n  create: CompanyCreate,\n  edit: CompanyEdit,\n  show: CompanyShow,\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/GridList.tsx",
      "content": "import { RecordContextProvider, useListContext } from \"ra-core\";\n\nimport type { Company } from \"../types\";\nimport { CompanyCard } from \"./CompanyCard\";\n\nconst times = (nbChildren: number, fn: (key: number) => any) =>\n  Array.from({ length: nbChildren }, (_, key) => fn(key));\n\nconst LoadingGridList = () => (\n  <div className=\"flex flex-wrap w-[1008px] gap-1\">\n    {times(15, (key) => (\n      <div\n        className=\"h-[200px] w-[194px] flex flex-col bg-gray-200\"\n        key={key}\n      />\n    ))}\n  </div>\n);\n\nconst LoadedGridList = () => {\n  const { data, error, isPending } = useListContext<Company>();\n\n  if (isPending || error) return null;\n\n  return (\n    <div\n      className=\"w-full gap-2 grid\"\n      style={{\n        gridTemplateColumns: \"repeat(auto-fill, minmax(180px, 1fr))\",\n      }}\n    >\n      {data.map((record) => (\n        <RecordContextProvider key={record.id} value={record}>\n          <CompanyCard />\n        </RecordContextProvider>\n      ))}\n\n      {data.length === 0 && <div className=\"p-2\">No companies found</div>}\n    </div>\n  );\n};\n\nexport const ImageList = () => {\n  const { isPending } = useListContext();\n  return isPending ? <LoadingGridList /> : <LoadedGridList />;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyShow.tsx",
      "content": "import { formatDistance } from \"date-fns\";\nimport { UserPlus } from \"lucide-react\";\nimport {\n  RecordContextProvider,\n  ShowBase,\n  useListContext,\n  useRecordContext,\n  useShowContext,\n} from \"ra-core\";\nimport {\n  Link as RouterLink,\n  useLocation,\n  useMatch,\n  useNavigate,\n} from \"react-router-dom\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { SortButton } from \"@/components/admin/sort-button\";\n\nimport { ActivityLog } from \"../activity/ActivityLog\";\nimport { TagsList } from \"../contacts/TagsList\";\nimport { findDealLabel } from \"../deals/deal\";\nimport { Status } from \"../misc/Status\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Company, Contact, Deal } from \"../types\";\nimport { CompanyAside } from \"./CompanyAside\";\n\nexport const CompanyShow = () => (\n  <ShowBase>\n    <CompanyShowContent />\n  </ShowBase>\n);\n\nconst CompanyShowContent = () => {\n  const { record, isPending } = useShowContext<Company>();\n  const navigate = useNavigate();\n\n  // Get tab from URL or default to \"activity\"\n  const tabMatch = useMatch(\"/companies/:id/show/:tab\");\n  const currentTab = tabMatch?.params?.tab || \"activity\";\n\n  const handleTabChange = (value: string) => {\n    if (value === currentTab) return;\n    if (value === \"activity\") {\n      navigate(`/companies/${record?.id}/show`);\n      return;\n    }\n    navigate(`/companies/${record?.id}/show/${value}`);\n  };\n\n  if (isPending || !record) return null;\n\n  return (\n    <div className=\"mt-2 flex pb-2 gap-8\">\n      <div className=\"flex-1\">\n        <Card>\n          <CardContent>\n            <div className=\"flex mb-3\">\n              <h5 className=\"text-xl flex-1\">{record.name}</h5>\n            </div>\n            <Tabs defaultValue={currentTab} onValueChange={handleTabChange}>\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"activity\">Activity</TabsTrigger>\n                <TabsTrigger value=\"contacts\">\n                  {record.nb_contacts\n                    ? record.nb_contacts === 1\n                      ? \"1 Contact\"\n                      : `${record.nb_contacts} Contacts`\n                    : \"No Contacts\"}\n                </TabsTrigger>\n                {record.nb_deals ? (\n                  <TabsTrigger value=\"deals\">\n                    {record.nb_deals === 1\n                      ? \"1 deal\"\n                      : `${record.nb_deals} deals`}\n                  </TabsTrigger>\n                ) : null}\n              </TabsList>\n              <TabsContent value=\"activity\" className=\"pt-2\">\n                <ActivityLog companyId={record.id} context=\"company\" />\n              </TabsContent>\n              <TabsContent value=\"contacts\">\n                {record.nb_contacts ? (\n                  <ReferenceManyField\n                    reference=\"contacts_summary\"\n                    target=\"company_id\"\n                    sort={{ field: \"last_name\", order: \"ASC\" }}\n                  >\n                    <div className=\"flex flex-col gap-4\">\n                      <div className=\"flex flex-row justify-end space-x-2 mt-1\">\n                        {!!record.nb_contacts && (\n                          <SortButton\n                            fields={[\"last_name\", \"first_name\", \"last_seen\"]}\n                          />\n                        )}\n                        <CreateRelatedContactButton />\n                      </div>\n                      <ContactsIterator />\n                    </div>\n                  </ReferenceManyField>\n                ) : (\n                  <div className=\"flex flex-col gap-4\">\n                    <div className=\"flex flex-row justify-end space-x-2 mt-1\">\n                      <CreateRelatedContactButton />\n                    </div>\n                  </div>\n                )}\n              </TabsContent>\n              <TabsContent value=\"deals\">\n                {record.nb_deals ? (\n                  <ReferenceManyField\n                    reference=\"lead-journey\"\n                    target=\"company_id\"\n                    sort={{ field: \"name\", order: \"ASC\" }}\n                  >\n                    <DealsIterator />\n                  </ReferenceManyField>\n                ) : null}\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n      <CompanyAside />\n    </div>\n  );\n};\n\nconst ContactsIterator = () => {\n  const location = useLocation();\n  const { data: contacts, error, isPending } = useListContext<Contact>();\n\n  if (isPending || error) return null;\n\n  const now = Date.now();\n  return (\n    <div className=\"pt-0\">\n      {contacts.map((contact) => (\n        <RecordContextProvider key={contact.id} value={contact}>\n          <div className=\"p-0 text-sm\">\n            <RouterLink\n              to={`/contacts/${contact.id}/show`}\n              state={{ from: location.pathname }}\n              className=\"flex items-center justify-between hover:bg-muted py-2 transition-colors\"\n            >\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"font-medium\">\n                  {`${contact.first_name} ${contact.last_name}`}\n                </div>\n                <div className=\"text-sm text-muted-foreground\">\n                  {contact.title}\n                  {contact.nb_tasks\n                    ? ` - ${contact.nb_tasks} task${\n                        contact.nb_tasks > 1 ? \"s\" : \"\"\n                      }`\n                    : \"\"}\n                  &nbsp; &nbsp;\n                  <TagsList />\n                </div>\n              </div>\n              {contact.last_seen && (\n                <div className=\"text-right\">\n                  <div className=\"text-sm text-muted-foreground\">\n                    last activity {formatDistance(contact.last_seen, now)} ago{\" \"}\n                    <Status status={contact.status} />\n                  </div>\n                </div>\n              )}\n            </RouterLink>\n          </div>\n        </RecordContextProvider>\n      ))}\n    </div>\n  );\n};\n\nconst CreateRelatedContactButton = () => {\n  const company = useRecordContext<Company>();\n  return (\n    <Button variant=\"outline\" asChild size=\"sm\" className=\"h-9\">\n      <RouterLink\n        to=\"/contacts/create\"\n        state={company ? { record: { company_id: company.id } } : undefined}\n        className=\"flex items-center gap-2\"\n      >\n        <UserPlus className=\"h-4 w-4\" />\n        Add contact\n      </RouterLink>\n    </Button>\n  );\n};\n\nconst DealsIterator = () => {\n  const { data: deals, error, isPending } = useListContext<Deal>();\n  const { dealStages } = useConfigurationContext();\n  if (isPending || error) return null;\n\n  const now = Date.now();\n  return (\n    <div>\n      <div>\n        {deals.map((deal) => (\n          <div key={deal.id} className=\"p-0 text-sm\">\n            <RouterLink\n              to={`/lead-journey/${deal.id}/show`}\n              className=\"flex items-center justify-between hover:bg-muted py-2 px-4 transition-colors\"\n            >\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"font-medium\">{deal.name}</div>\n                <div className=\"text-sm text-muted-foreground\">\n                  {findDealLabel(dealStages, deal.stage)},{\" \"}\n                  {deal.amount.toLocaleString(\"en-US\", {\n                    notation: \"compact\",\n                    style: \"currency\",\n                    currency: \"AED\",\n                    currencyDisplay: \"narrowSymbol\",\n                    minimumSignificantDigits: 3,\n                  })}\n                  {deal.category ? `, ${deal.category}` : \"\"}\n                </div>\n              </div>\n              <div className=\"text-right\">\n                <div className=\"text-sm text-muted-foreground\">\n                  last activity {formatDistance(deal.updated_at, now)} ago{\" \"}\n                </div>\n              </div>\n            </RouterLink>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyListFilter.tsx",
      "content": "import { Building, Truck, Users } from \"lucide-react\";\nimport { FilterLiveForm, useGetIdentity } from \"ra-core\";\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { sizes } from \"./sizes\";\n\nexport const CompanyListFilter = () => {\n  const { identity } = useGetIdentity();\n  const { companySectors } = useConfigurationContext();\n  const sectors = companySectors.map((sector) => ({\n    id: sector,\n    name: sector,\n  }));\n  return (\n    <div className=\"w-52 min-w-52 flex flex-col gap-8\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" />\n      </FilterLiveForm>\n\n      <FilterCategory icon={<Building className=\"h-4 w-4\" />} label=\"Size\">\n        {sizes.map((size) => (\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label={size.name}\n            value={{ size: size.id }}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory icon={<Truck className=\"h-4 w-4\" />} label=\"Sector\">\n        {sectors.map((sector) => (\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label={sector.name}\n            value={{ sector: sector.id }}\n          />\n        ))}\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<Users className=\"h-4 w-4\" />}\n        label=\"Account Manager\"\n      >\n        <ToggleFilterButton\n          className=\"w-full justify-between\"\n          label={\"Me\"}\n          value={{ sales_id: identity?.id }}\n        />\n      </FilterCategory>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyList.tsx",
      "content": "import { useGetIdentity, useListContext } from \"ra-core\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { ListPagination } from \"@/components/admin/list-pagination\";\nimport { SortButton } from \"@/components/admin/sort-button\";\n\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { CompanyEmpty } from \"./CompanyEmpty\";\nimport { CompanyListFilter } from \"./CompanyListFilter\";\nimport { ImageList } from \"./GridList\";\n\nexport const CompanyList = () => {\n  const { identity } = useGetIdentity();\n  if (!identity) return null;\n  return (\n    <List\n      title={false}\n      perPage={25}\n      sort={{ field: \"name\", order: \"ASC\" }}\n      actions={<CompanyListActions />}\n      pagination={<ListPagination rowsPerPageOptions={[10, 25, 50, 100]} />}\n    >\n      <CompanyListLayout />\n    </List>\n  );\n};\n\nconst CompanyListLayout = () => {\n  const { data, isPending, filterValues } = useListContext();\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  if (isPending) return null;\n  if (!data?.length && !hasFilters) return <CompanyEmpty />;\n\n  return (\n    <div className=\"w-full flex flex-row gap-8\">\n      <CompanyListFilter />\n      <div className=\"flex flex-col flex-1 gap-4\">\n        <ImageList />\n      </div>\n    </div>\n  );\n};\n\nconst CompanyListActions = () => {\n  return (\n    <TopToolbar>\n      <SortButton fields={[\"name\", \"created_at\", \"nb_contacts\"]} />\n      <ExportButton />\n      <CreateButton label=\"New Company\" />\n    </TopToolbar>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyInputs.tsx",
      "content": "import { required, useRecordContext } from \"ra-core\";\nimport { ReferenceInput } from \"@/components/admin/reference-input\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { SelectInput } from \"@/components/admin/select-input\";\nimport { ArrayInput } from \"@/components/admin/array-input\";\nimport { SimpleFormIterator } from \"@/components/admin/simple-form-iterator\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport ImageEditorField from \"../misc/ImageEditorField\";\nimport { isLinkedinUrl } from \"../misc/isLinkedInUrl\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport type { Company, Sale } from \"../types\";\nimport { sizes } from \"./sizes\";\n\nconst isUrl = (url: string) => {\n  if (!url) return;\n  const UrlRegex = new RegExp(\n    /^(http:\\/\\/www\\.|https:\\/\\/www\\.|http:\\/\\/|https:\\/\\/)?[a-z0-9]+([-.]{1}[a-z0-9]+)*\\.[a-z]{2,5}(:[0-9]{1,5})?(\\/.*)?$/i,\n  );\n  if (!UrlRegex.test(url)) {\n    return \"Must be a valid URL\";\n  }\n};\n\nexport const CompanyInputs = () => {\n  const isMobile = useIsMobile();\n\n  return (\n    <div className=\"flex flex-col gap-4 p-1\">\n      <CompanyDisplayInputs />\n      <div className={`flex gap-6 ${isMobile ? \"flex-col\" : \"flex-row\"}`}>\n        <div className=\"flex flex-col gap-10 flex-1\">\n          <CompanyContactInputs />\n          <CompanyContextInputs />\n        </div>\n        <Separator orientation={isMobile ? \"horizontal\" : \"vertical\"} />\n        <div className=\"flex flex-col gap-8 flex-1\">\n          <CompanyAddressInputs />\n          <CompanyAdditionalInformationInputs />\n          <CompanyAccountManagerInput />\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst CompanyDisplayInputs = () => {\n  const record = useRecordContext<Company>();\n  return (\n    <div className=\"flex gap-4 flex-1 flex-row\">\n      <ImageEditorField\n        source=\"logo\"\n        type=\"avatar\"\n        width={60}\n        height={60}\n        emptyText={record?.name.charAt(0)}\n        linkPosition=\"bottom\"\n      />\n      <TextInput\n        source=\"name\"\n        className=\"w-full h-fit\"\n        validate={required()}\n        helperText={false}\n        placeholder=\"Company name\"\n      />\n    </div>\n  );\n};\n\nconst CompanyContactInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Contact</h6>\n      <TextInput source=\"website\" helperText={false} validate={isUrl} />\n      <TextInput\n        source=\"linkedin_url\"\n        helperText={false}\n        validate={isLinkedinUrl}\n      />\n      <TextInput source=\"phone_number\" helperText={false} />\n    </div>\n  );\n};\n\nconst CompanyContextInputs = () => {\n  const { companySectors } = useConfigurationContext();\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Context</h6>\n      <SelectInput\n        source=\"sector\"\n        choices={companySectors.map((sector) => ({\n          id: sector,\n          name: sector,\n        }))}\n        helperText={false}\n      />\n      <SelectInput source=\"size\" choices={sizes} helperText={false} />\n      <TextInput source=\"revenue\" helperText={false} />\n      <TextInput source=\"tax_identifier\" helperText={false} />\n    </div>\n  );\n};\n\nconst CompanyAddressInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Address</h6>\n      <TextInput source=\"address\" helperText={false} />\n      <TextInput source=\"city\" helperText={false} />\n      <TextInput source=\"zipcode\" helperText={false} />\n      <TextInput source=\"stateAbbr\" helperText={false} />\n      <TextInput source=\"country\" helperText={false} />\n    </div>\n  );\n};\n\nconst CompanyAdditionalInformationInputs = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Additional information</h6>\n      <TextInput source=\"description\" multiline helperText={false} />\n      <ArrayInput source=\"context_links\" helperText={false}>\n        <SimpleFormIterator disableReordering fullWidth getItemLabel={false}>\n          <TextInput\n            source=\"\"\n            label={false}\n            helperText={false}\n            validate={isUrl}\n          />\n        </SimpleFormIterator>\n      </ArrayInput>\n    </div>\n  );\n};\n\nconst CompanyAccountManagerInput = () => {\n  return (\n    <div className=\"flex flex-col gap-4\">\n      <h6 className=\"text-lg font-semibold\">Account manager</h6>\n      <ReferenceInput\n        source=\"sales_id\"\n        reference=\"sales\"\n        filter={{\n          \"disabled@neq\": true,\n        }}\n      >\n        <SelectInput\n          label=\"Account manager\"\n          helperText={false}\n          optionText={saleOptionRenderer}\n        />\n      </ReferenceInput>\n    </div>\n  );\n};\n\nconst saleOptionRenderer = (choice: Sale) =>\n  `${choice.first_name} ${choice.last_name}`;\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyEmpty.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\n\nexport const CompanyEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-6\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No companies found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h6 className=\"text-lg font-bold\">No companies found</h6>\n        <p className=\"text-sm text-center text-muted-foreground mb-4\">\n          It seems your company list is empty.\n        </p>\n      </div>\n      <div className=\"flex space-x-2\">\n        <CreateButton label=\"Create Company\" />\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyEdit.tsx",
      "content": "import { EditBase, Form } from \"ra-core\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport { CompanyInputs } from \"./CompanyInputs\";\nimport { CompanyAside } from \"./CompanyAside\";\nimport { FormToolbar } from \"../layout/FormToolbar\";\n\nexport const CompanyEdit = () => (\n  <EditBase\n    actions={false}\n    redirect=\"show\"\n    transform={(values) => {\n      // add https:// before website if not present\n      if (values.website && !values.website.startsWith(\"http\")) {\n        values.website = `https://${values.website}`;\n      }\n      return values;\n    }}\n  >\n    <div className=\"mt-2 flex gap-8\">\n      <Form className=\"flex flex-1 flex-col gap-4 pb-2\">\n        <Card>\n          <CardContent>\n            <CompanyInputs />\n            <FormToolbar />\n          </CardContent>\n        </Card>\n      </Form>\n\n      <CompanyAside link=\"show\" />\n    </div>\n  </EditBase>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyCreate.tsx",
      "content": "import { CreateBase, Form, useGetIdentity } from \"ra-core\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport { CompanyInputs } from \"./CompanyInputs\";\n\nexport const CompanyCreate = () => {\n  const { identity } = useGetIdentity();\n  return (\n    <CreateBase\n      redirect=\"show\"\n      transform={(values) => {\n        // add https:// before website if not present\n        if (values.website && !values.website.startsWith(\"http\")) {\n          values.website = `https://${values.website}`;\n        }\n        return values;\n      }}\n    >\n      <div className=\"mt-2 flex lg:mr-72\">\n        <div className=\"flex-1\">\n          <Form defaultValues={{ sales_id: identity?.id }}>\n            <Card>\n              <CardContent>\n                <CompanyInputs />\n                <FormToolbar>\n                  <div className=\"flex flex-row gap-2 justify-end\">\n                    <CancelButton />\n                    <SaveButton label=\"Create Company\" />\n                  </div>\n                </FormToolbar>\n              </CardContent>\n            </Card>\n          </Form>\n        </div>\n      </div>\n    </CreateBase>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyCard.tsx",
      "content": "import { DollarSign } from \"lucide-react\";\nimport { Link } from \"react-router\";\nimport { useCreatePath, useRecordContext } from \"ra-core\";\nimport { Card } from \"@/components/ui/card\";\n\nimport type { Company } from \"../types\";\n\nexport const CompanyCard = (props: { record?: Company }) => {\n  const createPath = useCreatePath();\n  const record = useRecordContext<Company>(props);\n  if (!record) return null;\n\n  return (\n    <Link\n      to={createPath({\n        resource: \"companies\",\n        id: record.id,\n        type: \"show\",\n      })}\n      className=\"no-underline\"\n    >\n      <Card className=\"h-[200px] flex flex-col justify-between p-4 hover:bg-muted\">\n        <div className=\"flex flex-col items-center gap-1\">\n          <div className=\"text-center mt-1\">\n            <h6 className=\"text-sm font-medium\">{record.name}</h6>\n            <p className=\"text-xs text-muted-foreground\">{record.sector}</p>\n          </div>\n        </div>\n        <div className=\"flex flex-row w-full justify-between gap-2\">\n          <div className=\"flex items-center\">\n          </div>\n          {record.nb_deals ? (\n            <div className=\"flex items-center ml-2 gap-0.5\">\n              <DollarSign className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"text-sm font-medium\">{record.nb_deals}</span>\n              <span className=\"text-xs text-muted-foreground\">\n                {record.nb_deals\n                  ? record.nb_deals > 1\n                    ? \"deals\"\n                    : \"deal\"\n                  : \"deal\"}\n              </span>\n            </div>\n          ) : null}\n        </div>\n      </Card>\n    </Link>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyAvatar.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\n\nimport type { Company } from \"../types\";\n\nexport const CompanyAvatar = (props: {\n  record?: Company;\n  width?: 20 | 40;\n  height?: 20 | 40;\n}) => {\n  const { width = 40 } = props;\n  const record = useRecordContext<Company>(props);\n  if (!record) return null;\n\n  const sizeClass = width !== 40 ? `w-[20px] h-[20px]` : \"w-10 h-10\";\n\n  return (\n    <Avatar className={sizeClass}>\n      <AvatarImage\n        src={record.logo?.src}\n        alt={record.name}\n        className=\"object-contain\"\n      />\n      <AvatarFallback className={width !== 40 ? \"text-xs\" : \"text-sm\"}>\n        {record.name.charAt(0)}\n      </AvatarFallback>\n    </Avatar>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/CompanyAside.tsx",
      "content": "import { Globe, Linkedin, Phone } from \"lucide-react\";\nimport { useRecordContext } from \"ra-core\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { DeleteButton } from \"@/components/admin/delete-button\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { UrlField } from \"@/components/admin/url-field\";\nimport { SelectField } from \"@/components/admin/select-field\";\n\nimport { AsideSection } from \"../misc/AsideSection\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { Company } from \"../types\";\nimport { sizes } from \"./sizes\";\n\ninterface CompanyAsideProps {\n  link?: string;\n}\n\nexport const CompanyAside = ({ link = \"edit\" }: CompanyAsideProps) => {\n  const record = useRecordContext<Company>();\n  if (!record) return null;\n\n  return (\n    <div className=\"hidden sm:block w-[250px] min-w-[250px] space-y-4\">\n      <div className=\"flex flex-row space-x-1\">\n        {link === \"edit\" ? (\n          <EditButton label=\"Edit Company\" />\n        ) : (\n          <ShowButton label=\"Show Company\" />\n        )}\n      </div>\n\n      <CompanyInfo record={record} />\n\n      <AddressInfo record={record} />\n\n      <ContextInfo record={record} />\n\n      <AdditionalInfo record={record} />\n\n      {link !== \"edit\" && (\n        <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n          <DeleteButton\n            className=\"h-6 cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\"\n            size=\"sm\"\n          />\n        </div>\n      )}\n    </div>\n  );\n};\n\nconst CompanyInfo = ({ record }: { record: Company }) => {\n  if (!record.website && !record.linkedin_url && !record.phone_number) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Company Info\">\n      {record.website && (\n        <div className=\"flex flex-row items-center gap-1 min-h-[24px]\">\n          <Globe className=\"w-4 h-4\" />\n          <UrlField\n            source=\"website\"\n            target=\"_blank\"\n            rel=\"noopener\"\n            content={record.website\n              .replace(\"http://\", \"\")\n              .replace(\"https://\", \"\")}\n          />\n        </div>\n      )}\n      {record.linkedin_url && (\n        <div className=\"flex flex-row items-center gap-1 min-h-[24px]\">\n          <Linkedin className=\"w-4 h-4\" />\n          <a\n            className=\"underline hover:no-underline\"\n            href={record.linkedin_url}\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            title={record.linkedin_url}\n          >\n            LinkedIn\n          </a>\n        </div>\n      )}\n      {record.phone_number && (\n        <div className=\"flex flex-row items-center gap-1 min-h-[24px]\">\n          <Phone className=\"w-4 h-4\" />\n          <TextField source=\"phone_number\" />\n        </div>\n      )}\n    </AsideSection>\n  );\n};\n\nconst ContextInfo = ({ record }: { record: Company }) => {\n  if (!record.revenue && !record.id) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Context\">\n      {record.sector && (\n        <span>\n          Sector: <TextField source=\"sector\" />\n        </span>\n      )}\n      {record.size && (\n        <span>\n          Size: <SelectField source=\"size\" choices={sizes} />\n        </span>\n      )}\n      {record.revenue && (\n        <span>\n          Revenue: <TextField source=\"revenue\" />\n        </span>\n      )}\n      {record.tax_identifier && (\n        <span>\n          Tax Identifier: <TextField source=\"tax_identifier\" />\n        </span>\n      )}\n    </AsideSection>\n  );\n};\n\nconst AddressInfo = ({ record }: { record: Company }) => {\n  if (!record.address && !record.city && !record.zipcode && !record.stateAbbr) {\n    return null;\n  }\n\n  return (\n    <AsideSection title=\"Main Address\" noGap>\n      <TextField source=\"address\" />\n      <TextField source=\"city\" />\n      <TextField source=\"zipcode\" />\n      <TextField source=\"stateAbbr\" />\n      <TextField source=\"country\" />\n    </AsideSection>\n  );\n};\n\nconst AdditionalInfo = ({ record }: { record: Company }) => {\n  if (\n    !record.created_at &&\n    !record.sales_id &&\n    !record.description &&\n    !record.context_links\n  ) {\n    return null;\n  }\n  const getBaseURL = (url: string) => {\n    const urlObject = new URL(url.startsWith(\"http\") ? url : `https://${url}`);\n    return urlObject.hostname;\n  };\n\n  return (\n    <AsideSection title=\"Additional Info\">\n      {record.description && (\n        <p className=\"text-sm  mb-1\">{record.description}</p>\n      )}\n      {record.context_links && (\n        <div className=\"flex flex-col\">\n          {record.context_links.map((link, index) =>\n            link ? (\n              <a\n                key={index}\n                className=\"text-sm underline hover:no-underline mb-1\"\n                href={link.startsWith(\"http\") ? link : `https://${link}`}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                title={link}\n              >\n                {getBaseURL(link)}\n              </a>\n            ) : null,\n          )}\n        </div>\n      )}\n      {record.sales_id !== null && (\n        <div className=\"inline-flex text-sm text-muted-foreground mb-1\">\n          Followed by&nbsp;\n          <ReferenceField source=\"sales_id\" reference=\"sales\" record={record}>\n            <SaleName />\n          </ReferenceField>\n        </div>\n      )}\n      {record.created_at && (\n        <p className=\"text-sm text-muted-foreground mb-1\">\n          Added on{\" \"}\n          <DateField\n            source=\"created_at\"\n            record={record}\n            options={{\n              year: \"numeric\",\n              month: \"long\",\n              day: \"numeric\",\n            }}\n          />\n        </p>\n      )}\n    </AsideSection>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/companies/AutocompleteCompanyInput.tsx",
      "content": "import { useCreate, useGetIdentity, useNotify } from \"ra-core\";\nimport { AutocompleteInput } from \"@/components/admin/autocomplete-input\";\nimport type { InputProps } from \"ra-core\";\n\nexport const AutocompleteCompanyInput = ({\n  validate,\n}: Pick<InputProps, \"validate\">) => {\n  const [create] = useCreate();\n  const { identity } = useGetIdentity();\n  const notify = useNotify();\n  const handleCreateCompany = async (name?: string) => {\n    if (!name) return;\n    try {\n      const newCompany = await create(\n        \"companies\",\n        {\n          data: {\n            name,\n            sales_id: identity?.id,\n            created_at: new Date().toISOString(),\n          },\n        },\n        { returnPromise: true },\n      );\n      return newCompany;\n    } catch {\n      notify(\"An error occurred while creating the company\", {\n        type: \"error\",\n      });\n    }\n  };\n\n  return (\n    <AutocompleteInput\n      optionText=\"name\"\n      helperText={false}\n      onCreate={handleCreateCompany}\n      createItemLabel=\"Create %{item}\"\n      createLabel=\"Start typing to create a new company\"\n      validate={validate}\n    />\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/index.tsx",
      "content": "import type { Contact } from \"../types\";\nimport { ClientCreate } from \"./ClientCreate\";\nimport { ClientEdit } from \"./ClientEdit\";\nimport { ClientList } from \"./ClientList\";\nimport { ClientShow } from \"./ClientShow\";\n\nexport default {\n  list: ClientList,\n  show: ClientShow,\n  edit: ClientEdit,\n  create: ClientCreate,\n  recordRepresentation: (record: Contact) =>\n    record?.first_name + \" \" + record?.last_name,\n};\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientShow.tsx",
      "content": "import { ShowBase, useShowContext, useGetList, RecordContextProvider, useRefresh, useUpdate, useNotify } from \"ra-core\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Edit, Save, CircleX } from \"lucide-react\";\nimport { useMemo, useState, useEffect } from \"react\";\nimport type { SubmitHandler, FieldValues } from \"react-hook-form\";\nimport { useForm, FormProvider } from \"react-hook-form\";\n\nimport type { Contact, Task, Quote, Deal } from \"../types\";\nimport { ContactAside } from \"../contacts/ContactAside\";\nimport { QuoteItem } from \"../quotes/QuoteItem\";\nimport { AddQuote } from \"../quotes/AddQuote\";\nimport { Task as TaskComponent } from \"../tasks/Task\";\nimport { AddTask } from \"../tasks/AddTask\";\nimport { UnifiedNotesIterator } from \"../notes/UnifiedNotesIterator\";\nimport { ActivityLog } from \"../activity/ActivityLog\";\nimport {\n  crmAddDays,\n  crmEndOfDay,\n  crmEndOfWeek,\n  crmStartOfDay,\n} from \"../misc/timezone\";\n\nexport const ClientShow = () => (\n  <ShowBase>\n    <ClientShowContent />\n  </ShowBase>\n);\n\nconst ClientShowContent = () => {\n  const { record, isPending } = useShowContext<Contact>();\n  const refresh = useRefresh();\n  const [isEditingDescription, setIsEditingDescription] = useState(false);\n  const [update, { isPending: isUpdating }] = useUpdate();\n  const notify = useNotify();\n\n  // Fetch deals associated with this contact to get deal IDs for notes\n  // Fetch both archived and non-archived deals\n  const { data: deals } = useGetList<Deal>(\"lead-journey\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record?.id ? { lead_id: record.id } : {},\n    sort: { field: \"archived_at\", order: \"ASC\" }, // Non-archived first\n  }, { enabled: !!record?.id });\n  \n  // Separate archived and non-archived deals\n  const sortedDeals = useMemo(() => {\n    if (!deals) return [];\n    const active = deals.filter(d => !d.archived_at);\n    const archived = deals.filter(d => d.archived_at);\n    return [...active, ...archived];\n  }, [deals]);\n\n  // Get all deal IDs for fetching notes from all deals\n  const dealIds = useMemo(() => {\n    return deals?.map(deal => deal.id) || [];\n  }, [deals]);\n\n  const { data: quotes } = useGetList<Quote>(\"quotes\", {\n    pagination: { page: 1, perPage: 1000 },\n    sort: { field: \"created_at\", order: \"DESC\" },\n    filter: record?.id ? { contact_id: record.id } : {},\n  }, { enabled: !!record?.id });\n\n  const { data: tasks } = useGetList<Task>(\"tasks\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: record?.id ? { contact_id: record.id } : {},\n  }, { enabled: !!record?.id });\n\n  const [showCompletedTasks, setShowCompletedTasks] = useState(false);\n\n  const groupedTasks = useMemo(() => {\n    const empty = {\n      overdue: [] as Task[],\n      today: [] as Task[],\n      tomorrow: [] as Task[],\n      thisWeek: [] as Task[],\n      later: [] as Task[],\n      completed: [] as Task[],\n    };\n    if (!tasks) return empty;\n\n    const startOfToday = crmStartOfDay() ?? new Date();\n    const endOfToday = crmEndOfDay() ?? new Date();\n    const endOfTomorrow = crmEndOfDay(crmAddDays(new Date(), 1)) ?? new Date();\n    const endOfWeek = crmEndOfWeek() ?? new Date();\n\n    for (const task of tasks) {\n      if (task.done_date) {\n        empty.completed.push(task);\n        continue;\n      }\n\n      const due = task.due_date ? new Date(task.due_date) : null;\n      if (!due || Number.isNaN(due.getTime())) {\n        empty.later.push(task);\n        continue;\n      }\n\n      if (due < startOfToday) empty.overdue.push(task);\n      else if (due <= endOfToday) empty.today.push(task);\n      else if (due <= endOfTomorrow) empty.tomorrow.push(task);\n      else if (due <= endOfWeek) empty.thisWeek.push(task);\n      else empty.later.push(task);\n    }\n\n    const byDueDateAsc = (a: Task, b: Task) =>\n      new Date(a.due_date || 0).getTime() - new Date(b.due_date || 0).getTime();\n\n    empty.overdue.sort(byDueDateAsc);\n    empty.today.sort(byDueDateAsc);\n    empty.tomorrow.sort(byDueDateAsc);\n    empty.thisWeek.sort(byDueDateAsc);\n    empty.later.sort(byDueDateAsc);\n\n    empty.completed.sort(\n      (a, b) => new Date(b.done_date || 0).getTime() - new Date(a.done_date || 0).getTime(),\n    );\n\n    return empty;\n  }, [tasks]);\n\n  const form = useForm<{ description: string }>({\n    defaultValues: {\n      description: record?.description || \"\",\n    },\n  });\n\n  // Reset form when record ID changes (different contact)\n  useEffect(() => {\n    if (record) {\n      form.reset({ description: record.description || \"\" });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [record?.id]);\n\n  const handleDescriptionUpdate: SubmitHandler<FieldValues> = (values) => {\n    if (!record) return;\n    update(\n      \"contacts\",\n      { id: record.id, data: { description: values.description || null }, previousData: record },\n      {\n        onSuccess: () => {\n          setIsEditingDescription(false);\n          refresh();\n          notify(\"Description updated\", { type: \"info\" });\n        },\n        onError: (error: any) => {\n          console.error(\"Error updating description:\", error);\n          notify(\n            error?.message?.includes(\"description\") \n              ? \"Description column not found. Please ensure migrations are applied.\"\n              : \"Failed to update description\",\n            { type: \"error\" }\n          );\n        },\n      },\n    );\n  };\n\n  const handleCancelEdit = () => {\n    if (record) {\n      form.reset({ description: record.description || \"\" });\n    }\n    setIsEditingDescription(false);\n  };\n\n  if (isPending || !record) return null;\n\n  return (\n    <div className=\"mt-2 mb-2 flex gap-8\">\n      <div className=\"flex-1\">\n        <Card>\n          <CardContent>\n            <div className=\"flex\">\n              <div className=\"flex-1\">\n                <div className=\"flex items-center gap-2\">\n                  <h5 className=\"text-xl font-semibold\">\n                    {record.first_name} {record.last_name}\n                  </h5>\n                  <Badge variant=\"default\" className=\"text-xs text-white bg-emerald-600 hover:bg-emerald-700\">\n                    Client\n                  </Badge>\n                </div>\n                <div className=\"inline-flex text-sm text-muted-foreground\">\n                  {record.title}\n                  {record.title && record.company_id != null && \" at \"}\n                  {record.company_id != null && (\n                    <ReferenceField\n                      source=\"company_id\"\n                      reference=\"companies\"\n                      link=\"show\"\n                    >\n                      &nbsp;\n                      <TextField source=\"name\" />\n                    </ReferenceField>\n                  )}\n                </div>\n                <div className=\"mt-4\">\n                  {isEditingDescription ? (\n                    <FormProvider {...form}>\n                      <form onSubmit={form.handleSubmit(handleDescriptionUpdate)}>\n                        <div className=\"flex flex-col gap-2\">\n                          <Textarea\n                            {...form.register(\"description\")}\n                            placeholder=\"Add a description...\"\n                            rows={4}\n                            className=\"text-sm\"\n                          />\n                          <div className=\"flex justify-end gap-2\">\n                            <Button\n                              variant=\"outline\"\n                              onClick={handleCancelEdit}\n                              type=\"button\"\n                              size=\"sm\"\n                              className=\"cursor-pointer\"\n                            >\n                              <CircleX className=\"w-4 h-4 mr-2\" />\n                              Cancel\n                            </Button>\n                            <Button\n                              type=\"submit\"\n                              disabled={isUpdating}\n                              size=\"sm\"\n                              className=\"cursor-pointer\"\n                            >\n                              <Save className=\"w-4 h-4 mr-2\" />\n                              Save\n                            </Button>\n                          </div>\n                        </div>\n                      </form>\n                    </FormProvider>\n                  ) : (\n                    <div className=\"group relative\">\n                      {record.description ? (\n                        <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                          {record.description}\n                        </p>\n                      ) : (\n                        <p className=\"text-sm text-muted-foreground italic\">\n                          No description\n                        </p>\n                      )}\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => {\n                          form.reset({ description: record.description || \"\" });\n                          setIsEditingDescription(true);\n                        }}\n                        className=\"mt-2 h-7 cursor-pointer\"\n                      >\n                        <Edit className=\"w-3.5 h-3.5 mr-2\" />\n                        {record.description ? \"Edit description\" : \"Add description\"}\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n            \n            <Tabs defaultValue=\"activity\" className=\"mt-6\">\n              <TabsList className=\"w-full\">\n                <TabsTrigger value=\"activity\" className=\"flex-1\">Activity</TabsTrigger>\n                <TabsTrigger value=\"notes\" className=\"flex-1\">Notes</TabsTrigger>\n                <TabsTrigger value=\"quotes\" className=\"flex-1\">Quotes</TabsTrigger>\n                <TabsTrigger value=\"tasks\" className=\"flex-1\">Tasks</TabsTrigger>\n              </TabsList>\n              \n              <TabsContent value=\"activity\" className=\"pt-4\">\n                <Card className=\"mb-2 p-6\">\n                  <ActivityLog contactId={record.id} pageSize={10} context=\"contact\" />\n                </Card>\n              </TabsContent>\n              \n              <TabsContent value=\"notes\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <UnifiedNotesIterator\n                    reference=\"contacts\"\n                    showStatus\n                    contactId={record.id}\n                    leadId={record.id}\n                    dealIds={dealIds}\n                  />\n                </RecordContextProvider>\n              </TabsContent>\n              \n              <TabsContent value=\"quotes\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <AddQuote />\n                </RecordContextProvider>\n                {quotes && quotes.length > 0 && (\n                  <div className=\"mt-4 space-y-2\">\n                    {quotes.map((quote) => (\n                      <QuoteItem quote={quote} key={quote.id} />\n                    ))}\n                  </div>\n                )}\n              </TabsContent>\n              \n              <TabsContent value=\"tasks\" className=\"pt-4\">\n                <RecordContextProvider value={record}>\n                  <AddTask />\n                </RecordContextProvider>\n                <div className=\"mt-4 space-y-6\">\n                  {tasks && tasks.length > 0 ? (\n                    <>\n                      {groupedTasks.overdue.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Overdue\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.overdue.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.today.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Today\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.today.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.tomorrow.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Tomorrow\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.tomorrow.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.thisWeek.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            This Week\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.thisWeek.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.later.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                            Later\n                          </p>\n                          <div className=\"space-y-2\">\n                            {groupedTasks.later.map((task) => (\n                              <TaskComponent task={task} key={task.id} />\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {groupedTasks.completed.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            className=\"cursor-pointer\"\n                            onClick={() => setShowCompletedTasks((v) => !v)}\n                          >\n                            {showCompletedTasks ? \"Hide\" : \"Show\"} completed (\n                            {groupedTasks.completed.length})\n                          </Button>\n                          {showCompletedTasks && (\n                            <div className=\"space-y-2\">\n                              {groupedTasks.completed.map((task) => (\n                                <TaskComponent task={task} key={task.id} />\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </>\n                  ) : (\n                    <p className=\"text-sm text-muted-foreground\">No tasks yet</p>\n                  )}\n                </div>\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n      <ContactAside deals={sortedDeals} />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientListFilter.tsx",
      "content": "import { subMonths } from \"date-fns\";\nimport isEqual from \"lodash/isEqual\";\nimport {\n  Archive,\n  CheckSquare,\n  Clock,\n  Stethoscope,\n  Tag,\n  Users,\n} from \"lucide-react\";\nimport {\n  FilterLiveForm,\n  useGetIdentity,\n  useGetList,\n  useListContext,\n} from \"ra-core\";\n\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { Badge } from \"@/components/ui/badge\";\n\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { FilterOptionButton } from \"../filters/FilterOptionButton\";\nimport {\n  buildInFilter,\n  buildOverlapFilter,\n  parseInFilter,\n  parseOverlapFilter,\n  RangeFilter,\n  toggleValueInList,\n} from \"../filters/filterUtils\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport {\n  crmEndOfYesterday,\n  crmStartOfMonth,\n  crmStartOfWeek,\n} from \"../misc/timezone\";\n\nexport const ClientListFilter = () => {\n  const { filterValues = {}, setFilters } = useListContext();\n  const { identity } = useGetIdentity();\n  const { data } = useGetList(\"tags\", {\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: servicesData } = useGetList(\"services\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n  const { data: salesData } = useGetList(\"sales\", {\n    pagination: { page: 1, perPage: 50 },\n    sort: { field: \"first_name\", order: \"ASC\" },\n  });\n  const startOfWeek = crmStartOfWeek();\n  const startOfMonth = crmStartOfMonth();\n  const endOfYesterday = crmEndOfYesterday();\n  const lastSeenRanges = Array.isArray(filterValues.last_seen_ranges)\n    ? (filterValues.last_seen_ranges as RangeFilter[])\n    : [];\n  const selectedServices = parseOverlapFilter(\n    filterValues[\"services_interested@ov\"],\n  );\n  const selectedTags = parseOverlapFilter(filterValues[\"tags@ov\"]);\n  const selectedManagers = parseInFilter(filterValues[\"sales_id@in\"]);\n  const hasPendingTasks =\n    typeof filterValues[\"nb_tasks@gt\"] !== \"undefined\" &&\n    filterValues[\"nb_tasks@gt\"] !== null;\n  const archivedState = filterValues.hasArchivedDeals;\n\n  const updateFilters = (changes: Record<string, unknown>) => {\n    const next = { ...filterValues, ...changes };\n    Object.entries(changes).forEach(([key, value]) => {\n      if (\n        value === undefined ||\n        value === null ||\n        (Array.isArray(value) && value.length === 0)\n      ) {\n        delete next[key];\n      }\n    });\n    setFilters(next);\n  };\n\n  const toggleLastSeenRange = (range: RangeFilter) => {\n    const isSelected = lastSeenRanges.some((item) => isEqual(item, range));\n    const nextRanges = isSelected\n      ? lastSeenRanges.filter((item) => !isEqual(item, range))\n      : [...lastSeenRanges, range];\n    updateFilters({\n      last_seen_ranges: nextRanges.length ? nextRanges : undefined,\n    });\n  };\n\n  const toggleService = (id: number) => {\n    const next = toggleValueInList(selectedServices, id);\n    updateFilters({ \"services_interested@ov\": buildOverlapFilter(next) });\n  };\n\n  const toggleTag = (id: number) => {\n    const next = toggleValueInList(selectedTags, id);\n    updateFilters({ \"tags@ov\": buildOverlapFilter(next) });\n  };\n\n  const toggleManager = (id: string | number | undefined) => {\n    if (typeof id === \"undefined\") return;\n    const next = toggleValueInList(selectedManagers, id);\n    updateFilters({ \"sales_id@in\": buildInFilter(next) });\n  };\n\n  const toggleTasks = () => {\n    if (hasPendingTasks) {\n      updateFilters({ \"nb_tasks@gt\": undefined });\n    } else {\n      updateFilters({ \"nb_tasks@gt\": 0 });\n    }\n  };\n\n  const setArchivedFilter = (value: boolean | undefined) => {\n    updateFilters({ hasArchivedDeals: value });\n  };\n\n  const clearLastSeen = () => updateFilters({ last_seen_ranges: undefined });\n  const clearServices = () =>\n    updateFilters({ \"services_interested@ov\": undefined });\n  const clearTags = () => updateFilters({ \"tags@ov\": undefined });\n  const clearManagers = () => updateFilters({ \"sales_id@in\": undefined });\n\n  return (\n    <div className=\"w-52 min-w-52 order-first pt-0.75 flex flex-col gap-4\">\n      <FilterLiveForm>\n        <SearchInput source=\"q\" placeholder=\"Search name, company...\" />\n      </FilterLiveForm>\n\n      <FilterCategory\n        label=\"Last activity\"\n        icon={<Clock />}\n        count={lastSeenRanges.length}\n        onClear={clearLastSeen}\n      >\n        <FilterOptionButton\n          label=\"Today\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              gte: endOfYesterday?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              gte: endOfYesterday?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"This week\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              gte: startOfWeek?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              gte: startOfWeek?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before this week\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: startOfWeek?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: startOfWeek?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before this month\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: startOfMonth?.toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: startOfMonth?.toISOString(),\n            })\n          }\n        />\n        <FilterOptionButton\n          label=\"Before last month\"\n          selected={lastSeenRanges.some((range) =>\n            isEqual(range, {\n              field: \"last_seen\",\n              lte: subMonths(startOfMonth ?? new Date(), 1).toISOString(),\n            }),\n          )}\n          onToggle={() =>\n            toggleLastSeenRange({\n              field: \"last_seen\",\n              lte: subMonths(startOfMonth ?? new Date(), 1).toISOString(),\n            })\n          }\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Archive status\"\n        icon={<Archive />}\n        count={typeof archivedState === \"boolean\" ? 1 : 0}\n        onClear={() => setArchivedFilter(undefined)}\n      >\n        <FilterOptionButton\n          label=\"Unarchived\"\n          selected={archivedState === false}\n          onToggle={() =>\n            setArchivedFilter(archivedState === false ? undefined : false)\n          }\n        />\n        <FilterOptionButton\n          label=\"Archived\"\n          selected={archivedState === true}\n          onToggle={() =>\n            setArchivedFilter(archivedState === true ? undefined : true)\n          }\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Services interested in\"\n        icon={<Stethoscope />}\n        count={selectedServices.length}\n        onClear={clearServices}\n      >\n        {servicesData && servicesData.length > 0 ? (\n          servicesData.map((service) => (\n            <FilterOptionButton\n              key={service.id}\n              label={service.name}\n              selected={selectedServices.includes(String(service.id))}\n              onToggle={() => toggleService(service.id)}\n            />\n          ))\n        ) : (\n          <div className=\"text-xs text-muted-foreground\">\n            No services available\n          </div>\n        )}\n      </FilterCategory>\n\n      <FilterCategory\n        label=\"Tags\"\n        icon={<Tag />}\n        count={selectedTags.length}\n        onClear={clearTags}\n      >\n        {data &&\n          data.map((record) => (\n            <FilterOptionButton\n              key={record.id}\n              label={\n                <Badge\n                  variant=\"secondary\"\n                  className=\"text-black text-xs font-normal cursor-pointer\"\n                  style={{\n                    backgroundColor: record?.color,\n                  }}\n                >\n                  {record?.name}\n                </Badge>\n              }\n              selected={selectedTags.includes(String(record.id))}\n              onToggle={() => toggleTag(record.id)}\n            />\n          ))}\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<CheckSquare />}\n        label=\"Tasks\"\n        count={hasPendingTasks ? 1 : 0}\n        onClear={() => updateFilters({ \"nb_tasks@gt\": undefined })}\n      >\n        <FilterOptionButton\n          label={\"With pending tasks\"}\n          selected={hasPendingTasks}\n          onToggle={toggleTasks}\n        />\n      </FilterCategory>\n\n      <FilterCategory\n        icon={<Users />}\n        label=\"Account Manager\"\n        count={selectedManagers.length}\n        onClear={clearManagers}\n      >\n        <FilterOptionButton\n          label={\"Me\"}\n          selected={selectedManagers.includes(String(identity?.id))}\n          onToggle={() => toggleManager(identity?.id)}\n        />\n        {salesData &&\n          salesData\n            .filter((manager) => manager.id !== identity?.id)\n            .map((manager) => (\n              <FilterOptionButton\n                key={manager.id}\n                label={`${manager.first_name} ${manager.last_name}`}\n                selected={selectedManagers.includes(String(manager.id))}\n                onToggle={() => toggleManager(manager.id)}\n              />\n            ))}\n      </FilterCategory>\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientListContent.tsx",
      "content": "import { RecordContextProvider, useListContext } from \"ra-core\";\nimport { type MouseEvent, useCallback, useRef } from \"react\";\nimport { Link } from \"react-router\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport type { Contact } from \"../types\";\nimport { TagsList } from \"../contacts/TagsList\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { formatRelativeOrDate } from \"../misc/timezone\";\n\nexport const ClientListContent = () => {\n  const {\n    data: clients,\n    error,\n    isPending,\n    onSelect,\n    onToggleItem,\n    selectedIds,\n  } = useListContext<Contact>();\n  const isSmall = useIsMobile();\n  const lastClickedIndexRef = useRef<number | null>(null);\n\n  // StopPropagation does not work for some reason on Checkbox, this handler is a workaround\n  const handleLinkClick = useCallback(function handleLinkClick(\n    e: MouseEvent<HTMLAnchorElement>,\n  ) {\n    // Prevent navigation if clicking on checkbox or if shift key is pressed\n    if (\n      e.target instanceof HTMLButtonElement ||\n      (e.target as HTMLElement).closest('[data-slot=\"checkbox\"]') ||\n      e.shiftKey\n    ) {\n      e.preventDefault();\n    }\n  }, []);\n\n  const handleCheckboxClick = useCallback(\n    (clientId: number | string, index: number, event: MouseEvent) => {\n      event.stopPropagation();\n      event.preventDefault();\n      \n      if (event.shiftKey && lastClickedIndexRef.current !== null) {\n        // Shift-click: select range from last clicked to current\n        const start = Math.min(lastClickedIndexRef.current, index);\n        const end = Math.max(lastClickedIndexRef.current, index);\n        const rangeIds = clients\n          .slice(start, end + 1)\n          .map((client) => client.id);\n        \n        // Click would toggle the current item, so apply the *toggled* state to the whole range.\n        // Use onSelect (set selected IDs in one shot) to avoid flaky toggling/batching issues.\n        const currentIsSelected = selectedIds.includes(clientId);\n        const targetIsSelected = !currentIsSelected;\n\n        if (onSelect) {\n          const rangeSet = new Set(rangeIds);\n          const selectedSet = new Set(selectedIds);\n          if (targetIsSelected) {\n            rangeIds.forEach((id) => selectedSet.add(id));\n          } else {\n            selectedIds.forEach((id) => {\n              if (rangeSet.has(id)) selectedSet.delete(id);\n            });\n          }\n          onSelect(Array.from(selectedSet));\n        } else {\n          // Fallback (should rarely happen): toggle items to match target state\n          rangeIds.forEach((id) => {\n            const isSelected = selectedIds.includes(id);\n            if (isSelected !== targetIsSelected) {\n              onToggleItem(id);\n            }\n          });\n        }\n      } else {\n        // Normal click: toggle single item\n        onToggleItem(clientId);\n      }\n      lastClickedIndexRef.current = index;\n    },\n    [clients, onSelect, onToggleItem, selectedIds],\n  );\n\n  if (isPending) {\n    return <Skeleton className=\"w-full h-9\" />;\n  }\n\n  if (error) {\n    return null;\n  }\n  const now = Date.now();\n\n  return (\n    <div className=\"divide-y\">\n      {clients.map((client, index) => (\n        <RecordContextProvider key={client.id} value={client}>\n          <Link\n            to={`/clients/${client.id}/show`}\n            className=\"flex flex-row gap-4 items-center px-4 py-2 hover:bg-muted transition-colors first:rounded-t-xl last:rounded-b-xl\"\n            onClick={handleLinkClick}\n          >\n            <div \n              onClick={(e) => {\n                e.stopPropagation();\n                e.preventDefault();\n              }}\n            >\n              <Checkbox\n                className=\"cursor-pointer\"\n                checked={selectedIds.includes(client.id)}\n                // Use mousedown to reliably capture shiftKey with Radix checkbox\n                onMouseDown={(e) => handleCheckboxClick(client.id, index, e)}\n                // Prevent Radix default click toggling; selection is controlled by react-admin\n                onClick={(e) => {\n                  e.preventDefault();\n                  e.stopPropagation();\n                }}\n              />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"font-medium flex items-center gap-2\">\n                {`${client.first_name ?? \"\"} ${client.last_name ?? \"\"}`.trim() || \"New Lead\"}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">\n                {client.title}\n                {client.title && client.company_id != null && \" at \"}\n                {client.company_id != null && (\n                  <ReferenceField\n                    source=\"company_id\"\n                    reference=\"companies\"\n                    link={false}\n                  >\n                    <TextField source=\"name\" />\n                  </ReferenceField>\n                )}\n                {client.nb_tasks\n                  ? ` - ${client.nb_tasks} task${\n                      client.nb_tasks > 1 ? \"s\" : \"\"\n                    }`\n                  : \"\"}\n                &nbsp;&nbsp;\n                <TagsList />\n              </div>\n            </div>\n            <div className=\"text-right ml-4 flex items-center gap-2\">\n              <Badge variant=\"default\" className=\"text-xs text-white bg-emerald-600 hover:bg-emerald-700\">\n                Client\n              </Badge>\n              {client.last_seen && (\n                <div\n                  className=\"text-sm text-muted-foreground\"\n                  title={client.last_seen}\n                >\n                  {!isSmall && \"last activity \"}\n                  {formatRelativeOrDate(client.last_seen, new Date(now))}\n                </div>\n              )}\n            </div>\n          </Link>\n        </RecordContextProvider>\n      ))}\n\n      {clients.length === 0 && (\n        <div className=\"p-4\">\n          <div className=\"text-muted-foreground\">No clients found</div>\n        </div>\n      )}\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientList.tsx",
      "content": "import jsonExport from \"jsonexport/dist\";\nimport {\n  downloadCSV,\n  useGetIdentity,\n  useListContext,\n  type Exporter,\n} from \"ra-core\";\nimport { BulkActionsToolbar } from \"@/components/admin/bulk-actions-toolbar\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SortButton } from \"@/components/admin/sort-button\";\nimport { Card } from \"@/components/ui/card\";\n\nimport type { Company, Contact, Sale, Tag } from \"../types\";\nimport { ClientEmpty } from \"./ClientEmpty\";\nimport { ClientListContent } from \"./ClientListContent\";\nimport { ClientListFilter } from \"./ClientListFilter\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\n\nexport const ClientList = () => {\n  const { identity } = useGetIdentity();\n\n  if (!identity) return null;\n\n  return (\n    <List\n      title={false}\n      actions={<ClientListActions />}\n      perPage={25}\n      sort={{ field: \"last_seen\", order: \"DESC\" }}\n      exporter={exporter}\n      filter={{ isClient: true }}\n    >\n      <ClientListLayout />\n    </List>\n  );\n};\n\nconst ClientListLayout = () => {\n  const { data, isPending, filterValues } = useListContext();\n  const { identity } = useGetIdentity();\n\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  if (!identity || isPending) return null;\n\n  if (!data?.length && !hasFilters) return <ClientEmpty />;\n\n  return (\n    <div className=\"flex flex-row gap-8\">\n      <ClientListFilter />\n      <div className=\"w-full flex flex-col gap-4\">\n        <Card className=\"py-0\">\n          <ClientListContent />\n        </Card>\n      </div>\n      <BulkActionsToolbar />\n    </div>\n  );\n};\n\nconst ClientListActions = () => (\n  <TopToolbar>\n    <SortButton fields={[\"first_name\", \"last_name\", \"last_seen\"]} />\n    <ExportButton exporter={exporter} />\n    <CreateButton />\n  </TopToolbar>\n);\n\nconst exporter: Exporter<Contact> = async (records, fetchRelatedRecords) => {\n  const companies = await fetchRelatedRecords<Company>(\n    records,\n    \"company_id\",\n    \"companies\",\n  );\n  const sales = await fetchRelatedRecords<Sale>(records, \"sales_id\", \"sales\");\n  const tags = await fetchRelatedRecords<Tag>(records, \"tags\", \"tags\");\n\n  const clients = records.map((client) => {\n    const exportedClient = {\n      ...client,\n      company:\n        client.company_id != null\n          ? companies[client.company_id].name\n          : undefined,\n      sales: `${sales[client.sales_id].first_name} ${\n        sales[client.sales_id].last_name\n      }`,\n      tags: client.tags.map((tagId) => tags[tagId].name).join(\", \"),\n      email_work: client.email_jsonb?.find((email) => email.type === \"Work\")\n        ?.email,\n      email_home: client.email_jsonb?.find((email) => email.type === \"Home\")\n        ?.email,\n      email_other: client.email_jsonb?.find((email) => email.type === \"Other\")\n        ?.email,\n      email_jsonb: JSON.stringify(client.email_jsonb),\n      email_fts: undefined,\n      phone_work: client.phone_jsonb?.find((phone) => phone.type === \"Work\")\n        ?.number,\n      phone_home: client.phone_jsonb?.find((phone) => phone.type === \"Home\")\n        ?.number,\n      phone_other: client.phone_jsonb?.find((phone) => phone.type === \"Other\")\n        ?.number,\n      phone_jsonb: JSON.stringify(client.phone_jsonb),\n      phone_fts: undefined,\n    };\n    delete exportedClient.email_fts;\n    delete exportedClient.phone_fts;\n    return exportedClient;\n  });\n  return jsonExport(clients, {}, (_err: any, csv: string) => {\n    downloadCSV(csv, \"clients\");\n  });\n};\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientEmpty.tsx",
      "content": "import { CreateButton } from \"@/components/admin/create-button\";\n\nimport useAppBarHeight from \"../misc/useAppBarHeight\";\n\nexport const ClientEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-3\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No clients found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h6 className=\"text-lg font-bold\">No clients found</h6>\n        <p className=\"text-sm text-muted-foreground text-center mb-4\">\n          It seems your client list is empty.\n        </p>\n      </div>\n      <div className=\"flex flex-row gap-2\">\n        <CreateButton label=\"New Client\" />\n      </div>\n    </div>\n  );\n};\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientEdit.tsx",
      "content": "import { Card, CardContent } from \"@/components/ui/card\";\nimport { EditBase, Form, useEditContext } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\n\nimport type { Contact } from \"../types\";\nimport { ClientAside } from \"./ClientAside\";\nimport { LeadInputs } from \"../contacts/LeadInputs\";\n\nexport const ClientEdit = () => (\n  <EditBase\n    redirect=\"show\"\n    transform={(data: Contact) => {\n      // Split full name back into first_name and last_name before saving\n      if (data.first_name) {\n        const parts = data.first_name.trim().split(/\\s+/);\n        data.first_name = parts[0] || \"\";\n        data.last_name = parts.slice(1).join(\" \") || \"\";\n      }\n      return data;\n    }}\n  >\n    <ClientEditContent />\n  </EditBase>\n);\n\nconst ClientEditContent = () => {\n  const { isPending, record } = useEditContext<Contact>();\n  if (isPending || !record) return null;\n  \n  // Combine first_name and last_name for the form's default value\n  const fullName = record.first_name && record.last_name\n    ? `${record.first_name} ${record.last_name}`.trim()\n    : record.first_name || \"\";\n  \n  return (\n    <div className=\"mt-2 flex justify-center\">\n      <div className=\"w-[90%] max-w-6xl flex gap-8\">\n        <div className=\"flex-1\">\n        <Form \n          className=\"flex flex-1 flex-col gap-4\"\n          defaultValues={{\n            ...record,\n            first_name: fullName,\n          }}\n        >\n        <Card>\n          <CardContent>\n              <LeadInputs />\n            <FormToolbar />\n          </CardContent>\n        </Card>\n      </Form>\n        </div>\n        <ClientAside link=\"show\" />\n      </div>\n    </div>\n  );\n};\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientCreate.tsx",
      "content": "import { CreateBase, Form, useDataProvider, useGetIdentity, useNotify } from \"ra-core\";\nimport { FormToolbar } from \"@/components/admin/simple-form\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nimport type { Contact } from \"../types\";\nimport { createLeadJourneyDealForContact } from \"../deals/createLeadJourneyDeal\";\nimport { LeadInputs } from \"../contacts/LeadInputs\";\n\nexport const ClientCreate = () => {\n  const { identity } = useGetIdentity();\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n\n  const handleSuccess = async (data: Contact) => {\n    if (!data?.id) {\n      console.error(\"ClientCreate: Missing contact ID\", data);\n      return;\n    }\n    try {\n      await createLeadJourneyDealForContact(dataProvider, data, identity?.id);\n    } catch (error) {\n      notify(\"Client created but could not add to journey\", { type: \"warning\" });\n      console.error(\"ClientCreate: lead-journey create failed\", error);\n    }\n  };\n  return (\n    <CreateBase\n      redirect=\"show\"\n      transform={(data: Contact) => ({\n        ...data,\n        first_seen: new Date().toISOString(),\n        last_seen: new Date().toISOString(),\n        tags: [],\n        services_interested: data.services_interested || [],\n      })}\n      mutationOptions={{\n        onSuccess: (response) => {\n          // Handle both response.data (react-admin structure) and direct data\n          const contact = ((response as any)?.data ?? response) as Contact | undefined;\n          if (!contact || !contact.id) {\n            console.warn(\"ClientCreate: Invalid response structure\", response);\n            return;\n          }\n          handleSuccess(contact);\n        },\n      }}\n    >\n      <div className=\"mt-2 flex justify-center\">\n        <div className=\"w-[90%] max-w-6xl\">\n          <Form \n            defaultValues={{ \n              sales_id: identity?.id,\n              phone_has_whatsapp: false,\n              services_interested: [],\n            }}\n          >\n            <Card>\n              <CardContent>\n                <LeadInputs />\n                <FormToolbar />\n              </CardContent>\n            </Card>\n          </Form>\n        </div>\n      </div>\n    </CreateBase>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/clients/ClientAside.tsx",
      "content": "import { Linkedin, Mail, Phone } from \"lucide-react\";\nimport { useRecordContext, WithRecord } from \"ra-core\";\nimport type { ReactNode } from \"react\";\nimport { ArrayField } from \"@/components/admin/array-field\";\nimport { EditButton } from \"@/components/admin/edit-button\";\nimport { DeleteButton } from \"@/components/admin\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { ShowButton } from \"@/components/admin/show-button\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { EmailField } from \"@/components/admin/email-field\";\n\nimport { TagsListEdit } from \"../contacts/TagsListEdit\";\nimport { ServicesListEdit } from \"../contacts/ServicesListEdit\";\nimport { AsideSection } from \"../misc/AsideSection\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { Contact } from \"../types\";\nimport { ContactMergeButton } from \"../contacts/ContactMergeButton\";\nimport { ExportVCardButton } from \"../contacts/ExportVCardButton\";\n\nexport const ClientAside = ({ link = \"edit\" }: { link?: \"edit\" | \"show\" }) => {\n  const { contactGender } = useConfigurationContext();\n  const record = useRecordContext<Contact>();\n\n  if (!record) return null;\n  return (\n    <div className=\"hidden sm:block w-64 min-w-64 text-sm\">\n      <div className=\"mb-4 -ml-1\">\n        {link === \"edit\" ? (\n          <EditButton label=\"Edit Client\" />\n        ) : (\n          <ShowButton label=\"Show Client\" />\n        )}\n      </div>\n\n      <AsideSection title=\"Personal info\">\n        <ArrayField source=\"email_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Mail className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<EmailField source=\"email\" />}\n            />\n          </SingleFieldList>\n        </ArrayField>\n\n        {record.has_newsletter && (\n          <p className=\"pl-6 text-sm text-muted-foreground\">\n            Subscribed to newsletter\n          </p>\n        )}\n\n        {record.linkedin_url && (\n          <PersonalInfoRow\n            icon={<Linkedin className=\"w-4 h-4 text-muted-foreground\" />}\n            primary={\n              <a\n                className=\"underline hover:no-underline text-sm text-muted-foreground\"\n                href={record.linkedin_url}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                title={record.linkedin_url}\n              >\n                LinkedIn\n              </a>\n            }\n          />\n        )}\n        <ArrayField source=\"phone_jsonb\">\n          <SingleFieldList className=\"flex-col\">\n            <PersonalInfoRow\n              icon={<Phone className=\"w-4 h-4 text-muted-foreground\" />}\n              primary={<TextField source=\"number\" />}\n              showType\n            />\n          </SingleFieldList>\n        </ArrayField>\n        {contactGender\n          .map((genderOption) => {\n            if (record.gender === genderOption.value) {\n              return (\n                <PersonalInfoRow\n                  key={genderOption.value}\n                  primary={<span>{genderOption.label}</span>}\n                />\n              );\n            }\n            return null;\n          })\n          .filter(Boolean)}\n      </AsideSection>\n      <AsideSection title=\"Background info\">\n        <WithRecord<Contact>\n          render={(record) =>\n            record?.background ? (\n              <TextField source=\"background\" record={record} className=\"pb-2\" />\n            ) : null\n          }\n        />\n        <div className=\"text-muted-foreground\">\n          <span className=\"text-sm\">Added on</span>{\" \"}\n          <DateField\n            source=\"first_seen\"\n            options={{ year: \"numeric\", month: \"long\", day: \"numeric\" }}\n          />\n        </div>\n\n        <div className=\"text-muted-foreground\">\n          <span className=\"text-sm\">Last activity on</span>{\" \"}\n          <DateField\n            source=\"last_seen\"\n            options={{ year: \"numeric\", month: \"long\", day: \"numeric\" }}\n          />\n        </div>\n\n        <div className=\"inline-flex text-muted-foreground\">\n          Followed by&nbsp;\n          <ReferenceField source=\"sales_id\" reference=\"sales\">\n            <SaleName />\n          </ReferenceField>\n        </div>\n      </AsideSection>\n\n      <AsideSection title=\"Services interested in\">\n        <ServicesListEdit />\n      </AsideSection>\n\n      <AsideSection title=\"Tags\">\n        <TagsListEdit />\n      </AsideSection>\n\n      {link !== \"edit\" && (\n        <>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <ExportVCardButton />\n            <ContactMergeButton />\n          </div>\n          <div className=\"mt-6 pt-6 border-t hidden sm:flex flex-col gap-2 items-start\">\n            <DeleteButton\n              className=\"h-6 cursor-pointer hover:bg-destructive/10! text-destructive! border-destructive! focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40\"\n              size=\"sm\"\n            />\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nconst PersonalInfoRow = ({\n  icon,\n  primary,\n  showType,\n}: {\n  icon?: ReactNode;\n  primary: ReactNode;\n  showType?: boolean;\n}) => (\n  <div className=\"flex flex-row items-center gap-2 min-h-6\">\n    {icon && icon}\n    <div className=\"flex flex-wrap gap-x-2 gap-y-0\">\n      {primary}\n      {showType ? (\n        <WithRecord\n          render={(row) =>\n            row.type !== \"Other\" && (\n              <TextField source=\"type\" className=\"text-muted-foreground\" />\n            )\n          }\n        />\n      ) : null}\n    </div>\n  </div>\n);\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogTaskDeleted.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityTaskDeleted } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogTaskDeletedProps = {\n  activity: ActivityTaskDeleted;\n};\n\nexport function ActivityLogTaskDeleted({\n  activity,\n}: ActivityLogTaskDeletedProps) {\n  const context = useActivityLogContext();\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-red-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;deleted a task\n              {activity.task_type && activity.task_type !== \"None\" && (\n                <>&nbsp;({activity.task_type})</>\n              )}\n              {activity.contact_id && (\n                <>\n                  &nbsp;for&nbsp;\n                  <ReferenceField\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={activity}\n                  >\n                    <span>contact</span>\n                  </ReferenceField>\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n      {activity.task_text && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground line-through opacity-75\">\n          {activity.task_text.length > 100\n            ? `${activity.task_text.substring(0, 100)}...`\n            : activity.task_text}\n        </div>\n      )}\n    </div>\n  );\n}\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogTaskCreated.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport { TASK_COMPLETED } from \"../consts\";\nimport type { ActivityTaskCreated, ActivityTaskCompleted } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogTaskProps = {\n  activity: ActivityTaskCreated | ActivityTaskCompleted;\n};\n\nexport function ActivityLogTaskCreated({\n  activity,\n}: ActivityLogTaskProps) {\n  const context = useActivityLogContext();\n  const { task } = activity;\n  const isCompleted = activity.type === TASK_COMPLETED;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-purple-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;{isCompleted ? \"completed\" : \"created\"} task\n              {(() => {\n                const taskType = task.type?.trim();\n                // Only show type if it's a valid non-empty string and not \"none\" or \"null\"\n                if (taskType && \n                    taskType.toLowerCase() !== \"none\" && \n                    taskType.toLowerCase() !== \"null\" &&\n                    taskType !== \"\") {\n                  return ` (${taskType})`;\n                }\n                return \"\";\n              })()} for&nbsp;\n              <ReferenceField\n                source=\"contact_id\"\n                reference=\"contacts\"\n                record={task}\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n      {task.text && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground\">\n          {task.text}\n        </div>\n      )}\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogQuoteDeleted.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityQuoteDeleted } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogQuoteDeletedProps = {\n  activity: ActivityQuoteDeleted;\n};\n\nexport function ActivityLogQuoteDeleted({\n  activity,\n}: ActivityLogQuoteDeletedProps) {\n  const context = useActivityLogContext();\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-red-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;deleted a quote\n              {activity.contact_id && (\n                <>\n                  &nbsp;for&nbsp;\n                  <ReferenceField\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={activity}\n                  >\n                    <span>contact</span>\n                  </ReferenceField>\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n      {(activity.quote_description || activity.quote_amount) && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground line-through opacity-75\">\n          {activity.quote_description && (\n            <span>\n              {activity.quote_description.length > 100\n                ? `${activity.quote_description.substring(0, 100)}...`\n                : activity.quote_description}\n            </span>\n          )}\n          {activity.quote_amount && (\n            <span className=\"ml-2 font-semibold\">\n              {new Intl.NumberFormat(\"en-AE\", {\n                style: \"currency\",\n                currency: \"AED\",\n              }).format(Number(activity.quote_amount))}\n            </span>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogQuoteCreated.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport { QUOTE_UPDATED } from \"../consts\";\nimport type { ActivityQuoteCreated, ActivityQuoteUpdated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogQuoteProps = {\n  activity: ActivityQuoteCreated | ActivityQuoteUpdated;\n};\n\nexport function ActivityLogQuoteCreated({\n  activity,\n}: ActivityLogQuoteProps) {\n  const context = useActivityLogContext();\n  const { quote } = activity;\n  const isUpdated = activity.type === QUOTE_UPDATED;\n  \n  // Format currency properly\n  const formattedAmount = quote.amount\n    ? new Intl.NumberFormat(\"en-US\", {\n        style: \"currency\",\n        currency: \"AED\",\n        minimumFractionDigits: 2,\n      }).format(Number(quote.amount))\n    : null;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-green-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;{isUpdated ? \"updated a\" : \"created a\"}&nbsp;\n              {quote.service_id ? (\n                <>\n                  <ReferenceField\n                    source=\"service_id\"\n                    reference=\"services\"\n                    record={quote}\n                  >\n                    <TextField source=\"name\" />\n                  </ReferenceField>\n                  &nbsp;Quote\n                </>\n              ) : (\n                \"Quote\"\n              )}\n              &nbsp;for&nbsp;\n              <ReferenceField\n                source=\"contact_id\"\n                reference=\"contacts\"\n                record={quote}\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n              {formattedAmount && (\n                <>\n                  &nbsp;-&nbsp;{formattedAmount}\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} mode=\"local\" />\n        </span>\n      </div>\n      {quote.description && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground line-clamp-3 overflow-hidden\">\n          {quote.description}\n        </div>\n      )}\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogNoteDeleted.tsx",
      "content": "import { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityNoteDeleted } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogNoteDeletedProps = {\n  activity: ActivityNoteDeleted;\n};\n\nexport function ActivityLogNoteDeleted({\n  activity,\n}: ActivityLogNoteDeletedProps) {\n  const context = useActivityLogContext();\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-red-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;deleted a note\n              {activity.contact_id && (\n                <>\n                  &nbsp;for&nbsp;\n                  <ReferenceField\n                    source=\"contact_id\"\n                    reference=\"contacts\"\n                    record={activity}\n                  >\n                    <span>contact</span>\n                  </ReferenceField>\n                </>\n              )}\n            </span>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n      {activity.note_text && (\n        <div className=\"ml-6 mt-1 text-sm text-muted-foreground line-through opacity-75\">\n          {activity.note_text.length > 100\n            ? `${activity.note_text.substring(0, 100)}...`\n            : activity.note_text}\n        </div>\n      )}\n    </div>\n  );\n}\n\n\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogNote.tsx",
      "content": "import { Fragment, type ReactNode } from \"react\";\n\ntype ActivityLogContactNoteCreatedProps = {\n  header: ReactNode;\n  text: string;\n};\n\nexport function ActivityLogNote({\n  header,\n  text,\n}: ActivityLogContactNoteCreatedProps) {\n  if (!text) {\n    return null;\n  }\n  const paragraphs = text.split(\"\\n\");\n\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-col space-y-2 w-full\">\n        <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n          <div className=\"w-5 h-5 bg-blue-200 rounded-full flex-shrink-0\" />\n          <div className=\"flex flex-row items-center flex-grow min-w-0 justify-between\">\n            {header}\n          </div>\n        </div>\n        <div className=\"ml-6 mt-1\">\n          <div className=\"text-sm text-muted-foreground line-clamp-3 overflow-hidden\">\n            {paragraphs.map((paragraph: string, index: number) => (\n              <Fragment key={index}>\n                {paragraph}\n                {index < paragraphs.length - 1 && <br />}\n              </Fragment>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogIterator.tsx",
      "content": "import { Fragment, useState } from \"react\";\n\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  COMPANY_CREATED,\n  CONTACT_CREATED,\n  CONTACT_NOTE_CREATED,\n  DEAL_CREATED,\n  DEAL_NOTE_CREATED,\n  QUOTE_CREATED,\n  QUOTE_UPDATED,\n  TASK_CREATED,\n  TASK_COMPLETED,\n  DEAL_STATUS_CHANGED,\n  DEAL_ARCHIVED,\n  DEAL_UNARCHIVED,\n  NOTE_DELETED,\n  QUOTE_DELETED,\n  TASK_DELETED,\n} from \"../consts\";\nimport type { Activity } from \"../types\";\nimport { ActivityLogDealCreated } from \"./ActivityLogDealCreated\";\nimport { ActivityLogCompanyCreated } from \"./ActivityLogCompanyCreated\";\nimport { ActivityLogContactCreated } from \"./ActivityLogContactCreated\";\nimport { ActivityLogContactNoteCreated } from \"./ActivityLogContactNoteCreated\";\nimport { ActivityLogDealNoteCreated } from \"./ActivityLogDealNoteCreated\";\nimport { ActivityLogQuoteCreated } from \"./ActivityLogQuoteCreated\";\nimport { ActivityLogTaskCreated } from \"./ActivityLogTaskCreated\";\nimport { ActivityLogDealStatusChanged } from \"./ActivityLogDealStatusChanged\";\nimport { ActivityLogDealArchived } from \"./ActivityLogDealArchived\";\nimport { ActivityLogDealUnarchived } from \"./ActivityLogDealUnarchived\";\nimport { ActivityLogNoteDeleted } from \"./ActivityLogNoteDeleted\";\nimport { ActivityLogQuoteDeleted } from \"./ActivityLogQuoteDeleted\";\nimport { ActivityLogTaskDeleted } from \"./ActivityLogTaskDeleted\";\n\ntype ActivityLogIteratorProps = {\n  activities: Activity[];\n  pageSize: number;\n};\n\nexport function ActivityLogIterator({\n  activities,\n  pageSize,\n}: ActivityLogIteratorProps) {\n  const [activitiesDisplayed, setActivityDisplayed] = useState(pageSize);\n\n  return (\n    <div className=\"space-y-4\">\n      {activities.slice(0, activitiesDisplayed).map((activity) => (\n        <Fragment key={activity.id}>\n          <ActivityItem activity={activity} />\n          <Separator />\n        </Fragment>\n      ))}\n\n      {activitiesDisplayed < activities.length && (\n        <a\n          href=\"#\"\n          onClick={(e) => {\n            e.preventDefault();\n            setActivityDisplayed(\n              (activitiesDisplayed) => activitiesDisplayed + pageSize,\n            );\n          }}\n          className=\"flex w-full justify-center text-sm underline hover:no-underline\"\n        >\n          Load more activity\n        </a>\n      )}\n    </div>\n  );\n}\n\nfunction ActivityItem({ activity }: { activity: Activity }) {\n  if (activity.type === COMPANY_CREATED) {\n    return <ActivityLogCompanyCreated activity={activity} />;\n  }\n\n  if (activity.type === CONTACT_CREATED) {\n    return <ActivityLogContactCreated activity={activity} />;\n  }\n\n  if (activity.type === CONTACT_NOTE_CREATED) {\n    return <ActivityLogContactNoteCreated activity={activity} />;\n  }\n\n  if (activity.type === DEAL_NOTE_CREATED) {\n    return <ActivityLogDealNoteCreated activity={activity} />;\n  }\n\n  if (activity.type === DEAL_CREATED) {\n    return <ActivityLogDealCreated activity={activity} />;\n  }\n\n  if (activity.type === QUOTE_CREATED || activity.type === QUOTE_UPDATED) {\n    return <ActivityLogQuoteCreated activity={activity} />;\n  }\n\n  if (activity.type === TASK_CREATED || activity.type === TASK_COMPLETED) {\n    return <ActivityLogTaskCreated activity={activity} />;\n  }\n\n  if (activity.type === DEAL_STATUS_CHANGED) {\n    return <ActivityLogDealStatusChanged activity={activity} />;\n  }\n\n  if (activity.type === DEAL_ARCHIVED) {\n    return <ActivityLogDealArchived activity={activity} />;\n  }\n\n  if (activity.type === DEAL_UNARCHIVED) {\n    return <ActivityLogDealUnarchived activity={activity} />;\n  }\n\n  if (activity.type === NOTE_DELETED) {\n    return <ActivityLogNoteDeleted activity={activity} />;\n  }\n\n  if (activity.type === QUOTE_DELETED) {\n    return <ActivityLogQuoteDeleted activity={activity} />;\n  }\n\n  if (activity.type === TASK_DELETED) {\n    return <ActivityLogTaskDeleted activity={activity} />;\n  }\n\n  return null;\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealUnarchived.tsx",
      "content": "import { Link } from \"react-router\";\nimport type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityDealUnarchived } from \"../types\";\n\ntype ActivityLogDealUnarchivedProps = {\n  activity: RaRecord & ActivityDealUnarchived;\n};\n\nexport function ActivityLogDealUnarchived({\n  activity,\n}: ActivityLogDealUnarchivedProps) {\n  const { deal } = activity;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row gap-2 items-center w-full justify-between\">\n        <div className=\"flex flex-row gap-2 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-green-400 rounded-full flex-shrink-0\" />\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;unarchived&nbsp;\n            {deal.lead_id ? (\n              <ReferenceField\n                source=\"lead_id\"\n                reference=\"contacts\"\n                record={deal}\n                link=\"show\"\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            ) : (\n              <Link to={`/lead-journey/${deal.id}/show`}>\n                {deal.first_name || deal.last_name\n                  ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                  : deal.name || \"New Lead\"}\n              </Link>\n            )}\n          </span>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealStatusChanged.tsx",
      "content": "import { Link } from \"react-router\";\nimport type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport { useConfigurationContext } from \"../root/ConfigurationContext\";\nimport { findDealLabel } from \"../deals/deal\";\nimport type { ActivityDealStatusChanged } from \"../types\";\n\ntype ActivityLogDealStatusChangedProps = {\n  activity: RaRecord & ActivityDealStatusChanged;\n};\n\nexport function ActivityLogDealStatusChanged({\n  activity,\n}: ActivityLogDealStatusChangedProps) {\n  const { leadStages } = useConfigurationContext();\n  const { deal } = activity;\n  \n  // Use new_stage from activity if available, otherwise fall back to deal.stage\n  const newStage = activity.new_stage ?? deal.stage;\n  const oldStage = activity.old_stage;\n  \n  const newStageLabel = findDealLabel(leadStages, newStage) || newStage;\n  const oldStageLabel = oldStage ? (findDealLabel(leadStages, oldStage) || oldStage) : null;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row gap-2 items-center w-full justify-between\">\n        <div className=\"flex flex-row gap-2 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-amber-200 rounded-full flex-shrink-0\" />\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;moved&nbsp;\n            {deal.lead_id ? (\n              <ReferenceField\n                source=\"lead_id\"\n                reference=\"contacts\"\n                record={deal}\n                link=\"show\"\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            ) : (\n              <Link to={`/lead-journey/${deal.id}/show`}>\n                {deal.first_name || deal.last_name\n                  ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                  : deal.name || \"New Lead\"}\n              </Link>\n            )}\n            {oldStageLabel ? (\n              <>\n                &nbsp;from&nbsp;\n                <span className=\"font-medium\">{oldStageLabel}</span>\n                &nbsp;to&nbsp;\n              </>\n            ) : (\n              <> &nbsp;to&nbsp; </>\n            )}\n            <span className=\"font-medium\">{newStageLabel}</span>\n          </span>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealNoteCreated.tsx",
      "content": "import type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityDealNoteCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogNote } from \"./ActivityLogNote\";\n\ntype ActivityLogDealNoteCreatedProps = {\n  activity: RaRecord & ActivityDealNoteCreated;\n};\n\nexport function ActivityLogDealNoteCreated({\n  activity,\n}: ActivityLogDealNoteCreatedProps) {\n  const context = useActivityLogContext();\n  const { dealNote } = activity;\n  return (\n    <ActivityLogNote\n      header={\n        <>\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n                link={false}\n              >\n                <SaleName />\n              </ReferenceField>\n              &nbsp;added a note about lead&nbsp;\n              <ReferenceField\n                source=\"deal_id\"\n                reference=\"lead-journey\"\n                record={dealNote}\n                link=\"show\"\n              />\n              {context !== \"company\" && (\n                <>\n                  {\" at \"}\n                  <ReferenceField\n                    source=\"deal_id\"\n                    reference=\"deals\"\n                    record={dealNote}\n                    link={false}\n                  >\n                    <ReferenceField\n                      source=\"company_id\"\n                      reference=\"companies\"\n                      link=\"show\"\n                    />\n                  </ReferenceField>{\" \"}\n                </>\n              )}\n            </span>\n          </div>\n          <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n            <RelativeDate date={activity.date} />\n          </span>\n        </>\n      }\n      text={dealNote.text}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealCreated.tsx",
      "content": "import { Link } from \"react-router\";\nimport type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityDealCreated } from \"../types\";\n\ntype ActivityLogDealCreatedProps = {\n  activity: RaRecord & ActivityDealCreated;\n};\n\nexport function ActivityLogDealCreated({\n  activity,\n}: ActivityLogDealCreatedProps) {\n  const { deal } = activity;\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full\">\n        <div className=\"w-5 h-5 bg-orange-200 rounded-full\" />\n        <div className=\"text-sm text-muted-foreground flex-grow\">\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;added lead&nbsp;\n            <Link to={`/lead-journey/${deal.id}/show`}>\n              {deal.first_name || deal.last_name\n                ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                : deal.name || \"New Lead\"}\n            </Link>\n            {deal.lead_id && (\n              <>\n                &nbsp;for&nbsp;\n                <ReferenceField\n                  source=\"lead_id\"\n                  reference=\"contacts\"\n                  record={deal}\n                  link=\"show\"\n                >\n                  <TextField source=\"first_name\" />\n                  &nbsp;\n                  <TextField source=\"last_name\" />\n                </ReferenceField>\n              </>\n            )}\n            &nbsp;\n            <span className=\"text-xs\">\n              <RelativeDate date={activity.date} />\n            </span>\n          </span>\n        </div>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogDealArchived.tsx",
      "content": "import { Link } from \"react-router\";\nimport type { RaRecord } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityDealArchived } from \"../types\";\n\ntype ActivityLogDealArchivedProps = {\n  activity: RaRecord & ActivityDealArchived;\n};\n\nexport function ActivityLogDealArchived({\n  activity,\n}: ActivityLogDealArchivedProps) {\n  const { deal } = activity;\n  \n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row gap-2 items-center w-full justify-between\">\n        <div className=\"flex flex-row gap-2 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-gray-400 rounded-full flex-shrink-0\" />\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField\n              source=\"sales_id\"\n              reference=\"sales\"\n              record={activity}\n            >\n              <SaleName />\n            </ReferenceField>\n            &nbsp;archived&nbsp;\n            {deal.lead_id ? (\n              <ReferenceField\n                source=\"lead_id\"\n                reference=\"contacts\"\n                record={deal}\n                link=\"show\"\n              >\n                <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            ) : (\n              <Link to={`/lead-journey/${deal.id}/show`}>\n                {deal.first_name || deal.last_name\n                  ? `${deal.first_name ?? \"\"} ${deal.last_name ?? \"\"}`.trim()\n                  : deal.name || \"New Lead\"}\n              </Link>\n            )}\n          </span>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n\n\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogContext.tsx",
      "content": "import { createContext, useContext } from \"react\";\n\nexport type activityLogContextValue = \"company\" | \"contact\" | \"deal\" | \"all\";\n\nexport const ActivityLogContext = createContext<activityLogContextValue>(\"all\");\n\nexport const useActivityLogContext = () => {\n  const context = useContext(ActivityLogContext);\n\n  return context;\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogContactNoteCreated.tsx",
      "content": "import { useRecordContext } from \"ra-core\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityContactNoteCreated, Contact } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogNote } from \"./ActivityLogNote\";\n\ntype ActivityLogContactNoteCreatedProps = {\n  activity: ActivityContactNoteCreated;\n};\n\nexport function ActivityLogContactNoteCreated({\n  activity,\n}: ActivityLogContactNoteCreatedProps) {\n  const context = useActivityLogContext();\n  const { contactNote } = activity;\n  return (\n    <ActivityLogNote\n      header={\n        <>\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n              <ReferenceField\n                source=\"contact_id\"\n                reference=\"contacts\"\n                record={activity.contactNote}\n              >\n            &nbsp;added a note about{\" \"}\n            <TextField source=\"first_name\" />\n                &nbsp;\n                <TextField source=\"last_name\" />\n              </ReferenceField>\n            </span>\n          </div>\n          <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n            <RelativeDate date={activity.date} />\n          </span>\n        </>\n      }\n      text={contactNote.text}\n    />\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogContactCreated.tsx",
      "content": "import { Link } from \"react-router\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityContactCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogContactCreatedProps = {\n  activity: ActivityContactCreated;\n};\n\nexport function ActivityLogContactCreated({\n  activity,\n}: ActivityLogContactCreatedProps) {\n  const context = useActivityLogContext();\n  const { contact } = activity;\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row gap-2 items-center w-full justify-between\">\n        <div className=\"flex flex-row gap-2 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-teal-200 rounded-full flex-shrink-0\" />\n          <span className=\"text-muted-foreground text-sm inline-flex\">\n            <ReferenceField source=\"sales_id\" reference=\"sales\" record={activity}>\n              <SaleName />\n            </ReferenceField>\n            &nbsp;added&nbsp;\n            <Link to={`/contacts/${contact.id}/show`}>\n              {`${contact.first_name ?? \"\"} ${contact.last_name ?? \"\"}`.trim() || \"New Lead\"}\n            </Link>\n          </span>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLogCompanyCreated.tsx",
      "content": "import { Link } from \"react-router\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { RelativeDate } from \"../misc/RelativeDate\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ActivityCompanyCreated } from \"../types\";\nimport { useActivityLogContext } from \"./ActivityLogContext\";\n\ntype ActivityLogCompanyCreatedProps = {\n  activity: ActivityCompanyCreated;\n};\n\nexport function ActivityLogCompanyCreated({\n  activity,\n}: ActivityLogCompanyCreatedProps) {\n  const context = useActivityLogContext();\n  const { company } = activity;\n  return (\n    <div className=\"p-0\">\n      <div className=\"flex flex-row space-x-1 items-center w-full justify-between\">\n        <div className=\"flex flex-row space-x-1 items-center flex-grow min-w-0\">\n          <div className=\"w-5 h-5 bg-indigo-200 rounded-full flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <span className=\"text-muted-foreground text-sm inline-flex\">\n              <ReferenceField\n                source=\"sales_id\"\n                reference=\"sales\"\n                record={activity}\n              >\n                <SaleName />\n              </ReferenceField>\n            </span>\n            &nbsp;added company &nbsp;\n            <Link to={`/companies/${company.id}/show`}>{company.name}</Link>\n          </div>\n        </div>\n        <span className=\"text-muted-foreground text-xs flex-shrink-0 ml-2\">\n          <RelativeDate date={activity.date} />\n        </span>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/atomic-crm/activity/ActivityLog.tsx",
      "content": "import { Alert } from \"@/components/ui/alert\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { type Identifier, useDataProvider } from \"ra-core\";\n\nimport type { CrmDataProvider } from \"../providers/types\";\nimport { ActivityLogContext } from \"./ActivityLogContext\";\nimport { ActivityLogIterator } from \"./ActivityLogIterator\";\n\ntype ActivityLogProps = {\n  companyId?: Identifier;\n  contactId?: Identifier;\n  pageSize?: number;\n  context?: \"company\" | \"contact\" | \"deal\" | \"all\";\n};\n\nexport function ActivityLog({\n  companyId,\n  contactId,\n  pageSize = 20,\n  context = \"all\",\n}: ActivityLogProps) {\n  const dataProvider = useDataProvider<CrmDataProvider>();\n  const { data, isPending, error } = useQuery({\n    queryKey: [\"activityLog\", companyId, contactId],\n    queryFn: () => dataProvider.getActivityLog(companyId, contactId),\n  });\n\n  if (isPending) {\n    return (\n      <div className=\"mt-1\">\n        {Array.from({ length: 5 }).map((_, index) => (\n          <div className=\"space-y-2 mt-1\" key={index}>\n            <div className=\"flex flex-row space-x-2 items-center\">\n              <Skeleton className=\"w-5 h-5 rounded-full\" />\n              <Skeleton className=\"w-full h-4\" />\n            </div>\n            <Skeleton className=\"w-full h-12\" />\n            <Separator />\n          </div>\n        ))}\n      </div>\n    );\n  }\n\n  if (error) {\n    return <Alert>Failed to load activity log</Alert>;\n  }\n\n  return (\n    <ActivityLogContext.Provider value={context}>\n      <ActivityLogIterator activities={data} pageSize={pageSize} />\n    </ActivityLogContext.Provider>\n  );\n}\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/set-password-page.tsx",
      "content": "import { useState } from \"react\";\nimport type { ValidateForm } from \"ra-core\";\nimport { Form, required, useNotify, useTranslate } from \"ra-core\";\nimport { useSetPassword, useSupabaseAccessToken } from \"ra-supabase-core\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { Button } from \"@/components/ui/button\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Layout } from \"@/components/supabase/layout\";\n\ninterface FormData {\n  password: string;\n  confirmPassword: string;\n}\n\nexport const SetPasswordPage = () => {\n  const [loading, setLoading] = useState(false);\n\n  const access_token = useSupabaseAccessToken();\n  const refresh_token = useSupabaseAccessToken({\n    parameterName: \"refresh_token\",\n  });\n\n  const notify = useNotify();\n  const translate = useTranslate();\n  const [, { mutateAsync: setPassword }] = useSetPassword();\n\n  const validate = (values: FormData) => {\n    if (values.password !== values.confirmPassword) {\n      return {\n        password: \"ra-supabase.validation.password_mismatch\",\n        confirmPassword: \"ra-supabase.validation.password_mismatch\",\n      };\n    }\n    return {};\n  };\n\n  if (!access_token || !refresh_token) {\n    if (process.env.NODE_ENV === \"development\") {\n      console.error(\"Missing access_token or refresh_token for set password\");\n    }\n    return (\n      <Layout>\n        <p>{translate(\"ra-supabase.auth.missing_tokens\")}</p>\n      </Layout>\n    );\n  }\n\n  const submit = async (values: FormData) => {\n    try {\n      setLoading(true);\n      await setPassword({\n        access_token,\n        refresh_token,\n        password: values.password,\n      });\n    } catch (error: any) {\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"ra.auth.sign_in_error\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <Layout>\n      <div className=\"flex flex-col space-y-2 text-center\">\n        <h1 className=\"text-2xl font-semibold tracking-tight\">\n          {translate(\"ra-supabase.set_password.new_password\", {\n            _: \"Choose your password\",\n          })}\n        </h1>\n      </div>\n      <Form<FormData>\n        className=\"space-y-8\"\n        onSubmit={submit as SubmitHandler<FieldValues>}\n        validate={validate as ValidateForm}\n      >\n        <TextInput\n          label={translate(\"ra.auth.password\", {\n            _: \"Password\",\n          })}\n          autoComplete=\"new-password\"\n          source=\"password\"\n          type=\"password\"\n          validate={required()}\n        />\n        <TextInput\n          label={translate(\"ra.auth.confirm_password\", {\n            _: \"Confirm password\",\n          })}\n          source=\"confirmPassword\"\n          type=\"password\"\n          validate={required()}\n        />\n        <Button type=\"submit\" className=\"cursor-pointer\" disabled={loading}>\n          {translate(\"ra.action.save\")}\n        </Button>\n      </Form>\n    </Layout>\n  );\n};\n\nSetPasswordPage.path = \"set-password\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/layout.tsx",
      "content": "import * as React from \"react\";\nimport { Notification } from \"@/components/admin/notification\";\nimport { useConfigurationContext } from \"@/components/atomic-crm/root/ConfigurationContext\";\n\nexport const Layout = ({ children }: React.PropsWithChildren) => {\n  const { darkModeLogo, title } = useConfigurationContext();\n\n  return (\n    <div className=\"min-h-screen flex\">\n      <div className=\"container relative grid flex-col items-center justify-center sm:max-w-none lg:grid-cols-2 lg:px-0\">\n        <div className=\"relative hidden h-full flex-col bg-muted p-10 text-white dark:border-r lg:flex\">\n          <div className=\"absolute inset-0 bg-zinc-900\" />\n          <div className=\"relative z-20 flex items-center text-lg font-medium\">\n            <img className=\"h-6 mr-2\" src={darkModeLogo} alt={title} />\n            {title}\n          </div>\n        </div>\n        <div className=\"lg:p-8\">\n          <div className=\"mx-auto flex w-full flex-col justify-center space-y-6 sm:w-[350px]\">\n            {children}\n          </div>\n        </div>\n      </div>\n      <Notification />\n    </div>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "src/components/supabase/forgot-password-page.tsx",
      "content": "import { useState } from \"react\";\nimport { useResetPassword } from \"ra-supabase-core\";\nimport { Form, required, useNotify, useTranslate } from \"ra-core\";\nimport { Layout } from \"@/components/supabase/layout\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface FormData {\n  email: string;\n}\n\nexport const ForgotPasswordPage = () => {\n  const [loading, setLoading] = useState(false);\n\n  const notify = useNotify();\n  const translate = useTranslate();\n  const [, { mutateAsync: resetPassword }] = useResetPassword();\n\n  const submit = async (values: FormData) => {\n    try {\n      setLoading(true);\n      await resetPassword({\n        email: values.email,\n      });\n    } catch (error: any) {\n      notify(\n        typeof error === \"string\"\n          ? error\n          : typeof error === \"undefined\" || !error.message\n            ? \"ra.auth.sign_in_error\"\n            : error.message,\n        {\n          type: \"warning\",\n          messageArgs: {\n            _:\n              typeof error === \"string\"\n                ? error\n                : error && error.message\n                  ? error.message\n                  : undefined,\n          },\n        },\n      );\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <Layout>\n      <div className=\"flex flex-col space-y-2 text-center\">\n        <h1 className=\"text-2xl font-semibold tracking-tight\">\n          {translate(\"ra-supabase.reset_password.forgot_password\", {\n            _: \"Forgot password?\",\n          })}\n        </h1>\n        <p>\n          {translate(\"ra-supabase.reset_password.forgot_password_details\", {\n            _: \"Enter your email to receive a reset password link.\",\n          })}\n        </p>\n      </div>\n      <Form<FormData>\n        className=\"space-y-8\"\n        onSubmit={submit as SubmitHandler<FieldValues>}\n      >\n        <TextInput\n          source=\"email\"\n          label={translate(\"ra.auth.email\", {\n            _: \"Email\",\n          })}\n          autoComplete=\"email\"\n          validate={required()}\n        />\n        <Button type=\"submit\" className=\"cursor-pointer\" disabled={loading}>\n          {translate(\"ra.action.reset_password\", {\n            _: \"Reset password\",\n          })}\n        </Button>\n      </Form>\n    </Layout>\n  );\n};\n\nForgotPasswordPage.path = \"forgot-password\";\n",
      "type": "registry:component"
    },
    {
      "path": "src/hooks/user-menu-context.tsx",
      "content": "import { createContext, useContext } from \"react\";\n\n/**\n * @deprecated Use UserMenuContextValue from `ra-core` once available.\n */\nexport type UserMenuContextValue = {\n  /**\n   * Closes the user menu\n   * @see UserMenu\n   */\n  onClose: () => void;\n};\n\n/**\n * @deprecated Use UserMenuContext from `ra-core` once available.\n */\nexport const UserMenuContext = createContext<UserMenuContextValue | undefined>(\n  undefined,\n);\n\n/**\n * @deprecated Use useUserMenu from `ra-core` once available.\n */\nexport const useUserMenu = () => useContext(UserMenuContext);\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/useBulkExport.tsx",
      "content": "import type { Exporter } from \"ra-core\";\nimport {\n  fetchRelatedRecords,\n  useDataProvider,\n  useListContext,\n  useNotify,\n  useResourceContext,\n} from \"ra-core\";\nimport { useCallback, useMemo } from \"react\";\n\n/**\n * This fill will be backported to 'ra-core' in the future.\n *\n * @deprecated Import from 'ra-core' instead.\n */\nexport function useBulkExport<\n  ResourceInformationsType extends Partial<{ resource: string }>,\n>(props: UseBulkExportProps<ResourceInformationsType>) {\n  const { exporter: customExporter, meta } = props;\n\n  const resource = useResourceContext(props);\n  const { exporter: exporterFromContext, selectedIds } = useListContext();\n  const exporter = customExporter || exporterFromContext;\n  const dataProvider = useDataProvider();\n  const notify = useNotify();\n\n  const bulkExport = useCallback(() => {\n    if (exporter && resource) {\n      dataProvider\n        .getMany(resource, { ids: selectedIds, meta })\n        .then(({ data }) =>\n          exporter(\n            data,\n            fetchRelatedRecords(dataProvider),\n            dataProvider,\n            resource,\n          ),\n        )\n        .catch((error) => {\n          console.error(error);\n          notify(\"ra.notification.http_error\", {\n            type: \"error\",\n          });\n        });\n    }\n  }, [dataProvider, exporter, notify, resource, selectedIds, meta]);\n\n  return useMemo(() => {\n    return {\n      bulkExport,\n    };\n  }, [bulkExport]);\n}\n\nexport type ResourceInformation = Partial<{ resource: string }>;\n\nexport type UseBulkExportProps<T extends ResourceInformation> = T & {\n  exporter?: Exporter;\n\n  meta?: any;\n};\n",
      "type": "registry:hook"
    },
    {
      "path": "src/hooks/simple-form-iterator-context.tsx",
      "content": "import { createContext, useContext } from \"react\";\n\n/**\n * A React context that provides access to a SimpleFormIterator data (the total number of items) and mutators (add, reorder and remove).\n * Useful to create custom array input iterators.\n * @deprecated Use SimpleFormIteratorContext from `ra-core` once available.\n * @see {SimpleFormIterator}\n * @see {ArrayInput}\n */\nexport const SimpleFormIteratorContext = createContext<\n  SimpleFormIteratorContextValue | undefined\n>(undefined);\n\n/**\n * @deprecated Use SimpleFormIteratorContextValue from `ra-core` once available.\n */\nexport type SimpleFormIteratorContextValue = {\n  add: (item?: any) => void;\n  remove: (index: number) => void;\n  reOrder: (index: number, newIndex: number) => void;\n  source: string;\n  total: number;\n};\n\n/**\n * @deprecated Use useSimpleFormIterator from `ra-core` once available.\n */\nexport const useSimpleFormIterator = () => {\n  const context = useContext(SimpleFormIteratorContext);\n  if (!context) {\n    throw new Error(\n      \"useSimpleFormIterator must be used inside a SimpleFormIterator\",\n    );\n  }\n  return context;\n};\n\n/**\n * A React context that provides access to a SimpleFormIterator item meta (its index and the total number of items) and mutators (reorder and remove this remove).\n * Useful to create custom array input iterators.\n * @deprecated Use SimpleFormIteratorItemContext from `ra-core` once available.\n * @see {SimpleFormIterator}\n * @see {ArrayInput}\n */\nexport const SimpleFormIteratorItemContext = createContext<\n  SimpleFormIteratorItemContextValue | undefined\n>(undefined);\n\n/**\n * @deprecated Use SimpleFormIteratorItemContextValue from `ra-core` once available.\n */\nexport type SimpleFormIteratorItemContextValue = {\n  index: number;\n  total: number;\n  remove: () => void;\n  reOrder: (newIndex: number) => void;\n};\n\n/**\n * @deprecated Use useSimpleFormIteratorItem from `ra-core` once available.\n */\nexport const useSimpleFormIteratorItem = () => {\n  const context = useContext(SimpleFormIteratorItemContext);\n  if (!context) {\n    throw new Error(\n      \"useSimpleFormIteratorItem must be used inside a SimpleFormIteratorItem\",\n    );\n  }\n  return context;\n};\n",
      "type": "registry:hook"
    }
  ],
  "type": "registry:block"
}