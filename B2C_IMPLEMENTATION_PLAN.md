# **B2C CRM Transformation - Implementation Plan**

## **Table of Contents**
1. [Overview](#overview)
2. [Database Schema Changes](#database-schema-changes)
3. [Migration Steps](#migration-steps)
4. [TypeScript Type Updates](#typescript-type-updates)
5. [Configuration Updates](#configuration-updates)
6. [Component Implementation](#component-implementation)
7. [Data Provider Updates](#data-provider-updates)
8. [Lead Creation Flow](#lead-creation-flow)
9. [Testing Checklist](#testing-checklist)
10. [Implementation Timeline](#implementation-timeline)

---

## **Overview**

Transform the Atomic CRM from B2B to B2C model:
- **Contacts** → **Leads** (new potential clients)
- **Deals** → **Lead Status** (tracking lead progression)
- **Companies** → **Clients** (converted leads or direct clients)

### **Key Requirement**
When a new lead is created, it must appear in:
1. **Leads page** - Full list view with filters
2. **Lead Status page** - Under "New" column in kanban board

---

## **Database Schema Changes**

### **1. Create Services Table**

```sql
-- New table for services
CREATE TABLE "public"."services" (
    "id" bigint generated by default as identity not null,
    "name" text not null,
    "created_at" timestamp with time zone not null default now(),
    PRIMARY KEY ("id")
);

ALTER TABLE "public"."services" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable read access for authenticated users"
ON "public"."services"
AS PERMISSIVE
FOR SELECT
TO authenticated
USING (true);

CREATE POLICY "Enable insert for authenticated users only"
ON "public"."services"
AS PERMISSIVE
FOR INSERT
TO authenticated
WITH CHECK (true);

-- Insert default services
INSERT INTO "public"."services" (name) VALUES 
  ('Doctor on Call'),
  ('Teleconsultation'),
  ('Physiotherapy'),
  ('Nurse on Call'),
  ('Blood Test'),
  ('IV Therapy'),
  ('Nanny'),
  ('Elderly Care');

-- Grant permissions
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE "public"."services" TO "authenticated";
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE "public"."services" TO "service_role";
```

### **2. Modify Contacts Table (Leads)**

```sql
-- Add new fields for leads
ALTER TABLE "public"."contacts" 
  ADD COLUMN "flat_villa_number" text,
  ADD COLUMN "building_street" text,
  ADD COLUMN "area" text,
  ADD COLUMN "google_maps_link" text,
  ADD COLUMN "phone_has_whatsapp" boolean DEFAULT false,
  ADD COLUMN "services_interested" bigint[];
```

### **3. Modify Companies Table (Clients)**

```sql
-- Add new fields for clients
ALTER TABLE "public"."companies"
  ADD COLUMN "services" bigint[],
  ADD COLUMN "status" text DEFAULT 'Active';
```

### **4. Modify Deals Table (Lead Status)**

```sql
-- Add lead_id to reference contacts
ALTER TABLE "public"."deals"
  ADD COLUMN "lead_id" bigint,
  ADD CONSTRAINT "deals_lead_id_fkey" 
    FOREIGN KEY (lead_id) 
    REFERENCES contacts(id) 
    ON UPDATE CASCADE 
    ON DELETE SET NULL;

-- Note: Keep company_id for backward compatibility but it will be optional
ALTER TABLE "public"."deals" ALTER COLUMN "company_id" DROP NOT NULL;
```

### **5. Update Views**

```sql
-- Drop existing view
DROP VIEW IF EXISTS "public"."contacts_summary";

-- Recreate contacts_summary with new fields
CREATE VIEW "public"."contacts_summary"
AS
SELECT 
    co.id,
    co.first_name,
    co.last_name,
    co.gender,
    co.title,
    co.email_jsonb,
    jsonb_path_query_array(co.email_jsonb, '$[*].email')::text as email_fts,
    co.phone_jsonb,
    jsonb_path_query_array(co.phone_jsonb, '$[*].number')::text as phone_fts,
    co.flat_villa_number,
    co.building_street,
    co.area,
    co.google_maps_link,
    co.phone_has_whatsapp,
    co.services_interested,
    co.background,
    co.avatar,
    co.first_seen,
    co.last_seen,
    co.has_newsletter,
    co.status,
    co.tags,
    co.company_id,
    co.sales_id,
    co.linkedin_url,
    c.name as company_name,
    count(DISTINCT t.id) as nb_tasks
FROM
    "public"."contacts" co
LEFT JOIN
    "public"."tasks" t ON co.id = t.contact_id
LEFT JOIN
    "public"."companies" c ON co.company_id = c.id
GROUP BY
    co.id, c.name;

-- Drop and recreate companies_summary with new fields
DROP VIEW IF EXISTS "public"."companies_summary";

CREATE VIEW "public"."companies_summary"
    WITH (security_invoker=on)
AS
SELECT 
    c.*,
    count(DISTINCT t.id) as nb_tasks
FROM 
    "public"."companies" c
LEFT JOIN 
    "public"."tasks" t ON t.contact_id IN (
        SELECT id FROM "public"."contacts" WHERE company_id = c.id
    )
GROUP BY 
    c.id;
```

---

## **Migration Steps**

Create file: `supabase/migrations/20250204000000_b2c_transformation.sql`

```sql
-- ============================================
-- B2C CRM Transformation Migration
-- ============================================

-- 1. Create services table
CREATE TABLE "public"."services" (
    "id" bigint generated by default as identity not null,
    "name" text not null,
    "created_at" timestamp with time zone not null default now(),
    PRIMARY KEY ("id")
);

ALTER TABLE "public"."services" ENABLE ROW LEVEL SECURITY;

-- 2. Insert default services
INSERT INTO "public"."services" (name) VALUES 
  ('Doctor on Call'),
  ('Teleconsultation'),
  ('Physiotherapy'),
  ('Nurse on Call'),
  ('Blood Test'),
  ('IV Therapy'),
  ('Nanny'),
  ('Elderly Care');

-- 3. Add columns to contacts (leads)
ALTER TABLE "public"."contacts" 
  ADD COLUMN IF NOT EXISTS "flat_villa_number" text,
  ADD COLUMN IF NOT EXISTS "building_street" text,
  ADD COLUMN IF NOT EXISTS "area" text,
  ADD COLUMN IF NOT EXISTS "google_maps_link" text,
  ADD COLUMN IF NOT EXISTS "phone_has_whatsapp" boolean DEFAULT false,
  ADD COLUMN IF NOT EXISTS "services_interested" bigint[];

-- 4. Add columns to companies (clients)
ALTER TABLE "public"."companies"
  ADD COLUMN IF NOT EXISTS "services" bigint[],
  ADD COLUMN IF NOT EXISTS "status" text DEFAULT 'Active';

-- 5. Add lead_id to deals
ALTER TABLE "public"."deals"
  ADD COLUMN IF NOT EXISTS "lead_id" bigint;

-- Make company_id optional
ALTER TABLE "public"."deals" ALTER COLUMN "company_id" DROP NOT NULL;

-- Add foreign key
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint 
        WHERE conname = 'deals_lead_id_fkey'
    ) THEN
        ALTER TABLE "public"."deals" 
        ADD CONSTRAINT "deals_lead_id_fkey" 
        FOREIGN KEY (lead_id) 
        REFERENCES contacts(id) 
        ON UPDATE CASCADE 
        ON DELETE SET NULL;
    END IF;
END $$;

-- 6. Update views
DROP VIEW IF EXISTS "public"."contacts_summary";

CREATE VIEW "public"."contacts_summary"
AS
SELECT 
    co.id,
    co.first_name,
    co.last_name,
    co.gender,
    co.title,
    co.email_jsonb,
    jsonb_path_query_array(co.email_jsonb, '$[*].email')::text as email_fts,
    co.phone_jsonb,
    jsonb_path_query_array(co.phone_jsonb, '$[*].number')::text as phone_fts,
    co.flat_villa_number,
    co.building_street,
    co.area,
    co.google_maps_link,
    co.phone_has_whatsapp,
    co.services_interested,
    co.background,
    co.avatar,
    co.first_seen,
    co.last_seen,
    co.has_newsletter,
    co.status,
    co.tags,
    co.company_id,
    co.sales_id,
    co.linkedin_url,
    c.name as company_name,
    count(DISTINCT t.id) as nb_tasks
FROM
    "public"."contacts" co
LEFT JOIN
    "public"."tasks" t ON co.id = t.contact_id
LEFT JOIN
    "public"."companies" c ON co.company_id = c.id
GROUP BY
    co.id, c.name;

DROP VIEW IF EXISTS "public"."companies_summary";

CREATE VIEW "public"."companies_summary"
    WITH (security_invoker=on)
AS
SELECT 
    c.*,
    count(DISTINCT t.id) as nb_tasks
FROM 
    "public"."companies" c
LEFT JOIN 
    "public"."tasks" t ON t.contact_id IN (
        SELECT id FROM "public"."contacts" WHERE company_id = c.id
    )
GROUP BY 
    c.id;

-- 7. Set up policies for services
CREATE POLICY "Enable read access for authenticated users"
ON "public"."services"
AS PERMISSIVE
FOR SELECT
TO authenticated
USING (true);

CREATE POLICY "Enable insert for authenticated users"
ON "public"."services"
AS PERMISSIVE
FOR INSERT
TO authenticated
WITH CHECK (true);

CREATE POLICY "Enable update for authenticated users"
ON "public"."services"
AS PERMISSIVE
FOR UPDATE
TO authenticated
USING (true);

CREATE POLICY "Enable delete for authenticated users"
ON "public"."services"
AS PERMISSIVE
FOR DELETE
TO authenticated
USING (true);

-- 8. Grant permissions
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE "public"."services" TO "authenticated";
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE "public"."services" TO "service_role";
```

---

## **TypeScript Type Updates**

### **File: `src/components/atomic-crm/types.ts`**

Add these new types:

```typescript
export type Service = {
  name: string;
  created_at: string;
} & Pick<RaRecord, "id">;

export type Lead = {
  first_name: string;
  last_name: string;
  phone_jsonb: PhoneNumberAndType[];
  email_jsonb: EmailAndType[];
  phone_has_whatsapp: boolean;
  flat_villa_number?: string;
  building_street?: string;
  area?: string;
  city?: string;
  google_maps_link?: string;
  services_interested: Identifier[];
  status: string;
  tags: Identifier[];
  sales_id: Identifier;
  first_seen: string;
  last_seen: string;
  avatar?: Partial<RAFile>;
  nb_tasks?: number;
} & Pick<RaRecord, "id">;

export type Client = {
  name: string;
  phone_number: string;
  address?: string;
  city?: string;
  services: Identifier[];
  status: string;
  sales_id: Identifier;
  created_at: string;
  logo: RAFile;
  nb_tasks?: number;
} & Pick<RaRecord, "id">;

export type LeadStatus = {
  name: string;
  lead_id: Identifier;
  stage: "new" | "contacted" | "quoted" | "qualified" | "not-qualified" | "converted";
  created_at: string;
  updated_at: string;
  sales_id: Identifier;
  index: number;
} & Pick<RaRecord, "id">;
```

Update existing `Contact` type to include new fields:

```typescript
export type Contact = {
  first_name: string;
  last_name: string;
  title: string;
  company_id: Identifier;
  email_jsonb: EmailAndType[];
  avatar?: Partial<RAFile>;
  linkedin_url?: string | null;
  first_seen: string;
  last_seen: string;
  has_newsletter: boolean;
  tags: Identifier[];
  gender: string;
  sales_id: Identifier;
  status: string;
  background: string;
  phone_jsonb: PhoneNumberAndType[];
  nb_tasks?: number;
  company_name?: string;
  // New fields for B2C
  flat_villa_number?: string;
  building_street?: string;
  area?: string;
  google_maps_link?: string;
  phone_has_whatsapp?: boolean;
  services_interested?: Identifier[];
} & Pick<RaRecord, "id">;
```

---

## **Configuration Updates**

### **File: `src/components/atomic-crm/root/defaultConfiguration.ts`**

Add:

```typescript
export const defaultServices = [
  "Doctor on Call",
  "Teleconsultation",
  "Physiotherapy",
  "Nurse on Call",
  "Blood Test",
  "IV Therapy",
  "Nanny",
  "Elderly Care",
];

export const defaultLeadStages = [
  { value: "new", label: "New" },
  { value: "contacted", label: "Contacted" },
  { value: "quoted", label: "Quoted" },
  { value: "qualified", label: "Qualified" },
  { value: "not-qualified", label: "Not Qualified" },
  { value: "converted", label: "Converted" },
];

export const defaultClientStatuses = [
  "Active",
  "Inactive",
  "On Hold",
];
```

### **File: `src/components/atomic-crm/root/ConfigurationContext.tsx`**

Update interface:

```typescript
export interface ConfigurationContextValue {
  companySectors: string[];
  dealCategories: string[];
  dealPipelineStatuses: string[];
  dealStages: DealStage[];
  leadStages: DealStage[]; // NEW
  noteStatuses: NoteStatus[];
  taskTypes: string[];
  title: string;
  darkModeLogo: string;
  lightModeLogo: string;
  contactGender: ContactGender[];
  services: string[]; // NEW
  clientStatuses: string[]; // NEW
}
```

---

## **Component Implementation**

### **Phase 1: Leads (Contacts)**

#### **1. Create Lead Input Component**

**File: `src/components/atomic-crm/contacts/LeadInputs.tsx`**

```typescript
import { email, required } from "ra-core";
import { useFormContext } from "react-hook-form";
import { Separator } from "@/components/ui/separator";
import { useIsMobile } from "@/hooks/use-mobile";
import { BooleanInput } from "@/components/admin/boolean-input";
import { ReferenceInput } from "@/components/admin/reference-input";
import { TextInput } from "@/components/admin/text-input";
import { SelectInput } from "@/components/admin/select-input";
import { ArrayInput } from "@/components/admin/array-input";
import { SimpleFormIterator } from "@/components/admin/simple-form-iterator";
import { ReferenceArrayInput } from "@/components/admin/reference-array-input";
import { AutocompleteArrayInput } from "@/components/admin/autocomplete-array-input";

export const LeadInputs = () => {
  const isMobile = useIsMobile();

  return (
    <div className="flex flex-col gap-2 p-1">
      <div className={`flex gap-6 ${isMobile ? "flex-col" : "flex-row"}`}>
        <div className="flex flex-col gap-10 flex-1">
          <BasicInformation />
          <AddressInformation />
        </div>
        <Separator
          orientation={isMobile ? "horizontal" : "vertical"}
          className="flex-shrink-0"
        />
        <div className="flex flex-col gap-10 flex-1">
          <ServicesSection />
          <AccountManagerSection />
        </div>
      </div>
    </div>
  );
};

const BasicInformation = () => {
  return (
    <div className="flex flex-col gap-4">
      <h6 className="text-lg font-semibold">Basic Information</h6>
      
      <TextInput 
        source="first_name" 
        label="Full Name"
        validate={required()} 
        helperText={false} 
      />
      
      <ArrayInput
        source="phone_jsonb"
        label="Phone Number"
        helperText={false}
      >
        <SimpleFormIterator
          inline
          disableReordering
          disableClear
          className="[&>ul>li]:border-b-0 [&>ul>li]:pb-0"
        >
          <TextInput
            source="number"
            className="w-full"
            helperText={false}
            label={false}
            placeholder="Phone number"
            validate={required()}
          />
        </SimpleFormIterator>
      </ArrayInput>
      
      <BooleanInput 
        source="phone_has_whatsapp" 
        label="Phone number has WhatsApp"
        helperText={false}
      />
      
      <ArrayInput
        source="email_jsonb"
        label="Email"
        helperText={false}
      >
        <SimpleFormIterator
          inline
          disableReordering
          disableClear
          className="[&>ul>li]:border-b-0 [&>ul>li]:pb-0"
        >
          <TextInput
            source="email"
            className="w-full"
            helperText={false}
            label={false}
            placeholder="Email"
            validate={email()}
          />
        </SimpleFormIterator>
      </ArrayInput>
      
      <ReferenceArrayInput 
        source="services_interested" 
        reference="services"
      >
        <AutocompleteArrayInput
          label="Services Interested In"
          optionText="name"
          helperText={false}
        />
      </ReferenceArrayInput>
    </div>
  );
};

const AddressInformation = () => {
  return (
    <div className="flex flex-col gap-4">
      <h6 className="text-lg font-semibold">Address Information</h6>
      
      <TextInput 
        source="flat_villa_number" 
        label="Flat/Villa Number"
        helperText={false} 
      />
      
      <TextInput 
        source="building_street" 
        label="Building/Street"
        helperText={false} 
      />
      
      <TextInput 
        source="area" 
        label="Area"
        helperText={false} 
      />
      
      <TextInput 
        source="city" 
        label="City"
        helperText={false} 
      />
      
      <TextInput 
        source="google_maps_link" 
        label="Google Maps Link"
        helperText={false} 
      />
    </div>
  );
};

const ServicesSection = () => {
  return (
    <div className="flex flex-col gap-4">
      <h6 className="text-lg font-semibold">Services</h6>
      <ReferenceArrayInput 
        source="services_interested" 
        reference="services"
      >
        <AutocompleteArrayInput
          label="Services Interested In"
          optionText="name"
          helperText={false}
        />
      </ReferenceArrayInput>
    </div>
  );
};

const AccountManagerSection = () => {
  return (
    <div className="flex flex-col gap-4">
      <h6 className="text-lg font-semibold">Account Manager</h6>
      <ReferenceInput
        reference="sales"
        source="sales_id"
        sort={{ field: "last_name", order: "ASC" }}
        filter={{ "disabled@neq": true }}
      >
        <SelectInput
          helperText={false}
          label="Account manager"
          optionText={(choice: any) => `${choice.first_name} ${choice.last_name}`}
          validate={required()}
        />
      </ReferenceInput>
    </div>
  );
};
```

#### **2. Update ContactCreate to use LeadInputs**

**File: `src/components/atomic-crm/contacts/ContactCreate.tsx`**

```typescript
import { CreateBase, Form, useGetIdentity, useRedirect, useDataProvider } from "ra-core";
import { FormToolbar } from "@/components/admin/simple-form";
import { Card, CardContent } from "@/components/ui/card";

import type { Contact } from "../types";
import { LeadInputs } from "./LeadInputs";

export const ContactCreate = () => {
  const { identity } = useGetIdentity();
  const redirect = useRedirect();
  const dataProvider = useDataProvider();

  const handleSuccess = async (data: Contact) => {
    // Create a corresponding deal with stage "new" for the lead
    await dataProvider.create("deals", {
      data: {
        name: `${data.first_name} ${data.last_name}`,
        lead_id: data.id,
        stage: "new",
        sales_id: data.sales_id,
        index: 0,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
      },
    });
    
    redirect("show", "contacts", data.id);
  };

  return (
    <CreateBase
      redirect={false}
      transform={(data: Contact) => ({
        ...data,
        first_seen: new Date().toISOString(),
        last_seen: new Date().toISOString(),
        tags: [],
        services_interested: data.services_interested || [],
      })}
      mutationOptions={{
        onSuccess: handleSuccess,
      }}
    >
      <div className="mt-2 flex lg:mr-72">
        <div className="flex-1">
          <Form defaultValues={{ 
            sales_id: identity?.id,
            phone_has_whatsapp: false,
            services_interested: [],
          }}>
            <Card>
              <CardContent>
                <LeadInputs />
                <FormToolbar />
              </CardContent>
            </Card>
          </Form>
        </div>
      </div>
    </CreateBase>
  );
};
```

#### **3. Update ContactList Filters**

**File: `src/components/atomic-crm/contacts/ContactListFilter.tsx`**

Add service filter:

```typescript
import { FilterCategory } from "../filters/FilterCategory";
import { useGetList } from "ra-core";
import { Stethoscope } from "lucide-react"; // or appropriate icon

// Add to existing filters:
<FilterCategory label="Services" icon={<Stethoscope />}>
  {servicesData &&
    servicesData.map((service) => (
      <ToggleFilterButton
        className="w-full justify-between"
        key={service.id}
        label={service.name}
        value={{ "services_interested@cs": `{${service.id}}` }}
      />
    ))}
</FilterCategory>
```

---

### **Phase 2: Lead Status (Deals)**

#### **1. Update Deal Stages**

**File: `src/components/atomic-crm/root/defaultConfiguration.ts`**

```typescript
export const defaultLeadStages = [
  { value: "new", label: "New" },
  { value: "contacted", label: "Contacted" },
  { value: "quoted", label: "Quoted" },
  { value: "qualified", label: "Qualified" },
  { value: "not-qualified", label: "Not Qualified" },
  { value: "converted", label: "Converted" },
];
```

#### **2. Update DealInputs for Lead Status**

**File: `src/components/atomic-crm/deals/DealInputs.tsx`**

```typescript
import { required } from "ra-core";
import { ReferenceInput } from "@/components/admin/reference-input";
import { TextInput } from "@/components/admin/text-input";
import { SelectInput } from "@/components/admin/select-input";
import { AutocompleteInput } from "@/components/admin/autocomplete-input";
import { useConfigurationContext } from "../root/ConfigurationContext";

export const DealInputs = () => {
  return (
    <div className="flex flex-col gap-8">
      <DealInfoInputs />
      <LeadReferenceInput />
      <StageInput />
    </div>
  );
};

const DealInfoInputs = () => {
  return (
    <div className="flex flex-col gap-4 flex-1">
      <TextInput
        source="name"
        label="Lead Status Name"
        validate={required()}
        helperText={false}
      />
    </div>
  );
};

const LeadReferenceInput = () => {
  return (
    <div className="flex flex-col gap-4 flex-1">
      <h3 className="text-base font-medium">Linked to Lead</h3>
      <ReferenceInput source="lead_id" reference="contacts">
        <AutocompleteInput 
          label="Lead"
          optionText={(choice: any) => `${choice.first_name} ${choice.last_name}`}
          validate={required()} 
        />
      </ReferenceInput>
    </div>
  );
};

const StageInput = () => {
  const { leadStages } = useConfigurationContext();
  return (
    <div className="flex flex-col gap-4 flex-1">
      <h3 className="text-base font-medium">Stage</h3>
      <SelectInput
        source="stage"
        choices={leadStages.map((stage) => ({
          id: stage.value,
          name: stage.label,
        }))}
        defaultValue="new"
        helperText={false}
        validate={required()}
      />
    </div>
  );
};
```

#### **3. Update CRM Resource Configuration**

**File: `src/components/atomic-crm/root/CRM.tsx`**

```typescript
// Update configuration provider to include leadStages
<ConfigurationProvider
  // ... existing props
  leadStages={leadStages}
  services={services}
  clientStatuses={clientStatuses}
>
  {/* ... */}
  <Resource name="services" />
  {/* ... existing resources */}
</ConfigurationProvider>
```

---

## **Data Provider Updates**

### **File: `src/components/atomic-crm/providers/supabase/dataProvider.ts`**

Add service to full-text search for contacts:

```typescript
{
  resource: "contacts",
  beforeGetList: async (params) => {
    return applyFullTextSearch([
      "first_name",
      "last_name",
      "area",
      "city",
      "flat_villa_number",
      "building_street",
    ])(params);
  },
  beforeCreate: async (params) => {
    return processContactAvatar(params);
  },
  beforeUpdate: async (params) => {
    return processContactAvatar(params);
  },
},
```

---

## **Lead Creation Flow**

### **Critical Implementation: Auto-create Deal on Lead Creation**

When a new lead is created via `ContactCreate`:

1. **Lead is saved** to `contacts` table
2. **Deal is automatically created** with:
   - `name`: Lead's full name
   - `lead_id`: References the new lead
   - `stage`: "new"
   - `sales_id`: Same as lead's sales_id
   - `index`: 0 (top of column)

This ensures the lead appears in:
- ✅ **Leads page** (via contacts list)
- ✅ **Lead Status page** under "New" column (via deals kanban)

**Implementation** (already shown in ContactCreate above):

```typescript
const handleSuccess = async (data: Contact) => {
  // Create deal for new lead
  await dataProvider.create("deals", {
    data: {
      name: `${data.first_name} ${data.last_name}`,
      lead_id: data.id,
      stage: "new",
      sales_id: data.sales_id,
      index: 0,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    },
  });
  
  redirect("show", "contacts", data.id);
};
```

---

## **Testing Checklist**

### **Database Migration**
- [ ] Run migration successfully
- [ ] Verify `services` table created
- [ ] Verify default services inserted
- [ ] Verify new columns added to `contacts`
- [ ] Verify new columns added to `companies`
- [ ] Verify `lead_id` added to `deals`
- [ ] Verify views recreated successfully

### **Lead Creation**
- [ ] Create new lead with all fields
- [ ] Verify lead appears in Leads page
- [ ] Verify lead appears in Lead Status page under "New"
- [ ] Verify WhatsApp checkbox works
- [ ] Verify services multi-select works
- [ ] Verify address fields save correctly

### **Lead Status**
- [ ] Move lead from New → Contacted
- [ ] Move lead from Contacted → Quoted
- [ ] Move lead from Quoted → Qualified
- [ ] Move lead to Not Qualified
- [ ] Move lead to Converted (should create client)

### **Filters**
- [ ] Filter leads by Service
- [ ] Filter leads by Status
- [ ] Filter leads by Tags
- [ ] Filter leads by Pending Tasks
- [ ] Filter leads by Account Manager

### **Client Management**
- [ ] Create client manually
- [ ] Client creation from converted lead
- [ ] Filter clients by Status
- [ ] Filter clients by Service

### **Notes & Tasks**
- [ ] Add note to lead
- [ ] Add task to lead
- [ ] Add note to client
- [ ] Add task to client


---

## **Important Notes**

1. **Table Names**: Keep database table names (`contacts`, `companies`, `deals`) unchanged to avoid breaking existing code
2. **UI Labels**: Update only UI labels and terminology
3. **Backward Compatibility**: Existing data remains valid; new fields are optional
4. **Auto-Creation**: The critical piece is auto-creating a deal when a lead is created
5. **Services Management**: Add UI for managing services (CRUD operations)

---

## **Next Steps**

1. Review this plan and make adjustments
2. Run the database migration
3. Start implementing components in order
4. Test each phase before moving to the next
5. Update documentation as you go

---

**File saved as:** `B2C_IMPLEMENTATION_PLAN.md`

